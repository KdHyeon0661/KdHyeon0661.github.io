---
layout: post
title: 네트워크보안 - 이메일 전송 보안
date: 2025-10-27 14:25:23 +0900
category: 네트워크보안
---
# 9. 이메일 전송 보안

> 목표: **전송 경로(SMTP·TLS)**, **도메인 인증(SPF/DKIM/DMARC)**, **포렌식(헤더 판독)**을 체계화하고  
> **DMARC 리포트 기반 정책 강화**를 실습한다. 운영환경(온프레미스 MTA·클라우드 메일·하이브리드)에 바로 적용 가능한  
> **DNS 레코드 예시, MTA 설정 스니펫, 분석 스크립트, 체크리스트**를 포함한다.

---

## 9.1 SMTP/POP/IMAP 공격면

### 9.1.1 전송·수신 경로(개념 지도)
- **발신(MUA→MSA)**: 사용자 클라이언트(Outlook/Thunderbird/앱)가 **MSA(SMTP-Submit, 587/tcp)**로 송신  
- **중계(MTA↔MTA)**: 도메인 간 중계 **25/tcp** (Opportunistic TLS/STARTTLS)  
- **수신(MDA→사서함)**: 사서함 배달 후 사용자는 **IMAPS(993/tcp) / POP3S(995/tcp)**로 수신  
- **메타 레이어**: **SPF/DKIM/DMARC**, **MTA-STS/TLS-RPT/DANE**, **ARC**, **SpamAssassin/벡터 탐지**

### 9.1.2 주요 공격면과 대응 요약
| 구간 | 공격면 | 방어/완화 |
|---|---|---|
| SMTP 제출(587) | 약한 비밀번호/무차별 시도, OAuth 토큰 탈취 | **MFA·IP 제한**, 제출 포트만 허용, **SMTP AUTH 안전(PLAIN+TLS)**, 비정상 로그인 탐지 |
| MTA 중계(25) | **자격증명 없는 릴레이(오픈 릴레이)**, **Opportunistic TLS 다운그레이드**, 스푸핑 발신 | **오픈 릴레이 금지**(strict recipient checks), **MTA-STS/DANE**, 발신IP 평판 관리 |
| 수신(IMAP/POP)** | 평문 로그인, 무차별 시도 | **IMAPS/POP3S 강제**, **fail2ban/nftables** rate-limit, MFA/OAuth 우선 |
| 콘텐츠 | 악성 링크/첨부, HTML/대체 텍스트 우회, QR 피싱 | URL 재작성/샌드박스, 첨부 MIME 정책, QR 탐지 규칙, 외부발신 배지 |
| 인증 | SPF pass 위장(리디렉션), DKIM 중립, DMARC 미적용 | **DMARC 정착**, **alignment 검증**, 보고 기반 튜닝 |
| 행위 | BEC(CEO 사칭, 결재·계좌 변경), 스레드 하이재킹 | **외부발신 표시**, **결재/계좌 워크플로우 2채널 확인**, 스레드 위조 탐지(References/Message-Id) |

### 9.1.3 STARTTLS, 강제 TLS, MTA-STS, DANE
- **STARTTLS(기회적 TLS)**: 지원 시 TLS로 업그레이드하나, **다운그레이드** 가능성 → **MTA-STS** 또는 **DANE**로 보강
- **MTA-STS**: `mta-sts._domainpolicy.<domain>`(HTTPS로 정책 제공) + DNS TXT → **TLS 강제·유효 인증서** 요구  
- **TLS-RPT**: 전송TLS 실패 리포트(MTA-STS/DANE 실패 분석)
- **DANE(SMTPA, TLSA 레코드)**: DNSSEC 기반으로 **서버 인증서 바인딩**(가용 시 강력)

> 실무 팁: **MTA-STS 우선 도입**, 장기적으로 DNSSEC 운용이 가능하면 **DANE** 병행.

### 9.1.4 POP/IMAP 운영 팁
- **IMAPS/POP3S만 허용**(평문 포트 비활성)  
- OAuth/OIDC를 지원해 **앱 비밀번호** 제거  
- 동시 연결·IDLE 제한, 이상 로그인 지리/ASN 경보

---

## 9.2 SPF/DKIM/DMARC 실전 구성

### 9.2.1 SPF(Sender Policy Framework)
- **목적**: "이 IP/호스트가 내 도메인으로 메일을 보낼 권한이 있는가?"
- **평가 대상 식별자**: **Envelope-From(Mail From/Return-Path)**  
- **정책**: `-all(거부)`, `~all(유연)`, `?all(중립)`, `+all(허용)` — 운영은 `~all`→`-all` 단계적
- **한 줄 예시**
```
example.com.  TXT  "v=spf1 ip4:203.0.113.10 include:_spf.mxhost.com -all"
```
- **모듈화 예**
```
_spf.example.com. TXT "v=spf1 ip4:203.0.113.10 ip4:198.51.100.22 include:_spf.sendservice.net -all"
example.com.      TXT "v=spf1 include:_spf.example.com -all"
```
- **주의**: `include`/`mx`/`a` 남용 시 **DNS lookup 10회 제한** 초과 → 레코드 다이어트 필요

### 9.2.2 DKIM(DomainKeys Identified Mail)
- **목적**: 본문/헤더에 대한 **무결성 보장**(서명), 발신 도메인 **도메인 수준 소유 증명**
- **평가 식별자**: **d=**(서명 도메인), **s=**(selector), 공개키는 `selector._domainkey.domain`
- **레코드 예시**
```
selector1._domainkey.example.com. TXT "v=DKIM1; k=rsa; p=MIIBIjANBgkqh...IDAQAB; t=s;"
```
- **MTA(예: OpenDKIM) 설정 개념**
```
KeyTable     reldomain selector1:/etc/opendkim/keys/example.com/selector1.private
SigningTable *@example.com reldomain
Canonicalization relaxed/relaxed
SignatureAlgorithm rsa-sha256
```
- **추천**: **짧은 키 주기(선택자 롤링)**, **c=relaxed/relaxed**, 헤더 최소: From: Date: Subject: To: MIME-Version

### 9.2.3 DMARC(Domain-based Message Authentication, Reporting & Conformance)
- **목적**: **SPF/DKIM 중 최소 하나**가 **도메인 일치(alignment)**에 성공해야 하며, 실패 시 **처리 정책**을 제시
- **정책**: `p=none|quarantine|reject` (도메인 단위), 하위도메인 `sp=...`  
- **정렬(Alignment)**:  
  - SPF: Envelope-From 도메인과 Header From 도메인이 **조상/동일**(relaxed/strict)  
  - DKIM: d=도메인과 Header From **정렬**
- **샘플 레코드(초기 관찰)**
```
_dmarc.example.com. TXT "v=DMARC1; p=none; rua=mailto:dmarc-agg@example.com; ruf=mailto:dmarc-afrf@example.com; fo=1; adkim=s; aspf=s; pct=100"
```
- **운영 단계**
  1) **p=none** + 보고 수집(2~4주)  
  2) **정렬 실패 원인**(3rd-party 발송원) 보정  
  3) **p=quarantine**(부분 적용: `pct=50`)  
  4) 안정화 후 **p=reject** + `sp=reject` (하위도메인 포함)

### 9.2.4 ARC(Authenticated Received Chain)
- **목적**: 포워딩/MLM 과정에서 DKIM/DMARC가 깨지더라도 **원본 인증 상태**를 전달  
- **상황**: 대학/메이저 리스트서버/게이트웨이 — ARC 지원 MTA 권장

### 9.2.5 MTA-STS/TLS-RPT 레코드 예
- **DNS TXT**
```
_mta-sts.example.com. TXT "v=STSv1; id=20251001"
_smtp._tls.example.com. TXT "v=TLSRPTv1; rua=mailto:tlsrpt@example.com"
```
- **정책 파일(HTTPS served)**
```
version: STSv1
mode: enforce
mx: mail.example.com
max_age: 604800
```

---

## 9.3 BEC/피싱 헤더 포렌식

### 9.3.1 “받은 편지함 헤더” 읽는 순서
1) **Authentication-Results**: SPF/DKIM/DMARC/ARC 상태를 가장 먼저 확인  
2) **From / Reply-To / Return-Path(Envelope-From)**: **발신 도메인 불일치** 여부  
3) **Received 체인**: 가장 **아래(원본에 가까운)** hop부터 상향식 검토 — 예상되지 않은 **중계** 확인  
4) **Message-Id / References / In-Reply-To**: 스레드 하이재킹/조작 여부  
5) **MIME/Content-Type**: 이중확장자/비정상 MIME, HTML 내 링크 재작성 추적  
6) **DKIM-Signature**: d=/s=/bh=(본문해시)/h=(서명대상헤더) 확인 — 일부 헤더 누락 시 의심

**예시 헤더 발췌**
```
Authentication-Results: mx.corp.example;
  spf=pass smtp.mailfrom=mailer@service.example;
  dkim=pass (signature was verified) header.d=service.example header.s=sel1;
  dmarc=pass (p=none) header.from=example.com
Received: from mta1.service.example (mta1.service.example [198.51.100.23])
    by mx.corp.example with ESMTPS id ...
Return-Path: <mailer@service.example>
From: "HR Team" <hr@example.com>
Reply-To: "HR Team" <hr-team@reply.example.net>
Message-Id: <CA+abc123@service.example>
```

> 위험 신호: `From: ceo@exampIe.com` (I/l 혼동), `Reply-To` 타 도메인, `spf=fail|softfail`, `dkim=none|fail`, `dmarc=fail`,  
> Received 체인에 **수상한 프리-릴레이**(오픈 릴레이, 톱레벨 도메인 불일치) 등.

### 9.3.2 BEC(업무 이메일 침해) 탐지 힌트
- **표현 패턴**: 급한 결재·계좌 변경·기밀 데이터 요청, **주말/야간** 전송  
- **표정합성**: 발신자표시(Display Name)만 일치, 도메인은 **유사 도메인**  
- **행위 신호**: 내부 계정에서 외부로 대량 발송(침해), IMAP 대량 동기화, 규칙(Forward/삭제) 생성  
- **정책**: 외부발신 [EXTERNAL] 태그 + 중요 키워드(계좌/송금) 경보, **결재·계좌 변경은 전화/메신저 2채널 확인**

### 9.3.3 정규식/룰 아이디어(의사)
- **Display Name 스푸핑**
```
if header.From display-name ~= /CEO|CFO|회장|대표/ and sender_domain not in {corp domains} and not ARC.seal=pass:
  raise warning "High-risk display name spoof"
```
- **Reply-To 이탈**
```
if domain(From) != domain(Reply-To) and DMARC != pass:
  quarantine
```

---

## 9.4 실습: DMARC 리포트→정책 강화

> **목적**: p=none으로 **집계(aggregate) 보고**를 수집·분석해  
> 합법 발송원을 모두 정렬(alignment)시킨 뒤, **p=quarantine/reject**로 상향한다.  
> (개인정보·거래처 도메인 노출에 주의: 저장/보관기간 정책 준수)

### 9.4.1 준비
- **DNS DMARC 레코드**: `rua`(집계)·`ruf`(포렌식) 수신 주소 준비  
- **수집 메일함**: dmarc-agg@/dmarc-afrf@ 별도 생성, 메일 파싱 권한  
- **도메인 목록**: 루트/마케팅 서브도메인, **3rd-party 발송 서비스**(CRM, 뉴스레터, 티켓 시스템 등)

### 9.4.2 DMARC Aggregate XML 구조 요약
- `<report_metadata>`: 보고자/기간  
- `<policy_published>`: p/sp/adkim/aspf/pct  
- `<record>` 반복:  
  - `<row>`: source_ip, count, policy_evaluated (dkim/spf result)  
  - `<identifiers>`: header_from  
  - `<auth_results>`: `dkim`/`spf` 상세 결과

### 9.4.3 파이썬 파서(요약·학습용)
```python
# dmarc_agg_parse.py
import sys, gzip, xml.etree.ElementTree as ET
from collections import defaultdict

def parse(path):
    if path.endswith(".gz"): f = gzip.open(path, "rb")
    else: f = open(path, "rb")
    root = ET.parse(f).getroot()
    ns = {}
    pub = root.find("policy_published", ns)
    rows = []
    for rec in root.findall("record", ns):
        row = rec.find("row", ns)
        src = row.findtext("source_ip", default="")
        cnt = int(row.findtext("count", default="1"))
        pol = row.find("policy_evaluated", ns)
        dkim = pol.get("dkim"); spf = pol.get("spf")
        idf = rec.find("identifiers", ns)
        hfrom = idf.findtext("header_from", default="")
        rows.append((src, cnt, hfrom, dkim, spf))
    return rows

stats=defaultdict(int)
for p in sys.argv[1:]:
    for src,cnt,hfrom,dkim,spf in parse(p):
        key = (hfrom, dkim, spf)
        stats[key]+=cnt

print("header_from, dkim, spf, count")
for (hfrom,dkim,spf),c in sorted(stats.items(), key=lambda x:-x[1]):
    print(f"{hfrom},{dkim},{spf},{c}")
```

**사용 예**
```bash
python3 dmarc_agg_parse.py agg/*.xml.gz > summary.csv
```

### 9.4.4 분석·정렬 가이드
1) **`(dkim=pass or spf=pass) & alignment=pass` 비율**을 계산  
2) 실패 트래픽을 **소스IP/AS/역조회**로 묶고, 합법 발송원(예: `sendservice.net`) 식별  
3) 합법 발송원에 대해  
   - **SPF**: 그 서비스의 발신 대역 `include` 추가  
   - **DKIM**: 서비스가 제공하는 **CNAME 기반 키**(관리형 DKIM) or 공개키 TXT 배포  
4) **서브도메인 분리 전략**: 마케팅/뉴스레터는 `mail.example.com`으로 분리, `sp` 정책 별도  
5) 2~3주 추적 후 실패군이 **주로 공격/오탐**이라면 `pct=50`으로 **p=quarantine** 전환  
6) 오탐/정렬 문제 수렴 시 **p=reject** (필요시 `sp=reject`)

### 9.4.5 DNS 레코드 예(단계적)
- **초기**
```
_dmarc.example.com. TXT "v=DMARC1; p=none; rua=mailto:dmarc-agg@example.com; fo=1; aspf=s; adkim=s; pct=100"
```
- **중간(격리 일부)**
```
_dmarc.example.com. TXT "v=DMARC1; p=quarantine; pct=50; rua=mailto:dmarc-agg@example.com; aspf=s; adkim=s"
```
- **최종(거부)**
```
_dmarc.example.com. TXT "v=DMARC1; p=reject; sp=reject; rua=mailto:dmarc-agg@example.com; aspf=s; adkim=s"
```

### 9.4.6 Postfix/OpenDKIM/OpenDMARC 개념 스니펫

**Postfix(main.cf)**
```
smtpd_tls_security_level = may          # 대외 25번 포트: may + MTA-STS로 강제
smtp_tls_security_level  = dane         # 가능하다면 dane(내부/상호)
smtpd_sasl_auth_enable   = yes          # 587 제출 포트에서만
smtpd_relay_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_unauth_destination
```

**OpenDKIM(opendkim.conf)**
```
Syslog                  yes
Canonicalization        relaxed/relaxed
Selector                sel1
AutoRestart             Yes
UMask                   002
Socket                  inet:8891@localhost
KeyTable                /etc/opendkim/KeyTable
SigningTable            /etc/opendkim/SigningTable
```

**OpenDMARC(opendmarc.conf)**
```
AuthservID          mail.example.com
TrustedAuthservIDs  mail.example.com
Socket              inet:8893@localhost
SPFIgnoreResults    false
RequiredHeaders     true
```

> 실제 배포는 배포판/패키지 가이드에 따르고, **체인·권한·퍼미션** 점검을 자동화한다.

### 9.4.7 MTA-STS/TLS-RPT 리포트 분석(개념)
- TLS 실패 원인: 인증서 체인 불완전, SNI 불일치, 구식 TLS, STARTTLS 스트립  
- 리포트 집계: 실패 호스트·사유별 카운트, 재시도/재전송 패턴  
- 대응: 인증서 체인 수정, Outbound MTA SNI 설정, 구식 암호군 제외

### 9.4.8 운영 체크리스트
- [ ] **오픈 릴레이 검사**(외부에서 인증 없이 릴레이 불가)  
- [ ] **587 제출 포트** 분리, SMTP AUTH 강제(TLS)  
- [ ] **SPF 10 lookup 제한 준수**, include 정리(벤더 문서 최신화)  
- [ ] **DKIM 선택자 롤링**, 키 주기 관리(자동화)  
- [ ] **DMARC 보고 수집** 자동화, 4주 추이로 실패군 제거  
- [ ] **MTA-STS enforce**, TLS-RPT 모니터링, 가능 시 **DANE** 병행  
- [ ] **외부발신 배지**, **Reply-To 이탈 경보**, **스레드 하이재킹 룰**  
- [ ] **IMAPS/POP3S만 허용**, OAuth/MFA, 이상로그 경보  
- [ ] **보관·프라이버시**: DMARC·TLS-RPT·포렌식 데이터 보존기간·마스킹 정책

---

## 부록 A. 조사·테스트 명령 치트시트
```bash
# SPF 평가(수신자 MTA가 아닌 로컬 테스트)
dig +short TXT example.com | grep -i spf

# DKIM 공개키
dig +short TXT sel1._domainkey.example.com

# DMARC 레코드
dig +short TXT _dmarc.example.com

# SMTP TLS + STARTTLS
openssl s_client -starttls smtp -connect mx.example.com:25 -servername mx.example.com

# MTA-STS TXT/TLS-RPT
dig +short TXT _mta-sts.example.com
dig +short TXT _smtp._tls.example.com
```

## 부록 B. 간단 BEC 룰(의사 Splunk/Sigma 스타일)
```
title: External Payment Request Risk
detection:
  selection:
    header.from.display_name: /CEO|CFO|회장|대표|재무/
    header.from.domain: not in {example.com,subsidiary.co.kr}
    subject: /송금|계좌|급/
  condition: selection
level: high
```

## 요약
- **전송 보안**은 **MTA-STS/DANE**로 TLS를 **강제/검증**하고, 제출·수신 포트는 **TLS+MFA**로 보호한다.  
- **도메인 인증**은 **SPF(DNS대역)**, **DKIM(서명)**, **DMARC(정렬+정책)**의 3박자를 갖추고,  
  **집계 리포트**로 합법 발송원을 모두 정렬시킨 뒤 **p=reject**까지 상향한다.  
- **포렌식**은 **Authentication-Results, Received 체인, From/Reply-To/Return-Path** 상호 일치로 본다.  
- **운영 핵심**은 자동화(키·레코드·보고), 가시성(리포트/로그/지표), 단계적 정책 강화다.