---
layout: post
title: 운영체제 - 윈도우 10 (1)
date: 2025-11-05 17:25:23 +0900
category: 운영체제
---
# Chapter 21 — Windows 10 (1)

## History

### NT 계열에서 Windows 10까지 간략 연대표

- **1993~2003**: Windows NT 3.x/4.0 → Windows 2000/XP. 커널은 객체 지향적 설계(“NT 오브젝트”), HAL, Executive(메모리/I/O/보안) 확립.
- **2006~2012**: Vista/7/8 — UAC, WDDM 1.0(그래픽 드라이버 모델), 세션0 격리, 서비스 하드닝, PowerShell/ETW 보편화.
- **2015**: **Windows 10 출시**. “**Windows as a Service**” (반기 기능 업데이트 + 월간 품질 업데이트). **UWP** 앱 모델, Microsoft Store, **WDDM 2.x**, **Device Guard/Credential Guard**(VBS) 도입.
- **2016~2020**: **WSL(Windows Subsystem for Linux)** 1 → WSL2(Hyper-V 기반 가상화). **Windows Hello**, Exploit Guard, Application Guard, HVCI(하이퍼바이저 기반 코드 무결성) 확장.
- **2021+**: Windows 10 LTSC/엔터프라이즈 라인 유지, 많은 보안·관리 기능이 Windows 11로 공존/이행.

### “Windows as a Service”의 의미

- **반기/연간 기능 업데이트** + **월간 누적 보안/품질 업데이트**.
- **채널**: SAC(반기) vs **LTSC**(장기 서비스 채널 — 의료·제조 등 변경 최소화).
- **드라이버/펌웨어** 업데이트가 Windows Update 파이프라인에 통합.

### 핵심 기술 전환점

- **보안**: VBS/Isolated LSASS, AppContainer/LowBox, WDAC(코드 무결성 정책), AMSI(안티멀웨어 스캔 인터페이스).
- **그래픽**: WDDM 2.x(프리엠션·스케줄링 개선), DWM(컴포지션), DirectX 12.
- **가상화**: **Hyper-V** 클라이언트 포함, **WSL2**.
- **관리**: MDM(모바일 기기 관리) API, Azure AD 조인, Windows Autopilot.

실습: 현재 상태 파악
```powershell
# 버전/에디션/빌드/핫픽스 요약

Get-ComputerInfo | Select-Object OsName,OsVersion,WindowsProductName,WindowsVersion,OsBuildNumber
Get-HotFix | Sort-Object InstalledOn | Select-Object -Last 5
```

---

## Design Principles

### 하이브리드 커널(모놀리식 + 모듈형)

- **NT 커널**은 전형적 의미의 마이크로커널은 아니지만, **Executive**(I/O Manager, Memory Manager, Object Manager, Security Reference Monitor, Cache Manager, PnP/Power 등)로 역할이 분리되고, **서브시스템**(Win32, POSIX 유사 계층, WSL 등)이 사용자/커널 경계에서 동작.
- **ALPC(Advanced Local Procedure Call)** 로 사용자↔커널, 프로세스 간 고성능 IPC 제공.
- **오브젝트/핸들 테이블**: 파일·파이프·섀도우 카피·섬네일 캐시까지 공통 접근권한 모델로 다룸.

### 호환성 우선 + App Model 분리

- **Win32 API**(Desktop)와 **UWP/WinRT**(스토어 앱)의 **권한/샌드박스/수명주기**를 분리.
- **WOW64**(x64에서 32비트 앱 실행), **AppCompat Shim**으로 레거시 소프트웨어 호환성 유지.

### 보안 기본값(Defense in Depth)

- **UAC**(권한 상승 동의), **SRM**(Security Reference Monitor), **LSASS**(인증/키 관리), **WDAC**(코드 서명 정책), **AppLocker**, **AppContainer/Low Integrity**, **VBS/HVCI**(커널 코드 신뢰 경계 강화).
- **서비스 하드닝**: 서비스 계정 격리, 최소 권한 SID, 네트워크 제한.
- **AMSI**: 스크립트/매크로 실행 시 보안 엔진 개입.

### 신뢰성·성능

- **WER**(Windows Error Reporting) & Fault Bucketing, **ETW**(광범위 추적), **Resilient File System(ReFS)**(서버/워크스테이션 일부 SKU).
- **전력/현대 대기(Modern Standby)**, **스토리지 큐잉/프리엠션**, **메모리 압축**(사용자 세션 단위).

### 관리·배포

- **DISM/WSIM/MDT** 이미지 서비스, **Windows Update for Business**, **WSUS**, **Intune/MDM**, **Autopilot**.
- **그룹 정책(GPO)** vs **MDM 정책** 공존.

실습: 구성 상태 스냅샷
```powershell
# 주요 기능/옵션 확인

Get-WindowsOptionalFeature -Online | Where-Object {$_.State -eq 'Enabled'} | Select-Object FeatureName

# 정책 적용 여부 확인(있다면)

Get-CimInstance -Namespace root\Microsoft\Windows\DeviceGuard -ClassName Win32_DeviceGuard
```

---

## System Components

> 아래 구성은 **부팅 → 커널 초기화 → 세션/로그온 → 사용자 쉘**로 진입하는 전체 경로에 맞춰 설명한다.

### 부팅(UEFI)에서 세션까지

1) **UEFI 펌웨어** → **Windows Boot Manager(bootmgfw.efi)**
2) **winload.efi** 가 **ntoskrnl.exe**, **HAL**, 부팅 드라이버(Boot start) 로드
3) **ntoskrnl** 초기화: 메모리/페이지 파일/오브젝트 매니저/보안 초기화
4) **smss.exe(Session Manager)**:
   - 세션0(서비스용)·세션1+(사용자) 생성
   - **CSRSS**(Client/Server Runtime), **wininit.exe**, **winlogon.exe** 준비
5) **winlogon.exe** → 인증(LSASS) → **userinit.exe** → **explorer.exe**(쉘)

부팅 이벤트 관찰(ETW/WPR)
```powershell
# Windows Performance Recorder(선택 설치)로 부팅 추적 시작/정지(관리자)

wpr -start CPU -start DiskIO -filemode
# 재부팅 후

wpr -stop boot_trace.etl
# Windows Performance Analyzer(WPA)에서 etl 분석

```

### 레이어

- **HAL**: 하드웨어 추상화(인터럽트 라우팅/APIC/타이머/NUMA).
- **스케줄러**: 우선순위/동적 우선순위/퀀텀 기반, 멀티프로세서 balancing(Windows 10에서는 CPU 그룹/프로세서 친화도 확장).
- **메모리 관리자**: 가상 메모리, 파일 백드 페이지 캐시, AWE/large page, 메모리 압축.
- **I/O 매니저**: **IRP**(I/O Request Packet) 라우팅, 드라이버 스택, PnP/파워 매니저 통합.
- **캐시 매니저**: 매핑·리드어헤드·라이트비하인드 조절.
- **보안 레퍼런스 모니터(SRM)**: 토큰/ACL/DACL/SACL/오디트.
- **ALPC**: 고성능 로컬 IPC.
- **WDF(WDM 추상)**: **KMDF/UMDF** 드라이버 프레임워크.

### 사용자 모드 핵심 프로세스

- **smss.exe**: 세션, 페이지 파일, 환경(콘솔 서브시스템) 초기화.
- **csrss.exe**: 콘솔 창, 스레드/프로세스 생성 일부, Win32 서브시스템과 연계.
- **wininit.exe**: **services.exe**(SCM), **lsass.exe**(로그온/SSPI/Kerberos), **lsm**(세션 관리) 구동.
- **services.exe**: 서비스 제어 관리자(서비스 시작/중지/의존성).
- **winlogon.exe**: GINA 대체된 모델에서 Credential Provider와 연계하여 인증·잠금·해제 담당.
- **explorer.exe**: 쉘/파일 탐색기/태스크바.

관찰: 프로세스 트리
```powershell
Get-Process | Sort-Object StartTime | Select-Object Id,ProcessName,StartTime,Path | Format-Table -Auto
```

### 서브시스템 & 앱 모델

- **Win32**: user32/gdi32 → 커널의 **win32k.sys** 그래픽/입력 경로.
- **UWP/WinRT**: 샌드박스(AppContainer, capability 선언 기반), 수명주기 관리, 백그라운드 태스크/토스트 알림.
- **WOW64**: x64에서 32비트 앱을 별도 서브시스템로 실행.
- **WSL/WSL2**:
  - **WSL1**: **Pico process**(NT커널 위 syscall 번역)
  - **WSL2**: 경량 Hyper-V VM 기반(가상 커널), Plan9/VirtIO로 파일/네트 통합.

WSL 설치/상태
```powershell
wsl --status
wsl --install -d Ubuntu
```

### 보안 컴포넌트

- **LSASS**: 자격 증명, Kerberos/NTLM, LSA 플러그인. **Credential Guard** 활성 시 **격리 프로세스**(VBS)로 보호.
- **UAC**: 관리자 토큰/표준 사용자 토큰 이중화, 동의 프롬프트.
- **WDAC/AppLocker**: 허용 서명/경로/퍼블리셔 정책(화이트리스트).
- **AMSI**: 스크립팅 엔진 호출 경로 인터셉트(AV/EDR에 제공).

AMSI를 사용하는 스크립트 엔진(관측)
```powershell
$env:COMPLUS_ForceAMSIInit=1
# PowerShell 스크립트 실행 시 AMSI 후킹 대상이 됨(보안 제품에서 관찰 가능)

```

### 네트워크/방화벽/HTTP 스택

- **Winsock**(user) / **WSK**(kernel) / **HTTP.sys**(커널 HTTP 서버 — IIS/URL ACL).
- **Windows Defender Firewall**(WFP 필터 기반), **IPsec**, **VPN**(RAS), **802.1X**.
- **Netsh/PowerShell**로 방화벽/프로필/규칙 자동화.

예: 443 인바운드 허용 규칙
```powershell
New-NetFirewallRule -DisplayName "Allow HTTPS" -Direction Inbound -Action Allow -Protocol TCP -LocalPort 443
```

### 저장소/파일시스템

- **NTFS**: 저널링, ACL, EFS(파일 암호화), 클러스터 공유 볼륨(CSV) 지원.
- **ReFS**(에디션 한정): 메타데이터 무결성, 스냅샷(VSS와 조합), 큰 볼륨/가상화 워크로드 최적화.
- **스토리지 스택**: Storport, NVMe, SMB3(클라이언트/서버), CSV, Storage Spaces.

볼륨/파일시스템 상태
```powershell
Get-Volume | Select-Object DriveLetter,FileSystem,FileSystemLabel,Size,SizeRemaining,HealthStatus
```

### 드라이버 모델

- **WDM**(기반) → **WDF(KMDF/UMDF)** 로 개발 단순화·안전성 강화.
- **PnP/Power** 상태 기계, **IRP** 파이프라인, I/O 큐 및 취소/타임아웃 관리.
- **WDDM**(그래픽): 커널 모드 미니포트 + 사용자 모드 드라이버(UMD), 스케줄링/메모리 격리.

드라이버 나열·상태
```powershell
Get-CimInstance Win32_SystemDriver | Select-Object Name,State,StartMode,PathName | Sort-Object Name
```

### 진단/관측

- **ETW**: 커널/사용자 이벤트 추적. **PerfView/Windows Performance Recorder/Analyzer** 사용.
- **이벤트 로그**: Application/System/Security, **Microsoft-Windows-*** 디버 채널.
- **리소스 모니터/성능 모니터(PerfMon)**, **ProcMon/ProcExp**(Sysinternals).

ETW: CPU 샘플링 세션 예
```powershell
# CLI 예시

.\PerfView.exe collect -CircularMB:1024 -Zip:true -Providers:CPU_Sampling -NoGui
# 종료 후 PerfView에서 .etl.zip 열어 히트맵/스택 분석

```

---

## 21.3.A 예제 모음 — 실전 시나리오

### A.1 Windows 서비스 최소 골격(C#)

```csharp
// Service1.cs — .NET 6/7 Windows Background Service(Worker Service 템플릿 기반)
// 설치는 sc.exe create 또는 PowerShell New-Service 등을 사용
using System;
using System.ServiceProcess;
using System.Threading;
using System.Threading.Tasks;

public class MinimalService : ServiceBase
{
    private CancellationTokenSource _cts;
    public MinimalService() => ServiceName = "MinimalService";

    protected override void OnStart(string[] args)
    {
        _cts = new CancellationTokenSource();
        Task.Run(async () =>
        {
            while (!_cts.Token.IsCancellationRequested)
            {
                // ETW/이벤트로그/파일로 헬스비트 남기기
                EventLog.WriteEntry("tick", EventLogEntryType.Information);
                await Task.Delay(TimeSpan.FromSeconds(30), _cts.Token);
            }
        });
    }

    protected override void OnStop() => _cts.Cancel();

    public static void Main() => Run(new MinimalService());
}
```

서비스 등록/제거
```powershell
sc.exe create MinimalService binPath= "C:\Path\MinimalService.exe" start= auto
sc.exe start MinimalService
sc.exe stop MinimalService
sc.exe delete MinimalService
```

### A.2 Job Object로 프로세스 격리(C/C++)

```cpp
// job_isolation.cpp — 자식 프로세스 CPU/메모리 제한(간단 예)
#include <windows.h>
#include <stdio.h>

int main() {
    HANDLE hJob = CreateJobObjectW(NULL, L"DemoJob");
    JOBOBJECT_EXTENDED_LIMIT_INFORMATION li = {0};
    li.BasicLimitInformation.LimitFlags = JOB_OBJECT_LIMIT_PROCESS_MEMORY | JOB_OBJECT_LIMIT_ACTIVE_PROCESS;
    li.ProcessMemoryLimit = 200 * 1024 * 1024; // 200MB
    li.BasicLimitInformation.ActiveProcessLimit = 3;
    SetInformationJobObject(hJob, JobObjectExtendedLimitInformation, &li, sizeof(li));

    STARTUPINFOW si = {sizeof(si)}; PROCESS_INFORMATION pi = {0};
    if (CreateProcessW(L"C:\\Windows\\System32\\notepad.exe", NULL, NULL, NULL, FALSE,
                       CREATE_SUSPENDED | CREATE_BREAKAWAY_FROM_JOB, NULL, NULL, &si, &pi)) {
        AssignProcessToJobObject(hJob, pi.hProcess);
        ResumeThread(pi.hThread);
        CloseHandle(pi.hThread); CloseHandle(pi.hProcess);
    }
}
```

### — URL 예약

```powershell
# 커널 모드 HTTP 서버(IIS/HttpListener 등)가 사용할 URL 예약

netsh http add urlacl url=http://+:8080/ user=Everyone
```

C# HttpListener 간단 서버
```csharp
using System;
using System.Net;
using System.Text;
class S {
  static void Main() {
    var l = new HttpListener();
    l.Prefixes.Add("http://+:8080/"); l.Start();
    for(;;){
      var ctx = l.GetContext();
      var bytes = Encoding.UTF8.GetBytes("OK");
      ctx.Response.ContentLength64 = bytes.Length;
      ctx.Response.OutputStream.Write(bytes,0,bytes.Length);
      ctx.Response.Close();
    }
  }
}
```

### A.4 AppLocker/WDAC로 실행 화이트리스트 예(요약)

```powershell
# 예: 특정 디렉터리만 허용(테스트 정책 내보내기)

New-AppLockerPolicy -DefaultRule -RuleType Path |
  Set-AppLockerPolicy -XMLPolicy -Merge -ErrorAction Stop
# 실제 환경에서는 GPO/WDAC(CI 정책)로 서명 기반 허용 권장

```

### A.5 ETW 사용자 이벤트 로깅(C#)

```csharp
using System.Diagnostics.Tracing;
class AppEvents : EventSource {
  public static AppEvents Log = new AppEvents();
  [Event(1, Level = EventLevel.Informational)] public void Started(string v) => WriteEvent(1, v);
}
class Program { static void Main(){ AppEvents.Log.Started("1.0.0"); } }
```
WPA/PerfView에서 `AppEvents` 프로바이더를 구독하여 앱 이벤트를 타임라인으로 확인.

---

## 21.3.B 보안 하드닝 빠른 체크리스트

1) **서비스 격리**: 전용 계정(가급적 서비스 SID), 네트워크/파일 시스템 최소 권한, **Job Object**·**Integrity Level** 제약.
2) **코드 실행 제어**: WDAC/AppLocker(서명 기반), PowerShell Constrained Language/AMSI.
3) **자격 증명 보호**: Credential Guard, RDP/WinRM 최소화, LSASS 접근 제한.
4) **업데이트/드라이버**: WUfB/WSUS, 드라이버 서명 강제(HVCI).
5) **감사/관측**: 보안 이벤트(4624/4625 등), Sysmon, ETW 추적, Attack Surface Reduction 규칙.

---

## 21.3.C 문제 해결(티켓팅 전에 볼 것)

- **리소스 급증**: “리소스 모니터/성능 모니터 + WPA(ETW)”로 근본 원인(드라이버 DPC, 디스크 큐, 컨텍스트 스위치 등) 확인.
- **부팅 지연**: `WPR -boottrace`, 서비스 자동 시작 지연 옵션, 드라이버 초기화 순서 재검토.
- **UWP 문제**: AppX 배포/권한(Capability) 누락, AppContainer ACL 확인.
- **네트워크 이슈**: Windows Firewall 로그, netsh trace, ETW `Microsoft-Windows-TCPIP`.

---

# 정리

- **Windows 10**은 NT 계열의 객체·오브젝트 기반 커널을 계승하면서, **보안(부팅부터 커널/LSASS 격리), 가상화(WSL/Hyper-V), 현대 관리(MDM/WUfB)** 를 결합한 **서비스형 Windows**이다.
- **디자인 원칙**은 “호환성 유지 + 보안 기본값 + 진단/관측 우선 + 관리 자동화”로 요약된다.
- **시스템 구성요소**는 **부팅 체인 → NT 커널(Executive) → 세션/로그온 → Win32/UWP 서브시스템 → 서비스/드라이버/스토리지/네트워크/보안**으로 층층이 결합된다.
- 본문 예제(서비스 골격, Job Object 격리, HTTP.sys URL 예약, ETW 로깅, 방화벽 규칙)는 **운영/개발 실전**에서 곧바로 쓰이며, 보안·성능·관측의 세 축을 함께 다룬다.
