---
layout: post
title: C++ - ìŠ¤ë§ˆíŠ¸ í¬ì¸í„° êµ¬í˜„ (4)
date: 2024-09-26 19:20:23 +0900
category: Cpp
---
# ğŸ”„ shared_from_thisì™€ enable_shared_from_this ì™„ì „ ì •ë³µ

`shared_ptr`ì„ ì‚¬ìš©í•˜ë‹¤ ë³´ë©´, **ìê¸° ìì‹ ì„ ê°€ë¦¬í‚¤ëŠ” `shared_ptr`ì„ í´ë˜ìŠ¤ ë‚´ë¶€ì—ì„œ ìƒì„±**í•˜ê³  ì‹¶ì„ ë•Œê°€ ìˆìŠµë‹ˆë‹¤.  
ì´ëŸ´ ë•Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë°”ë¡œ `std::enable_shared_from_this<T>`ì…ë‹ˆë‹¤.

---

## ğŸ¤” ì™œ í•„ìš”í•œê°€?

```cpp
class Widget {
public:
    std::shared_ptr<Widget> getSelf() {
        return std::shared_ptr<Widget>(this);  // ğŸ”¥ ë¬¸ì œ ë°œìƒ!
    }
};
```

- ìœ„ ì½”ë“œëŠ” **ì´ë¯¸ shared_ptrë¡œ ê´€ë¦¬ë˜ê³  ìˆëŠ” ê°ì²´ë¥¼ ë‹¤ì‹œ í¬ì¥** â†’ **ì´ì¤‘ í•´ì œ(crash) ìœ„í—˜**
- í•´ê²°ì±…: `shared_from_this()`ëŠ” ì´ë¯¸ ìƒì„±ëœ shared_ptrê³¼ ì—°ê²°ëœ í¬ì¸í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë°˜í™˜

---

## âœ… ì‚¬ìš©ë²•: `enable_shared_from_this`

```cpp
#include <memory>
#include <iostream>

class Widget : public std::enable_shared_from_this<Widget> {
public:
    void show() {
        auto self = shared_from_this();
        std::cout << "Self use_count: " << self.use_count() << "\n";
    }
};

int main() {
    auto w = std::make_shared<Widget>();
    w->show();  // ì•ˆì „í•˜ê²Œ ìê¸° ìì‹ ì„ ì°¸ì¡°
}
```

### ğŸ§  ë‚´ë¶€ ë™ì‘ ì›ë¦¬

- `shared_ptr<T>`ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ **ControlBlock í¬ì¸í„°**ë¥¼ ê°€ì§€ê³  ìˆìŒ
- `enable_shared_from_this`ëŠ” **ìê¸° ìì‹ ì˜ weak_ptrì„ ì €ì¥**í•¨ìœ¼ë¡œì¨
  `shared_from_this()`ì—ì„œ ê¸°ì¡´ `shared_ptr`ì„ ë³µì› ê°€ëŠ¥í•˜ê²Œ í•¨

---

## ğŸ”¬ ì§ì ‘ êµ¬í˜„í•´ ë³´ê¸° (ê°„ë‹¨ ëª¨ë¸)

```cpp
template <typename T>
class EnableSharedFromThis {
protected:
    mutable std::weak_ptr<T> weak_this;

public:
    std::shared_ptr<T> shared_from_this() const {
        return weak_this.lock();
    }

    void _set_weak_this(const std::shared_ptr<T>& sp) const {
        if (weak_this.expired())
            weak_this = sp;
    }
};
```

### ğŸ“¦ SharedPtrê³¼ ì—°ê²°

```cpp
template <typename T>
class MySharedPtr {
    T* ptr;
    ControlBlock* ctrl;
    // ìƒëµëœ ë‚´ìš©...

    MySharedPtr(ControlBlock* cb) : ctrl(cb), ptr(cb->getObject()) {
        // enable_shared_from_this ì§€ì›
        if constexpr (std::is_base_of_v<EnableSharedFromThis<T>, T>) {
            ptr->_set_weak_this(MySharedPtr<T>(*this));
        }
    }
};
```

---

## â— ì£¼ì˜ì‚¬í•­

| ì£¼ì˜ì                              | ì„¤ëª…                                                   |
|------------------------------------|----------------------------------------------------------|
| `enable_shared_from_this` ì—†ì´ í˜¸ì¶œ | `shared_from_this()`ëŠ” ì˜ˆì™¸ ë°œìƒ (bad_weak_ptr)         |
| `make_shared`ë¡œ ìƒì„±í•´ì•¼ ì•ˆì „í•¨     | ë‚´ë¶€ì—ì„œ weak_this ì—°ê²°ì´ ìë™ìœ¼ë¡œ ì´ë£¨ì–´ì§             |
| ìƒì„±ì ë‚´ë¶€ì—ì„œ ì‚¬ìš© ê¸ˆì§€          | ì•„ì§ weak_this ì„¤ì • ì „ì´ë¯€ë¡œ ì˜ˆì™¸ ë°œìƒ ê°€ëŠ¥             |

---

## âœ… ìš”ì•½

| ê¸°ëŠ¥                 | ì„¤ëª…                                                             |
|----------------------|------------------------------------------------------------------|
| `shared_from_this()` | ì•ˆì „í•˜ê²Œ ìê¸° ìì‹ ì˜ shared_ptrë¥¼ ë°˜í™˜                          |
| `enable_shared_from_this<T>` | weak_ptrì„ ë‚´ë¶€ì— ì €ì¥í•´ shared_ptrê³¼ ì—°ê²° ìœ ì§€           |
| ì§ì ‘ ìƒì„± ê¸ˆì§€       | `std::shared_ptr<T>(this)` â†’ ì ˆëŒ€ ê¸ˆì§€ (ì´ì¤‘ í•´ì œ ìœ„í—˜)         |
| ìƒì„± ì‹œì  ì£¼ì˜       | ìƒì„±ì ë‚´ë¶€ì—ì„œ `shared_from_this()` í˜¸ì¶œí•˜ë©´ ì˜ˆì™¸ ë°œìƒ          |

---

## ğŸ’¬ ë§ˆë¬´ë¦¬

- `shared_from_this()`ëŠ” **ìŠ¤ìŠ¤ë¡œë¥¼ ê°€ë¦¬í‚¤ëŠ” shared_ptrì´ í•„ìš”í•  ë•Œ í•„ìˆ˜ ë„êµ¬**
- C++ ë‚´ë¶€ì—ì„œ ìŠ¤ë§ˆíŠ¸ í¬ì¸í„° ìƒëª… ì£¼ê¸°ë¥¼ ì™„ë²½í•˜ê²Œ ì œì–´í•  ìˆ˜ ìˆê²Œ í•´ì¤Œ
- ì§ì ‘ êµ¬í˜„ì„ í†µí•´ `weak_ptr`ê³¼ `shared_ptr`ì˜ ê´€ê³„ë¥¼ ì²´ê°í•  ìˆ˜ ìˆìŒ