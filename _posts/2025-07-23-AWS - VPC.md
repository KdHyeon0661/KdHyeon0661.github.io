---
layout: post
title: AWS - VPC
date: 2025-07-23 18:20:23 +0900
category: AWS
---
# AWS VPC

## 큰 그림 — VPC가 푸는 문제

- **격리(멀티 테넌시)**: 계정·VPC 단위 네트워크 격리
- **주소 계획**: 사설 CIDR(IPv4/IPv6) 설계, AZ 단위 서브넷 샤딩
- **연결성**: IGW/NAT/프라이빗 링크/엔드포인트/피어링/TGW/VPN/DX
- **보안**: SG(Stateful)/NACL(Stateless)/Route 53 Resolver 정책/Traffic Mirroring
- **운영/가시성**: Flow Logs/CloudWatch/CloudTrail/Config/Inspector
- **확장성/복원력**: AZ 분산, NAT 게이트웨이 HA, 경로검증/헬스체크(게이트웨이 엔드포인트는 제외)

---

## VPC 기초부터: CIDR·서브넷·AZ 맵

### CIDR 용량 산정

예: 리전 `ap-northeast-2`, **2AZ × (퍼블릭/앱/DB) = 6 subnets**, 각 서브넷에 /24 필요하다고 하자.
필요 주소량: $$6 \times 2^{(32-24)} = 6 \times 256 = 1536$$ (여유 포함 /20 권장)

- **권장 VPC CIDR**: `10.0.0.0/16` 또는 `10.0.0.0/20` 이상
- 서브넷 샘플:
  - `10.0.1.0/24`  (Public-a)
  - `10.0.2.0/24`  (App-a)
  - `10.0.3.0/24`  (DB-a)
  - `10.0.101.0/24`(Public-b)
  - `10.0.102.0/24`(App-b)
  - `10.0.103.0/24`(DB-b)

> 주의: 서브넷은 **단일 AZ**에 종속. IGW는 VPC 당 1개, NAT GW는 AZ마다 1개 권장(HA).

### 간단 체크

- VPC에 /56 IPv6 CIDR 할당 → 각 서브넷에 /64 분할
- 퍼블릭 통신은 **Egress-Only IGW** (IPv6 NAT 없음)

---

## 라우팅·게이트웨이: IGW/NAT/엔드포인트/프라이빗 링크

### 인터넷 게이트웨이(IGW)

퍼블릭 서브넷의 라우트 테이블 예:

| Destination | Target     | 비고                 |
| ---         | ---        | ---                  |
| 10.0.0.0/16 | local      | VPC 내부             |
| 0.0.0.0/0   | igw-xxxxxx | 인터넷 아웃바운드/인바운드 |

필수: 퍼블릭 IP(또는 탄력 IP) + 서브넷 `Auto-assign public IPv4` 또는 인스턴스 수준 퍼블릭 IP.

### NAT: 게이트웨이 vs 인스턴스

| 항목 | NAT 게이트웨이 | NAT 인스턴스 |
| --- | --- | --- |
| 운영 | 완전관리형, 패치/스케일 자동 | 직접 패치·모니터·오토스케일 필요 |
| 고가용성 | AZ 단위 생성. 다중 AZ 배치 권장 | ASG/HAProxy 등 수동 설계 |
| 성능/병목 | 고성능, 탄력 | 인스턴스 스펙/ENI/커널 튜닝 영향 |
| 비용 | 상대적으로 높음 | 낮을 수 있으나 O&M 비용↑ |

**실무 권장**: 프라이빗 서브넷 수가 많고 트래픽이 크면 AZ별 NAT GW 배치 + 각 프라이빗 서브넷은 **동일 AZ** NAT를 참조(크로스 AZ 요금/지연 방지).

### 게이트웨이 엔드포인트 vs 인터페이스 엔드포인트

- **Gateway Endpoint**: S3/DynamoDB 전용, 라우트테이블에 **프리픽스** 추가(데이터 전송 비용 절감, 인터넷 경로 불필요)
- **Interface Endpoint (AWS PrivateLink)**: 대부분의 AWS 서비스·서드파티에 **ENI** 생성, **보안그룹**으로 제어, **DNS 프라이빗 호스트존** 연동

```bash
# S3 게이트웨이 엔드포인트 생성(예시)

aws ec2 create-vpc-endpoint \
  --vpc-id vpc-xxxx \
  --service-name com.amazonaws.ap-northeast-2.s3 \
  --route-table-ids rtb-aaa rtb-bbb \
  --vpc-endpoint-type Gateway
```

**PrivateLink 유스케이스**: SaaS API를 퍼블릭 인터넷 없이 프라이빗 ENI로 사용.

---

## 보안: 보안 그룹 vs NACL, 그리고 전략

### 요약 비교

| 항목 | 보안 그룹(SG) | 네트워크 ACL(NACL) |
| --- | --- | --- |
| 계층 | ENI/인스턴스 | 서브넷 |
| 상태성 | **Stateful** | **Stateless** |
| 규칙 | Allow만 | Allow/Deny |
| 기본 | Outbound Allow All | In/Out 모두 Deny |
| 운영 난이도 | 낮음(동적) | 높음(순서·정책쌍) |

**권장 디자인**: SG로 애플리케이션 간 허용 관계를 모델링, NACL은 **광역 거부/레이트 제한성** 또는 규정 준수 시 최소한으로.

### SG 예시 — 3-Tier

- ALB-SG: In `80/443` from `0.0.0.0/0`, Out to App-SG
- App-SG: In `8080` from ALB-SG, Out to DB-SG `5432/3306`
- DB-SG: In `5432/3306` from App-SG, Out 제한적(패치/백업 목적)

```plaintext
[ALB-SG] <--80/443-- Internet
   |
   v
[APP-SG] <--8080-- ALB-SG
   |
   v
[DB-SG]  <--5432/3306-- APP-SG
```

### NACL 샘플

| Rule | Type | Proto | Port | Src/Dst | Action |
| --- | --- | --- | --- | --- | --- |
| 100 | HTTP | TCP | 80 | 0.0.0.0/0 (In) | ALLOW |
| 110 | HTTPS | TCP | 443 | 0.0.0.0/0 (In) | ALLOW |
| 200 | Ephemeral | TCP | 1024-65535 | 0.0.0.0/0 (Out) | ALLOW |
| * | All | All | All | 0.0.0.0/0 | DENY |

> Stateless이므로 In/Out에 **응답 포트도 별도 허용** 필요.

---

## 표준 3-Tier VPC 레퍼런스(멀티 AZ, HA NAT, 엔드포인트)

아키텍처(요지):

```
VPC 10.0.0.0/16
├── Public Subnet A 10.0.1.0/24  ──IGW── Internet
│   └─ ALB, NAT-GW-A (EIP)
├── Private App Subnet A 10.0.2.0/24 ── route: 0.0.0.0/0 -> NAT-GW-A
│   └─ ECS/EKS/EC2 App
├── Private DB Subnet A  10.0.3.0/24 (no route to IGW/NAT)
│   └─ RDS/Aurora
├── Public Subnet B 10.0.101.0/24 ──IGW──
│   └─ ALB(az-aware), NAT-GW-B (EIP)
├── Private App Subnet B 10.0.102.0/24 -> NAT-GW-B
└── Private DB Subnet B  10.0.103.0/24 (isolation)

+ Gateway Endpoint: S3, DynamoDB
+ Interface Endpoint: ECR, SSM, CloudWatch Logs, STS 등
+ Route53 Resolver Inbound(온프레 질의 수신) / Outbound(온프레 포워딩)
```

핵심:
- **AZ 맞춤 NAT** 라우팅 (크로스 AZ NAT 금지)
- DB 서브넷은 **인터넷/네트워크 경로 없음**
- **게이트웨이 엔드포인트(S3/DDB)** 로 비용↓/보안↑
- 앱에서 컨테이너 이미지/ECR, 로깅/CloudWatch는 **인터페이스 엔드포인트**로 프라이빗 통신

---

## 라우팅 테이블 설계 예시

### 퍼블릭 서브넷 RT

| Destination | Target     |
| --- | --- |
| 10.0.0.0/16 | local      |
| 0.0.0.0/0   | igw-xxxxxx |

### 앱 프라이빗 서브넷 RT(AZ-A)

| Destination | Target       |
| --- | --- |
| 10.0.0.0/16 | local        |
| 0.0.0.0/0   | nat-aaaaaa   |
| com.amazonaws.ap-northeast-2.s3 | vpce-rt-entry (Gateway EP) |

> S3는 NAT 대신 **게이트웨이 엔드포인트** 경로로 최우선 매칭.

---

## IaC — Terraform/CloudFormation 스니펫

### Terraform: VPC + 2AZ 서브넷 + IGW + NAT + 기본 SG

```hcl
provider "aws" { region = "ap-northeast-2" }

resource "aws_vpc" "main" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true
  enable_dns_support   = true
  tags = { Name = "demo-vpc" }
}

resource "aws_internet_gateway" "igw" {
  vpc_id = aws_vpc.main.id
}

# Subnets

resource "aws_subnet" "pub_a" {
  vpc_id                  = aws_vpc.main.id
  cidr_block              = "10.0.1.0/24"
  availability_zone       = "ap-northeast-2a"
  map_public_ip_on_launch = true
  tags = { Tier = "public" }
}
resource "aws_subnet" "app_a" {
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.2.0/24"
  availability_zone = "ap-northeast-2a"
  tags = { Tier = "app" }
}

# RT: public

resource "aws_route_table" "public" {
  vpc_id = aws_vpc.main.id
  route { cidr_block = "0.0.0.0/0" gateway_id = aws_internet_gateway.igw.id }
}
resource "aws_route_table_association" "pub_a" {
  subnet_id      = aws_subnet.pub_a.id
  route_table_id = aws_route_table.public.id
}

# NAT (in Public)

resource "aws_eip" "nat_a" { domain = "vpc" }
resource "aws_nat_gateway" "nat_a" {
  allocation_id = aws_eip.nat_a.id
  subnet_id     = aws_subnet.pub_a.id
}

# RT: app

resource "aws_route_table" "app_a" {
  vpc_id = aws_vpc.main.id
  route { cidr_block = "0.0.0.0/0" nat_gateway_id = aws_nat_gateway.nat_a.id }
}
resource "aws_route_table_association" "app_a" {
  subnet_id      = aws_subnet.app_a.id
  route_table_id = aws_route_table.app_a.id
}

# SG: ALB -> App -> DB 패턴 예시 중 App SG

resource "aws_security_group" "app_sg" {
  name        = "app-sg"
  description = "Allow 8080 from ALB-SG"
  vpc_id      = aws_vpc.main.id

  ingress {
    from_port       = 8080
    to_port         = 8080
    protocol        = "tcp"
    security_groups = [aws_security_group.alb_sg.id]
  }
  egress { from_port = 0 to_port = 0 protocol = "-1" cidr_blocks = ["0.0.0.0/0"] }
}
resource "aws_security_group" "alb_sg" {
  name = "alb-sg" vpc_id = aws_vpc.main.id
  ingress { from_port=80 to_port=80 protocol="tcp" cidr_blocks=["0.0.0.0/0"] }
  egress  { from_port=0 to_port=0 protocol="-1" cidr_blocks=["0.0.0.0/0"] }
}
```

### — S3 Gateway VPCE + Route

```yaml
Resources:
  Vpc: { Type: AWS::EC2::VPC, Properties: { CidrBlock: 10.0.0.0/16, EnableDnsSupport: true, EnableDnsHostnames: true } }
  RtApp:
    Type: AWS::EC2::RouteTable
    Properties: { VpcId: !Ref Vpc }
  S3Endpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref Vpc
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.s3"
      RouteTableIds: [ !Ref RtApp ]
      VpcEndpointType: Gateway
```

---

## 하이브리드: VPN, Direct Connect, TGW, 피어링

### 선택 기준

| 요구 | 권장 |
| --- | --- |
| 간단한 사이트 간 연결 | **Site-to-Site VPN** |
| 전용·대역폭·일관 지연 | **Direct Connect** |
| 다수 VPC/온프레 통합 허브 | **Transit Gateway** |
| 1:1 VPC 경로(간단) | **VPC Peering**(비전달, Centralized 취약) |

### 라우팅 주의

- 피어링: **트랜싯 라우팅 불가**(A-B, B-C 연결해도 A-C 안 감)
- TGW: 중앙 라우팅 도메인, 도메인 간 라우팅 분리/공유
- VPN BGP 동적 라우팅 권장(정적 라우팅은 운영 비용↑)

---

## 네임서비스·프라이빗 DNS: Route 53 Resolver/PHZ

- **프라이빗 호스티드 존(PHZ)**: 특정 VPC 내부 도메인
- **Resolver Inbound/Outbound**: 온프레 ↔ VPC 간 질의 포워딩
- **Interface Endpoint의 전용 도메인**을 PHZ에 바인딩해 **프라이빗 DNS**로 통합

---

## 관측/운영: VPC Flow Logs, CloudWatch, 트러블슈팅

### Flow Logs: 필수 필드

- `interface-id`, `srcaddr`, `dstaddr`, `srcport`, `dstport`, `action(ACCEPT/REJECT)`, `bytes`, `packets`

**Logs Insights** 예제(거부 트래픽 TOP src):

```sql
fields @timestamp, interfaceId, srcAddr, dstAddr, dstPort, action
| filter action = "REJECT"
| stats count() as rejects by srcAddr, dstAddr, dstPort
| sort rejects desc
| limit 50
```

**느린 통신 추적**: ALB→App→DB 단계별 ACCEPT/REJECT·지연 구간 식별.

### 자주 터지는 문제 체크리스트

- [ ] **서브넷-AZ 불일치**(리소스는 a, NAT는 b)
- [ ] **RT에 0.0.0.0/0 없거나 잘못된 타깃**
- [ ] **SG는 Allow인데 NACL에서 Deny**
- [ ] **Egress-Only IGW**(IPv6)인데 IPv4 만지는 실수
- [ ] **게이트웨이 엔드포인트 라우트 누락**(S3/DDB NAT 경유)
- [ ] **프라이빗 호스트존 VPC 연계 누락**
- [ ] **TGW 라우팅 테이블 연결/전파 미설정**
- [ ] **DNS 해석 비활성**(VPC 설정 `enableDnsHostnames=false`)

---

## 실습 1 — 최소 구성 퍼블릭 웹 서버

1) VPC `10.0.0.0/16`
2) Public Subnet `10.0.1.0/24` (`map_public_ip_on_launch=true`)
3) IGW 연결, RT: `0.0.0.0/0 -> IGW`
4) SG: `80/22` 오픈
5) EC2(아마존 리눅스) + 유저데이터:

```bash
#!/bin/bash

yum update -y
amazon-linux-extras install nginx1 -y
systemctl enable nginx
systemctl start nginx
echo "Hello from VPC Public!" > /usr/share/nginx/html/index.html
```

접속: `http://<EIP or Public-IP>/`

---

## 실습 2 — 프라이빗 앱 + NAT + S3 엔드포인트

- App Subnet: `10.0.2.0/24`(RT: `0.0.0.0/0 -> NAT-A`)
- **S3 Gateway Endpoint** 추가 → 라우트에 `pl-xxxx` 자동 주입
- SG: 아웃바운드 `0.0.0.0/0`(또는 서비스 엔드포인트 SG 위주)
- 검증:

```bash
# 퍼블릭 IP 없는 EC2에서

curl http://169.254.169.254/latest/meta-data/local-ipv4
aws s3 ls s3://my-bucket  # 인터넷 없이 접근(게이트웨이 EP 경유)
```

---

## 수학으로 보는 서브넷 슬라이싱(빠른 감)

- /16 → /24:
$$
2^{(24-16)} = 256 \text{ 개 서브넷} \quad (\text{각 } 256 \text{ IP})
$$
- /20 → /24:
$$
2^{(24-20)} = 16 \text{ 개 서브넷}
$$
- AZ 2개·티어 3개·여유 2배 → /20 또는 /16 권장

---

## 비용 최적화 팁

- **NAT GW**: AZ별 배치 필요지만, 트래픽 패턴 따라 **엔드포인트 우선**으로 인터넷 경로 최소화
- **Flow Logs**: **S3 + Parquet**로 장기 보관, Athena 질의 비용↓
- **인터페이스 엔드포인트**: 많이 쓰면 비용↑ → 필요 서비스만, SG로 최소화
- **프라이빗 ALB/NLB**: 불필요한 퍼블릭 트래픽 차단, 데이터 전송 비용 관리

---

## 보안 베스트 프랙티스(요지)

- SG **기본 거부 모델**: 발신도 축소(목적지 SG/포트 기반)
- NACL 최소 규칙 + **DENY ALL** 기본
- **VPC 엔드포인트 정책**으로 S3 경로 제한(버킷/프리픽스)
- **KMS**(EBS/RDS/Logs) + **TLS 내부 통신**(NLB TLS Passthrough/Term)
- **랜딩존/네트워크 전용 계정** + **핵심 리소스 태깅**(rtb/subnet/vpc)
- **Config/CloudTrail**로 보안 이벤트 추적, **GuardDuty** 활성화

---

## 운영 오브저버빌리티 대시보드(예시 JSON)

```json
{
  "widgets": [
    { "type": "metric", "properties": {
      "title": "NAT-A BytesOutToDestination",
      "metrics": [["AWS/NATGateway","BytesOutToDestination","NatGatewayId","nat-aaaaa"]],
      "stat": "Sum","period":300,"region":"ap-northeast-2"
    }},
    { "type": "metric", "properties": {
      "title": "ALB 5XX",
      "metrics": [["AWS/ApplicationELB","HTTPCode_ELB_5XX_Count","LoadBalancer","app/myalb/xxx"]],
      "stat": "Sum","period":300
    }}
  ]
}
```

---

## 자주 묻는 질문(FAQ)

**Q1. 퍼블릭 서브넷의 정의는?**
A. **RT에 0.0.0.0/0 → IGW**가 있고, 인스턴스에 퍼블릭 IP가 있을 때 인터넷 인/아웃 가능.

**Q2. NAT 없이도 프라이빗 인스턴스가 S3 접근?**
A. **게이트웨이 엔드포인트(S3)** 설정하면 가능. 라우트 엔트리 우선순위에 주의.

**Q3. 피어링과 TGW 차이?**
A. 피어링은 **1:1, 비전달**, TGW는 **허브-스포크, 전달 가능**, 대규모 네트워크에 적합.

**Q4. IPv6에서 NAT?**
A. 없음. **Egress-Only IGW** 사용.

---

## 최종 점검 체크리스트

- [ ] CIDR 계획(여유/성장/하이브리드 충돌 회피)
- [ ] AZ별 퍼블릭/앱/DB 서브넷 구획
- [ ] 퍼블릭 RT에 IGW, 프라이빗 RT에 AZ별 NAT
- [ ] 엔드포인트(S3/DDB/필요 서비스)로 인터넷 경로 축소
- [ ] SG: 서비스 간 최소 허용, NACL: 기본 거부 + 최소 허용
- [ ] PHZ/Resolver로 내부 DNS 일관성
- [ ] Flow Logs/Athena/CloudWatch로 관측·알람
- [ ] IaC와 태깅, Config/CloudTrail/GuardDuty로 거버넌스
- [ ] 정기 네트워크 DR/펜테스트·성능/비용 점검

---

## 빠른 CLI

```bash
# VPC/서브넷/IGW/RT 간단 셋업(일부)

aws ec2 create-vpc --cidr-block 10.0.0.0/16
aws ec2 create-internet-gateway
aws ec2 attach-internet-gateway --internet-gateway-id igw-xxx --vpc-id vpc-xxx
aws ec2 create-subnet --vpc-id vpc-xxx --cidr-block 10.0.1.0/24 --availability-zone ap-northeast-2a
aws ec2 modify-subnet-attribute --subnet-id subnet-xxx --map-public-ip-on-launch
aws ec2 create-route-table --vpc-id vpc-xxx
aws ec2 create-route --route-table-id rtb-xxx --destination-cidr-block 0.0.0.0/0 --gateway-id igw-xxx
aws ec2 associate-route-table --subnet-id subnet-xxx --route-table-id rtb-xxx
```

---

## AWS NLB/ALB 내부 통신 패턴 예시

- 퍼블릭 ALB → 프라이빗 App (ALB SG → App SG)
- 내부 NLB(TLS): 서버 인증/클라이언트 인증(mTLS)로 **동서 트래픽** 보호

---

## 예제 보안 그룹(정규화 버전)

```plaintext
# ALB-SG

IN: 80/443 from 0.0.0.0/0
OUT: to APP-SG:8080

# APP-SG

IN: 8080 from ALB-SG
OUT: to DB-SG:5432/3306, to VPCe-SG:443

# DB-SG

IN: 5432/3306 from APP-SG
OUT: to Backup/Monitoring only
```

---

## 결론

VPC는 AWS 인프라의 **네트워크·보안·연결성**의 핵심 축이다.
**표준 3-Tier 멀티 AZ VPC** 템플릿을 바탕으로, **엔드포인트와 프라이빗 링크, SG/NACL 역할 분담, TGW/피어링, PHZ/Resolver**까지 체계화하면,
보안·가용성·비용·운영 편의성이 모두 균형 잡힌 **생산급(Production-grade)** 네트워크를 만들 수 있다.
본 문서의 IaC/체크리스트/트러블슈팅을 그대로 적용해 **재현 가능한 네트워크 설계**를 표준화하라.
