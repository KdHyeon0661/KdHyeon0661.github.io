---
layout: post
title: TCPIP - TCP 연결 관리
date: 2025-09-04 17:25:23 +0900
category: TCPIP
---
# TCP 연결 관리

## TCP 유한 상태 머신의 이론적 기반

### 상태 머신의 수학적 모델
TCP FSM은 공식적으로 튜플 M = (Q, Σ, δ, q₀, F)로 표현할 수 있습니다:
- **Q**: 상태 집합 {CLOSED, LISTEN, SYN_SENT, SYN_RCVD, ESTABLISHED, FIN_WAIT_1, FIN_WAIT_2, CLOSING, TIME_WAIT, CLOSE_WAIT, LAST_ACK}
- **Σ**: 입력 알파벳 (이벤트 집합) - {APP_PASSIVE_OPEN, APP_ACTIVE_OPEN, APP_SEND, APP_CLOSE, RCV_SYN, RCV_ACK, RCV_FIN, RCV_FIN_ACK, TIMEOUT}
- **δ**: 전이 함수 Q × Σ → Q
- **q₀**: 초기 상태 CLOSED
- **F**: 최종 상태 {CLOSED}

### 상태 전이의 정형적 규칙
각 상태 전이는 아래의 공리를 따릅니다:

1. **상호배타성 원리**: 
   - 동일한 입력에 대해 한 상태에서 두 개 이상의 다른 상태로 전이 불가
   - δ(q, σ)는 유일한 상태값을 반환

2. **완전성 보장**:
   - 정의되지 않은 입력은 자동으로 오류 처리 또는 무시
   - 이는 프로토콜 견고성의 수학적 기반

3. **순환성 제한**:
   - TIME_WAIT → CLOSED를 제외하고는 순환 전이가 존재하지 않음
   - 이는 연결 수명의 유한성을 보장

## 연결 설정의 이론적 의미론

### 3방향 핸드셰이크의 논리적 필요성
TCP의 3방향 핸드셰이크는 단순한 실용적 선택이 아닌, 분산 시스템의 근본적 문제에 대한 해법입니다:

#### Two Generals' Problem과의 관계
TCP 핸드셰이크는 Two Generals' Problem의 현실적 해결책으로 볼 수 있습니다:

```
Two Generals' Problem을 TCP로 매핑:
General A (클라이언트)          General B (서버)
"공격하자" (SYN) ------------>
"확인, 공격하자" (SYN-ACK) <---
"확인받음" (ACK) ------------>
```

**이론적 통찰**: 
- 완벽한 합의는 이론적으로 불가능하지만(비동기 통신에서)
- TCP는 유한한 재전송과 타임아웃으로 실용적 합의 달성
- 확률적 완결성(probabilistic termination) 제공

#### 시퀀스 번호 공간의 순환적 특성
TCP 시퀀스 번호는 2³² 크기의 순환 공간에서 작동합니다. 이는:

1. **모듈러 연산 기반 비교**: 모든 시퀀스 비교는 mod 2³²에서 수행
2. **PAWS(Protection Against Wrapped Sequence)**: 
   - 2³² 바이트 전송 시 시퀀스 번호 재사용 문제
   - 타임스탬프 옵션으로 구별 가능하도록 확장

### 초기 시퀀스 번호(ISN)의 암호학적 의미

#### ISN 생성의 보안 요구사항
RFC 6528에서 제시하는 ISN 생성의 암호학적 속성:

1. **예측 불가능성**: 
   - 미래 ISN 추정이 계산상 불가능해야 함
   - P[ISNₜ₊₁ = x | ISN₀...ISNₜ] ≈ 2⁻³²

2. **균일 분포**: 
   - 모든 ISN이 동일한 확률로 선택되어야 함
   - 이는 시퀀스 번호 추측 공격 방지

3. **컨텍스트 분리**:
   - 서로 다른 연결 간 ISN 상관관계 최소화
   - (srcIP, srcPort, dstIP, dstPort) 튜플별 독립성 유지

#### 암호학적 구조 분석
ISN 생성기는 사실상 의사난수 함수(PRF)로 모델링 가능:
```
ISN = PRF(secret_key, (IP_src, Port_src, IP_dst, Port_dst, counter)) ⊕ timestamp
```
여기서 PRF는 암호학적 해시 함수(MD5, SHA-1, SHA-256)로 구현됩니다.

## 연결 상태의 정보 이론적 분석

### 상태 정보의 엔트로피 개념
각 TCP 상태는 특정 정보량을 포함하고 있으며, 이는 Shannon 엔트로피로 분석 가능:

#### 상태별 정보 내용
1. **LISTEN 상태**: 
   - 정보량 낮음 (대기 중인 연결 없음)
   - 엔트로피 H ≈ 0

2. **SYN_RCVD 상태**:
   - 클라이언트 정보 포함
   - 엔트로피 H = H(Client_IP) + H(Client_Port) + H(ISN_c)

3. **ESTABLISHED 상태**:
   - 최대 정보량 보유
   - H = H(시퀀스 공간) + H(윈도우 상태) + H(타이머 상태) + H(버퍼 상태)

### 상태 전이의 마르코프 속성
TCP FSM은 마르코프 과정(Markov process)의 속성을 가집니다:

1. **무기억성**: 
   - 다음 상태는 현재 상태와 입력에만 의존
   - 과거 상태 이력에 독립
   
2. **전이 확률 행렬**:
   상태 i에서 상태 j로의 전이 확률 Pᵢⱼ은 네트워크 조건에 따라 변화:
   ```
   P = [pᵢⱼ] where pᵢⱼ = Pr[다음 상태 = j | 현재 상태 = i]
   ```

3. **흡수 상태**: 
   - CLOSED는 흡수 상태(absorbing state)
   - 일단 도달하면 다른 상태로 전이 불가
   - 이는 모든 연결의 최종 운명을 나타냄

## TIME_WAIT 상태의 심층 이론적 분석

### 2MSL 대기의 확률적 해석
TIME_WAIT의 2MSL 대기 시간은 지연 패킷의 생존 시간에 대한 확률적 모델에 기반합니다:

#### 패킷 생존 시간 분포
네트워크에서 패킷 생존 시간 T는 일반적으로 다음과 같은 분포를 따릅니다:
1. **지수 분포 가정**: Pr[T > t] = e^{-λt}
2. **MSL 정의**: Pr[T > MSL] < ε (매우 작은 값)
3. **2MSL 선택 이유**: Pr[T > 2MSL] < ε² (극히 작은 값)

#### 새 연결에서의 오래된 패킷 간섭 확률
동일한 소켓 쌍의 새 연결에서 오래된 패킷이 간섭할 확률:
```
P_간섭 = P_패킷_생존 × P_시퀀스_일치 × P_시간_중첩
       ≤ ε² × 2^{-32} × (연결_생성_빈도 × 2MSL)
```

이론적으로 이 확률은 시스템 수명 동안 1보다 훨씬 작도록 설계됩니다.

### TIME_WAIT의 대안적 해석: 연결 버전 관리
TIME_WAIT을 연결의 "세대 관리" 시스템으로 재해석할 수 있습니다:

1. **연결 세대 개념**:
   - 각 (소켓 쌍, ISN)을 고유한 연결 세대로 정의
   - TIME_WAIT은 이전 세대의 완전한 소멸을 보장

2. **부분 순서 관계**:
   연결 C₁이 C₂보다 이전이라는 관계(C₁ ≺ C₂)는:
   - C₁.end_time + 2MSL < C₂.start_time 일 때 성립
   - 이 관계는 전이적이고 비대칭적

## 흐름 제어와 연결 상태의 상호작용

### 슬라이딩 윈도우 프로토콜의 상태 공간

#### 윈도우 상태의 기하학적 표현
송신 윈도우는 2³² 원형 공간에서 세 개의 포인터로 정의됩니다:
1. **SND.UNA**: 미확인 최소 시퀀스
2. **SND.NXT**: 다음에 보낼 시퀀스  
3. **SND.UNA + SND.WND**: 윈도우 상한

이들은 항상 다음 관계를 만족합니다:
```
SND.UNA ≤ SND.NXT ≤ SND.UNA + SND.WND (mod 2³²)
```

#### 윈도우 상태의 위상적 특성
윈도우 공간은 다음과 같은 위상적 속성을 가집니다:
1. **연결성**: SND.UNA에서 SND.UNA+SND.WND까지의 구간은 연결됨
2. **동역학**: ACK 수신 시 SND.UNA 이동, 데이터 전송 시 SND.NXT 이동
3. **안정성 조건**: 윈도우 크기가 0이면 데드락 상태

### 혼잡 제어 상태 머신과의 결합
TCP 혼잡 제어는 자체 상태 머신을 가지며 연결 상태와 상호작용합니다:

```
혼잡 제어 FSM:
Slow Start ---(ssthresh 도달)---> Congestion Avoidance
    ↑                               |
    |(타임아웃 또는 3중복 ACK)       |
    +-----------<-------------------+
```

이 혼잡 상태는 연결의 ESTABLISHED 상태와 병행 실행됩니다.

## 분산 합의로서의 연결 관리

### TCP 연결의 비잔틴 내성
TCP 연결 설정은 제한된 비잔틴 합의 문제로 볼 수 있습니다:

#### 가정과 보장
1. **네트워크 모델**: 
   - 메시지 손실 가능
   - 메시지 지연 가능
   - 메시지 재전송 가능
   - 단, 메시지 변조는 감지 가능(체크섬)

2. **합의 목표**:
   - 양측이 연결을 열었다고 믿거나
   - 양측이 연결을 열지 않았다고 믿음
   - 절반만 열었다고 믿는 상태 불허

#### 핸드셰이크의 불변식
3방향 핸드셰이크는 다음 불변식을 유지합니다:

1. **초기화 불변식**:
   ```
   서버가 SYN_RCVD 상태일 때:
   ∃! 클라이언트가 SYN_SENT 또는 ESTABLISHED 상태
   ```

2. **확립 불변식**:
   ```
   한 호스트가 ESTABLISHED 상태이면:
   상대방도 ESTABLISHED 상태이거나
   곧 ESTABLISHED 상태가 될 것임
   ```

### 연결 종료의 분산 종료 문제
연결 종료는 분산 시스템의 "종료 감지" 문제와 동형입니다:

#### 분산 종료 조건
연결이 종료되었다고 말할 수 있는 조건:
1. **로컬 종료 조건**: 응용 프로그램이 close() 호출
2. **원격 종료 조건**: FIN 수신
3. **전역 종료 조건**: 양측이 FIN을 송신하고 최종 ACK를 수신

## 통계적 모델과 성능 분석

### 연결 수명 분포
TCP 연결 수명 L은 일반적으로 다음과 같은 분포를 따릅니다:

#### 실측 기반 모델
1. **웹 서버 연결**: 
   - 대부분 매우 짧음(수 ms ~ 수 초)
   - Heavy-tailed 분포: 소수의 긴 연결이 대부분의 데이터 전송

2. **데이터베이스 연결**:
   - 장수명 연결 우세
   - 지수 분포와 유사

#### 상태별 체류 시간 모델링
각 상태에서의 체류 시간은 서로 다른 분포를 가집니다:

1. **SYN_RCVD**: 
   - 타임아웃 기반
   - 기하 분포와 유사(재전송)

2. **ESTABLISHED**:
   - 응용 프로그램 의존적
   - 로그정규 분포나 파레토 분포 가능성

3. **TIME_WAIT**:
   - 결정적 2MSL
   - 변형: SO_LINGER 옵션으로 변경 가능

### 큐잉 이론을 통한 연결 관리 분석
TCP 서버는 본질적으로 M/G/1 또는 G/G/k 큐잉 시스템으로 모델링 가능:

#### 연결 수용 용량 분석
```
LISTEN 상태의 서버 큐잉 모델:
- 도착 프로세스: 포아송 과정(가정)
- 서비스 시간: 연결 처리 시간
- 서버 수: 단일 소켓(여러 스레드/프로세스는 병렬 서버로 모델링)
```

#### SYN 큐와 Accept 큐의 이중 큐 구조
```
두 단계 큐잉 시스템:
1. SYN 큐: SYN_RCVD 상태 연결 (미완료 연결)
2. Accept 큐: ESTABLISHED 상태 연결 (완료 연결)

성능 병목은 일반적으로:
- SYN Flooding 시: SYN 큐 포화
- 느린 응용 프로그램 시: Accept 큐 포화
```

## 프로토콜 검증의 형식적 방법

### TCP 상태 머신의 모델 검증
TCP FSM은 다음과 같은 형식적 방법으로 검증되었습니다:

#### 모델 체킹을 통한 속성 검증
중요한 검증된 속성들:

1. **살아있음(Liveness)**:
   - 모든 연결은 결국 CLOSED 상태에 도달
   - 기아 상태(starvation) 없음

2. **안전성(Safety)**:
   - 한 번에 한 상태만 존재
   - 상태 불변식 유지
   - 데드락 없음

3. **진행성(Progress)**:
   - 유효한 입력이 있으면 상태 전이 발생
   - 무한 루프 없음

#### 도달 가능성 분석
상태 공간의 도달 가능성 그래프 분석 결과:
- CLOSED에서 모든 상태로 도달 가능
- 모든 상태에서 CLOSED로 도달 가능
- 특정 병렬 경로는 동시 실행 불가(상호배타적)

### 시간 자동체(Timed Automata) 모델
TCP는 시간 제약이 있는 자동체로 모델링될 수 있습니다:

#### 시간 제약의 형식화
각 상태에는 암묵적 또는 명시적 시간 제약이 존재:

1. **명시적 타임아웃**:
   - SYN_RCVD: 30-120초
   - TIME_WAIT: 2MSL (일반적으로 60초)

2. **암묵적 시간 제약**:
   - ESTABLISHED: keepalive 타임아웃
   - 모든 상태: 재전송 타임아웃(RTO)

이 시간 자동체 모델은 UPPAAL 같은 도구로 검증 가능합니다.

## 정보 이론적 관점의 연결 보안

### 시퀀스 번호의 정보량 분석
TCP 시퀀스 번호는 32비트이므로 이론적 정보량은:
```
I(ISN) = 32 bits (최대)
```

그러나 실제 정보량은 생성 알고리즘에 따라 다릅니다:

1. **예측 가능한 ISN**: I(ISN) ≈ 0 bits (보안 취약)
2. **암호학적 ISN**: I(ISN) ≈ 32 bits (이상적)
3. **실제 구현**: I(ISN) ≈ 28-30 bits (구현 제약으로 인한 손실)

### 연결 하이재킹의 정보 이론적 모델
성공적인 연결 하이재킹을 위해 공격자가 알아야 할 정보:
```
I(하이재킹) = I(시퀀스 번호) + I(윈도우 크기) + I(옵션 상태) + I(타임스탬프)
           ≈ 32 + 16 + 가변 + 32 bits
           ≥ 80 bits (현실적 최소)
```

이 이론적 하한은 실제 공격의 어려움을 설명합니다.

## 결론: TCP 연결 관리의 이론적 체계

TCP 연결 관리 시스템은 단순한 실용적 구현을 넘어 심오한 이론적 기반을 가집니다. 이는:

1. **분산 합의 알고리즘**으로서: Two Generals' Problem에 대한 실용적 해법
2. **유한 상태 머신**으로서: 엄격한 수학적 모델링 가능
3. **확률적 시스템**으로서: 통계적 성능 분석 가능
4. **보안 프로토콜**으로서: 정보 이론적 안전성 제공
5. **시간적 시스템**으로서: 실시간 속성과 제약 관리

이러한 다층적 이론적 기반이 TCP가 40년 이상 생존하며 진화할 수 있었던 근본 이유입니다. 각 이론적 통찰은 단순한 구현 디테일이 아니라, 신뢰성, 성능, 보안의 상충 관계를 균형있게 해결하기 위한 필수적 선택입니다.

TCP의 연결 관리 메커니즘을 깊이 이해한다는 것은 단순한 네트워크 프로그래밍 지식을 넘어, 분산 시스템 설계의 근본 원리를 이해하는 것입니다. 이는 현대의 새로운 프로토콜(QUIC, HTTP/3 등)을 평가하고 설계하는 데 필수적인 기초 지식을 제공합니다.