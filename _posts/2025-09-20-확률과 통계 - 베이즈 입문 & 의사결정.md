---
layout: post
title: 확률과 통계 - 베이즈 입문 & 의사결정
date: 2025-09-20 16:25:23 +0900
category: 확률과 통계
---
# 12) 베이즈 입문 & 의사결정

> **목표**  
> - **사전(prior)**·**우도(likelihood)**·**사후(posterior)**의 역할을 이해하고, **공액사전**(특히 **베타–이항**)을 자유자재로 다룬다.  
> - **신빙구간(credible interval)**과 **사후예측(posterior predictive)**으로 직관적인 불확실성 보고를 만든다.  
> - **소규모 트래픽 A/B**에서 **누적 업데이트**·**의사결정(손실/효용 기반)**·**정지 규칙**을 설계한다.  
> - **함정**: **사전 민감도**, **수렴 기준**, **보고서 설명법**(p값과의 차이)을 숙지한다.

---

## 0) Hook — “작은 트래픽에서도, 직관적인 확률로 말하기”
A/B에서 전환율이 **3% vs 3.4%**처럼 **근소**하고 표본이 작으면, 빈도주의 z-검정은 **느리게** 유의해진다. 베이즈는 이렇게 묻는다:

- “**B가 A보다 좋을 확률**은 몇 %인가?”  
- “롤아웃하면 **기대 손익**이 얼마인가?”  
- “**지금 멈춰도 될 만큼** 불확실성이 줄었는가?”

이 질문에 답하려면 **사전+데이터=사후**의 기계와, 그 위에서 **의사결정(기대효용 최대화)**을 돌리는 습관이 필요하다.

---

## 1) 베이즈 삼각형: 사전·우도·사후

### 1.1 기본 공식
데이터 $$D$$, 모수 $$\theta$$에 대해
$$
p(\theta\mid D)=\frac{p(D\mid \theta)\,p(\theta)}{p(D)}\ \ \ \text{(정규화 상수 }p(D)=\int p(D\mid\theta)p(\theta)\,d\theta).
$$
- **사전** $$p(\theta)$$: 데이터 보기 **전** 믿음(지식·역사).  
- **우도** $$p(D\mid\theta)$$: 모수가 주어졌을 때 데이터가 나올 **가능성**.  
- **사후** $$p(\theta\mid D)$$: 데이터 관측 **후** 업데이트된 믿음.

### 1.2 A/B 전환율의 모형
- 각 노출/사용자에서 **전환**은 베르누이: $$X_i\sim \mathrm{Bernoulli}(p)$$.  
- n회 노출, 성공(전환) x이면: $$X\sim \mathrm{Binomial}(n,p),\ \ p\in(0,1).$$  
- 공액사전: $$p\sim \mathrm{Beta}(\alpha,\beta).$$

---

## 2) 공액사전: 베타–이항(핵심)

### 2.1 업데이트 규칙
사전 $$p\sim \mathrm{Beta}(\alpha,\beta)$$, 데이터 $$x\mid p\sim \mathrm{Binomial}(n,p)$$이면
$$
p(p\mid x,n)=\mathrm{Beta}\big(\alpha+x,\ \beta+n-x\big).
$$
- **의미**: $$\alpha,\beta$$는 **사전 성공/실패의 유효 카운트**.  
  - 예) $$\mathrm{Beta}(1,1)$$(균일) = **중립 사전**(유효 n=2).  
  - $$\mathrm{Beta}(0.5,0.5)$$(Jeffreys) = 비정보적·꼬리 가중.  
  - **역사 기반**: 과거 전환 $$x_0$$, 노출 $$n_0$$이면 $$\alpha=x_0+c,\ \beta=(n_0-x_0)+c$$처럼 **완충** $$c$$로 신뢰 조절.

### 2.2 요약량
사후 $$\mathrm{Beta}(\alpha^\star,\beta^\star)$$에서
$$
E[p\mid D]=\frac{\alpha^\star}{\alpha^\star+\beta^\star},\quad
\mathrm{Var}[p\mid D]=\frac{\alpha^\star\beta^\star}{(\alpha^\star+\beta^\star)^2(\alpha^\star+\beta^\star+1)}.
$$
- **중요**: 평균은 **사전 평균과 표본비율의 가중 평균**.  
  $$\frac{\alpha^\star}{\alpha^\star+\beta^\star}=\lambda\cdot \frac{\alpha}{\alpha+\beta}+(1-\lambda)\cdot \frac{x}{n},\ \ \lambda=\frac{\alpha+\beta}{\alpha+\beta+n}.$$

### 2.3 신빙구간(credible interval)
- **등꼬리(Eq-tailed)**: 사후분포의 하/상 $$\alpha/2,\ 1-\alpha/2$$ 분위.  
- **HDI/HPD**: 밀도 최대 영역(단봉 베타에선 거의 동일).  
- 보고 예: “$$p_B$$의 95% 신빙구간은 **[0.028, 0.037]**.”

---

## 3) 소규모 트래픽 A/B: 누적 업데이트 & 비교

### 3.1 설정
- 변형 A: $$x_A$$/$$n_A$$, 사전 $$\mathrm{Beta}(\alpha_A,\beta_A)$$ ⇒ 사후 $$\mathrm{Beta}(\alpha_A+x_A,\beta_A+n_A-x_A)$$.  
- 변형 B: $$x_B$$/$$n_B$$, 사전 $$\mathrm{Beta}(\alpha_B,\beta_B)$$ ⇒ 사후 $$\mathrm{Beta}(\alpha_B+x_B,\beta_B+n_B-x_B)$$.

### 3.2 “B가 A보다 좋을 확률” \(P(p_B>p_A\mid D)\)
폐형식이 있으나 실무에선 **샘플링(Thompson)**이 빠르고 명확:
1) $$p_A^{(b)}\sim \mathrm{Beta}(\alpha_A^\star,\beta_A^\star)$$, $$p_B^{(b)}\sim \mathrm{Beta}(\alpha_B^\star,\beta_B^\star)$$  
2) $$\hat q=\frac{1}{B}\sum_b \mathbf{1}\{p_B^{(b)} > p_A^{(b)}\}$$  
→ “**B가 더 나을 확률**”로 리포트.

### 3.3 차이의 분포와 신빙구간
- 샘플별 차이 $$\Delta^{(b)}=p_B^{(b)}-p_A^{(b)}$$로 **신빙구간**·**기대 uplift**를 바로 계산.  
- 보고 예: “$$P(p_B>p_A\mid D)=0.82$$, **E[Δ|D]=+0.28pp**, 95% 신빙구간 **[−0.12pp, +0.70pp]**.”

### 3.4 누적 업데이트(온라인)
- 하루 단위 새 데이터 $$\Delta x, \Delta n$$를 관측할 때마다  
  $$
  \alpha^\star \leftarrow \alpha^\star + \Delta x,\ \ \beta^\star \leftarrow \beta^\star + (\Delta n-\Delta x).
  $$
- **연속 모니터링**이 가능하고 **정지 규칙**을 사전 정의하면 **p-hacking** 문제를 피한다(§7).

---

## 4) 사후예측(posterior predictive) — “다음 n명에게서 몇 명 전환?”
사후 $$p\mid D\sim\mathrm{Beta}(\alpha^\star,\beta^\star)$$일 때, **미래** 전환수 $$\tilde X\mid D$$는
$$
\tilde X\ \sim\ \mathrm{Beta\text{-}Binomial}\left(N,\ \alpha^\star,\ \beta^\star\right),\quad
\Pr(\tilde X=k)=\binom{N}{k}\frac{B(\alpha^\star+k,\ \beta^\star+N-k)}{B(\alpha^\star,\beta^\star)}.
$$
- **예측 평균**: $$E[\tilde X/N\mid D]=\frac{\alpha^\star}{\alpha^\star+\beta^\star}.$$  
- 보고 예: “향후 50만 노출에서 **기대 전환율 3.2%**, 95% 예측구간 [3.0%, 3.4%].”

---

## 5) 의사결정: 손실/효용과 규칙
베이즈의 의사결정은 **기대손실 최소화**(=기대효용 최대화).

### 5.1 손실 함수 예시(전환·수익)
- **Uplift 기반**: 변형 선택의 **기대 추가 전환(또는 수익)**:
$$
\text{EGain}(B)=M\cdot V\cdot E[(p_B-p_A)_+ \mid D]\ -\ C_{\text{deploy}},
$$
- 여기서 **M**=향후 노출 수, **V**=전환당 가치(원), **C**=배포 비용.  
- **비대칭 비용**: 나쁜 변형 롤아웃 비용 **C\_bad**를 포함해
$$
\text{EUL}(B) = M V \cdot E[p_B-p_A\mid D]\ -\ C_{\text{deploy}}\ -\ C_{\text{bad}}\cdot P(p_B<p_A\mid D).
$$
→ **EUL(B)>0**면 B 롤아웃.

### 5.2 단순 확률 규칙(의사결정 경계)
- 임계치 $$\tau$$를 정해 **\(P(p_B>p_A\mid D)\ge \tau\)** 이고  
- **기대 손실**이 $$\le \epsilon$$이면 **멈추고 B 채택**.  
  - 예: **\(\tau=0.95,\ \epsilon=0.1\text{pp}\)**.

### 5.3 멈춤 vs 더 관측(정보가치)
- **EVPI/EVSI**(정보가치) 개념: 더 모으면 기대효용 ↑인지 평가.  
- 실무 간단 규칙: **신빙구간 반폭**이 목표 이하이면 멈춤; 아니면 **추가 표본 n**을 계산(§6.3).

---

## 6) 실전 레시피 — 소규모 트래픽 A/B

### 6.1 사전 선택
- **중립**: $$\mathrm{Beta}(1,1)$$ 또는 **Jeffreys** $$\mathrm{Beta}(0.5,0.5)$$.  
- **역사 정보**: 과거 유사 실험의 **히스토리**에서 **층화 평균**을 모아 **약한 정보**로 사용(과적합 방지).  
- **동질 가정 완화**: 변형 간 사전 동일이 원칙이나, **알고리즘 개선** 등 **강한 도메인** 근거가 있으면 약간의 **사전 차등** 허용(보고서에 명시).

### 6.2 매일 업데이트 & 리포트 항목
- 각 변형 사후 **평균/신빙구간**  
- **\(P(p_B>p_A\mid D)\)**, **E[Δ|D]**, **Δ의 신빙구간**  
- **사후예측**(향후 N에서 기대 전환 수)  
- **손실기반 판단**(EUL)과 **정지판단**(τ, ε 만족 여부)

### 6.3 목표 정밀도(반폭 δ)까지 필요한 n 근사
베타–이항 사후에서 **등꼬리 신빙구간 반폭 δ**를 얻기 위한 n 근사는 **정규 근사**로 대략
$$
\delta \approx z_{1-\alpha/2}\sqrt{\frac{p(1-p)}{n+\alpha+\beta}},\quad \Rightarrow\ n \approx \frac{z^2 p(1-p)}{\delta^2} - (\alpha+\beta).
$$
- **보수적**: $$p=0.5$$ 사용.  
- B와 A의 **차이**에 대한 정밀도는 **합성 분산**으로 더 큼 → 실무는 시뮬레이션(샘플링)으로 n↑를 가늠.

---

## 7) 수렴 기준 & 연속 모니터링

### 7.1 권장 멈춤 규칙(예)
- **확률 기준**: $$P(p_B>p_A\mid D)\ge 0.95$$  
- **정밀도 기준**: $$\mathrm{HalfWidth}(95\%\,CI(\Delta))\le 0.2\text{pp}$$  
- **손실 기준**: $$E[\text{Loss}(\text{선택})\mid D]\le \text{임계}$$  
- **최대 기간/최소 노출**: 탐색적 중간 흔들림 방지

### 7.2 주의(“베이즈=아무 때나 멈춰도 OK?”)
- 베이즈는 **사전 정의된 규칙**으로 연속 모니터링이 **일관**되지만,  
  - **규칙을 데이터에 맞게 바꾸면**(중간에 τ/ε 변경) **선택 편향**.  
  - **보고서**에 **규칙/파라미터**를 **사전등록**하고 그대로 지킬 것.

---

## 8) 보고서 설명법(비기술 이해관계자용)

### 8.1 신빙구간 vs 신뢰구간
- **신빙구간(베이즈)**: “전환율이 **[a, b]일 확률이 95%**” (모수 확률 진술).  
- **신뢰구간(빈도주의)**: “절차를 무한 반복하면 **95% 구간이 진짜 모수를 포함**.”  
- 실무 커뮤니케이션: 신빙구간이 **더 직관적**. 단, **사전**의 영향이 있음을 병기.

### 8.2 대표 문장 템플릿
- “지금까지 데이터 기준, **B가 A보다 나을 확률 88%**, 기대 uplift **+0.23pp**. **95% 신빙구간**은 **[−0.05pp, +0.53pp]**.  
  **전환당 2,000원 가치**와 **배포비용**을 고려하면 **기대순이익 +240만 원**으로 **롤아웃 권고** (정지 기준 충족).”

---

## 9) 사전 민감도 & 진단

### 9.1 민감도 분석
- 최소 2–3개의 사전(예: Beta(1,1), Beta(0.5,0.5), 역사 Beta(α₀,β₀))로  
  - **\(P(p_B>p_A)\)**, **E[Δ]**, **의사결정(EUL sign)** 의 **견고성** 확인.  
- **토네이도 플롯**: 사전 선택에 따른 출력 변화 시각화.

### 9.2 사전 캘리브레이션
- **등가 표본크기(ESS)** $$=\alpha+\beta$$로 사전 강도를 명시.  
- **하프라이프**: 데이터가 ESS를 **두 배** 넘으면 사전 영향 급감(직관 제공).

---

## 10) 다중 비교·세그먼트 — 계층베이즈(스케치)
이벤트/세그먼트가 **여럿**일 때는  
$$
p_g \sim \mathrm{Beta}(\alpha,\beta),\quad X_g\mid p_g \sim \mathrm{Binomial}(n_g,p_g)
$$
- **풀링(shrinkage)**로 희소 세그먼트의 추정이 안정, **선택 편향** 완화.  
- 리포트는 **사후 평균/신빙구간**과 **랭크**(상위 q%)로.

---

## 11) 코드 스니펫(개념): 베타–이항 업데이트·비교·의사결정
```python
# 개념/데모용: 베타-이항 A/B 업데이트, P(pB>pA), 신빙구간, 손실기반 의사결정
import math, random
from typing import Tuple, Dict, List

def beta_update(alpha: float, beta: float, x: int, n: int) -> Tuple[float,float]:
    return alpha + x, beta + (n - x)

def beta_equal_tailed_ci(alpha: float, beta: float, level: float=0.95) -> Tuple[float,float]:
    # SciPy 없이 근사: 임시로 정규근사 사용(실무: scipy.stats.beta.ppf)
    from math import sqrt
    a, b = alpha, beta
    m = a/(a+b)
    v = (a*b)/(((a+b)**2)*(a+b+1))
    z = 1.96 if abs(level-0.95)<1e-9 else 1.96 # placeholder
    lo = max(0.0, m - z*math.sqrt(v))
    hi = min(1.0, m + z*math.sqrt(v))
    return lo, hi

def prob_B_superior(alphaA, betaA, alphaB, betaB, B:int=200000) -> float:
    cnt = 0
    for _ in range(B):
        # 베타 샘플링: 간이 방법(실무는 numpy.random.beta)
        # 여기선 Cheng-Feast 근사 대신 random.betavariate 사용 (파이썬 표준)
        a = random.betavariate(alphaA, betaA)
        b = random.betavariate(alphaB, betaB)
        if b > a: cnt += 1
    return cnt / B

def delta_samples(alphaA,betaA,alphaB,betaB,B:int=200000) -> List[float]:
    return [random.betavariate(alphaB,betaB)-random.betavariate(alphaA,betaA) for _ in range(B)]

def decision_eul(alphaA,betaA,alphaB,betaB, M:int, V:float, C_deploy:float=0.0, C_bad:float=0.0, B:int=100000) -> Dict:
    gains, bad = [], 0
    for _ in range(B):
        pA = random.betavariate(alphaA,betaA)
        pB = random.betavariate(alphaB,betaB)
        gains.append(M*V*(pB - pA))
        if pB < pA: bad += 1
    E_gain = sum(gains)/B - C_deploy - C_bad*(bad/B)
    prob_sup = sum(g>0 for g in gains)/B
    return {"EUL":E_gain, "P_gain>0":prob_sup}

# 예시: A: xA=3000,nA=100000; B: xB=3300,nB=100000; prior Beta(1,1)
alphaA, betaA = beta_update(1,1,3000,100000)
alphaB, betaB = beta_update(1,1,3300,100000)
print("A post mean ~", alphaA/(alphaA+betaA))
print("B post mean ~", alphaB/(alphaB+betaB))
print("P(B>A) ~", prob_B_superior(alphaA,betaA,alphaB,betaB, B=50000))

# 의사결정: 향후 노출 M=1,000,000, 전환가치 V=2000원, 배포비용 100만원, 나쁜 롤아웃비 300만원
print(decision_eul(alphaA,betaA,alphaB,betaB, M=1_000_000, V=2000, C_deploy=1_000_000, C_bad=3_000_000, B=50000))
```

> **실무**: `scipy.stats.beta` 또는 `numpy.random.beta` 사용, **HDI/BCa**는 라이브러리 이용. 손실/효용은 **사업 파라미터(M, V, 비용)** 를 연결.

---

## 12) 함정과 체크리스트

1) **사전 민감도 무시**  
   - 최소 2–3개의 사전으로 **민감도** 확인(ESS, 평균).  
   - 보고서에 “사전 **정의**·**근거**·**강도(ESS)**”를 명시.

2) **정지 기준 후조정(데이터 보고 바꾸기)**  
   - 베이즈라도 **규칙 바꾸면** 선택편향. **사전등록** 필수.

3) **신빙구간 오해**  
   - “모수가 구간에 있을 확률 95%”라고 **명시**(빈도주의와 대비 설명).

4) **사후 차이 대신 개별 구간만 비교**  
   - “구간이 겹치면 차이 유의 아님”은 **오해**. **Δ=p_B-p_A**의 **신빙구간**을 직접 보고.

5) **랜덤화 단위 불일치**  
   - 사용자 무작위화 실험에서 **세션** 단위로 업데이트/평가 금지(§11편 참고). 사후예측도 **사용자 기준**.

6) **다중 실험에서 최상위만 보고**  
   - 선택편향(“치트리프팅”). **계층베이즈** 또는 **선택 후 검증** 절차.

7) **소수점 해석**  
   - **pp**(percentage point) vs **%**(상대) 구분: 보고서에 둘 다 병기.

---

## 13) 요약 템플릿(보고용)

- **사전**: Beta(1,1) (ESS=2).  
- **데이터**: A 3,000/100k, B 3,300/100k.  
- **사후**:  
  - A $$\mathrm{Beta}(3001,97001)$$ ⇒ 평균 3.000% [95% CI 2.90–3.10]  
  - B $$\mathrm{Beta}(3301,96701)$$ ⇒ 평균 3.300% [95% CI 3.20–3.40]  
- **비교**: $$P(p_B>p_A)=0.9999$$, $$E[\Delta]=+0.30\text{pp}$$, 95% CI [+0.15, +0.45] pp.  
- **결정**(M=100만, V=2천원, 비용=100만원, 나쁜 롤아웃=300만원): **기대순이익 +3,300만원**, 정지 기준 충족 → **B 롤아웃 권고**.  
- **민감도**: Jeffreys 사전(Beta(0.5,0.5))에서도 결론 동일.

---

## 14) Q&A(현업에서 자주 받는 질문)

- **Q. 사전은 주관적이라 위험 아닌가?**  
  **A.** 사전은 **명시적 가정**이다. 민감도 분석·ESS 공개로 **투명성**을 확보하고, 역사 기반 **약한 정보**를 사용하라.

- **Q. 베이즈면 언제든 멈춰도 공정?**  
  **A.** **사전 정의된** 멈춤 규칙을 따르면 일관성 유지. **규칙 후조정**은 금물.

- **Q. p값 대신 무엇을?**  
  **A.** **\(P(p_B>p_A)\)**, **Δ의 신빙구간**, **기대손익**을 함께 제시.

- **Q. 작은 트래픽에 강점?**  
  **A.** 사전+데이터의 결합으로 **불안정 추정을 완화**. 단, 사전 영향이 크므로 **민감도** 필수.

---

## 15) TL;DR
- **베타–이항**: 빠르고 투명한 **A/B 전환율** 업데이트.  
- **신빙구간**과 **\(P(p_B>p_A)\)** 로 이해관계자와 **확률 언어**로 소통.  
- **손실/효용**을 명시해 **기대순이익** 기준으로 배포 결정을 내린다.  
- **사전 민감도**·**정지 규칙**·**랜덤화 단위**를 지키면, **작은 표본**에서도 **신뢰 가능한** 의사결정이 가능하다.
