---
layout: post
title: 컴퓨터시스템 - 메모리 관리를 위한 도구로서의 VM
date: 2025-08-16 22:20:23 +0900
category: 컴퓨터시스템
---
# 메모리 관리를 위한 도구로서의 VM (Virtual Memory)

가상 메모리(VM)는 단순히 "큰 메모리를 흉내 내는 기술"이 아니라, **운영체제가 메모리를 효율적으로 관리**하고 **프로세스 간의 격리와 보호를 제공**하며, **메모리 자원을 효율적으로 분배**하는 강력한 도구입니다.  
이 관점에서 VM은 **메모리 관리(Memory Management)**의 핵심 역할을 수행합니다.

---

## 1. 메모리 관리에서 VM의 주요 목표

1. **추상화 제공**
   - 프로세스는 자신만의 **연속적인 주소 공간**을 가지는 것처럼 보임.
   - 실제 물리 메모리 위치를 숨기고, 프로그램이 하드웨어 구조를 몰라도 동작 가능하게 함.

2. **보호**
   - 한 프로세스의 메모리 접근이 다른 프로세스 또는 커널 메모리를 침범하지 않도록 보호.
   - CPU의 MMU(Memory Management Unit)와 페이지 테이블을 활용.

3. **효율적 자원 분배**
   - 메모리가 부족할 때는 **스와핑(Swapping)**이나 **페이지 교체**로 자원 재활용.
   - 자주 쓰이는 페이지를 DRAM에 두고, 덜 쓰이는 페이지는 디스크로 이동.

---

## 2. 메모리 공간 분리와 보호

- VM은 각 프로세스에 **독립적인 가상 주소 공간**을 제공.
- 프로세스 간의 메모리 침범을 방지.
- 페이지 테이블에 의해 **읽기/쓰기/실행 권한**이 관리됨.
- 예:
  - 사용자 영역(User Space): 일반 애플리케이션 코드/데이터.
  - 커널 영역(Kernel Space): OS 코드, 장치 드라이버, 시스템 버퍼.

---

## 3. 동적 메모리 할당 지원

VM은 동적 메모리 관리(Heap, Stack 확장)에 필수적입니다.
- **Heap**: `malloc()`, `free()`와 같은 함수로 요청한 메모리를 페이지 단위로 매핑.
- **Stack**: 함수 호출 시 스택 프레임을 위한 페이지 할당.
- 필요 시 `mmap()` 시스템 콜을 통해 파일 매핑, 공유 메모리 매핑 등을 수행.

---

## 4. 가상 메모리와 스와핑(Swapping)

- 물리 메모리가 부족하면 OS는 덜 사용되는 페이지를 디스크(스왑 공간)로 이동.
- 스와핑의 장점:
  - 많은 프로세스가 동시에 실행 가능.
  - 큰 프로그램도 실행 가능.
- 단점:
  - 디스크 접근은 느려서 과도한 스와핑은 **스래싱(Thrashing)**을 유발.

---

## 5. 메모리 매핑(Memory Mapping)과 파일 I/O

VM은 메모리 관리뿐 아니라, 효율적인 파일 접근도 지원:
- **파일 매핑(File Mapping)**: 파일 내용을 가상 메모리에 매핑.
- 장점:
  - 파일 읽기/쓰기 시 명시적인 I/O 호출 없이 메모리 접근처럼 사용.
  - 운영체제의 페이지 캐시와 결합되어 I/O 성능 향상.

예시 (C 코드):
```c
#include <sys/mman.h>
#include <fcntl.h>
#include <unistd.h>
#include <string.h>

int main() {
    int fd = open("data.txt", O_RDWR);
    char *map = mmap(NULL, 4096, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);

    strcpy(map, "Hello VM!");
    msync(map, 4096, MS_SYNC);

    munmap(map, 4096);
    close(fd);
    return 0;
}
```
위 코드는 `data.txt` 파일을 메모리에 매핑해 수정하는 예시입니다.

---

## 6. 공유 메모리(Shared Memory) 구현

VM은 프로세스 간 통신(IPC)에서도 중요한 역할:
- 두 프로세스가 동일한 물리 페이지를 가상 주소에 매핑 → 고속 데이터 교환 가능.
- POSIX `shm_open` 또는 System V `shmget` 사용.
- 커널은 권한과 접근 제어를 통해 보안 유지.

---

## 7. 메모리 할당 정책과 최적화

운영체제는 VM을 통해 다양한 할당 전략을 구현:
- **Demand Paging**: 실제 접근할 때 페이지를 로드.
- **Prefetching**: 앞으로 필요할 페이지를 미리 로드(지역성 기반).
- **Copy-On-Write (COW)**: 프로세스 fork 시 메모리를 복사하지 않고 공유하다가, 수정 시 복사.

---

## 8. VM과 메모리 단편화 문제 해결

- **내부 단편화**: 페이지 크기(4KB 등)로 인해 실제 필요한 공간보다 더 많이 할당.
- **외부 단편화**: 연속된 물리 메모리가 부족해 발생.
- VM은 **페이지 단위 할당**으로 외부 단편화를 해결하고, 내부 단편화를 최소화하려 페이지 크기를 적절히 선택.

---

## 9. 요약

- VM은 단순한 주소 변환 기능이 아니라 **보호, 격리, 자원 효율성, 성능 최적화**를 제공하는 메모리 관리 핵심 도구.
- 스와핑, 페이지 교체, 파일 매핑, 공유 메모리, COW 등 다양한 기술과 결합.
- 현대 OS의 메모리 관리 설계에서 VM은 필수적인 기반 기술.