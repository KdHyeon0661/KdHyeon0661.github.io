---
layout: post
title: 확률과 통계 - ANOVA & 실험설계
date: 2025-09-20 14:25:23 +0900
category: 확률과 통계
---
# 10) ANOVA & 실험설계 맛보기

> **목표**  
> - **일원/이원 ANOVA**로 여러 그룹 평균 차이/상호작용을 해석한다.  
> - **사후검정**(Tukey·Dunnett·Games–Howell 등)과 **효과크기**(η², ω², 부분 η²)를 함께 보고한다.  
> - **2^k 요인설계**로 적은 표본으로 **주효과/상호작용**을 동시에 탐색하는 직관을 잡는다.  
> - **함정**: 이질분산·불균형 설계, 비율/카운트 지표에서의 **ANOVA 남용**을 피하고 **GLM/로지스틱·포아송**으로 전환하는 기준을 익힌다.

---

## 0) Hook — “평균 차이? 상호작용!”  
- **진입 배너 3수준**(기본/이미지/동영상)과 **요일 7수준**이 전환에 주는 **독립적 영향(주효과)** 과 **조합에 따른 변화(상호작용)** 를 알고 싶다.  
- **ANOVA**는 “평균의 차이”를 **분산 비율(F)** 로 검정한다:  
  $$F=\frac{\text{집단 간 평균차가 만드는 변동}}{\text{집단 내(오차) 변동}}$$  
- 실무 핵심은 **효과의 유의성(p)** 뿐 아니라 **크기(효과크기)**, **어디서 차이나는지(사후검정)**, **설계의 타당성(가정/불균형)** 이다.

---

## 1) 일원 ANOVA (One-way) — 배너 3수준 평균 전환율 비교

### 1.1 모형과 가정
- **모형**: $$Y_{ij}=\mu+\alpha_i+\varepsilon_{ij},\quad i=1,\dots,a,\ j=1,\dots,n_i$$  
  - $$Y_{ij}$$: j번째 사용자(또는 세션)의 지표(예: 세션당 구매액, 혹은 변환지표에 대한 연속화 지표).  
  - $$\alpha_i$$: i번째 배너 수준의 효과, 제약 $$\sum_i \alpha_i=0$$.  
- **가정**:  
  1) 각 그룹 내 **독립**  
  2) **정규성**(오차)  
  3) **등분산성**: $$\mathrm{Var}(\varepsilon_{ij})=\sigma^2$$ (그룹 간 동일)

> **비율(전환/비전환)** 같은 **이항** 데이터는 원칙적으로 **일반화 선형모형(GLM)** 을 권장(§8). 일원 ANOVA는 **연속형**(예: **세션당 매출**, **로그 스케일**)에 우선 적용. 비율에 ANOVA를 적용하려면 **집단별 평균의 정규성/등분산**이 성립하거나 **아크사인-루트 변환** 등 대체가 필요하지만, GLM이 보통 더 낫다.

### 1.2 검정량
- 제곱합 분해:  
  $$\text{SST}=\sum_{i}\sum_{j}(Y_{ij}-\bar Y_{\cdot\cdot})^2=\underbrace{\sum_{i}n_i(\bar Y_{i\cdot}-\bar Y_{\cdot\cdot})^2}_{\text{SSB}}+\underbrace{\sum_{i}\sum_{j}(Y_{ij}-\bar Y_{i\cdot})^2}_{\text{SSE}}$$
- 자유도: SSB: \(a-1\), SSE: \(N-a\)  
- 평균제곱: \( \text{MSB}=\text{SSB}/(a-1),\ \text{MSE}=\text{SSE}/(N-a)\)  
- **F 통계량**: $$F=\frac{\text{MSB}}{\text{MSE}} \sim F_{a-1,\ N-a} \quad (H_0:\ \alpha_1=\cdots=\alpha_a=0)$$

### 1.3 효과크기(일원)
- **η²**: \( \eta^2=\text{SSB}/\text{SST} \) (설명된 비율, 약간의 과대평가)  
- **ω²**: \( \omega^2=\frac{\text{SSB}-(a-1)\text{MSE}}{\text{SST}+\text{MSE}} \) (편향 보정, 권장)

### 1.4 사후검정(어디가 다른가)
- **Tukey HSD**: 모든 쌍 비교에 균형 잡힌 FWER 제어, 등분산·표본 대체로 안전  
- **Dunnett**: **대조군 vs 나머지** 중심(배너 “기본” vs “이미지/동영상”)  
- **Games–Howell**: **이질분산·불균등 표본**에 강함(등분산 가정 불필요)

---

## 2) 이원 ANOVA (Two-way) — 배너(3) × 요일(7)

### 2.1 모형
$$
Y_{ijk}=\mu+\alpha_i+\beta_j+(\alpha\beta)_{ij}+\varepsilon_{ijk}
$$
- \(i=1..3\) (배너 수준), \(j=1..7\) (요일), \(k=1..n_{ij}\) (셀 표본)  
- **검정**  
  - **배너 주효과**: 모든 요일 평균으로 본 배너 차이  
  - **요일 주효과**: 모든 배너 평균으로 본 요일 차이  
  - **상호작용**: 배너 효과가 요일에 따라 **변하는가**

### 2.2 F-통계량과 자유도(균형 설계 가정)
- SS 분해: **SSA**(배너), **SSB**(요일), **SSAB**(상호작용), **SSE**(오차)  
- df: \(a-1\), \(b-1\), \((a-1)(b-1)\), \(ab(n-1)\)  
- **F**:  
  \(F_A=\frac{\text{MSA}}{\text{MSE}}\), \(F_B=\frac{\text{MSB}}{\text{MSE}}\), \(F_{AB}=\frac{\text{MSAB}}{\text{MSE}}\)

### 2.3 효과크기(이원)
- **부분 η²**:  
  $$\eta^2_{\text{partial},A}=\frac{\text{SSA}}{\text{SSA}+\text{SSE}} \quad (\text{B, AB도 동일형식})$$
- **ω²**(대안):  
  $$\omega^2_A=\frac{\text{SSA}-(a-1)\text{MSE}}{\text{SST}+\text{MSE}}$$

### 2.4 상호작용 해석 — “배너×요일”
- **상호작용 유의**: “어떤 요일에는 동영상 배너가 특히 좋고, 어떤 요일엔 이득이 없다” → **주효과 단정 금지**  
- **단순효과(simple effects)** 분석: 요일을 고정하고 배너 간 비교(또는 그 반대)  
- **그래프**: **Interaction plot**(요일 x축, 평균 전환율 y축, 배너별 선)로 교차/간격 변화 확인

---

## 3) 불균형 설계(Type I/II/III SS)와 이질분산

### 3.1 불균형 표본(n_ij 다름)
- **직관**: 그룹 표본이 크게 다르면 “평균의 가중치”가 달라져 **주효과 해석**이 **순서 의존** 가능  
- **Type I SS**(순차): 모형에 **들어간 순서**의 영향  
- **Type II SS**: 각 요인의 **다른 요인 주효과**를 통제, **상호작용 제외** 가정  
- **Type III SS**(업계 표준): **다른 모든 항**(상호작용 포함)을 통제하고 해당 요인의 순수 효과를 평가

> **실무 권장**: 이원 ANOVA에서 **Type II**(상호작용이 미미할 때) 또는 **Type III**(상호작용 포함, 불균형)로 보고를 일관화. 사후에는 **EMMeans(LSMeans)** 로 **균형화된 평균**을 비교.

### 3.2 이질분산(그룹별 분산 다름)
- **일원**: **Welch ANOVA** (등분산 불필요), 사후는 **Games–Howell**  
- **이원**: 고전 이원 ANOVA는 등분산 가정; 현실에선  
  - **강건 표준오차(White/HC3)** 를 갖춘 **선형모형(OLS)** 로 대체, **유의성**은 **와일드 부트스트랩**이나 **샌드위치 SE**로  
  - **변환**(로그/루트) 또는 **GLM** (가변 분산 구조) 검토

---

## 4) 예시 A — “진입 배너(3) × 요일(7)” 전환 차이

### 4.1 데이터 구조
- 데이터 단위: **사용자 수준**(권장) 또는 **집계(일×배너) 수준**  
- 주요 열: `converted(0/1)`, `banner`∈{base,img,video}, `weekday`∈{Mon..Sun}, `user_id`(무작위화 단위)

### 4.2 분석 경로 ① (연속화 지표/로그 변환 → 이원 ANOVA)
- 전환을 0/1로 쓰면 이항→**로지스틱**이 원칙.  
- **맛보기**로서, “세션당 전환율(연속화)” 또는 “로그 오즈 추정치” 같은 연속형으로 만들어 **ANOVA 의미**를 익힌다.  
- **절차**  
  1) 종속변수의 **분포 확인**(QQ-plot, 등분산)  
  2) **이원 ANOVA**(Type III)로 **배너·요일·상호작용** 검정  
  3) 유의하면 **단순효과**와 **사후검정**(요일 고정 배너 비교, Tukey/GH)

### 4.3 분석 경로 ② (**정석**) 이항 → **로지스틱 회귀(GLM)** + **분산분석표(Deviance ANOVA)**
- 모형:  
  $$\log\frac{p_{ij}}{1-p_{ij}}=\beta_0+\alpha_i+\beta_j+(\alpha\beta)_{ij}$$  
- **유의성**: **Likelihood ratio test**(Deviance) 또는 **Wald**로 **주효과/상호작용**  
- **해석**: 배너·요일에 따른 **오즈비(OR)**, **상호작용 OR**  
- **사후**: **EMMeans** 로 로짓 스케일의 **대등비교** + FDR 보정

> **권장 보고**: “이원 로지스틱(사용자 단위), 배너·요일·상호작용 모두 검정. 상호작용 유의(χ²=…, p=…). 월·금에 **동영상** 배너 OR=1.18(95% CI …), 수·토에는 효과 미미.”

---

## 5) 사후검정·단순효과 — 무엇을, 언제?

### 5.1 상호작용 **유의**한 경우
- **단순효과**: 각 요일에서 배너 간 비교(**요일을 고정**)  
- **단순대비(simple contrast)**: 특정 가설(동영상 vs (기본+이미지)/2)  
- **보정**: **Tukey**(모든쌍), **Dunnett**(대조군), **Holm**/**BH-FDR**

### 5.2 상호작용 **비유의**한 경우
- **주효과** 중심 사후검정(배너 주효과에 대한 Tukey 등)  
- **요일**은 **블로킹**으로 보고, 주효과는 **전반적 차이**

### 5.3 효과크기
- 주효과/상호작용의 **부분 η²**, 쌍 비교는 **Hedges’ g**(연속) 또는 **오즈비**(이항)

---

## 6) 2^k 요인설계(Full Factorial) — 푸시 타이밍 탐색

### 6.1 기본 개념
- **k개의 2수준 요인**(−1 / +1), **모든 조합(2^k)** 을 실험  
- **장점**: 같은 표본으로 **주효과**와 **상호작용**(2원, 3원 …)까지 추정  
- **예시**(k=3):  
  - A: **타이밍**(아침 −1 vs 저녁 +1)  
  - B: **빈도**(1회 −1 vs 2회 +1)  
  - C: **개인화**(일반 −1 vs 개인화 +1)  
  - 응답: **사용자 단위 전환(0/1)** 또는 **세션당 매출**

### 6.2 설계 행렬(코딩)
| Run | A | B | C | AB | AC | BC | ABC |
|---:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
| 1 | −1 | −1 | −1 | +1 | +1 | +1 | −1 |
| 2 | +1 | −1 | −1 | −1 | −1 | +1 | +1 |
| 3 | −1 | +1 | −1 | −1 | +1 | −1 | +1 |
| 4 | +1 | +1 | −1 | +1 | −1 | −1 | −1 |
| 5 | −1 | −1 | +1 | +1 | −1 | −1 | +1 |
| 6 | +1 | −1 | +1 | −1 | +1 | −1 | −1 |
| 7 | −1 | +1 | +1 | −1 | −1 | +1 | −1 |
| 8 | +1 | +1 | +1 | +1 | +1 | +1 | +1 |

- **효과 추정**(연속형 응답): 각 열과 **응답의 상관(평균 차)** 으로 추정  
- **이항 응답**: **로지스틱 회귀**에 **주효과+상호작용**을 넣고 해석(OR/IRR)

### 6.3 상호작용 해석
- **AB** 유의: **아침×2회** 조합에서만 상승(각각 단독 효과는 약함)  
- **ABC** 유의: 특정 조합(저녁×2회×개인화)에서 극적 상승 → **세그먼트 전략** 제안

### 6.4 표본 크기 & 파워(개념)
- **Cohen’s f** 또는 **표준화 효과**로 per-cell **n** 산정  
- **균형 설계**(각 조합 같은 n)가 **해석·파워** 모두에 유리  
- 상호작용까지 탐지하려면 **주효과보다 더 큰 n** 필요(효과가 작기 쉬움)

### 6.5 분할 요인(Blocking)
- 요일/플랫폼 차이를 **블록**으로 통제 → 오차 감소, **효율적 추정**  
- 설계 표에 **블록** 열을 추가하고 **무작위화**는 블록 내에서 수행

---

## 7) 분수 요인설계(2^(k−p)) — 빠른 스크리닝

### 7.1 동기
- k↑ → 2^k 급증. **스크리닝** 단계에서 **일부 조합만**으로 “큰 효과”를 찾는다.  
- 예: k=5 → 32조합; **1/2 분수**면 16조합만 수행.

### 7.2 별칭(aliasing)과 해석
- 분수설계는 **어떤 상호작용이 다른 효과와 혼합**된다(별칭).  
- **해결**:  
  - **해상도(Resolution)**: III(주효과↔2원 상호작용 별칭), IV(주효과는 2원과 분리, 2원↔2원 별칭), V(주효과/2원 모두 분리)  
  - **규칙**: 스크리닝엔 **Res. IV** 이상 권장  
  - **확인 실험**: 의심되는 조합만 추가 수행해 별칭 분리

### 7.3 효과 선택
- **정규/반정규 플롯** 또는 **Lenth 방법**으로 유의 효과 추정  
- **다중검정**은 **FDR**(BH)로 간결히 제어

---

## 8) 비율/카운트 지표: ANOVA 대신 **GLM(로지스틱·포아송)**

### 8.1 왜?  
- 전환(0/1), 오류수(카운트)는 **분산이 평균과 종속**. ANOVA의 **정규/등분산** 가정이 자연스럽지 않다.  
- **대안**:  
  - **로지스틱**: $$\log\frac{p}{1-p}=\text{요인}+\text{상호작용}$$  
  - **포아송/음이항**(오프셋 포함): $$\log \lambda=\text{요인}+\text{상호작용}+\log(\text{노출})$$

### 8.2 “ANOVA 느낌”으로 읽기  
- GLM의 **Deviance ANOVA**(우도비 검정)로 주효과/상호작용을 순차/유형별로 평가  
- 사후는 **EMMeans**(logit/로그율 스케일)로 대비, **OR/IRR** + **FDR 보정** 보고

> **리포트 예**  
> “이원 로지스틱에서 배너×요일 상호작용 유의(χ²=…, p<0.01). 수·금 **동영상** 배너 **OR=1.22 [1.10, 1.35]**. 다중비교는 **BH-FDR 5%**로 제어.”

---

## 9) 시각화·리포팅 템플릿

### 9.1 필수 그림
- **Interaction plot**: 요일 x축, 평균 전환율 y축, 배너별 선  
- **평균±SE 바차트**: 배너별/요일별  
- **잔차진단**(연속형): 잔차 vs 적합, QQ-플롯(ANOVA=특수한 선형모형)

### 9.2 표준 문장
- “이원 분석에서 **배너 주효과** F(2, …)=…, p=…, **요일 주효과** F(6, …)=…, p<…, **상호작용** F(12, …)=…, p=…. **부분 η²**: 배너 0.04, 요일 0.09, 상호작용 0.02.”  
- “상호작용 유의 → **단순효과**: 금요일에 동영상>기본 **Δ=+0.6pp** (Tukey, p_adj=0.02).”

---

## 10) 함정과 처방(체크리스트)

1) **비율에 일원/이원 ANOVA를 그대로 적용**  
   - ⟶ **로지스틱/포아송 GLM**으로 전환. 변환(아크사인 루트)은 과도 단순화.  
2) **이질분산·불균형 무시**  
   - 일원: **Welch + Games–Howell**.  
   - 이원: **Type II/III + 강건 SE**/**GLM**/**부트스트랩**.  
3) **상호작용 유의한데 주효과만 해석**  
   - ⟶ **단순효과/슬라이스 분석**으로 조건부 비교.  
4) **무작위화/배정 누락**  
   - 사용자ID 단위 **무작위화**(크로스오버 금지), 로그에 배정 기록.  
5) **다중검정 폭발**  
   - Tukey/Dunnett 또는 **BH-FDR**로 제어, **주지표 1개** 사전등록.  
6) **요인 누락/누락변수 편향**  
   - 주요 공변량(플랫폼, 국가) **블록/요인**으로 포함하거나 **회귀**와 결합.  
7) **시간추세/이월효과**  
   - 푸시 타이밍 설계는 **블록 요인(요일/주)** 추가, **세션/사용자** 클러스터 SE.  
8) **표본 불충분으로 상호작용 탐지 실패**  
   - 상호작용은 효과가 작다. **파워 분석**으로 per-cell n 확보.

---

## 11) Python 개념 코드 (statsmodels)

```python
# 가상 예시: 배너(3) × 요일(7) — 연속화 지표(예: log1p 매출) 이원 ANOVA (Type III)
import pandas as pd, numpy as np
import statsmodels.api as sm
import statsmodels.formula.api as smf
from statsmodels.stats.anova import anova_lm
from statsmodels.stats.multicomp import pairwise_tukeyhsd

# df: columns = ['y_cont','banner','weekday']  # y_cont: 예를 들면 log1p(세션당 매출)
df['banner']  = df['banner'].astype('category')
df['weekday'] = df['weekday'].astype('category')

# 이원 선형모형 적합 (HC3 강건 SE)
model = smf.ols('y_cont ~ C(banner)*C(weekday)', data=df).fit(cov_type='HC3')

# Type III ANOVA 표
anova3 = sm.stats.anova_lm(model, typ=3)
print(anova3)

# 상호작용 유의 → 단순효과(예: 금요일에서 배너 비교)
df_fri = df[df['weekday']=='Fri']
m_fri = smf.ols('y_cont ~ C(banner)', data=df_fri).fit(cov_type='HC3')
print(sm.stats.anova_lm(m_fri, typ=3))

# 사후검정 (Tukey) - 이질분산이면 Games–Howell 외부 패키지 고려
tukey = pairwise_tukeyhsd(endog=df_fri['y_cont'], groups=df_fri['banner'], alpha=0.05)
print(tukey.summary())

# 정석: 이항 응답이면 로지스틱 + 분산분석표(Deviance)
# df_bin: ['converted','banner','weekday','user_id']
glm = smf.glm('converted ~ C(banner)*C(weekday)', data=df, family=sm.families.Binomial()).fit()
print(glm.summary())
# 주효과/상호작용 검정은 likelihood ratio test로 각 항 제거 모형과 비교
```

> **주의**: 실전에서는 **EMMeans(LSMeans)** 로 불균형을 보정한 평균을 비교하고, **다중비교 보정**을 일관되게 적용한다.

---

## 12) 푸시 타이밍 2^3 요인설계 — 해석 예시(개념 숫자)

- 결과(로그 변환한 세션당 매출):  
  - **A(아침→저녁)**: \( \hat\beta_A=+0.03\) (≈ **+3.0%**)  
  - **B(1회→2회)**: \( \hat\beta_B=+0.01\) (미세)  
  - **C(일반→개인화)**: \( \hat\beta_C=+0.05\) (**+5.1%**)  
  - **AB**: \( \hat\beta_{AB}=+0.02\) (**상호작용**: 저녁×2회에서만 효과 증폭)  
  - **AC, BC, ABC**: 비유의  
- **의미**: 단순히 2회가 좋은 게 아니라 **저녁**일 때 2회가 의미 있음(AB).  
- **전략**: “저녁 × 2회 × 개인화” 우선 배포, 그 외는 1회 유지.

---

## 13) 파워·표본크기(개념)

### 13.1 일원 ANOVA
- **Cohen’s f**:  
  $$f=\sqrt{\frac{\sum_i \pi_i(\mu_i-\mu)^2}{\sigma^2}}$$  
  (균형: \(\pi_i=1/a\))  
- 주어진 \(f,\ \alpha,\ \text{그룹 수},\ \text{power}\) 로 **per-group n** 산정(전용 도구/공식)

### 13.2 이원 ANOVA
- 주효과/상호작용 각각의 **f** 또는 **부분 η²**로 per-cell **n** 추정  
- **균형**이 파워를 크게 좌우: 가능하면 **각 셀 동일 표본**

---

## 14) 한 페이지 요약 (TL;DR)

- **일원/이원 ANOVA**: 평균 차이와 **상호작용**을 **F**로 검정.  
- **사후검정**: Tukey(모든쌍), Dunnett(대조군), Games–Howell(이질분산). **효과크기(η²/ω²/부분 η²)** 함께.  
- **불균형**: **Type II/III SS** + **EMMeans**. **이질분산**: Welch/Games–Howell 또는 **GLM**/강건 SE.  
- **비율/카운트**: **로지스틱/포아송 GLM**(오프셋), **Deviance ANOVA**로 읽기.  
- **2^k 요인설계**: 주효과·상호작용을 동시에 파악, 필요하면 **분수설계** + **확인 실험**.  
- **리포트**: “주효과·상호작용 F/p, 효과크기, 사후비교(보정), 그래프(Interaction plot), 설계 한계(불균형/이질분산)”를 항상 함께.
