---
layout: post
title: C# - ë¹„ê´€ë¦¬ ë©”ëª¨ë¦¬ ì ‘ê·¼ ë° ë„¤ì´í‹°ë¸Œ ì—°ë™
date: 2024-10-29 19:20:23 +0900
category: Csharp
---
# C# ë¹„ê´€ë¦¬ ë©”ëª¨ë¦¬ ì ‘ê·¼ ë° ë„¤ì´í‹°ë¸Œ ì—°ë™ ì´ì •ë¦¬ (P/Invoke, Marshal, NativeMemory, Span<byte>)

C#ì€ ê¸°ë³¸ì ìœ¼ë¡œ **ê´€ë¦¬ ë©”ëª¨ë¦¬ í™˜ê²½(.NET GC)**ì—ì„œ ì‹¤í–‰ë˜ì§€ë§Œ,  
í•„ìš”ì— ë”°ë¼ **ë¹„ê´€ë¦¬ ë©”ëª¨ë¦¬(unmanaged memory)**ë‚˜ **ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬(C/C++)**ì™€ ìƒí˜¸ì‘ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ê¸€ì—ì„œëŠ” ê·¸ëŸ° ê³ ê¸‰ ê¸°ëŠ¥ë“¤ì„ ì •ë¦¬í•©ë‹ˆë‹¤.

---

## ğŸ”· 1. ë¹„ê´€ë¦¬ ë©”ëª¨ë¦¬ë€?

.NETì—ì„œ ê´€ë¦¬ë˜ì§€ ì•Šê³  GCì˜ ì œì–´ë¥¼ ë°›ì§€ ì•ŠëŠ” ë©”ëª¨ë¦¬ ì˜ì—­.

| êµ¬ë¶„ | ì„¤ëª… |
|------|------|
| **ê´€ë¦¬ ë©”ëª¨ë¦¬** | GCê°€ ì¶”ì /íšŒìˆ˜ (newë¡œ í• ë‹¹ëœ ê°ì²´) |
| **ë¹„ê´€ë¦¬ ë©”ëª¨ë¦¬** | C/C++ì²˜ëŸ¼ ì§ì ‘ í• ë‹¹/í•´ì œ í•„ìš” (GCê°€ ëª¨ë¦„) |

---

## ğŸ”· 2. Marshal í´ë˜ìŠ¤ - ë¹„ê´€ë¦¬ ë©”ëª¨ë¦¬ ë‹¤ë£¨ê¸°

`System.Runtime.InteropServices.Marshal`ì€  
C#ì—ì„œ **ë¹„ê´€ë¦¬ ë©”ëª¨ë¦¬ì— ì ‘ê·¼í•˜ê±°ë‚˜ ì¡°ì‘**í•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.

### âœ… ë©”ëª¨ë¦¬ í• ë‹¹ / í•´ì œ

```csharp
IntPtr ptr = Marshal.AllocHGlobal(100); // 100ë°”ì´íŠ¸ í• ë‹¹
Marshal.FreeHGlobal(ptr);               // í•´ì œ
```

### âœ… êµ¬ì¡°ì²´ â†’ í¬ì¸í„°

```csharp
MyStruct data = new MyStruct();
IntPtr p = Marshal.AllocHGlobal(Marshal.SizeOf<MyStruct>());
Marshal.StructureToPtr(data, p, false);
```

### âœ… í¬ì¸í„° â†’ êµ¬ì¡°ì²´

```csharp
MyStruct recovered = Marshal.PtrToStructure<MyStruct>(p);
```

---

## ğŸ”· 3. NativeMemory â€“ .NET 6+ ê³ ì„±ëŠ¥ ë©”ëª¨ë¦¬ API

.NET 6ë¶€í„°ëŠ” `System.Runtime.InteropServices.NativeMemory`ë¥¼ ì‚¬ìš©í•´  
**ë¹„ê´€ë¦¬ ë©”ëª¨ë¦¬ë¥¼ ë” ë¹ ë¥´ê³  ì§ê´€ì ìœ¼ë¡œ** ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```csharp
nint p = NativeMemory.Alloc(100);
NativeMemory.Free(p);
```

- `nint`: í”Œë«í¼ í¬ê¸°ì— ë”°ë¼ ìë™ ì¡°ì •ë˜ëŠ” ì •ìˆ˜(IntPtr ëŒ€ì²´)
- ì†ë„ê°€ ë” ë¹ ë¥´ê³  GC ê°œì… ì—†ìŒ
- Marshalë³´ë‹¤ í˜„ëŒ€ì ì´ê³  ê°„ê²°í•¨

---

## ğŸ”· 4. Span<byte>ì™€ ë¹„ê´€ë¦¬ ë©”ëª¨ë¦¬ ì—°ê²°

`Span<T>`ëŠ” ë¹„ê´€ë¦¬ ë©”ëª¨ë¦¬ë¥¼ ì•ˆì „í•˜ê²Œ ë‹¤ë£¨ëŠ” ë° ì í•©í•œ íƒ€ì…ì…ë‹ˆë‹¤.

```csharp
nint p = NativeMemory.Alloc(10);
Span<byte> span = new Span<byte>((void*)p, 10);

span[0] = 42;
NativeMemory.Free(p);
```

> âœ… í¬ì¸í„° â†’ Span ì—°ê²° ì‹œ ì•ˆì „í•˜ê²Œ ë²”ìœ„ ê²€ì‚¬ ë“± ì§€ì›ë¨

---

## ğŸ”· 5. P/Invoke (Platform Invocation)

C#ì—ì„œ ì™¸ë¶€ **C/C++ DLL í•¨ìˆ˜ í˜¸ì¶œ**ì„ ì§€ì›í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

### âœ… ì„ ì–¸ ì˜ˆì‹œ

```csharp
[DllImport("user32.dll")]
public static extern int MessageBox(IntPtr hWnd, string text, string caption, uint type);
```

### âœ… í˜¸ì¶œ

```csharp
MessageBox(IntPtr.Zero, "Hello", "PInvoke", 0);
```

> `DllImport`ëŠ” `System.Runtime.InteropServices`ì— ìˆìŒ

### âœ… C í•¨ìˆ˜ ì˜ˆì œ (Cë¡œ ë§Œë“  DLL)

```c
// C í•¨ìˆ˜ ì •ì˜ (export DLL)
__declspec(dllexport) int Add(int a, int b) {
    return a + b;
}
```

ê·¸ë¦¬ê³  C#ì—ì„œ:

```csharp
[DllImport("MyDll.dll")]
public static extern int Add(int a, int b);
```

---

## ğŸ”· 6. GCHandle â€“ ê´€ë¦¬ ê°ì²´ë¥¼ ë¹„ê´€ë¦¬ ì½”ë“œì— ë„˜ê¸¸ ë•Œ

ë¹„ê´€ë¦¬ ì½”ë“œì— .NET ê°ì²´ë¥¼ ì „ë‹¬í•  ë•Œ GCê°€ ê°ì²´ë¥¼ ì´ë™ì‹œí‚¤ì§€ ì•Šë„ë¡ ê³ ì •í•´ì•¼ í•¨.

```csharp
GCHandle handle = GCHandle.Alloc(myObject, GCHandleType.Pinned);
IntPtr ptr = handle.AddrOfPinnedObject();

// ... ë„¤ì´í‹°ë¸Œ í˜¸ì¶œ ë“±

handle.Free(); // ë°˜ë“œì‹œ í•´ì œ!
```

---

## ğŸ”· 7. Unsafe ì½”ë“œë¡œ ì§ì ‘ ì ‘ê·¼

```csharp
unsafe static void UnsafePointer()
{
    byte* p = (byte*)NativeMemory.Alloc(10);
    p[0] = 0xFF;
    NativeMemory.Free(p);
}
```

- `unsafe` í‚¤ì›Œë“œ í•„ìš”
- ê³ ì† ë²„í¼ ì²˜ë¦¬, ì´ë¯¸ì§€ ì¡°ì‘ ë“±ì— ìœ ìš©
- ê´€ë¦¬ ë©”ëª¨ë¦¬ì—ì„œ ì‚¬ìš© ë¶ˆê°€

---

## âœ… ìš”ì•½ ë¹„êµ

| ê¸°ìˆ  | ì—­í•  | ì‚¬ìš© ì‹œì  |
|------|------|------------|
| `Marshal` | êµ¬ì¡°ì²´ ë³€í™˜, ë¹„ê´€ë¦¬ ë©”ëª¨ë¦¬ ì ‘ê·¼ | í˜¸í™˜ì„±ìš© |
| `NativeMemory` | ê³ ì† ë¹„ê´€ë¦¬ ë©”ëª¨ë¦¬ í• ë‹¹/í•´ì œ | .NET 6+ ê¶Œì¥ |
| `Span<T>` | ì•ˆì „í•œ ë©”ëª¨ë¦¬ ì ‘ê·¼ | ë²„í¼ ì¡°ì‘, stackalloc ë“± |
| `P/Invoke` | C/C++ DLL í˜¸ì¶œ | Win32 API ì—°ë™ ë“± |
| `GCHandle` | .NET ê°ì²´ ê³ ì • | ë„¤ì´í‹°ë¸Œ í˜¸ì¶œ ì‹œ í•„ìš” |
| `unsafe` í¬ì¸í„° | ì§ì ‘ ë©”ëª¨ë¦¬ ì¡°ì‘ | ê³ ì„±ëŠ¥ ì²˜ë¦¬, ì‹œìŠ¤í…œ í”„ë¡œê·¸ë˜ë° |