---
layout: post
title: 정보보안기사 - 엔드포인트 보안
date: 2025-11-06 14:25:23 +0900
category: 정보보안기사
---
# 엔드포인트 보안(AV/EDR/XDR, 응용제어, 취약점/패치관리)

## 0) 큰그림(One-Page)

- **AV(안티바이러스)**: 시그니처·기계학습 기반 **실시간 검사·행위 차단**. 필수지만 **단독**으로는 부족.
- **EDR(Endpoint Detection & Response)**: **프로세스·파일·레지스트리·네트워크 텔레메트리** 수집 → **행위 기반 탐지/헌팅** → **격리/킬/롤백**.
- **XDR(eXtended DR)**: EDR + **이메일·아이덴티티·네트워크·클라우드**까지 **연계 탐지/대응**.
- **응용제어(Application Control)**: **허용목록(Allow-list)**, 서명/경로/해시·정책으로 **실행 제어**(Windows: **AppLocker/WDAC**, macOS: **Gatekeeper/Notarization**, Linux: **SELinux/AppArmor + 파일시스템/권한**).
- **취약점/패치관리(VM/PM)**: **자산 인벤토리 → 스캔(OVAL/CVE) → 위험기반 우선순위 → 배치/재부팅/롤백 → 컴플라이언스 보고**.
- **운영 원칙**: 최소권한, Zero Trust, **정책 표준화(GPO/MDM/구성관리)**, 중앙 수집(WEF/Syslog/Osquery TLS), 변경/롤백 문서화.

---

# 1) AV / EDR / XDR

## 1.1 개념 정리

- **AV**: 알려진 악성코드/유사 패턴/휴리스틱/ML 기반 **차단**.  
- **EDR**: **행위**(프로세스 트리, 명령줄, DLL 로드, 드라이버, 네트워크 접속) 중심 **수집/탐지/대응**.  
- **XDR**: 엔드포인트 외 **이메일/IdP/프록시/클라우드 워크로드/서버**까지 **코릴레이션과 자동대응**.

> 설계 팁: **AV=예방, EDR=사후/행위, XDR=교차도메인 상관관계**.  
> 중복 도구는 충돌/성능저하를 부르므로 **표준 스택 1개**로 통일하고, **예외**만 정책으로 관리.

---

## 1.2 엔드포인트 텔레메트리 최소 수집 표준

- **프로세스**: 생성/종료(명령줄 포함), 부모-자식 트리, 서명/해시.  
- **파일**: 생성/수정/삭제, PE 메타, 실행 권한 변경.  
- **레지스트리(Win)**: Run 키/서비스/드라이버/시스템 정책 변경.  
- **네트워크**: 프로세스별 연결(로컬/원격 IP/Port/도메인).  
- **보안 이벤트**: 로그인/권한 상승/정책 변경/로그 삭제.

**Windows Quick Query (PowerShell)**
```powershell
# 최근 1시간, 프로세스 생성(4688) + 명령줄
$start = (Get-Date).AddHours(-1)
Get-WinEvent -FilterHashtable @{LogName='Security'; Id=4688; StartTime=$start} |
  Select TimeCreated,
         @{n='ParentPID';e={$_.Properties[3].Value}},
         @{n='NewProcessName';e={$_.Properties[6].Value}},
         @{n='CommandLine';e={$_.Properties[8].Value}} |
  Out-GridView
```

**Linux Quick Hunt (auditd + ausearch)**
```bash
# 최근 1시간, 실행 추적
sudo ausearch -i -ts recent -m EXECVE | tail -n 50
```

**macOS Unified Log**
```bash
# 최근 1시간, Gatekeeper/AMFI 관련
log show --predicate 'subsystem CONTAINS "com.apple.security"' --last 1h
```

---

## 1.3 실습: “의심스러운 PowerShell 인코딩 실행 탐지”

### Windows (Event 4104 ScriptBlock / 4688)
```powershell
# 4104(스크립트 블록 로깅) + -enc 흔적 탐지
$start=(Get-Date).AddHours(-4)
Get-WinEvent -FilterHashtable @{LogName='Microsoft-Windows-PowerShell/Operational'; StartTime=$start} |
? { $_.Message -match "-enc" -or $_.Message -match "FromBase64String" } |
Select TimeCreated,Message | Out-GridView

# 4688에서 -enc 포함 실행
Get-WinEvent -FilterHashtable @{LogName='Security'; Id=4688; StartTime=$start} |
? { $_.Message -match "powershell.exe" -and $_.Message -match " -enc " } |
Select TimeCreated,Message
```
**대응**: EDR 룰/응답으로 **프로세스 킬 + 네트워크 격리 + 아티팩트 수집**(메모리 덤프/디스크 캡처) 자동화.

---

## 1.4 리눅스 실습: osquery로 “권한 상승 시도” 찾기

```sql
-- root 소유 SUID 파일 나열
SELECT path, uid, gid, mode, md5
FROM file
WHERE path LIKE '/usr/bin/%' AND (mode & 2048) != 0;

-- 최근 1시간 UID 전환(ex: sudo/su)
SELECT * FROM process_events
WHERE cmdline LIKE '%sudo%' AND time > strftime('%s','now')-3600;
```

**배포**: osqueryd + TLS 플릿(서버) 연동으로 중앙 수집/조인.

---

## 1.5 YARA로 단순 시그니처 헌팅(예)

```bash
# rule.yar
rule SuspiciousEncodedPowershell {
  strings:
    $a = /powershell\.exe.*-enc\s+[A-Za-z0-9+\/=]{20,}/ nocase
  condition:
    $a
}
yara -r rule.yar /var/log/
```

> 실제 운영은 **EDR/XDR 탐지 엔진**에 룰/쿼리를 배포하고 **오탐 튜닝**이 필수.

---

# 2) 응용제어(Application Control)

## 2.1 Windows — AppLocker / WDAC

### 전략
- **감사(Audit)** → **정책 보강** → **강제(Enforce)** 단계적 전환.
- 개발/빌드/IT 툴 체인을 **서명/경로** 기준으로 예외 허용.
- **스크립트**(`.ps1`, `.vbs`, `.js`, `.bat`, `.cmd`)는 **서명/경로 제한** 필수.

### AppLocker 빠른 시작(감사 → 강제)
```powershell
# 1) 기본 규칙 생성(관리자/Windows 디폴트 허용)
New-AppLockerPolicy -DefaultRule -XMLPolicy C:\Temp\applocker.xml
Set-AppLockerPolicy -XMLPolicy C:\Temp\applocker.xml -Merge

# 2) .ps1/.bat 등 스크립트는 서명만 허용 (GUI 또는 별도 XML 작성 권장)
# 3) 감사 모드 적용 확인
Get-AppLockerPolicy -Effective -Xml | Out-File C:\Temp\effective.xml

# 이벤트 확인
Get-WinEvent -LogName "Microsoft-Windows-AppLocker/EXE and DLL" -MaxEvents 50
```

### WDAC(서명 기반 허용목록) 핵심 패턴
- 운영: **서명된 코드만 허용** + 사내 서명 루트 신뢰 + 드라이버 제한.
- 파일시스템 경로/해시 예외 최소.

```powershell
# WDAC 정책(XML) 생성은 GUI/Wizard 또는 PowerShell 툴킷 사용
# 배포 후 감사 → 차단 전환
```

---

## 2.2 macOS — Gatekeeper/Notarization/MDM

- **Gatekeeper**: 서명·공식 배포(Notarized) 앱만 허용(보안 설정 강화).  
- **spctl**로 상태 점검:
```bash
spctl --status
spctl --assess --type execute /Applications/SomeApp.app
```
- **MDM 구성 프로파일**로 “허용된 개발자 TeamID/BundleID”만 승인.  
- **PPPC**(개인정보 보호 제어)로 터미널/관리도구의 파일/스크린녹화 권한 사전 허용(필수만).

---

## 2.3 Linux — SELinux/AppArmor + 실행 경로/권한

- **SELinux/AppArmor**: 프로세스별 **읽기/쓰기/네트워크/바인드** 제한.  
- `/tmp` `noexec` + **Capability**로 최소권한 바인드(`cap_net_bind_service`).  
- **패키지 관리 기반**(rpm/apt) 설치만 허용하고 임의 바이너리 실행 경로는 **읽기 전용**.

```bash
# /tmp 실행 차단
echo "tmpfs /tmp tmpfs defaults,noexec,nosuid,nodev,mode=1777 0 0" | sudo tee -a /etc/fstab
sudo mount -o remount /tmp
```

---

# 3) 취약점/패치관리(Vulnerability & Patch Management)

## 3.1 프로세스(표준)

1) **자산 인벤토리**: OS/에디션/빌드, 설치 소프트웨어/버전/SBOM.  
2) **스캔**: 에이전트/에이전트리스, **CVE/OVAL** 매핑, 네트워크/로컬 혼합.  
3) **우선순위**: CVSS + **활성 악용(KEV)** + 노출도(인터넷/권한) + 비즈니스 영향.  
4) **배치**: 시험(파일럿) → 링 배포 → 전체 → 재부팅/검증.  
5) **예외/연기**: 보정통제(응용제어/EDR 룰), 만료일 지정.  
6) **리포팅**: SLA(예: 크리티컬 7일/하이 14일), 준수율/KPI.

---

## 3.2 인벤토리 수집 예제

### Windows — 설치 소프트웨어/핫픽스
```powershell
# 1) Win32_Product는 느려서 권장하지 않음. 레지스트리 경로 스캔
$paths = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall",
         "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall"
$apps = foreach($p in $paths){
  Get-ChildItem $p | ForEach-Object {
    $disp=(Get-ItemProperty $_.PsPath).DisplayName
    if($disp){[pscustomobject]@{
      DisplayName=$disp
      DisplayVersion=(Get-ItemProperty $_.PsPath).DisplayVersion
      Publisher=(Get-ItemProperty $_.PsPath).Publisher
    }}
  }
}
$apps | Sort DisplayName | Format-Table -Auto

# 2) 설치된 핫픽스
Get-HotFix | Select HotFixID,InstalledOn | Sort InstalledOn -Descending
```

### Linux — 패키지/커널
```bash
# Debian/Ubuntu
dpkg -l | awk '{print $2" "$3}' | tail -n +6
uname -a

# RHEL/Alma/Rocky
rpm -qa --queryformat '%{NAME} %{VERSION}-%{RELEASE}\n' | sort
```

### macOS — 앱/OS 업데이트
```bash
system_profiler SPApplicationsDataType | grep -E "Location:|Version:"
softwareupdate -l
```

---

## 3.3 취약점 스캔(OpenSCAP 예)

```bash
# RHEL 예: CIS/SCAP 프로파일로 평가(리포트 산출)
sudo oscap xccdf eval --profile xccdf_org.ssgproject.content_profile_cis \
  --results /var/tmp/openscap-results.xml --report /var/tmp/openscap-report.html \
  /usr/share/xml/scap/ssg/content/ssg-rhel9-ds.xml
```

**검증**: `openscap-report.html` 점수/실패 항목 확인 → 자동시정 스크립트 생성 가능(프로파일에 따라 다름).  
**주의**: 하드닝 권고는 서비스에 영향 줄 수 있으니 **파일럿** 필수.

---

## 3.4 패치 배포/자동화

### Windows — PowerShell(WSUS/클라우드 정책 외 단독 예)
```powershell
# PSWindowsUpdate 모듈 사용 예(관리 템플릿 기반 배포 전 테스트)
Install-Module PSWindowsUpdate -Force
Get-WindowsUpdate -MicrosoftUpdate -AcceptAll -IgnoreReboot
Install-WindowsUpdate -MicrosoftUpdate -AcceptAll -AutoReboot
```

### Linux — 자동 보안 업데이트
```bash
# Debian/Ubuntu
sudo apt update && sudo apt -y upgrade
sudo apt install -y unattended-upgrades
sudo dpkg-reconfigure --priority=low unattended-upgrades

# RHEL/Alma/Rocky
sudo dnf check-update
sudo dnf -y upgrade
sudo systemctl enable --now dnf-automatic.timer || true
```

### macOS — 자동 업데이트
```bash
# 크리티컬 업데이트 자동 설치
sudo softwareupdate --install --all
sudo softwareupdate --schedule on
```

### Ansible(다중 OS 롤아웃, 요약)
```yaml
- hosts: endpoints
  become: true
  tasks:
    - name: Linux | Update
      package:
        name: '*'
        state: latest
      when: ansible_os_family != 'Windows'

    - name: Windows | Update (PSWindowsUpdate)
      win_shell: |
        Install-Module PSWindowsUpdate -Force
        Install-WindowsUpdate -MicrosoftUpdate -AcceptAll -AutoReboot
      when: ansible_os_family == 'Windows'
```

**롤백**:  
- Windows: `wusa /uninstall /kb:XXXXX` 또는 “업데이트 기록 → 제거”.  
- Linux/macOS: 주요 패키지는 이전 버전 재설치/스냅샷 복구(필수 시스템은 **스냅샷/이미지 백업** 전제).

---

## 3.5 위험 기반 우선순위(Risk-Based Prioritization)

- **악용 중(KEV)**, **공격 체인 상 조기 단계(원격 코드 실행, 권한 상승)**, **외부 노출** 시스템 우선.  
- **패치불가** 시스템은 **네트워크 세그멘테이션/가상 패치(WAF/정책)/응용제어/EDR 룰**로 보정통제.  
- **SLA** 예: Critical 7일/High 14일/Medium 30일/Low 60일.

---

# 4) 운영 시나리오(End-to-End)

## 시나리오 A — “랜섬웨어 방지: 실행 제어 + 민감 폴더 보호 + 신속 대응”

1) **응용제어**: 허용 목록(Windows: WDAC/AppLocker, macOS Gatekeeper, Linux SELinux/AppArmor) 적용.  
2) **민감 폴더 보호(Windows 예)**:
```powershell
# Controlled Folder Access(감사 → 강제)
Set-MpPreference -EnableControlledFolderAccess Enabled
Add-MpPreference -ControlledFolderAccessProtectedFolders "C:\Data","D:\Projects"
Add-MpPreference -ControlledFolderAccessAllowedApplications "C:\Program Files\Trusted\Editor.exe"
```
3) **의심 행위 탐지**: 대량 파일 암호화 패턴(짧은 시간 다수의 파일 rename/write) EDR 룰.  
4) **대응**: **네트워크 격리 + 프로세스 킬 + 휘발성 아티팩트 수집** 자동화.  
5) **복구**: 백업/스냅샷에서 복원, 원인 규명 후 예외 정책 최소화.

---

## 시나리오 B — “개발자 머신: 빌드 체인 예외와 보안 균형”

- **문제**: 빌드/런타임 툴이 잦은 업데이트/커스텀 바이너리 사용 → 응용제어와 충돌.  
- **해결**:  
  - 경로 기반(서명 어려운 경우) 허용 **전용 작업 디렉터리**를 만들고 **해시 핀** 또는 **Team 서명** 도입.  
  - **네트워크/권한**은 여전히 최소(프록시/레지스트리/키체인 접근 제한).  
  - 빌드 디렉터리 외 실행은 차단.

**AppLocker(예)**
```powershell
# D:\Dev\Build\ 경로는 개발자 그룹만 실행 허용, 그 외 스크립트는 서명 필수
# 세부 XML 정책은 GPO/GUI로 작성 후 배포 권장
```

---

## 시나리오 C — “취약점 제로데이: 가상 패치 + 임시 룰 + 신속 패치”

1) **탐지**: 위협 인텔로 새로운 RCE 공개.  
2) **가상 패치**:  
   - WAF/프록시 룰 차단,  
   - 엔드포인트 **EDR 차단 룰**(특정 프로세스 인자/로드 DLL),  
   - 응용제어로 **해당 바이너리 버전 실행 금지**.  
3) **패치**: 벤더 패치 T+N 시간 배포 계획 – 파일럿 → 링 확장.  
4) **검증**: 공격 재현 PoC로 차단/패치 적용 상태 확인.  
5) **해제**: 벤더 패치 안정화 시 임시 룰 단계적 해제.

---

## 시나리오 D — “패치 윈도우 자동화 + 리스크 예외”

- **윈도우 서버군**: 월 2주차 주말 02:00~04:00, 자동 재부팅 허용.  
- **리눅스 DB군**: 동기화 후 **롤링 패치**(1/N씩), 헬스체크 패스 시 다음 묶음.  
- **예외 티켓**: 패치 연기 사유/보정통제/만료일 기입 후 승인 필수.

**Ansible 롤링(요약)**
```yaml
- hosts: dbservers
  serial: 10%
  tasks:
    - name: Apply security updates only (RHEL)
      dnf:
        name: '*'
        state: latest
        security: yes
    - name: Reboot if needed
      reboot:
        reboot_timeout: 1800
```

---

# 5) 모니터링/탐지/보고

## 5.1 지표(KPI)
- **AV/EDR 에이전트 커버리지**(≥ 98%)  
- **EDR 텔레메트리 가용성**(최근 24h 데이터 ≥ 95%)  
- **패치 준수율**(Critical 7d ≥ 95%)  
- **MTTD/MTTR**: 탐지/격리/조치 시간  
- **오탐률/정책 예외 만료 준수율**

## 5.2 운영 대시보드 쿼리 샘플

### Windows — 최근 24h 관리자 특권 로그인(4672)
```powershell
$start=(Get-Date).AddDays(-1)
Get-WinEvent -FilterHashtable @{LogName='Security'; Id=4672; StartTime=$start} |
  Group-Object {$_.Properties[1].Value} | Sort Count -Descending |
  Select Name,Count
```

### osquery — 네트워크 비정상 포트 리스닝
```sql
SELECT p.name, l.port, l.address, p.cmdline
FROM listening_ports l JOIN processes p ON l.pid=p.pid
WHERE l.port NOT IN (22,80,443,3389,53) AND address != '127.0.0.1';
```

---

# 6) 배포/구성 자동화 번들

## 6.1 Windows — PowerShell 스냅인(점검/수정 일괄)

```powershell
<#
.SYNOPSIS
  Endpoint Baseline: AV/Logging/AppLocker quick configure (랩/PoC 용)
#>

# 1) PowerShell 로깅
$base = 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell'
New-Item -Path "$base\ScriptBlockLogging" -Force | Out-Null
Set-ItemProperty "$base\ScriptBlockLogging" -Name EnableScriptBlockLogging -Type DWord -Value 1
New-Item -Path "$base\ModuleLogging\ModuleNames" -Force | Out-Null
Set-ItemProperty "$base\ModuleLogging" -Name EnableModuleLogging -Type DWord -Value 1
New-ItemProperty "$base\ModuleLogging\ModuleNames" -Name "*" -PropertyType String -Value "*" -Force | Out-Null

# 2) 프로세스 명령줄 로깅
New-Item -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit" -Force | Out-Null
Set-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit" `
  -Name "ProcessCreationIncludeCmdLine_Enabled" -Type DWord -Value 1

# 3) AV 기본 설정(예)
Set-MpPreference -PUAProtection Enabled -EnableNetworkProtection Enabled
Update-MpSignature
```

## 6.2 Linux — 하드닝/패치 Ansible(요약)

```yaml
- hosts: linux_endpoints
  become: true
  tasks:
    - name: Ensure SELinux/AppArmor enforcing (플랫폼 조건)
      command: getenforce
      register: sel
      ignore_errors: yes

    - name: /tmp noexec
      mount:
        path: /tmp
        src: tmpfs
        fstype: tmpfs
        opts: defaults,noexec,nosuid,nodev,mode=1777
        state: mounted

    - name: Install osquery
      package:
        name: osquery
        state: present

    - name: Update all packages
      package:
        name: '*'
        state: latest
```

---

# 7) 체크리스트

**AV/EDR/XDR**
- [ ] 단일 표준 스택, 중복 에이전트 제거  
- [ ] 텔레메트리(프로세스/네트워크/스크립트) 수집 On  
- [ ] 헌팅 룰: `-enc`, LOLBins(rundll32/regsvr32/mshta), 대량 파일 변경  
- [ ] 자동 대응: 격리/킬/블록/티켓 생성

**응용제어**
- [ ] 감사 → 강제 단계 전환 계획  
- [ ] 스크립트/매크로/드라이버 서명 요구  
- [ ] 개발자/빌드 체인 예외 최소화(경로/서명)  
- [ ] Linux: SELinux/AppArmor enforce, `/tmp noexec`

**취약점/패치**
- [ ] 인벤토리/스캔 파이프라인(주기/범위 명시)  
- [ ] 위험 기반 SLA(Critical 7d)  
- [ ] 패치 윈도우/롤링/리부트 계획  
- [ ] 예외 만료/보정통제 기록

**로깅/보고**
- [ ] 중앙 수집(WEF/Osquery TLS/Syslog)  
- [ ] KPI 대시보드/월간 리포트  
- [ ] 경보 라우팅(Slack/Email/Pager)

---

# 8) 트러블슈팅 & 롤백

- **성능 저하/충돌**: 중복 실시간 검사 비활성, 예외(빌드/백업 폴더) 최소 범위 지정.  
- **오탐/업무 차단**: 감사 모드에서 경로/서명 기반 예외 식별 → 검토 후 한정 허용.  
- **패치 실패/블루스크린**: 스냅샷/백업 복원, 문제 KB 제거, 벤더 케이스 오픈.  
- **로그 과다**: 보존 기간/필드 축소, 샘플링, 저장소 압축/수명주기.

**Windows KB 롤백**
```powershell
wusa /uninstall /kb:5000000 /quiet /norestart
```

**Linux 패키지 롤백(예: DNF 히스토리)**
```bash
sudo dnf history
sudo dnf history undo <ID>
```

---

# 9) 요약(암기 포인트)

- **AV=예방**, **EDR=행위 탐지/대응**, **XDR=도메인 연계** — **단일 표준화**가 핵심.  
- **응용제어**로 기본 실행을 막고 **필요만 허용**(서명/경로/해시).  
- **취약점/패치**는 **자산→스캔→위험기반 배포→검증/보고**의 루프.  
- **자동화/중앙수집** 없이는 규모 확장 불가: GPO/MDM/Ansible + WEF/Osquery/Syslog.