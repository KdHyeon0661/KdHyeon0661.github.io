---
layout: post
title: TCPIP - DNS 메시징
date: 2025-12-02 16:25:23 +0900
category: TCPIP
---
# DNS 메시징 및 메시지, 자원 레코드, 마스터 파일 형식

DNS는 단순한 이름-주소 변환 시스템을 넘어, 정교한 메시징 프로토콜을 통해 분산 데이터베이스로서의 기능을 수행합니다. 이러한 메시지 교환 체계는 효율성과 확장성을 동시에 추구하며, 40년이 넘는 시간 동안 인터넷의 핵심 인프라로 자리매김했습니다.

## DNS 메시지 생성과 전송

### DNS 통신 모델
DNS는 클라이언트-서버 모델을 기반으로 하지만, 재귀적(recursive)과 반복적(iterative) 쿼리의 구분으로 더욱 복잡한 상호작용을 구현합니다.

**기본 통신 패턴:**
```
재귀 해석기(Stub Resolver) → 재귀 서버(Recursive Resolver) → 권한 서버(Authoritative Server)
        (로컬)                         (ISP 또는 공공 DNS)            (도메인 소유자)
```

**전송 프로토콜:**
1. **UDP 포트 53**: 기본 모드, 512바이트 제한
   - 빠른 응답 시간
   - 작은 메시지에 최적화
   - 트랜잭션 ID를 통한 요청-응답 매칭

2. **TCP 포트 53**: 대용량 응답 또는 영역 전송
   - 512바이트 초과 메시지
   - AXFR/IXFR 영역 전송
   - DNSSEC 서명된 응답

### DNS 메시지 처리 흐름

**일반적인 쿼리 처리 과정:**
```
1. 클라이언트: 재귀 쿼리 전송 (RD=1)
2. 재귀 서버: 캐시 확인 → 없으면 루트 서버에 반복 쿼리
3. 루트 서버: TLD 서버 참조 응답
4. 재귀 서버: TLD 서버에 반복 쿼리
5. TLD 서버: 권한 서버 참조 응답
6. 재귀 서버: 권한 서버에 반복 쿼리
7. 권한 서버: 최종 응답
8. 재귀 서버: 클라이언트에 응답, 캐시 저장
```

**에러 처리 메커니즘:**
- **서버 실패**: SERVFAIL (RCODE=2)
- **이름 없음**: NXDOMAIN (RCODE=3)
- **쿼리 거부**: REFUSED (RCODE=5)

## DNS 메시지 처리와 일반 메시지 형식

### DNS 메시지 기본 구조
모든 DNS 메시지는 단일 통합 형식을 가지며, 헤더와 네 가지 주요 섹션으로 구성됩니다:

```
┌─────────────────────────────────────────┐
│                헤더 (12바이트)            │
├─────────────────────────────────────────┤
│            질문 섹션 (가변 길이)          │
├─────────────────────────────────────────┤
│            응답 섹션 (가변 길이)          │
├─────────────────────────────────────────┤
│          권한 섹션 (가변 길이)            │
├─────────────────────────────────────────┤
│          추가 정보 섹션 (가변 길이)       │
└─────────────────────────────────────────┘
```

**섹션별 역할:**
- **질문 섹션**: 클라이언트의 쿼리 정보
- **응답 섹션**: 요청된 자원 레코드
- **권한 섹션**: 위임 정보 (NS 레코드)
- **추가 정보 섹션**: 관련된 추가 레코드 (주소 등)

## DNS 메시지 헤더 및 질문 섹션 형식

### 헤더 상세 구조 (12바이트)
```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             트랜잭션 ID        |            플래그             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         질문 수               |         응답 RR 수            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       권한 RR 수              |       추가 RR 수              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

**트랜잭션 ID (16비트):**
- 요청-응답 매칭을 위한 고유 식별자
- 클라이언트가 생성, 서버가 동일 값으로 응답
- UDP에서의 재전송 공격 방지에 부분적 역할

**플래그 필드 세부 분석:**

```
플래그 필드 비트 맵:
15 14 13 12 11 10 9  8  7  6  5  4  3  2  1  0
QR Opcode  AA TC RD RA Z  AD CD RCODE
```

1. **QR (1비트)**: 0=쿼리, 1=응답
2. **Opcode (4비트)**:
   - 0: 표준 쿼리 (QUERY)
   - 1: 역방향 쿼리 (IQUERY) - 사용 중단됨
   - 2: 서버 상태 요청 (STATUS)
   - 4: 알림 (NOTIFY)
   - 5: 업데이트 (UPDATE)
3. **AA (권한 응답, 1비트)**: 응답이 권한 서버에서 왔음을 표시
4. **TC (잘림, 1비트)**: 메시지가 잘렸음을 표시 (TCP 재시도 필요)
5. **RD (재귀 요청, 1비트)**: 클라이언트의 재귀 쿼리 요청
6. **RA (재귀 가능, 1비트)**: 서버의 재귀 쿼리 지원 표시
7. **Z (예약, 1비트)**: 항상 0
8. **AD (인증된 데이터, 1비트)**: DNSSEC 검증된 데이터 (응답에만)
9. **CD (검사 비활성화, 1비트)**: DNSSEC 검사 비활성화 요청
10. **RCODE (응답 코드, 4비트)**:
    - 0: NOERROR
    - 1: FORMATERROR
    - 2: SERVFAIL
    - 3: NXDOMAIN
    - 4: NOTIMP
    - 5: REFUSED
    - 9: NOTAUTH (서버가 영역에 권한 없음)

### 질문 섹션 형식
질문 섹션은 하나 이상의 질문 엔트리를 포함하며, 각 엔트리는 다음과 같은 형식을 가집니다:

```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
/                            QNAME                             /
/                                                               /
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|            QTYPE              |           QCLASS              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

**필드 설명:**
1. **QNAME (가변 길이)**: 쿼리 대상 도메인 이름
   - 라벨 시퀀스 형식 (압축 가능)
   - NULL 라벨(0)로 종료

2. **QTYPE (16비트)**: 요청된 자원 레코드 타입
   - 주요 값:
     - 1: A (IPv4 주소)
     - 2: NS (네임 서버)
     - 5: CNAME (별칭)
     - 15: MX (메일 교환기)
     - 16: TXT (텍스트 정보)
     - 28: AAAA (IPv6 주소)
     - 255: ANY (모든 레코드)

3. **QCLASS (16비트)**: 요청된 클래스
   - 1: IN (인터넷)
   - 3: CH (Chaosnet)
   - 4: HS (Hesiod)
   - 254: NONE (RFC 2136)
   - 255: ANY (모든 클래스)

## DNS 메시지 자원 레코드 필드 형식

### 자원 레코드 기본 구조
응답, 권한, 추가 정보 섹션은 모두 동일한 자원 레코드(RR) 형식을 사용합니다:

```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
/                             NAME                             /
/                                                               /
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             TYPE              |            CLASS              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                              TTL                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|            RDLENGTH           |                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
/                             RDATA                             /
/                                                               /
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 자원 레코드 필드 상세

1. **NAME (가변 길이)**: 레코드가 속한 도메인 이름
   - 압축 포인터 사용 가능

2. **TYPE (16비트)**: RR 타입 (QTYPE과 동일 값 공유)
   - 확장된 타입들:
     - 6: SOA (Start of Authority)
     - 12: PTR (포인터)
     - 33: SRV (서비스 위치)
     - 41: OPT (EDNS0 옵션)
     - 46: RRSIG (DNSSEC 서명)
     - 47: NSEC (다음 보안 레코드)

3. **CLASS (16비트)**: RR 클래스 (QCLASS와 동일 값 공유)

4. **TTL (32비트)**: Time To Live (초 단위)
   - 캐시 유효 시간
   - 0: 즉시 캐시 만료
   - 일반값: 300(5분) ~ 86400(24시간)

5. **RDLENGTH (16비트)**: RDATA 필드 길이 (바이트)

6. **RDATA (가변 길이)**: 타입별 데이터

### 주요 RR 타입별 RDATA 형식

**A 레코드 (타입 1):**
```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                            ADDRESS                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

**AAAA 레코드 (타입 28):**
```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                         ADDRESS (128비트)                     |
|                                                               |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

**CNAME 레코드 (타입 5):**
- 도메인 이름 하나만 포함
- 압축 가능

**MX 레코드 (타입 15):**
```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          PREFERENCE           |                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
/                          EXCHANGE                            /
/                                                               /
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

**SOA 레코드 (타입 6):**
```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
/                            MNAME                             /
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
/                            RNAME                             /
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    SERIAL NUMBER                             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    REFRESH INTERVAL                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                     RETRY INTERVAL                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    EXPIRE LIMIT                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    MINIMUM TTL                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

## DNS 이름 표기법과 메시지 압축 기술

### 이름 인코딩 방식
DNS에서 도메인 이름은 **라벨 시퀀스** 형식으로 인코딩됩니다:

**일반 인코딩:**
```
예: www.google.com
인코딩: 3 w w w 6 g o o g l e 3 c o m 0
길이:   ↑           ↑           ↑     ↑
       라벨1       라벨2       라벨3   종료
```

### DNS 메시지 압축
RFC 1035에 정의된 압축 기술은 메시지 크기를 크게 줄여줍니다:

**압축 포인터 형식:**
```
포인터: 1 1 + 오프셋 (14비트)
비트:   1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0
       ↑ ↑
       압축 포인터 표시 (항상 11로 시작)
```

**압축 예시:**
```
원본 메시지 (압축 없음):
www.google.com IN A
인코딩: 3 w w w 6 g o o g l e 3 c o m 0 ...

압축 적용 후 (동일 이름 반복 시):
첫 번째: 3 w w w 6 g o o g l e 3 c o m 0
두 번째: 3 w w w [포인터] (첫 번째의 google.com 위치 참조)
```

**압축 규칙:**
1. 도메인 이름 전체 또는 일부를 압축 가능
2. 압축 포인터는 항상 이전에 등장한 이름을 참조
3. 압축은 재귀적 적용 가능 (압축된 이름도 다시 압축 가능)
4. NULL 라벨(0)은 압축하지 않음

**실제 메시지 압축 예제:**
```
질문: mail.google.com
응답 권한 섹션: google.com NS ns1.google.com
응답 추가 섹션: ns1.google.com A 192.0.2.1

압축 적용:
- 질문: mail.google.com (일반 인코딩)
- 권한: [포인터 to google.com] NS ns1.[포인터 to google.com]
- 추가: ns1.[포인터 to google.com] A ...
```

## DNS 마스터 파일 형식

### 존 파일 구조
마스터 파일(또는 존 파일)은 텍스트 기반으로 DNS 존 데이터를 정의합니다:

**기본 형식:**
```
[도메인] [TTL] [클래스] [타입] [RDATA]
```

**주요 지시어:**
1. **$ORIGIN**: 기본 도메인 설정
2. **$TTL**: 기본 TTL 값 설정
3. **$INCLUDE**: 다른 파일 포함
4. **;**: 주석 시작

### 완전한 존 파일 예제
```
; Google.com 예제 존 파일
$ORIGIN google.com.
$TTL 3600

@       IN  SOA   ns1.google.com. admin.google.com. (
                  2024010101      ; Serial
                  7200            ; Refresh (2시간)
                  3600            ; Retry (1시간)
                  1209600         ; Expire (2주)
                  3600 )          ; Minimum TTL

; 네임 서버 레코드
        IN  NS    ns1.google.com.
        IN  NS    ns2.google.com.
        IN  NS    ns3.google.com.

; 주소 레코드
@       IN  A     142.250.206.206
        IN  AAAA  2001:4860:4802:38::a

; 별칭 (CNAME) 레코드
www     IN  CNAME @
mail    IN  CNAME @

; 서브도메인
docs    IN  A     142.250.206.207

; 메일 교환기 (MX)
@       IN  MX    10 aspmx.l.google.com.
        IN  MX    20 alt1.aspmx.l.google.com.

; 텍스트 레코드 (SPF, DMARC 등)
@       IN  TXT   "v=spf1 include:_spf.google.com ~all"
        IN  TXT   "google-site-verification=..."

; 서비스 레코드 (SRV)
_sip._tcp    IN  SRV 10 60 5060 sipserver.google.com.
```

### SOA 레코드 필드 상세

**SOA 필드 설명:**
1. **MNAME**: 이 존의 기본 마스터 네임서버
2. **RNAME**: 관리자 이메일 (@ 대신 . 사용)
   - 예: admin.google.com. → admin@google.com
3. **Serial**: 버전 번호 (YYYYMMDDNN 형식 권장)
4. **Refresh**: 보조 서버의 주기적 업데이트 간격
5. **Retry**: 실패 시 재시도 간격
6. **Expire**: 보조 서버의 데이터 만료 시간
7. **Minimum**: 부정적 캐싱 TTL (NXDOMAIN 응답 등)

## IPv6 지원을 위한 DNS 변경

### AAAA 레코드 도입
IPv6의 등장으로 새로운 레코드 타입이 필요하게 되었습니다:

**AAAA 레코드 특징:**
- "쿼드 A"라고 발음
- 128비트 IPv6 주소 저장
- 기존 A 레코드와 유사한 형식

**실제 사용 예:**
```
google.com.    IN  AAAA  2001:4860:4802:38::a
google.com.    IN  AAAA  2001:4860:4802:32::a
```

### IPv6 전환을 위한 DNS 전략

**이중 스택 지원:**
```
동일 도메인에 A와 AAAA 레코드 모두 제공
클라이언트가 프로토콜에 따라 적절한 레코드 선택
```

**IPv6 우선 정책:**
- Happy Eyeballs 알고리즘
- 클라이언트가 A와 AAAA 모두 쿼리
- 빠른 응답 프로토콜 선택

### EDNS0을 통한 확장
RFC 6891에 정의된 EDNS0(Extension Mechanisms for DNS)은 DNS 프로토콜의 제한을 확장합니다:

**주요 개선점:**
1. **더 큰 메시지 크기**: UDP에서 512바이트 이상 지원
2. **DNSSEC 지원**: 옵션 플래그 추가
3. **클라이언트 서브넷**: CDN 최적화

**OPT 레코드 형식:**
```
도메인: . (루트, 항상 0)
타입: OPT (41)
클래스: 요청자 UDP 페이로드 크기
TTL: 확장 RCODE 및 플래그
RDATA: 옵션 목록
```

### DNS64와 NAT64
IPv6 전용 네트워크에서 IPv4 리소스 접근을 위한 기술:

**DNS64 작동:**
```
1. 클라이언트: example.com AAAA 쿼리
2. DNS64 서버: example.com A 쿼리 (IPv4)
3. 수신: 192.0.2.1 (IPv4 주소)
4. 변환: 64:ff9b::192.0.2.1 (IPv6로 매핑)
5. 응답: AAAA 레코드로 변환된 주소
```

### DNSSEC와 IPv6
**DNSSEC 개선점:**
- 데이터 무결성 보장
- DNS 스푸핑 방지
- IPv6 주소의 신뢰성 확보

**새로운 레코드 타입:**
- RRSIG (타입 46): 서명된 RRset
- DNSKEY (타입 48): 공개 키
- DS (타입 43): 위임 서명자
- NSEC/NSEC3 (타입 47/50): 부정적 응답 인증

---

## 결론

DNS 메시징 시스템은 단순함과 효율성의 균형을 이루는 설계의 걸작으로, 수십 년간 인터넷의 핵심 인프라로 기능하면서도 지속적으로 진화해 왔습니다. 그 메시지 형식은 1987년 RFC 1035에 처음 정의된 이후 근본적인 구조를 유지하면서도, EDNS0, DNSSEC, IPv6 지원 등의 확장을 통해 현대적 요구사항을 충족시켜 왔습니다.

DNS의 가장 뛰어난 특징 중 하나는 **메시지 압축 기술**입니다. 이는 단순히 트래픽을 줄이는 기술적 기교를 넘어, 프로토콜 설계자들이 제한된 자원(초기 512바이트 UDP 제한) 내에서 최대의 효율성을 추구한 창의적인 해결책입니다. 압축 포인터 메커니즘은 데이터 중복성을 우아하게 제거하면서도 구현 복잡성을 최소화한 모범 사례입니다.

마스터 파일 형식은 또 다른 설계적 우아함을 보여줍니다. 인간이 읽고 편집하기 쉬운 텍스트 기반 형식이면서도, 파서가 효율적으로 처리할 수 있는 구조를 갖추고 있습니다. $ORIGIN, $TTL 같은 지시어들은 구성의 유연성과 재사용성을 높이며, SOA 레코드의 세부 필드들은 분산 데이터베이스의 일관성 유지라는 복잡한 문제를 단순한 매개변수들로 해결합니다.

IPv6 지원을 위한 DNS의 진화는 이 프로토콜이 어떻게 새로운 기술 동향에 적응하는지를 보여줍니다. AAAA 레코드의 도입은 단순한 새로운 레코드 타입 추가를 넘어, 이중 스택 전환, DNS64/NAT64, DNSSEC 통합 등 포괄적인 생태계 변화를 수용했습니다. 이는 DNS가 단독으로 존재하는 시스템이 아니라, 더 큰 인터넷 인프라의 일부로 기능하며 상호의존적으로 발전한다는 사실을 잘 보여줍니다.

오늘날 DNS 메시징은 클라우드, 마이크로서비스, 글로벌 로드 밸런싱, 보안 강화 등 현대 인터넷의 모든 측면에서 핵심적인 역할을 합니다. DNS-over-HTTPS(DoH)와 DNS-over-TLS(DoT) 같은 새로운 발전은 프라이버시와 보안 측면에서의 지속적 진화를 보여주며, 이는 프로토콜이 사회적 요구사항에도 적응할 수 있음을 입증합니다.

DNS 메시징 시스템을 이해하는 것은 단순한 네트워크 프로토콜 지식을 넘어, 확장 가능한 분산 시스템 설계의 근본 원리를 이해하는 것입니다. 이는 현대 소프트웨어 아키텍트와 엔지니어에게 귀중한 통찰력을 제공하며, 글로벌 규모의 시스템이 어떻게 효율적이고 견고하게 운영될 수 있는지에 대한 교훈을 담고 있습니다.