---
layout: post
title: 정보보안기사 - ARP/RARP 프로토콜
date: 2025-11-06 21:25:23 +0900
category: 정보보안기사
---
# SECTION 04 네트워크 기본 학습 — 03. ARP/RARP 프로토콜

## 1. 왜 ARP를 이해해야 하는가

- **ARP = L3(IP) ↔ L2(MAC) 해석자**. 동일 브로드캐스트 도메인에서만 동작, L3 장비(게이트웨이)가 L2 세그먼트 경계를 분리한다.
- **현실 영향**: 연결 지연(ARP 미해결), 대역폭 낭비(폭주), **중간자 공격(MITM)**, **IP 충돌·Failover**(GARP), 이중화(가상 IP), 멀티홈(ARP flux) 등.
- **시험·실무 포인트**: 프레임/필드·브로드캐스트 범위·캐시 상태·GARP/Proxy/InARP 정의·취약점과 방어(DAI/ISG/Port Security)·운영 명령·로그 필터.

---

## 2. ARP 개요와 동작 흐름

### 2.1 기본 개념
- 목적: **IP 주소 → MAC 주소** 매핑을 질의/응답으로 획득해 프레임을 송신.
- 범위: **같은 L2 브로드캐스트 도메인**(같은 VLAN) 내에서만 유효.
- 전송: **ARP 요청**은 브로드캐스트(FF:FF:FF:FF:FF:FF), **ARP 응답**은 보통 유니캐스트.

### 2.2 처리 흐름(호스트 A가 게이트웨이를 통해 외부로 송신)
1) A는 대상 IP가 같은 서브넷인지 판단(마스크 기준).
2) 외부면 **게이트웨이 IP**를 L3 다음 홉으로 선택.
3) ARP 캐시에 게이트웨이 IP→MAC가 없으면 **ARP 요청** 브로드캐스트.
4) 게이트웨이가 **ARP 응답**으로 자신의 MAC을 회신.
5) A는 캐시에 저장 후 L2 프레임(DST=게이트웨이 MAC)으로 송신.

---

## 3. ARP 프레임/헤더 구조 (이더넷/IPv4)

### 3.1 이더넷+ARP 프레임 개요
| 구간 | 필드 | 값/길이(바이트) | 비고 |
|---|---|---:|---|
| Ethernet | Destination MAC | 6 | 보통 FF:FF:FF:FF:FF:FF(요청) / 유니캐스트(응답) |
|  | Source MAC | 6 | 송신자 MAC |
|  | EtherType | 2 | **0x0806** (ARP) |
| ARP | Hardware Type (HTYPE) | 2 | **1** = Ethernet |
|  | Protocol Type (PTYPE) | 2 | **0x0800** = IPv4 |
|  | Hardware Size (HLEN) | 1 | **6** (MAC 길이) |
|  | Protocol Size (PLEN) | 1 | **4** (IPv4 길이) |
|  | Opcode | 2 | **1**=Request, **2**=Reply, **3/4**=RARP Req/Rep, **8/9**=InARP Req/Rep |
|  | Sender MAC (SHA) | 6 | 송신자 MAC |
|  | Sender IP (SPA) | 4 | 송신자 IP |
|  | Target MAC (THA) | 6 | 대상 MAC(요청 시 00:00:00:00:00:00) |
|  | Target IP (TPA) | 4 | 질의 대상 IP |

> **요점**: ARP는 L2 프레임 안에 실리는 **L2.5 제어 메시지**이며, IP/포트 개념이 없다.

### 3.2 Wireshark 디스플레이 필터
```
arp
arp.opcode == 1     # Request
arp.opcode == 2     # Reply
arp.src.proto_ipv4 == 192.168.10.10
arp.dst.proto_ipv4 == 192.168.10.1
```

---

## 4. ARP 캐시(Neighbor Table)와 상태

### 4.1 캐시 구조/표시
- 키: IP, 값: MAC, 메타: 인터페이스, 상태, 타이머.
- 리눅스: `ip neigh show` / 윈도우: `arp -a`, `Get-NetNeighbor`.

```bash
# Linux
ip neigh show
# 예: 192.168.10.1 dev eth0 lladdr 00:11:22:33:44:55 REACHABLE
```

```powershell
# Windows
arp -a
Get-NetNeighbor -AddressFamily IPv4
```

### 4.2 리눅스 Neighbor 상태(요지)
- **INCOMPLETE**: 요청 보냈으나 응답 대기
- **REACHABLE**: 정상 통신(일정 시간)
- **STALE**: 오래됨(다음 전송 때 확인)
- **DELAY → PROBE**: 확인 프로빙
- **FAILED**: 해석 실패
- **PERMANENT/NOARP**: 정적 항목/ARP 불필요

```bash
# 정적(영구) 매핑 추가/삭제
sudo ip neigh add 192.168.10.1 lladdr 00:11:22:33:44:55 dev eth0 nud permanent
sudo ip neigh del 192.168.10.1 dev eth0
```

```powershell
# Windows 정적 이웃(인터페이스 인덱스 필요)
Get-NetIPInterface | ft ifIndex,InterfaceAlias
netsh interface ipv4 add neighbors <ifIndex> 192.168.10.1 00-11-22-33-44-55
netsh interface ipv4 delete neighbors <ifIndex> 192.168.10.1
```

> **주의**: 정적 매핑은 관리 부담/변경 실패 위험. 운영망에서는 **DAI/ISG** 등 L2 장비 기반 방어 우선.

---

## 5. GARP/Proxy ARP/InARP — 파생 동작

### 5.1 GARP(Gratuitous ARP)
- **정의**: **자기 자신의 IP**에 대해 **자발적으로** ARP “요청(혹은 응답)”을 브로드캐스트.
- **용도**:
  - IP 충돌 감지(응답이 오면 충돌)
  - 이중화/장애조치 시 **ARP 캐시 갱신**(가상 IP 이동)
  - NIC 교체/맥 변경 후 주변 테이블 재학습

**패킷 특징**: `SPA = TPA = 자기 IP`, `THA=00:..:00`, 브로드캐스트.

### 5.2 Proxy ARP
- **정의**: 라우터/호스트가 **타 네트워크 대상의 ARP 질의**에 **자신의 MAC**으로 응답하여 **대리 전송**.
- **장점/단점**: 라우팅 재구성 없이 접속 가능(레거시) vs 브로드캐스트 도메인 혼탁/보안 복잡성.
- **권장**: 현대 환경에서는 **세그멘테이션/정상 라우팅** 사용, Proxy ARP는 최소화.

### 5.3 InARP(Inverse ARP)
- **정의**: **L2 식별자(DLCI/VC 등)**만 알고 있을 때 상위 **IP 주소를 질의**(RFC 2390, opcode 8/9).
- **주 사용처**: 과거 Frame Relay/ATM/PPP. 오늘날 일반 이더넷 환경에서는 드뭄.

---

## 6. RARP(역 ARP) — 역사적 맥락

- **목적**: “**MAC → IP**” 매핑 확보(디스크 없는 워크스테이션이 부트 시 IP를 받는 용도).
- **한계**: 서버 쪽 정적 테이블 필요, 부가 정보 부족.
- **현황**: **BOOTP → DHCP**로 대체(현대 네트워크에서 **RARP는 사용 안 함**).

---

## 7. ARP 관련 성능/트래픽 개념 메모

### 7.1 브로드캐스트 도메인 ARP 오버헤드 추정
브로드캐스트 도메인 내 호스트 수 \(N\), 호스트당 초당 평균 ARP 요청 \(r\), ARP 평균 길이 \(S\) 바이트(이더넷 오버헤드 포함).

$$
\text{ARP 트래픽(바이트/초)} \approx N \cdot r \cdot S
$$

> 암기 포인트: **N이 커질수록 ARP 브로드캐스트 폭증**. 대규모 L2 평면은 세그멘테이션/라우팅이 필수.

### 7.2 ARP Aging과 재해석
- Aging/Probe 주기 등은 **OS별 상이**. 과도하게 짧으면 트래픽 증가, 과도하게 길면 IP 변경 반영이 느림.

---

## 8. 보안 취약점과 위협 시나리오

### 8.1 ARP 스푸핑/포이즈닝(중간자)
- **원리**: 공격자가 “게이트웨이 IP → 공격자 MAC” ARP 응답을 **속여서** 전파 → 피해자가 게이트웨이 대신 공격자에게 프레임 전달 → **스니핑/변조** 가능.
- **변형**: GARP/Unsolicited ARP Reply 남발, 양방향 포이즈닝, 스위치 학습 테이블 교란.

### 8.2 거부 서비스(ARP Storm)
- 루프/오류로 인해 ARP 브로드캐스트 폭주 → CPU/대역폭 소모, 연결 지연 급증.

### 8.3 ARP Flux(멀티홈)
- 멀티 NIC 호스트가 여러 IP에 대해 **예상치 못한 인터페이스 MAC**으로 응답 → 경로 예측 실패/보안 정책 혼란.

---

## 9. 방어 전략 — 계층별 통합

### 9.1 L2 스위치 기반(권장)
- **DHCP Snooping**: 스위치가 신뢰 포트에서만 DHCP Offer/Ack 허용, **IP–MAC–포트 바인딩**을 데이터베이스로 유지.
- **DAI(Dynamic ARP Inspection)**: 위 바인딩을 근거로 **ARP 요청/응답 검증**, 위변조 드롭.
- **IP Source Guard(ISG)**: 포트별 허용되는 **IP–MAC**만 L3 트래픽 허용.
- **Port Security**: 포트당 MAC 수/변경 제한(Sticky MAC), 위반 시 Restrict/Shutdown.
- **BPDU Guard/Root Guard**: L2 루프/루트 탈취 방지(ARP Storm 2차 피해 억제).

(예시 구성 — 문법은 벤더/모델별로 차이가 있음)
```
ip dhcp snooping
ip dhcp snooping vlan 10
ip arp inspection vlan 10
interface Gi1/0/1
  ip dhcp snooping trust        ! 업링크/서버측만 신뢰
interface Gi1/0/10
  ip arp inspection limit rate 30
  switchport port-security
  switchport port-security maximum 2
  switchport port-security violation restrict
```

### 9.2 호스트/서버 측(보조)
- **정적 Neighbor(선별)**: 게이트웨이 등 극히 제한된 대상에만, 변경 자동화 필수.
- **방화벽 레이트리밋**: 과도한 ARP(리눅스 bridge/nftables/ebtables).
- **모니터링**: `arpwatch`(리눅스), 스위치 로그/DAI 카운터, SIEM 경보.

### 9.3 네트워크 설계
- **세그멘테이션**: 브로드캐스트 도메인 축소(VLAN), 서버/사용자/관리/DMZ 분리.
- **게이트웨이 이중화**: VRRP/HSRP 등 사용 시 **GARP로 빠른 캐시 갱신**, 탐지규칙 튜닝.

---

## 10. 운영 명령/실습(안전한 범위)

> 모든 실습은 **폐쇄된 테스트 망**에서 수행한다. 제3자 네트워크에 영향을 주는 **공격성 행위**(위변조 ARP 송신 등)는 금지한다.

### 10.1 패킷 관측
```bash
# Linux: ARP 요청/응답만
sudo tcpdump -nni eth0 arp

# ARP 폭주 의심(초당 1000프레임 초과 관측)
sudo tcpdump -nni eth0 'arp' -Q in -w arp.pcap
```

### 10.2 ARP 응답 시간/도달성(arping)
```bash
# 대상 IP의 L2 응답 확인(같은 VLAN)
sudo arping -c 4 -I eth0 192.168.10.1
```

### 10.3 캐시 점검/정비
```bash
# Linux
ip neigh show dev eth0
sudo ip neigh flush dev eth0

# Windows
arp -a
arp -d *
# 또는
netsh interface ip delete arpcache
```

### 10.4 Windows PowerShell 가시화
```powershell
# 인터페이스별 이웃 상태
Get-NetNeighbor -AddressFamily IPv4 | Select ifIndex,IPAddress,LinkLayerAddress,State

# 중복 MAC 탐지(간단)
$nb = Get-NetNeighbor -AddressFamily IPv4 | Group-Object IPAddress
$nb | Where-Object { $_.Count -gt 1 } | ForEach-Object {
  [pscustomobject]@{
    IP = $_.Name
    MACs = ($_.Group | Select -Expand LinkLayerAddress) -join ','
  }
}
```

---

## 11. ARP 이상 징후 탐지 스크립트(샘플)

> **목적**: “**같은 IP에 여러 MAC**” 또는 “**짧은 시간 내 MAC 교체**”를 탐지해 경고.
> **주의**: 운영망 반영 전 테스트. 과도한 경보(이중화, 유지보수 등 정당 변경) 튜닝 필요.

```python
# arp_watch_like.py — 로컬 arp 테이블/캐시 출력 로그를 주기적으로 파싱해 이상 탐지(개념 예시)
# 실행 환경: 관리 PC에서 주기적으로 'arp -a' 또는 'ip neigh show'를 수집해 파일로 저장 후 분석

import re, time, pathlib, collections

LOG = pathlib.Path("arp_snapshot.txt")   # 외부 수집본(예: cron으로 1분마다 저장)
seen = {}  # IP -> (MAC, timestamp)

def parse(lines):
    items = []
    for ln in lines:
        # 윈도우 'arp -a' 간단 파서 (환경에 맞게 정규식 조정)
        m = re.search(r'(\d+\.\d+\.\d+\.\d+)\s+([\da-fA-F:-]{11,})', ln)
        if m:
            ip = m.group(1)
            mac = m.group(2).lower().replace('-',':')
            items.append((ip, mac))
    return items

def main():
    if not LOG.exists():
        print("no snapshot")
        return
    now = int(time.time())
    lines = LOG.read_text(encoding='utf-8', errors='ignore').splitlines()
    for ip, mac in parse(lines):
        last = seen.get(ip)
        if last and last[0] != mac:
            dt = now - last[1]
            if dt < 300:  # 5분 내 교체 경고
                print(f"[ALERT] {ip} MAC changed {last[0]} -> {mac} in {dt}s")
        seen[ip] = (mac, now)

if __name__ == "__main__":
    while True:
        main()
        time.sleep(60)
```

> 실제 운영은 **스위치 DAI 로그/카운터**, **SIEM 상관 분석**과 연동하는 편이 안정적이다.

---

## 12. 로그·포렌식 포인트

- **스위치**: DAI Drop 카운터/로그, DHCP Snooping DB 변화.
- **호스트**: `syslog`(Linux) — `kernel: neighbour: ARP ...`, Windows 이벤트(네트워크 어댑터 변경).
- **패킷**: 동일 IP에 대해 **서로 다른 SHA(송신자 MAC)**로 반복 **ARP Reply**가 오면 포이즈닝 의심.
- **Wireshark 지표**: “ARP Duplicate IP address detected”, “Gratuitous ARP for …” 메시지.

---

## 13. 운영 체크리스트 (현장용)

- [ ] **브로드캐스트 도메인 최소화**(VLAN 세그멘테이션).
- [ ] **DHCP Snooping**(신뢰 포트 지정) 활성 → **DAI**/ISG 사용.
- [ ] 서버/게이트웨이 포트에 **Port Security**(MAC 수/변경 제한).
- [ ] **Proxy ARP 비활성**(필요 시에만 제한적 사용).
- [ ] 게이트웨이 이중화(VRRP/HSRP) 시 **정상 GARP** 패턴 기준선 구축.
- [ ] **arpwatch/DAI 카운터/SIEM**으로 “같은 IP에 다른 MAC” 변화 경보.
- [ ] 운영 표준: **정적 ARP 최소화**, 필요 시 자동화 스크립트로 일괄 관리.
- [ ] 대규모 L2 도메인에서 **ARP 레이트리밋**(스위치 지원시) 검토.
- [ ] 변경관리: VLAN/포트/보안 정책 변경은 승인·로그·롤백 플랜 유지.

---

## 14. 자주 나오는 개념 정리(Q&A 스타일)

**Q1. ARP는 라우터를 통과하나?**
A. **아니오.** ARP는 **브로드캐스트 도메인 내부**에서만 동작. 라우터 인터페이스가 경계다.

**Q2. GARP와 ARP Reply 차이?**
A. GARP는 **자기 IP**를 브로드캐스트로 **알리는** 목적(요청 형태가 일반적), ARP Reply는 **질의에 대한 응답**으로 유니캐스트가 일반적.

**Q3. DHCP Snooping 없이 DAI가 가능한가?**
A. 장비에 따라 **정적 ARP ACL**로 제한적 가능하나, 일반적으로 **DHCP Snooping DB** 기반이 표준.

**Q4. ARP 스푸핑 방지에 정적 ARP를 쓰면 끝?**
A. 소규모/특수 환경을 제외하고 운영 비용/변경 실패 위험이 커서 **권장하지 않음**. 스위치 기반 방어가 우선.

---

## 15. 미니 랩(테스트 망)

### 랩 A — GARP 관측과 캐시 갱신 확인
1) 이중화 가상 IP를 가진 두 노드 중 Active를 전환.
2) **tcpdump/wireshark**로 GARP 패킷 수신 확인, 클라이언트 `ip neigh show`에서 MAC이 즉시 갱신되는지 확인.

```bash
sudo tcpdump -nni eth0 'arp and ether dst ff:ff:ff:ff:ff:ff'
ip neigh show | grep 192.168.10.100
```

### 랩 B — DAI Drop 동작 검증(스위치)
1) DHCP Snooping/DAI 활성 후 **정상 단말**은 통신 OK.
2) 임의 MAC으로 ARP Reply 변조 시도 → 스위치가 **Drop** 및 카운터 증가 확인.
3) 운영 포트에서 **신뢰 포트 설정 금지**가 잘 적용되어 있는지 점검.

---

## 16. 예상 문제(필기/실무)

1) **ARP 헤더**의 HTYPE/PTYPE/HLEN/PLEN/Opcode의 의미와 이더넷/IPv4에서의 값 조합을 서술하라.
2) **GARP/Proxy ARP/InARP** 각각의 정의와 사용 사례를 1줄씩 요약하라.
3) **ARP 스푸핑**의 원리와 이를 **L2 장비**에서 근본적으로 차단하는 메커니즘 2가지를 쓰라.
4) 대규모 브로드캐스트 도메인에서 ARP 트래픽이 폭증하는 이유와 네트워크 설계 차원의 해결책을 쓰라.
5) **DHCP Snooping**과 **DAI**의 관계, **신뢰 포트** 개념을 설명하라.
6) “같은 IP에 대해 서로 다른 MAC이 짧은 시간에 반복”되는 현상에 대한 **합법적 원인**과 **악성 가능성**을 하나씩 제시하라.

---

## 17. 결론

- ARP는 **단순하지만 치명적인(L2 브로드캐스트 기반)** 제어 프로토콜이다.
- 시험과 실무에서 핵심은 **프레임 구조/브로드캐스트 범위/캐시 상태**를 정확히 이해하고, **DAI·DHCP Snooping·ISG·Port Security**로 **위변조를 장비 레벨에서 차단**하는 것.
- 운영은 **가시성**(tcpdump/wireshark/DAI 카운터/arpwatch/SIEM)과 **변경관리**(세그멘테이션·게이트웨이 이중화·정책 표준화)가 승패를 좌우한다.
