---
layout: post
title: 정보보안기사 - DRDoS
date: 2025-11-09 22:25:23 +0900
category: 정보보안기사
---
# SECTION 04 네트워크 기본 학습 — 14. DRDoS (Distributed Reflection DoS)

## 개요 — DRDoS란?

- **정의**: 공격자가 **소스 주소를 표적의 IP로 위조(spoofing)**한 요청을 **제3의 리플렉터(reflector)**(DNS/NTP/SSDP/CLDAP/… 서버)에 전송 → 리플렉터가 **응답을 표적에게 되돌려** 표적의 **대역폭/큐/상태**를 고갈시키는 **분산 반사** 서비스 거부 공격.
- **핵심 특징**
  1) **익명성/분산성**: 리플렉터가 **대신 응답**하므로 원 공격자 추적이 어려움.
  2) **증폭 가능**: 일부 UDP 기반 서비스는 **요청≪응답**(증폭 계수 ↑).
  3) **방어 난이도**: 정당한 서버가 보내는 **합법 형태의 대량 응답** → 단순 ACL로는 오탐/오차 위험.

### 공격 흐름(개념도)

```
[공격자(소스 스푸핑)] --(작은 요청)--> [리플렉터/증폭원 수천대]
                                       \--(큰 응답, 분산)--> [표적(Victim)]
```

---

## 수학적 모델 — 증폭/부하 근사

- **증폭 계수(Amplification Factor)**
  $$ A_f = \frac{\text{응답 크기(바이트)}}{\text{요청 크기(바이트)}}. $$

- **표적 유입 대역폭 근사**
  리플렉터 수 \(R\), 리플렉터 1대당 요청률 \(q\) (req/s), 요청 평균 크기 \(S_r\), 응답 평균 크기 \(S_s\)라면
  $$
  \text{Victim\_bps} \approx R \cdot q \cdot S_s = R \cdot q \cdot A_f \cdot S_r.
  $$
  동일한 \(R, q, S_r\)에서 \(A_f\)가 클수록 동일 자원으로 **훨씬 큰 유입량** 유도.

- **유입 PPS(패킷/초)**
  응답 평균 패킷 크기를 \(M\) 바이트(레이어2/3 오버헤드 포함)로 잡으면
  $$
  \text{Victim\_pps} \approx \frac{R \cdot q \cdot S_s}{M}.
  $$

> 직관: **증폭 계수**가 큰 프로토콜(예: DNS 확대 응답, 메모리 캐시 덤프형)은 적은 요청만으로도 표적의 **링크/장비 큐/커널**을 빠르게 포화시킨다.

---

## 주요 리플렉터/증폭원 — 서비스별 특성·지표·완화

> **목표는 방어**다. “어떻게 악용되는가”는 **방어 포인트 이해** 수준에서만 설명한다.

| 서비스 | 포트/프로토콜 | 증폭 특성(개념) | 대표 오개방 시나리오 | 주 방어책(운영자 관점) |
|---|---|---|---|---|
| **DNS** | 53/UDP | EDNS0·DNSSEC로 응답 확대 → \(A_f\)↑ | 오픈 리졸버, 권한 서버 RRL 미적용 | **RRL**, **DNS Cookies**, 오픈 리졸버 제거, 권한 서버 ACL/뷰 |
| **NTP** | 123/UDP | (구버전) 모니터링/통계 응답 | `monlist`/mode6/7 쿼리 허용 | **monitor 비활성화**, `noquery`/ACL, 최신 NTP/chrony |
| **SSDP/UPnP** | 1900/UDP | 다수 기기의 M-SEARCH 응답 | 가정용/IoT UPnP 외부 노출 | CPE에서 **UPnP 비활성** 또는 WAN 차단 |
| **CLDAP** | 389/UDP | 큰 AD 응답 | AD/도메인 서비스의 UDP 노출 | **UDP 389 차단**, LDAP/TCP로 전환, DC ACL |
| **Memcached(구성)** | 11211/UDP | 캐시 덤프형 대형 응답 | UDP 활성화·외부 바인딩 | **UDP 비활성(-U 0)**, 루프백 바인딩 |
| **WS-Discovery/mDNS** | 3702/UDP, 5353/UDP | 멀티캐스트 응답 | L3 경계 넘는 잘못된 포워딩 | 경계에서 차단, 스코프 제한 |
| **Chargen/QOTD/Portmap** | 19/UDP, 17/UDP, 111/UDP | 에코/문자열 응답 | 레거시 서비스 노출 | 서비스 제거/차단 |

> **TCP 반사**(예: SYN-ACK reflection)도 존재하나, 오늘날 대규모 DRDoS는 **UDP 기반**이 실전에서 압도적이다(요청 위조·무연결).

---

## 탐지 — 패킷·플로우·앱 로그의 복합 신호

### 공통 징후

- **단일/소수 표적 IP**로 **한 방향 응답 트래픽** 급증(bps/pps).
- **dstPort 편향**(53/123/1900/389/11211 …), **srcIP 다양성↑(카디널리티↑)**.
- **요청/응답 바이트 비율**의 비정상(응답≫요청), **플로우 지속시간 짧음**, **단건 페이로드 비대형**.

### 플로우(NetFlow/IPFIX)로 빠른 진단

```bash
# 상위 dstport(표적 포트) 관측

nfdump -r flows.nfd -s dstport -n 20
# 표적 IP Top-N

nfdump -r flows.nfd -s dstip -n 10
# srcip 카디널리티(대략)

nfdump -r flows.nfd -s srcip -n 100000 | wc -l
# 요청/응답 바이트 비율(플랫폼별 집계 쿼리 작성 권장)

```

### 패킷 기반(IDS/IPS 룰; 개념 예시)

```bash
# Suricata — 표적 포트 급증(개념; 공인 룰셋 사용 권장)

alert udp any any -> $HOME_NET 53 (msg:"DNS reflection surge"; detection_filter:track by_dst, count 20000, seconds 1; sid:410001;)
alert udp any any -> $HOME_NET 123 (msg:"NTP reflection surge"; detection_filter:track by_dst, count 15000, seconds 1; sid:410002;)
alert udp any any -> $HOME_NET {1900,389,11211} (msg:"Common UDP reflector surge"; detection_filter:track by_dst, count 15000, seconds 1; sid:410003;)
```

### 통계 지표(엔트로피)로 보조 탐지

- **소스 IP 엔트로피**
  $$ H(S) = - \sum_{i} p(s_i)\log_2 p(s_i) $$
  DRDoS는 정상 대비 **소스 다양성(엔트로피)**가 급증하며, **dst포트/표적 IP**는 낮은 엔트로피를 보이는 경향.

```python
# entropy_watch.py — 오프라인 로그로 srcIP 엔트로피 계산(교육용)

import sys, math, collections
cnt=collections.Counter(l.strip().split()[0] for l in sys.stdin)  # 입력: "srcIP dstIP dstPort ..."
N=sum(cnt.values())
H=-sum((c/N)*math.log((c/N),2) for c in cnt.values())
print(f"srcIP entropy: {H:.2f} bits (N={N} events)")
```

---

## 완화 — 업스트림→경계→호스트→애플리케이션의 다층 방어

### 업스트림/라우팅

- **BCP38/uRPF**: 소스 스푸핑 차단(공급자/업스트림 협력 필수).
  - **Strict**: 패킷의 소스가 **들어온 인터페이스로 역방향 라우팅** 가능해야 허용.
  - **Loose**: **임의의 인터페이스**로 역방향 경로만 있으면 허용(대규모망 실무 대체).
- **RTBH**: 공격 시간대 **표적 프리픽스 블랙홀**로 급한 불 끄기(서비스 포기).
- **BGP Flowspec**: 5튜플·DSCP·플래그 기반 **정밀 차단**(운영사 정책 필요).
- **Anycast + 스크러빙 센터**: 글로벌 분산 후 스크러빙 → 정제 트래픽만 오리진으로.

### 경계 방화벽/L3 제어(예: nftables)

```bash
# nftables — UDP 증폭원 대표 포트 제한(환경별 값 조정)

nft add table inet filter
nft add chain inet filter input { type filter hook input priority 0; policy drop; }
nft add rule inet filter input ct state established,related accept
nft add rule inet filter input iif "lo" accept
# ICMP는 PMTUD 필요한 유형만 허용(과도 차단은 역효과)

nft add rule inet filter input icmp type { destination-unreachable, time-exceeded, echo-request, echo-reply } limit rate 200/second accept
# UDP 포트 레이트 제한

nft add rule inet filter input udp dport {53,123,1900,389,11211} limit rate 1000/second burst 5000 packets accept
nft add rule inet filter input udp dport {53,123,1900,389,11211} drop
```

### 서비스별 하드닝(운영자 필수 체크)

#### DNS (BIND 예: RRL, Cookies, 오픈 리졸버 금지)

```bind
options {
  recursion no;           // 권한 서버는 재귀 금지
  rate-limit {
    responses-per-second 10;
    window 5;
    slip 2;               // 일부 응답 지연/드롭로 증폭 억제
  };
  minimal-responses yes;  // 불필요 섹션 축소(응답 크기↓)
  dnssec-enable yes;
  cookies yes;            // DNS Cookies로 스푸핑/반사 억제
};
acl trusted-nets { 10.0.0.0/8; 192.168.0.0/16; };
view "internal" {
  match-clients { trusted-nets; };
  recursion yes;          // 내부 전용 리졸버
};
```

#### Unbound (리졸버 RRL/속도 제한)

```yaml
server:
  interface: 127.0.0.1
  access-control: 127.0.0.0/8 allow
  access-control: 10.0.0.0/8 allow
  do-ip6: no
  ip-ratelimit: 200
  ratelimit: 1000
  minimal-responses: yes
  harden-short-bufsize: yes
```

#### NTP (ntpd/chrony: 모니터링 비활성·ACL)

```conf
# ntpd 예시

restrict default kod notrap nomodify nopeer noquery
restrict -6 default kod notrap nomodify nopeer noquery
disable monitor   # 'monlist'류 차단
# chrony 예시

cmdport 0         # 관리 포트 비활성(원격 제어 금지)
allow 10.0.0.0/8  # 내부만 서비스
```

#### Memcached (UDP 비활성·루프백 바인딩)

```bash
# systemd 환경

ExecStart=/usr/bin/memcached -m 512 -p 11211 -U 0 -l 127.0.0.1
#           메모리  포트  UDPoff  루프백 바인딩

```

#### CLDAP/AD (UDP 389 비활성·엣지 차단·LDAP/TCP 전환)

- **엣지/방화벽**에서 UDP/389 차단, **도메인 내부**만 허용.
- 가능하면 LDAP **TCP**(389) + **보안(서명/채널 바인딩/LDAPS)** 사용.

#### SSDP/UPnP (CPE/서버 측)

- WAN → **UDP/1900 차단**, UPnP IGD **비활성**(가정/소형사 무선AP).
- 서버 OS에서 **SSDPDiscovery**/UPnP 서비스 중지.

### 호스트/커널 튜닝(반사 트래픽 흡수 내성)

```bash
# /etc/sysctl.d/60-ddos.conf (개념)

net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.core.somaxconn = 16384
net.ipv4.tcp_synack_retries = 3
net.ipv4.tcp_fin_timeout = 30
net.netfilter.nf_conntrack_max = 2097152
net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 30
```

### 애플리케이션 계층(프런트 리밋·챌린지·캐시)

```nginx
# Nginx — 토큰 버킷 기반 리밋

limit_req_zone $binary_remote_addr zone=reqip:10m rate=20r/s;
limit_conn_zone $binary_remote_addr zone=connip:10m;

server {
  listen 443 ssl http2;
  limit_req zone=reqip burst=40 nodelay;
  limit_conn connip 100;
  client_header_timeout 10;
  client_body_timeout 15;
  reset_timedout_connection on;

  location /search {            # 비싼 엔드포인트는 별도 강화
    limit_req zone=reqip burst=10;
    proxy_pass http://app;
  }
}
```

---

## 운영 런북 — 감지→분류→즉시 완화→근절→복구→사후

1) **감지**: bps/pps 급증, dstPort 편향, srcIP 카디널리티↑, 요청/응답 비율 비정상.
2) **분류**: DNS/NTP/SSDP/CLDAP/Memcached… **어떤 리플렉터 계통인지** 규명.
3) **즉시 완화**: 업스트림 **스크러빙/RTBH/Flowspec** 요청, 경계 **UDP 포트 레이트** 조정, WAF/리미터 강화, 중요 엔드포인트만 허용.
4) **근절(근본조치)**: 내부 오픈 리졸버/서비스 제거, DNS RRL·NTP 설정 교정, CPE 가이드(협력사/고객 통지).
5) **복구**: 캐시 워밍·큐/DB 정상화, 사용자 고지.
6) **사후**: 벡터/ASN/시간대/규모 문서화, 임계·룰 재조정, 분기별 **훈련**.

---

## 안전 실습(공격 생성 없이 “오프라인 분석·방어 검증”)

> 목적: **실제 전송 없이** DRDoS 유사 플로우를 담은 **PCAP 파일**을 생성(오프라인) → IDS/플로우/로그 파이프라인으로 **탐지 로직 검증**.
> 주의: 아래 코드는 **패킷을 네트워크에 송신하지 않음**(파일만 생성).

### DRDoS 유사 PCAP 생성(Scapy, 오프라인)

```python
# make_drdos_pcap.py — DRDoS-like 트래픽을 "파일로만" 합성(전송 없음)

from scapy.all import IP, UDP, DNS, DNSQR, DNSRR, wrpcap
import random, time

victim = "203.0.113.10"      # 예시(문서 전용 범위)
reflectors = [f"198.51.100.{i}" for i in range(10, 60)]  # 문서 전용 범위
pkts=[]

# 요청(작게) — 소스=Victim 으로 "위조된" 형태를 파일에만 기록

for r in reflectors:
    qname = random.choice(["example.com","large.example.org","bigzone.test."])
    req = IP(src=victim,dst=r)/UDP(sport=40000,dport=53)/DNS(id=random.randint(1,65535),qd=DNSQR(qname=qname,qtype="ANY"))
    pkts.append(req)

# 응답(크게) — 리플렉터가 Victim에게 보내는 큰 응답을 합성(EDNS0)

for r in reflectors:
    an = DNSRR(rrname="large.example.org", type="TXT", rdata="X"*900)  # 큰 페이로드
    resp = IP(src=r,dst=victim)/UDP(sport=53,dport=40000)/DNS(id=random.randint(1,65535), qr=1, aa=1, ancount=1, an=an)
    pkts.append(resp)

wrpcap("drdos_demo.pcap", pkts)
print("Wrote drdos_demo.pcap (offline synthesis)")
```

### 오프라인 탐지·특성 확인

```bash
# 패킷 요약

tshark -r drdos_demo.pcap -q -z conv,udp
# DNS 요약

tshark -r drdos_demo.pcap -Y "dns" -T fields -e ip.src -e ip.dst -e udp.dstport -e dns.flags.response | head
# IDS 룰 테스트(로컬 Suricata 오프라인 모드)

suricata -r drdos_demo.pcap -S /path/to/local.rules -l out/
```

### 플로우 수준 카디널리티/포트 편향 확인(개념)

```bash
tshark -r drdos_demo.pcap -T fields -e ip.src -e ip.dst -e udp.dstport \
 | awk '{print $1}' | sort | uniq | wc -l    # srcIP 다양성
tshark -r drdos_demo.pcap -T fields -e udp.dstport | sort | uniq -c | sort -nr | head
```

> 이 오프라인 합성/분석 과정을 통해 **탐지 룰·경보 임계**를 **실서비스에 영향 없이** 검증할 수 있다.

---

## 체크리스트 — 사전·실시간·사후

### 사전(Prevention)

- [ ] **BCP38/uRPF** 적용(업스트림 협력 포함)
- [ ] **오픈 리졸버/SSDP/CLDAP/Memcached-UDP** 등 **증폭원 제거**
- [ ] **DNS RRL/DNS Cookies**, NTP `disable monitor`/`noquery`
- [ ] **CDN/WAF/스크러빙** 계약·플레이북 확정
- [ ] **Rate/Conn Limit**(Nginx/HAProxy), 앱 타임아웃·큐 한계
- [ ] **모니터링**: bps/pps/cps, srcIP 엔트로피, dstPort 분포, 요청/응답 바이트 비율 경보

### 실시간(Response)

- [ ] **플로우 지표 스냅샷**(Top dstIP/dstPort, srcIP 카디널리티)
- [ ] 업스트림 **RTBH/Flowspec** 요청, 특정 UDP 포트 임시 차단/폴리싱
- [ ] WAF/리밋·챌린지 상향, 중요 엔드포인트만 허용
- [ ] 오탐/부작용 모니터(정상 사용자 영향 최소화)

### 사후(Post)

- [ ] **타임라인**(시작/피크/벡터 전환/종료), 벡터·ASN·규모 문서화
- [ ] **임계/룰 재조정**, 캐패시티·아키텍처 보강 계획
- [ ] 협력사·고객 공지/가이드(UPnP/NAS·CPE 설정) 배포
- [ ] **분기 훈련**(오프라인 PCAP·재현 시나리오로 탐지 검증)

---

## 부록 A — 구성 스니펫(선택 적용)

### BIND: 오픈 리졸버 금지 + RRL

```bind
options {
  recursion no; minimal-responses yes; dnssec-enable yes; cookies yes;
  rate-limit { responses-per-second 10; window 5; slip 2; };
};
```

### Unbound: 내부 전용 리졸버 + RRL

```yaml
server:
  interface: 127.0.0.1
  access-control: 127.0.0.0/8 allow
  ip-ratelimit: 200
  ratelimit: 1000
  minimal-responses: yes
```

### ntpd/chrony: 모니터링 차단·ACL

```conf
restrict default kod notrap nomodify nopeer noquery
disable monitor
# chrony: cmdport 0, allow 내부망

```

### Memcached: UDP 비활성

```bash
ExecStart=/usr/bin/memcached -m 512 -p 11211 -U 0 -l 127.0.0.1
```

### Windows Defender 방화벽: UDP 1900/389 차단(엣지)

```powershell
New-NetFirewallRule -DisplayName "Block-SSDP" -Direction Inbound -LocalPort 1900 -Protocol UDP -Action Block
New-NetFirewallRule -DisplayName "Block-CLDAP" -Direction Inbound -LocalPort 389  -Protocol UDP -Action Block
```

### Cisco IOS: uRPF(Strict, 필요한 경우 ACL 예외)

```cisco
interface GigabitEthernet0/0
 ip verify unicast source reachable-via rx
 ip verify unicast source reachable-via rx allow-default
# 주의: 비대칭 라우팅 환경은 Loose/Feasible 검토

```

### BGP RTBH/Flowspec(개념 스켈레톤)

```cisco
route-map RTBH permit 10
 set ip next-hop 192.0.2.1              ! 블랙홀 NH (업스트림 합의)
!
ip route 203.0.113.10 255.255.255.255 Null0 tag 666
! Flowspec은 사업자/플랫폼별 문법 상이 → 운영사 가이드 준수
```

---

## 부록 B — 대시보드/경보(개념)

```yaml
# Prometheus Alert: UDP dstPort 편향 + bps 급증(개념)

- alert: DRDoS_UDP_Suspected
  expr: (sum(rate(node_network_receive_bytes_total[1m])) by (instance) > 1e9)
        and on(instance)
        (sum(rate(app_udp_to_dstport_bytes{dstport=~"53|123|1900|389|11211"}[1m])) by (instance) / ignoring(instance) sum(rate(node_network_receive_bytes_total[1m])) by (instance) > 0.5)
  for: 1m
  labels: {severity: critical}
  annotations:
    summary: "Likely DRDoS UDP surge to reflector ports"
```

---

## 예상문제(실무/필답)

1) **DRDoS의 3요소**(소스 스푸핑·리플렉터·증폭)를 기술하고, 각 요소를 **방어자가 줄이는 방법**을 서술하라.
2) **DNS RRL**과 **DNS Cookies**가 DRDoS 억제에 기여하는 방식의 차이를 설명하라.
3) **CLDAP/Memcached/SSDP** 각각에 대한 **운영자 하드닝 체크 항목**을 2가지 이상 쓰라.
4) **소스 IP 엔트로피**/dstPort 편향/요청:응답 바이트 비율을 이용한 **탐지 로직**을 설명하라.
5) **uRPF(Strict/Loose)**, **RTBH**, **Flowspec**, **Anycast+스크러빙**의 **장단점**과 적용 시나리오를 비교하라.

---

## 결론

- DRDoS는 “**합법 서버의 대량 응답**을 악용”한다. 따라서 **오픈/오구성 서비스 제거**와 **업스트림 수준의 스푸핑 억제(BCP38)**가 **근본 해법**이다.
- 실전에서는 **업스트림(스크러빙/라우팅)** → **경계(L3/4 제어)** → **프런트(L7 리밋·챌린지·캐시)** → **오리진(설계/용량)**의 다층 체계가 필요하다.
- **오프라인 합성 PCAP**과 **정량 지표(엔트로피/비율/카디널리티)** 기반의 경보 튜닝으로, **서비스 영향 없이** 탐지/대응 체계를 꾸준히 검증하라.
