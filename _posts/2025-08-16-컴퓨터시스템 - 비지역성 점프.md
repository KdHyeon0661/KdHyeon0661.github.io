---
layout: post
title: 컴퓨터시스템 - 비지역성 점프
date: 2025-08-16 18:20:23 +0900
category: 컴퓨터시스템
---
# 비지역성 점프 (Nonlocal Jump)

## 1. 개요
비지역성 점프(Nonlocal Jump)는 **프로그램의 현재 실행 흐름을 특정 함수의 호출 관계를 건너뛰고 다른 지점으로 바로 이동하는 기능**을 말합니다.  
C 언어에서는 `setjmp()`와 `longjmp()` 함수가 대표적인 구현이며, 예외 처리, 에러 복구, 특정 조건에서 빠른 종료 등의 목적으로 사용됩니다.

---

## 2. 동작 원리
비지역성 점프는 크게 두 단계로 작동합니다.

1. **점프 지점 저장 (setjmp)**  
   - 현재 함수 호출 스택의 상태(레지스터, 스택 포인터, 프로그램 카운터 등)를 `jmp_buf` 구조체에 저장합니다.
   - 이후 `longjmp()`가 호출되면 이 저장된 상태로 복원되어 프로그램이 마치 `setjmp()` 호출 직후로 돌아온 것처럼 실행됩니다.

2. **점프 실행 (longjmp)**  
   - 이전에 `setjmp()`로 저장한 실행 컨텍스트를 복원합니다.
   - 지정한 값이 `setjmp()`의 반환값이 되어 실행이 재개됩니다.

---

## 3. 함수 원형
```c
#include <setjmp.h>

int setjmp(jmp_buf env);
void longjmp(jmp_buf env, int val);
```
- **`setjmp()`**: 현재 실행 환경을 `env`에 저장. 직접 호출 시 `0`을 반환, `longjmp()`로 복원될 때는 `val` 값을 반환.
- **`longjmp()`**: `setjmp()`에 저장된 실행 환경으로 점프. 반환값 `val`이 0이면 자동으로 1로 변환.

---

## 4. 예제 코드
```c
#include <stdio.h>
#include <setjmp.h>

jmp_buf buf;

void func2() {
    printf("func2: longjmp 실행!\n");
    longjmp(buf, 42); // setjmp로 복귀
}

void func1() {
    printf("func1: func2 호출\n");
    func2();
    printf("func1: 이 코드는 실행되지 않음\n");
}

int main() {
    int ret = setjmp(buf);
    if (ret == 0) {
        printf("main: setjmp 최초 호출, func1 실행\n");
        func1();
    } else {
        printf("main: longjmp로 복귀, ret=%d\n", ret);
    }
    return 0;
}
```
**출력 예시**
```
main: setjmp 최초 호출, func1 실행
func1: func2 호출
func2: longjmp 실행!
main: longjmp로 복귀, ret=42
```

---

## 5. 사용 사례
- **에러 처리**: 깊은 함수 호출 중간에서 오류 발생 시 즉시 상위 레벨로 복귀.
- **파서/인터프리터**: 구문 분석 실패 시 안전한 위치로 복귀.
- **리소스 제한 시 종료**: 스택 오버플로우나 메모리 부족 감지 후 안전하게 복귀.

---

## 6. 장점과 단점
### 장점
- 복잡한 에러 처리 로직 단순화.
- 깊은 함수 호출을 여러 단계 거슬러 올라가는 데 유용.
- 성능상 오버헤드가 낮음(예외 처리 프레임워크보다 단순).

### 단점
- 프로그램 흐름을 이해하기 어렵게 만들 수 있음.
- 지역 변수 복구 문제: `longjmp()`로 복귀 시 **자동 변수의 값이 정의되지 않을 수 있음**(특히 최적화 시).
- 자원 정리 누락 가능성: 파일 핸들, 메모리 해제, 락 해제 등은 복귀 전에 반드시 처리 필요.

---

## 7. 주의사항
- `setjmp()`와 `longjmp()` 사이에서 **스택이 변경**되면 예측 불가 동작 발생 가능.
- C++에서는 생성자/소멸자가 호출되지 않으므로 예외 처리 대신 사용 비추천.
- POSIX에서는 `sigsetjmp()` / `siglongjmp()`를 제공해 시그널 마스크까지 저장/복원 가능.

---

## 8. 확장 예제: 시그널 처리와 함께 사용
```c
#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include <setjmp.h>

jmp_buf env;

void handler(int sig) {
    printf("시그널 %d 수신, longjmp로 복귀\n", sig);
    longjmp(env, 1);
}

int main() {
    signal(SIGFPE, handler); // 0으로 나눔 감지
    if (setjmp(env) == 0) {
        int x = 1, y = 0;
        printf("0으로 나눔 시도\n");
        printf("%d\n", x / y); // SIGFPE 발생
    } else {
        printf("에러 처리 후 안전하게 종료\n");
    }
    return 0;
}
```

---

## 9. 요약
- **비지역성 점프**는 프로그램 실행 흐름을 강제로 다른 위치로 이동시키는 기능.
- `setjmp()`로 현재 상태를 저장하고, `longjmp()`로 복귀.
- 에러 처리, 복잡한 제어 흐름 탈출에 유용하지만 자원 관리와 가독성 문제 주의.