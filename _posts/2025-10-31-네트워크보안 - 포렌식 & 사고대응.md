---
layout: post
title: 네트워크보안 - 포렌식 & 사고대응
date: 2025-10-31 14:25:23 +0900
category: 네트워크보안
---
# 19. 포렌식 & 사고대응(IR)

> 목표: **네트워크 포렌식 절차·증적 보존(Chain of Custody)**, **타임라인·킬체인/ATT&CK 매핑**,
> **커뮤니케이션·법적 이슈**를 실무 관점으로 정리하고, 마지막에 **PCAP 기반 TTP 역추적** 실습을 수행한다.
> 대상 독자: Blue/IR, SOC, Threat Hunting, DFIR 엔지니어.

---

## 19.1 네트워크 포렌식 절차·증적 보존

### 19.1.1 네트워크 포렌식이 다루는 것
- **데이터 소스**
  - **패킷(PCAP/PCAPNG)**: 풀 콘텐츠(선택적).
  - **세션/메타데이터**: Zeek/Suricata/NetFlow/IPFIX/sFlow, 프록시/WAF/방화벽 로그.
  - **아티팩트**: 파일 전송(HTTP/FTP/SMB), TLS JA3/JA4, DNS 질의/응답.
- **사고 유형**
  - 피싱 후 **C2 비콘/데이터 유출**, 내부 확산(L2/L3), 크리덴셜 탈취, DNS/HTTP 터널링, DDoS, MITM 등.
- **성과물**
  - **타임라인**(분 단위 이상), **TTP 매핑**(ATT&CK/킬체인), **근본 원인(RCA)**, **지표(IOA/IOC)**, **교정 조치**.

---

### 19.1.2 초기 대응(First 1–4 Hours)
1) **신고 접수 → 분류(Severity/SLA)**
   - 자산 중요도(티어), 영향 범위(사용자·시스템·데이터), 가용성/기밀성 영향.
2) **보존 명령(Hold)과 데이터 동결**
   - 스위치 SPAN/TAP 적용/유지, 프록시·FW·DNS 로그 보존 기간 확장,
   - 클라우드(Traffic Mirroring, Flow Logs) 활성.
3) **현장 변경 최소화**
   - 공격원 도주 방지를 위해 **즉시 차단이 필요한가** vs **관찰/추적** 중 택일(소유자 승인).
4) **Chain of Custody(증적 연쇄) 시작**
   - 수집자, 시간, 수단, 저장 매체, 해시 기록(수정 불가 원칙).

---

### 19.1.3 증거 수집 원칙(Forensically Sound)
- **무결성 보장**: 수집 전/후 **SHA-256** 해시 산출 및 보관.
- **재현성**: 수집 스크립트/버전/옵션을 기록(누가 어디서 무엇을 어떻게).
- **최소 권한·가변성 최소화**: 센서/미러 포트에서 **Read-only 캡처**, 운영 장비 설정 변경은 승인 절차 필요.
- **시각 동기화**: NTP, TZ 표준화(UTC 권장), 로그 간 **±1–2s** 정확도 확인.

**예: tcpdump 캡처(증적용)**
```bash
# 1. 캡처 경계 지정 (인터페이스/필터/스냅렌/회전)
sudo tcpdump -i eth1 -s 0 -B 4096 -w /evidence/capture_%Y%m%d_%H%M%S.pcap \
  'tcp or udp or icmp' -G 900 -W 8

# 2. 해시 계산 및 기록
for f in /evidence/capture_*.pcap; do
  sha256sum "$f" >> /evidence/hashes.sha256
done
```

**Chain of Custody 양식(요지)**
```
[증거ID] [설명] [수집자] [일시(UTC)] [장소/시스템] [도구/버전/옵션]
[저장매체] [해시(SHA-256)] [이관 대상/일시] [보관 위치] [봉인번호]
```

---

### 19.1.4 저장·이관·보호
- **저장 형식**: PCAP/PCAPNG, JSON Lines(NDJSON), CSV.
- **보안**: 암호화된 컨테이너(예: LUKS/Veracrypt), 접근 통제(RBAC), 봉인(Seal).
- **인덱싱**: 메타 DB(파일명, 시간 범위, 인터페이스, 필터, 해시, 사건ID).

---

### 19.1.5 캡처 전략(풀/타깃/샘플)
- **풀 패킷**: 공간/성능 부담 ↑, 포렌식 정밀도 최고. 중요 세그먼트/짧은 기간.
- **타깃 캡처**: 사고 자산/포트/프로세스 한정.
- **샘플링**: sFlow/NetFlow 1:N 샘플. 사후 상세 분석은 불가할 수 있음.

---

## 19.2 타임라인·킬체인 매핑

### 19.2.1 타임라인 구성 단계
1) **수집**: PCAP → Zeek/Suricata/`tshark`로 L7 메타 추출.
2) **정규화**: 공통 필드(ECS-like): `@timestamp`, `src/dst ip/port`, `proto`, `dns.url`, `http.uri`, `tls.sni`, `ja3`, `bytes`, `uid`.
3) **세션 결합**: 동일 연결/흐름 단위로 묶기(5-tuple + 시간).
4) **이벤트 분류**: `Initial Access`, `Execution`, `C2`, `Exfiltration` 등.
5) **가시화**: Gantt/스파크라인, pivot table.

**tshark로 L7 메타 CSV 추출(예)**
```bash
# HTTP
tshark -r evidence.pcap -Y http -T fields \
 -e frame.time_epoch -e ip.src -e ip.dst -e tcp.srcport -e tcp.dstport \
 -e http.request.method -e http.host -e http.request.uri -E header=y -E quote=d -E separator=, \
 > http.csv

# DNS
tshark -r evidence.pcap -Y dns -T fields \
 -e frame.time_epoch -e ip.src -e dns.qry.name -e dns.flags.rcode -e dns.a \
 -E header=y -E quote=d -E separator=, > dns.csv

# TLS ClientHello (JA3 필요 시 Zeek 권장)
tshark -r evidence.pcap -Y "ssl.handshake.type == 1" -T fields \
 -e frame.time_epoch -e ip.src -e ip.dst -e tls.handshake.extensions_server_name \
 > tls_ch.csv
```

---

### 19.2.2 킬체인/ATT&CK 매핑 로지ック
- **예시 규칙**
  - **피싱 클릭**: HTTP/S GET → 특정 `User-Agent` + 리다이렉션 체인 + 짧은 체류.
  - **실행/드롭**: 파일 다운로드(`Content-Type: application/octet-stream`) 후 SMB/WinRM 등 내부 이동.
  - **Command & Control**: 일정 주기 소량 요청(비콘), JA3 희귀, SNI 희귀, NXDOMAIN 다량.
  - **Exfiltration**: 지속적인 업로드/POST 대용량, 압축·암호화 헤더 패턴.

**매핑 테이블(요약)**
| 이벤트 | 예시 증거 | ATT&CK 전술/기술 |
|---|---|---|
| 메일 URL 클릭 | 프록시/WAF 클릭 로그 | T1566.002 Phishing: Link |
| 페이로드 다운로드 | HTTP GET `.exe`/`.dll` | T1105 Ingress Tool Transfer |
| C2 비콘 | JA3/희귀 SNI/고정 주기 | T1071.001 Web Protocols |
| 권한 탈취/이동 | SMB/WMI/WinRM 내부 통신 | TA0008 Lateral Movement |
| 데이터 유출 | 장시간 POST/PUT 업로드 | TA0010 Exfiltration |

---

### 19.2.3 파이썬으로 타임라인 자동 생성(PCAP → CSV)
```python
# timeline_build.py
import subprocess, csv, json, os, sys, tempfile, time
from datetime import datetime

PCAP = sys.argv[1] if len(sys.argv) > 1 else "evidence.pcap"
TMP = tempfile.mkdtemp(prefix="nf_")

def run(cmd, out):
    with open(out, "w", encoding="utf-8") as f:
        subprocess.check_call(cmd, stdout=f)

# 1. 추출
http_csv = os.path.join(TMP, "http.csv")
dns_csv  = os.path.join(TMP, "dns.csv")
tls_csv  = os.path.join(TMP, "tls.csv")

run(["tshark","-r",PCAP,"-Y","http","-T","fields",
     "-e","frame.time_epoch","-e","ip.src","-e","ip.dst","-e","tcp.srcport","-e","tcp.dstport",
     "-e","http.request.method","-e","http.host","-e","http.request.uri",
     "-E","header=y","-E","quote=d","-E","separator",","], http_csv)

run(["tshark","-r",PCAP,"-Y","dns","-T","fields",
     "-e","frame.time_epoch","-e","ip.src","-e","dns.qry.name","-e","dns.flags.rcode","-e","dns.a",
     "-E","header=y","-E","quote=d","-E","separator",","], dns_csv)

run(["tshark","-r",PCAP,"-Y","ssl.handshake.type == 1","-T","fields",
     "-e","frame.time_epoch","-e","ip.src","-e","ip.dst","-e","tls.handshake.extensions_server_name",
     "-E","header=y","-E","quote=d","-E","separator",","], tls_csv)

# 2. 타임라인 머지
rows = []
def add_rows(path, typ):
    with open(path, newline='', encoding="utf-8") as f:
        r = csv.DictReader(f)
        for row in r:
            ts = float(row.get('frame.time_epoch') or row.get('frame.time'))
            event = {"@timestamp": datetime.utcfromtimestamp(ts).isoformat()+"Z", "type": typ}
            event.update(row)
            rows.append(event)

add_rows(http_csv,"http")
add_rows(dns_csv,"dns")
add_rows(tls_csv,"tls_clienthello")

# 3. 정렬/저장
rows.sort(key=lambda x: x["@timestamp"])
out_csv = "timeline.csv"
with open(out_csv, "w", newline='', encoding="utf-8") as f:
    w = csv.DictWriter(f, fieldnames=sorted({k for r in rows for k in r}))
    w.writeheader(); w.writerows(rows)

print(f"[+] Timeline written: {out_csv} ({len(rows)} events)")
```

**사용**
```bash
python3 timeline_build.py evidence.pcap
# 결과: timeline.csv → 스프레드시트/시각화 도구로 로드
```

---

### 19.2.4 JA3/희귀 지문과 DNS DGA 힌트
- JA3/JA4는 **Zeek**로 추출이 가장 수월.
- **희귀도 계산**: 타임라인 윈도우 내 상위 빈도 외 나머지를 Rare로 태깅.

**간단 희귀도 마킹(파이썬)**
```python
# rare_mark.py
import csv, collections
src = "timeline.csv"; dst = "timeline_mark.csv"
ja3_count = collections.Counter(); sni_count = collections.Counter()
rows=[]
with open(src, newline='', encoding="utf-8") as f:
    r=csv.DictReader(f); rows=list(r)
for x in rows:
    if x.get("ja3"): ja3_count[x["ja3"]] += 1
    if x.get("tls.handshake.extensions_server_name"): sni_count[x["tls.handshake.extensions_server_name"]] += 1
for x in rows:
    x["rare_ja3"] = "1" if (x.get("ja3") and ja3_count[x["ja3"]] <= 2) else "0"
    x["rare_sni"] = "1" if (x.get("tls.handshake.extensions_server_name") and sni_count[x["tls.handshake.extensions_server_name"]] <= 2) else "0"
with open(dst,"w",newline='',encoding="utf-8") as f:
    w=csv.DictWriter(f, fieldnames=rows[0].keys()); w.writeheader(); w.writerows(rows)
print("[+] saved:", dst)
```

---

## 19.3 커뮤니케이션·법적 이슈

### 19.3.1 커뮤니케이션 원칙(내부/외부)
- **단일 창구(Single Point of Contact)**: IR 리드/대변인 지정.
- **사실과 의견 분리**: “확인됨/의심/미확정” 구분.
- **타임라인 중심 보고**: 언제 무엇이 일어났고, 대응은 무엇을 했는가.
- **민감 정보 보호**: PII/PHI/고객데이터 최소 공유(Need-to-know).
- **규정 준수**: 산업/지역 법규(개인정보 유출 통지 기한 등).

**내부 브리핑 템플릿(요지)**
```
[사고ID] [요약: 영향/심각도/현재상태]
[타임라인] T0(탐지) → T1(격리) → T2(근본 원인) → T3(교정 배포)
[영향 범위] 자산/계정/데이터/서비스
[지표] IOC/IOA (도메인/IP/JA3/해시)
[조치] 완료/진행/계획
[요청사항] 비즈니스 팀, IT 운영, 법무 등
```

**외부(고객/규제기관) 커뮤니케이션**
- 승인된 문안·FAQ, 법무 검토 후 공개.
- “현재까지 확인된 사실”과 “고객의 즉시 조치 가이드” 포함.

---

### 19.3.2 법적·윤리적 고려
- **Chain of Custody** 미준수 시 법적 효력 약화 가능.
- **사생활 보호**: 캡처 데이터 중 PII 마스킹/비식별화 정책.
- **계약/규정**: MSA/SLA, 침해 사고 통지의무, 데이터 주권(Region).
- **수사기관 협력**: 영장/요청 사항 검토, 필요한 범위 내 제공.

---

### 19.3.3 사후 분석 & RCA(근본 원인 분석)
- **기술적 원인**: 취약점, 미패치, 미인증, 정책 누락.
- **조직적 원인**: 인력/프로세스/교육/자산관리 미흡.
- **재발 방지**: 보안통제 강화, 탐지 룰 추가, 교육/훈련, 모의훈련(Tabletop/릴레이).

---

## 19.4 실습: PCAP 기반 TTP 역추적

> **시나리오**
> - 사내 단말 `10.0.2.15`에서 **피싱 사이트** 접속 후 **C2 의심 비콘** 발생, 일부 도메인 NXDOMAIN 급증.
> - 제공물: `evidence.pcap`(인터넷 경계 SPAN), **Zeek/Suricata 없음**(노터치 환경).
> - **목표**: PCAP만으로 **타임라인** 구성 → **킬체인/ATT&CK** 매핑 → **IOC/교정** 도출.

### 19.4.1 단계 1 — 빠른 스코프 파악
```bash
# 상위 통계
tshark -r evidence.pcap -q -z conv,ip > conv_ip.txt
tshark -r evidence.pcap -q -z http,stat > http_stat.txt
tshark -r evidence.pcap -q -z io,stat,1 > io_stat.txt

# 의심 스트림 찾아보기 (HTTP 요청 라인)
tshark -r evidence.pcap -Y "http.request" -T fields \
 -e frame.time -e ip.src -e http.host -e http.request.uri | head
```
**판단 포인트**
- 단말 `10.0.2.15`의 **외부 접속 도메인 목록**, 특정 시점 **리다이렉션 체인** 존재 여부.
- 이후 **짧은 간격의 주기적 요청**(C2) 등장 여부.

---

### 19.4.2 단계 2 — DNS/TLS/HTTP 타임라인 뽑기
```bash
# DNS
tshark -r evidence.pcap -Y dns -T fields \
 -e frame.time_epoch -e ip.src -e dns.qry.name -e dns.flags.rcode \
 > dns_timeline.csv

# HTTP
tshark -r evidence.pcap -Y http.request -T fields \
 -e frame.time_epoch -e ip.src -e http.host -e http.request.uri -e http.user_agent \
 > http_timeline.csv

# TLS SNI
tshark -r evidence.pcap -Y "ssl.handshake.type == 1" -T fields \
 -e frame.time_epoch -e ip.src -e ip.dst -e tls.handshake.extensions_server_name \
 > tls_sni.csv
```

**분석 힌트**
- **피싱 클릭 직후** 10분 내 **NXDOMAIN 다발** → DGA/오타 도메인 시도.
- **희귀 SNI** 또는 무의미한 서브도메인, 동일 길이/패턴 반복.
- HTTP **User-Agent**가 표준 브라우저와 다른 값(자동화/스크립트)인지 확인.

---

### 19.4.3 단계 3 — 파일 전송/수상한 페이로드
```bash
# 파일 추출(간단; 콘텐츠 타입/확장자 파악)
tshark -r evidence.pcap --export-objects http,./extracted_http
# 또는 Zeek files.log를 원하나, 이번 랩은 tshark로 제한

# 추출물 해시
for f in extracted_http/*; do sha256sum "$f"; done > files.sha256
```
- PE/Script 가능성 파일이면 **YARA**/AV 스캔, 샌드박스(격리 환경) 분석.
- 압축/암호 파일이면 **패스워드 힌트**(URI/파라미터/메일 텍스트) 탐색.

---

### 19.4.4 단계 4 — 비콘/주기 탐지(간단 통계)
```python
# beacon_check.py
import csv, collections
from datetime import datetime
import statistics as st

f="http_timeline.csv"
reqs=collections.defaultdict(list)
with open(f) as r:
    for ts,src,host,uri,ua in csv.reader(r, delimiter='\t'):
        t=float(ts); key=(src,host)
        reqs[key].append(t)
for k,arr in reqs.items():
    if len(arr)<8: continue
    arr.sort()
    gaps=[arr[i+1]-arr[i] for i in range(len(arr)-1)]
    if len(gaps)>3:
        try:
            cv=st.pstdev(gaps)/(st.mean(gaps)+1e-6)
            if cv<0.2 and 5 <= st.mean(gaps) <= 120:
                print("BEACON?",k,"mean_gap=",round(st.mean(gaps),2),"cv=",round(cv,2),"count=",len(arr))
        except Exception:
            pass
```
- 출력에 나타난 `(src, host)` 조합은 **C2 후보**.
- 동일 호스트로 **작은 페이로드 반복**이면 C2 가능성 상승.

---

### 19.4.5 단계 5 — 킬체인 매핑 & IOC 도출
- **Initial Access**: 프록시/HTTP 타임라인에서 `referrer`, 리다이렉션 체인 확인.
- **Execution/Drop**: 파일 추출/다운로드 이벤트, MIME/해시 기록.
- **C2**: Beacon 후보, SNI/도메인, JA3(없으면 SNI/UA 기반) 기록.
- **Exfiltration**: 장시간/대량 업로드(HTTP POST/PUT), chunked 전송 확인.

**IOC 목록(예시 템플릿)**
```
[Domains] suspicious-cdn.example, a1b2c3d4.xyz
[IPs] 203.0.113.50, 198.51.100.77
[URLs] https://suspicious-cdn.example/dl/setup.exe
[JA3] b2f34a... (희귀; 표준 리스트와 상이)
[File Hash] setup.exe SHA256=aa..ff
[User-Agent] "Go-http-client/1.1"
```

---

### 19.4.6 단계 6 — 교정/완화·탐지 룰 반영
- **차단**:
  - FW/프록시: 도메인/URL 차단, SNI 차단(가능 시), JA3 차단(프록시/IPS).
  - DNS RPZ 싱크홀.
- **탐지 룰**:
  - Suricata 룰(`http.user_agent`/`http.uri`/`tls.sni`),
  - Zeek NOTICE(비콘/희귀 SNI/JA3),
  - SIEM 상관(피싱 클릭 → NXDOMAIN/희귀 SNI 10분 내).
- **자산 측 조치**:
  - 감염 단말 네트워크 격리(EDR), 계정 비밀번호 재설정, 런치포인트 검사.

**Suricata 룰 예(요지)**
```suricata
alert http any any -> any any (msg:"C2-style URI /checkin"; http.uri; content:"/checkin"; nocase; sid:900001; rev:1;)
alert http any any -> any any (msg:"Non-browser UA likely bot"; http.user_agent; pcre:"/(Go-http-client|python-requests|curl)/i"; sid:900002; rev:1;)
alert tls any any -> any any (msg:"Suspicious SNI"; tls.sni; content:"a1b2c3d4.xyz"; nocase; sid:900003; rev:1;)
```

**Zeek 간단 Notice(희귀 SNI)**
```zeek
@load base/protocols/ssl
redef Notice::policy += {
  [$note=Notice::SSL::Invalid_Server_Cert, $priority=Notice::ACTION_LOG]
};
# 실제로는 희귀도 테이블 구축 후 특정 임계 이하시 NOTICE 발생 처리
```

---

### 19.4.7 리포트(최종 산출물) 구성
1) **요약(Executive Summary)**: 영향, 근본 원인, 조치, 재발 방지.
2) **타임라인**: T0~Tn 표/시각화.
3) **TTP 매핑**: ATT&CK 테이블.
4) **증거 목록**: PCAP/로그 파일, 해시, Chain of Custody.
5) **IOC/IOA**: 공유 가능한 형태(CSV/Sigma/Suricata/Zeek).
6) **권고사항**: 정책/탐지 보강, 교육/훈련 계획.

**ATT&CK 매핑 예(요약)**
| 전술 | 기술 | 증거 | 상태 |
|---|---|---|---|
| Initial Access | T1566.002 Link | 프록시 클릭 로그, Referrer | Confirmed |
| Execution | T1204.002 Mal Doc/Installer | setup.exe 다운로드 | Suspected |
| C2 | T1071.001 Web | Beacon 패턴, 희귀 SNI | Confirmed |
| Exfiltration | T1041 Exfil over C2 | 대용량 POST 없음 | Not Observed |

---

## 부록 A. 도구 요약 & 옵션 치트시트
- **tcpdump**: `-i`, `-s 0`, `-G sec`, `-w`, `-B`, BPF 필터.
- **tshark**: `-Y`(디스플레이 필터), `-T fields`, `-e field`, `-E` CSV/JSON 옵션, `--export-objects`.
- **Zeek**: `@load ja3`, `local.zeek`, `dns/http/ssl.log`.
- **Suricata**: `eve.json`(dns/http/tls/files/flow/alert), ET 룰.
- **hash**: `sha256sum` 전후 기록.
- **pcap 편집**: `editcap`(시간/패킷 추출), `mergecap`(병합).

---

## 부록 B. 자주 겪는 문제와 해결
| 문제 | 원인 | 해결 |
|---|---|---|
| 타임스탬프 불일치 | NTP 오차, TZ 혼용 | UTC 통일, 오프셋 교정 스크립트 |
| JA3 누락 | TLS 가시성 미활성 | Zeek ja3 로드, SNI 최소 확보 |
| 파일 추출 실패 | TLS 암호화 | 프록시/END 가시성, 서버 측 로그 교차 |
| 오탐 다발 | 일반적 UA/URI 룰 과격 | 화이트리스트/자산 태그 반영 |
| 대용량 PCAP 처리 지연 | IO/CPU 병목 | 시간 슬라이스, 필터링, 병렬 처리 |

---

## 부록 C. 테이블탑 & 모의훈련 아이디어
- **피싱→C2→내부 SMB 스캔**: 타임라인 합성, 룰 반영, 격리 승인/롤백 절차 점검.
- **DNS 터널링**: NXDOMAIN/엔트로피 탐지, RPZ 신속 반영, 사용자 커뮤니케이션 훈련.
- **데이터 유출 시나리오**: Proxy/WAF 업로드 감시, 알림→티켓→법무 통지 흐름.

---

## 요약
- 네트워크 포렌식의 핵심은 **무결성 있는 수집·보존**, **정규화된 타임라인**, **TTP 매핑**이다.
- PCAP만으로도 `tshark/Zeek`를 활용해 **피싱→C2→내부 확산/유출**의 흔적을 충분히 재구성할 수 있다.
- 결과는 **IOC/룰/플레이북**으로 즉시 **운영 체계**에 환류되어야 한다(탐지 강화·차단 자동화).
- 커뮤니케이션/법적 이슈는 **사실 중심·체계적 문서화·Chain of Custody**가 생명이다.
