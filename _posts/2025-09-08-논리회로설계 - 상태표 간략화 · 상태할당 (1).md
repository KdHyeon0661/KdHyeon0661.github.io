---
layout: post
title: 논리회로설계 - 상태표 간략화 · 상태할당 (1)
date: 2025-09-08 20:25:23 +0900
category: 논리회로설계
---
# 상태표 간략화 · 상태할당 — **중복상태 제거**, **등가상태(동치/구별 가능 상태)**, **함의(임플리케이션) 차트**

> 표기: 입력 \(x\), 출력 \(y\), 상태(벡터) \(q\), 다음상태 \(q^+\).  
> 모델: **클럭형 순서회로**(Mealy/Moore 모두). 수식은 필요시 Mealy/Moore를 구분해 명시합니다.

---

## 0) 준비: 용어와 큰 흐름

- **도달 가능 상태 제거(Reachability)**: 리셋 상태에서 시작해 입력을 바꿔가며 **안 가는 상태**를 삭제.  
- **등가상태(Equivalent states)**: 모든 입력열에 대해 **항상 동일한 출력열**을 내보내는 상태 쌍.  
  - **Moore**: 현재 상태의 출력이 같고, 입력별 다음상태들이 **재귀적으로 등가**.  
  - **Mealy**: 모든 입력에서 **출력이 즉시 동일**하고, 입력별 다음상태들이 **재귀적으로 등가**.  
- **상태 최소화** = (1) **도달성 정리** → (2) **등가 병합**.  
- **상태할당(State assignment)**: 최소화된 상태들을 **비트 코드**로 배정(이진/그레이/원-핫 등)해 **조합로직**이 작아지도록 하는 설계 단계.

---

## 1) 중복상태 제거(도달성 분석)

### 1.1 알고리즘
1. **초기 집합** \(R=\{\text{RESET}\}\).  
2. \(R\)에서 **한 단계 전이**로 갈 수 있는 상태들을 더함.  
3. 더 이상 늘지 않을 때까지 반복.  
4. 전체 상태집합 \(S\)에서 \(R\)에 없는 상태를 **삭제**.

### 1.2 주의
- Mealy/Moore 모두 동일.  
- 하드웨어 관점에서 **불법 상태**(리셋 미적용·SEU 등)로 들어갈 수도 있으므로, 삭제 전 **self-start 복귀** 경로를 설계/검토.

---

## 2) 등가상태 · 구별가능 상태

### 2.1 정의(재귀적)
- **Moore**: 상태 \(p,q\)가 등가 \((p\equiv q)\) iff  
  1) \(y(p)=y(q)\) 이고  
  2) \(\forall x\), \(\delta(p,x)\equiv \delta(q,x)\).
- **Mealy**: \(p\equiv q\) iff  
  1) \(\forall x\), \(\lambda(p,x)=\lambda(q,x)\) 이고  
  2) \(\forall x\), \(\delta(p,x)\equiv \delta(q,x)\).

> **구별가능(distinguishable)**: 위 조건을 **어기는** 경우. “구별시키는 입력열”이 존재.

### 2.2 실무 판정법(두 가지)
- **연쇄 분할(Partition refinement)** — Moore에 특히 효율적  
- **함의(임플리케이션) 차트(Implication chart)** — Mealy/Moore 모두에 적용 쉬움

---

## 3) 연쇄 분할(Partition refinement) — (Moore 중심)

### 3.1 절차
1) **출력값으로 1차 분할**: \(P_0=\{ \text{동일 출력 상태끼리} \}\).  
2) **입력별 다음상태의 블록**이 동일한 상태끼리 **세분화**: \(P_{k+1}=\text{refine}(P_k)\).  
3) 분할이 더 이상 바뀌지 않으면 **고정점** → 각 블록이 **등가 클래스**.

### 3.2 예(간단 Moore)
- 상태/출력: \(A,B,C: y=0,\; D: y=1\). 입력 \(x\in\{0,1\}\).  
- 전이:  
  \(A:0\to B,1\to C\),  
  \(B:0\to B,1\to D\),  
  \(C:0\to B,1\to C\),  
  \(D:0\to B,1\to D\).

- 1차 분할: \(\{A,B,C\}|\{D\}\)  
- 세분화:  
  - \(A\)와 \(C\): `0→B`, `1→C`로 **동일 패턴** → **같은 블록** 유지  
  - \(B\): `1→D`가 **다른 블록**으로 가므로 \(A,C\)와 분리  
- 결과: \(\{A,C\}|\{B\}|\{D\}\) → **\(A\equiv C\)**, 나머지는 단독.

---

## 4) 함의(임플리케이션) 차트 — **등가 판정 표준 도구**

> 사용 의의: 작은 예제는 손쉽고, Mealy에도 적용 가능.  
> 구성: 상태쌍 \((p,q)\)에 대해 **“이 쌍이 등가라면 \(\Rightarrow\) 다음상태 쌍들도 등가여야 한다”**는 **함의 관계**를 기록/전파.

### 4.1 표 구성(삼각표)
- 표의 셀 = **정렬된 상태쌍** \((p,q), p>q\).  
- 초기 표시는:
  - **Moore**: \(y(p)\ne y(q)\)면 **즉시 ×(구별)**.  
  - **Mealy**: **어느 입력**에서든 \(\lambda(p,x)\ne \lambda(q,x)\)면 **×**.
- 각 셀 \((p,q)\)에 대해 모든 입력 \(x\)에 대해  
  \[
  (p,q)\Rightarrow\big(\delta(p,x),\delta(q,x)\big)
  \]
  을 **함의 목록**에 기록. (쌍의 순서는 정렬)

### 4.2 표 해석(전파)
- 이미 ×로 표기된 셀을 **참조**하는 함의를 가진 셀은 **자기도 ×**(귀류).  
- 변동이 없을 때까지 반복.  
- 끝까지 ×가 아닌 셀 = **등가 가능** → 병합.

### 4.3 Worked Example (위 §3의 Moore 예)

#### (1) 초기 마크
쌍 목록: \((A,B),(A,C),(A,D),(B,C),(B,D),(C,D)\)  
- \(D\)의 출력이 1, 나머지 0 → \((A,D),(B,D),(C,D)\) **×**.

#### (2) 함의 기록
- \((A,B)\):  
  - \(x=0\): \((B,B)\) — trivial OK  
  - \(x=1\): \((C,D)\) — **이미 ×** → \((A,B)\) **×**
- \((B,C)\):  
  - \(x=0\): \((B,B)\)  
  - \(x=1\): \((D,C)\) = \((C,D)\) **×** → \((B,C)\) **×**
- \((A,C)\):  
  - \(x=0\): \((B,B)\)  
  - \(x=1\): \((C,C)\)  
  → **× 없음** → **등가**

#### (3) 결과
- 등가쌍: \((A,C)\) → **병합**: \(AC\).  
- 축약 상태집합: \(\{AC,B,D\}\).

### 4.4 Mealy에의 적용(차이점)
- **초기 마크 기준**: \( \exists x:\lambda(p,x)\ne \lambda(q,x)\Rightarrow \text{×} \).  
- 그 외 전파 로직은 동일.  
- 출력이 간선에 달렸으므로, **출력 같은지**를 **우선** 본다 → 많은 쌍이 초기에 ×로 걸러짐.

---

## 5) 비완전 명세(ISM) 확장 노트

- **호환(compatible)**: 정의된 입력에 대해 출력이 동일하고, 정의된 전이들이 **호환 쌍**으로 향함(미정 입력은 제약 X).  
- **호환/합병 그래프** 또는 **확장 함의 차트**로 **최대 호환집합**을 모아 **닫힌 커버(closed cover)**를 선택 → 최소화.  
- 병합 후 **미정 전이 채움**은 **self-start/락아웃 방지** 기준으로.

---

## 6) 상태할당(State Assignment) — **좋은 코드가 로직을 줄인다**

### 6.1 목표
- 다음상태/출력 로직의 **게이트 수·팬인·지연·해저드** 최소화.  
- **FF 타입/수**·플랫폼(FPGA/ASIC)을 고려:  
  - **원-핫**: 상태수 \(N\)개의 FF, 로직 단순/고속(FPGA 친화).  
  - **이진(BIN)**: \(\lceil\log_2 N\rceil\) FF, 면적↓(ASIC).  
  - **그레이(GRAY)**: 인접 전이 해밍거리 1 → 해저드/EMI↓.  
  - **Johnson/링**: 순환형 FSM에 적합.

### 6.2 휴프만(Huffman)·인접 그래프(Adjacency) 휴리스틱
1) **인접 그래프** 작성: **같은 입력**에서 전이되는 상태쌍, 또는 **빈번 전이**에 **가중치**.  
2) **하이퍼큐브 임베딩**: 이진 코드에서 **인접한 상태쌍**을 **해밍거리 1**로 배정(=K-맵 인접 칸에 배치).  
3) **출력 지향**: Moore면 출력 비트들을 **상태코드의 일부로 직접 할당**(출력 로직 제거).  
4) **제약식**:  
   - 자주 쓰이는 전이 \((p\to q)\) → \(\text{Hamming}(code(p),code(q))=1\) 선호.  
   - 서로 다른 출력(복수 비트)은 **비트 분리**로 반영.

### 6.3 절차(요약)
- 최소화된 FSM \(\Rightarrow\) **전이/출력 빈도** 파악 \(\Rightarrow\) **인접 그래프** \(\Rightarrow\)  
  **코드 후보 생성**(그레이/수작업/탐색) \(\Rightarrow\) **논리 합성 결과 비교**(팬인/지연/셀수) \(\Rightarrow\) 선택.

### 6.4 소형 예 — 위 축약 FSM \(\{AC,B,D\}\) 을 2비트로
- Moore 출력: \(y(AC)=0, y(B)=0, y(D)=1\) → **출력 비트를 MSB로**:  
  \(D\to 1\*\), \(AC,B\to 0\*\).  
- 인접(전이 다수): \(AC\leftrightarrow B\), \(B\leftrightarrow D\).  
- 배정: \(AC=00\), \(B=01\), \(D=10\) (그레이형).  
- 다음상태 대략:  
  \(AC:0\to B(01),1\to AC(00)\),  
  \(B:0\to AC(00),1\to D(10)\),  
  \(D:0\to D(10),1\to D(10)\).  
- **K-맵**으로 \(D_1,D_0\) 도출 → 팬인 2~3으로 단순 로직 달성.

### 6.5 VHDL 구현(명시적 인코딩)
```vhdl
-- Moore FSM: 상태 인코딩을 직접 지정(합성기 지시자 예시)
library ieee; use ieee.std_logic_1164.all;
entity fsm_moore is
  port (clk, rst, x : in std_logic; y : out std_logic);
end;
architecture rtl of fsm_moore is
  type state_t is (AC, B, D);
  signal s, ns : state_t := AC;
  attribute enum_encoding : string;
  attribute enum_encoding of state_t : type is "00 01 10"; -- AC=00,B=01,D=10
begin
  process(all) begin
    ns <= s;
    case s is
      when AC => if x='0' then ns <= B; else ns <= AC; end if;
      when B  => if x='0' then ns <= AC; else ns <= D;  end if;
      when D  =>              ns <= D;
    end case;
  end process;

  process(clk) begin
    if rising_edge(clk) then
      if rst='1' then s <= AC; else s <= ns; end if;
    end if;
  end process;

  y <= '1' when s=D else '0';
end;
```

> FPGA에서 **원-핫**을 원하면 `attribute enum_encoding of state_t is "001 010 100";` 처럼 지정하면 됩니다(도구별 문법 상이).

---

## 7) 체크리스트

- [ ] **도달 불가 상태**를 먼저 삭제했는가?  
- [ ] Moore/Mealy에 맞는 **등가 정의**로 최소화했는가?  
- [ ] **함의 차트**에서 초기 마크(출력 불일치)와 전이 함의 전파를 정확히 적용했는가?  
- [ ] ISM이라면 **호환/닫힌 커버**를 만족하는가(락아웃 방지)?  
- [ ] 상태할당에서 **인접 전이=해밍거리 1** 원칙을 최대한 반영했는가?  
- [ ] Moore 출력은 **상태코드의 비트화**로 제거 가능 여부를 검토했는가?  
- [ ] 최종 합성 결과(팬인/지연/셀수)를 비교해 선택했는가?

---

### 포켓 요약
- **중복상태 제거**: 도달성 분석으로 불필요 상태 삭제.  
- **등가상태 판단**: 연쇄 분할(특히 Moore) 또는 **함의 차트**(Mealy/Moore 공용).  
- **함의 차트**: (출력 불일치) 초기 × → 전이 함의로 × 전파 → 남은 쌍 병합.  
- **상태할당**: 출력지향/인접지향(그레이)·원-핫/이진 등으로 로직을 최소화.
