---
layout: post
title: AWS - KMS
date: 2025-08-03 20:20:23 +0900
category: AWS
---
# π” AWS KMSλ¥Ό ν™μ©ν• λ°μ΄ν„° μ•”νΈν™” μ™„μ „ κ°€μ΄λ“

AWS KMS(Key Management Service)λ” **μ•”νΈν™” ν‚¤μ μƒμ„±Β·κ΄€λ¦¬Β·μ‚¬μ©μ„ μ¤‘μ•™μ—μ„ μ•μ „ν•κ² μ κ³µ**ν•λ” μ„λΉ„μ¤μ…λ‹λ‹¤. μ΄ λ¬Έμ„λ” KMSμ ν•µμ‹¬ κ°λ…λ¶€ν„° μ‹¤μ „ μ μ©(μ„λ²„μ‚¬μ΄λ“, ν΄λΌμ΄μ–ΈνΈμ‚¬μ΄λ“, Envelope Encryption), μ΄μΒ·λ³΄μ• λ¨λ²” μ‚¬λ΅€, μμ  μ½”λ“κΉμ§€ μμ„Έν μ •λ¦¬ν•©λ‹λ‹¤.

---

## λ©μ°¨
1. KMS κ°μ” β€” ν•µμ‹¬ κ°λ…  
2. μ•”νΈν™” λ°©μ‹ μ”μ•½ (SSE, client-side, envelope)  
3. KMS μ£Όμ” κµ¬μ„± μ”μ†μ™€ ν‚¤ μ ν•  
4. κΈ°λ³Έ μ›ν¬ν”λ΅μ°: λ°μ΄ν„° μ•”νΈν™”/λ³µνΈν™”(Envelope)  
5. μ„λΉ„μ¤λ³„ μ—°κ³„ μ‚¬μ© μ (S3, EBS, RDS, Lambda λ“±)  
6. μ‹¤μµ μμ 
   - S3 SSE-KMS μ„¤μ • (CLI)
   - ν΄λΌμ΄μ–ΈνΈ μ‚¬μ΄λ“(Envelope) μ•”νΈν™”/λ³µνΈν™” β€” Python(boto3) μμ 
   - KMSλ΅ λΉ„λ°€(ν™κ²½λ³€μ) μ•”νΈν™” (CLI)
7. κ¶ν•, ν‚¤ μ •μ±…, Grants, μ•”νΈν™” μ»¨ν…μ¤νΈ  
8. ν‚¤ κ΄€λ¦¬(νμ „Β·μ‚­μ Β·λ³µμ )μ™€ μ΄μ ν  
9. λ³΄μ•Β·κ°μ‚¬Β·λΉ„μ© κ³ λ ¤μ‚¬ν•­  
10. μ²΄ν¬λ¦¬μ¤νΈ(λ² μ¤νΈ ν”„λ™ν‹°μ¤)
11. μμ£Ό λ°μƒν•λ” μ¤λ¥μ™€ ν•΄κ²° λ°©λ²•

---

# 1. KMS κ°μ” β€” ν•µμ‹¬ κ°λ…

- **λ©μ **: μ• ν”λ¦¬μΌ€μ΄μ…μ΄λ‚ AWS μ„λΉ„μ¤κ°€ λ°μ΄ν„°λ¥Ό μ•”νΈν™”/λ³µνΈν™”ν•  λ• μ‚¬μ©ν•λ” **μ¤‘μ•™ ν‚¤ κ΄€λ¦¬** μ κ³µ.  
- **μ΄μ **: ν‚¤μ μƒμ„±Β·λ³΄νΈΒ·μ‚¬μ© κΈ°λ΅(CloudTrail)Β·κ¶ν• ν†µμ Β·νμ „ κ΄€λ¦¬ λ“±μ„ ν†µν•© μ κ³µ.
- **μ‚¬μ© μ‹λ‚λ¦¬μ¤**: S3 κ°μ²΄ μ•”νΈν™”(SSE-KMS), EBS μ•”νΈν™”, RDS μ•”νΈν™”, Lambda ν™κ²½ λ³€μ μ•”νΈν™”, μ• ν”λ¦¬μΌ€μ΄μ…μ ν΄λΌμ΄μ–ΈνΈ μ‚¬μ΄λ“ μ•”νΈν™” λ“±.

---

# 2. μ•”νΈν™” λ°©μ‹ μ”μ•½

- **Server-Side Encryption (SSE)**  
  - **SSE-S3**: S3κ°€ κ΄€λ¦¬ν•λ” ν‚¤λ΅ μ•”νΈν™”(μ‚¬μ©μ μ μ–΄ λ¶κ°€).  
  - **SSE-KMS**: KMSμ CMKλ΅ S3κ°€ κ°μ²΄λ¥Ό μ•”νΈν™”. **ν‚¤ μ‚¬μ© κ¶ν•**μ„ μ μ–΄ν•  μ μμ.  
  - **SSE-C**: κ³ κ°μ΄ μ κ³µν• ν‚¤λ΅ S3κ°€ μ•”νΈν™”(λ³µμ΅μ„± λ†’μ).

- **Client-Side Encryption (CSE)**  
  - μ• ν”λ¦¬μΌ€μ΄μ…μ΄ λ΅μ»¬μ—μ„ λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•κ³ , μ•”νΈν™”λ λ°”μ΄νΈλ¥Ό S3μ— μ—…λ΅λ“. KMSλ” **λ°μ΄ν„° ν‚¤**(Data Key)λ¥Ό λ°κΈ‰Β·μ•”νΈν™”(μ¦‰, Envelope)λ¥Ό λ‹΄λ‹Ή.

- **Envelope Encryption (κ¶μ¥ ν¨ν„΄)**  
  - KMSμ—μ„ **λ°μ΄ν„° ν‚¤(λ€μΉ­ ν‚¤)**λ¥Ό μƒμ„±(GenerateDataKey) β†’ μ• ν”λ¦¬μΌ€μ΄μ…μ΄ **λ°μ΄ν„° ν‚¤(ν‰λ¬Έ)**λ΅ λ°μ΄ν„° μ•”νΈν™” β†’ ν‰λ¬Έ λ°μ΄ν„°ν‚¤λ” λ©”λ¨λ¦¬μ—μ„ νκΈ°ν•κ³ , **μ•”νΈν™”λ λ°μ΄ν„° ν‚¤**(CiphertextBlob)λ¥Ό ν•¨κ» μ €μ¥. λ³µνΈν™” μ‹ KMS `Decrypt`λ΅ λ³µνΈν™”λ ν‰λ¬Έ λ°μ΄ν„° ν‚¤λ¥Ό λ°›μ•„ λ°μ΄ν„° λ³µμ›.

---

# 3. KMS μ£Όμ” κµ¬μ„± μ”μ†μ™€ ν‚¤ μ ν•

- **CMK (Customer Master Key)**: KMSμ—μ„ κ΄€λ¦¬ν•λ” ν‚¤μ λ…Όλ¦¬ λ‹¨μ„. λ‘ μΆ…λ¥:
  - **Customer-managed CMK**: μ‚¬μ©μκ°€ μƒμ„±ν•κ³  μ •μ±…/νμ „μ„ μ μ–΄.
  - **AWS-managed CMK**: AWS μ„λΉ„μ¤κ°€ μƒμ„±Β·κ΄€λ¦¬. κΈ°λ³Έμ μΈ μ„λΉ„μ¤ ν†µν•©μ— μ‚¬μ©.
  - **AWS-owned KMS keys**: μ™„μ „ν AWSκ°€ μ†μ /κ΄€λ¦¬(μ‚¬μ©μ λ…Έμ¶ μ—†μ).

- **ν‚¤ μ ν•**
  - **λ€μΉ­(Symmetric)**: `Encrypt`/`Decrypt`, `GenerateDataKey` λ“±. λ€λ¶€λ¶„μ λ°μ΄ν„° μ•”νΈν™”μ— κ¶μ¥.
  - **λΉ„λ€μΉ­(Asymmetric)**: `Sign/Verify`, `Encrypt/Decrypt` μ©λ„ (RSA, ECC). μ£Όλ΅ μ„λ…/κ²€μ¦, μ•”νΈν™”μ—μ„ ν‚¤ λ…Έμ¶μ΄ λ¶κ°€ν• μ‹λ‚λ¦¬μ¤.

- **Custom Key Store**  
  - CloudHSM κΈ°λ° ν‚¤ μ €μ¥μ†λ΅, ν•λ“μ›¨μ–΄ λ³΄μ• λ¨λ“(HSM)μ—μ„ ν‚¤λ¥Ό κ΄€λ¦¬ν•΄μ•Ό ν•λ” κ·μ  λ€μ‘ μ‹ μ‚¬μ©.

- **Multi-Region CMK**  
  - μ—¬λ¬ λ¦¬μ „μ— κ±Έμ³ μ‚¬μ© κ°€λ¥ν• ν‚¤(λ³µμ  κ°€λ¥). μ§€μ—­ μ¥μ• λ³µκµ¬/κΈ€λ΅λ² μ• ν”λ¦¬μΌ€μ΄μ…μ— μ μ©.

---

# 4. κΈ°λ³Έ μ›ν¬ν”λ΅μ°: Envelope Encryption (κ¶μ¥)

1. μ• ν”λ¦¬μΌ€μ΄μ…μ΄ KMSμ— `GenerateDataKey`(λλ” `GenerateDataKeyWithoutPlaintext`) νΈμ¶ β†’ λ°ν™:
   - `Plaintext` (λ°μ΄ν„° ν‚¤ ν‰λ¬Έ)
   - `CiphertextBlob` (λ°μ΄ν„° ν‚¤μ KMS μ•”νΈλ¬Έ)
2. μ• ν”λ¦¬μΌ€μ΄μ…μ€ `Plaintext`λ¥Ό μ‚¬μ©ν•΄ **μ‹¤μ  λ°μ΄ν„°**λ¥Ό μ•”νΈν™”(μ: AES-GCM)
3. μ•”νΈν™”λ λ°μ΄ν„° + `CiphertextBlob`μ„ ν•¨κ» μ €μ¥(μ: S3 μ¤λΈμ νΈ λ©”νƒ€λ°μ΄ν„°, DB μ»¬λΌ)
4. λ³µνΈν™”: μ €μ¥λ `CiphertextBlob`μ„ KMS `Decrypt`μ— μ μ¶ β†’ λ³µνΈν™”λ `Plaintext`λ΅ μ‹¤μ  λ°μ΄ν„°λ¥Ό λ³µνΈν™”

> μ΄μ : KMS API νΈμ¶μ€ λΉ„μ©κ³Ό μ§€μ—°μ΄ μμΌλ―€λ΅, λ°μ΄ν„° μμ²΄λ¥Ό μ§μ ‘ KMSλ΅ μ•”νΈν™”(λ€λ‰ λ°μ΄ν„°)ν•μ§€ μ•κ³  **λ°μ΄ν„° ν‚¤λ΅ μ•”νΈν™”**ν•λ” λ°©μ‹μ΄ ν¨μ¨μ μ΄κ³  μ•μ „ν•¨.

---

# 5. μ„λΉ„μ¤λ³„ μ—°κ³„ μ‚¬μ© μ (κ°„λ‹¨ μ”μ•½)

- **S3**: SSE-KMSλ΅ κ°μ²΄ μ•”νΈν™”, λλ” ν΄λΌμ΄μ–ΈνΈ μ‚¬μ΄λ“(Envelope) λ°©μ‹μΌλ΅ μ €μ¥. S3 λ²„ν‚· κΈ°λ³Έ μ•”νΈν™” μ„¤μ • κ¶μ¥.  
- **EBS**: EBS λ³Όλ¥¨ μƒμ„± μ‹ KMS ν‚¤ μ§€μ •ν•μ—¬ μ•”νΈν™”(μ¤λƒ…μƒ· ν¬ν•¨).  
- **RDS**: μΈμ¤ν„΄μ¤ μƒμ„± μ‹ KMS CMKλ΅ μ¤ν† λ¦¬μ§€ μ•”νΈν™” κ°€λ¥.  
- **EFS**: νμΌ μ‹μ¤ν… μ•”νΈν™”μ— KMS μ‚¬μ©.  
- **Lambda**: ν™κ²½λ³€μ μ•”νΈν™”(νΉν plain text λΉ„λ°€ κ°’ λ€μ‹  KMS μ•”νΈν™”) β€” λλ” Secrets Manager μ‚¬μ© κ¶μ¥.  
- **Secrets Manager & Parameter Store**: λ‚΄λ¶€μ μΌλ΅ KMSλ¥Ό μ‚¬μ©ν•μ—¬ λΉ„λ°€μ„ μ•”νΈν™”.  
- **CloudWatch Logs, Redshift, Glue** λ“± μ£Όμ” AWS μ„λΉ„μ¤λ” KMS μ—°λ™ μ§€μ›.

---

# 6. μ‹¤μµ μμ 

## 6.1 S3μ—μ„ SSE-KMSλ΅ λ²„ν‚· κΈ°λ³Έ μ•”νΈν™” μ„¤μ • (CLI)

```bash
aws s3api put-bucket-encryption \
  --bucket my-bucket \
  --server-side-encryption-configuration '{
    "Rules":[
      {
        "ApplyServerSideEncryptionByDefault":{
          "SSEAlgorithm":"aws:kms",
          "KMSMasterKeyID":"arn:aws:kms:ap-northeast-2:123456789012:key/abcd-ef01-2345-6789"
        }
      }
    ]
  }'
```

- κ°μ²΄ μ—…λ΅λ“ μ‹ λ³„λ„ μµμ… μ—†μ΄ SSE-KMSλ΅ μλ™ μ•”νΈν™”λ©λ‹λ‹¤.
- **κ¶ν•**: κ°μ²΄λ¥Ό μ—…λ΅λ“ν•λ” μ£Όμ²΄(μ‚¬μ©μ/μ„λΉ„μ¤)λ” ν•΄λ‹Ή CMKμ— λ€ν•΄ `kms:Encrypt`(λλ” `kms:GenerateDataKey`) κ¶ν•μ΄ μμ–΄μ•Ό ν•©λ‹λ‹¤.

## 6.2 KMS ν‚¤ μƒμ„± (CLI)

```bash
aws kms create-key \
  --description "My app CMK" \
  --tags TagKey=Project,TagValue=Billing
```

μƒμ„± ν›„ `KeyId` λλ” `Arn`μ„ μ‚¬μ©.

## 6.3 ν΄λΌμ΄μ–ΈνΈ μ‚¬μ΄λ“(Envelope) μ•”νΈν™”/λ³µνΈν™” β€” Python (boto3 + cryptography μμ )

> μ‚¬μ „μ¤€λΉ„: `pip install boto3 cryptography`

```python
# encrypt_file.py
import boto3
import json
from cryptography.hazmat.primitives.ciphers.aead import AESGCM

kms = boto3.client('kms', region_name='ap-northeast-2')
S3_BUCKET = 'my-encrypted-bucket'
CMK_KEY_ID = 'arn:aws:kms:ap-northeast-2:123456789012:key/abcd-ef01-2345-6789'

def generate_data_key():
    resp = kms.generate_data_key(KeyId=CMK_KEY_ID, KeySpec='AES_256')
    # resp contains 'Plaintext' (bytes) and 'CiphertextBlob' (bytes)
    return resp['Plaintext'], resp['CiphertextBlob']

def encrypt_bytes(plaintext_bytes, data_key_plain):
    aesgcm = AESGCM(data_key_plain)
    nonce = AESGCM.generate_key(bit_length=96)  # 12 bytes nonce recommended
    # cryptography expects 12-byte nonce for AESGCM
    nonce = AESGCM.generate_key(bit_length=96)[:12]
    ct = aesgcm.encrypt(nonce, plaintext_bytes, None)
    return nonce + ct  # prepend nonce

def main():
    # μ: κ°„λ‹¨ νμΌ μ•”νΈν™”
    with open('example.txt', 'rb') as f:
        data = f.read()

    data_key_plain, data_key_encrypted = generate_data_key()
    ciphertext = encrypt_bytes(data, data_key_plain)

    # Plaintext data keyλ” λ°λ“μ‹ λ©”λ¨λ¦¬μ—μ„ μ¦‰μ‹ νκΈ°
    del data_key_plain

    # μ €μ¥: S3μ— μ—…λ΅λ“ (μ: metadataμ— encrypted data key λ³΄κ΄€)
    import boto3
    s3 = boto3.client('s3')
    s3.put_object(Bucket=S3_BUCKET, Key='example.enc',
                  Body=ciphertext,
                  Metadata={'x-amz-key': data_key_encrypted.hex()})
    print("Uploaded encrypted object with encrypted data key in metadata.")

if __name__ == '__main__':
    main()
```

λ³µνΈν™” μ:

```python
# decrypt_file.py
import boto3
from cryptography.hazmat.primitives.ciphers.aead import AESGCM

s3 = boto3.client('s3')
kms = boto3.client('kms', region_name='ap-northeast-2')

def decrypt_object(bucket, key):
    obj = s3.get_object(Bucket=bucket, Key=key)
    ciphertext = obj['Body'].read()
    enc_key_hex = obj['Metadata']['x-amz-key']
    enc_key = bytes.fromhex(enc_key_hex)

    # KMSμ— μ”μ²­ν•μ—¬ λ°μ΄ν„° ν‚¤ ν‰λ¬Έ νλ“
    resp = kms.decrypt(CiphertextBlob=enc_key)
    data_key_plain = resp['Plaintext']

    nonce = ciphertext[:12]
    ct = ciphertext[12:]
    aesgcm = AESGCM(data_key_plain)
    plaintext = aesgcm.decrypt(nonce, ct, None)

    # λ©”λ¨λ¦¬ μ •λ¦¬
    del data_key_plain
    return plaintext

if __name__ == '__main__':
    print(decrypt_object('my-encrypted-bucket', 'example.enc'))
```

**μ£Όμ**: μ„ μ½”λ“λ” κµμ΅μ© μμ μ…λ‹λ‹¤. μ‹¤μ  λ°°ν¬ μ‹ nonce μƒμ„± λ°©μ‹, λ©”νƒ€λ°μ΄ν„° μ €μ¥ μ„μΉ, ν‚¤ λ…Έμ¶ μµμ†ν™”, λ©”λ¨λ¦¬ ν΄λ¦¬μ–΄, μ—λ¬ μ²λ¦¬ λ“± λ³΄κ°• ν•„μ”.

## 6.4 KMSλ΅ λ¬Έμμ—΄(μ: λΉ„λ°€λ²νΈ) μ•”νΈν™”(ν΄λΌμ΄μ–ΈνΈβ†’λ³΄κ΄€) β€” CLI

```bash
# μ•”νΈν™”
aws kms encrypt --key-id alias/my-key --plaintext "mySecretPassword" \
  --query CiphertextBlob --output text | base64 --decode > secret.bin

# λ³µνΈν™”
aws kms decrypt --ciphertext-blob fileb://secret.bin \
  --query Plaintext --output text | base64 --decode
```

---

# 7. κ¶ν•, ν‚¤ μ •μ±…, Grants, μ•”νΈν™” μ»¨ν…μ¤νΈ

## 7.1 ν‚¤ μ •μ±…(Key Policy)
- CMKμ **μµμƒμ„ κ¶ν• μ μ–΄ λ¬Έμ„**μ…λ‹λ‹¤. ν‚¤ μ •μ±…μ€ ν•΄λ‹Ή CMKμ— λ„κ°€ λ¬΄μ¨ μ‘μ—…μ„ ν•  μ μλ”μ§€ κ²°μ •ν•©λ‹λ‹¤.
- μΌλ°μ  κ¶μ¥: ν‚¤ κ΄€λ¦¬μ(κ΄€λ¦¬μ μ—­ν• )μ™€ ν‚¤ μ‚¬μ© μ£Όμ²΄(μ„λΉ„μ¤/μ‚¬μ©μ)λ¥Ό λ…μ‹μ μΌλ΅ λ¶„λ¦¬ν•μ—¬ μµμ† κ¶ν•μΌλ΅ κµ¬μ„±.

μ(κ°„λ‹¨):

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid":"AllowUseOfTheKey",
      "Effect":"Allow",
      "Principal":{"AWS":"arn:aws:iam::111122223333:role/S3AccessRole"},
      "Action":["kms:Encrypt","kms:Decrypt","kms:GenerateDataKey*"],
      "Resource":"*"
    }
  ]
}
```

## 7.2 IAM μ •μ±… vs ν‚¤ μ •μ±…
- **IAM μ •μ±…**: μ£Όμ²΄(μ‚¬μ©μ/μ—­ν• )μ— μ—°κ²°λλ” κ¶ν•.  
- **ν‚¤ μ •μ±…**: CMK μμ²΄μ— μ—°κ²°λλ” κ¶ν•.  
KMS μ ‘κ·Όμ„ μ„ν•΄μ„λ” λ³΄ν†µ **λ‘μ½ λ¨λ‘** μ μ ν κµ¬μ„±λμ–΄μ•Ό ν•©λ‹λ‹¤(ν‚¤ μ •μ±…μ΄ κ¶ν• λ¶€μ—¬λ¥Ό ν—μ©ν•κ³ , IAM μ •μ±…μ΄ μ”μ²­μ„ ν—μ©).

## 7.3 Grants
- Grantsλ” μΌμ‹μ Β·μ„Έλ°€ν• ν‚¤ μ‚¬μ© κ¶ν•(μ: νΉμ • API ν—μ©)μ„ λ¶€μ—¬ν•  λ• μ‚¬μ©.  
- μ¥μ : λΉ λ¥Έ κ¶ν• λ¶€μ—¬/μ·¨μ†, νΉν S3λ‚ λ‹¤λ¥Έ AWS μ„λΉ„μ¤κ°€ ν‚¤λ¥Ό μ‚¬μ©ν•λ„λ΅ κ¶ν•μ„ μ„μ„ν•  λ• μ μ©.

## 7.4 μ•”νΈν™” μ»¨ν…μ¤νΈ (Encryption Context)
- μ¶”κ°€μ μΈ μΈμ¦ λ°”μΈλ”© λ©”νƒ€λ°μ΄ν„°. λ°μ΄ν„°λ¥Ό λ³µνΈν™”ν•  λ• λ™μΌν• μ»¨ν…μ¤νΈκ°€ ν•„μ”ν•λ©΄ KMSκ°€ κ±°λ¶€ν•©λ‹λ‹¤(μµμ…).
- μ: `{"purpose":"backup","object":"invoice/2025/07/01.json"}`  
- μ‚¬μ©: λ―Όκ°ν• λ°μ΄ν„°μ λ¬΄κ²°μ„±/μ¶μ² κ²€μ¦μ— μ μ©.

---

# 8. ν‚¤ κ΄€λ¦¬(νμ „Β·μ‚­μ Β·λ³µμ )μ™€ μ΄μ ν

## 8.1 ν‚¤ νμ „ (Key Rotation)
- Customer-managed symmetric CMKλ” **μλ™ ν‚¤ νμ „(1λ…„ μ£ΌκΈ°)**μ„ ν™μ„±ν™”ν•  μ μμ.  
- νμ „ μ‹ κΈ°μ΅΄ μ•”νΈλ¬Έμ„ μλ™μΌλ΅ μ¬μ•”νΈν™”ν•μ§„ μ•μµλ‹λ‹¤. λ°μ΄ν„° μ¬μ•”νΈν™”κ°€ ν•„μ”ν• κ²½μ°:
  - **ReEncrypt API**λ¥Ό μ‚¬μ©ν•΄ μ•”νΈλ¬Έμ„ μƒ CMKλ΅ μ¬μ•”νΈν™”ν•κ±°λ‚,
  - μ €μ¥λ κ°μ²΄λ¥Ό "μ½κ³  μ¬μ“°κΈ°(λ³µνΈν™”β†’μ•”νΈν™” with new key)" λ°©μ‹μΌλ΅ μ²λ¦¬.

## 8.2 ν‚¤ μ‚­μ  (ScheduleKeyDeletion)
- CMKλ” μ¦‰μ‹ μ‚­μ  λ¶κ°€. μ‚­μ  μμ•½(7~30μΌ) ν›„ μ‚­μ λ©λ‹λ‹¤. μ΄λ¥Ό ν†µν•΄ μ‹¤μ μ‚­μ  λ°©μ§€.
- μ‚­μ  μ „μ—λ” ν‚¤ λΉ„ν™μ„±ν™”(disable-key) κ¶μ¥.

## 8.3 λ©€ν‹° λ¦¬μ „ & λ³µμ 
- **Multi-Region CMK**λ¥Ό μ‚¬μ©ν•λ©΄ λ¦¬μ „ κ°„ μ¬λ‚ λ³µκµ¬λ¥Ό μ‰½κ² ν•  μ μμ(λ³µμ  μ§€μ›).
- Cross-Region μ•”νΈλ¬Έ μ‚¬μ© μ‹ λ¦¬μ „λ³„ ν‚¤ μ ‘κ·Ό κ³ λ ¤ ν•„μ”.

## 8.4 Custom Key Store (CloudHSM)
- κ·μ •μƒ HSMμ—μ„ ν‚¤λ¥Ό κ΄€λ¦¬ν•΄μ•Ό ν•  λ• μ‚¬μ©.
- λ‹¨μ : λΉ„μ©Β·μ΄μ λ³µμ΅μ„± μ¦κ°€.

---

# 9. λ³΄μ•Β·κ°μ‚¬Β·λΉ„μ© κ³ λ ¤μ‚¬ν•­

## 9.1 κ°μ‚¬(CloudTrail)
- KMSμ λ¨λ“  API νΈμ¶(Encrypt, Decrypt, GenerateDataKey, CreateKey λ“±)μ€ CloudTrailμ— κΈ°λ΅λ©λ‹λ‹¤. κ°μ‚¬Β·ν¬λ μ‹Β·μ‚¬μ©λ‰ μ¶”μ μ— ν•„μ.

## 9.2 λΉ„μ©
- **CMK(κ³ κ° κ΄€λ¦¬ ν‚¤)**μ— λ€ν• μ›”λ³„ λΉ„μ©(μΌλ¶€ ν‚¤ μ ν•μ— μ μ©) λ° **API νΈμ¶(Encrypt/Decrypt/GenerateDataKey λ“±)**μ— λ€ν• μ‚¬μ© μ”κΈμ΄ λ°μƒν•©λ‹λ‹¤. (μ”κΈμ€ μ§€μ—­Β·μ‹μ μ— λ”°λΌ λ‹¬λΌμ§€λ―€λ΅ AWS μ”κΈ νμ΄μ§€ ν™•μΈ κ¶μ¥)

## 9.3 μ„±λ¥Β·μ¤μΌ€μΌ
- KMSλ” λ™μ‹ μ²λ¦¬λ‰ ν•κ³„Β·API λ μ΄ν„΄μ‹κ°€ μ΅΄μ¬.  
- λ€λ‰ λ°μ΄ν„° μ•”νΈν™” μ‹ **Envelope Encryption**μ„ μ‚¬μ©ν•κ³ , KMS νΈμ¶μ„ μµμ†ν™”(λ°μ΄ν„°ν‚¤ μ¬μ‚¬μ©μ€ μ‹ μ¤‘ν)ν•μ„Έμ”.

---

# 10. μ²΄ν¬λ¦¬μ¤νΈ(λ² μ¤νΈ ν”„λ™ν‹°μ¤)

- **μµμ† κ¶ν• μ›μΉ™(Least Privilege)** μ μ©  
- CMKλ” ν•„μ”ν•  λ•λ§ μƒμ„±ν•κ³  νƒκΉ…μΌλ΅ κ΄€λ¦¬  
- **ν‚¤ μ •μ±…**μ™€ **IAM μ •μ±…**μ„ μΌκ΄€λκ² μ„¤κ³„  
- **Encryption Context** ν™μ©μΌλ΅ λ¬΄κ²°μ„± κ°•ν™”  
- **Envelope Encryption** μ‚¬μ© β€” KMSλ΅ λ€μ©λ‰ λ°μ΄ν„° μ§μ ‘ μ•”νΈν™” κΈμ§€  
- **μλ™ ν‚¤ νμ „(Automatic key rotation)** ν™μ„±ν™”(κ°€λ¥ν•λ©΄)  
- **CloudTrail λ΅κΉ…** ν™μ„±ν™”ν•μ—¬ λ¨λ“  KMS νΈμ¶ κ°μ‚¬  
- **λ°μ΄ν„° ν‚¤ ν‰λ¬Έ(Plaintext)**μ€ λ©”λ¨λ¦¬μ—μ„ λΉ λ¥΄κ² νκΈ°ν•κ³  μ λ€ λ΅κ·Έμ— λ‚¨κΈ°μ§€ μ•μ  
- **λΉ„μƒ λ€μ‘**μ„ μ„ν• ν‚¤ μ‚­μ  λ³΄νΈ(μ‚­μ  μμ•½ κΈ°κ°„Β·λΉ„ν™μ„±ν™” μ •μ±…) λ§λ ¨  
- **λΉ„μ© λ¨λ‹ν„°λ§**: KMS API νΈμ¶λ‰κ³Ό CMK μλ‰ ν™•μΈ

---

# 11. μμ£Ό λ°μƒν•λ” μ¤λ¥μ™€ ν•΄κ²° λ°©λ²•

- **AccessDeniedException**  
  - μ›μΈ: ν‚¤ μ •μ±… λλ” IAM μ •μ±…μ— ν•΄λ‹Ή μ£Όμ²΄ κ¶ν• λ„λ½.  
  - ν•΄κ²°: ν‚¤ μ •μ±…Β·IAM μ •μ±…Β·μ„λΉ„μ¤ μ—­ν• Β·grantsλ¥Ό ν™•μΈ. S3 + KMSμ κ²½μ° `kms:ViaService` μ΅°κ±΄ ν•„μ”ν•  μ μμ.

- **InvalidCiphertextException**  
  - μ›μΈ: μ κ³µλ μ•”νΈλ¬Έμ΄ μ ν¨ν•μ§€ μ•μ(μ¤μ—Ό λλ” μλ»λ ν‚¤ μ‚¬μ©).  
  - ν•΄κ²°: μ•”νΈλ¬Έκ³Ό λ€μ‘ν•λ” CMK ν™•μΈ. μ•”νΈν™” μ»¨ν…μ¤νΈλ¥Ό μ‚¬μ©ν–λ‹¤λ©΄ λ³µνΈν™” μ‹ λ™μΌν• μ»¨ν…μ¤νΈ μ „λ‹¬ μ—¬λ¶€ ν™•μΈ.

- **ThrottlingException**  
  - μ›μΈ: KMS API νΈμ¶ μ΄κ³Ό(μ¤λ£¨ν’‹ μ ν•).  
  - ν•΄κ²°: νΈμ¶ ν¨ν„΄ μ¬μ„¤κ³„(μΊμ‹±, λ°°μΉ), AWS μ§€μ›μ— μ”μ²­ν•μ—¬ μ ν• μƒν–¥.

---

# λ¶€λ΅ β€” μμ‹: S3 + KMS μ‚¬μ© μ‹ κ¶ν• μμ‹(ν•µμ‹¬μ‚¬ν•­)

- S3κ°€ KMSλ¥Ό μ‚¬μ©ν•λ„λ΅ ν—μ©ν•λ ¤λ©΄ CMK ν‚¤ μ •μ±…μ— S3 μ„λΉ„μ¤ μ”μ²­μ„ ν—μ©ν•΄μ•Ό ν•©λ‹λ‹¤. (μ: `kms:Encrypt` κ¶ν•μ„ S3μ— μ„μ„)
- μμ‹ ν‚¤ μ •μ±… λ¬Έκµ¬(μ”μ•½):

```json
{
  "Sid": "AllowS3ToUseKey",
  "Effect": "Allow",
  "Principal": { "Service": "s3.amazonaws.com" },
  "Action": [
    "kms:Encrypt",
    "kms:Decrypt",
    "kms:GenerateDataKey*",
    "kms:ReEncrypt*"
  ],
  "Resource": "*",
  "Condition": {
    "StringEquals": { "kms:ViaService": "s3.ap-northeast-2.amazonaws.com" }
  }
}
```

> μ„ μƒν”μ€ κ°λ… μ„¤λ…μ©μ…λ‹λ‹¤. μ‹¤μ λ΅λ” `Resource`, `aws:SourceAccount` λ“± μ΅°κ±΄μ„ λ” μ—„κ²©ν μ„¤μ •ν•΄μ•Ό ν•©λ‹λ‹¤.

---

# κ²°λ΅ 

AWS KMSλ” **ν‚¤ μλ…μ£ΌκΈ° κ΄€λ¦¬Β·κ¶ν• ν†µμ Β·κ°μ‚¬**λ¥Ό ν†µν•© μ κ³µν•μ—¬ μ•μ „ν• μ•”νΈν™” ν™κ²½μ„ λ§λ“¤ μ μκ² ν•΄μ¤λ‹λ‹¤.  
ν•µμ‹¬μ€ **Envelope Encryption ν¨ν„΄μ„ μ‚¬μ©**ν•κ³ , **ν‚¤μ •μ±…Β·IAMμ •μ±…μ„ μ—„κ²©ν•κ² μ„¤κ³„**ν•λ©°, **CloudTrailλ΅ κ°μ‚¬**ν•λ” κ²ƒμ…λ‹λ‹¤. μ΄μ μΈ΅λ©΄μ—μ„λ” ν‚¤ νμ „Β·λΉ„μƒ λ³µκµ¬Β·λΉ„μ© κ΄€λ¦¬λ¥Ό ν•¨κ» κ³ λ ¤ν•΄μ•Ό μ•μ „ν•κ³  ν™•μ¥ κ°€λ¥ν• μ•”νΈν™” μ „λµμ„ μ„¤κ³„ν•  μ μμµλ‹λ‹¤.
