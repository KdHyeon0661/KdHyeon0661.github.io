---
layout: post
title: Git - 다중 SSH 키
date: 2025-01-19 22:20:23 +0900
category: Git
---
# 고급 SSH 설정: 다중 키, SSH Config, GPG 서명

## 핵심 개념

SSH 키와 GPG 서명을 효과적으로 관리하면 보안성과 작업 효율성을 동시에 향상시킬 수 있습니다. 개인과 업무용 계정을 분리하거나 여러 서비스(GitHub, GitLab, Bitbucket)를 병행 사용할 때 특히 유용합니다.

---

## 다중 SSH 키 활용 시나리오

### 일반적인 사용 사례
1. **개인과 업무 계정 분리**: GitHub 개인 계정과 회사 계정 동시 사용
2. **다중 Git 서비스**: GitHub, GitLab, Bitbucket 등 플랫폼별 키 분리
3. **장비별 구분**: 노트북, 데스크탑, CI 서버별 전용 키 사용
4. **권한 최소화**: 특정 저장소에만 접근 가능한 제한적 키 생성
5. **일시적 접근**: 협력사나 외부 개발자에게 임시 키 발급

### 보안 이점
- 키 유출 시 피해 범위 최소화
- 장비 분실 시 해당 키만 폐기 가능
- 역할 기반 접근 제어 구현 용이

---

## SSH 키 생성 및 관리

### 안전한 키 생성 방법
```bash
# 개인용 키 생성
ssh-keygen -t ed25519 -a 64 -C "personal@example.com" \
  -f ~/.ssh/id_ed25519_personal

# 업무용 키 생성  
ssh-keygen -t ed25519 -a 64 -C "work@company.com" \
  -f ~/.ssh/id_ed25519_work
```

**옵션 설명**:
- `-t ed25519`: EdDSA 알고리즘 사용 (보다 안전하고 빠름)
- `-a 64`: 키 유도 함수 반복 횟수 증가 (브루트포스 공격 방지)
- `-C "comment"`: 키 식별용 주석 (일반적으로 이메일 사용)

### 공개키 확인 및 등록
```bash
# 공개키 확인
cat ~/.ssh/id_ed25519_personal.pub

# GitHub에 등록:
# Settings → SSH and GPG keys → New SSH key
```

**중요**: 항상 암호문구(passphrase)를 설정하고, 개인키 파일 권한은 600으로 유지하세요.

---

## SSH Config 고급 설정

### 기본 구성 구조
```sshconfig
# ~/.ssh/config

# 개인 GitHub 계정
Host github.com-personal
  HostName github.com
  User git
  IdentityFile ~/.ssh/id_ed25519_personal
  IdentitiesOnly yes
  AddKeysToAgent yes

# 업무용 GitHub 계정  
Host github.com-work
  HostName github.com
  User git
  IdentityFile ~/.ssh/id_ed25519_work
  IdentitiesOnly yes
  AddKeysToAgent yes

# 기업 GitHub 엔터프라이즈
Host ghe.company.com
  HostName ghe.company.com
  User git
  IdentityFile ~/.ssh/id_ed25519_work
  IdentitiesOnly yes
```

### 고급 기능 활용
```sshconfig
# 연결 재사용으로 성능 향상 (멀티플렉싱)
Host *
  ControlMaster auto
  ControlPath ~/.ssh/control-%r@%h:%p
  ControlPersist 600

# 점프 호스트를 통한 내부망 접속
Host internal-server
  HostName internal.company.com
  User admin
  ProxyJump bastion.company.com
  IdentityFile ~/.ssh/id_ed25519_internal

# 설정 파일 모듈화
Include ~/.ssh/config.d/*.conf
```

---

## Git 작업 흐름에 적용

### 저장소 클론
```bash
# 개인 저장소
git clone git@github.com-personal:username/project.git

# 업무 저장소
git clone git@github.com-work:company/team-project.git

# 내부 엔터프라이즈 저장소
git clone git@ghe.company.com:department/service.git
```

### 기존 저장소 원격 주소 변경
```bash
# HTTPS에서 SSH로 전환
git remote set-url origin git@github.com-personal:username/repo.git

# 업무용 계정으로 변경
git remote set-url origin git@github.com-work:company/repo.git
```

### 서브모듈 SSH 통일
```bash
# 모든 서브모듈의 URL을 SSH 형식으로 변환
git submodule foreach '
  current=$(git config --get remote.origin.url);
  if [[ $current == https://* ]]; then
    new=${current/https:\/\/github.com\//git@github.com:};
    git remote set-url origin "$new";
  fi
'
git submodule sync --recursive
```

---

## GPG 커밋 서명 설정

### GPG 키 생성
```bash
# 새로운 GPG 키 생성 (대화형)
gpg --full-generate-key

# 키 정보 확인
gpg --list-secret-keys --keyid-format=long
# 출력 예: sec   rsa4096/3AA5C34371567BD2 2025-07-20 [SC]

# 공개키 추출 (GitHub 등록용)
gpg --armor --export 3AA5C34371567BD2
```

### Git에 GPG 키 연결
```bash
# 서명용 키 설정
git config --global user.signingkey 3AA5C34371567BD2

# 모든 커밋에 자동 서명 활성화
git config --global commit.gpgsign true

# 특정 커밋에만 수동 서명
git commit -S -m "feat: GPG 서명이 적용된 커밋"
```

### 서명 확인
```bash
# 최근 커밋의 서명 검증
git log --show-signature -1

# 태그 서명 및 검증
git tag -s v1.0.0 -m "릴리스 버전 1.0.0"
git tag -v v1.0.0
```

**장점**: GitHub에서 "Verified" 배지 표시, 커밋 변조 방지, 공급망 보안 강화

---

## CI/CD 환경에서의 SSH 키 관리

### 배포 키(Deploy Key) 사용
배포 키는 특정 저장소에만 연결되는 SSH 키로, CI/CD 파이프라인에 적합합니다.

1. **읽기 전용 키**: 패키지 다운로드, 의존성 설치
2. **쓰기 가능 키**: 문서 자동 생성, 릴리스 태그 푸시

```bash
# CI 환경에서 known_hosts 설정
mkdir -p ~/.ssh
ssh-keyscan github.com >> ~/.ssh/known_hosts
chmod 644 ~/.ssh/known_hosts

# 배포 키로 인증
ssh -i /path/to/deploy-key git@github.com
```

### 머신 사용자(Machine User)
여러 저장소에 접근해야 할 경우 전용 GitHub 계정을 생성하는 것이 더 적합할 수 있습니다.

---

## 문제 해결 가이드

### 일반적인 SSH 문제 진단
```bash
# 상세 디버깅 모드
ssh -vT git@github.com

# Git 명령어와 함께 디버깅
GIT_SSH_COMMAND="ssh -v" git fetch origin
```

### 주요 오류 및 해결책

**문제**: `Permission denied (publickey)`
- **원인**: 키가 등록되지 않았거나 에이전트에 로드되지 않음
- **해결**: 
  ```bash
  # SSH 에이전트 시작
  eval "$(ssh-agent -s)"
  
  # 키 추가
  ssh-add ~/.ssh/id_ed25519_personal
  
  # GitHub에 공개키 등록 확인
  ```

**문제**: `Host key verification failed`
- **원인**: known_hosts에 호스트 키 정보가 없거나 불일치
- **해결**:
  ```bash
  # 기존 항목 제거
  ssh-keygen -R github.com
  
  # 새로운 키 등록
  ssh-keyscan github.com >> ~/.ssh/known_hosts
  ```

**문제**: GPG 서명 실패
- **원인**: gpg-agent 문제나 pinentry 설정 오류
- **해결**:
  ```bash
  # gpg-agent 재시작
  gpgconf --kill gpg-agent
  
  # pinentry 프로그램 확인
  echo "pinentry-program $(which pinentry)" >> ~/.gnupg/gpg-agent.conf
  gpgconf --reload gpg-agent
  ```

### 파일 권한 확인 및 수정
```bash
# 적절한 권한 설정
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_*
chmod 644 ~/.ssh/*.pub
chmod 644 ~/.ssh/config
chmod 644 ~/.ssh/known_hosts
```

---

## 모범 사례 요약

### 보안 관행
1. **강력한 암호문구 사용**: 모든 SSH 키에 암호문구 설정
2. **정기적인 키 회전**: 6-12개월마다 키 재생성 및 교체
3. **최소 권한 원칙**: 각 키가 필요한 최소한의 접근만 갖도록 제한
4. **장비별 키 분리**: 노트북, 데스크탑, 서버별 별도 키 사용

### 구성 관리
1. **SSH Config 활용**: 호스트별 자동 키 선택 구성
2. **백업 정책**: 암호화된 상태로 GPG 키 백업
3. **문서화**: 팀 내 SSH/GPG 설정 표준 문서 유지
4. **테스트**: 새로운 설정 적용 전 철저한 테스트 수행

### 운영 효율성
1. **에이전트 활용**: ssh-agent로 반복적인 암호 입력 방지
2. **연결 재사용**: 멀티플렉싱으로 연결 속도 개선
3. **자동화 스크립트**: 반복적 설정 작업 자동화
4. **모니터링**: 키 사용 로그 정기적 검토

---

## 결론

고급 SSH 및 GPG 설정은 처음에는 복잡해 보일 수 있지만, 일단 구성해두면 장기적으로 보안과 생산성을 크게 향상시킵니다. 개인과 업무 환경을 분리하고, 적절한 권한 관리와 정기적인 키 회전을 통해 보안 위험을 최소화할 수 있습니다.

가장 중요한 것은 균형을 유지하는 것입니다. 지나치게 복잡한 설정은 유지보수를 어렵게 만들 수 있으므로, 실제 필요에 맞는 수준의 구성을 선택하세요. 작은 단계부터 시작해 점차 고급 기능을 도입하는 것이 장기적인 성공의 열쇠입니다.

SSH와 GPG는 단순한 인증 도구를 넘어 개발 워크플로우의 핵심 인프라입니다. 이들을 효과적으로 관리하는 습관은 전문 개발자로서의 중요한 역량 중 하나입니다.