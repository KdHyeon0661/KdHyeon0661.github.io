---
layout: post
title: Git - 다중 SSH 키
date: 2025-01-19 22:20:23 +0900
category: Git
---
# 고급 SSH 설정: 다중 키, SSH config, GPG 서명까지

## 개념 정리(요약)

- **다중 SSH 키**: 개인/회사/별도 서비스(예: GitLab, Bitbucket) 혹은 장비별로 **키를 분리**하면 유출/회전/권한 최소화에 유리.
- **`~/.ssh/config`**: 호스트 별칭을 통해 **저장소 주소만 바꿔도** 서로 다른 키를 자동 선택.
- **GPG 서명**: “이 커밋은 내가 했다”를 **암호학적으로 증명**. GitHub에 Verified가 표시되며 공급망 보안 강화.
- **운용 포인트**: 키 권한(600)·에이전트 로딩·서브모듈 URL 통일·프록시/점프호스트·CI 배포키·정기 회전·감사 가능성.

---

## 다중 SSH 키가 필요한 상황(확장)

- **개인 GitHub.com**과 **회사 GitHub Enterprise**를 동시에 사용
- **GitHub + GitLab + Bitbucket** 등 다중 서비스 병행
- **장비별(노트북/데스크탑/WSL/CI)**로 키를 분리해 분실·폐기 비용 최소화
- 특정 프로젝트에만 **쓰기 권한이 있는 전용 키**(최소 권한 원칙)
- 외부 협력사 접근 시 **일시적 키** 발급 후 만료/폐기

---

## SSH 키 생성(개인/회사 분리 + 강화 옵션)

```bash
# 개인

ssh-keygen -t ed25519 -a 64 -o -C "my_personal_email@example.com" \
  -f ~/.ssh/id_ed25519_personal

# 회사

ssh-keygen -t ed25519 -a 64 -o -C "my_work_email@company.com" \
  -f ~/.ssh/id_ed25519_work
```

- `-a 64` : KDF 라운드 증가(암호문구 브루트포스 방어 강화)
- `-o` : 현대적 포맷으로 저장
- **암호문구(passphrase) 반드시 사용**
- 하드웨어 보안키(FIDO2)도 선택 가능:
```bash
ssh-keygen -t ed25519-sk -C "my_hwkey@example.com" -f ~/.ssh/id_ed25519_hw
```

공개키 등록용 출력:
```bash
cat ~/.ssh/id_ed25519_personal.pub
cat ~/.ssh/id_ed25519_work.pub
```

---

## `~/.ssh/config` 고급 설계

### 기본 분기(개인/회사)

```sshconfig
# ~/.ssh/config

Host github.com-personal
  HostName github.com
  User git
  IdentityFile ~/.ssh/id_ed25519_personal
  IdentitiesOnly yes
  AddKeysToAgent yes

Host github.com-work
  HostName github.com
  User git
  IdentityFile ~/.ssh/id_ed25519_work
  IdentitiesOnly yes
  AddKeysToAgent yes
```

### 조직 엔터프라이즈 도메인 분기 예

```sshconfig
Host ghe.company.internal
  HostName ghe.company.internal
  User git
  IdentityFile ~/.ssh/id_ed25519_work
  IdentitiesOnly yes
```

### 공통 규칙 + 개별 규칙(Include/Match 활용)

```sshconfig
# 공통 기본

Host *
  ServerAliveInterval 30
  ServerAliveCountMax 3
  PreferredAuthentications publickey
  StrictHostKeyChecking ask
  AddKeysToAgent yes

# 사내망만 다른 키 사용(예: 전용 배스천 키)

Match host *.company.internal
  IdentityFile ~/.ssh/id_ed25519_work

# 설정 분리(모듈화)

Include ~/.ssh/conf.d/*.conf
```

### 멀티플렉싱(연결 재사용으로 속도/안정성 개선)

```sshconfig
Host github.com github.com-personal github.com-work ghe.company.internal
  ControlMaster auto
  ControlPath ~/.ssh/cm-%r@%h:%p
  ControlPersist 5m
```

> 멀티플렉싱은 동일 호스트로의 반복 연결에서 성능 향상. CI에서는 누적 소켓 관리에 주의.

---

## 커스텀 호스트로 clone/원격 교체

### clone

```bash
# 개인

git clone git@github.com-personal:username/repo.git

# 회사

git clone git@github.com-work:company/repo.git
# 또는

git clone git@ghe.company.internal:team/service.git
```

### 기존 저장소 원격 변경

```bash
git remote set-url origin git@github.com-personal:username/repo.git
# 또는

git remote set-url origin git@github.com-work:company/repo.git
```

> 서브모듈도 일관되게 SSH로 맞추려면 `.gitmodules` 수정 후 `git submodule sync --recursive`.

---

## 키 재등록/폐기와 정기 회전(보안 관점)

1) GitHub → **Settings → SSH and GPG keys**
2) 사용하지 않는 키 **Delete**
3) 새 키는 **New SSH key** 등록(장비/용도 구분 Title 부여)
4) **정기 회전**: 반기/분기마다 재발급·구키 폐기
5) 장비 분실 시 해당 키 즉시 폐기

권한/퍼미션(UNIX):
```bash
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_ed25519*
chmod 644 ~/.ssh/*.pub
chmod 644 ~/.ssh/config
```

---

## 사용과 OS별 팁

### 공통

```bash
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519_personal
ssh-add ~/.ssh/id_ed25519_work
ssh-add -l
```

### macOS(키체인 연동)

```bash
ssh-add --apple-use-keychain ~/.ssh/id_ed25519_personal
ssh-add --apple-use-keychain ~/.ssh/id_ed25519_work
# 설정 파일에 반영

cat >> ~/.ssh/config <<'EOF'
Host *
  UseKeychain yes
  AddKeysToAgent yes
EOF
```

### Windows(Git for Windows)

- Git Credential Manager와 병행 가능
- OpenSSH 에이전트 서비스 시작/자동화, 권한 있는 PowerShell 사용

### WSL

- Windows ↔ WSL간 에이전트 소켓 공유 또는 각자 등록
- `chmod`/개행(CRLF) 혼선 주의

---

## 프록시/배스천(점프호스트)/사내망

### ProxyJump(권장)

```sshconfig
Host bastion.company.internal
  HostName bastion.company.internal
  User myid
  IdentityFile ~/.ssh/id_ed25519_work

Host ghe.company.internal
  HostName ghe.company.internal
  User git
  IdentityFile ~/.ssh/id_ed25519_work
  ProxyJump bastion.company.internal
```

### ProxyCommand(레거시)

```sshconfig
Host ghe.company.internal
  HostName ghe.company.internal
  User git
  IdentityFile ~/.ssh/id_ed25519_work
  ProxyCommand nc -X connect -x proxy.company.internal:8080 %h %p
```

호스트키 사전 등록(비대화형 환경):
```bash
ssh-keyscan -t rsa,ecdsa,ed25519 github.com >> ~/.ssh/known_hosts
```

---

## 서브모듈, LFS, 모노레포

### 서브모듈

```bash
git submodule update --init --recursive
# URL을 SSH로 일괄 변환

git config -f .gitmodules submodule.lib.url git@github.com:org/lib.git
git submodule sync --recursive
```

### 얕은 클론 + 서브모듈(대용량 최적화)

```bash
git clone --recurse-submodules --depth 1 git@github.com-work:org/mono.git
git submodule update --init --recursive --depth 1
```

### LFS

```bash
git lfs install
# LFS 포인터만 내려온 경우 다시 체크아웃

git checkout -- .
```

---

## GPG 서명 — 생성부터 Verified까지

### 키 생성

```bash
gpg --full-generate-key
# 유형: RSA and RSA, 길이: 4096, 만료: 선택, 이름/이메일: GitHub와 동일

```

키 목록/ID 확인:
```bash
gpg --list-secret-keys --keyid-format=long
# sec   rsa4096/3AA5C34371567BD2 2025-07-20 [SC]

```

공개키 내보내기(ASCII armor):
```bash
gpg --armor --export 3AA5C34371567BD2
```
GitHub → **Settings → SSH and GPG keys → GPG keys → New GPG key** 등록

### Git에 서명 키 연결

```bash
git config --global user.signingkey 3AA5C34371567BD2
git config --global commit.gpgsign true
# 필요 시 GPG 프로그램 명시

git config --global gpg.program gpg
```

테스트:
```bash
git commit -S -m "feat: enable gpg signing"
git log --show-signature -1
```

태그 서명/검증:
```bash
git tag -s v1.0.0 -m "release 1.0.0"
git tag -v v1.0.0
```

> Pinentry(암호문구 입력 창) 미표시 문제는 gpg-agent/pinentry 설정 확인. Windows는 Gpg4win, macOS는 pinentry-mac 권장.

### 간단 비교

- GPG 대신 **SSH 키로 커밋 서명**도 가능:
```bash
git config --global gpg.format ssh
git config --global user.signingkey ~/.ssh/id_ed25519.pub
git commit -S -m "chore: ssh signing"
```
- 조직 정책/플랫폼 지원에 따라 GPG vs SSH 서명 선택.

---

## CI/CD와 배포 키(Deploy Key), 머신 사용자

- **Deploy Key**: **리포 하나**에만 묶이는 SSH 공개키(읽기 전용/쓰기 가능 선택).
  → CI가 특정 리포만 접근해야 할 때 안전.
- **머신 사용자(Machine User)**: 별도 GitHub 사용자 + PAT/SSH.
  → 여러 리포 접근/권한이 필요하면 머신 사용자 계정이 더 적합.

CI에서 known_hosts 사전 세팅:
```bash
mkdir -p ~/.ssh && chmod 700 ~/.ssh
ssh-keyscan github.com >> ~/.ssh/known_hosts
chmod 644 ~/.ssh/known_hosts
```

---

## 실전 시나리오

### 개인/회사 동시 운용(전체 흐름)

```bash
# 키 생성(이미 있음 가정)
# ~/.ssh/config 구성(개인/회사 별칭)
# 개인 저장소

git clone git@github.com-personal:myuser/pet-repo.git

# 회사 저장소

git clone git@github.com-work:myorg/core-service.git

# 기존 프로젝트를 회사 키로 전환

git remote set-url origin git@github.com-work:myorg/core-service.git
```

### HTTPS에서 SSH로 전환 + 서브모듈 통일

```bash
git remote set-url origin git@github.com:username/app.git
git submodule foreach '
  url=$(git config --get remote.origin.url);
  echo $url | grep -q "^https" && \
  new=$(echo $url | sed "s#https://github.com/#git@github.com:#"); \
  git remote set-url origin $new
'
git submodule sync --recursive
```

### 배스천 경유로 엔터프라이즈 접속

```sshconfig
Host bastion
  HostName bastion.company.internal
  User corpuser
  IdentityFile ~/.ssh/id_ed25519_work

Host ghe
  HostName ghe.company.internal
  User git
  ProxyJump bastion
  IdentityFile ~/.ssh/id_ed25519_work
```
```bash
git clone git@ghe:team/monorepo.git
```

---

## 트러블슈팅(증상 → 원인 → 해결)

| 증상/메시지 | 원인 | 해결 |
|---|---|---|
| `Permission denied (publickey)` | 키 미등록/에이전트 미로딩/`IdentitiesOnly` 미사용/권한(퍼미션) | `ssh-add -l` 확인, 공개키 등록, `chmod 600` 키 파일, `IdentitiesOnly yes` |
| `Host key verification failed` | known_hosts 불일치/중간자 공격 가능성 | `ssh-keygen -R github.com` 후 `ssh-keyscan` 재등록(공식 지문 확인) |
| 계속 HTTPS 크리덴셜 프롬프트 | 원격이 HTTPS | `git remote set-url origin git@...` 로 SSH 전환 |
| 서브모듈 업데이트 실패 | 서브모듈 URL 권한/프로토콜 불일치 | `.gitmodules` SSH로 변경 → `git submodule sync --recursive` |
| GPG 서명 실패/Pinentry 미표시 | gpg-agent/pinentry 설정 문제 | `gpgconf --kill gpg-agent`, pinentry 설치/연결, `gpg --list-secret-keys` 재확인 |
| CI에서 시크릿 노출 우려 | 포크 PR/권한 설계 미흡 | 포크 PR 워크플로우는 시크릿 차단, 배포는 main 브랜치 전용, Deploy Key/머신 사용자 사용 |
| 너무 많은 키 시도 | ssh-agent에 불필요한 키 다수 | `ssh-add -D` 로 초기화 후 필요한 키만 `ssh-add` |

디버깅 팁:
```bash
ssh -vT git@github.com              # 상세 로그
GIT_SSH_COMMAND="ssh -v" git fetch origin
```

---

## 보안 체크리스트

- [ ] ED25519/하드웨어 키 사용, **암호문구 필수**
- [ ] 장비/용도별 키 분리, 분실 시 즉시 폐기
- [ ] 반기/분기 키 회전, **불용 키 삭제**
- [ ] `~/.ssh`/개인키 퍼미션 적정(700/600)
- [ ] `~/.ssh/config`로 **호스트별 키 분기**(별칭)
- [ ] 배포는 Deploy Key/머신 사용자 사용, 시크릿 최소화
- [ ] 서브모듈/LFS/프록시/배스천/멀티플렉싱 고려
- [ ] 문제 시 `ssh -vT` + known_hosts/권한/에이전트 순서로 점검

---

## 명령 모음(요약 스니펫)

```bash
# 키 생성(개인/회사)

ssh-keygen -t ed25519 -a 64 -o -C "me@personal" -f ~/.ssh/id_ed25519_personal
ssh-keygen -t ed25519 -a 64 -o -C "me@company"  -f ~/.ssh/id_ed25519_work

# 에이전트

eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519_personal
ssh-add ~/.ssh/id_ed25519_work

# 연결 테스트

ssh -T git@github.com

# 커스텀 호스트로 clone

git clone git@github.com-personal:username/repo.git
git clone git@github.com-work:company/repo.git

# 원격 전환

git remote set-url origin git@github.com-work:company/repo.git

# GPG

gpg --full-generate-key
gpg --list-secret-keys --keyid-format=long
gpg --armor --export <KEYID>  # GitHub에 등록
git config --global user.signingkey <KEYID>
git config --global commit.gpgsign true
git commit -S -m "feat: signed commit"

# known_hosts

ssh-keyscan github.com >> ~/.ssh/known_hosts
```

---

## 참고 자료

- GitHub SSH 설정: https://docs.github.com/en/authentication/connecting-to-github-with-ssh
- SSH config 매뉴얼: https://linux.die.net/man/5/ssh_config
- Git GPG 서명: https://docs.github.com/en/authentication/managing-commit-signature-verification
