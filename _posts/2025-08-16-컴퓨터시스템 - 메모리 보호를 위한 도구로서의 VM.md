---
layout: post
title: 컴퓨터시스템 - 메모리 보호를 위한 도구로서의 VM
date: 2025-08-16 22:20:23 +0900
category: 컴퓨터시스템
---
# 메모리 보호를 위한 도구로서의 가상 메모리(VM)

가상 메모리(Virtual Memory)는 단순히 프로그램이 물리 메모리를 직접 다루지 않게 하는 기능이 아니라, **프로세스 간 메모리 보호**, **커널 보호**, **잘못된 메모리 접근 차단** 등 시스템 안정성을 위한 핵심 보안 장치이기도 합니다. 운영체제와 하드웨어는 VM을 이용해 모든 메모리 접근을 제어하고, 허용되지 않은 접근 시 **예외(Exception)**를 발생시켜 프로세스를 안전하게 종료하거나 오류를 처리합니다.

---

## 1. 메모리 보호의 필요성
1. **프로세스 간 침범 방지**  
   - 한 프로세스가 다른 프로세스의 데이터를 읽거나 쓰면 보안과 안정성이 심각하게 훼손됩니다.
   - VM은 각 프로세스에 독립적인 가상 주소 공간을 부여해 물리 메모리를 격리합니다.

2. **커널 메모리 보호**  
   - 운영체제 커널은 하드웨어 제어, 파일 시스템, 네트워크 등 핵심 기능을 수행하므로 일반 프로그램이 임의로 접근할 수 없게 해야 합니다.
   - 가상 메모리는 커널 영역을 사용자 영역과 분리하고, 접근 권한을 제한합니다.

3. **잘못된 포인터 참조 방지**  
   - 잘못된 주소를 참조하는 포인터 버그는 치명적입니다.
   - VM은 매핑되지 않은 주소 접근 시 페이지 폴트(Page Fault)를 발생시켜 문제를 발견하게 합니다.

---

## 2. 하드웨어 기반 보호 메커니즘

### (1) MMU(Memory Management Unit)와 페이지 테이블
- **MMU**는 가상 주소 → 물리 주소 변환 과정에서 페이지 테이블에 정의된 **권한 비트(Protection Bits)**를 확인합니다.
- 권한 비트 예:
  - **R(Read)**: 읽기 가능 여부
  - **W(Write)**: 쓰기 가능 여부
  - **X(Execute)**: 실행 가능 여부

### (2) 페이지 보호 예시
| 구역 | R | W | X | 설명 |
|------|---|---|---|------|
| 코드 영역(Text) | ✅ | ❌ | ✅ | 실행 가능, 쓰기 금지 |
| 데이터 영역(Data) | ✅ | ✅ | ❌ | 읽기/쓰기 가능, 실행 불가 |
| 스택(Stack) | ✅ | ✅ | ❌ | 실행 불가, 오직 데이터 저장 |

---

## 3. 소프트웨어 기반 보호 메커니즘

### (1) 페이지 폴트(Page Fault)
- 프로그램이 권한이 없는 페이지에 접근 시 CPU가 페이지 폴트를 발생.
- OS는 이를 감지해:
  - 메모리를 로드하거나,
  - 권한 위반 시 프로세스를 강제 종료(SIGSEGV 시그널).

### (2) 주소 공간 분리
- 사용자 모드(User Mode)와 커널 모드(Kernel Mode)로 분리.
- 시스템 콜(System Call)만을 통해 커널 자원 접근.

---

## 4. 공유 메모리와 보호
VM은 **공유 메모리(Shared Memory)**를 통해 프로세스 간 데이터 교환을 허용하되, 권한 제어로 보안을 유지합니다.
- 예: `mmap()`으로 매핑 시 `PROT_READ | PROT_WRITE` 권한 지정 가능.
- 서로 다른 권한으로 같은 물리 페이지를 매핑해 읽기 전용 접근 가능.

---

## 5. 메모리 보호 관련 예제 (C)
```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>

int main() {
    // 1페이지 크기의 읽기 전용 메모리 할당
    char *mem = mmap(NULL, 4096, PROT_READ, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
    if (mem == MAP_FAILED) {
        perror("mmap");
        exit(1);
    }

    strcpy(mem, "Hello"); // 여기서 SIGSEGV 발생 (쓰기 불가 페이지)
    munmap(mem, 4096);
    return 0;
}
```
- 위 코드는 읽기 전용으로 매핑된 메모리에 쓰기를 시도 → **세그멘테이션 폴트(SIGSEGV)** 발생.

---

## 6. 실행 방지(XD/NX 비트)
- 현대 CPU는 **NX(No-eXecute) 비트** 또는 **XD(eXecute Disable) 비트**로 데이터 영역에서의 코드 실행을 방지.
- 스택/힙에 저장된 데이터가 악성 코드로 실행되는 것을 차단.

---

## 7. 보호 메커니즘 요약
1. **주소 공간 격리**: 각 프로세스별 독립적인 가상 주소 공간.
2. **권한 비트 관리**: 읽기, 쓰기, 실행 권한 제어.
3. **페이지 폴트 처리**: 잘못된 접근을 감지하고 차단.
4. **NX/XD 비트**: 데이터 영역 코드 실행 방지.
5. **커널 보호**: 사용자 영역에서 커널 메모리 접근 차단.

---

## 8. 결론
메모리 보호를 위한 VM은 **하드웨어(MMU)와 운영체제의 긴밀한 협력**으로 동작하며,  
이를 통해 현대 시스템은 안정성과 보안을 유지합니다.  
이 보호 장치는 단순히 개발자의 실수를 잡아내는 용도뿐 아니라,  
악의적인 공격(버퍼 오버플로우, 코드 인젝션 등)을 방어하는 중요한 방패 역할을 합니다.