---
layout: post
title: TCPIP - UDP
date: 2025-08-29 22:25:23 +0900
category: TCPIP
---
# 8. UDP
**(🔰 헤더 구조·체크섬·비연결/비신뢰, ⚙️ 실사용 예: DNS/스트리밍/실시간, 🚀 손실·지연 환경 설계 포인트)**

> 이 글은 UDP를 **프로토콜 스펙→운영→설계** 순으로 정리합니다.  
> “헤더·체크섬·비연결성”의 본질부터 **DNS, RTP/RTCP, WebRTC/QUIC, 게임** 같은 실사용 패턴, 그리고 **손실·지연·지터 환경에서의 실전 설계 포인트**(MTU·FEC·NACK·재생버퍼·혼잡제어·보안/증폭 방지)까지 **예제·수식·체크리스트**로 설명합니다. 수식은 MathJax, 코드/명령은 ```로 표기합니다.

---

## 8.1 왜 UDP인가
- **비연결·경량(8바이트 헤더)** → **지연에 민감한 실시간**(음성/영상/게임/센서)에서 유리.  
- **응용이 전송을 직접 설계**(혼잡·복구·보안·다중화) → **자유도가 높고 책임도 큼**.  
- 오늘날 **QUIC(HTTP/3)**, **WebRTC**, 다수의 실시간 전송이 UDP 위에서 동작.

---

## 8.2 UDP 헤더 구조 & 체크섬 (🔰)

### 8.2.1 헤더(8B)
```
0               15 16              31 (bit)
+----------------+------------------+
| Source Port    | Destination Port |
+----------------+------------------+
| Length         | Checksum         |
+----------------+------------------+
|            (Payload …)           |
```
- **Source/Destination Port**: 0~65535 (0은 특수).  
- **Length**: **UDP 헤더 + 페이로드 총 길이**(바이트).  
- **Checksum**: 1의 보수 합(IPv4에서는 0=미사용 허용, **IPv6에서는 필수**).

### 8.2.2 체크섬 계산(요지)
- **의사 헤더(pseudo-header)** 포함 합산 → **종단 간 오류 검출** 강화.
  - IPv4: SrcIP, DstIP, Protocol(17), UDP Length  
  - IPv6: SrcIP, DstIP, UDP Length, Next Header(17)
- 페이로드 길이가 홀수면 **패딩 0**으로 맞추어 합산.
- \[
  \text{Checksum} = \neg\Big(\sum\nolimits_{16\text{-bit words}} \text{word}\Big)_{1\text{'s complement}}
  \]
- **IPv6에서 0 체크섬은 금지** → 드라이버/오프로드 장치가 반드시 계산.

> **관찰 포인트**: 캡처에서 UDPv4 체크섬이 `0x0000`이면 **옵션 미사용**일 수 있음(허용). UDPv6는 `0x0000`이면 **불가**.

---

## 8.3 비연결/비신뢰 특성 (🔰)
- **연결 수립 없음**(SYN/ACK 같은 핸드셰이크 X), **상태 없는 전송** → **초고속 시작**, **오버헤드 최소화**.  
- **신뢰성 보장 없음**: **손실/중복/순서 뒤바뀜/흐름제어 부재** 가능.  
- **혼잡제어 없음**: 네트워크 보호를 위해 **응용이 스스로** 레이트·혼잡 반응을 구현해야 함(RFC 8085 가이드라인).  
- **분할/재조립**은 IP 레이어가 담당 → **대형 UDP**는 IP 프래그먼트 의존(권장 X).  
- **NAT/방화벽**: UDP는 **세션 타임아웃 짧음**(수~수십 초). **주기적 keepalive** 필요(예: 15–30s).

---

## 8.4 실사용 예 (⚙️)

### 8.4.1 DNS
- **기본 UDP/53**. 작은 쿼리/응답에 최적.  
- **EDNS(0)**로 UDP 페이로드 확장(일반적으로 1232~4096 설정)하지만, **프래그먼트/PMTUD 실패** 위험 → **큰 응답은 TCP로 폴백**(TC=1).  
- **증폭 공격 방지** 위해 재귀/오픈 리졸버 노출 금지, **RRL(rate limiting)** 적용.

### 8.4.2 RTP/RTCP(실시간 음성/영상)
- **RTP(미디어)** + **RTCP(통계/제어)** 쌍. 보통 **연속된 UDP 포트 2개** 사용.  
- **지터 버퍼**로 패킷 도착 변동 흡수, **패킷 손실 은닉(PLC)**, **FEC/재전송 제한적 사용**.  
- RTCP에서 **jitter/packet loss/RTT 추정**을 교환해 동적 비트레이트(ABR)나 전송 파라미터 조정.

### 8.4.3 WebRTC(브라우저 실시간 P2P)
- **SRTP(보안 RTP)**, **STUN/TURN/ICE**, **DTLS**(키 교환) 모두 **UDP 우선**.  
- **NAT 종류** 따라 **직접경로 실패 시 TURN 릴레이**.  
- **콘텐츠 적응(선택적 재전송·FEC·SVC 등)**으로 손실/지연에 대응.

### 8.4.4 QUIC/HTTP/3
- **UDP 위 사용자 공간 전송**. **암호화(TLS1.3) + 혼잡제어 + 멀티플렉스** 통합.  
- **대역폭 추정/손실복구**는 TCP에서 차용(CUBIC/BBR 등), **헤드오브라인 블로킹 완화**, **0-RTT** 가능.

### 8.4.5 그 외
- **DHCP**, **NTP**, **SNMP**, **TFTP**, **Syslog(UDP 514)** 등 **경량 제어/관리**.  
- **게임/IoT 텔레메트리**: 주기적 상태 업데이트(순서/일부 손실 허용).

---

## 8.5 손실·지연·지터 환경에서의 설계 포인트 (🚀)

### 8.5.1 MTU/프래그먼트 회피
- **원칙: IP 프래그먼테이션 피하기.**  
- **인터넷 안전 크기**: **\(\approx 1200\)B UDP 페이로드**(QUIC 최소/경험칙).  
- 경로에 오버레이(VXLAN/GRE/QinQ)가 있으면 **더 낮춰**(예: 1120/1160B 등).  
- ICMP 불통/PMTUD 실패 대비 → **작은 세그먼트, MSS/패킷화 보수적**.

### 8.5.2 전송 속도·페이싱·혼잡 친화성
- **버스트 전송 금지**: **페이싱**(간격을 두고 송신)으로 큐 정체/드롭 감소.  
- **혼잡 친화성**: **손실·ECN**에 반응해 전송률 감소(자체 구현 or QUIC 사용).  
- **지속적 측정**: 단위 시간 손실률 \(p\), RTT \(\tau\), 지터 \(\sigma\)를 추정 → 레이트 적응.

### 8.5.3 손실 복구 전략
**A. 재전송(ARQ)**  
- **NACK 기반**(비디오 키프레임/선택적): 손실 패킷 ID를 알리고 **선택적 재전송**.  
- **지연 제한**: 재전송 왕복 지연이 **재생기한**을 넘기면 무의미 → **I-프레임 대체/에러은닉**.

**B. FEC(Forward Error Correction)**  
- **XOR/RS/라플라스/라프터(라퐁틴)** 등 코드로 **추가 패킷** 전송.  
- \[
  \text{복원 가능 손실률} \approx \frac{r}{k+r}
  \]
  - \(k\): 원본, \(r\): 보호 패킷 수. 예) \(k=10, r=2\) → \(\approx 16.7\%\) 이내 손실 복원(분산 가정).  
- **오버헤드·지연**과 **복구율** 트레이드오프.

**C. 하이브리드(H-ARQ)**  
- **소량 FEC + 제한적 재전송**. 실시간에서 흔한 절충.

### 8.5.4 인터리빙 & 재생(지터) 버퍼
- **인터리빙**: 연속 샘플을 시간적으로 섞어 손실을 **얕고 넓게** 만들어 은닉 쉬움.  
- **지터 버퍼**: 처음에 **배수 프레임 지연**을 허용해 변동 흡수.  
- **RTP 지터 추정식(표준 근사)**:
  \[
  J \leftarrow J + \frac{|(D_i - D_{i-1})| - J}{16}
  \]
  - \(D_i\): i번째 패킷의 **상대 도착 간격 변동**.  
- **버퍼 동적 조절**: 실시간 회의는 30–150ms 범위에서 자동 조정, 방송/스트리밍은 1–3초 버퍼링.

### 8.5.5 시간 동기화 & 타임스탬프
- **NTP/PTP**, **RTCP SR**로 송수신 **클록 드리프트** 교정.  
- **타임스탬프 기반 보정**으로 **AV 동기**, **재생 스케줄링** 안정화.

### 8.5.6 순서/중복/중복제거
- **시퀀스 번호**로 **재정렬 버퍼** 운용(윈도우 수십 패킷).  
- **중복 전송**(중요 프레임 이중 송신)과 **중복 제거**(ID 캐시)로 신뢰성 향상.

### 8.5.7 다중 경로/경로 전환
- **멀티홈/다중 인터페이스**(Wi-Fi+LTE): **이중화/분산**(패킷 or 흐름 단위).  
- **빠른 페일오버**: 상위(QUIC/애플리케이션)에서 **경로 검증·전환**.  
- **패킷 듀얼샷**(중요 패킷을 두 경로로)로 손실 확률 제곱 감소.

### 8.5.8 보안 & 증폭/오용 방지
- **DTLS/SRTP**로 암호화/무결성/인증.  
- **증폭 방지**: “작은 요청 → 큰 응답” 패턴 제한, **쿠키/토큰** 검증, **초기 3× 앰플리피케이션 제한(QUIC 유사)**.  
- **Port scan/反사 방지**: 레이트 리밋, 응답 축약, **대칭 경로 확인**.

### 8.5.9 QoS 마킹 & ECN
- **DSCP**로 우선순위(예: EF=음성). 도메인 경계 재마킹 가능 → **엔드-투-엔드 보장 X**.  
- **ECN**(CE 마킹) 활용 시 **드롭 없이 혼잡 신호** 수집(상위 전송이 반응하도록 설계 필요).

---

## 8.6 예제 시나리오

### 8.6.1 DNS: UDP→TCP 폴백 & EDNS 크기
```text
1) 클라 → 재귀: A? (UDP, EDNS bufsize=1232)
2) 응답 크기 > 1232 → TC=1 설정하여 '잘림' 응답
3) 클라: TCP로 재질의 → 완전 응답 수신
운영: EDNS bufsize를 1232±로 보수 설정(프래그먼트 회피)
```

### 8.6.2 RTP/RTCP: 지터·손실 대응
```text
- 송신: 20ms 프레임(VoIP), 패킷당 160샘플(8kHz)
- 수신: 지터 버퍼 60ms 시작 → 네트워크에 따라 40~120ms 자동 조정
- 손실: 2% 수준 → PLC(보간) + 저강도 FEC(1/10) 적용
- RTCP: 5s 간격 리포트로 누적 손실/지터/RTT 공유 → 전송률/코덱 비트레이트 조정
```

### 8.6.3 WebRTC: ICE/NAT 우회
```text
- 후보: host(사설) / srflx(STUN 공인) / relay(TURN)
- 체크: 각 후보쌍 연결성 테스트 → 우선순위 최대 경로 선택
- 대칭 NAT/CGNAT에서 직결 실패 → TURN 릴레이 자동 사용
- Keepalive: STUN Binding(수십 초 간격)로 NAT 매핑 유지
```

### 8.6.4 게임: 상태 업데이트 & 보정
```text
- 60Hz 틱, 20~30Hz UDP 스냅샷: 위치·속도·입력 해시 포함
- 클라: '프레딕션'으로 입력 즉시 반영, 서버 스냅샷 도착 시 '리콘실리에이션'
- 손실: 동일 스냅샷을 2회 얕게 중복 송신(dupe) → 체감 순간 텔레포트 감소
- 지연: 보정 윈도우 100ms, 중요 이벤트(격발)는 보장 채널(재전송/확인) 사용
```

---

## 8.7 운영·진단 체커

### 8.7.1 송신 측
```text
- 패킷 크기: 1000~1200B 목표(오버레이/태그 고려)
- 페이싱: burst off, pacing on
- 리드/라그(코덱/인코더) 지연 상한 문서화
- FEC 비율, 재전송 마감기한(deadline) 설정
- DSCP 마킹(도메인 정책 확인), ECN 활성화 여부
```

### 8.7.2 경로/네트워크
```text
- NAT 타임아웃: UDP 15~60s? keepalive 주기 일치?
- ICMP Too Big/Frag Needed 허용(경로 MTU 알림)
- Wi-Fi 환경: 전송률 자동조정/지터 증가 대비(버퍼 완충)
- 큐/혼잡: AQM(RED/CoDel)·ECN 정책 확인
```

### 8.7.3 수신 측
```text
- 지터 버퍼 시작/상한(VoIP 30~150ms, 회의 60~200ms)
- 재정렬 윈도우(시퀀스 기반), 중복 제거
- NACK 윈도우·빈도, 재전송 한계 시간 τ_NACK < 재생기한
- RTCP/텔레메트리로 loss/RTT/jitter 지속 수집
```

---

## 8.8 수식·감각 메모

### 8.8.1 유효 처리량(조악 근사)
\[
\text{Goodput} \approx \frac{\text{Payload}}{\text{Payload} + \text{L2/3/4 Overheads}} \times \text{Rate}
\]
- L2(이더넷 14+FCS4), L3(IPv4 20/IPv6 40), UDP 8, RTP 12 등을 합산.

### 8.8.2 손실·FEC 트레이드오프
\[
\text{Overhead} = \frac{r}{k}, \quad \text{복구율} \uparrow \Rightarrow \text{지연/오버헤드} \uparrow
\]
- 낮은 지연이 최우선이면 **얕은 FEC + 제한적 NACK**.

### 8.8.3 재생 버퍼 지연
\[
\text{Startup Latency} \approx \text{초기 버퍼 깊이} + \text{디코딩 파이프라인 지연}
\]
- 라이브 방송은 초기 버퍼를 길게(수 초), 대화용은 짧게(수십 ms).

---

## 8.9 보안·건전성

- **DTLS/SRTP**로 기밀·무결·인증. 키 교환/재키(키 롤) 관리.  
- **증폭/반사 공격 완화**: 응답 크기 상한, **주소 검증 후 확대 송신(anti-amplification)**, RRL.  
- **권한 없는 포트 오픈 차단**: UPnP/PCP 제한, 로그/승인제.  
- **DDoS 내성**: Anycast 리졸버/미디어 엣지, 레이트리밋/도메인 분리, **초기 도착 요청 샘플링 후 확대**.

---

## 8.10 미니 랩(현장 손맛)

### 8.10.1 `tc netem`으로 손실/지연 재현
```bash
# 50ms 지연, 5ms 지터, 2% 손실, 0.1% 듀플리케이트
sudo tc qdisc add dev eth0 root netem delay 50ms 5ms loss 2% duplicate 0.1%
# 제거
sudo tc qdisc del dev eth0 root
```
- **관찰**: RTCP 통계, 재생버퍼 인/아웃, NACK 빈도, 평균 비트레이트 변화.

### 8.10.2 MTU 안전 크기 검증
```bash
# DF 유지한 큰 UDP 패킷 전송(개념 도구 사용)
# Too Big/Frag Needed 수신 여부 확인 → 안전 페이로드 결정
```

### 8.10.3 FEC 비율 스윕
```text
k=10, r ∈ {1,2,3} 테스트 → 손실 5~15% 구간에서 화질/지연/오버헤드 비교
결과를 기반으로 실서비스 목표 손실률(예: <8%)에서 최적 r 선택
```

### 8.10.4 NAT Keepalive 최적화
```text
UDP NAT timeout 30s 환경 가정 → 15~20s STUN keepalive
지나치게 짧으면 배터리/비용↑, 길면 매핑 소실로 '무음' 발생
```

---

## 8.11 체크리스트(요약 카드)

- **헤더/체크섬**: IPv6는 체크섬 필수, 의사헤더 포함.  
- **MTU**: 프래그먼트 금지, **~1200B 목표**(경로/오버레이 고려).  
- **혼잡**: 페이싱·ECN·손실에 반응(자체 구현 or QUIC).  
- **복구**: **얕은 FEC + 제한적 재전송**(기한 내)·인터리빙·PLC.  
- **버퍼**: 지터 버퍼 동적, 재정렬 윈도우/중복 제거.  
- **NAT**: keepalive·ICE/TURN, Hairpin/스플릿 DNS 고려.  
- **보안**: DTLS/SRTP, 증폭 제한, RRL.  
- **지표**: loss/RTT/jitter/해당 구간 P95/P99, 시작지연, 프레임 드롭률.

---

## 8.12 한 장 요약(포스터)
- **UDP**는 **단순·경량**이지만 **신뢰/혼잡/순서**를 **응용이 책임**.  
- **DNS·RTP/RTCP·WebRTC·QUIC** 등에서 핵심 전송.  
- **설계 키워드**: **작은 패킷**, **페이싱**, **혼잡 반응**, **FEC+NACK 절충**, **지터 버퍼**, **NAT 우회**, **보안/증폭 방지**.  
- “**낮은 지연 vs 높은 복원력**”의 **트레이드오프**를 서비스 특성에 맞게 조정하라.

---

### 부록 A — UDP 기반 스택 한눈도
```
[App]—(코덱/ABR/ARQ/FEC/암호화)—[UDP]—[IP(ECN/DSCP/PMTUD)]—[L2]
         ↑           ↑
       RTCP       STUN/TURN/ICE(필요시)
```

### 부록 B — 텔레메트리 필드 제안
```text
ts, ssrc/flow_id, seq, marker, size, send_ts, recv_ts,
oneway_ms, rtt_ms, jitter_ms, loss_run_len, fec_used, nack_req, nack_hit,
abr_bitrate_kbps, playout_buf_ms, dscp, ecn_ce
```

### 부록 C — 운영 템플릿
```text
[환경] Wi-Fi/셀룰러/유선, NAT 타입, MTU, AQM/ECN
[목표] 지연 상한, 손실 허용률, 스타트업 지연, 평균/최대 비트레이트
[설계] 패킷 크기/페이싱, FEC r/k, NACK 한계시간, 버퍼 범위, QoS/ECN
[보안] DTLS/SRTP, 앰플리피케이션 한도, RRL
[관측] loss/RTT/jitter(P50/P95/P99), nack/fec 효용, 버퍼 언더런, QoE/MOS
[실험] netem 시나리오표, 경로·시간대별 A/B, 릴리스 게이팅 기준
```