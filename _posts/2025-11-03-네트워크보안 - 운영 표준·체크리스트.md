---
layout: post
title: 네트워크보안 - 운영 표준·체크리스트
date: 2025-11-03 19:25:23 +0900
category: 네트워크보안
---
# 운영 표준·체크리스트

> 목표
> - **분기별 네트워크 보안 헬스체크**를 “문서→측정→개선” 주기로 표준화한다.
> - **변경관리·룰 리뷰·히트(사용) 분석**을 자동화해, **쌓이는 규칙**과 **죽은 규칙**을 체계적으로 제거한다.
> - **DR(재해복구) 관점**에서 네트워크를 **핫/웜/콜드** 시나리오로 설계하고, 라우팅/보안 정책의 **일관성 검증**을 포함한다.
> - **실습**: 실제처럼 만든 ACL/보안그룹/방화벽 규칙에서 **Shadow Rule(상위 규칙에 가려져 매칭되지 않는 규칙)**을 자동 탐지·삭제하는 워크숍을 수행한다.

---

## 분기별 네트워크 보안 헬스체크

### 헬스체크의 5축(5 Axes)

1) **가시성(Visibility)**: 로그 수집/메트릭/플로우(Proxy, DNS, NetFlow/IPFIX, FW, WAF, LB, VPN, ZTNA, K8s NetworkPolicy)
2) **정책(Policy)**: L3/L4/L7 룰 최소권한, **deny-by-default**, Shadow/중복/오타(Any/Any) 제거
3) **노출(Exposure)**: 인터넷 노출 서비스/포트/경로, 퍼블릭 엔드포인트/보안그룹 과다 허용
4) **탄력(Resilience)**: 이중화, 경로 수렴, BFD/BGP Max-Prefix, DDoS/레이트리밋, 캐시/프록시 적중률
5) **DR/복구력(Recoverability)**: 핫/웜/콜드 경로 시험, 구성 백업/스냅샷, 인프라 코드(IaC) 재현성

### 분기별 헬스체크 표준 절차(1~2주)

- **W1-D1: 범위 정리**
  - 대상: **경계/지사/클라우드/VPC/K8s/프록시/WAF**
  - 최신 네트워크 다이어그램/주소계획/라우팅 정책/방화벽 객체 **취합**
- **W1-D2~D3: 데이터 수집**
  - 장비 설정 백업(버전+해시), 룰 Export, NetFlow/로그 샘플
  - 공개 노출 스캔(Nmap/Naabu), Cloud SG 인벤토리(읽기 전용)
- **W1-D4: 자동 분석**
  - Shadow/중복/Any-Any/묶음 포트 검출, SG 과다 허용, **미사용 객체**
  - 히트 카운트(Top/Zero), 정책 편차(표준 템플릿 대비 변형)
- **W1-D5: 리포트 초안**
  - 위험/영향/개선안(ROI + 리스크) + **승인 필요 변경 목록(Change Set)**
- **W2: 리뷰 & 적용 계획**
  - CAB(Change Advisory Board) 통과 → 카나리 변경 → 점진 적용/롤백 경로 명시

**핵심 출력물**
- **Executive Summary**(1p): 상위 5개 리스크/비용-효과/적용 일정
- **Tech Appendix**: 규칙 리스트/히트 통계/탐지 쿼리/드리프트 비교 결과

### 체크리스트(핵심 30문)

**정책·룰**
- [ ] 인터페이스/존 별 **기본 거부**(Implicit/Explicit Deny) 구현
- [ ] **Any/Any** 예외는 사유/만료일/소유자 기록
- [ ] 동일/상위 규칙에 **완전히 포함**되는 규칙(Shadow) 없음
- [ ] **중복 객체/주소그룹** 제거, 네이밍 규칙 준수

**가시성**
- [ ] FW/프록시/DNS/WAF/LB/K8s/Cloud SG 로그 **집중 수집**
- [ ] NetFlow/IPFIX 또는 **유사 흐름 지표** 확보
- [ ] TLS 가시성: SNI/JA3/서버측 지표(오리진 RPS, p95) 수집

**노출**
- [ ] 퍼블릭 IP/포트 인벤토리 최신, 외부 스캔 결과 **합치**
- [ ] 관리 인터페이스(SSH/WinRM/VPN/WebUI) **접근제한**(ZTNA/Jump)
- [ ] WAF/헤더 보안/HSTS/H2/H3 정책 확인

**탄력·DR**
- [ ] HA/이중화 상태/Failover 테스트 로그
- [ ] BGP/VRRP/ECMP/Max-Prefix/RTBH/FlowSpec 구성
- [ ] DR: 핫/웜/콜드 경로 및 **DNS/Failover/Healthcheck** 검증 결과

---

## 변경관리·룰 리뷰·히트 분석

### 원칙

- **RFC(요청) → 동료 리뷰 → CAB 승인 → 카나리 → 전체 적용 → 회고**
- **버전 관리**: 장비 설정/룰/SG를 **Git 저장소**로 보관(민감정보 제거)
- **릴리즈 단위**: “업무 플로우” 기준(서비스 단위), **롤백 스크립트 포함**

**RFC 템플릿(요약)**
```
- 제목: [FW] UserLAN→DB 신규 플로우 허용(5432/TCP)
- 배경: 분석팀 신규 리포트 기능 (JIRA #AN-1234)
- 범위: CoreFW-A/B, VPC-SG-Prod
- 변경: ACL/FQDN/SG diff 첨부
- 영향: 예상 RPS+지연, 대체 경로
- 테스트: Stg 환경 규칙/흐름 검증 결과
- 롤백: 이전 룰셋 복원 스크립트
- 만료: 임시 예외(만료일 2026-01-31)
- 소유자: data-team@, 네트워크@ (공동)
```

### 룰 리뷰(정량화 포인트)

- **루ール 매수**: 인터페이스/존 당 상한(예: 500/존)
- **Any/Any/Any** 카운트, **허용**:차단 비율
- **Hit Ratio**: Top 10%가 전체 트래픽의 몇 %를 커버?
- **Zero-Hit 규칙**: 90일(또는 180일) **0 히트** → 제거 후보
- **Shadow/중복**: 자동 분석 스코어(0~100) → 70↑ 시 제거 권고

### 히트 분석(예: Elastic KQL/SQL)

**방화벽 로그 인덱스 가정(`fw-*`)**

- **규칙별 히트 Top-N**
```kql
index: fw-* action:"allow"
| stats count() as hits by rule.id, rule.name
| sort hits desc | head 20
```

- **Zero-Hit 후보**
```kql
index: fw-*
| stats count() as hits by rule.id, rule.name
| where hits == 0
```

- **의심스러운 광범위 규칙(Any/Any)**
```kql
index: fw-* action:"allow"
| where source.ip == "*" and destination.ip == "*" and destination.port == "*"
```

- **Cloud SG 오픈(0.0.0.0/0)**
```kql
index: cloud-sg-*
| where cidr == "0.0.0.0/0" and port in (22,3389,445)
```

### — 구성 백업 & Diff

**Bash: 장비 설정 백업**
```bash
#!/usr/bin/env bash

set -euo pipefail
HOSTS=("fw-a" "fw-b" "edge" "core")
DEST="./backup/$(date +%F)"
mkdir -p "$DEST"
for h in "${HOSTS[@]}"; do
  ssh -o BatchMode=yes netbackup@$h "show running-config" > "$DEST/$h.cfg"
  sha256sum "$DEST/$h.cfg"
done
```

**Python: 이전 버전과 Diff 요약**
```python
import difflib, pathlib, sys
cur=pathlib.Path(sys.argv[1]); prev=pathlib.Path(sys.argv[2])
for f in cur.glob("*.cfg"):
    p = prev/f.name
    if not p.exists():
        print("[NEW]", f.name); continue
    a, b = p.read_text().splitlines(), f.read_text().splitlines()
    for line in difflib.unified_diff(a,b,fromfile=str(p),tofile=str(f)):
        if any(k in line for k in ("permit","deny","object-group","route ")):
            print(line)
```

---

## DR 관점의 네트워크(핫/웜/콜드)

### 용어 정리

- **핫(Hot)**: 실시간 복제/동기 또는 근실시간 비동기, **즉시 전환**(DNS/Anycast/Healthcheck).
- **웜(Warm)**: 주기 동기화(분~시간), **수동 전환**(라우팅 변경/AS-Path 조정/경로 광고).
- **콜드(Cold)**: 백업/스냅샷만, **복구 시간 길다**(시간~일). 네트워크/보안 정책 재적용 필요.

### 네트워크 구성 핵심

- **라우팅**: BGP 피어링(핫: Active/Active/ECMP, 웜: Preconfig + 침묵 광고, 콜드: 비활성)
- **보안정책**: 동일 룰셋/객체를 **IaC로 배포**(템플릿/변수), **CIDR/SG/NetworkPolicy** 동기화
- **이름해결/DNS**: **짧은 TTL** + 헬스체크 기반 Failover(LB/WAF/CDN)
- **상태**: 세션 일관성(스테이트풀 장비는 **동기화/세션 비활성화** 고려)

### DR 표준 테스트(분기)

| 테스트 | 핫 | 웜 | 콜드 |
|---|---|---|---|
| DNS 전환/헬스체크 | 자동 | 수동(스크립트) | 수동 |
| BGP 경로 전환 | 자동(ECMP) | 수동(Preconfig) | n/a |
| FW 정책 합치 | 자동(IaC 배포) | 자동 | 수동 |
| 애플리케이션 연결성 | 합격 기준 p95<2x | p95<3x | 수동 체크 |
| 롤백 | 즉시 | 15분 내 | 1h 내 |

**전환 스크립트(예: BGP 로컬프리퍼런스 변경)**
```bash
ssh netops@edge-dr "configure
set protocols bgp group WAN neighbor 203.0.113.1 local-preference 200
commit and-quit"
```

**DNS Failover(API 개념)**
```bash
curl -X POST "https://dns.api/provider" \
  -d '{"record":"api.example.com","targets":["1.2.3.4"],"ttl":30}'
```

---

## 실습: Shadow Rule 제거 워크숍

> **목표**: ACL/보안그룹/방화벽 규칙에서 **Subset(포함관계)**을 계산해,
> 상위 규칙이 **완전히 포괄**하는 하위 규칙(Shadow)을 자동 검출·레포트·제거 계획까지 도출한다.

### Shadow Rule의 정의

- **정의**: 룰 A가 트래픽 집합 `T(A)`를, 룰 B가 `T(B)`를 허용(또는 차단)할 때,
  `T(B) ⊆ T(A)` 이고 **A가 B보다 위에** 있으면 B는 **매칭되지 않음**(Shadow).
- **유형**
  1) **정확 포함**: (src/dst/포트/프로토콜/시간/인터페이스)가 상위가 더 **넓음**
  2) **객체그룹 확장**: 그룹 멤버 때문에 포함
  3) **순서 충돌**: 상단 deny가 하단 allow를 덮음(의도 여부 확인 필요)

### 입력 포맷(예시)

```csv
# rules.csv

id,order,action,src,dst,proto,port,comment
R1,10,allow,10.10.0.0/16,10.20.30.40/32,tcp,443,Wide allow
R2,20,allow,10.10.10.0/24,10.20.30.40/32,tcp,443,Subset of R1
R3,30,deny,any,any,any,any,Block all (implicit)
R4,25,allow,10.10.0.0/16,10.20.30.40/32,tcp,443,Duplicate of R1 (lower)
R5,15,deny,10.10.10.5/32,10.20.30.40/32,tcp,443,Specific deny before allow
```

### Shadow/중복 탐지 알고리즘(개요)

- **정규화**: `any` → `0.0.0.0/0`, `any port` → `1-65535`
- **집합 비교**:
  - IP: CIDR 포함여부(`netB ⊆ netA`)
  - Port: 범위 포함(`[pB] ⊆ [pA]`)
  - Proto: 동일 또는 상위(예: any 포함)
- **판정**:
  - **중복(Duplicate)**: 동작/조건 완전 동일, 순서만 다름
  - **Shadow(Allow-Allow)**: 위의 허용이 아래 허용을 포괄
  - **Shadow(Deny-Allow)**: 상단 Deny가 하단 Allow를 가림(중요/위험)
- **제외 규칙**: 주석에 `#keep` 또는 만료일 미도래(예외) → 리포트만

### 파이썬 스크립트: Shadow/중복 탐지

```python
# shadow.py

import ipaddress, csv, sys
from typing import Tuple

ANY_IP = ipaddress.ip_network("0.0.0.0/0")

def parse_ip(s:str):
    return ANY_IP if s in ("any","*") else ipaddress.ip_network(s, strict=False)

def parse_port(s:str) -> Tuple[int,int]:
    if s in ("any","*",""): return (1,65535)
    if "-" in s:
        a,b = s.split("-",1); return (int(a), int(b))
    return (int(s), int(s))

def contains(a1,a2):  # a1 ⊇ a2 for IP network
    return a2.subnet_of(a1)

def port_contains(A:Tuple[int,int], B:Tuple[int,int]):
    return A[0] <= B[0] and A[1] >= B[1]

def proto_contains(pA, pB):
    return pA in ("any","*") or pA == pB

def normalize(row):
    return {
        "id":row["id"],
        "order":int(row["order"]),
        "action":row["action"].lower(), # allow/deny
        "src":parse_ip(row["src"]),
        "dst":parse_ip(row["dst"]),
        "proto":row["proto"].lower(),
        "port":parse_port(row["port"]),
        "comment":row.get("comment","")
    }

def is_same(a,b):
    return (a["action"]==b["action"] and a["src"]==b["src"] and a["dst"]==b["dst"]
            and a["proto"]==b["proto"] and a["port"]==b["port"])

def is_subset(a,b):
    # a ⊇ b ?
    return (contains(a["src"], b["src"]) and contains(a["dst"], b["dst"])
            and proto_contains(a["proto"], b["proto"])
            and port_contains(a["port"], b["port"]))

rows = [normalize(r) for r in csv.DictReader(open(sys.argv[1]))]
rows.sort(key=lambda x:x["order"])

report = {"duplicate":[], "shadow_allow_allow":[], "shadow_deny_allow":[], "notes":[]}

for i,upper in enumerate(rows):
    for lower in rows[i+1:]:
        if "#keep" in lower["comment"]: continue
        if is_same(upper, lower):
            report["duplicate"].append((upper["id"], lower["id"]))
        elif upper["action"]=="allow" and lower["action"]=="allow" and is_subset(upper, lower):
            report["shadow_allow_allow"].append((upper["id"], lower["id"]))
        elif upper["action"]=="deny" and lower["action"]=="allow" and is_subset(upper, lower):
            report["shadow_deny_allow"].append((upper["id"], lower["id"]))

print("== Duplicate ==")
for a,b in report["duplicate"]: print(a,"covers",b)
print("\n== Shadow Allow-Allow ==")
for a,b in report["shadow_allow_allow"]: print(a,"shadows",b)
print("\n== Shadow Deny-Allow (RISK) ==")
for a,b in report["shadow_deny_allow"]: print(a,"shadows",b)
```

**실행 예**
```bash
python3 shadow.py rules.csv
# == Duplicate ==
# R1 covers R4
#
# == Shadow Allow-Allow ==
# R1 shadows R2
#
# ==
# R5 shadows R2

```

### 제거·정리 플레이북

1) **리포트 확인**: Shadow/중복/Zero-Hit 목록 → 소유자/업무 플로우 식별
2) **의도 확인**: 상단 Deny가 의도적이면 **명시적 주석/만료** 추가, 하단 Allow **정리**
3) **카나리 삭제**: 읽히지 않는 규칙부터 **비활성/주석 처리** → 7일 관찰
4) **완전 삭제**: 모니터링 정상 시 제거 → Git PR/MR로 커밋
5) **회귀 테스트**: 핵심 경로(업무 플로우) 연결 테스트/벤치 수행

**Zero-Hit + Shadow 동시 필터(간단 규칙)**
```kql
index: fw-*
| stats count() as hits by rule.id
| where hits == 0 or rule.id in ["R2","R4"]  // shadow.py 결과 반영
```

### Cloud 보안그룹/네트워크폴리시 확장

- **Cloud SG**: 동일 알고리즘(소스 CIDR/포트/프로토콜), 0.0.0.0/0 오픈, 중복 규칙 제거
- **K8s NetworkPolicy**: `namespaceSelector/podSelector`의 **교집합 포함** 평가, **기본 거부**+허용만 남기기

**K8s NP Shadow 예(개념)**
- NP-A: `from: ns=web`, port 5432
- NP-B: `from: ns=*`, port 5432  → **A는 B에 의해 가려짐**(차라리 B만 유지)

### 워크숍 과제(팀별)

- **과제 1**: 제공된 `rules.csv` 변형(100~500개 룰)에서 Shadow/중복 검출 → PR로 제거안 제출
- **과제 2**: Cloud SG JSON(20개 그룹)에서 0.0.0.0/0 오픈+미사용 포트 식별
- **과제 3**: K8s NP YAML 10개에서 기본 거부가 없는 네임스페이스 찾아 수정
- **평가 기준**: 제거 수(품질)·오탐(없음)·회귀 테스트 성공률·문서화 완성도

---

## 부록 A. 표준 문서(샘플)

**룰 주석 표준**
```
# owner: data-team@corp
# ticket: JIRA-AN-1234
# purpose: user->reporting-db
# expiry: 2026-01-31
# env: prod

```

**네이밍 표준(요약)**
- 객체: `OBJ_{ZONE}_{TYPE}_{DESC}` (예: `OBJ_DMZ_NET_API01`)
- 주소그룹: `GRP_{ZONE}_{APP}_{ENV}` (예: `GRP_SRV_REPORTING_PROD`)
- 규칙: `{ORDER}_{ACTION}_{FLOW}_{DESC}`

---

## 부록 B. KPI 대시보드(운영 지표)

- **규칙 매수 추이**: 분기별 총 룰 수 / 존당 룰 수
- **Shadow/중복 비율**: (Shadow+Dup)/총 룰
- **Zero-Hit 비율**: 90일 기준
- **Any/Any 카운트**: 만료일 없는 예외 수
- **변경 리드타임**: RFC→배포 평균 시간
- **DR 연습 성적**: 전환 시간, 실패/미스

---

## 요약

- 분기 헬스체크는 **가시성/정책/노출/탄력/DR**의 5축으로 측정하고, 결과를 **변경 세트**로 바로 연결해야 효과가 난다.
- 변경관리/룰 리뷰는 **Git 버전+자동 분석+히트 통계**로 정량화하며, **Zero-Hit/Shadow/Any-Any**를 우선 제거한다.
- DR은 **핫/웜/콜드** 각 시나리오의 **경로·정책 일치성** 검증이 핵심이며, 전환·롤백 스크립트를 표준화해야 한다.
- 실습 워크숍의 **Shadow Rule 탐지 스크립트**를 팀에 배포해 정기적으로 **죽은 규칙을 청소**하면, 보안·성능·운영 단순화가 동시에 개선된다.
