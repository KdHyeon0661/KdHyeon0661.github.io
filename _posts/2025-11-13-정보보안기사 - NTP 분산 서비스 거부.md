---
layout: post
title: 정보보안기사 - NTP 분산 서비스 거부
date: 2025-11-13 23:25:28 +0900
category: 정보보안기사
---
# 취약점

## 핵심 요약 (TL;DR)

- **공격 메커니즘**: 공격자가 **송신자 IP를 피해자 IP로 스푸핑**한 **작은 NTP 쿼리**(UDP/123)를 **반사기(reflector)**로 사용 가능한 **취약 NTP 서버** 다수에 보낸다 → 서버는 **훨씬 큰 응답**을 피해자에게 발사 → **증폭 + 분산**으로 대역 외부에서 대량 트래픽을 만들 수 있다.
- **주요 취약 벡터**: 고전적 **`monlist`(mode 7) 질의**(CVE-2013-5211) 악용. **NTP 4.2.7p26 이상**에서 `monlist` 제거/무력화, **`mrulist`는 넌스 기반**으로 남용 방지. **구버전 ntpd/잘못된 restrict/monitor 설정**이 문제.
- **증폭 배율**: 현장 관측으로 **최대 수백 배(≈ 200배 수준) 증폭** 가능했던 사례가 다수 보고됨(트래픽 조합/경로에 따라 상이).
- **현대 리눅스 기본**: RHEL8+ 등은 **chronyd**가 기본 NTP 클라이언트/서버(서버는 명시적 allow 없으면 비개방). Ubuntu는 **systemd-timesyncd**가 **클라이언트 전용**(기본적으로 123/udp 수신 안 함). **ntpd 사용 시 특히 구성 점검 필수**.
- **방어 3단 콤보**
  ① **호스트(NTP 데몬) 하드닝**: `disable monitor`, **`restrict ... noquery nopeer nomodify`**, chrony는 **`allow` 명시/`cmdport 0`** 등.
  ② **네트워크 경계**: **BCP38/84**(소스 스푸핑 차단, uRPF), **UDP/123 폴리싱/필터링**, 관리면 CoPP.
  ③ **탐지/대응**: NetFlow에서 **sport=123 대량 유입** 패턴, IDS 룰(모드6/7 쿼리 시그니처)·SIEM 탐지.

---

## 배경과 동작 원리

### 반사·증폭 DDoS에서 NTP가 표적이 되는 이유

- **UDP 기반**이라 3-way 핸드셰이크 없이 **소스 IP 스푸핑**이 쉽다.
- 특정 질의(과거 `monlist` 등)가 **작은 요청 → 큰 응답**의 구조(=증폭).
- 공용으로 개방된 **오픈 NTP 서버**가 인터넷에 여전히 존재.

### 고전 공격 흐름(도식)

```
공격자 ──(src=피해자IP, dst=오픈NTP:123/UDP, 작은 질의)──▶ 오픈 NTP 서버들
   │
   └───────────────────────(큰 응답 다발)──────────────────────▶ 피해자
```

- 과거 대표 벡터: `ntpdc -c monlist`가 호출하는 **mode 7 `monlist`** 요청(CVE-2013-5211). NTP **4.2.7p26+**에서 제거·무력화, 대체 **`mrulist`는 넌스(Nonce)로 악용 억제**.

### 증폭 배율(참고)

- 환경에 따라 다르지만, **수십~수백 배(≈ 200x)** 증폭이 보고됨. 방어 설계 시 **여유 폴리싱/백홀 시나리오**를 고려.

---

## 자산 진단 체크리스트(운영팀용)

> 범위: **내 서버/네트워크**만 점검. 제3자 스캔 금지.

- [ ] **NTP 데몬 종류·버전 파악**
  - `ntpd -v` / `chronyd -v` / `systemctl status systemd-timesyncd`
  - **ntpd 사용 시** 최소 **4.2.7p26 이상** 여부, 하위면 즉시 업그레이드/대체 고려.
- [ ] **서버 개방 여부**: 외부에서 **UDP/123 수신**이 필요한가? 대부분 클라이언트만 필요.
- [ ] **구성 검토**
  - ntpd: `disable monitor`, `restrict default ... noquery nopeer nomodify`, loopback만 허용.
  - chrony: **서버로 쓸 때만** `allow` 네트워크 명시, 원격 명령 채널은 `cmdport 0` 또는 `cmdallow`로 제한.
- [ ] **방화벽 정책**: 비서버는 인바운드 UDP/123 차단. 서버는 승인된 소스만 허용, 레이트리밋 설정.
- [ ] **경계 라우터**: **BCP38/84(uRPF)** 적용(소스 스푸핑 방지).
- [ ] **모니터링**: NetFlow/SIEM에 **sport=123 다수 분산 유입** 탐지 룰 존재 여부.

---

## 플랫폼별 안전 설정

### ntpd (NTP.org reference implementation)

#### 권장 `ntp.conf` 골자(예시)

```cfg
# 기본 접근 제한(IPv4/IPv6)

restrict default kod limited nomodify nopeer noquery notrap
restrict -6 default kod limited nomodify nopeer noquery notrap

# 루프백/로컬은 허용

restrict 127.0.0.1
restrict ::1

# 'monitor' 기능 비활성(과거 monlist 악용 차단)

disable monitor

# 정의

pool 0.pool.ntp.org iburst
pool 1.pool.ntp.org iburst
```

- 포인트
  - `disable monitor` 로 **과거 모니터링 서비스(mode 7)** 비활성화.
  - `noquery nopeer nomodify` 로 **쿼리/피어 형성/수정 차단**.
  - **업그레이드**: 4.2.7p26+는 `monlist` 제거 및 `mrulist` 넌스 요구. 구버전이면 **즉시 업데이트**.

#### 방화벽(리눅스, 서버가 아닐 때)

```bash
# iptables - 비서버 호스트에서 인바운드 NTP 차단

sudo iptables -A INPUT -p udp --dport 123 -j DROP
# nftables (권장)

sudo nft add rule inet filter input udp dport 123 drop
```

### chrony (현대 리눅스 기본: RHEL8+/Rocky/Alma 등)

- **기본**: 클라이언트 모드. **서버로 쓰려면 `allow`로 네트워크를 명시**해야 외부 질의 수락.
- **원격 명령 포트**(UDP/323)는 **`cmdport 0`** 으로 끄거나, `bindcmdaddress/ cmdallow`로 **로컬 한정**을 권장.

#### `chrony.conf` 예시(클라이언트 전용·안전)

```cfg
pool pool.ntp.org iburst
driftfile /var/lib/chrony/drift
makestep 0.1 3
rtcsync

# → 외부 클라이언트 질의 거부
# 명령 포트 차단

cmdport 0
```

#### `chrony.conf` 예시(사내 서버; 승인 네트워크만 허용)

```cfg
# 상위 소스

server ntp-upstream.example.com iburst

# 내부 대역에만 서비스

allow 10.10.0.0/16
allow 192.168.50.0/24

# 관리 채널은 로컬만

bindcmdaddress 127.0.0.1
bindcmdaddress ::1
cmdallow 127.0.0.1
cmdallow ::1
```

> RHEL8+에서 **chronyd가 기본 NTP** 구현임을 전제로 운영 가이드를 제공.

### systemd-timesyncd (Ubuntu 등)

- **클라이언트 전용**으로 동작(기본적으로 UDP/123 **수신 대기 없음**).
- 서버가 필요 없다면 **timesyncd 유지**가 가장 안전·간단.
- NTP 서버 사용 시에는 **대체 데몬 설치(chrony 등)** 가이드에 따라 전환.

---

## 네트워크 경계·사업자 레벨 완화

### 소스 스푸핑 근절 (필수)

- **BCP38/84**: AS 경계/엣지·접속단에서 **uRPF**(Strict/Loose), 정적/다이내믹 ACL로 **위조 소스 IP 드랍**.
- 엔터프라이즈도 **업링크·인터넷 엣지**에서 반드시 시행.

#### Cisco IOS 예시 (uRPF Strict)

```ios
interface GigabitEthernet0/0
 ip verify unicast source reachable-via rx
 ip access-group OUTBOUND-EGRESS in
!
ip access-list extended OUTBOUND-EGRESS
 deny   udp any any eq 123 fragments
 permit ip any any
```

#### JunOS 예시 (uRPF + 폴리싱)

```junos
set interfaces ge-0/0/0 unit 0 family inet rpf-check
set firewall family inet policer POLICE-NTP if-exceeding bandwidth-limit 10m
set firewall family inet policer POLICE-NTP then discard
set firewall family inet filter EDGE term NTP from protocol udp
set firewall family inet filter EDGE term NTP from destination-port 123
set firewall family inet filter EDGE term NTP then policer POLICE-NTP
```

### UDP/123 엣지 폴리싱·허용목록(서버 역할일 때만)

- **비서버 조직**: 인바운드 UDP/123 **차단**.
- **서버 조직**: 승인된 피어 네트·다운스트림만 **허용**·**레이트리밋**, CoPP로 **제어면 보호**.

---

## 탐지·모니터링·대응

### 네트워크 관측 지표

- **sport=123** 대량 분산 유입(피해자 관점).
- 특정 기간 **UDP/123 요청 급증 + 대형 응답**(반사기 관점).
- CISA는 **대형 UDP 패킷·비상태 UDP 흐름**에 대한 경보 구성을 권고.

#### 탐지 쿼리 예시

```spl
index=netflow (udp.src_port=123 OR udp.dst_port=123)
| stats count sum(bytes) by src_ip, dst_ip, udp.src_port, udp.dst_port
| where udp.src_port=123 AND count > 1000
```

### IDS/IPS 룰(개념)

- **모드 6/7** 제어 쿼리 패턴 탐지 룰 활성화.
- Snort/Talos·서리카타 룰셋의 **NTP monlist(CVE-2013-5211)** 탐지 항목을 최신 유지.

> 참고: 공개 룰 문서(예: Snort rule docs)에서 **monlist 악용 탐지** 시그니처가 제공된다.

### 운영 런북(Incident Runbook)

1) **식별**: NetFlow/IDS 경보 → 트래픽 캡처(메타) 확보.
2) **격리**:
   - 우리 망이 **반사기**라면: 즉시 **UDP/123 인바운드 차단/폴리싱 강화**, 해당 NTP 서버 **서비스 중지**→ 하드닝 후 재개.
   - 우리가 **피해자**라면: ISP와 **RTBH(원격 블랙홀)**, **BGP Flowspec**, **스크러빙센터** 협조.
3) **근절/개선**: 취약 NTP 서버 업데이트·구성 고정, 경계 uRPF·ACL 상시화.
4) **사후학습**: 모니터링 룰·대응 임계치 조정, **연 1회 이상 DRDoS 합동훈련**.

---

## 점검·하드닝 절차 예시(운영 스크립트 중심)

### Linux — 내가 **반사기**가 아님을 보장(비서버 호스트)

```bash
# timesyncd 또는 chronyd 클라이언트만 사용 중인지 확인

systemctl is-active systemd-timesyncd || true
systemctl is-active chronyd || true
systemctl is-active ntpd || true  # active면 구성 점검 필수

# 방화벽으로 인바운드 UDP/123 차단

sudo nft add rule inet filter input udp dport 123 drop

# 세션·로그 확인(최근 1시간 포트123)

sudo journalctl --since "1 hour ago" | grep -i '123/udp' || true
```

### ntpd — 서버 운영 시 안전 구성·검증

```bash
# 버전 확인(4.2.7p26 이상 권장)

ntpd --version

# 설정 파일 핵심 확인

grep -E 'disable +monitor|restrict +default' /etc/ntp.conf

# 재시작 및 바인딩 확인

sudo systemctl restart ntp || sudo systemctl restart ntpd
sudo ss -uap | grep ':123 '

# 로컬에서만 상태 점검(원격 쿼리 금지)

ntpq -p
```
- **포인트**: `ntpq -p` 등 **로컬 관리**로 충분해야 한다. 원격 질의가 꼭 필요하면 **관리망/VPN 내부 한정**.

### chrony — 서버 운영 시 안전 구성·검증

```bash
# 서버로 쓸 때만 'allow' 존재해야 함, 관리 채널은 로컬만

sudo egrep '^(allow|cmdport|bindcmdaddress|cmdallow)' /etc/chrony.conf

sudo systemctl restart chronyd
chronyc sources -v
chronyc tracking
```
- **allow 미지정** 시 외부 클라이언트는 기본 거부(안전 기본값).

---

## 운영 정책·표준 문구(샘플)

### 구성 표준

| 항목 | 표준 |
|---|---|
| NTP 데몬 | **chronyd** 권장(서버 필요 시에만 개방). Ubuntu 단독 호스트는 **timesyncd** 기본 사용.  |
| ntpd 사용 시 | 버전 **4.2.7p26+** 필수, `disable monitor`, `restrict default ... noquery nopeer nomodify` 필수.  |
| 네트워크 | 경계 **uRPF/BCP38/84** 준수. UDP/123 인바운드 기본 거부(서버 예외).  |
| 탐지 | NetFlow·IDS 룰로 **sport=123 대량 유입** 패턴 경보, DDoS 런북 상시 유지.  |

### 변경관리·감사 포인트

- NTP 역할 변경(클라이언트→서버) 시 **방화벽·ACL·`allow` 범위** 동시 변경.
- 분기마다 **오픈 NTP 서버 스위프(사내 주소 공간만)** 및 **버전/설정 감리**.

---

## 자주 묻는 질문(FAQ)

**Q1. `monlist`만 막으면 끝인가요?**
A. 아니요. **구버전 ntpd의 모드6/7 제어 질의 전반**이 반사·증폭에 악용될 수 있고, **미흡한 restrict/monitor 설정**도 위험합니다. **최신 버전**과 **엄격한 `restrict`/`disable monitor`**가 기본입니다.

**Q2. Ubuntu 서버는 기본적으로 안전한가요?**
A. 기본 **systemd-timesyncd(클라이언트)** 사용 시 서버 포트(UDP/123)를 수신하지 않아 상대적으로 안전합니다. **단, 방화벽 기본 거부**와 **데몬 전환 시 절차**는 유지하세요.

**Q3. RHEL8+/Rocky에서 왜 chrony를 권하나요?**
A. 배포판 기본이고, **서버로 쓰려면 명시적 `allow` 필요**라 실수로 오픈 서버가 되는 위험이 작습니다. 성능·적시성도 우수합니다.

---

## 부록 — IDS 시그니처/정책 예시(학습용)

> 아래는 **방어 시나리오 참고용**으로, 상용/커뮤니티 룰셋 최신본 사용을 권장.

### Snort/Suricata 개념 룰(모드7 `monlist` 탐지 계열)

```snort
# 예시적 개념 룰 — 실제 운영은 공급자 최신 룰셋 권장

alert udp $EXTERNAL_NET any -> $HOME_NET 123 (msg:"NTP monlist/mode7 possible"; content:"|17 00 03|"; offset:0; depth:3; classtype:attempted-dos; sid:1000001; rev:1;)
```
- **주의**: 실제 배포는 **공식 룰셋**(Talos/ET 등)의 최신 업데이트 사용.

### CISA 탐지 팁 반영(대형 UDP/비상태 흐름 경보)

- **대형 UDP 패킷**을 상·하위 포트에서 감지하고, **비상태 UDP**에 대한 경보를 두는 것을 권고.

---

## 결론 — “기본값 보안” + “경계에서의 반사 억제”

1) **애초에 오픈 NTP 서버를 만들지 말 것**(chrony 기본값, timesyncd 유지).
2) **ntpd 필요 시**: 최신 버전 + `disable monitor` + 엄격 restrict + 최소 공개.
3) **경계에서 스푸핑 차단**(BCP38/84/uRPF) & **UDP/123 폴리싱**.
4) **가시성**: NetFlow/IDS/SIEM으로 **sport=123 대량 유입**을 조기 경보.
→ 이 4가지만 지켜도 **NTP 반사·증폭 DDoS의 가해자도 피해자도 될 가능성**을 크게 줄일 수 있다.
