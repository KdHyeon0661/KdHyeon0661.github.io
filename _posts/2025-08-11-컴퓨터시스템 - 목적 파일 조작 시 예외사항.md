---
layout: post
title: 컴퓨터시스템 - 목적 파일 조작 시 예외사항
date: 2025-08-11 23:20:23 +0900
category: 컴퓨터시스템
---
# 목적 파일 조작 시 예외사항(주의점·함정·특수 케이스)

목적 파일(ELF, COFF, Mach-O 등)을 `objcopy`, `patchelf`, `strip` 등으로 조작할 때는 단순히 “동작하니 OK”로 끝나지 않습니다. 잘못 수정하면 **실행 불능**, **ABI(응용 바이너리 인터페이스) 불일치**, **보안 취약점** 등이 생길 수 있습니다. 아래는 실무에서 자주 마주하는 예외사항과 함정들입니다.

---

## 1. 심볼·섹션 조작 시 예외사항

### 1.1 심볼 약화/숨김으로 인한 ABI 깨짐
- **문제**: 공개 API 심볼을 `--localize-symbol` 또는 `--weaken-symbol`로 변경하면, 동적 링커가 의도한 심볼을 찾지 못해 **undefined symbol** 런타임 에러 발생.
- **예외 케이스**: 플러그인 시스템, 인터포지션(심볼 오버라이드) 의존 코드.
- **대응**: 변경 전/후 `nm -D`로 동적 심볼 테이블 비교, API 버전 스크립트로 허용 목록 제어.

### 1.2 섹션 제거 시의 간접 영향
- `.comment`나 `.note`는 제거해도 안전하지만, `.eh_frame`, `.init_array` 등은 런타임 동작에 필요.
- `.eh_frame` 제거 → C++ 예외 처리 불능.
- `.ctors`/`.init_array` 제거 → 전역 객체 초기화 누락.

---

## 2. 동적 속성 변경 시 예외사항

### 2.1 RPATH/RUNPATH 수정 충돌
- `RPATH`가 설정된 ELF는 `LD_LIBRARY_PATH`보다 우선할 수 있음.  
  → `RUNPATH`로 바꾸면 우선순위 변경됨.
- 일부 환경(예: SUID 바이너리, 보안 정책 활성화)에서는 RPATH/RUNPATH 무시됨.

### 2.2 SONAME 변경
- `SONAME`은 다른 바이너리가 링크할 때 참조하는 이름.
- 라이브러리 파일명 변경 후 SONAME을 갱신하지 않으면 링크 에러 발생.

---

## 3. `strip`/디버그 정보 제거 시 예외사항

- 완전 `strip --strip-all` 하면 GDB, perf, addr2line, ASLR 디버깅 불가.
- 일부 JIT·프로파일러(eBPF, SystemTap)는 심볼 이름·주소 정보 필요.
- 심볼 제거 후에도 `.symtab` 일부가 남아있어야 할 수도 있음(특수 로더).

---

## 4. 아카이브(.a) 조작 시 예외사항

- Thin archive(`ar rcsT`)는 멤버가 외부 경로를 참조 → 원본 파일 삭제 시 링크 불가.
- `ranlib` 미실행 시 일부 플랫폼에서 `ar` 인덱스가 갱신 안 돼 링크 실패.

---

## 5. 플랫폼/아키텍처 별 예외사항

### 5.1 크로스 컴파일 환경
- 호스트 `objcopy`/`readelf`를 타겟 바이너리에 사용하면 포맷/엔디안 차이로 잘못 파싱.
- 해결: 타겟 전용 binutils 사용(`arm-linux-gnueabi-objdump` 등).

### 5.2 Windows PE/COFF
- `editbin`으로 서브시스템 변경 시 디지털 서명 무효화.
- `.reloc` 제거 → ASLR 불가.

### 5.3 macOS Mach-O
- `install_name_tool`로 LC_ID_DYLIB 변경 시 코드 서명 깨짐 → `codesign` 재서명 필요.

---

## 6. 재배치/로더 예외사항

- `objcopy`로 GOT/PLT 관련 섹션 수정 시, 동적 링커가 잘못된 주소로 점프.
- PIE(Position Independent Executable) 바이너리를 일반 ELF로 변환하면 ASLR 무력화.

---

## 7. 법적/라이선스 예외사항

- 일부 상용 라이브러리는 심볼/섹션 편집, 난독화 금지 조항이 있음.
- GPL 라이브러리 편집 후 배포 시, 소스 공개 의무가 부과될 수 있음.

---

## 8. 종합 체크리스트(예외 방지)

- [ ] 수정 전/후 `readelf -a`, `nm -D`, `objdump -x` 비교.
- [ ] 변경 전 런타임 로드 로그(`LD_DEBUG=libs,bindings`).
- [ ] 디버그 제거 시 `.eh_frame`, `.init_array` 보존 여부 확인.
- [ ] RPATH/RUNPATH 변경 시 보안 정책 영향 점검.
- [ ] 크로스 빌드 환경에서는 타겟 전용 도구 사용.
- [ ] 서명/무결성 정책 확인.

---

## 9. 결론
목적 파일 조작은 단순한 “바이너리 편집”이 아니라 **ABI 보존·보안 정책·디버깅 가능성**을 모두 고려해야 합니다.  
특히 운영 환경(보안 설정, 서명 정책)과 아키텍처별 차이를 이해하지 않고 변경하면, 조작 후 바로 실행 불능이 되는 사례가 많습니다.