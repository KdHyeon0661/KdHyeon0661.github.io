---
layout: post
title: Linux - ìŠ¤ëƒ…ìƒ· ì‹œìŠ¤í…œ
date: 2024-12-03 19:20:23 +0900
category: Linux
---
# ìŠ¤ëƒ…ìƒ· ì‹œìŠ¤í…œ(Btrfs, ZFS)ê³¼ ê³µê°„ ì ˆì•½ ì „ëµ

## ğŸ“¸ 1. ìŠ¤ëƒ…ìƒ·ì˜ ë³¸ì§ˆ: Copy-on-Write(CoW)ì™€ ì°¸ì¡°

ìŠ¤ëƒ…ìƒ·ì€ â€œí˜„ì¬ ì‹œì ì˜ **ë©”íƒ€ë°ì´í„°(ë¸”ë¡ ë§µ)**ë¥¼ ì–¼ë ¤ì„œ **ë¸”ë¡ì„ ê³µìœ **â€í•˜ëŠ” ê¸°ìˆ ì´ë‹¤. ë°ì´í„° ë³€ê²½ì´ ë°œìƒí•˜ë©´ **ì›ë³¸ ë¸”ë¡ì„ ë³´ì¡´**í•œ ì±„ **ìƒˆ ë¸”ë¡ì— ì“°ê¸°**(Copy-on-Write) í•˜ë¯€ë¡œ, ìŠ¤ëƒ…ìƒ· ì§í›„ì—ëŠ” ì¶”ê°€ ê³µê°„ì„ ê±°ì˜ ì°¨ì§€í•˜ì§€ ì•ŠëŠ”ë‹¤.

### í•µì‹¬ ì§ê´€
- ìŠ¤ëƒ…ìƒ· ìƒì„± ì‹œ: **ë©”íƒ€ë°ì´í„°ë§Œ ë³µì œ** â†’ ì¦‰ì‹œ/ì €ë¹„ìš©
- ì´í›„ ë³€ê²½: **ë³€ê²½ëœ ë¸”ë¡ë§Œ** ìƒˆë¡œ í• ë‹¹ â†’ ìŠ¤ëƒ…ìƒ·ê³¼ í˜„ì¬ë³¸(ë¼ì´ë¸Œ)ì´ **ê³µê°„ì„ ê³µìœ **
- ìŠ¤ëƒ…ìƒ· ì‚­ì œ: í•´ë‹¹ ìŠ¤ëƒ…ìƒ·ë§Œ ì°¸ì¡°í•˜ë˜ ë¸”ë¡ì´ ìˆìœ¼ë©´ **ê·¸ ë¸”ë¡ë§Œ íšŒìˆ˜**

### ê°„ë‹¨í•œ ë¹„ìš© ëª¨ë¸(ì§ê´€ì‹)
ìŠ¤ëƒ…ìƒ· ì´í›„ ì´ ì¶”ê°€ ì‚¬ìš© ê³µê°„ì„ \(S\), ë³€ê²½ ë¹„ìœ¨ì„ \(p\), ì´ ë°ì´í„° í¬ê¸°ë¥¼ \(D\)ë¼ í•˜ë©´,
$$
S \approx p \cdot D
$$
ìŠ¤ëƒ…ìƒ·ì´ ë§ì„ìˆ˜ë¡ **ì¤‘ë³µ ì°¸ì¡° êµ¬ê°„**ì´ ëŠ˜ì–´ë‚˜ë©°, í”„ë£¨ë‹(ì˜¤ë˜ëœ ìŠ¤ëƒ…ìƒ· ì‚­ì œ) ì‹œ íšŒìˆ˜ë˜ëŠ” ê³µê°„ì€ **ìœ ì¼ ì°¸ì¡° ë¸”ë¡**ì˜ í•©ìœ¼ë¡œ ê·¼ì‚¬í•  ìˆ˜ ìˆë‹¤.

---

## ğŸŒ² 2. Btrfs â€” ì„œë¸Œë³¼ë¥¨, ìŠ¤ëƒ…ìƒ·, CoW ìš´ì˜

BtrfsëŠ” **ì„œë¸Œë³¼ë¥¨(subvolume)** ë‹¨ìœ„ë¡œ ìŠ¤ëƒ…ìƒ·ì„ ë§Œë“ ë‹¤. ë£¨íŠ¸ì— ì—¬ëŸ¬ ì„œë¸Œë³¼ë¥¨ì„ ë‘ê³  ë§ˆìš´íŠ¸ ë‹¨ìœ„ë¡œ ê´€ë¦¬í•˜ëŠ” ë ˆì´ì•„ì›ƒì´ ì •ì„ì´ë‹¤.

### 2.1 ë ˆì´ì•„ì›ƒ ì„¤ê³„(ì˜ˆì‹œ)
```text
/mnt/btrfs
  â”œâ”€ @           (ë£¨íŠ¸ìš© ì„œë¸Œë³¼ë¥¨, / ë¡œ ë§ˆìš´íŠ¸)
  â”œâ”€ @home       (/home)
  â”œâ”€ @var        (/var)       â† ì¦ì€ ì“°ê¸° ë¶„ë¦¬, í•„ìš” ì‹œ nocow/ì˜µì…˜ ì¡°ì •
  â””â”€ @snapshots  (ìŠ¤ëƒ…ìƒ· ë³´ê´€ìš© ë§ˆìš´íŠ¸ í¬ì¸íŠ¸)
```

### 2.2 ì„œë¸Œë³¼ë¥¨/ìŠ¤ëƒ…ìƒ· ê¸°ì´ˆ ëª…ë ¹
```bash
# íŒŒí‹°ì…˜ ë§ˆìš´íŠ¸ í›„ ì„œë¸Œë³¼ë¥¨ ìƒì„±
sudo mount /dev/sdX1 /mnt
sudo btrfs subvolume create /mnt/@
sudo btrfs subvolume create /mnt/@home
sudo btrfs subvolume create /mnt/@var

# ì½ê¸°-ì“°ê¸° ìŠ¤ëƒ…ìƒ·
sudo btrfs subvolume snapshot /mnt/@ /mnt/@_snap_$(date +%F)

# ì½ê¸°-ì „ìš© ìŠ¤ëƒ…ìƒ·(ë°±ì—…/ì „ì†¡ ê¸°ì ìš©ìœ¼ë¡œ ê¶Œì¥)
sudo btrfs subvolume snapshot -r /mnt/@ /mnt/@_ro_$(date +%F)

# ë‚˜ì—´/ì‚­ì œ/ì •ë³´
sudo btrfs subvolume list -o /mnt
sudo btrfs subvolume delete /mnt/@_ro_2025-11-11
sudo btrfs filesystem df /mnt     # ë…¼ë¦¬/ì‹¤ì œ ì‚¬ìš©ëŸ‰
```

### 2.3 fstab ë§ˆìš´íŠ¸(ì••ì¶•/atime ìµœì í™”)
```fstab
UUID=<UUID>  /               btrfs  subvol=@,compress=zstd:3,noatime,space_cache=v2  0  0
UUID=<UUID>  /home           btrfs  subvol=@home,compress=zstd:3,noatime             0  0
UUID=<UUID>  /var            btrfs  subvol=@var,compress=zstd:3                      0  0
UUID=<UUID>  /.snapshots     btrfs  subvol=@snapshots,ro                             0  0
```
- `compress=zstd[:level]` : ì†ë„/ì••ì¶•ìœ¨ ê· í˜•. zstd:3~6 ê¶Œì¥(ë²”ìš©).
- `noatime` : ì½ê¸° ì„±ëŠ¥ í–¥ìƒ.
- `space_cache=v2` : ìµœì‹  ê³µê°„ ìºì‹œ.
- ìŠ¤ëƒ…ìƒ· ë³´ê´€ìš© ë§ˆìš´íŠ¸ëŠ” **ro**ë¡œ ì½ê¸° ì „ìš© ë…¸ì¶œí•´ â€œí•¨ë¶€ë¡œ ìˆ˜ì •â€ ë°©ì§€.

### 2.4 nocow(ì£¼ì˜)
DB/VM ì´ë¯¸ì§€ ë“± **ëœë¤ ì“°ê¸° ëŒ€íŒŒì¼**ì— CoWê°€ ì˜¤ë²„í—¤ë“œì¼ ìˆ˜ ìˆë‹¤. íŒŒì¼ ìƒì„± **ì´ì „**ì— NOCOW ì†ì„± ë¶€ì—¬:
```bash
# í•´ë‹¹ ë””ë ‰í† ë¦¬(ë˜ëŠ” íŒŒì¼)ì— nocow: xattr + chattr(SSD/TRIM/Checksum ì˜í–¥ ê³ ë ¤)
sudo chattr +C /var/lib/mydb
# ì´í›„ ìƒì„±ë˜ëŠ” íŒŒì¼ì—ë§Œ ì ìš©(Cow ë¹„í™œì„±í™”). ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íŒŒì¼ì—” ì†Œê¸‰ ì ìš© ì•ˆ ë¨.
```
> NOCOWëŠ” Btrfsì˜ ì²´í¬ì„¬/ìŠ¤í¬ëŸ½ ì´ì  ì¼ë¶€ ìƒì‡„. ì •ë§ í•„ìš”í•œ ì›Œí¬ë¡œë“œì—ë§Œ ì‚¬ìš©.

### 2.5 ê³µê°„ ìœ ì§€/íšŒìˆ˜ ë„êµ¬
```bash
# ê· í˜• ì¬ë°°ì¹˜(í”„ë˜ê·¸/ê³µê°„ íŒŒí¸í™” ëŒ€ì‘) â€” ë¶€ë¶„ì /í”„ë¡œí•„ë³„ ê¶Œì¥
sudo btrfs balance start -dlimit=5 -mlimit=5 /      # ì¡°ê¸ˆì”©
# ì²´í¬ì„¬ ê²€ì¦/ë³µêµ¬(í”„ë¡œí•„/RAID ì¡°ê±´ í•˜ì—ì„œ)
sudo btrfs scrub start -Bd /
# ë…¼ë¦¬ vs ì‹¤ì œ ê³µê°„, ê° í”„ë¡œí•„ ì‚¬ìš©ëŸ‰
sudo btrfs filesystem usage /
```
- **balance**ëŠ” ê³¼í•˜ë©´ ì„±ëŠ¥/ë‚´êµ¬ì„±ì— ì§€ì¥. ì‘ì€ ë‹¨ìœ„ë¡œ ì ì§„ ìˆ˜í–‰.
- **scrub**ëŠ” ì •ê¸° ìˆ˜í–‰(ì˜ˆ: ì›” 1íšŒ) ê¶Œì¥ â†’ ì¡°ê¸° ì˜¤ë¥˜ ê°ì§€/ë³µêµ¬.

### 2.6 ì¦ë¶„ ì „ì†¡(send/receive)
```bash
# ì½ê¸°ì „ìš© ìŠ¤ëƒ…ìƒ· 2ê°œ ê¸°ë°˜ì˜ ì¦ë¶„ ì „ì†¡
sudo btrfs send -p /mnt/@_ro_2025-11-01 /mnt/@_ro_2025-11-11 | ssh backup 'btrfs receive /backup/@'

# ì´ˆê¸° ì „ì†¡(ë² ì´ìŠ¤ ì—†ìŒ)
sudo btrfs send /mnt/@_ro_base | ssh backup 'btrfs receive /backup/@'
```
- BtrfsëŠ” ë„¤ì´í‹°ë¸Œ ì¦ë¶„(`-p <parent>`). WANì „ì†¡ ì‹œ ì••ì¶• ìŠ¤íŠ¸ë¦¼(`zstdmt`) íŒŒì´í”„ ì¡°í•© ê°€ëŠ¥.

---

## ğŸ’½ 3. ZFS â€” ë°ì´í„°ì…‹/í’€, ìŠ¤ëƒ…ìƒ·/í´ë¡ , ì „ì†¡

ZFSëŠ” **í’€(zpool)** ìœ„ì— **ë°ì´í„°ì…‹(dataset)**ì„ ë§Œë“ ë‹¤. ìŠ¤ëƒ…ìƒ·ì€ `dataset@name`, í´ë¡ ì€ `dataset/clone`ìœ¼ë¡œ í‘œí˜„ëœë‹¤.

### 3.1 í’€/ë°ì´í„°ì…‹ ìƒì„±(ì˜ˆì‹œ)
```bash
# ë””ìŠ¤í¬ 2ê°œ ë¯¸ëŸ¬ í’€
sudo zpool create -o ashift=12 tank mirror /dev/sdb /dev/sdc

# ë°ì´í„°ì…‹(íŒŒì¼ì‹œìŠ¤í…œ) ìƒì„± ë° ì˜µì…˜
sudo zfs create -o compression=lz4 -o atime=off tank/home
sudo zfs create -o compression=zstd tank/data
sudo zfs list
```
- `ashift=12` : 4K ì„¹í„° ì •ë ¬(í˜„ëŒ€ ë””ìŠ¤í¬ ê¸°ë³¸).
- ì••ì¶•: lz4(ê²½ëŸ‰), zstd(ê³ ì••ì¶•).
- `recordsize`ëŠ” ì›Œí¬ë¡œë“œë³„ ì¡°ì •(DB 16K/8K, ëŒ€ìš©ëŸ‰ íŒŒì¼ 1M ê¶Œì¥).

### 3.2 ìŠ¤ëƒ…ìƒ·/í´ë¡ /ë¡¤ë°±
```bash
# ìŠ¤ëƒ…ìƒ· ìƒì„±/ë‚˜ì—´/ì‚­ì œ
sudo zfs snapshot tank/data@daily-2025-11-11
sudo zfs list -t snapshot
sudo zfs destroy tank/data@daily-2025-11-01

# ë¡¤ë°±(ë°ì´í„°ì…‹ì„ ìŠ¤ëƒ…ìƒ· ì‹œì ìœ¼ë¡œ ë˜ëŒë¦¼)
sudo zfs rollback tank/data@daily-2025-11-11

# í´ë¡ (ì“°ê¸°ê°€ëŠ¥í•œ ë¶„ê¸° ë¸Œëœì¹˜; ì› ìŠ¤ëƒ…ìƒ· ì¢…ì†)
sudo zfs clone tank/data@daily-2025-11-11 tank/data-test
```

### 3.3 ì¦ë¶„ ì „ì†¡(send/receive)
```bash
# ì „ì²´ ì „ì†¡(ì´ˆê¸°)
sudo zfs send tank/data@base | ssh backup 'zfs receive -u backup/data'

# ì¦ë¶„(ë¶€ëª¨ ìŠ¤ëƒ…ìƒ· ê¸°ì¤€)
sudo zfs send -I tank/data@base tank/data@daily-2025-11-11 | ssh backup 'zfs receive -u backup/data'

# ì¤‘ë‹¨ ëŒ€ì‘: -t ìŠ¤íŠ¸ë¦¼ bookmark/holdë¥¼ ì¨ì„œ ì´ì–´ë¶™ì´ê¸° ê°€ëŠ¥
```
- `-i`(ì¼ë°˜ ì¦ë¶„), `-I`(ì¤‘ê°„ ìŠ¤ëƒ… ëª¨ë‘ í¬í•¨ ì¦ë¶„).
- `zfs hold/release`ë¡œ ìŠ¤ëƒ…ìƒ· ì‹¤ìˆ˜ ì‚­ì œ ë°©ì§€.
- `-u` ìˆ˜ì‹ í•˜ë©´ ì¦‰ì‹œ ë§ˆìš´íŠ¸í•˜ì§€ ì•ŠìŒ(í›„ì²˜ë¦¬ ë§ˆìš´íŠ¸).

### 3.4 ë¬´ê²°ì„±, ARC/L2ARC, SLOG
- **ì²´í¬ì„¬**: ëª¨ë“  ë¸”ë¡ ë³´í˜¸. `zpool scrub`ìœ¼ë¡œ ì •ê¸° ê²€ì‚¬/ìê¸°ë³µêµ¬.
- **ARC/L2ARC**: ë©”ëª¨ë¦¬ ìºì‹œ/SSD ë³´ì¡° ìºì‹œ. ì½ê¸° ì„±ëŠ¥ í–¥ìƒ.
- **ZIL/SLOG**: ë™ê¸°ì“°ê¸° ê°€ì† ì¥ì¹˜(ì €ì§€ì—° SSD). DB/VM ë™ê¸° ë¡œê·¸ì— íš¨ê³¼.

```bash
sudo zpool scrub tank
sudo zpool status
```

### 3.5 ê³µê°„/ì„±ëŠ¥ ì¡°ì • ì˜µì…˜
```bash
# ë ˆì½”ë“œì‚¬ì´ì¦ˆ(ëŒ€ìš©ëŸ‰ ìˆœì°¨ IOì— ìœ ë¦¬)
sudo zfs set recordsize=1M tank/media
# ë™ê¸°ì“°ê¸° ì •ì±…(ì›Œí¬ë¡œë“œë³„ ì‹ ì¤‘íˆ)
sudo zfs set sync=standard tank/data
# ì••ì¶•/ì¤‘ë³µì œê±°
sudo zfs set compression=zstd tank/data
sudo zfs set dedup=on tank/archive   # ë©”ëª¨ë¦¬/CPU ë¶€ë‹´ í¼. ì •ë§ ì¤‘ë³µ ë§ì€ ì›Œí¬ë¡œë“œì—ë§Œ!
```

---

## ğŸ§  4. ê³µê°„ ì ˆì•½ ì „ëµ ì´ì •ë¦¬

### 4.1 CoW + ì••ì¶•
- **CoW**: ë³€ê²½ ë¸”ë¡ë§Œ ì¶”ê°€ ì €ì¥ â†’ ìŠ¤ëƒ…ìƒ· ë¹„ìš©â†“
- **ì••ì¶•**: zstd/lz4 ë“±ìœ¼ë¡œ ì €ì¥ íš¨ìœ¨â†‘, IO ê°ì†Œ â†’ ì‹¤ì œ ì²´ê° ì†ë„â†‘ì¸ ê²½ìš° ë‹¤ìˆ˜
  - Btrfs: `compress=zstd[:level]`
  - ZFS: `zfs set compression=zstd|lz4`

### 4.2 ì¤‘ë³µ ì œê±°(Dedup)
- **ZFS dedup**: ë™ì¼í•œ ë¸”ë¡ í•´ì‹œë¡œ **1íšŒë§Œ ì €ì¥**.
  - ë©”ëª¨ë¦¬/CPU ì˜¤ë²„í—¤ë“œ í¼(í•´ì‹œ í…Œì´ë¸”). **ë°±ì—… ë¦¬í¬ì§€í† ë¦¬/ì•„ì¹´ì´ë¸Œ**ì²˜ëŸ¼ ì§„ì§œ ì¤‘ë³µì´ ë§ì€ ì›Œí¬ë¡œë“œì—ë§Œ.
- **Btrfs dedup**: ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ë„êµ¬ë¡œ ìœ ì €ëœë“œ ìˆ˜ì¤€(ì˜ˆ: `duperemove`, `beesd`). ìš´ì˜ ë‚œì´ë„ ê³ ë ¤.

### 4.3 ê³µê°„ íšŒìˆ˜/ì •ë¦¬
- Btrfs: **balance(ì ˆì œ)**, **defrag(í° íŒŒì¼/ë©”íƒ€ë°ì´í„° ëŒ€ìƒ)**, **scrub(ë¬´ê²°ì„±)**
- ZFS: **snapshot prune + send/receive ì¦ë¶„**, **scrub**, **ì˜ˆì•½/ì¿¼íƒ€ë¡œ ë°ì´í„°ì…‹ ê²½ê³„ ê´€ë¦¬**

### 4.4 ìŠ¤ëƒ…ìƒ· ë³´ì¡´ ì •ì±…(ì˜ˆ)
- ë§¤ì‹œê°„ 24ê°œ, ë§¤ì¼ 7ê°œ, ë§¤ì£¼ 5ê°œ, ë§¤ì›” 6ê°œ â†’ **Grandfather-Father-Son(GFS)** ì •ì±…
  - ë¡œì»¬ ìŠ¤ëƒ…ìƒ·(ë‹¨ê¸° ë³µêµ¬) + ì›ê²© ì¦ë¶„ ì „ì†¡(ì¬í•´ë³µêµ¬)

---

## ğŸ§ª 5. ì‹¤ì „ ë ˆì‹œí”¼: í˜„ì¥ì—ì„œ ê·¸ëŒ€ë¡œ ì“°ëŠ” ìŠ¤í¬ë¦½íŠ¸

### 5.1 Btrfs: `/home` ì¼ì¼ ìŠ¤ëƒ…ìƒ· + 14ì¼ ë³´ì¡´
```bash
#!/usr/bin/env bash
set -euo pipefail

SRC=/home
DST_PARENT=/.snapshots/home
DATE=$(date +%F)

sudo mkdir -p "$DST_PARENT"
sudo btrfs subvolume snapshot -r "$SRC" "$DST_PARENT/@home_$DATE"

# 15ì¼ ì´ì „ ìŠ¤ëƒ…ìƒ· ì‚­ì œ
find "$DST_PARENT" -maxdepth 1 -type d -name '@home_*' -daystart -mtime +14 -print0 \
  | xargs -0r sudo btrfs subvolume delete
```
`cron` ë“±ë¡:
```bash
0 2 * * * root /usr/local/sbin/btrfs-home-daily
```

### 5.2 ZFS: ì¼ì¼ ì¦ë¶„ ì „ì†¡(ì›ê²© ë°±ì—…) + ë³´ì¡´
```bash
#!/usr/bin/env bash
set -euo pipefail

SRC="tank/data"
SNAP="daily-$(date +%F)"
DST="backup/data"
REMOTE="backup-host"

# ìŠ¤ëƒ…ìƒ· ìƒì„±
sudo zfs snapshot ${SRC}@${SNAP}

# ë§ˆì§€ë§‰ ìŠ¤ëƒ…ìƒ· ì°¾ê¸°(ì—†ìœ¼ë©´ ì „ì²´ ì „ì†¡)
LAST=$(sudo zfs list -t snapshot -o name -s creation -H | grep "^${SRC}@" | tail -2 | head -1 || true)

if [[ -n "${LAST}" ]]; then
  sudo zfs send -I "${LAST}" "${SRC}@${SNAP}" | ssh "${REMOTE}" "zfs receive -u ${DST}"
else
  sudo zfs send "${SRC}@${SNAP}" | ssh "${REMOTE}" "zfs receive -u ${DST}"
fi

# ë¡œì»¬ 30ì¼ ì´ì „ ìŠ¤ëƒ…ìƒ· ì‚­ì œ
sudo zfs list -t snapshot -o name,creation -s creation -H \
 | awk -v src="${SRC}@" '$1 ~ "^"src {print}' \
 | head -n -30 | awk '{print $1}' \
 | xargs -r -n1 sudo zfs destroy
```

### 5.3 Btrfs: ë¹ ë¥¸ ì‹œí—˜ìš© ë¡¤ë°±(ë¶€íŒ… ì „í™˜ ì‹œë‚˜ë¦¬ì˜¤)
1) í˜„ì¬ ë£¨íŠ¸ë¥¼ ì½ê¸°ì „ìš© ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ë³´ê´€
2) íŒ¨í‚¤ì§€/ì—…ê·¸ë ˆì´ë“œ
3) ë¬¸ì œê°€ ìˆìœ¼ë©´ **ìŠ¤ëƒ…ìƒ·ì„ ë£¨íŠ¸ë¡œ êµì²´**
```bash
# ë£¨íŠ¸ ìŠ¤ëƒ…ìƒ·
sudo btrfs subvolume snapshot -r / /.snapshots/@root_pre_upgrade_$(date +%F)

# ë¬¸ì œ ë°œìƒ ì‹œ: ë¶€íŠ¸ íŒŒë¼ë¯¸í„°ë¡œ subvol=@root_pre_upgrade_... ì§€ì • ë˜ëŠ”
# ìŠ¤ëƒ…ìƒ·ì„ ìƒˆë¡œìš´ @ ë¡œ ë³µì œ í›„ ë§ˆìš´íŠ¸ êµì²´
sudo btrfs subvolume delete /@                  # ì¡°ì‹¬! ì˜¤í”„ë¼ì¸/ë¼ì´ë¸ŒCDì—ì„œ
sudo btrfs subvolume snapshot /.snapshots/@root_pre_upgrade_2025-11-11 /@
```

---

## ğŸ”§ 6. ìš´ì˜ ì ê²€(í•„ìˆ˜ ëª…ë ¹ ëª¨ìŒ)

### 6.1 Btrfs
```bash
sudo btrfs subvolume list /
sudo btrfs filesystem usage /
sudo btrfs scrub start -Bd /
sudo btrfs balance start -dlimit=3 -mlimit=3 /
sudo btrfs check --readonly /dev/sdX1     # ì˜¤í”„ë¼ì¸ ì ê²€(ì£¼ì˜)
```

### 6.2 ZFS
```bash
sudo zpool status
sudo zpool scrub tank
sudo zfs list -t snapshot
sudo zfs get all tank/data | less
```

---

## ğŸ§· 7. Timeshift/Snapper/Sanoid/zrepl â€” ìš´ì˜ ìë™í™” íˆ´

- **Timeshift(Btrfs/rsync)**: ë°ìŠ¤í¬íƒ‘ ë³µêµ¬ ì§€í–¥(GUI/CLI), ì‹œìŠ¤í…œ ìŠ¤ëƒ…ìƒ· ìŠ¤ì¼€ì¤„ëŸ¬
- **Snapper(Btrfs)**: openSUSE ì¶œì‹ . yast/zypperì™€ í›Œë¥­í•œ í†µí•©. í”„ë£¨ë‹ ì •ì±… ê°•ë ¥
```bash
sudo snapper -c root create-config /
sudo snapper -c root create --type single --cleanup-algorithm number --description "manual"
sudo snapper -c root list
```
- **Sanoid/Syncoid(ZFS)**: ìŠ¤ëƒ…ìƒ· ì •ì±…/ë³´ì¡´ + send/receive ìë™í™”ì˜ ë°íŒ©í†  í‘œì¤€
- **zrepl(ZFS)**: í´ëŸ¬/í‘¸ì…” ëª¨ë¸, ì¡/í•„í„° ê¸°ë°˜ì˜ í˜„ëŒ€ì  ì¦ë¶„ ë³µì œ í”„ë ˆì„ì›Œí¬

---

## âš ï¸ 8. ì£¼ì˜í•  ì (ì•ˆì „ ì§€ì¹¨)

1) **ìŠ¤ëƒ…ìƒ· â‰  ë°±ì—…**
   - ê°™ì€ ì¥ë¹„/í’€ì—ë§Œ ìˆë‹¤ë©´ **ì¥ì¹˜ ê³ ì¥/ì‹¤ìˆ˜/ëœì„¬ì›¨ì–´**ì— ì·¨ì•½.
   - **ì˜¤í”„ì‚¬ì´íŠ¸/ì˜¤í”„ë¼ì¸**(ë‹¤ë¥¸ ì„œë²„/ìŠ¤í† ë¦¬ì§€)ì— **ì¦ë¶„ ì „ì†¡**ì„ ë°˜ë“œì‹œ ì¶”ê°€.

2) **ë°í”„ë˜ê·¸/ë°¸ëŸ°ìŠ¤ ë‚¨ìš© ê¸ˆì§€**
   - CoW íŒŒì¼ì‹œìŠ¤í…œì€ ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ê°€ ë¹ˆë²ˆ. ë¹„ìš© í° ì‘ì—…ì€ **ë¶€ë¶„/ê³„íšì  ìˆ˜í–‰**.

3) **ZFS dedupëŠ” ì‹ ì¤‘íˆ**
   - ë©”ëª¨ë¦¬ ë° ì„±ëŠ¥ ë¹„ìš©ì´ í¼. **ì•„ì¹´ì´ë¸Œ/ì´ë¯¸ì§€ ì €ì¥ì†Œ** ë“± ì¤‘ë³µ ë¸”ë¡ì´ ì••ë„ì ìœ¼ë¡œ ë§ì€ ê³³ì—ë§Œ.

4) **NOCOW ì‚¬ìš©ì€ ìµœì†Œí™”**
   - ë¬´ê²°ì„±/ì²´í¬ì„¬ ì´ì ì„ ìƒëŠ”ë‹¤. DB/VM ë“± í•„ìš”í•œ ëŒ€ìƒë§Œ ì‚¬ì „ì— ì§€ì •.

5) **ë¶€íŠ¸ í†µí•©**
   - ë£¨íŠ¸ ì„œë¸Œë³¼ë¥¨ ì „í™˜ ì‹œ GRUB/í˜¸ì¶œìì—ê²Œ `subvol=` íŒŒë¼ë¯¸í„°ê°€ ì •í™•íˆ ì „ë‹¬ë˜ì–´ì•¼ í•œë‹¤.

---

## ğŸ§® 9. ê³µê°„/ì„±ëŠ¥ ì§ê´€ì‹ ê³µì‹ ëª‡ ê°€ì§€

### 9.1 ì••ì¶•ìœ¼ë¡œ ì ˆì•½ë˜ëŠ” ê³µê°„ ê·¼ì‚¬
ì••ì¶•ë¥ ì„ \(r \in (0,1]\)ë¼ í•˜ë©´, ë°ì´í„° \(D\)ì— ëŒ€í•´ ì €ì¥ ê³µê°„ \(D'\)ëŠ”
$$
D' \approx r \cdot D
$$
`zstd`ëŠ” ì¼ë°˜ì ìœ¼ë¡œ í…ìŠ¤íŠ¸/ë¡œê·¸/ì†ŒìŠ¤ì½”ë“œì—ì„œ \(r \ll 1\) (ê³ ì••ì¶•), ì˜ìƒ/ì´ë¯¸ì§€(ì´ë¯¸ ì••ì¶• í¬ë§·)ëŠ” \(r \approx 1\).

### 9.2 ì¦ë¶„ ì „ì†¡ëŸ‰
ìŠ¤ëƒ…ìƒ· ì‚¬ì´ ë³€ê²½ëŸ‰ì„ \(\Delta\)ë¼ í•˜ë©´ ì „ì†¡ëŸ‰ì€
$$
T \approx \Delta + \epsilon
$$
(\(\epsilon\)ì€ ë©”íƒ€ë°ì´í„°/í—¤ë” ì˜¤ë²„í—¤ë“œ). **ì§§ì€ ì£¼ê¸° ìŠ¤ëƒ…ìƒ·**ì€ \(\Delta\)ë¥¼ ì‘ê²Œ ìœ ì§€ â†’ ë°±ì—… ì°½êµ¬/ëŒ€ì—­í­ ì•ˆì •.

### 9.3 ë¸”ë¡ í¬ê¸°ì™€ ëœë¤ IO
ë ˆì½”ë“œì‚¬ì´ì¦ˆ(ë˜ëŠ” Btrfs ë‚´ë¶€ ì²­í¬/ë…¸ë“œ)ì˜ ìµœì í™”ëŠ” ì›Œí¬ë¡œë“œë³„ **ëœë¤ vs ìˆœì°¨** íŒ¨í„´ê³¼ ê´€ë ¨.
- ìˆœì°¨ ëŒ€íŒŒì¼: í° recordsize(ì˜ˆ: ZFS 1M) â†’ ëŒ€ì—­í­ íš¨ìœ¨â†‘
- DB/ë¡œê·¸: ì‘ì€ recordsize(ì˜ˆ: 16K/8K) â†’ ë¶€ë¶„ ì—…ë°ì´íŠ¸ íš¨ìœ¨â†‘

---

## ğŸ“ 10. ë¹ ë¥¸ ë ˆí¼ëŸ°ìŠ¤(ìš”ì•½ í‘œ)

| ì£¼ì œ | Btrfs | ZFS |
|---|---|---|
| ìŠ¤ëƒ…ìƒ· ë‹¨ìœ„ | Subvolume | Dataset |
| ìŠ¤ëƒ…ìƒ· ì¢…ë¥˜ | rw/ro(ê¶Œì¥ ro) | ro, cloneìœ¼ë¡œ rw ë¸Œëœì¹˜ |
| ì¦ë¶„ ì „ì†¡ | `btrfs send/receive -p` | `zfs send/receive -i/-I` |
| ì••ì¶• | `compress=zstd` | `compression=zstd|lz4` |
| ì¤‘ë³µì œê±° | ìœ ì €ëœë“œ ë„êµ¬/ì‹¤í—˜ì  | `dedup=on`(ì£¼ì˜) |
| ë¬´ê²°ì„±/ìŠ¤í¬ëŸ½ | `btrfs scrub` | `zpool scrub` |
| ê³µê°„ íšŒìˆ˜ | balance(ì ˆì œ), defrag | ìŠ¤ëƒ… í”„ë£¨ë‹ ìœ„ì£¼ |
| ê¶Œì¥ íˆ´ | snapper/timeshift | sanoid/syncoid, zrepl |

---

## âœ¨ ë§ˆë¬´ë¦¬

- **ìŠ¤ëƒ…ìƒ·ì€ â€œì‹œê°„ì˜ ë¶ë§ˆí¬â€**ì´ë©°, CoW ë•ë¶„ì— **ë¹ ë¥´ê³  ê²½ì œì **ì´ë‹¤.
- **Btrfs**ëŠ” ì„œë¸Œë³¼ë¥¨ ê¸°ë°˜ìœ¼ë¡œ **ë°ìŠ¤í¬íƒ‘/ì„œë²„ ëª¨ë‘**ì—ì„œ ìœ ì—°í•˜ê³ , **ZFS**ëŠ” ê°•ë ¥í•œ **ë¬´ê²°ì„±/ë³µì œ/íŠœë‹** ë¬´ê¸°ë¥¼ ì œê³µí•œë‹¤.
- ì‹¤ì „ì€ **ë ˆì´ì•„ì›ƒ ì„¤ê³„ â†’ ë§ˆìš´íŠ¸/ì••ì¶• â†’ ìŠ¤ëƒ…ìƒ· ìŠ¤ì¼€ì¤„ â†’ ì¦ë¶„ ì „ì†¡ â†’ í”„ë£¨ë‹ â†’ ì •ê¸° ìŠ¤í¬ëŸ½**ì˜ ë£¨í‹´ì„ **ìë™í™”**í•˜ëŠ” ì¼ì´ë‹¤.
- ë§ˆì§€ë§‰ìœ¼ë¡œ, ìŠ¤ëƒ…ìƒ·ì€ ë¡œì»¬ ì‚¬ê³ ì— ì·¨ì•½í•˜ë¯€ë¡œ **ì˜¤í”„ì‚¬ì´íŠ¸ ì¦ë¶„ ë°±ì—…**ì„ ë°˜ë“œì‹œ ê°™ì´ ìš´ì˜í•˜ë¼.
