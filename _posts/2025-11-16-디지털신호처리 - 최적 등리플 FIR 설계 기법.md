---
layout: post
title: 디지털신호처리 - 최적 등리플 FIR 설계 기법
date: 2025-11-16 19:25:23 +0900
category: 디지털신호처리
---
# 최적 등리플 FIR 설계 기법

## 왜 “최적 등리플”인가? — 창함수/주파수 샘플링 vs Equiripple

앞에서 본 설계 기법들을 간단히 요약해 두자.

- **창함수 설계**
  이상적인 주파수 응답의 **시간 영역 임펄스 응답**을 자르고, **창(window)** 를 곱해서 지터를 줄이는 방법.
  - 장점: 구현·이해가 쉽고, 설계 직관이 좋다.
  - 단점: 통과/저지 대역 리플, 전이 대역 폭을 “정확히 제어”하기 어렵다. 주로 경험적.

- **주파수 샘플링 설계**
  이상적 주파수 응답을 일정한 주파수 격자에 샘플링해서 IDFT/IFT를 취해 FIR 계수를 얻는 방식.
  - 장점: 원하는 주파수 격자에 직접 값을 줄 수 있다.
  - 단점: 격자 외 구간에서의 리플, 전이대역 거동을 정밀하게 제어하기 어렵다.

**최적 등리플 FIR 설계**는 이런 질문에서 출발한다.

> “주어진 필터 차수에서,
> 통과/저지 대역 리플을 **최소의 최악값(maximum ripple)** 으로 만드는 계수는 무엇인가?”

이것이 바로 **minimax(최소 최대)** 혹은 **Chebyshev 최적화** 문제다.

- 등리플(equiripple):
  설계된 필터의 **오차 곡선**이
  통과/저지 대역에서 여러 번 **동일 크기**로 반복해서 위아래로 진동하는 형태.

- 직관:
  한 곳에서 리플을 줄이면, 다른 곳에서 리플이 커진다.
  “어느 구간의 리플도 억울하게 크지 않게” **전체를 균등하게 나눠 가지는** 구조가
  minimax 관점에서 최적인 경우가 많다.

이를 **엄밀하게** 풀어내는 것이 **Parks–McClellan 알고리즘(= Remez 교환법의 특수형)** 이고,
GNU Octave에서는 `remez` 함수로 구현되어 있다.

---

## 문제 정식화: 가중 minimax 최적화

### 이상적인 응답과 설계 대상

디지털 FIR 필터의 주파수 응답을

$$
H(e^{j\omega}) = \sum_{n=0}^{M} h[n] e^{-j\omega n}
$$

이라고 하자. (선형 위상 FIR라면 계수가 대칭/반대칭이지만, 일단 일반형으로 둔다.)

우리는 보통 특정 대역에서 **이상적인 주파수 응답**을 지정한다.

예: 저역통과 필터

$$
H_d(e^{j\omega}) =
\begin{cases}
1, & 0 \le \omega \le \omega_p \\[4pt]
0, & \omega_s \le \omega \le \pi
\end{cases}
$$

중간의 전이대역
$$\omega_p < \omega < \omega_s$$
에서는 아무 요구를 하지 않거나, 완만한 조건만 둔다.

### 오차 함수 정의

**가중 오차(weighted error)** 를 다음처럼 정의한다.

$$
E(\omega)
=
W(\omega)\bigl[H_d(e^{j\omega}) - H(e^{j\omega})\bigr]
$$

여기서

- $$W(\omega) \ge 0$$: 가중 함수
  - 통과대역 오차가 저지대역 오차보다 덜 중요하면 통과대역에서 작은 가중을 준다.
  - 반대로 저지대역 감쇠를 엄격히 요구하면 저지대역에 큰 가중을 준다.

**최적 등리플 설계 문제**는 다음과 같이 적는다.

$$
\min_{h[n]} \, \max_{\omega \in \Omega} |E(\omega)|
$$

여기서 $$\Omega$$ 는 우리가 관심 있는 주파수 범위 (보통 통과대역과 저지대역의 합집합).

- 이 문제의 해는 “오차의 절댓값이 가능한 한 작고,
  그 오차가 통과/저지 대역에서 **등리플**이 되는 형태”로 나타난다.

---

## 선형 위상 FIR로의 축소 — 실질적인 최적화 변수 줄이기

### 선형 위상 FIR 구조

앞에서 정리했듯, 선형 위상 FIR는 크게 네 가지 타입(Type I~IV)의 계수 대칭성을 가진다.
대표적으로 **Type I (길이 홀수, 대칭)** 를 보면:

길이 $$L = 2N + 1$$ 인 FIR에서

$$
h[n] = h[L-1-n] = h[2N-n]
$$

이고, 주파수 응답은

$$
H(e^{j\omega})
= e^{-j\omega N}\, A(\omega)
$$

이때
$$A(\omega)$$ 는 “순수 실수인 진폭 응답”이다.

$$
A(\omega)
= \sum_{k=0}^{N} a_k \cos(\omega k)
$$

여기서 $$a_k$$ 들은 $$h[n]$$ 의 특정 선형결합이다.
즉, 선형 위상 FIR의 설계 문제는 **실수 진폭 다항식** $$A(\omega)$$ 를 설계하는 것으로 축소된다.

- 위상은 자동으로 $$e^{-j\omega N}$$ 로 고정 (그룹지연 N 샘플).
- 우리가 설계해야 할 것은 **진폭 응답** 뿐.

### minimax 문제 재정의

이제 오차는

$$
E(\omega)
=
W(\omega)\bigl[D(\omega) - A(\omega)\bigr]
$$

형태가 된다. 여기서

- $$D(\omega)$$: 원하는 진폭(예: 저역통과에서 1 또는 0)
- $$A(\omega)$$: 위에서 본 cos 시리즈

최적화 문제는 동일하다.

$$
\min_{a_k} \, \max_{\omega \in \Omega} |E(\omega)|
$$

대칭을 활용하면, 계수 개수는

- 필터 길이 $$L = 2N+1$$ 이더라도
- 최적화 변수가 $$N+1$$ 개 $$a_0,\dots,a_N$$ 으로 줄어든다.

Remez 교환 알고리즘은 이 **실수 cos 시리즈 계수**들에 대해 작동한다.

---

## Chebyshev 근사와 교대 정리(Alternation Theorem)

최적 등리플 설계의 이론적 기반은 **Chebyshev 다항식**과 **교대 정리(Alternation theorem)** 에 있다.

### minimax 근사와 Chebyshev 함수

단일 구간 $$[a,b]$$ 에서 어떤 함수 $$F(x)$$ 를
다항식 $$P(x)$$ 로 근사할 때

$$
\min_{P(x)} \max_{x\in[a,b]} |F(x)-P(x)|
$$

형태의 문제를 **Chebyshev(minimax) 근사**라고 부른다.

이때 **최적 다항식의 오차 함수**는

- 절댓값이 **동일한 크기**의 극대값을 여러 점에서 가진다.
- 그 최대값들의 부호가 **번갈아(+, -, +, -, …)** 나오는 특징이 있다.

이를 **교대 정리**라고 한다.

정리의 요지는 다음과 같다(아이디어 차원):

> 차수가 $$M$$ 인 근사 다항식에 대한 최적 해가 존재한다면,
> 그 오차 함수는 수렴 구간 내에서 최소 $$M+2$$ 개의 교대로 부호가 바뀌는 extrema 를 가져야 한다.

이 성질 덕분에 **최적화 문제를 “선형 연립방정식 + 교대점 갱신”의 반복 문제로 바꿀 수 있다.**

### FIR 설계에 대한 적용

선형 위상 FIR 설계에서 우리는

$$
A(\omega) = \sum_{k=0}^{N} a_k \cos(\omega k)
$$

을 설계한다. 이것은 $$\cos(\omega)$$ 를 변수로 하는 다항식에 해당하므로,
Chebyshev 근사와 같은 구조를 가진다.

- 계수 개수: $$N+1$$
- 최적 오차의 극대값은 통과/저지대역에서 최소 $$N+2$$ 개의 교대점을 가진다.

이 이론이 **Remez 교환 알고리즘**의 핵심이다.

---

## Remez 교환 알고리즘(개념)

### 알고리즘 개요

선형 위상 FIR 설계의 Remez 교환 알고리즘 개요는 다음과 같다:

1. 설계하고 싶은 대역(통과·저지)을 **연속 주파수 축**으로 규정.
2. 그 축을 **많은 샘플 지점**으로 이산화.
3. 그 중에서 임의 혹은 heuristic으로
   $$N+2$$ 개의 주파수 지점을 “교대점 후보”로 선택.
4. 이 지점들에서 **가중 오차가 동일한 절댓값을 가지도록** 선형 시스템을 풀어
   $$a_k$$ 와 오차 크기 $$\delta$$ 를 구한다.
5. 새로 얻은 $$a_k$$ 로 전체 주파수 격자에서 오차를 계산하고,
   **진짜 극대점들(오차의 절대값이 큰 지점들)** 을 찾는다.
6. 이 새로운 극대점들 중에서 다시 **교대하는 $$N+2$$ 개**를 뽑아 새 집합으로 삼는다.
7. 수렴할 때까지 4~6을 반복.

이 과정에서

- 오차의 최대값이 점점 감소하거나,
- 교대점 집합(주파수 위치)이 거의 변하지 않는 지점에서 수렴으로 본다.

### 선형 시스템의 형태

선형 위상 FIR에서의 진폭 표현:

$$
A(\omega_i) = \sum_{k=0}^{N} a_k \cos(\omega_i k)
$$

오차 함수:

$$
E(\omega_i) = W(\omega_i)\bigl[D(\omega_i)-A(\omega_i)\bigr]
$$

Remez의 핵심은

$$
E(\omega_i) = (-1)^i \delta
$$

같은 형태(등리플)를 만족하도록 $$a_k$$ 과 $$\delta$$ 를 동시에 결정하는 것이다.

즉, 교대점 $$\{\omega_0,\dots,\omega_{N+1}\}$$ 에 대해

$$
W(\omega_i)\left[D(\omega_i) - \sum_{k=0}^{N} a_k \cos(\omega_i k)\right]
= (-1)^i \delta
$$

라는 $$N+2$$ 개의 식을 세우고,
$$N+1$$ 개의 $$a_k$$ + 1개의 $$\delta$$ 를 풀면 된다.

이렇게 얻은 $$a_k$$ 는 “교대점 집합에 대해 최적”이지만,
전체 대역에 대해 역시 최적인지 확인하기 위해 다시 교대점 갱신 단계로 돌아간다.

---

## GNU Octave에서의 최적 등리플 설계 도구: `remez`

GNU Octave의 signal 패키지는 **Parks–McClellan(= Remez)** 알고리즘을 구현한 `remez` 함수를 제공한다.

형태는 다음과 같다.

```octave
b = remez(N, f, a, w)
```

- `N`: 필터 차수 (계수 개수 - 1, 즉 길이가 N+1)
- `f`: 주파수 구간(벡터), 0~1 범위 (0: DC, 1: Nyquist = $$\pi$$)
- `a`: 각각의 구간에 대해 원하는 진폭(벡터)
- `w`: 각 대역의 가중치(벡터)

간단 요약:

- `f` 길이가 `2 * nbands` 이고, `[f0 f1 f2 f3 ...]` 형태.
  - `[f0 f1]` → 첫 번째 대역
  - `[f2 f3]` → 두 번째 대역, …
- `a` 길이는 `2 * nbands`.
  - `[a0 a1 a2 a3 ...]`, 대역별로 원하는 진폭 수준.
- `w` 길이는 `nbands`.
  - 각 대역의 오차 가중치.

예: 하나의 저역통과 필터
- 통과 대역: $$[0, \omega_p]$$
- 저지 대역: $$[\omega_s, \pi]$$

을 설계할 경우,

- `f = [0 fp fs 1]`
- `a = [1 1 0 0]`
- `w = [Wpass Wstop]`

형식으로 쓴다. 여기서 `fp = ωp/π`, `fs = ωs/π`.

---

## 기본 예제 1: 저역통과 최적 등리플 FIR 설계

### 사양 설정

샘플링 주파수 $$F_s = 48\,\text{kHz}$$,
저역통과 필터를 설계한다고 하자.

- 통과 대역 끝: $$F_p = 4.8\,\text{kHz} \Rightarrow f_p = F_p/(F_s/2) = 0.2$$
- 저지 대역 시작: $$F_s' = 7.2\,\text{kHz} \Rightarrow f_s = 7.2/24 = 0.3$$
- 통과대역 허용 리플: 약 0.01 (1%)
- 저지대역 감쇠: 최소 60 dB 수준으로 기대

필터 차수는 일단 **N = 60** 정도로 가정하고,
리플 수준은 가중치로 맞춰가며 실험한다.

### GNU Octave 코드

```octave
pkg load signal   % remez, freqz 등 사용

Fs = 48000;
Fp = 4800;
Fs1 = 7200;

fp = Fp / (Fs/2);   % 0~1로 정규화
fs = Fs1 / (Fs/2);

N  = 60;            % filter order (길이 N+1 = 61)

f = [0, fp, fs, 1]; % 주파수 대역
a = [1, 1, 0, 0];   % 통과: 1, 저지: 0

Wpass = 1;    % 통과대역 가중
Wstop = 10;   % 저지대역 가중 (저지대역 오차를 더 작게 만들고 싶음)
w = [Wpass, Wstop];

b = remez(N, f, a, w);  % 최적 등리플 계수 계산

% 주파수 응답 확인
[H, wgrid] = freqz(b, 1, 4096);

fgrid = wgrid / pi;  % 0~1

figure;
subplot(2,1,1);
plot(fgrid, abs(H));
grid on;
xlabel('Normalized Frequency');
ylabel('|H(e^{j\omega})|');
title('Equiripple Lowpass FIR (Magnitude)');

subplot(2,1,2);
plot(fgrid, 20*log10(abs(H) + eps));
grid on;
xlabel('Normalized Frequency');
ylabel('Magnitude (dB)');
title('Magnitude in dB');
ylim([-100 5]);
```

- `Wstop` 를 키우면 저지대역 리플(감쇠)이 더 좋아지고,
  대신 통과대역 리플이 약간 커지는 경향이 있다.
- 반대로 `Wpass` 를 키우면 통과대역 리플을 더 줄이는 대신,
  저지대역 감쇠가 다소 희생된다.

### 등리플 형태 확인

주파수 축에서

- 통과대역에서는 진폭이 1을 중심으로 **±δp** 정도로 **지그재그**.
- 저지대역에서는 0을 중심으로 **±δs** 정도로 지그재그.

이 리플들이 **가중 오차 기준으로 거의 동일 높이**를 가지는 형태가
최적 등리플 해의 특징이다.

---

## 예제 2: 고역통과 최적 등리플 FIR

고역통과 필터는 저역통과를 **스펙 변환**해서 만들 수도 있지만,
`remez` 에 직접 고역통과 스펙을 줄 수도 있다.

### 사양 설정

- 샘플링: $$F_s = 48\,\text{kHz}$$
- 저지대역 끝: $$F_{s0} = 6\,\text{kHz} \Rightarrow f_{s0} = 6/24 = 0.25$$
- 통과대역 시작: $$F_{p0} = 9.6\,\text{kHz} \Rightarrow f_{p0} = 9.6/24 = 0.4$$
- 필터 차수: N = 60

### Octave 코드

```octave
pkg load signal

Fs = 48000;
Fs0 = 6000;
Fp0 = 9600;

fs0 = Fs0 / (Fs/2);
fp0 = Fp0 / (Fs/2);

N = 60;

f = [0, fs0, fp0, 1];
a = [0, 0, 1, 1];     % 저역: 0, 고역: 1
w = [10, 1];          % 저역대역 감쇠를 더 중요하게

b_hp = remez(N, f, a, w);

[H_hp, wgrid] = freqz(b_hp, 1, 4096);
fgrid = wgrid / pi;

figure;
subplot(2,1,1);
plot(fgrid, abs(H_hp)); grid on;
xlabel('Normalized Frequency'); ylabel('|H|');
title('Equiripple Highpass FIR');

subplot(2,1,2);
plot(fgrid, 20*log10(abs(H_hp)+eps)); grid on;
xlabel('Normalized Frequency'); ylabel('dB');
title('Magnitude (dB)');
ylim([-100 5]);
```

- 주파수 응답에서 **고역대역**에서 1을 중심으로 리플,
  저역대역에서 0 주변 리플을 볼 수 있다.
- 여전히 등리플 원리가 적용된다.

---

## 예제 3: 대역통과 / 대역저지 다중 대역 설계

최적 등리플의 장점 중 하나는 **다중 대역(multiband)** 필터 설계가 매우 자연스럽다는 점이다.

### 대역통과 예제

사양:

- 샘플링: $$F_s = 48\,\text{kHz}$$
- 통과대역: 6~9 kHz
- 저지대역1: 0~4.8 kHz
- 저지대역2: 10.8~24 kHz

즉, 통과대역 중심 7.5 kHz 정도를 갖는 대역통과.

정규화:

- 통과: $$[6, 9]/24 \Rightarrow [0.25, 0.375]$$
- 저지1: 0~4.8 kHz → $$[0, 0.2]$$
- 저지2: 10.8~24 kHz → $$[0.45,1]$$

Octave 코드:

```octave
pkg load signal

Fs = 48000;
F1 = 6000;  F2 = 9000;
Fs1 = 4800; Fs2 = 10800;

f1 = F1 / (Fs/2);
f2 = F2 / (Fs/2);
fs1 = Fs1 / (Fs/2);
fs2 = Fs2 / (Fs/2);

N = 80;  % 대역이 좁으므로 약간 더 긴 필터

% [저지1] [통과] [저지2]
f = [0, fs1, f1, f2, fs2, 1];
a = [0, 0, 1, 1, 0, 0];
w = [10, 1, 10];   % 저지대역 감쇠에 큰 가중

b_bp = remez(N, f, a, w);

[H_bp, wgrid] = freqz(b_bp, 1, 4096);
fgrid = wgrid / pi;

figure;
subplot(2,1,1);
plot(fgrid, abs(H_bp)); grid on;
xlabel('Normalized Frequency'); ylabel('|H|');
title('Equiripple Bandpass FIR');

subplot(2,1,2);
plot(fgrid, 20*log10(abs(H_bp)+eps)); grid on;
xlabel('Normalized Frequency'); ylabel('dB');
title('Magnitude (dB)');
ylim([-120 5]);
```

- 통과대역에서 리플이 등리플.
- 두 저지대역에서도 각각 등리플(가중 포함)이 나타난다.

---

## 가중치 선택과 리플 비율

### 가중치와 리플의 관계

가중 오차 정의를 다시보면

$$
E(\omega) = W(\omega)[D(\omega)-A(\omega)]
$$

최적 등리플에서 **가중 오차**가 등리플이므로

$$
\max_{\omega \in \text{pass}} |E(\omega)| = \max_{\omega \in \text{stop}} |E(\omega)| = \delta
$$

- 통과대역 리플(진폭 기준) ≈ $$\delta / W_{\text{pass}}$$
- 저지대역 리플(진폭 기준) ≈ $$\delta / W_{\text{stop}}$$

따라서

$$
\frac{\text{stopband ripple}}{\text{passband ripple}}
\approx
\frac{W_{\text{pass}}}{W_{\text{stop}}}
$$

즉, 가중치 비를 조정하면 **통과대역 vs 저지대역 리플 비율**을 제어할 수 있다.

### 실험: 가중치 변화

Octave에서 통과대역/저지대역 가중치 비를 여러 값으로 바꿔가며
리플을 측정해볼 수 있다.

```octave
pkg load signal

Fs = 48000;
Fp = 4800;
Fs1 = 7200;
fp = Fp / (Fs/2);
fs = Fs1 / (Fs/2);

N = 60;
f = [0, fp, fs, 1];
a = [1, 1, 0, 0];

weights = [1, 1; 1, 10; 1, 100]; % [Wpass, Wstop] 조합

for idx = 1:size(weights,1)
  Wpass = weights(idx,1);
  Wstop = weights(idx,2);
  w = [Wpass, Wstop];

  b = remez(N, f, a, w);
  [H, wgrid] = freqz(b,1,4096);
  fgrid = wgrid / pi;

  % 간단히 대역을 나눠 리플 측정
  pass_idx = find(fgrid <= fp);
  stop_idx = find(fgrid >= fs);

  pass_mag = abs(H(pass_idx));
  stop_mag = abs(H(stop_idx));

  rp = max(pass_mag) - min(pass_mag);
  rs = max(stop_mag);

  printf("Wpass=%.1f, Wstop=%.1f -> rp≈%.3e, rs≈%.3e (|H_stop,max|)\n", ...
          Wpass, Wstop, rp, rs);
end
```

- `rp`: 통과대역 진폭 리플
- `rs`: 저지대역 최대 진폭(0에서 얼마나 위로 튀는지)

`Wstop` 이 커질수록 `rs` 가 줄고, 대신 `rp` 가 조금 늘어나는 방향으로 바뀌는 것을 볼 수 있다.

---

## 다른 필터 유형: Differentiator, Hilbert 변환기

최적 등리플 방법은 단순 **저역/고역/대역통과** 외에
다음과 같은 특수 FIR도 설계할 수 있다.

- **미분기(differentiator)**:
  원하는 진폭이

  $$
  |H_d(e^{j\omega})| = \omega \quad \text{또는} \quad \omega^\alpha
  $$

  같은 형태 (저주파 미분기).

- **Hilbert 변환기**:
  진폭이 1이고 위상이 $$-\pi/2$$ 또는 $$+\pi/2$$ 인 필터.
  즉, 입력을 90도 위상 이동시키는 필터.

GNU Octave의 `remez` 는 옵션 인자로 **필터 유형**을 지정할 수 있다.
(선형 위상 Type I~IV 기반 + differentiator/Hilbert 옵션 등)

문법은 버전에 따라 약간 다를 수 있으므로,
필요시 `help remez` 를 통해 지원되는 모드를 확인한 뒤 사용하는 것이 좋다.

간단 예로, differentiator (저주파 대역에서 등리플 미분기):

```octave
pkg load signal

N = 60;
f = [0, 0.3, 1];        % [0, 0.3] 구간에서 미분기 특성
a = [0, 0.3, 0];        % 크기 ~ ω (정규화) 형태로 줄 수도 있지만,
                        % 단순 예제로 0~0.3까지 선형증가 모양을 줌
w = [1, 0];             % 미분기 구간만 중요하게

% 일부 구현에서는 'differentiator' 모드를 명시할 수 있음
% b_diff = remez(N, f, a, w, 'differentiator');
b_diff = remez(N, f, a, w);  % 심플 예, 일반 모드

[H_diff, wgrid] = freqz(b_diff, 1, 4096);
fgrid = wgrid / pi;

figure;
plot(fgrid, abs(H_diff));
grid on;
xlabel('Normalized Frequency');
ylabel('|H|');
title('Approximate Differentiator via Equiripple');
```

실전에서는 differentiator용 `a`를
$$|H_d(e^{j\omega})| = \omega$$ 또는 $$\omega^\alpha$$에 비례하도록 설계하고,
그에 맞는 가중을 준 뒤 `remez` 를 호출한다.

---

## 최적 등리플 vs 창함수/주파수 샘플링 — 비교

### 주어진 차수에서의 성능

동일 차수 $$N$$ 에 대해

- 창함수 설계:
  - 전이대역 폭, 저지대역 리플을 대략적·경험적으로 조정.
  - 최악 리플이 “최소”라는 보장은 없다.

- 주파수 샘플링 설계:
  - 주파수 격자에서 이상 응답을 지정했지만,
    그 사이 주파수의 오차는 최적이 아닐 수 있다.

- 최적 등리플 설계:
  - **max 오차**(가중 오차 기준)가 수학적으로 “최소”.
  - 같은 차수라면 보통 창함수에 비해 좁은 전이대역 혹은 더 작은 리플을 달성.

그래서 **주어진 차수에서 최고의 스펙**을 뽑고 싶을 때,
또는 **차수를 최소로 줄이고 싶을 때**, 최적 등리플 설계가 거의 표준이다.

### 설계자 관점에서의 trade-off

- 장점:
  - 매우 날카로운 전이대역, 높은 저지대역 감쇠, 균등한 리플.
  - 다양한 대역·필터 유형에 적용 가능.

- 단점:
  - 알고리즘이 복잡(하지만 `remez` 함수 사용으로 숨겨짐).
  - 설계 사양을 잘못 주면 수렴이 느리거나 원치 않는 특성(예: Gibbs-like oscillation)이 발생.
  - 설계 사양과 실제 리플/감쇠의 관계를 정확히 이해할 필요.

창함수 설계는 “어느 정도 큰 그림”을 빠르게 잡기에 좋고,
최적 등리플은 “마지막에 차수 줄이기/리플 압축하기”용으로 좋다고 생각하면 된다.

---

## 고정소수점/양자화 관점의 주의사항

앞 글(양자화 과정/필터 계수 양자화)과 연결해 보면,
최적 등리플 설계를 쓴다고 해서 **계수 양자화** 문제에서 완전히 자유로운 것은 아니다.

- 최적 설계된 계수는 보통 **정밀도에 민감**하다.
- 고정소수점 구현에서는
  - IIR 보다 덜 민감하긴 하지만,
  - 긴 FIR(특히 높은 스톱밴드 감쇠를 가진 필터)에서
    계수 양자화가 통과/저지 대역 리플을 눈에 띄게 바꿀 수 있다.

GNU Octave에서 간단히 실험해보자.

```octave
pkg load signal

Fs = 48000;
Fp = 4800; Fs1 = 7200;
fp = Fp / (Fs/2); fs = Fs1 / (Fs/2);
N = 60;
f = [0, fp, fs, 1];
a = [1, 1, 0, 0];
w = [1, 10];

b = remez(N, f, a, w);   % double precision 계수

% 고정소수점 흉내: 12-bit fractional
nfrac = 12;
bq = round(b * 2^nfrac) / 2^nfrac;

[H, wgrid]  = freqz(b, 1, 4096);
[Hq, ~]     = freqz(bq, 1, 4096);
fgrid = wgrid / pi;

figure;
subplot(2,1,1);
plot(fgrid, 20*log10(abs(H)+eps), 'k-', ...
     fgrid, 20*log10(abs(Hq)+eps), 'r--');
grid on;
xlabel('Normalized Frequency');
ylabel('Magnitude (dB)');
title('Equiripple LPF: Double vs Quantized Coefficients');
legend('Double', 'Quantized');

subplot(2,1,2);
plot(fgrid, 20*log10(abs(Hq-H)+eps));
grid on;
xlabel('Normalized Frequency');
ylabel('Error (dB)');
title('Difference due to Coefficient Quantization');
```

- 저지대역 감쇠가 60 dB 수준이라면,
  12 bit fractional 계수에서 감쇠가 조금 줄어들 수 있다.
- 요구 스펙이 엄격할수록, **계수 비트수**를 늘려야 한다.

---

## 설계 절차 요약 — 실전 레시피

최적 등리플 FIR 설계를 실전에서 쓸 때의 기본 절차를 정리하면 다음과 같다.

1. **사양 정의**
   - 샘플링 주파수 $$F_s$$
   - 각 대역의 경계 주파수 $$F_{p1}, F_{s1}, F_{p2}, F_{s2}\dots$$
   - 통과대역 허용 리플 $$\delta_p$$, 저지대역 감쇠 $$A_s$$ (dB)

2. **정규화**
   - $$f_i = F_i / (F_s/2)$$ 로 0~1로 정규화.
   - `f` 벡터 구성: `[f0 f1 f2 ...]`
   - `a` 벡터 구성: `[A0 A1 A2 ...]` (각 대역에서 원하는 진폭 수준)

3. **가중치 초기 설정**
   - 통과대역 리플 목표: $$\delta_p$$
   - 저지대역 리플 목표: $$\delta_s = 10^{-A_s/20}$$
   - 비례 관계로부터

     $$
     \frac{W_{\text{stop}}}{W_{\text{pass}}}
     \approx
     \frac{\delta_p}{\delta_s}
     $$

     로 초기 가중치 비를 잡는다.

4. **필터 차수 추정**
   - 창함수 설계에서 사용하는 근사식을 사용해서 대략적인 차수를 잡거나,
   - 경험적으로 몇 개의 길이를 시도하면서 리플/감쇠를 확인.

5. **`remez` 호출**
   - `b = remez(N, f, a, w);`

6. **검증**
   - `freqz` 로 주파수 응답 확인.
   - 통과대역 리플, 저지대역 최대 레벨 측정.
   - 필요시 차수/가중치 재조정.

7. **양자화/고정소수점 고려**
   - 구현 환경의 비트수를 고려해 계수 양자화 시뮬레이션.
   - 필요시 필터 차수/비트수/스케일링 재조정.

---

## 연습 문제 (GNU Octave 실습 중심)

앞에서 정리한 내용을 실제로 손으로·코드로 확인하기 위한 연습 문제를 정리한다.

### 문제 1) 저역통과 Equiripple vs Hamming 설계 비교

1. 동일한 사양
   - $$F_s = 48\,\text{kHz}$$,
   - 통과대역 끝 $$4.8\,\text{kHz}$$, 저지대역 시작 $$7.2\,\text{kHz}$$,
   - 필터 차수 $$N = 60$$.
2. Hamming 창을 사용한 창함수 설계와,
   최적 등리플 설계( `remez` )를 각각 수행하라.
3. 각 필터에 대해
   - 통과대역 리플(진폭 차이)
   - 저지대역 최대 진폭(감쇠 dB)
   를 측정하고 비교하라.

힌트 코드:

```octave
pkg load signal

Fs = 48000; Fp = 4800; Fs1 = 7200;
fp = Fp/(Fs/2); fs = Fs1/(Fs/2);
N  = 60;

% 1) Equiripple
f = [0, fp, fs, 1];
a = [1, 1, 0, 0];
w = [1, 10];
b_eq = remez(N, f, a, w);

% 2) Hamming window design (fir1)
b_hm = fir1(N, fp, "low", hamming(N+1));

% 응답 비교
[Heq, wgrid] = freqz(b_eq, 1, 4096);
[Hhm, ~]     = freqz(b_hm, 1, 4096);
fgrid = wgrid / pi;

% 리플 측정은 앞에서 한 것과 비슷하게 pass_idx, stop_idx 나눠서 수행
```

---

### 문제 2) 다중대역 Equi-ripple 필터 설계

전화/오디오 처리를 참고해 다음과 같은 필터를 설계하라.

- 샘플링: $$F_s = 16\,\text{kHz}$$
- 통과대역1: 0.3~3.4 kHz
- 저지대역1: 0~0.2 kHz
- 저지대역2: 3.6~8 kHz

1. 두 저지대역과 하나의 통과대역을 갖는 **대역통과 필터**를
   `remez` 로 설계하라.
2. 저지대역 감쇠를 더 무겁게 보기 위해 적절한 가중치 `w`를 설정하라.
3. 창함수 설계(예: Blackman 창)로 만든 대역통과와 성능을 비교하라.

---

### 문제 3) 가중치와 리플 비율 수치 검증

1. 간단한 저역통과 필터를 설계한다.
2. 통과/저지대역에 대해 서로 다른 가중치 비(예: 1:1, 1:10, 1:100)를 줘가며
   세 가지 필터를 설계하라.
3. 각 필터에 대해
   - 통과대역 리플 최대값(진폭 기준)
   - 저지대역 최대 진폭
   을 측정하고, 리플 비 비율과 가중치 비 관계를 관찰하라.

---

### 문제 4) Equi-ripple Differentiator 설계

1. 저주파 영역에서

   $$
   |H_d(e^{j\omega})| = \omega
   $$

   에 가까운 **등리플 미분기**를 설계하라.
2. 대상 대역은 $$0 \le \omega \le 0.3\pi$$ 로 둔다.
3. `remez` 로 계수를 구하고, 실제 진폭 응답과 이상 진폭(직선)을 비교하라.
4. 미분기 계수에 소량의 양자화(예: 10 bit fractional)를 가했을 때
   저주파 영역에서의 오차가 어떻게 변하는지 관찰하라.

---

### 문제 5) Hilbert 변환기 Equi-ripple 설계(고급)

1. $$F_s = 48\,\text{kHz}$$ 에서 300 Hz 이상 대역에 대해
   근사적인 **Hilbert 변환기** FIR 필터(90도 위상 이동)를 설계하라.
2. 각 주파수에서 입력 사인파와 출력 사인파 위상 차이를 측정해
   “90도 ± 리플” 형태를 확인하라.
3. 이 때 사용한 `remez` 옵션(필터 타입)을 GNU Octave 문서에서 확인하고 적용하라.

---

## 결론 — Equi-ripple은 “마지막 1 dB”를 쥐어짜는 도구

정리하면, **최적 등리플 FIR 설계**는 다음과 같은 위치에 있다.

1. **주어진 차수에서 최적**
   - 창함수나 주파수 샘플링보다, 같은 차수에서 더 좋은 리플/감쇠를 얻을 수 있다.
   - 반대로, 같은 리플/감쇠를 달성하는 데 필요한 차수를 줄일 수 있다.

2. **수학적 기반 (Chebyshev/minimax)**
   - 오차 함수의 등리플/교대 특성에 기반한 정교한 최적화 문제.
   - Remez 교환 알고리즘으로 실용적으로 해결 가능.

3. **GNU Octave에서의 구현**
   - `remez` 함수로 대부분의 표준 FIR를 설계할 수 있다.
   - 멀티밴드, 고역통과, 대역통과, differentiator, Hilbert 등 다양한 필터에 적용 가능.

4. **실무 팁**
   - 창함수 기법으로 먼저 대략적인 차수/대역폭을 감 잡은 뒤,
     같은 사양을 equiripple로 다시 설계해 **스펙을 압축**하는 전략이 유용하다.
   - 고정소수점/양자화 환경이라면
     필터 계수 비트수와 필터 차수 사이의 trade-off 를 수치 실험으로 검증할 것.
