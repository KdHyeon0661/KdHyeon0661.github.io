---
layout: post
title: 정보보안기사 - 패키지/의존성 보안
date: 2025-11-09 22:25:23 +0900
category: 정보보안기사
---
# 패키지/의존성 보안 — **SBOM · SCA · 서드파티 관리**

## 0) 큰 그림(아키텍처 개요)

```
개발자 → [소스/PR] → CI(빌드·테스트)
                 └─ SCA(언어별) ─┐
                 └─ SBOM 생성 ───┼─> 아티팩트(이미지/패키지) 서명(Cosign)
                 └─ Secret Scan ─┘         └─ SLSA 프로비넌스/어태스테이션
                                   ↓
           사설 레지스트리(프록시/캐시/격리) — 라이선스/보안 정책(게이트)
                                   ↓
                     스테이징/프로덕션(배포) ← 런타임 스캐닝(이미지/OS 패키지)
                                   ↓
                         자산 카탈로그/SBOM 저장소(버전·Diff·감사)
```

---

# 1) 위협 모델(왜 필요한가?)

- **타이포스쿼팅/프로테스트웨어**: 인기 패키지 이름 오탈자/정치적 페이로드 삽입.  
- **디펜던시 컨퓨전**: 사설 패키지와 같은 이름으로 공개 레지스트리에 악성 패키지 업로드 → 기본 레졸버가 외부를 우선함.  
- **트랜지티브(Add-on) 취약점**: 직접 추가하지 않은 하위 의존성에서 취약점 발생(Log4Shell 등).  
- **무결성/출처 불명**: 누가 언제 어떻게 빌드했는지 증명 불가 → 공급망 공격 위험.  

**핵심 전략**  
1) **SBOM**으로 **무엇이 들어왔는지** 전수 목록화.  
2) **SCA**로 **알려진 취약점**을 자동 차단(게이트).  
3) **서드파티 관리**(사설 레지스트리/정책/서명/프로비넌스)로 **위험 소스 유입** 축소.

---

# 2) SBOM(Software Bill of Materials)

## 2.1 포맷 & 도구
- **CycloneDX**(권장), **SPDX**(리눅스 재단 표준).  
- 생성 도구: **Syft/Trivy/Grype**, 언어별 **CycloneDX 플러그인**, 컨테이너/OS는 **Trivy/Syft**.

## 2.2 예시 — Node/Java/Python/Container SBOM 생성

### (A) Node.js (CycloneDX)
```bash
# npm i -D @cyclonedx/cyclonedx-npm
npx @cyclonedx/cyclonedx-npm --output-format json --output-file bom-node.json
```

### (B) Maven(Java)
```bash
# pom.xml 플러그인 추가 후
mvn -DskipTests cyclonedx:makeAggregateBom   # target/bom.json 생성
```

### (C) Python
```bash
pip install cyclonedx-bom
cyclonedx-py --format json --outfile bom-py.json
```

### (D) 컨테이너 + OS 패키지
```bash
# Syft: 이미지에서 SBOM
syft registry.example.com/app:1.2.3 -o cyclonedx-json > bom-image.json

# Trivy: 패키지 + 취약점 리포트 동시
trivy image --format cyclonedx --output bom-image.json registry/app:1.2.3
```

### (E) 멀티-SBOM 병합(개념)
- 앱(Node/Java/Python) + 베이스이미지/레이어 SBOM을 **릴리즈 태그** 기준으로 저장.  
- 릴리스 간 **Diff**로 변경된 의존성/라이선스 추적.

## 2.3 SBOM 활용
- **자산 인벤토리**: 서비스/버전별 의존성·라이선스 맵.  
- **취약점 일괄 검색**: 신규 CVE 등장 시 SBOM 저장소에서 **영향 범위 조회**.  
- **감사/컴플라이언스**: 라이선스 정책 준수(Allow/Deny 리스트).

---

# 3) SCA(Software Composition Analysis)

## 3.1 언어별 권장 툴 모음
- **Python**: `pip-audit`, `pip-compile`(해시), `safety`, `pip-licenses`.  
- **Node**: `npm audit`/`pnpm audit`, `osv-scanner`, `license-checker`.  
- **Java**: OWASP Dependency-Check, `mvn versions:use-latest-releases`.  
- **Go**: `govulncheck`, SBOM은 `syft`/`cyclonedx-gomod`.  
- **Rust**: `cargo audit`, `cargo deny`(라이선스/보안 정책).  
- **.NET**: `dotnet list package --vulnerable`.

## 3.2 GitHub Actions — **언어 매트릭스 + SBOM 아티팩트**

```yaml
name: ci-sca-sbom
on: [push, pull_request, schedule]
jobs:
  sca-matrix:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        lang: [node, python, java]
    steps:
      - uses: actions/checkout@v4

      - name: Node SCA & SBOM
        if: matrix.lang == 'node'
        uses: actions/setup-node@v4
        with: { node-version: '20' }
      - if: matrix.lang == 'node'
        run: |
          npm ci
          npm audit --audit-level=high
          npx @cyclonedx/cyclonedx-npm --output-format json --output-file bom-node.json

      - name: Python SCA & SBOM
        if: matrix.lang == 'python'
        uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - if: matrix.lang == 'python'
        run: |
          pip install -r requirements.txt
          pip install pip-audit cyclonedx-bom
          pip-audit --strict
          cyclonedx-py --outfile bom-py.json --format json

      - name: Java SCA & SBOM
        if: matrix.lang == 'java'
        run: |
          mvn -q -DskipTests org.owasp:dependency-check-maven:check
          mvn -q -DskipTests cyclonedx:makeAggregateBom

      - uses: actions/upload-artifact@v4
        with: { name: sbom-${{ matrix.lang }}, path: "**/bom*.json" }
```

**게이트 원칙**  
- **High/Critical** 발견 시 빌드 **실패**.  
- 예외(waiver)는 **만료일/버전 범위**를 명시해 **자동 만료**.

---

# 4) 서드파티 관리(정책·레지스트리·검증)

## 4.1 사설 레지스트리/프록시(격리/캐시/검증)
- **Nexus/Artifactory/GitHub Packages** 등으로 **외부 레지스트리 프록시**.  
- 신규 패키지는 **격리(Quarantine)** → **자동 스캔(SCA/라이선스/멀웨어)** 후 승격.  
- **Immutable** 저장(태그 불변), **감사 로그** 활성화.

## 4.2 디펜던시 컨퓨전 차단

### npm(.npmrc)
```ini
registry=https://npm.company.local/
@company:registry=https://npm.company.local/
//npm.company.local/:_authToken=${NPM_TOKEN}
always-auth=true
```

### pip(pip.conf)
```ini
[global]
index-url = https://pypi.company.local/simple
extra-index-url =
# 외부 PyPI 비활성(권장: 사설만 사용)
disable-pip-version-check = true
```

> **원칙**: 내부 스코프(`@company/`)는 **항상 내부 레지스트리로만**. 외부 레지스트리에 같은 이름이 있어도 **해결되지 않도록**.

## 4.3 타이포스쿼팅/멀웨어 탐지
- 신규 패키지 이름이 **인기 패키지 유사**(edit distance)인 경우 **검역**.  
- 게시자 2FA/서명 여부, 주당 다운로드 급등, 의심 스크립트(`preinstall`) 검사.

## 4.4 라이선스 컴플라이언스

### Node — license-checker
```bash
npm i -D license-checker
npx license-checker --json > licenses.json
```

### Python — pip-licenses
```bash
pip install pip-licenses
pip-licenses --format=json --with-authors > licenses.json
```

**정책**  
- Allow: MIT/Apache-2.0/BSD-3-Clause…  
- Review: MPL-2.0, EPL-2.0…  
- Deny: GPL-3.0-only(내부정책 예), AGPL-3.0…

---

# 5) 버전 고정/해시 핀(재현성·무결성)

## 5.1 잠금 파일/고정 설치
- **npm/yarn/pnpm**: `package-lock.json`/`yarn.lock`/`pnpm-lock.yaml`, CI는 **`npm ci`** 사용.  
- **Python**: `pip-tools`로 **해시 포함** 고정.

```bash
pip install pip-tools
pip-compile --generate-hashes -o requirements.txt pyproject.toml
pip-sync requirements.txt
```
`requirements.txt` 예:
```
requests==2.32.0 \
  --hash=sha256:... --hash=sha256:...
```

- **Go**: `go.sum`(모듈 해시), `GOPROXY` 내부 설정.  
- **Rust**: `Cargo.lock` 커밋, `cargo vendor`로 소스 벤더링(에어갭).

## 5.2 컨테이너 베이스 이미지 고정(다이제스트)
```dockerfile
# ❌ 태그만 고정은 변할 수 있음
# FROM python:3.12-slim

# ✅ 다이제스트 핀
FROM python@sha256:8a2f...d1c  # 내부 보증된 다이제스트 사용
```

---

# 6) 무결성·출처 증명(서명·프로비넌스)

## 6.1 Cosign 서명(이미지/SBOM)
```bash
# 이미지 서명
cosign sign --key cosign.key registry.example.com/app:1.2.3
# SBOM 어태치(oci-artifact)
cosign attach sbom --sbom bom-image.json registry.example.com/app:1.2.3
# 검증
cosign verify --key cosign.pub registry.example.com/app:1.2.3
```

## 6.2 SLSA 프로비넌스(빌드 출처)
- CI 내 **빌드 워크플로/소스 커밋/빌더 ID**를 **어태스테이션**으로 기록 → **서명**.  
- 배포 파이프라인에서 **SLSA 수준**/서명 검증 실패 시 **차단**.

---

# 7) 런타임/이미지 스캐닝(운영)

- 배포 전 **이미지 스캔**(Trivy/Grype) + **OS 패키지 업데이트** 확인.  
- **최소 베이스**(distroless/ubi-micro), 불필요 패키지 제거, **Non-root** 운영.  
- 런타임에서 **eBPF 또는 데몬셋 스캐너**로 주기 스캔 — 결과는 **SIEM** 으로.

```bash
trivy image --exit-code 1 --severity CRITICAL,HIGH registry/app:1.2.3
```

---

# 8) 정책 게이트(OPA/Rego) — 취약점/라이선스 차단

```rego
# package cicd.policy
default allow = false

allow {
  input.build.sca.high == 0
  input.build.sca.critical == 0
  not deny_license
}

deny_license {
  some i
  input.build.licenses[i] == "AGPL-3.0-only"
}
```

CI에서 **ext-authz** 혹은 **OPA CLI**로 정책 평가 후 **불합격 시 실패**.

---

# 9) 인시던트 대응 런북(예: Log4Shell 재발 시)

1) **탐지**: 위협 인텔/새 CVE → SBOM 저장소에서 **패키지 이름/버전 검색**.  
2) **범위**: 영향 받는 서비스 목록 + 실행중 이미지/Pod 매핑.  
3) **완화**:  
   - WAF/리버스프록시 룰 임시 차단,  
   - JVM/환경별 런타임 완화(시스템 속성 비활성 등),  
   - 네트워크 Egress 제한(콜백 차단).  
4) **교체**: SCA가 제시하는 **수정 버전으로 즉시 업데이트** → 테스트 → 프로덕션 롤아웃(카나리).  
5) **검증**: 공격 패턴 로그/추적 재검토, **SBOM Diff** 확인.  
6) **사후**: 재현 테스트/포렌식 아티팩트 보존, **재발방지**(자동 업데이트/알람 강화).

---

# 10) 지표(KPI)·리스크

- **패키지 노후율**: 최신 마이너/패치로부터 경과 일수 중간값.  
- **취약점 백로그**: High/Critical 개수 & 평균 해결 시간(SLA).  
- **서명/프로비넌스 적용률**: 이미지/릴리스 중 서명된 비율.  
- **라이선스 위반 건수**: 예외 승인/만료 내역.

리스크 근사:
$$
\text{Risk} = \text{Likelihood} \times \text{Impact}
$$
- Likelihood는 **공개 Exploit 존재**·**인터넷 노출**·**활용도**로 가중.

---

# 11) 체크리스트(현장용)

## SBOM
- [ ] 모든 릴리스/이미지에 **CycloneDX JSON** 생성/보관  
- [ ] 릴리스 간 **SBOM Diff** 자동화  
- [ ] SBOM과 아티팩트 **연계 태그/메타데이터** 부여

## SCA
- [ ] **언어별 스캐너** CI 게이트(High/Critical 차단)  
- [ ] 예외는 **만료일/근거** 포함, 주기적 재검토  
- [ ] 스케줄 스캔(주 1회) — 새 CVE Catch-up

## 서드파티
- [ ] 사설 레지스트리 프록시/캐시/검역  
- [ ] `.npmrc`/`pip.conf`로 외부 우회 차단(Dependency Confusion 방지)  
- [ ] 신규 패키지 **이상징후(이름/게시자/스크립트)** 검사

## 고정/무결성
- [ ] 잠금파일 커밋, CI는 `npm ci`/`pip-sync`  
- [ ] Python **해시 핀**(`--generate-hashes`)  
- [ ] 베이스이미지 **다이제스트 핀**

## 서명/프로비넌스
- [ ] Cosign 서명(이미지/SBOM) 검증 파이프라인  
- [ ] SLSA 어태스테이션 검증

## 라이선스
- [ ] Allow/Deny 리스트 정의 및 CI 평가  
- [ ] SBOM에 라이선스 포함, 예외 만료 관리

---

# 12) 실습 세트(핸즈온)

### 실습 A) **Node 서비스**에 SBOM+SCA+라이선스 게이트 추가
1) `npx @cyclonedx/cyclonedx-npm …` 로 `bom-node.json` 생성 → 아티팩트 업로드  
2) `npm audit --audit-level=high` 를 CI 실패 기준으로  
3) `license-checker` 결과에서 Deny 라이선스 발견 시 실패 → OPA로 평가

### 실습 B) **Python API** 고정/해시 핀
1) `pip-compile --generate-hashes` 로 **해시 포함** `requirements.txt` 생성  
2) `pip-audit --strict` 로 SCA  
3) 런타임 이미지 스캔 `trivy image … --exit-code 1`

### 실습 C) **컨테이너** 서명·SBOM 어태치·검증
1) `syft`/`trivy` 로 SBOM 생성  
2) `cosign sign` / `cosign attach sbom`  
3) 배포 파이프라인에서 `cosign verify` 실패 시 중단

---

# 13) 참고 스니펫 모음

### Renovate/Dependabot(자동 업데이트 PR)
```json
// renovate.json
{
  "extends": ["config:recommended"],
  "rangeStrategy": "pin",
  "labels": ["dependencies"],
  "packageRules": [
    { "matchUpdateTypes": ["minor","patch"], "automerge": true }
  ]
}
```

### Go — govulncheck
```bash
go install golang.org/x/vuln/cmd/govulncheck@latest
govulncheck ./...
```

### Rust — cargo audit/deny
```bash
cargo install cargo-audit cargo-deny
cargo audit
cargo deny check bans licenses
```

### Java — OWASP Dependency-Check(Maven)
```xml
<plugin>
  <groupId>org.owasp</groupId>
  <artifactId>dependency-check-maven</artifactId>
  <version>10.0.3</version>
  <executions>
    <execution>
      <goals><goal>check</goal></goals>
      <configuration>
        <failBuildOnCVSS>7.0</failBuildOnCVSS>
      </configuration>
    </execution>
  </executions>
</plugin>
```

---

## 마무리

- **SBOM**은 “들어간 모든 재료의 목록”이고, **SCA**는 “그 재료의 건강검진”입니다.  
- 여기에 **사설 레지스트리/정책/서명/프로비넌스/고정 설치**를 더하면 **공급망 공격면**이 급감합니다.  
- 오늘 바로 적용할 4가지:  
  1) 모든 빌드에 **CycloneDX SBOM** 생성·아카이브  
  2) **언어별 SCA**를 CI **게이트**로(High/Critical=Fail)  
  3) **pip-compile --generate-hashes / npm ci / 다이제스트 핀**으로 재현성 확보  
  4) **Cosign 서명 + SLSA 어태스테이션 검증**을 배포 전 필수화
