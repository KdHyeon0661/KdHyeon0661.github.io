---
layout: post
title: 네트워크보안 - 클라우드 네트워킹 보안
date: 2025-10-27 18:25:23 +0900
category: 네트워크보안
---
# 13. 클라우드 네트워킹 보안

> 목표: **클라우드 VPC 설계의 보안 기본기**(서브넷·라우팅·SG vs NACL)를 정복하고,
> **관리형 WAF/DDoS·CDN과 원천(Origin) 보호**를 현실적으로 조합한다.
> 이어서 **프라이빗 링크/피어링/트랜싯 게이트웨이**를 비교하고,
> 마지막으로 **허브–스포크 보안 아키텍처**를 IaC(개념 Terraform)와 운영 체크리스트로 완성한다.
> 벤더는 AWS 중심으로 설명하되 **Azure/GCP 맵핑**도 병행한다.

---

## 13.1 VPC/서브넷/라우팅/보안그룹 vs NACL

### 13.1.1 보안 레이어 한눈에 (AWS 기준)
- **VPC**: 테넌트 격리 (CIDR, 라우팅 도메인)
- **Subnet**: **Public(IGW 경로)** / **Private(NAT·TGW·VPC 엔드포인트 경로)** 분리
- **Route Table**: 목적지 프리픽스 → 다음 홉(IGW/NAT GW/TGW/VPCE)
- **Security Group(SG)**: **상태기반(Stateful)**, **ENI(인터페이스)**에 붙는 **허용 규칙(Allow-list)**
- **NACL**: **서브넷 경계의 무상태(Stateless)**, **허용/거부** 둘 다. 기본은 **허용**
- **VPC Endpoint(Interface/Gateway)**: S3/DynamoDB/다양한 서비스에 **사설경로**
- **VPC Flow Logs**: 연결 메타데이터 (승인/거부, 5-tuple, 바이트/패킷)

> 운영 관점: **SG로 90%** 통제, **NACL은 특정 거부·대역 차단·디펜스 인 뎁스**로 소수만 관리.

### 13.1.2 Public/Private Subnet 분리 패턴
- **Public**: ALB/NLB(인터넷), Bastion(필요시), 관리형 NAT GW
- **Private-Apps**: 앱/배치/내부 ALB, 아웃바운드는 **NAT 또는 프록시**
- **Private-Data**: DB/캐시/브로커 (아웃바운드 **없음** 또는 **VPC 엔드포인트로만**)
- **Inspection/Shared**: 중앙 로깅/프록시/보안 툴(VPC Lattice/프록시·GWLB)

**라우팅 예(개념)**
```
# public-rt
0.0.0.0/0 → Internet Gateway

# private-apps-rt
0.0.0.0/0 → NAT Gateway
com.amazonaws.<region>/* → Interface/Gateway Endpoint

# private-data-rt
인터넷 경로 없음
S3/DynamoDB → Gateway Endpoint
내부 서비스(프라이빗 링크) → Interface Endpoint
```

### 13.1.3 SG vs NACL 차이 & 사용 기준
| 항목 | SG | NACL |
|---|---|---|
| 상태성 | 상태기반(Stateful) | 무상태(Stateless) |
| 적용 위치 | ENI(인스턴스/ALB/ENI) | 서브넷 경계 |
| 규칙 유형 | **허용만**(Allow-list) | 허용/거부(Allow/Deny) |
| 운영 난이도 | 상대적으로 쉬움(서비스 기준) | 숫자 우선순위·대칭 규칙 필요 |
| 주 용도 | **서비스별 포트 화이트리스트** | **대역 차단/거부**, 규정 디펜스 |

**SG 예(앱 → DB)**
- DB SG 인바운드: `tcp/3306` **Source = App-SG** (CIDR 대신 SG 참조!)
- App SG egress: `tcp/3306` **Destination = DB-SG**
> SG 간 참조는 **환경 드리프트를 줄이는 핵심 패턴**.

**NACL 예(서브넷 거부)**
- 특정 외부 대역(위협 인텔) **Deny Inbound**
- 전체는 Allow, 예외만 Deny → **룰 수 최소화**

### 13.1.4 IaC(개념 Terraform) – 최소 패턴
```hcl
# VPC & Subnet
resource "aws_vpc" "main" { cidr_block = "10.10.0.0/16" }
resource "aws_subnet" "public_a"  { vpc_id = aws_vpc.main.id cidr_block = "10.10.1.0/24" map_public_ip_on_launch = true }
resource "aws_subnet" "private_a" { vpc_id = aws_vpc.main.id cidr_block = "10.10.2.0/24" }

# IGW / NAT
resource "aws_internet_gateway" "igw" { vpc_id = aws_vpc.main.id }
resource "aws_eip" "nat_eip" { vpc = true }
resource "aws_nat_gateway" "nat" { subnet_id = aws_subnet.public_a.id allocation_id = aws_eip.nat_eip.id }

# Route Tables
resource "aws_route_table" "public_rt" { vpc_id = aws_vpc.main.id }
resource "aws_route" "public_0" {
  route_table_id = aws_route_table.public_rt.id
  destination_cidr_block = "0.0.0.0/0"
  gateway_id = aws_internet_gateway.igw.id
}
resource "aws_route_table_association" "public_assoc" {
  subnet_id      = aws_subnet.public_a.id
  route_table_id = aws_route_table.public_rt.id
}

resource "aws_route_table" "private_rt" { vpc_id = aws_vpc.main.id }
resource "aws_route" "private_0" {
  route_table_id = aws_route_table.private_rt.id
  destination_cidr_block = "0.0.0.0/0"
  nat_gateway_id = aws_nat_gateway.nat.id
}
resource "aws_route_table_association" "private_assoc" {
  subnet_id      = aws_subnet.private_a.id
  route_table_id = aws_route_table.private_rt.id
}

# SG (App ↔ DB)
resource "aws_security_group" "app" { name = "sg-app"; vpc_id = aws_vpc.main.id }
resource "aws_security_group" "db"  { name = "sg-db";  vpc_id = aws_vpc.main.id }

resource "aws_security_group_rule" "db_in_3306" {
  type                     = "ingress"
  from_port                = 3306
  to_port                  = 3306
  protocol                 = "tcp"
  security_group_id        = aws_security_group.db.id
  source_security_group_id = aws_security_group.app.id
}
```

### 13.1.5 Azure/GCP 맵핑
- **Azure**: VNet/Subnet, **NSG**(SG 유사, 서브넷/니코 바인딩), **ASG**(SG 그룹간 참조 대체), **UDR**(RT), **Private Endpoint**, **Azure Firewall**, **PaaS Private Link**
- **GCP**: VPC(Subnet Regional), **VPC Firewall**(SG+NACL 혼합 느낌, 상태기반), **Serverless VPC Access**, **Private Service Connect(PSC)**, **Cloud NAT**, **Cloud Router**

---

## 13.2 관리형 WAF/DDoS, CDN과 원천 보호

### 13.2.1 경계 디자인: “CDN/WAF 앞단, 원천 보호”
- **CDN(CloudFront/Azure Front Door/Cloud CDN)** 앞에 **도메인/TLS**,
  **WAF(관리형 규칙 + 커스텀)**는 **CDN 혹은 ALB/프록시**에 부착
- 원천(Origin)은 **CDN 원본 전용 접근**:
  - **Origin Access Control/Identity(OAC/OAI)**(S3)
  - **원본 보안그룹에서 CDN 전용 IP/헤더 허용**
  - **PrivateLink/내부 ALB**로 **공개 IP 제거** 가능

### 13.2.2 DDoS 대응(관리형)
- **AWS Shield Standard**: L3/4 자동 방어
- **Shield Advanced**: 비용보호, 공격 탐지/룰 연계, **Route 53·CloudFront·ALB**와 통합
- **GCP Cloud Armor**, **Azure DDoS Protection** 동등 개념

> 원칙: **Anycast CDN + WAF + Rate-limit + 캐시 전략**으로 “**흡수+완화**”.
> 애플리케이션 레벨은 **프록시에서 속도·세션·챌린지** 조합.

### 13.2.3 WAF 규칙 운용
- **관리형 룰**(OWASP, BotControl) + **커스텀 룰**(경로/메서드/헤더)
- **감지 모드 → 튜닝 → 차단 모드** 단계적 전환
- **GraphQL/WebSocket/gRPC**는 **전용 시나리오**(Content-Type/메서드 최소화)로 보완

**AWS WAF 커스텀(개념)**
- `/api/*`는 `POST/PUT/DELETE`만 허용, `GET`은 `max body 0`
- 특정 헤더 없는 요청 차단(`X-Edge-Auth: …`)
- **IP 평판 리스트** 자동 갱신(Lambda/Automation)

### 13.2.4 CDN 캐시/원천 보호 컴보
- **정적**: 긴 TTL + 서명 URL(다운로드 보호)
- **동적**: 짧은 TTL + **Origin Shield**/캐시 키 최적화
- **원천 접근**: **Private ALB** + **CloudFront Origin Access**(헤더 검증)로 퍼블릭 노출 차단

---

## 13.3 프라이빗 링크/피어링/트랜싯 GW

### 13.3.1 개념 비교
| 항목 | 목적 | 경로 특성 | 라우팅/제한 | 보안/격리 |
|---|---|---|---|---|
| **VPC Peering** | 두 VPC 간 L3 연결 | **일대일, 트랜짓 불가** | 중첩 CIDR X, 보통 RT에 수동 등록 | 심플/저비용, 스케일 한계 |
| **Transit Gateway(TGW)** | **허브–스포크** 다중 VPC/온프 연동 | 중앙 허브 라우팅 | **라우팅 도메인/테이블**로 분리 가능 | 대규모·정책 분리 용이 |
| **PrivateLink(Interface Endpoint)** | **서비스 소비자→제공자** 단방향 L7 프록시 | ENI로 사설 연결 | **CIDR 충돌 무관**, 라우팅 단순 | **서비스형 노출**에 최적 |
| **(GCP) PSC / (Azure) Private Link** | 동일 개념 | 〃 | 〃 | 〃 |

> **패턴**: **서비스 제공**은 **PrivateLink/PSC**, **조직 내 다수 VPC 연결**은 **TGW/Hub**.

### 13.3.2 PrivateLink 예 (서비스 제공자 ↔ 소비자)
- 제공자 VPC의 NLB/ALB(지원되는 타입)에 **VPC Endpoint Service** 게시
- 소비자 VPC가 **Interface Endpoint** 생성 → SG로 서비스 포트만 허용
- **장점**: **공인 IP/피어링 불필요**, **CIDR 충돌 무관**, **정밀 접근제어(ACCEPT/REJECT)**

**Terraform 개념**
```hcl
# Provider (Service)
resource "aws_vpc_endpoint_service" "svc" {
  acceptance_required = true
  network_load_balancer_arns = [aws_lb.nlb.arn]
}

# Consumer
resource "aws_vpc_endpoint" "ep" {
  vpc_id            = aws_vpc.main.id
  service_name      = aws_vpc_endpoint_service.svc.service_name
  vpc_endpoint_type = "Interface"
  subnet_ids        = [aws_subnet.private_a.id]
  security_group_ids = [aws_security_group.consumer_ep.id]
}
```

### 13.3.3 Transit Gateway(허브) – 라우팅 도메인 분리
- **Attachment**: VPC/사이트간 VPN/Direct Connect 연결
- **Route Table**: **검열/검사 VPC**(보안 허브)로 **스포크 트래픽 중앙 집행**
- **분리**: Prod/Non-Prod/Shared 별 **TGW Route Table** 분할

---

## 13.4 실습: 허브–스포크 보안 아키텍처

> **시나리오**
> - **Hub(보안/공유)**: 인스펙션 VPC(프록시·GWLB·IDS/IPS), 공용 Egress, 공통 VPC 엔드포인트
> - **Spoke-Apps**: 애플리케이션 VPC (사설만), DB는 별도 Data VPC
> - **경로**: Spoke ↔ TGW ↔ Hub(검사) ↔ NAT/VPCE/온프
> - **원천 공개** 금지: 공개 트래픽은 **CloudFront/WAF → Private ALB**(Origin Access)로만

### 13.4.1 네트워크 토폴로지 (개념)
```
[Internet]
   │
[CloudFront + WAF]  ← 도메인/TLS/봇·L7 보호
   │ (Origin Access 헤더)
[Private ALB in Hub] ─ (TGW) ─ [Spoke-App VPC]
        │                         │
     [GWLB/IPS]                [App/ECS/EKS]
        │                         │
   [Egress NAT/Proxy]       [Data VPC via TGW]
        │
   [S3/DDB Endpoints]
```

### 13.4.2 핵심 정책
1) **Spoke VPC**는 **인터넷 라우트 없음**(0.0.0.0/0 경로 금지)
2) **아웃바운드**는 **TGW→Hub**를 통해서만, Hub에서 **프록시/보안 검사를 통과**해야 인터넷/NAT
3) **인바운드**는 **CloudFront/WAF**만 허용 → **Origin 헤더/SG**로 **직접 접근 차단**
4) 모든 VPC는 **필수 서비스**를 **VPCE(Interface/Gateway)**로 접근(S3/SSM/CloudWatch 등)
5) **SG 참조**로 App–DB 최소 허용, **NACL은 예외 거부만**
6) **Flow Logs + GuardDuty/CloudTrail + WAF Logs** → SIEM/OTel에 통합

### 13.4.3 IaC(개념 Terraform) 스니펫

**(A) TGW와 라우팅**
```hcl
resource "aws_ec2_transit_gateway" "tgw" {
  amazon_side_asn = 64512
  default_route_table_association = false
  default_route_table_propagation = false
}

# TGW Route Tables
resource "aws_ec2_transit_gateway_route_table" "hub_rt"  { transit_gateway_id = aws_ec2_transit_gateway.tgw.id }
resource "aws_ec2_transit_gateway_route_table" "spk_rt"  { transit_gateway_id = aws_ec2_transit_gateway.tgw.id }

# Attachments
resource "aws_ec2_transit_gateway_vpc_attachment" "hub_att" {
  transit_gateway_id = aws_ec2_transit_gateway.tgw.id
  vpc_id             = aws_vpc.hub.id
  subnet_ids         = [aws_subnet.hub_tgw_a.id, aws_subnet.hub_tgw_b.id]
}

resource "aws_ec2_transit_gateway_vpc_attachment" "spk_att" {
  transit_gateway_id = aws_ec2_transit_gateway.tgw.id
  vpc_id             = aws_vpc.spk.id
  subnet_ids         = [aws_subnet.spk_tgw_a.id, aws_subnet.spk_tgw_b.id]
}

# Association / Propagation
resource "aws_ec2_transit_gateway_route_table_association" "assoc_hub" {
  transit_gateway_attachment_id  = aws_ec2_transit_gateway_vpc_attachment.hub_att.id
  transit_gateway_route_table_id = aws_ec2_transit_gateway_route_table.hub_rt.id
}
resource "aws_ec2_transit_gateway_route_table_propagation" "prop_spk_to_hub" {
  transit_gateway_attachment_id  = aws_ec2_transit_gateway_vpc_attachment.spk_att.id
  transit_gateway_route_table_id = aws_ec2_transit_gateway_route_table.hub_rt.id
}
resource "aws_ec2_transit_gateway_route_table_association" "assoc_spk" {
  transit_gateway_attachment_id  = aws_ec2_transit_gateway_vpc_attachment.spk_att.id
  transit_gateway_route_table_id = aws_ec2_transit_gateway_route_table.spk_rt.id
}
# Default route in spk_rt → hub attachment
resource "aws_ec2_transit_gateway_route" "spk_default_to_hub" {
  transit_gateway_route_table_id = aws_ec2_transit_gateway_route_table.spk_rt.id
  destination_cidr_block         = "0.0.0.0/0"
  transit_gateway_attachment_id  = aws_ec2_transit_gateway_vpc_attachment.hub_att.id
}
```

**(B) Hub VPC: 프록시/NAT/VPCE**
```hcl
# Private ALB (Origin, internal)
resource "aws_lb" "origin_alb" {
  name               = "origin-alb"
  internal           = true
  load_balancer_type = "application"
  subnets            = [aws_subnet.hub_priv_a.id, aws_subnet.hub_priv_b.id]
  security_groups    = [aws_security_group.origin_alb.id]
}

# SG: CloudFront 전용 접근(예: 헤더 검증과 함께)
resource "aws_security_group_rule" "alb_in_from_cf" {
  type              = "ingress"
  protocol          = "tcp"
  from_port         = 443
  to_port           = 443
  security_group_id = aws_security_group.origin_alb.id
  cidr_blocks       = ["<CloudFront_Managed_Prefixes>"] # 실제 운영은 IP 업데이트 자동화
}

# Gateway Endpoints (S3/DDB): Hub에서 공용 없이 접근
resource "aws_vpc_endpoint" "s3" {
  vpc_id       = aws_vpc.hub.id
  service_name = "com.amazonaws.${var.region}.s3"
  vpc_endpoint_type = "Gateway"
  route_table_ids = [aws_route_table.hub_priv_rt.id]
}

# Interface Endpoints (SSM/Logs/KMS …)
resource "aws_vpc_endpoint" "ssm" {
  vpc_id            = aws_vpc.hub.id
  service_name      = "com.amazonaws.${var.region}.ssm"
  vpc_endpoint_type = "Interface"
  subnet_ids        = [aws_subnet.hub_priv_a.id, aws_subnet.hub_priv_b.id]
  security_group_ids = [aws_security_group.vpce.id]
}
```

**(C) Spoke VPC: 인터넷 라우트 없음**
```hcl
# Spoke private route: only TGW
resource "aws_route" "spk_to_tgw_default" {
  route_table_id         = aws_route_table.spk_priv_rt.id
  destination_cidr_block = "0.0.0.0/0"
  transit_gateway_id     = aws_ec2_transit_gateway.tgw.id
}
# No IGW/NAT in Spoke
```

**(D) CloudFront/WAF → Private ALB (원천 보호)**
- CloudFront Origin 도메인은 **내부 NLB/ALB**(내부 NLB + NLB TLS or ALB)
- **오리진 커스텀 헤더**(예: `X-Origin-Auth`)를 프록시에서 검증 → 직접 호출 차단
- ALB SG는 **CloudFront 관리 IP**만 허용 (자동화로 최신화)

### 13.4.4 관측/감사
- **VPC Flow Logs**: **REJECT 증가**(잘못된 라우팅/SG), **비정상 egress**
- **CloudTrail**: 네트워크 변경(라우트/NACL/SG/Endpoint) 경보
- **WAF Logs**: 차단 룰 탑 N, false positive 피드백 루프
- **GuardDuty/Security Hub**: Managed Intel + 이상징후

**Athena 예(Flow Logs: 외부로 나가면 안 되는 서브넷에서 443 이외 egress 탐지)**
```sql
SELECT srcaddr, dstaddr, dstport, count(*) c
FROM vpc_flow_logs
WHERE action='ACCEPT'
  AND srcsubnetid IN ('subnet-priv-data-1','subnet-priv-data-2')
  AND dstport NOT IN (443)
  AND start_time > current_timestamp - interval '1' day
GROUP BY srcaddr, dstaddr, dstport
ORDER BY c DESC;
```

### 13.4.5 운영 체크리스트
- [ ] **Spoke에 IGW/NAT 금지**, 0.0.0.0/0은 TGW→Hub로만
- [ ] **CloudFront/WAF만 Origin 접근**, ALB SG는 **CF 전용**
- [ ] **SG 참조 기반 허용**, **NACL은 최소 규칙**(거부 예외만)
- [ ] **모든 공용 접근 제거**: 관리/배포/로그 수집은 **VPCE/SSM**
- [ ] **라우팅 도메인 분리**: TGW Route Table(Prod/NonProd/Shared)
- [ ] **프록시/SSL-Pinning/mTLS(내부)**로 egress 제어
- [ ] **Flow Logs/CloudTrail/WAF/Shield/GuardDuty** 대시보드 통합
- [ ] IaC(GitOps)로 **승인·리뷰·테스트** 없이 네트워크 바뀌지 않게
- [ ] **카나리/헬스체크** 실패 시 자동 롤백/알림

---

## 부록 A. Azure/GCP 허브–스포크 힌트

**Azure**
- 허브: **Azure Firewall**(DNS 프록시+FQDN 필터), **Firewall Policy**로 중앙 제어
- 스포크: VNet Peering(Use Remote Gateway), **Private Link**(PaaS)
- WAF/CDN: **Front Door + WAF**, 원천은 **Private Endpoint**
- NSG/ASG: 서비스 그룹 태깅으로 규칙 간결화

**GCP**
- **VPC-SC**(서비스 경계)로 API egress 제한, **Cloud Armor**(WAF/DDoS)
- **PSC**(프라이빗 서비스 연결), **Cloud NAT** 중앙 아웃바운드
- **Network Firewall**/Hierarchical FW 정책 + **Cloud Router**(동적 라우팅)
- **Serverless NEGs + Cloud CDN**로 원천 은닉

---

## 부록 B. “실패 시나리오”와 빠른 진단
- **증상**: Spoke에서 인터넷 불가
  - 확인: Spoke RT → TGW default 존재? TGW RT에서 Hub로 라우팅? Hub에서 NAT/프록시 경로?
- **증상**: Origin이 직접 노출됨
  - 확인: ALB **퍼블릭인가**? SG가 **CF IP만 허용**하는가? Origin 헤더 검증 있는가?
- **증상**: S3 접근이 인터넷으로 나감
  - 확인: **Gateway Endpoint** 경로/RT 연결 여부, S3 **Interface Endpoint**와 혼용 시 라우팅 우선순위
- **증상**: DB에 우회 트래픽
  - 확인: DB SG 인바운드의 **Source = App-SG**인지(CIDR 허용 금지), NACL 예외 룰이 대칭인지

---

## 요약
- **SG(상태기반) 중심 + NACL 최소 거부**가 기본. **Public/Private/Inspection** 서브넷 분리와 **VPCE** 적극 활용.
- **CDN+WAF**로 외부를 흡수하고, 오리진은 **Private ALB/헤더 검증/SG 제약**으로 **비공개화**.
- **PrivateLink/PSC**는 **서비스형 노출**, **TGW/허브–스포크**는 **조직 연결**에 적합.
- **허브–스포크 보안 아키텍처**에서 **아웃바운드 중앙 검사**와 **인바운드 원천 보호**를 동시에 달성하라.
- 관측·감사(Flow Logs/Trail/WAF/Shield)와 **IaC+리뷰+테스트**로 **변경 리스크**를 관리하라.
