---
layout: post
title: Linux - 커널, 모듈, 부팅 과정 분석
date: 2024-11-26 19:20:23 +0900
category: Linux
---
# 커널·모듈·부팅 과정 분석

## 전체 부팅 타임라인(UEFI/BIOS 공통 사고 모델)

1) **펌웨어 단계 (BIOS/UEFI)**
- 하드웨어(메모리, CPU, 장치 초기화) → **부트 디바이스** 결정
- UEFI에선 EFI System Partition(ESP)의 `EFI/BOOT/BOOTX64.EFI` 또는 베더 엔트리 실행

2) **부트로더 (GRUB2)**
- **커널 이미지(`vmlinuz`)** + **초기 램디스크(`initrd`/`initramfs`)** 적재
- **커널 명령줄**(kernel cmdline) 전달

3) **커널 초기화**
- 메모리 매핑/스케줄러/기본 드라이버/루트fs 마운트 전 준비
- **initramfs 진입** → 스토리지/RAID/LUKS/LVM/파일시스템 활성
- 루트 파일시스템 마운트 후 **init 프로세스** 실행(`systemd` 등)

4) **사용자 공간 (systemd)**
- 타겟/서비스 의존성 해석 → 네트워킹/로그인TTY/그래픽 디스플레이 매니저 기동

5) **로그인 프롬프트**
- CLI/GUI 진입, 런레벨/타겟에 따른 서비스 가동 완료

부팅상 문제를 추적할 땐 위의 **전이 경계**(펌웨어→부트로더 / 부트로더→커널 / 커널→initramfs / initramfs→루트fs / 루트fs→systemd)를 머릿속에 두고, 해당 구간의 **증거**(화면/LED/로그/콘솔)를 수집합니다.

---

## /boot와 GRUB2 구조 — 안전한 수정 절차

### `/boot` 구성 요소

| 파일/디렉토리 | 역할 |
|---|---|
| `vmlinuz-<ver>` | 압축 커널 이미지(실행 엔트리포인트 포함) |
| `initrd.img-<ver>` 또는 `initramfs-<ver>.img` | 루트 마운트 전 필요한 **초기 사용자 공간** |
| `System.map-<ver>` | 커널 심볼 주소 테이블(디버깅/프로파일) |
| `config-<ver>` | 빌드 시 커널 설정(Kconfig 결과) |
| `grub/` | GRUB 모듈·테마 등 |
| (UEFI) `/boot/efi/EFI/<distro>/*.efi` | EFI 실행 바이너리 |

### GRUB 설정 파일의 흐름

- 수동 편집 X: `/boot/grub/grub.cfg`
- **편집 대상**: `/etc/default/grub`, `/etc/grub.d/*`
- 반영: `update-grub`(Debian/Ubuntu) 또는 `grub2-mkconfig`(RHEL/Fedora)

```bash
# Debian/Ubuntu

sudo nano /etc/default/grub
sudo update-grub    # /boot/grub/grub.cfg 재생성

# RHEL/Fedora

sudo grub2-mkconfig -o /boot/grub2/grub.cfg
# UEFI일 경우 경로가 /boot/efi/EFI/<vendor>/grub.cfg 인 배포판도 있음

```

### `/etc/default/grub` 핵심 항목 예시

```bash
GRUB_DEFAULT=0
GRUB_TIMEOUT=5
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"
# 서버라면: "quiet" 제거, "loglevel=7 systemd.log_level=debug"로 부팅 진단 강화

```

> **원칙**: GUI 워크스테이션은 `quiet splash`, 서버/디버깅은 **조용함을 제거**하고 **로그레벨↑**.

### (UEFI) 부트 엔트리 관리

```bash
sudo efibootmgr               # 현재 부트 엔트리 목록 확인
sudo efibootmgr -o 0003,0001  # 부트 순서 재정의
```

---

## 커널 이미지·initramfs — 루트 마운트 전의 “작전 기지”

### initrd/initramfs가 필요한 이유

- 루트 파티션 접근에 필요한 **모듈/도구**(SCSI/NVMe/LVM/RAID/LUKS/네트워크 루트 등)를 미리 **메모리 상**에 준비
- 커널은 `initramfs`의 `/init`을 실행 → LUKS 해제 → LVM 활성 → 루트fs 마운트 → **`switch_root`**로 실제 루트 전환

### initramfs 제작/갱신

```bash
# Debian/Ubuntu (update-initramfs)

sudo update-initramfs -c -k 6.8.0-xx    # 새로 생성(-c)
sudo update-initramfs -u -k all         # 전 커널 업데이트

# RHEL/Fedora系 (dracut)

sudo dracut -f /boot/initramfs-$(uname -r).img $(uname -r)
```

### initramfs 열람(구조 이해)

```bash
# 임시 디렉토리에서 해제

mkdir /tmp/ir && cd /tmp/ir
lsinitramfs /boot/initrd.img-$(uname -r) | head -50  # Ubuntu
# 또는

mkdir /tmp/ir2 && cd /tmp/ir2
zcat /boot/initramfs-$(uname -r).img | cpio -idmv
```

구성 확인 포인트:
- `/init` 스크립트 흐름(드라이버 로딩 → LUKS/LVM → 루트탐색 → switch_root)
- 필요한 모듈/후킹 스크립트 포함 여부

---

## 커널 커맨드라인(cmdline) — 한 줄로 바꾸는 부팅 성격

### 현재 부팅 커맨드라인 확인

```bash
cat /proc/cmdline
```

### 자주 쓰는 커널 파라미터

| 파라미터 | 효과/용도 |
|---|---|
| `root=/dev/…`/`UUID=` | 루트fs 위치 지정(멀티디스크 환경 필수) |
| `ro`/`rw` | 루트 마운트 초기 상태(read-only 추천) |
| `quiet`, `splash` | 부팅 메시지 억제/스플래시(워크스테이션) |
| `systemd.unit=rescue.target` | 구조모드로 부팅(서비스 최소) |
| `emergency` 또는 `emergency.target` | 비상쉘(루트fs R/O, 수동 조치) |
| `nomodeset` | 초기 KMS 비활성(그래픽 문제 회피) |
| `ipv6.disable=1` | IPv6 임시 비활성 |
| `selinux=0`/`enforcing=0` | SELinux 비활성/허용모드(진단용) |
| `rd.luks.uuid=` / `rd.lvm.vg=` | dracut 기반에서 LUKS/LVM 지정 |
| `crashkernel=...` | kdump 메모리 예약(커널 크래시 덤프용) |
| `intel_iommu=on`/`amd_iommu=on` | IOMMU/PCIe 파스스루 |

> **복구시**: `systemd.unit=emergency.target` + `rootpw`(배포판 옵션)로 들어가 `/etc/fstab`·`/etc/crypttab`·드라이버·initramfs를 점검/재생성합니다.

---

## 커널 모듈 — 로딩, 블랙리스트, DKMS

### 기본 조작

```bash
lsmod                         # 로드된 모듈
modinfo e1000e                # 모듈 메타/의존/파라미터
sudo modprobe e1000e          # 의존 포함 로드
sudo modprobe -r e1000e       # 안전 제거(사용중이면 실패)
```

모듈 파라미터는 `/sys/module/<mod>/parameters/`에서 조회/런타임 변경(가능시).

### 영구 로드/블랙리스트

```bash
# 항상 로드

echo e1000e | sudo tee /etc/modules-load.d/net.conf

# 블랙리스트(충돌 드라이버 차단)

cat <<'EOF' | sudo tee /etc/modprobe.d/blacklist-legacy.conf
blacklist nouveau
options r8169 aspm=0
EOF

# 반영(재부팅 또는 initramfs 재생성 필요할 수 있음)

sudo update-initramfs -u
```

### DKMS(커널 업그레이드와 함께 모듈 재빌드)

```bash
# 예: 외부 드라이버 패키지 설치 시 자동 등록됨

dkms status
# 수동 재빌드

sudo dkms build  -m <module> -v <ver>
sudo dkms install -m <module> -v <ver>
```

> DKMS는 **커널 업데이트마다** 외부 모듈을 자동 재컴파일 → “커널 올렸더니 Wi-Fi가 사라졌다” 문제를 구조적으로 방지.

---

## 커널 메시지/로그 — dmesg, journalctl -k

### 즉시 확인

```bash
dmesg -T | egrep -i 'error|fail|timeout|segfault'
# 또는 systemd 저널

journalctl -k -b            # 현재 부팅 커널 로그
journalctl -k -b -1         # 이전 부팅
```

### 부팅 멈춤 시 수집 팁

- **부트 옵션**: `loglevel=7` `systemd.log_level=debug` `systemd.log_target=kmsg`
- 직렬콘솔 사용(서버/VM): `console=ttyS0,115200`

```bash
# 예: KVM 게스트의 시리얼 콘솔

GRUB_CMDLINE_LINUX_DEFAULT="console=ttyS0,115200n8 loglevel=7"
```

---

## initramfs 단계 디버깅 — 루트가 안 붙는다?

증상: “A start job is running for /dev/… (1min 30s)”, “Cannot find root device”

### 진단 순서

1) `cat /proc/cmdline` 에서 `root=UUID=…` 가 올바른지
2) `lsinitramfs | grep dm-crypt|lvm|raid` → 필요한 후킹이 들어있는지
3) 암호화/LVM 환경은 **비밀번호 프롬프트**가 유효한지(키맵/콘솔)
4) `dmesg`에 스토리지 드라이버 타임아웃/Probing 실패 흔적

### 재생성

```bash
# Ubuntu

sudo update-initramfs -u -k all
# RHEL/Fedora

sudo dracut -f
```

### 응급 쉘에서 루트 전환 수동 조치(개념)

```bash
# (initramfs 쉘 가정)

/sbin/modprobe dm-crypt
/sbin/cryptsetup open /dev/sda2 cryptroot
vgchange -ay
mount -o ro /dev/mapper/vg0-root /new_root
exec switch_root /new_root /sbin/init
```

---

## 커널 패닉·OOPS 대응 — kdump, kexec, SysRq

### kdump 설정(요지)

1) **커널 커맨드라인**에 `crashkernel=auto` 또는 구체 크기 추가
2) `kdump` 서비스 활성 → 패닉 시 별도 커널로 부팅, 메모리 덤프 저장

```bash
# RHEL/Fedora

sudo systemctl enable --now kdump
sudo kdumpctl status
```

덤프는 `/var/crash/<date>/vmcore` 등으로 수집 → `crash` 도구로 분석.

### kexec — 재부팅 없이 커널 교체

```bash
sudo kexec -l /boot/vmlinuz-<new> --initrd=/boot/initramfs-<new>.img --command-line="$(cat /proc/cmdline)"
sudo systemctl kexec   # 즉시 새 커널로 재실행(주의)
```

### Magic SysRq(막힌 시스템에서 최후의 수단)

```bash
# 활성 여부

cat /proc/sys/kernel/sysrq
# 긴급 시퀀스(키보드): Alt+SysRq+REISUB
# R: 키보드 X, E: 프로세스 종료, I: 강제 kill, S: sync, U: R/O remount, B: 재부팅

```

---

## 보안·무결성 — Secure Boot, 모듈 서명, MOK

### Secure Boot 활성 환경에서 외부 모듈

- 서명되지 않은 모듈 거부 → **MOK**(Machine Owner Key) 등록 필요

```bash
sudo mokutil --import my_pubkey.der
# 재부팅하여 MOK 관리 화면에서 등록

```

DKMS 모듈도 **사전 서명** 또는 **MOK 등록 후 서명** 절차 필요.

### 커널 무결성/정책

- IMA/evm, dm-verity, lockdown 모드(`lockdown=integrity`/`confidentiality`)
- SELinux(부트시 `enforcing=1`), AppArmor 강화

---

## ARM(임베디드) 부팅 특이점 — Device Tree/UEFI 혼재

- x86은 ACPI, ARM은 **Device Tree Blob(DTB)**로 하드웨어 기술
- 부트로더(U-Boot)가 **커널 + initramfs + DTB**를 전달
- 일부는 ARM UEFI + GRUB로 수렴 중

DTB 교체/수정 시 커널과 **정합성** 필수.

---

## 실전 시나리오(End-to-End)

### 시나리오 A — 커널 업데이트 후 네트워크 다운

1) `dkms status` 로 외부 드라이버 빌드 유무 확인
2) 없다면 `sudo dkms autoinstall` 또는 패키지 재설치
3) `journalctl -k | grep -i firmware` 로 펌웨어 요구 확인 → `linux-firmware` 갱신

### 시나리오 B — 부팅이 GRUB에서 멈춘다(Rescue)

1) 라이브 USB 부팅 → 루트 파티션 마운트
2) `mount --bind /dev /mnt/dev` 등 chroot 준비 → `chroot /mnt`
3) `grub-install /dev/sda` → `update-grub` → 재부팅

```bash
# chroot 템플릿

sudo mount /dev/mapper/vg0-root /mnt
sudo mount /dev/sda1 /mnt/boot
sudo mount -t proc /proc /mnt/proc
sudo mount -t sysfs /sys  /mnt/sys
sudo mount --bind /dev /mnt/dev
sudo chroot /mnt
grub-install /dev/sda
update-grub
exit
sudo reboot
```

### 시나리오 C — LUKS/LVM 루트에서 패스프레이즈 프롬프트가 안 뜬다

- `lsinitramfs`에 `cryptsetup`/`lvm` 포함 여부 확인
- **키맵/콘솔** 부트옵션(`vconsole.keymap=`/`rd.vconsole.keymap=`) 의심
- `dracut -f` 또는 `update-initramfs -u`로 재생성

### 시나리오 D — 그래픽 블랙스크린

- `nomodeset` 임시 적용 → GUI 진입 후 드라이버/펌웨어 재설정
- 커널 로그에서 `gpu hang`, `drm` 에러 확인

---

## 커널 빌드(개요) — 로컬 최적화/패치 검증 루틴

> 패키지 커널로 충분하나, 특정 패치/옵션 검증용으로 최소 절차만 정리.

```bash
# 준비(예: Debian/Ubuntu)

sudo apt build-dep linux
git clone https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
cd linux
make oldconfig              # 현재 설정 기반
# 또는 menuconfig로 옵션 조절

make -j$(nproc) bindeb-pkg  # deb 패키지 생성
sudo dpkg -i ../linux-image-*.deb ../linux-headers-*.deb
sudo update-grub && sudo reboot
```

- 새 커널 부팅 실패 대비: GRUB에서 **이전 커널**을 항상 남겨두기

---

## 커널 파라미터(런타임) — sysctl와 /etc/sysctl.d

### 즉시 적용

```bash
sudo sysctl net.ipv4.ip_forward=1
sudo sysctl vm.swappiness=10
```

### 영구화(권장: drop-in 파일)

```bash
# /etc/sysctl.d/99-tuning.conf

net.core.somaxconn = 4096
fs.inotify.max_user_watches = 1048576
vm.swappiness = 10

sudo sysctl --system   # 모든 드롭인 반영
```

---

## 체크리스트(실패 도메인별)

- **GRUB 이전**: UEFI 부트 엔트리/ESP 무결성/디스크 순서
- **GRUB→커널**: `grub.cfg` 커널/Initrd 경로 일치, Secure Boot 서명
- **커널→initramfs**: 드라이버·후킹 포함, LUKS/LVM/RAID 해제/활성
- **initramfs→루트**: 올바른 `root=`/UUID, 파일시스템 모듈 존재
- **루트→systemd**: `systemd.unit=`/`default.target` 이상 여부, `journalctl -xb` 에러

---

## 실전 예제 모음

### 예제 1) “조용함” 제거하고 부팅 원인 파악

```bash
# /etc/default/grub

GRUB_CMDLINE_LINUX_DEFAULT="loglevel=7 systemd.log_level=debug"

sudo update-grub
```

### 예제 2) 특정 모듈 강제 블랙리스트 + 대체 모듈 파라미터

```bash
# /etc/modprobe.d/net-tuning.conf

blacklist r8169
options e1000e InterruptThrottleRate=1,1,1
```
```bash
sudo update-initramfs -u
sudo reboot
```

### 예제 3) kdump 활성화 개요(RHEL 예)

```bash
# /etc/default/grub 커널 라인에 crashkernel=auto 추가 후

sudo grub2-mkconfig -o /boot/grub2/grub.cfg
sudo systemctl enable --now kdump
sudo kdumpctl status
```

### 예제 4) 직렬 콘솔로 헤드리스 서버 부팅 로그 수집

```bash
# /etc/default/grub

GRUB_CMDLINE_LINUX_DEFAULT="console=ttyS0,115200n8 loglevel=7"

sudo update-grub
```

### 예제 5) initramfs에 LUKS/LVM 누락 시 재생성

```bash
# Ubuntu

sudo update-initramfs -u -k all
# Fedora/RHEL

sudo dracut -f
```

---

## 명령·파일 요약

| 도구/파일 | 용도 |
|---|---|
| `efibootmgr` | UEFI 부트 엔트리 관리 |
| `update-grub` / `grub2-mkconfig` | GRUB cfg 생성 |
| `/etc/default/grub` | GRUB 템플릿(커맨드라인 포함) |
| `update-initramfs` / `dracut` | initramfs 생성/갱신 |
| `lsinitramfs` / `cpio` | initramfs 내부 확인 |
| `lsmod`/`modprobe`/`modinfo`/`rmmod` | 모듈 조회/로드/제거 |
| `dkms` | 외부 모듈 커널버전 호환 빌드 |
| `dmesg` / `journalctl -k` | 커널 메시지 조회 |
| `sysctl` / `/etc/sysctl.d/*.conf` | 런타임 파라미터/영구화 |
| `kdumpctl` / `crash` | 커널 크래시 덤프 수집/분석 |
| `kexec` | 재부팅 없이 커널 스위치 |

---

## 부록: 빠른 복구 루틴(현장용 치트시트)

1) GRUB 메뉴에서 **이전 커널** 또는 **고급 옵션** 진입
2) 실패 원인 가설화: (a) GRUB (b) initramfs (c) 드라이버 (d) 루트fs (e) systemd
3) 커맨드라인 조정: `systemd.unit=rescue.target loglevel=7`
4) 네트워크/디스크 모듈 확인: `lsmod`, `modprobe`
5) initramfs 재생성: `update-initramfs -u`/`dracut -f`
6) DKMS 모듈 재빌드: `dkms autoinstall`
7) `journalctl -b -1` 로 **직전 부팅 실패 로그** 확인
8) 최후: 라이브 미디어 → chroot → `grub-install`, `update-grub`, 루트fs 점검

---

## 마무리

- **부팅은 “구간”의 연쇄**입니다. **어디에서 넘기지 못했는지**를 빠르게 특정하면, 조치는 곧바로 좁혀집니다.
- 운영에서는 **조용한 부팅을 멈추고(quiet 해제)**, **로그레벨/직렬콘솔/덤프(kdump)**를 습관화하세요.
- 모듈·펌웨어·initramfs·GRUB cfg의 **정합성 관리**와 **DKMS 자동화**는 “커널 업데이트 공포증”을 없애줍니다.
- 이 글의 템플릿과 루틴으로 **부팅 장애의 평균 복구 시간(MTTR)**을 확실히 줄일 수 있습니다.
