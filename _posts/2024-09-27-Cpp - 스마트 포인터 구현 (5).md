---
layout: post
title: C++ - μ¤λ§νΈ ν¬μΈν„° κµ¬ν„ (5)
date: 2024-09-27 19:20:23 +0900
category: Cpp
---
# π§­ μ¤λ§νΈ ν¬μΈν„° μ™„μ „ μ •λ¦¬ β€“ μ‹¤μ „ μ”μ•½νΈ

C++μ μ¤λ§νΈ ν¬μΈν„°λ” μμ›μ μλ™ κ΄€λ¦¬λ¥Ό λ„μ™€μ£Όλ” κ°•λ ¥ν• λ„κµ¬μ…λ‹λ‹¤.  
μ΄ μ‹λ¦¬μ¦μ—μ„λ” `unique_ptr`, `shared_ptr`, `weak_ptr`, κ·Έλ¦¬κ³  λ‚΄λ¶€ κµ¬μ΅°μ™€ μ»¤μ¤ν…€ κµ¬ν„κΉμ§€ λ‹¤λ¤μµλ‹λ‹¤.  
μ΄μ  μ¤‘μ”ν• κ°λ…μ„ ν• λμ— μ •λ¦¬ν•΄λ΄…μ‹λ‹¤.

---

## π“ μ¤λ§νΈ ν¬μΈν„° μΆ…λ¥ μ”μ•½

| μΆ…λ¥           | νΉμ§•                         | λ³µμ‚¬ μ—¬λ¶€  | μ“°μ„ |
|----------------|------------------------------|------------|------|
| `unique_ptr`   | λ‹¨λ… μ†μ κ¶                   | β (moveλ§ κ°€λ¥) | μμ› μ†μ κ¶ μ΄μ „μ΄ ν•„μ”ν• κ²½μ° |
| `shared_ptr`   | κ³µμ  μ†μ κ¶, μ°Έμ΅° μΉ΄μ΄νΈ      | β…         | μ—¬λ¬ κ³³μ—μ„ κ³µμ λλ” κ°μ²΄ |
| `weak_ptr`     | μ†μ κ¶ μ—†μ, shared μ°Έμ΅° μ¶”μ  | β…         | μν™ μ°Έμ΅° λ°©μ§€μ© |

---

## π”§ λ‚΄λ¶€ κµ¬μ΅° ν•µμ‹¬

### π“¦ shared_ptr κµ¬μ΅° μ”μ•½

```text
[shared_ptr] β”€β”¬β”€> [T*]
              β””β”€> [ControlBlock]
                    β”β”€ ref_count
                    β””β”€ weak_count
```

- **ControlBlock**μ€ μ°Έμ΅° μΉ΄μ΄νΈ λ° μ‚­μ μ λ“±μ„ ν¬ν•¨
- `shared_ptr` λ³µμ‚¬ β†’ `ref_count++`
- λ§μ§€λ§‰ `shared_ptr` μ†λ©Έ β†’ `ref_count == 0` β†’ κ°μ²΄ μ‚­μ 
- `weak_ptr`κΉμ§€ μ‚¬λΌμ§ β†’ ControlBlock μ‚­μ 

---

## π›  make_shared μµμ ν™” μ”μ•½

| ν•­λ©                     | μΌλ° new + shared_ptr | make_shared           |
|--------------------------|------------------------|------------------------|
| λ©”λ¨λ¦¬ ν• λ‹Ή νμ         | 2λ² (T + ControlBlock) | 1λ² (ν†µν•©)            |
| μμ™Έ μ•μ „μ„±              | λ‚®μ                   | λ†’μ                  |
| μ„±λ¥                     | λ³΄ν†µ                   | μ°μ (μΊμ‹ μΉν™”μ )     |

```cpp
auto p = std::make_shared<MyClass>();  // β… μ¶”μ²
```

---

## π¤ shared_from_this μ‚¬μ©λ²• μ”μ•½

- ν΄λμ¤ λ‚΄λ¶€μ—μ„ `shared_ptr`μ„ λ°ν™ν•λ ¤λ©΄ `enable_shared_from_this` μƒμ† ν•„μ”

```cpp
class MyClass : public std::enable_shared_from_this<MyClass> {
public:
    std::shared_ptr<MyClass> getPtr() {
        return shared_from_this();
    }
};
```

- μƒμ„±μλ” `shared_ptr`κ³Ό μ—°κ²°λμ§€ μ•μΌλ―€λ΅, μƒμ„±μ λ‚΄λ¶€μ—μ„ `shared_from_this()` νΈμ¶ κΈμ§€!

---

## β οΈ μ‹¤μ λ°©μ§€ μ²΄ν¬λ¦¬μ¤νΈ

β… `new T()` λ€μ‹  `make_shared<T>()`λ¥Ό μ“°μ  
β… μ λ€ `shared_ptr<T>(this)` κΈμ§€ (μ΄μ¤‘ μ‚­μ  μ„ν—)  
β… `unique_ptr`μ€ λ³µμ‚¬ κΈμ§€, `std::move`λ΅ λ„κΈ°μ  
β… `shared_ptr`λ΅ μν™ μ°Έμ΅° μƒκΈ°λ©΄ `weak_ptr`λ΅ λμ  
β… `enable_shared_from_this`λ” κΌ­ μƒμ† κµ¬μ΅°μ— λ§κ² μ‚¬μ©ν•μ

---

## π“ μ§μ ‘ κµ¬ν„ μ‹ κΈ°μ–µν•  μ 

| κΈ°λ¥                        | ν•µμ‹¬ ν¬μΈνΈ                          |
|-----------------------------|---------------------------------------|
| μ»¤μ¤ν…€ `SharedPtr<T>`        | ControlBlock μ„¤κ³„, μ°Έμ΅° κ΄€λ¦¬         |
| `WeakPtr<T>` κµ¬ν„            | ControlBlock μ μ§€, lock()λ΅ κ³µμ  λ³µμ› |
| `make_shared` κµ¬ν„          | `placement new`, λ‹¨μΌ λ©”λ¨λ¦¬ λΈ”λ΅ μ‚¬μ© |
| `enable_shared_from_this`   | λ‚΄λ¶€ `weak_ptr` μ €μ¥, μλ™ μ—°κ²° ν•„μ” |

---

## π’΅ μ–Έμ  μ–΄λ–¤ μ¤λ§νΈ ν¬μΈν„°λ¥Ό μ¨μ•Ό ν• κΉ?

| μƒν™©                                 | μ μ ν• μ¤λ§νΈ ν¬μΈν„° |
|--------------------------------------|------------------------|
| λ‹¨λ… μμ› μ†μ                          | `unique_ptr`           |
| μ—¬λ¬ κ°μ²΄κ°€ μ†μ                       | `shared_ptr`           |
| μ°Έμ΅°λ” ν•λ μƒλ… μ£ΌκΈ°λ” μ†μ ν•μ§€ μ•μ | `weak_ptr`             |
| λ‚΄λ¶€μ—μ„ μκΈ° μμ‹ μ„ μ•μ „ν•κ² μ°Έμ΅°     | `shared_from_this()`   |

---

## π§  λ§λ¬΄λ¦¬: μ¤λ§νΈ ν¬μΈν„° μ² ν•™

μ¤λ§νΈ ν¬μΈν„°λ” λ‹¨μν• ν¬μΈν„°λ¥Ό λ€μ²΄ν•λ” λ„κµ¬κ°€ μ•„λ‹™λ‹λ‹¤.  
κ·Έ λ©μ μ€ C++μ μ² ν•™μΈ **RAII(Resource Acquisition Is Initialization)** λ¥Ό μ‹¤ν„ν•λ©°,  
λ©”λ¨λ¦¬ ν•΄μ μ™€ μμ› κ΄€λ¦¬λ¥Ό **μλ™ν™”ν•κ³  λ…ν™•ν•κ²** λ§λ“λ” κ²ƒμ…λ‹λ‹¤.
