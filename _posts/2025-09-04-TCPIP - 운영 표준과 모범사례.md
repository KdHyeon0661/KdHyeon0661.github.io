---
layout: post
title: TCPIP - 운영 표준과 모범사례
date: 2025-09-04 23:25:23 +0900
category: TCPIP
---
# 19. 운영 표준과 모범사례
**(🔰 네트워크 문서화: 주소계획·다이어그램·변경관리, ⚙️ 모니터링: 지연·손실·재전송률·연결수, 🚀 용량 계획·성능 테스트 시나리오)**

> 이 장은 “**운영은 문서·지표·실험이 전부다**”라는 전제를 실무 관점에서 풀어낸 **체크리스트+템플릿+예제** 모음입니다.  
> 명령/설정은 ``` 코드 블록으로, 간단 수식은 *MathJax*로 표기합니다.

---

## 19.1 네트워크 문서화 표준 (🔰)

### 19.1.1 주소계획(IPAM) 원칙
- **단일 출처(Single Source of Truth)**: 스프레드시트가 아닌 **Git 관리 IPAM**(YAML/CSV) 또는 상용 IPAM(Infoblox/NetBox 등) 사용.
- **의미가 보이는 계층화**  
  - **Global**: `10.0.0.0/8` 같은 대역 예약  
  - **Region/Zone**: `10.12.0.0/16` (ap-northeast-2)  
  - **환경**: `10.12.10.0/23` (prod), `10.12.20.0/23` (staging)  
  - **역할**: `10.12.10.0/24` (app), `10.12.11.0/24` (db)
- **충돌·중복 방지**: IPAM에서 **CIDR 겹침 검증** CI 파이프라인.
- **IPv6**는 일찍부터 병행: `/56`~`/48`을 리전에 할당, 서버/Pod는 SLAAC/ULA 계획 포함.

**예: Git 기반 IPAM 스니펫(YAML)**
```yaml
meta:
  version: 1
  owner: netops
  updated: 2025-09-10
global:
  ipv4_root: 10.0.0.0/8
  ipv6_root: 2001:db8::/32
regions:
  apne2:
    cidr_v4: 10.12.0.0/16
    cidr_v6: 2001:db8:12::/48
    envs:
      prod:
        subnets:
          app: {v4: 10.12.10.0/24, v6: 2001:db8:12:10::/64, vlan: 110}
          db:  {v4: 10.12.11.0/24, v6: 2001:db8:12:11::/64, vlan: 111}
      stg:
        subnets:
          app: {v4: 10.12.20.0/24, v6: 2001:db8:12:20::/64, vlan: 210}
```

### 19.1.2 네이밍 규칙(권장)
- **장비**: `<role>-<site>-<rack>-<pos>` 예) `sw-core-seo-r03-u12`
- **인터페이스**: `ge-0/0/1`, `eth1.110`(서브인터페이스는 VLAN ID 포함)
- **DNS 레코드**:  
  - **서비스**: `api.region.example.com`  
  - **역할**: `db-ro.apne2.prod.example.net`  
  - **장비 관리**: `mgmt-sw-core-seo.example.net`

### 19.1.3 다이어그램 표준
- **L1(물리)**: 랙·케이블·전원·광모듈(심볼 일관)  
- **L2(스위칭)**: VLAN·Trunk/Access·LAG·STP  
- **L3(라우팅)**: ASN·피어링·VRF·경로(요약 CIDR)  
- **오버레이/클라우드**: VPC·서브넷·IGW/NAT·SG/NACL·CNI·Ingress

**범례(예)**
```
[사각형] 장비/인스턴스  [구름] 클라우드  [굵은실선] LAG/포트채널
[점선] 오버레이(VXLAN/GRE)  [자물쇠] TLS/Tunnel  [⚠] 변경/리스크 포인트
```

**버전 관리**
- 다이어그램/주소계획/변경 기록을 **같은 리포지토리**에 보관.  
- **Semantic versioning**과 **Changelog**로 변경 이유/영향 범위 기록.

### 19.1.4 변경관리(Change Management)
- **RFC(Request For Change) 템플릿**
```
[제목] apne2 L3 코어 경로 요약 추가 (/16 → /15)
[배경] 라우팅 테이블 축소, 수렴 시간 개선
[영향] 경로 요약 범위 내 신규 세그먼트 필요 시 재광고 필요
[계획] 1) 백업 경로 검증 2) 유지보수 창 02:00~03:00 3) 단계적 적용 4) 검증
[롤백] 기존 /16 경로 재광고, 각 노드 config restore
[리스크] 경로 블랙홀/비대칭 가능 → 샌드박스 시뮬레이션/프리체크
[승인] CAB(네트·보안·플랫폼) 승인 필요, D-1 알림
```
- **MOP/SOP**  
  - **MOP**(Method of Procedure): 실제 커맨드/스크린샷/퍼포먼스 임계 포함  
  - **SOP**(Standard Operating Procedure): 반복 운용 표준

**MOP 예시(발췌)**
```text
1) 사전: 'show route summary' 저장, 'ping pmtud' OK 확인
2) 변경: 'set policy-options aggregate route 10.12.0.0/15'
3) 커밋: 'commit confirmed 10' → 검증 후 'commit'
4) 검증: 라우트 수, 수렴 시간, 트래픽 끊김 여부
5) 롤백 기준: 손실>0.1% 또는 지연+20ms 3분 지속 시 'rollback 1'
```

---

## 19.2 모니터링: 지표 설계 & 알림 (⚙️)

### 19.2.1 관측 대상(레이어별)
- **L1/2**: 링크 업/다운, 에러·드롭, STP 상태, LAG 멤버, 채널 이용률  
- **L3**: BGP/OSPF/IS-IS 피어 상태·수렴, 경로 수·플랩, VRF 헬스  
- **L4/7**: 연결 수, 신설 연결률, 재전송률, RTT/TTFB, 에러율(4xx/5xx)  
- **클라우드**: NAT 게이트웨이 커넥션, NACL/SG 드롭, VPC Flow Logs  
- **앱/프록시**: H2/H3 비율, 커넥션 풀 히트율, 큐 대기시간, Outlier Ejection  
- **DNS**: 쿼리 시간, 코드 비율(NX/SERVFAIL), 캐시 히트, 권한서버 헬스

### 19.2.2 핵심 SLI/지표 정의
- **지연(Latency)**: RTT, TTFB(P50/P95/P99)  
- **손실(Loss)**: ICMP/TCP 재전송률, UDP 손실률  
- **재전송률(Retrans %)**: `tcp_retrans_segs / tcp_out_segs`  
- **연결 수/율**: `conn_active`, `conn_new/s`  
- **가용성(Availability)**: 헬스 패스율, 5xx 비율 역수  
- **큐 지연/포화**: `queue_wait_ms`, 인터페이스 큐 드롭  
- **ECN CE율**: 마킹 비율로 혼잡 측정

**지표 간 수식 예(리틀의 법칙)**
\[
L = \lambda \cdot W \quad
\text{(동시 연결수)} = \text{도착률(RPS)} \times \text{지연(초)}
\]
→ 원하는 RPS와 목표 응답시간으로 **풀 크기/인스턴스 수** 역산.

### 19.2.3 대시보드 레이아웃(제안)
1) **NOC 탑패널(10초 리프레시)**  
   - 세계 지도: 리전별 P95 TTFB, 오류율, 트래픽  
   - BGP 피어 카운트/플랩, Anycast POP 헬스  
   - DNS 응답시간/오류율
2) **서비스 패널**  
   - L7: RPS, P50/95/99 TTFB, 4xx/5xx, 리트라이율, H2/H3비  
   - L4: conn_active/new/s, 재전송률, ECN CE%  
   - 백엔드: 풀 히트율, 큐 대기, DB 커넥션
3) **링크/장비**  
   - 인터페이스 Util/에러/드롭, LAG 불균형, STP 상태  
   - 장비 CPU/메모리/온도/전원

### 19.2.4 수집 경로
- **SNMPv3**(장비), **sFlow/NetFlow/IPFIX**(트래픽), **Prometheus Exporter**(프록시/앱), **CloudWatch/Stackdriver**(클라우드 메트릭), **VPC Flow Logs**, **RUM/합성 모니터**(Synthetics), **BGP 모니터**(ExaBGP/bird_exporter).

### 19.2.5 Prometheus 규칙(예시)
```yaml
groups:
- name: net-latency
  rules:
  - alert: EdgeP95LatencyHigh
    expr: histogram_quantile(0.95, sum by(le,region)(rate(http_request_duration_seconds_bucket{job="edge"}[5m]))) > 0.400
    for: 10m
    labels: {severity: page}
    annotations:
      summary: "Region {{ $labels.region }} P95 TTFB > 400ms (10m)"

  - alert: RetransmissionRateHigh
    expr: rate(node_netstat_Tcp_RetransSegs[5m]) / rate(node_netstat_Tcp_OutSegs[5m]) > 0.02
    for: 5m
    labels: {severity: ticket}
    annotations:
      summary: "Retransmission > 2% (possible congestion/MTU issue)"

- name: lb-health
  rules:
  - alert: BackendOutlierEjections
    expr: increase(envoy_cluster_outlier_detection_ejections_total[10m]) > 10
    labels: {severity: page}
    annotations:
      summary: "Frequent outlier ejections (check backend health/load)"
```

### 19.2.6 알림 전략(소모성 경보 방지)
- **SLO 기반 번 레이트 알림**: 에러 버짓 소진 속도 기준.
- **지속시간 조건**: 스파이크는 무시(`for: 5m` 이상).
- **연결된 런북 링크**: 알림 텍스트에 **원인 후보/명령 모음** 포함.
- **다단계 라우팅**: P1(전화/슬랙), P2(슬랙/이메일), P3(정기 리포트).

**번 레이트(예)**
\[
\text{Burn Rate} = \frac{\text{실패율}}{\text{허용 실패율}}
\]
- BR>14 (5분 창) & BR>3 (1시간 창) **동시** 충족 시 페이징.

---

## 19.3 용량 계획 & 성능 테스트 시나리오 (🚀)

### 19.3.1 모델링: 무엇을 계산할까
- **트래픽**: bps(대역), pps(패킷수), RPS(요청수), CPS(신규 연결/초), HPS(TLS 핸드셰이크/초)
- **리소스**: CPU/메모리/FD/소켓/conntrack, 디스크 IOPS(로그), NIC 큐/인터럽트
- **네트워크**: RTT, BDP, 재전송율, ECN CE율, 큐 지연

**BDP 계산**
\[
\text{BDP} = \text{Bandwidth} \times \text{RTT}
\]
예) 5 Gbps, RTT 60 ms → `5e9 * 0.06 ≈ 300 Mb ≈ 37.5 MB`  
→ 송수신 버퍼/윈도우·큐는 **최소 수십 MB** 필요.

**커넥션 풀 추정**
\[
\text{pool\_size} \approx \lambda \times W
\]
예) 4000 RPS, 평균 60ms → `240`개 연결 필요(+ 여유 20~30%).

### 19.3.2 헤드룸과 목표
- **링크/장비**: 95퍼센타일 사용률 **≤ 60~70%**, CPU **≤ 70%**  
- **LB/프록시**: `conn_active` 여유 30% 이상, **핸드셰이크/초** 목표치 정의  
- **스토리지/로그**: 스파이크 대비 **2~3배 버퍼링**(큐/디스크)

### 19.3.3 성장 예측
- 과거 3~6개월 **95퍼센타일** 트렌드 → 선형/지수 모델.  
- **이벤트/프로모션/배포** 달력 반영(피크 계수 k).

### 19.3.4 테스트 시나리오 디자인
- **래더(계단)**: 0→25%→50%→75%→100% 단계별 10분 유지.  
- **스텝 스트레스**: 100%에서 1.2x/1.5x/2x 짧은 스파이크.  
- **소크(Soak)**: 70~80% 부하로 **6~24시간** 장기 안정성/누수 확인.  
- **스파이크/냉시동**: 대규모 동시 시작(앱/크론/새벽 사용자).  
- **혼합 트래픽**: 정적/동적/업로드/다운로드/웹소켓/HTTP3 비율.

**트래픽 믹스 표(예)**
```
GET static (H2/H3) : 40%
GET API            : 35%
POST API           : 15%
WebSocket          :  5%
gRPC               :  5%
```

### 19.3.5 테스트 도구/방법
- **L7 HTTP**: `k6`, `wrk2`(고정 RPS), `locust`  
- **L4/QUIC**: `h2load`, `fortio`, `curl --http3` 스크립트  
- **네트워크**: `iperf3`(TCP/UDP), `flent`, `tc netem`(지연/손실/대역 제한)
- **장애 주입**: **Chaos**(링크 다운/BGP 플랩/인스턴스 종료/패킷 손실)

**k6 스크립트(발췌)**
```js
import http from 'k6/http';
import { sleep } from 'k6';
export let options = {
  stages: [
    { duration: '3m', target: 2000 },
    { duration: '10m', target: 2000 },
    { duration: '3m', target: 0 }
  ],
  thresholds: {
    http_req_duration: ['p(95)<400', 'p(99)<900'],
    http_req_failed: ['rate<0.01']
  }
};
export default function () {
  const res = http.get('https://www.example.com/api/v1/items');
  sleep(0.1);
}
```

**tc netem로 지연/손실 주입**
```bash
tc qdisc add dev eth0 root netem delay 80ms 20ms loss 1% rate 200mbit
# 테스트 후
tc qdisc del dev eth0 root
```

### 19.3.6 사전/사후 체크리스트
**사전**
- [ ] 테스트 환경 **프로덕션과 동일 경로**(CDN/LB/방화벽)  
- [ ] 알림/오토스케일 **일시 정책 조정**(허용 범위 확대)  
- [ ] 테스트 트래픽 **식별 헤더**(`X-LoadTest: true`)로 로깅 분리  
- [ ] 데이터베이스/스토리지 **샌드박스** 또는 **읽기 전용** 시나리오

**사후**
- [ ] P50/95/99, 오류율, 재시도율, conn_active/new/s, CPU/메모리/FD  
- [ ] **성능 회귀** 없는지(이전 릴리스 비교)  
- [ ] 병목 계층(네트·LB·앱·DB) **탑 3**와 개선 액션

### 19.3.7 수용력 추정 예제

**예1: L7 프록시 수용량**
- 목표: `P95 TTFB<400ms`, 오류<1%, RPS=10k
- 관측: 한 인스턴스 당 안정 `RPS≈1500`, CPU 65%, conn_active 800
- 필요 인스턴스:  
  \[
  N \ge \frac{10000}{1500} \times 1.3 \ (\text{헤드룸}) \approx 8.7 \Rightarrow 9
  \]
- **오토스케일**: CPU>70% 또는 `P95>350ms` 5분 지속 시 +1

**예2: TLS 핸드셰이크**
- 목표 HPS=2k(피크), 인스턴스당 HPS=300  
  → 최소 7개(+30% 헤드룸 → 10개)

**예3: 링크 용량**
- 95퍼센타일 아웃바운드 4.2 Gbps, 피크 6.0 Gbps  
  - 정책: 95p ≤ 70% 링크 → 링크 10 G 업그레이드 or LAG 2×10 G  
  - LAG 해시 불균형 모니터(`per-member util`)

---

## 19.4 운영 아카이브: 런북·포스트모템·지식화

### 19.4.1 런북(자동 링크)
- 알림 → **런북** 바로가기: 증상별 `dig/mtr/curl/ss/pcap` 명령 포함  
- “**롤백 조건**·**백업 지표**·**담당자**”가 맨 위

### 19.4.2 포스트모템(Blameless)
```
[타임라인] 탐지-대응-복구
[영향] 기간/사용자/거래
[근본 원인] 기술/프로세스
[탐지] 어떤 지표가 잡았나/못 잡았나
[액션] 단기/장기(오너/마감)
[교훈] 체크리스트/테스트/문서 업데이트
```

### 19.4.3 문서 라이프사이클
- **리뷰 주기**(분기별), **소유자 지정**, **아카이브 정책**(구버전 폐기), 링크 만료 점검.

---

## 19.5 템플릿 모음 (복붙용)

### 19.5.1 변경 요청서(RFC)
```markdown
# RFC: <요약 제목>
- 제출자: @owner  / 팀: NetOps
- 변경 유형: 표준 / 비표준 / 긴급
- 윈도우: 2025-09-20 02:00–03:00 KST
- 영향: 트래픽 절체 1회(<1s), 모니터링 알림 가능
- 리스크: BGP 수렴 지연 → 경로 불안정
- 완화: Graceful shutdown, RHI, 프리체크
- 롤백 플랜: 'rollback.sh' 실행, 기존 config 복원
- 검증: 패킷 손실<0.1%, TTFB 변동<+20ms 5분 이내
```

### 19.5.2 MOP(절차)
```text
1) 사전 백업: 'show run' 저장, 'ethtool -S' 캡처
2) 유지창 알림/배너 공지
3) 단계적 변경 A→B (LAG 멤버 단위)
4) 검증: mtr, curl -w, flow logs
5) 롤백 조건 충족 시 즉시 'rollback.sh'
6) 보고: 전/후 지표 스냅샷, PR에 첨부
```

### 19.5.3 IPAM CSV 포맷(간단)
```csv
region,env,role,vlan,cidr_v4,cidr_v6,gw_v4,gw_v6,notes
apne2,prod,app,110,10.12.10.0/24,2001:db8:12:10::/64,10.12.10.1,2001:db8:12:10::1,web/app tier
apne2,prod,db,111,10.12.11.0/24,2001:db8:12:11::/64,10.12.11.1,2001:db8:12:11::1,db subnet
```

### 19.5.4 Grafana 대시보드 섹션(요지)
```
Row1: Global Map(P95, Err%), Region Share, BGP Peers
Row2: Edge(L7) RPS/TTFB/Err%, H2/H3 ratio, Retry
Row3: L4 conn_active/new/s, Retrans%, ECN CE%
Row4: Link Util per-member, Drops/Err, STP/LAG
Row5: DNS Query time, NX/SERVFAIL, Cache hit
```

---

## 19.6 체크리스트(요약 카드)

**문서화**
- [ ] Git 관리 IPAM/다이어그램, 네이밍/범례 표준  
- [ ] 변경관리: RFC→MOP→검증→포스트모템  
- [ ] 주소계획: 리전/환경/역할 계층, IPv6 병행

**모니터링**
- [ ] SLI/SLO 정의(P50/95/99), 번 레이트 알림  
- [ ] L4/7·DNS·BGP·링크 지표, ECN/재전송율  
- [ ] 대시보드: NOC/서비스/링크, 런북 링크

**용량/테스트**
- [ ] BDP/풀 크기/핸드셰이크/HPS 모델  
- [ ] 래더/소크/스파이크/혼합 트래픽 시나리오  
- [ ] 95p ≤ 70% 정책, 헤드룸 30%+, 오토스케일

---

### 부록 A — 빠른 계측 명령 모음
```bash
# 지연/타이밍
curl -sS -o /dev/null -w 'dns:%{time_namelookup} conn:%{time_connect} tls:%{time_appconnect} ttfb:%{time_starttransfer} total:%{time_total}\n' https://host

# 경로/MTU
mtr -rwzbc100 host
tracepath host; ping -M do -s 1472 host

# TCP 상태
ss -s; ss -tin '( dport = :443 or sport = :443 )' | head

# 인터페이스/에러
ip -s link show dev eth0
ethtool -S eth0 | egrep 'err|drop|crc|miss'
```

### 부록 B — 지표 필드 가이드(요약)
```
[Edge/L7] rps, ttfb_p50/95/99, err_4xx/5xx, retry_rate, h2/h3_ratio
[L4] conn_active, conn_new/s, retrans%, rtt_p50/95, ecn_ce%
[Link] util_in/out, err/drop, member_imbalance, stp_state
[BGP] peers_up, flaps, prefixes_in, convergence_s
[DNS] qps, query_ms_p95, nxdomain_rate, servfail_rate, cache_hit
```

---

## 19.7 한 장 요약(포스터)
- **문서화**는 신뢰의 시작: **주소·다이어그램·변경**이 한 리포지토리에서 진화해야 한다.  
- **모니터링**은 지연·손실·재전송·연결수, 그리고 **퍼센타일**이 핵심. 알림은 **SLO/번 레이트**로.  
- **용량/성능**은 **BDP/풀/핸드셰이크**를 숫자로 모델링하고, **래더/소크/스파이크** 테스트로 검증한다.  
- 운영의 기술은 **사전 체크리스트**와 **사후 학습**으로 완성된다.
