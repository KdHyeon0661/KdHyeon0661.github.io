---
layout: post
title: TCPIP - 실전 사고노트
date: 2025-09-04 22:25:23 +0900
category: TCPIP
---
# 18. 실전 사고노트
**(⚙️ SYN Flood와 완화 전략, ⚙️ PMTUD 블랙홀 전송 실패, ⚙️ TIME_WAIT 폭증과 커넥션 한계, ⚙️ DNS 캐싱/TTL 설정 실수, ⚙️ CGNAT 뒤 P2P/원격 접속 문제)**

> “현장에서 진짜로 터지는” 다섯 가지 전형 케이스를 **현상 → 가설 → 증거 수집 → 즉시 대응(Contain) → 근본 조치(Fix) → 사후 학습(Prevent)** 순으로 기록합니다.
> 명령/설정은 ``` 코드 블록으로, 간단 도식은 ASCII로 표기합니다.

---

## 18.1 케이스 #1 — SYN Flood와 완화 전략 (⚙️)

### 18.1.1 현상
- 짧은 시간에 **SYN** 폭주 → `SYN_RECV` 소켓 급증, **새 연결 수락 실패**, 502/504 증가.
- L4/L7 LB CPU는 평소와 유사하나 **커널 소켓 큐/백로그** 포화.

### 18.1.2 즉석 점검
```bash
# 현재 소켓 및 큐 상태
ss -ant 'state syn-recv' | wc -l
ss -s

# 커널 통계
netstat -s | egrep -i 'listen|SYN|overflow|drops'

# HAProxy/NGINX 수락 대기열(있으면)
echo "show info" | socat stdio /run/haproxy/admin.sock | egrep 'CurrConns|ListenQueue'
```

### 18.1.3 가설
- 대역 외부에서 **L4 SYN Flood** (대량 스푸핑 포함)
- 애플리케이션 병목이 아니라 **커널/네트워크 계층 포화**

### 18.1.4 Contain(즉시 대응)
1) **커널 완화**
```bash
# SYN backlog 확장 & SYN-ACK 재시도 단축
sysctl -w net.ipv4.tcp_max_syn_backlog=32768
sysctl -w net.ipv4.tcp_synack_retries=3
# SYN cookies (정상 트래픽 영향 적음)
sysctl -w net.ipv4.tcp_syncookies=1
# 수락 큐 확대
sysctl -w net.core.somaxconn=4096
```
2) **L4 차단/속도 제한 (엣지/호스트)**
```bash
# nftables: 초당 SYN Rate Limit (개념)
nft add rule inet filter input tcp flags syn limit rate 5000/second accept
nft add rule inet filter input tcp flags syn drop

# iptables SYNPROXY (커널/모듈 필요)
iptables -t raw -A PREROUTING -p tcp -m tcp --syn -j CT --notrack
iptables -A INPUT -p tcp -m tcp --syn -m hashlimit --hashlimit-name syn \
  --hashlimit 4000/sec --hashlimit-burst 8000 --hashlimit-mode srcip --hashlimit-srcmask 32 \
  -j SYNPROXY --sack-perm --timestamp --wscale 7 --mss 1460
```
3) **상단 방어**
- **Anycast 엣지**/DDoS 스크러빙 센터 연동, **BGP Flowspec**로 공격 서브넷/포트 컷.
- 클라우드 L4 **Managed DDoS Protection** 활성화.

### 18.1.5 Fix(근본 조치)
- **L4 앞단 확장**: 수용량 큰 L4 LB(NLB/IPVS)로 초반 SYN 흡수.
- **SYNPROXY 전면**: L7 앞단에 **전용 L4**(커널/어플라이언스) 배치.
- **헬스/오토스케일**: LB 인스턴스 풀 자동 증감.
- **거래 로그**: 공격원 ASN/패턴 기반 자동 룰(만료 시간 포함).

### 18.1.6 Prevent(사후)
- 런북: **SYN flood 탐지 임계**(새 연결/초, SYN_RECV 수, 수락지연) + 즉시 적용 스크립트.
- **관측**: `accept queue`, `listen drops`, `SYN cookies sent`, 지역/ASN 별 유입.

---

## 18.2 케이스 #2 — PMTUD 블랙홀로 전송 실패 (⚙️)

### 18.2.1 현상
- **작은 응답은 정상**, **큰 응답만 타임아웃**. HTTP/2는 간헐 OK, **HTTP/3(QUIC) 실패** 빈발.
- 신규로 **IPsec/VXLAN/VPN** 도입 직후 발생.

### 18.2.2 즉석 점검
```bash
# 경로 MTU 힌트
tracepath <host>         # e.g., pMTU 1480 … 1440 …
# DF 고정 ping (IPv4/IPv6)
ping -M do -s 1472 <host>      # 1500-28
ping -M do -s 1452 -6 <host>   # 1500-48
# 서버/노드 MTU
ip link show dev eth0 | grep mtu
```
패킷 캡처에서 **ICMP Fragmentation Needed / Packet Too Big**가 **보이지 않음** → 방화벽에서 **ICMP 차단 추정**.

### 18.2.3 가설
- 터널 오버헤드로 **유효 MTU 감소**, 그러나 경로에서 **ICMP Too Big**가 차단되어 **PMTUD 블랙홀**.

### 18.2.4 Contain
- **MSS 클램핑(경계/노드 출구)**
```bash
# IPv4, 노드/게이트웨이에서
iptables -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN \
  -j TCPMSS --clamp-mss-to-pmtu
# 또는 고정값(예: 오버레이 환경 1360)
iptables -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN \
  -j TCPMSS --set-mss 1360
```
- **서버/노드**: PLPMTUD 활성
```bash
sysctl -w net.ipv4.tcp_mtu_probing=1
```

### 18.2.5 Fix
- **ICMP PTB 허용**(보안장비/클라우드 보안그룹) 룰 추가.
- **CNI/오버레이 MTU** 통일(예: Underlay 1500 → VXLAN 1450, Pod 1450).
- VPN/PPPoE/EVPN 등 **오버헤드 표** 문서화, 변경 시 체크리스트화.

### 18.2.6 Prevent
- **배포 전** `tracepath`/DF ping 자동 점검.
- 저장된 **골든 경로 MTU**와 **드리프트 알림**(변화 시 경보).

---

## 18.3 케이스 #3 — TIME_WAIT 폭증 & 서버 커넥션 한계 (⚙️)

### 18.3.1 현상
- **TIME_WAIT 소켓** 수십/수백만 → **FD 고갈**, 새 연결 지연/실패(accept 에러).
- RPS 급증 이벤트 또는 **Keep-Alive 비활성** 배포 이후.

### 18.3.2 배경
- **능동 종료한 쪽**이 대체로 TIME_WAIT 보유. **프록시/백엔드**가 요청마다 새 연결 열고 닫으면 폭증.
- NAT 경계에서도 **포트 고갈**.

### 18.3.3 즉석 점검
```bash
ss -ant state time-wait | wc -l
ss -s
cat /proc/sys/net/ipv4/ip_local_port_range
ulimit -n
```

### 18.3.4 가설
- **커넥션 재사용 부족**(Keep-Alive/풀 미설정), **짧은 idle timeout**, H1 다중 커넥션 남발.

### 18.3.5 Contain
- **프록시→백엔드 Keep-Alive/풀 즉시 확대**
  - NGINX: `keepalive 256;` / `proxy_http_version 1.1; proxy_set_header Connection "";`
  - Envoy/HAProxy: **커넥션 풀**/H2 업스트림.
- **FD/포트 상향**
```bash
ulimit -n 1048576
sysctl -w net.ipv4.ip_local_port_range="20000 65000"
```
- **주의**: `tcp_tw_recycle` **절대 금지**(NAT 환경 문제). `tcp_tw_reuse`는 **클라 아웃바운드** 최적화로 제한적 의미.

### 18.3.6 Fix
- **HTTP/2/3 업스트림**으로 연결 수 축소(멀티플렉싱).
- **idle timeout** 양단 조율(프록시>백엔드).
- **요청당 새 커넥션**을 만드는 코드/라이브러리 수정(풀 라이브러리 사용).
- **SO_REUSEPORT**로 멀티 워커 균등 수락.

### 18.3.7 Prevent
- 대규모 릴리스 전 **TIME_WAIT 비율 경보** 및 **풀 히트율** 지표.
- 카나리에서 **FD 사용량/포트 사용량** 추적.

---

## 18.4 케이스 #4 — DNS 캐싱/TTL 설정 미스로 장애 (⚙️)

### 18.4.1 현상
- 배포 후 일부 지역만 새로운 오리진/ELB로 **안 붙음**.
- **TTL 과대/과소** 또는 **Negative Caching**/권한서버 TTL 불일치로 **이상한 캐시 지속**.

### 18.4.2 즉석 점검
```bash
dig www.example.com A +ttl +nsid +trace
dig @1.1.1.1 www.example.com A +edns=1280 +dnssec +stats
dig @resolver.of.isp www.example.com A +stats
# 로컬 캐시
systemd-resolve --statistics 2>/dev/null || true
```
- 포인트: `TTL`, CNAME 체인 길이, 권한서버 NS/DS 동기, **NXDOMAIN TTL**(negative TTL), 리졸버별 상이 응답.

### 18.4.3 가설
- **TTL이 너무 큼**(예: 1d) → 이전 IP/레코드 장기 유지.
- 반대로 **TTL=0** 난발 → 리졸버 과부하/지연.
- **EDNS/프래그 멘테이션**으로 일부 리졸버 실패(UDP↓→TCP 폴백 안 됨).
- **Split DNS**로 사내/외부 응답 상이.

### 18.4.4 Contain
- **권한서버에서 TTL 조정**(긴 → 짧음, ex. 60s~300s) 및 **즉시 변경 발표**.
- 문제 리졸버를 **지정 우회**하여 단기 정상 운영(앱/프록시에서 `--resolve`/`upstream DNS` 임시 변경).
- **UDP 실패 시 TCP 허용** 정책 확인(FW).

### 18.4.5 Fix
- 배포 프로세스: **T-24h TTL 단계적 감소 → 변경 → 안정 후 TTL 복귀**.
- **헬스 기반 GSLB** 또는 **CDN 매핑** 사용(레코드가 아픈 리전을 빼도록).
- **권한/보조 네임서버 동기** 체크(Serial/NOTIFY/AXFR).
- **DNSSEC** 사용 시 **서명/체인 유효성**/만료 관리 자동화.
- **EDNS size** 보수적(1232~1280) 권장, **TC=1** TCP 폴백 확인.

### 18.4.6 Prevent
- 모니터링: **쿼리 시간**, 응답 코드 비율(SERVFAIL/NX), 권한서버 오류율.
- **캐시 플러시 런북**(OS/브라우저/리졸버/업체).

---

## 18.5 케이스 #5 — CGNAT 뒤 P2P/원격 접속 문제 (⚙️)

### 18.5.1 현상
- 집/모바일 망에서 **P2P 연결 실패**, 게임 **NAT Type Strict/Moderate**.
- 사무실 PC에 **직접 접속(인바운드) 불가**. 포트포워딩이 라우터에서는 먹는데 **여전히 실패**.

### 18.5.2 배경
- ISP/모바일의 **CGNAT**(NAT444/LSN)로 **공인 IP 공유**.
- **대칭(symmetric) NAT** 빈번 → **UDP 홀펀칭 실패**. 인바운드 포트 매핑 **불가**.

### 18.5.3 가설
- 외부에서 **직접 도달 불가**. P2P는 **STUN**으로 공인 엔드포인트 추정하나, 대칭 NAT로 **양방향 매핑 불일치**.

### 18.5.4 Contain(실용 대안)
1) **릴레이/역터널** 사용
   - **TURN**(미디어 릴레이) 또는 **중계 서버**를 통해 전달.
   - **SSH 역포워딩**(R Port)로 외부 VPS→내부 포트 거꾸로 연결:
```bash
# 내부(사무실) → 외부(VPS)로 역터널
ssh -N -R 0.0.0.0:2222:localhost:22 user@vps.example.com
# 외부에서: ssh -p 2222 user@vps.example.com  # (VPS 방화벽 허용)
```
2) **메시 VPN/오버레이**(예: WireGuard 기반)
```ini
# (개념) wg0.conf 스니펫
[Interface]
PrivateKey = <host-priv>
Address    = 100.64.0.10/32
# CGNAT 환경 Keepalive 필수
# PersistentKeepalive = 25

[Peer]
PublicKey  = <vps-pub>
Endpoint   = vps.example.com:51820
AllowedIPs = 0.0.0.0/0, ::/0
PersistentKeepalive = 25
```
3) **IPv6 사용**
- ISP가 **네이티브 IPv6** 제공 시 **인바운드 가능**(보안그룹/방화벽 필수).

### 18.5.5 Fix
- 서비스 측: **ICE(STUN/TURN) 자동화**, **QUIC/UDP** 우선, 실패 시 **TCP 릴레이** 폴백.
- 원격접속: **클라우드 릴레이/역터널 표준화**(인증/감사 포함), **고정 공인 IP 상품** 검토.

### 18.5.6 Prevent
- 사용 설명서에 **NAT 제약/대안** 명시(IPv6, 릴레이, 역터널).
- 앱은 **NAT 타입 감지** 후 **자동 전략 선택**(P2P→릴레이 전환).

---

## 18.6 공통 런북 서식(복붙용)

### 18.6.1 사건 카드
```
[요약] 무엇이/언제/얼마나 영향?
[현상] 지표/로그/샘플(PCAP/스크린샷)
[가설] 1, 2, 3 (우선순위)
[검증] 명령/도구/성공-실패 기준
[대응] 즉시 완화(롤백/룰/스케일/차단)
[원인] 근본 원인과 증거
[교훈] 재발 방지(코드/설정/프로세스/모니터링)
```

### 18.6.2 빠른 진단 명령 묶음
```bash
# 네트워크 타임라인
curl -sS -o /dev/null -w 'dns:%{time_namelookup} conn:%{time_connect} tls:%{time_appconnect} ttfb:%{time_starttransfer} total:%{time_total} proto:%{http_version}\n' https://host

# MTU/경로
tracepath host; ping -M do -s 1472 host

# TCP 상태
ss -s; ss -tin '( sport = :443 or dport = :443 )'

# DNS
dig +trace www.example.com; dig @1.1.1.1 www A +stats

# 캡처(안전)
tcpdump -i any -s 128 -B 4096 -w diag.pcap 'host host and (tcp port 443 or icmp)'
```

---

## 18.7 “원인별 냄새표(스멜 시트)”

| 냄새 | 의심 | 확인 |
|---|---|---|
| 큰 응답만 실패 | MTU/PMTUD | DF ping, ICMP PTB, MSS clamp |
| SYN_RECV 폭증 | SYN Flood | ss -ant, netstat -s, SYN cookies/queue |
| 접속 느림, TTFB前 | 연결/핸드셰이크 | curl 타이밍, TLS 핸드셰이크 시간 |
| 다운로드 중 지연↑ | 혼잡/버퍼블로트 | flent rrul, fq_codel/ECN |
| 5xx 간헐 | 특정 인스턴스/리전 | Outlier ejection, 지역 지표 |
| 일부만 안 붙음 | DNS/TTL/캐시 | dig +trace, 리졸버별 비교 |
| P2P/원격 실패 | CGNAT/대칭NAT | STUN 타입, TURN/역터널 대체 |

---

## 18.8 체크리스트(요약 카드)

**SYN Flood**
- [ ] `tcp_syncookies=1`, `tcp_max_syn_backlog` 상향, `somaxconn` 상향
- [ ] SYNPROXY/Rate limit, Anycast/스크러빙, RHI/Flowspec
- [ ] 수락 큐/드롭 지표 경보

**PMTUD 블랙홀**
- [ ] ICMP PTB 허용, `tcp_mtu_probing=1`
- [ ] MSS 클램핑(경계), CNI/오버레이 MTU 일치
- [ ] 배포 전 경로 MTU 테스트 자동화

**TIME_WAIT 폭증**
- [ ] 업스트림 Keep-Alive/풀, H2/H3 멀티플렉싱
- [ ] `ulimit -n`, 포트 범위 확장, 재사용 전략(클라)
- [ ] TIME_WAIT/FD/풀 히트율 모니터

**DNS/TTL**
- [ ] T-24h TTL 낮추기 → 변경 → TTL 복귀
- [ ] GSLB 헬스 연동, 권한/보조 동기, EDNS 사이즈 관리
- [ ] 리졸버/지역별 쿼리 시간 모니터

**CGNAT**
- [ ] STUN/TURN/ICE 자동화, 릴레이/역터널 가이드
- [ ] IPv6 우선(보안그룹 동반), Keepalive(UDP 15–30s)
- [ ] NAT 타입 진단/폴백 로직

---

## 18.9 부록 — 구성 스니펫 모음

### 18.9.1 HAProxy SYN Proxy(개념적 대체)
```haproxy
global
  nbthread 4
  maxconn 200000

defaults
  mode tcp
  timeout client  30s
  timeout server  30s
  timeout connect 3s

frontend ft
  bind :443
  tcp-request inspect-delay 2s
  tcp-request connection accept if { req_len 0 }   # 초간단 핸드셰이크 필터
  default_backend bk

backend bk
  balance leastconn
  server s1 10.0.1.10:443 check
  server s2 10.0.1.11:443 check
```

### 18.9.2 NGINX 업스트림 Keep-Alive
```nginx
upstream app {
  keepalive 512;
  server 10.0.2.10:8080 max_fails=3 fail_timeout=10s;
  server 10.0.2.11:8080;
}
server {
  listen 443 ssl http2;
  location / {
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_read_timeout 60s;
    proxy_pass http://app;
  }
}
```

### 18.9.3 MSS 클램핑(고정)
```bash
iptables -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN \
  -j TCPMSS --set-mss 1360
```

### 18.9.4 dig 비교 예
```bash
dig www.example.com A +stats
dig @1.1.1.1 www.example.com A +stats
dig +trace www.example.com
```

### 18.9.5 SSH 역포워딩
```bash
ssh -N -R 0.0.0.0:8443:localhost:8443 user@vps.example.com
```

---

## 18.10 한 장 요약(포스터)
- **SYN Flood**는 **L4에서 막고**(cookies/SYNPROXY/스크러빙), **큐 지표**를 본다.
- **PMTUD 블랙홀**은 **DF ping/tracepath**로 드러난다—**ICMP PTB & MSS Clamp**.
- **TIME_WAIT 폭증**은 **풀/Keep-Alive/H2/H3**로 해결한다; 무리한 커널 트릭은 금물.
- **DNS 장애**는 **TTL/캐시/권한 동기**의 문제—배포 절차에 **TTL 램프 다운/업**을 넣어라.
- **CGNAT** 뒤 인바운드는 기본적으로 막힌다—**TURN/역터널/IPv6**이 답이다.
