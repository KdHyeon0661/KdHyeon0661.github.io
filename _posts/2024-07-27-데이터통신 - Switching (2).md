---
layout: post
title: 데이터 통신 - Switching (2)
date: 2024-07-27 15:20:23 +0900
category: DataCommunication
---
# Packet Switching & 8.4 Structure of a Switch — Datagram/VC 네트워크와 회선/패킷 스위치 구조(최신 확장 정리)

> 형식 규칙: 본문은 `~~~markdown`, **코드는 넣지 않는다**, 모든 수식은 $$…$$, 표·ASCII 다이어그램을 적극 사용한다.
> 목표: **8.3 packet switching**(datagram networks, virtual-circuit networks)와 **8.4 structure of a switch**(structure of circuit switches, structure of packet switches)를 *생략 없이* 이론 중심으로 체계화한다. 최신 경향(데이터센터 스위치, ECN/AQM, VOQ, iSLIP/DRR, 멀티스테이지 패브릭: **Banyan, Omega, Butterfly, Benes, Clos, Fat-Tree**)까지 반영한다.

---

## 준비: 패킷 스위칭에서의 지연·대역폭·버퍼

총 지연 분해:
\[
D_{\text{total}} = D_{\text{proc}} + D_{\text{queue}} + D_{\text{trans}} + D_{\text{prop}}
\]
- \(D_{\text{proc}}\): 포트 파싱/룰 룩업/스케줄링
- \(D_{\text{queue}}\): 큐잉 지연(혼잡의 핵심 지표)
- \(D_{\text{trans}}=\frac{L}{R}\): 길이 \(L\) (bit) 패킷을 \(R\) (bps) 링크에 직렬화하는 시간
- \(D_{\text{prop}}=\frac{d}{s}\): 거리 \(d\), 전파속도 \(s\)로 인한 전파 지연

대역폭–지연 곱(BDP):
\[
\text{BDP} = R \times \text{RTT}
\]
파이프를 가득 채우기 위해 필요한 **in-flight 데이터량**으로, 윈도우/버퍼 설계의 1차 기준이 된다.

간단 대기행렬 근사(M/M/1):
\[
\rho = \frac{\lambda}{\mu},\qquad W_q=\frac{\rho}{\mu(1-\rho)},\qquad W=\frac{1}{\mu-\lambda}
\]
여기서 \(\lambda\): 평균 도착율, \(\mu\): 평균 서비스율, \(W_q\): 평균 대기, \(W\): 평균 체류시간.

---

## Packet Switching

### Datagram Networks

**정의**
- 데이터그램 네트워크는 **사전 연결 설정 없이**, 각 패킷이 **완전한 목적지 주소**(필요시 소스/흐름 힌트 포함)로 독립 라우팅된다.
- IP 네트워크(IPv4/IPv6)가 전형적 사례. “베스트-에포트” 전달이 기본 전제다.

**특징**
- **상태 최소화**: 중간 장비는 네트워크-가중치 상태(라우팅 테이블/FIB, ECMP 경로)만 유지. 플로우별 per-hop 상태는 보통 없다.
- **경로 가변성**: 부하 분산(ECMP)과 라우팅 수렴에 따라 *패킷별* 경로가 달라질 수 있다.
- **확장성·탄력성**: 링크/노드 장애 시 라우팅 재수렴으로 우회. 거대 스케일에서 관리 난이도가 상대적으로 낮다.

**장점/단점 요약**

| 항목 | 장점 | 단점 |
|---|---|---|
| 제어면 | 연결 설정 불요 → 단순·확장 | 경로·지연의 비결정성 |
| 데이터면 | 주소룩업 기반 포워딩 | 순서보장 없음(상위 계층 처리) |
| QoS | DiffServ, AQM/ECN으로 통계적 품질 | 엄격 보장형 QoS는 어려움 |

**실전 포인트**
- **DiffServ(DSCP)**, **AQM(RED/PIE/CoDel)**, **ECN** 조합으로 지연/손실을 관리.
- **플로우 해시** 기반 ECMP는 *리-오더링 최소화*를 위해 패킷이 아닌 플로우 단위로 경로를 고정한다.

---

### Networks

**정의**
- 전송 전 **경로(가상회선; VC)** 를 **시그널링**으로 설정하고, 각 스위치/라우터가 **라벨/VCID** 상태를 저장하여 **라벨 스와핑**으로 포워딩한다.
- ATM(셀 기반), Frame-Relay, MPLS(라벨 기반) 등이 대표적이다.

**특징**
- **사전 자원 할당 가능**: 대역·버퍼·스케줄링을 연결 설정 시 협상/예약 → **지연·손실 예측성** 향상.
- **빠른 포워딩**: 주소 LPM 대신 **고정폭 라벨 룩업**(TCAM/정적 테이블).
- **제어면 복잡성**: LDP/RSVP-TE 같은 프로토콜 및 **상태 폭증** 관리 필요.

**장점/단점 요약**

| 항목 | 장점 | 단점 |
|---|---|---|
| 성능 | TE/QoS 보장, FRR 등 빠른 우회 | 상태 관리 오버헤드 |
| 제어 | 경로 제약(장애영역 회피, 비용 최소) 표현 | 연결 설정 지연·복구 절차 필요 |
| 구현 | 라벨 스택으로 헤더 경량화 | 대규모 플로우 환경서 스케일링 이슈 |

**실전 포인트**
- **MPLS-TE**: 명시 경로/대역 제약/링크 속성 기반의 **트래픽 엔지니어링**.
- **FRR(Fast Reroute)**: 장애 시 서브-50ms 수준의 국소 우회 경로 적용.
- **SR-MPLS/SRv6**: **세그먼트 라우팅**으로 제어면 단순화(라벨 스택/IPv6 헤더에 경로를 인코딩).

---

### Datagram vs VC — 심층 비교

| 관점 | Datagram | Virtual-Circuit |
|---|---|---|
| 장애복원 | 라우팅 수렴 의존(밀리초~수초) | FRR·사전 보호경로로 서브-50ms 가능 |
| 지터/지연 | 부하·경로 가변 → 예측성 낮음 | 자원 예약으로 예측성 높임 |
| 확장성 | 초대규모 공중망에 최적 | 도메인 내부/사업자 코어 TE용 |
| 운영 | 단순(상태 적음) | 복잡(상태/시그널링) |
| 대표 | 공용 인터넷 | 사업자 코어, 전용/미션크리티컬 |

---

## Structure of a Switch

현대 스위치/라우터는 공통적으로 **(i) 포트(입/출), (ii) 스위치 패브릭, (iii) 큐·스케줄러, (iv) 제어면**으로 구성된다.

고전적 분해(데이터면 파이프라인):

```
Ingress Port: PHY → MAC → Parser → Match/Action(TCAM/ALU)
             → Policer/Meter/Mark(DSCP/ECN) → (VOQ/Ingress Queue)
Switch Fabric: Crossbar / Multistage(Clos, Benes, Banyan 등)
Egress Port:  Shaper → Scheduler(SP/WRR/DRR/WFQ) → MAC → PHY
```

---

### Structure of Circuit Switches

#### 자원 할당 방식: TDM/FDM/WDM

- **TDM**: 주기를 시간슬롯으로 분할하여 회선 단위로 **고정 슬롯** 배정. 지연·지터가 매우 낮지만 **유휴 슬롯 낭비** 가능.
- **FDM/WDM**: 주파수/파장 자원을 전용 할당(광 회선).

#### 공간 분할 스위칭: Crossbar, Clos, Benes

- **Crossbar (N×N)**
  - 모든 입력–출력 쌍에 스위치 포인트. 이론상 **비블로킹**이나, 포인트 수가 \(O(N^2)\)로 **면적·전력** 증가.
- **Clos 3-Stage \(C(m,n,r)\)**
  - 1/3단에 \(r\)개의 \(n\times m\) 스위치, 중앙에 \(m\)개의 \(r\times r\) 스위치.
  - **엄밀 비블로킹** 조건(전통적 결과의 한 형태): \(m \ge 2n-1\).
  - 구현상 **구성 비블로킹/재배치 비블로킹**으로 운용(중앙 선택 정책 필요).
- **Benes (2·log\(_2\)N−1 단계)**
  - Clos의 특수형. **재배치 비블로킹**: 이미 설정된 연결을 재배치하면 항상 새로운 연결을 수용 가능.
  - 스테이지 수가 \(O(\log N)\), 전체 스위칭 소자 수가 \(O(N \log N)\).

**요약 표 — 회선 스위치 구조**

| 구조 | 비블로킹 성질 | 복잡도(스위치 소자 수) | 장점 | 단점 |
|---|---|---|---|---|
| Crossbar | 엄밀 비블로킹 | \(O(N^2)\) | 단순, 지연 최소 | 대규모 비경제적 |
| Clos | (조건부) 엄밀/구성/재배치 비블로킹 | \(O(N \log N)\) | 확장성, 모듈화 | 제어 복잡 |
| Benes | 재배치 비블로킹 | \(O(N \log N)\) | 경로 존재 보장 | 재배치 필요 |

> 회선 스위치는 **버퍼링을 거의 요구하지 않으며**, **슬롯/경로 예약** 자체가 품질을 규정한다.

---

### Structure of Packet Switches

패킷 스위치는 **버퍼·스케줄링·패브릭**이 성능을 좌우한다.

#### 큐 배치: 입력/출력/공유/VOQ

- **입력 큐(공동 큐)**: 간단하지만 **HOL(Head-of-Line) 블로킹**으로 포화 처리율이 제한(균등 트래픽에서 약 0.586 근방).
- **출력 큐**: 이상적이지만 출력 포트 속도를 초과하는 내부 **스피드업** 필요.
- **공유 메모리**: 모든 포트가 공용 고속 메모리 접근(소형/저속에 적합).
- **VOQ (Virtual Output Queuing)**: 입력 포트 내 **출력별 가상 큐**로 HOL 제거 → 고처리율 달성의 사실상 표준.

#### 스케줄링: 최대 매칭과 근사

- **iSLIP (Request–Grant–Accept, 라운드로빈 포인터 회전)**: 고속·간단, 장기 공정성.
- **PIM/Maximal Matching**: 근사 최대 매칭 반복으로 높은 처리율.
- **출력 스케줄러**: SP(Strict Priority), WRR/DRR(가중치 라운드로빈), WFQ/PGPS(이상적 GP S 근사).
- **계층형 스케줄링(HTS/HQOS)**: 포트→큐그룹→큐로 다단 형태, SLA/트래픽 클래스 분리.

#### AQM & ECN

- **DropTail**: 단순하나 버퍼블로트 위험.
- **RED/PIE/CoDel**: 평균/PI 제어/지연지표 기반의 **조기 신호**로 혼잡 전개 억제.
- **ECN**: 드롭 대신 **마킹**으로 혼잡 신호 전달(송신측 혼잡윈도우 조정).

#### Store-and-Forward vs Cut-Through

- **Store-and-Forward**: 패킷 전체 수신 후 전달(오류차단 유리, 직렬화 지연 포함).
- **Cut-Through**: 헤더만 보고 즉시 전달(지연↓). 오류 프레임 전파 가능성, CRC-반응 정책 필요.

#### 내부 속도 증폭(스피드업)

- 이상적 **출력 큐 스위치**를 에뮬레이트하려면 **내부 속도**가 라인 속도보다 커야 한다.
- 알려진 결과들(조건·가정에 따라 상수 달라짐)이 제시하듯, **VOQ+적절한 스케줄링+완만한 스피드업(S≈2)** 로 실용적 근사가 가능하다.

---

### 8.4.2-α Multistage Packet Fabrics — **Banyan & Friends** *(요청 보강)*

멀티스테이지 상호연결 네트워크(MIN)는 **규모 확장과 하드웨어 경제성**을 위해 크로스바를 **다수의 작은 스위치**로 분해하고 **여러 단계**로 연결한다.

#### Banyan Network (자기라우팅, Blocking)

- **자기라우팅(self-routing)**: 목적지 주소의 비트(예: 가장 상위→하위)를 **스테이지별 분기**로 사용.
- **구성**: \( \log_2 N \) 스테이지, 각 스테이지는 2×2 스위치 \(N/2\)개. 전체 복잡도는 \(O(N \log N)\).
- **Blocking**: 동일 출력으로 수렴하는 경로 충돌이 가능 → 단일 Banyan은 **Blocking**.

대표 배리언트: **Omega**, **Baseline**, **Generalized Banyan** (배선 패턴만 다를 뿐 자기라우팅 속성은 동일).

ASCII(8포트 Omega 예시 개념):
```
In0 ─┐     ┌─┐     ┌─┐     ┌─┐    ┌─ Out0
In1 ─┼─> [  ]─>  [  ]─>  [  ] ──┼──┤
In2 ─┼─> [  ]─>  [  ]─>  [  ] ──┼──┤
In3 ─┘     └─┘     └─┘     └─┘    └─ Out7
(각 스테이지 2×2 스위치, 배선은 “셔플-익스체인지-셔플” 형태)
```

**장점**: 모듈화·확장성, 단순한 포워딩 결정(헤더 비트만 판독).
**단점**: Blocking. 단일 평면으로는 임의 트래픽에서 손실·지연 증가.

#### 다중 Banyan(병렬 평면) & 랜덤화

- **다중 평면(parallel banyans)** 과 **해시/랜덤 분산**으로 충돌 확률을 낮추고 처리율을 높인다.
- 입력에서 평면을 선택하는 간단한 해시(플로우 기반)로 **재정렬을 최소화**한다.

#### Butterfly/Baseline/Omega

- 모두 **Banyan 계열**: 배선 패턴(셔플/디셔플/퍼뮤테이션)이 다를 뿐, **스테이지 수는 \(\log_2 N\)**, 각 스테이지 2×2.
- **Butterfly**: 이론·알고리즘 분야에서 널리 쓰이는 정규화된 구조.
- 공통 속성: **자기라우팅**, **Blocking**, **저복잡도**.

#### Benes Network (Rearrangeably Nonblocking)

- \(2\log_2 N - 1\) 스테이지, 전/후반이 **Butterfly의 역상**으로 구성.
- **재배치 비블로킹**: 기존 연결 재배치(라우팅)로 항상 새로운 연결 수용 가능.
- 패킷 스위치에서 **버퍼드-벤스**(스테이지별 큐)를 두고 **랜덤/분산 라우팅**을 적용하면 높은 처리율에 근접.

#### Clos-형 패브릭(패킷)

- **3-스테이지 Clos** 패브릭을 패킷 스위치에 적용: 라인카드(입/출)–중앙 스위치–라인카드.
- 각 스테이지에 **버퍼/VOQ** 와 **스케줄링**을 결합하면 Blocking을 실용적으로 제거.
- 대규모 스위치(스파인–리프 토폴로지)에서 사실상의 표준.

#### Fat-Tree (멀티루트 Clos의 토폴로지 표현)

- 트리의 상위로 갈수록 링크/스위치 용량(‘fat’)이 증가하도록 설계 → **균형 대역** 보장.
- ECMP로 **다중 경로 분산**, 데이터센터에서 널리 채택.

**멀티스테이지 비교 요약**

| 구조 | 성질 | 스테이지 수 | Blocking | 용도 |
|---|---|---:|---|---|
| Banyan/Omega/Baseline | 자기라우팅, 저복잡 | \(\log_2 N\) | 있음 | 소형/학습·특화 |
| 다중 Banyan | 병렬 평면+랜덤화 | \(\log_2 N\) | 완화 | 중형, 비용 절감 |
| Benes | 재배치 비블로킹 | \(2\log_2 N - 1\) | 없음(재배치) | 고성능 패킷/회선 |
| Clos | (조건부) 비블로킹 | 3(일반화 가능) | 없음(조건 충족 시) | 대규모 코어/스파인 |
| Fat-Tree | Clos 토폴로지화 | 다단 | 멀티패스 | DC 스케일-아웃 |

---

### 8.4.2-β HOL 블로킹과 VOQ, 스피드업

- **HOL 블로킹**(입력 공동 큐): 균등 무작위 도착 트래픽에서 **포화 처리율 ≈ 0.586**.
- **VOQ**: 입력 포트 내에 출력별 가상 큐를 둬 **상호 독립 매칭** 가능 → 고처리율(이론적 100% 근접).
- **스피드업**: 내부 패브릭이 라인 속도보다 빠르게 동작하도록 설계하여 **출력 큐 동작 근사**. 실무에서는 **S≈2 전후**를 사용(구현/전력/열을 고려한 절충).

---

### 8.4.2-γ 큐 관리·스케줄링 이론 항목(핵심 수식)

- **가중치 공정 공유(WFQ)** 의 이상적 모델 GPS에 대한 근사: 플로우 \(i\)의 장기 처리율은 가중치 비율에 수렴.
- **지연 바운드**(단순 모델):
  \[
  D_i \le \frac{\sigma_i}{C\cdot \phi_i} + \frac{L_{\max}}{C}
  \]
  \(\sigma_i\): 버스트 한도(토큰버킷), \(C\): 링크 용량, \(\phi_i\): 가중치 몫, \(L_{\max}\): 최대 패킷 길이.
- **AQM 목표**: 평균 큐 길이/지연을 일정 범위로 유지 → **지터 억제**, **대역 공유의 안정화**.

---

## 설계 시나리오(코드 없이 계산·절차 중심)

### 시나리오 A — 코어 스위치 패브릭 선택

**요구**: 256×100 GbE 포트, 무손실 지향 아님, 지연 민감 Mixed 트래픽.
**대안**
1) **단일 크로스바**: \(O(N^2)\) 복잡도·전력 부담 커짐.
2) **3-Stage Clos + VOQ + iSLIP/DRR**: 모듈화·확장성·가격 유리.
3) **Benes(버퍼드)**: 재배치 제어 복잡성 증가(소프트웨어 스케줄러 필요).

**선정**: **Clos**. 중앙 스위치 수 \(m\)과 각 스테이지 포트 수 \(n\)을 정하고, 내부 링크는 **라인속도×S** (S≈2)로 설계. **VOQ** 필수, 출력 스케줄러는 **SP(제어 트래픽 상단)** + **DRR/WFQ** 혼합.

### 시나리오 B — 멀티스테이지(Banyan 병렬)로 비용 절감

**요구**: 64포트 중형 스위치, 저전력·저비용 우선, 가벼운 혼잡.
**대안**: **2~4 평면의 Banyan** 을 병렬로 두고, 입력에서 **플로우 해시**로 평면 선택.
**주의**: 단일 평면 Blocking은 남음 → 병렬화로 충돌 확률을 낮춤. 재정렬 위험은 플로우 단위 고정으로 억제.

### 시나리오 C — 데이터그램 vs VC

- **인터넷 에지/코어**: **Datagram** + DiffServ/AQM/ECN.
- **사업자 TE/전용선/보장형 서비스**: **VC(MPLS-TE/SR)** + FRR, SLA 가시성.
- **데이터센터 스파인–리프**: **IP ECMP + VOQ**(필요 시 **SR-MPLS/SRv6**로 경로 선언).

---

## 표와 다이어그램 요약

**표 1 — Datagram vs VC**

| 항목 | Datagram | VC |
|---|---|---|
| 연결 | 설정 없음 | 시그널링 필요 |
| 상태 | FIB 중심 | per-VC 상태 |
| QoS | 통계적, 클래스 기반 | 보장형 가능 |
| 장애 | 수렴 | FRR·보호경로 |
| 스케일 | 초대규모 | 도메인 내부 TE |

**표 2 — 스위치 구조**

| 구조 | 버퍼 | 스케줄링 | 비블로킹 성질 | 스케일/비용 |
|---|---|---|---|---|
| Crossbar | 옵션 | 간단 | 엄밀 비블로킹 | \(O(N^2)\) |
| Clos | 일반 | 필요 | 조건부 비블로킹 | \(O(N\log N)\) |
| Benes | 선택 | 필요 | 재배치 비블로킹 | \(O(N\log N)\) |
| Banyan계 | 선택 | 필요 | Blocking | \(O(N\log N)\) |

**ASCII — VOQ 개념**

```
Ingress Port k
 ├─ VOQ[k→0]: [..]
 ├─ VOQ[k→1]: [....]
 ├─ ...
 └─ VOQ[k→N-1]: [.]

Scheduler (iSLIP/Maximal Matching) → Crossbar/Clos Fabric → Egress
```

---

## 체크리스트 (설계/운영)

1) **VOQ 필수화**: HOL 블로킹 제거가 최우선.
2) **스케줄링**: iSLIP(핵심 경량), DRR/WFQ(클래스 보장), SP(제어 트래픽 보호).
3) **AQM/ECN**: 지연 억제와 공정한 혼잡 신호.
4) **멀티스테이지 선택**:
   - **Clos/Fat-Tree**: 대규모 고집적.
   - **Benes**: 재배치 허용 시 이론적으로 강력.
   - **Banyan 병렬**: 저비용-중성능 절충.
5) **스피드업**: 내부 왕복 경합을 흡수(S≈2 전후).
6) **Datagram vs VC**: 공중망/대규모는 Datagram, TE/QoS 보장은 VC.
7) **보전성**: 장애·업그레이드 시 **경로 다양성/여분 평면**으로 서비스 연속성 확보.

---

## 핵심 공식 모음

- 총 지연: \(D_{\text{total}} = D_{\text{proc}} + D_{\text{queue}} + D_{\text{trans}} + D_{\text{prop}}\)
- 직렬화 지연: \(D_{\text{trans}} = \frac{L}{R}\)
- 전파 지연: \(D_{\text{prop}} = \frac{d}{s}\)
- BDP: \(\text{BDP} = R \cdot \text{RTT}\)
- M/M/1 평균 대기: \(W_q=\frac{\rho}{\mu(1-\rho)}\), 평균 체류: \(W=\frac{1}{\mu-\lambda}\)
- HOL 한계(입력 공동 큐, 균등 트래픽): 처리율 \(\approx 0.586\)
- 토큰버킷 서비스 지연 상계(단순형): \(D_i \le \frac{\sigma_i}{C\phi_i} + \frac{L_{\max}}{C}\)

---

## 결론

- **Datagram**은 확장성과 탄력성, **VC**는 예측성과 TE.
- 대형 스위치의 현실적 답은 **멀티스테이지 패브릭 + VOQ + 고속 매칭(iSLIP/Maximal) + 적정 스피드업 + AQM/ECN**.
- **Banyan**은 자기라우팅과 저복잡도의 미덕이 있으나 **단일 평면은 Blocking** → **병렬화/무작위화**나 **Benes/Clos**로 보완.
- 최종 선택은 **트래픽 특성(버스트/지연 민감도)**, **SLA**, **전력/열/면적/비용** 제약의 균형에서 결정된다.
