---
layout: post
title: 확률과 통계 - 선형회귀
date: 2025-09-19 23:25:23 +0900
category: 확률과 통계
---
# 9. 선형회귀

> **목표**  
> - **단순/다중회귀**를 한 번에 정리하고, **가정·잔차진단**을 실무 문장으로 번역한다.  
> - **다중공선성** 진단(**VIF**)과 **상호작용항** 해석을 확실히 잡는다.  
> - **로그-링크**(로그변환 vs GLM 로그링크)의 차이와 해석을 구분한다.  
> - **과적합 vs 설명가능성**의 트레이드오프를 지표로 의사결정한다.

---

## 0. Hook — “선형이지만, 제품 질문에 충분히 선명하다”
- **ARPU(사용자당 평균 수익)** 같은 지표는 **양수·비대칭(heavy-tail)**인 경우가 많다.  
- 그럼에도 **선형회귀**는 “**선형-인-계수**”라는 단순함으로  
  - **효과크기(한 단위 증가의 변화량)**를 직관적으로 보여주고,  
  - **상호작용**으로 “상황에 따라 달라지는 효과”를 쉽게 모델링하며,  
  - **해석 가능한 기준선**(baseline)을 제공한다.  
- 단, **가정/잔차진단/강건화** 없이는 **오판**이 쉽다. 이 장에서 “**해석 가능한 선형**”을 **신뢰할 수 있게** 만들자.

---

## 1. 단순·다중 선형회귀: 정의와 해석

### 1.1 단순회귀(한 설명변수)
- $$Y = \beta_0 + \beta_1 X + \varepsilon,\qquad E[\varepsilon\mid X]=0$$  
- **OLS(최소제곱)** 추정량: 잔차제곱합 $$\sum (y_i-\beta_0-\beta_1 x_i)^2$$ 최소화.  
- **해석**: $$\beta_1$$ = “**X 한 단위**가 늘 때 **Y의 평균 변화량**”.

### 1.2 다중회귀(여러 설명변수)
- $$Y = \beta_0 + \beta_1 X_1 + \cdots + \beta_p X_p + \varepsilon$$  
- **행렬형**: $$\hat\beta=(X^\top X)^{-1}X^\top y$$  
- **부분효과 해석**: $$\beta_j$$는 “**다른 변수들을 고정**했을 때 **X_j**의 **변화량 1**에 따른 **Y 평균 변화량**”.

> **실무 팁**: ARPU 같이 **스케일이 큰 지표**는 **표준화**(z-score)나 **단위 스케일링**(예: 분당, 천 원 단위)로 **계수 해석**을 쉬게 만들자.

---

## 2. 가정과 잔차진단(“그래프 + 간단 테스트”로 빠르게)

### 2.1 핵심 가정
1) **선형성**: $$E[Y\mid X]$$가 설명변수들의 **선형결합**.  
2) **독립성**: 잔차 $$\varepsilon_i$$들 **상호독립**(시계열/군집이면 위배).  
3) **등분산성**: $$\mathrm{Var}(\varepsilon\mid X)=\sigma^2$$(스케일 변화 없음).  
4) **정규성**(추론 목적): $$\varepsilon\mid X$$가 정규(큰 표본이면 근사로 완화).

### 2.2 잔차진단 체크리스트
- **잔차 vs 적합값**: 패턴(곡선·부채꼴)이 보이면 **비선형/이분산** 신호.  
- **정규 QQ-플롯**: 꼬리에서 크게 휘면 **heavy-tail**(신뢰구간/검정에 영향).  
- **스케일-로케이션**: 잔차 절대값의 적합값 의존성 체크(이분산).  
- **레버리지·영향력**: **Cook’s D**, **Hat 값**으로 극단치/영향점 탐지.  
- **자기상관**(일·주 시계열): **Durbin–Watson** 또는 ACF로 확인(필요시 블록 처리/시계열 모형).

### 2.3 처방
- **비선형**: 로그/제곱근/스플라인로 **변환**(아래 §7).  
- **이분산**: **로그변환**, **강건 표준오차(HC/White)**, **가중최소제곱(WLS)**.  
- **정규성 약함**: **부트스트랩 CI**, 큰 표본의 **근사**에 기대되지만 보고에 주의.  
- **자기상관/군집**: **군집-강건 표준오차**(사용자·날짜 군집), **블록 부트스트랩**.

---

## 3. 다중공선성 진단 — **VIF**와 해석 안정성

### 3.1 VIF 정의
- $$\mathrm{VIF}_j=\frac{1}{1-R_j^2}$$, 여기서 $$R_j^2$$는 **X_j를 나머지 X로 회귀**했을 때의 결정계수.  
- **규칙**: $$\mathrm{VIF}>10$$(혹은 5)면 **강한 공선성** 의심.

### 3.2 공선성의 증상
- 계수의 **표준오차 팽창** → **p값 불안정**, 부호가 **데이터 분할마다 뒤집힘**.  
- **예측 성능**은 덜 망가지지만, **해석 가능성**이 떨어짐.

### 3.3 처방
- **센터링**(특히 **상호작용** 포함 시; 아래 §5)  
- **스케일링/표준화**(단위 차이 완화)  
- **특징 축소**: **주성분(PLS)**  
- **릴리지(Ridge)**: 공선성에 **강함**(해석은 약간 어려워짐)  
- **도메인 우선**: “같은 의미” 변수 중 하나를 **고정/삭제**.

---

## 4. 상호작용(Interaction) — “상황에 따라 달라지는 효과”

### 4.1 모형
- $$\text{ARPU}_i = \beta_0 + \beta_1 \,\text{Sessions}_i + \beta_2 \,\text{Time}_i + \beta_3 \,\text{Push}_i + \beta_4\,(\text{Sessions}_i\times \text{Push}_i) + \varepsilon_i$$  
  - **Push**: 이진(0/1, 노출 여부) 또는 **노출횟수**(연속).  
  - **상호작용항** $$\beta_4$$: **푸시가 있을 때 세션의 기울기 변화**.

### 4.2 해석(푸시=0,1)
- **푸시=0**일 때: $$E[\text{ARPU}\mid\text{Push}=0] = \beta_0 + \beta_1 \,\text{Sessions} + \beta_2 \,\text{Time}$$  
- **푸시=1**일 때: $$E[\text{ARPU}\mid\text{Push}=1] = (\beta_0+\beta_3) + (\beta_1+\beta_4)\,\text{Sessions} + \beta_2 \,\text{Time}$$  
  - 즉, **절편**이 $$\beta_3$$만큼, **Sessions의 기울기**가 $$\beta_4$$만큼 **증가**.

### 4.3 센터링의 이유
- $$\text{Sessions}^\star = \text{Sessions}-\overline{\text{Sessions}}$$  
- 센터링하면 **절편과 주효과**의 해석이 **평균적 상황**에서의 효과로 **안정**되고, **VIF**도 감소.

> **계층 원칙(Hierarchical principle)**: **상호작용**을 넣으면, **해당 주효과**들도 **함께** 포함해라(해석·추론 안정성).

---

## 5. 예시 데이터 설계와 단계별 적합

### 5.1 변수 설계(사용자 레벨)
- **ARPU**: 사용자 i의 기간별 매출(원). **양수·heavy-tail** 경향.  
- **Sessions**: 기간 내 세션 수(정수).  
- **Time**: 총 체류시간(분).  
- **Push**: 기간 중 푸시 알림 **노출 여부**(0/1) 또는 **노출 횟수**(정수).  
- (선택) **Country/Device**: 공변량(더미).

### 5.2 1단계: 베이스라인 (단순)
- $$\text{ARPU}=\beta_0+\beta_1\ \text{Sessions}+\varepsilon$$  
- **해석**: 세션 1 증가 시 ARPU 평균 **β₁ 원** 증가(다른 요인 무시).  
- **잔차진단**: ARPU가 heavy-tail이면 **이분산** 신호 강할 수 있음.

### 5.3 2단계: 다중
- $$\text{ARPU}=\beta_0+\beta_1\ \text{Sessions}+\beta_2\ \text{Time}+\beta_3\ \text{Push} + \varepsilon$$  
- **의미**: Time, Push를 **고정**한 상태에서 Sessions 효과.

### 5.4 3단계: 상호작용 포함
- $$\text{ARPU}=\beta_0+\beta_1 S^\star+\beta_2 T^\star+\beta_3 P+\beta_4 (S^\star \times P)+\varepsilon$$  
  - **센터링**: $$S^\star=S-\bar S,\ T^\star=T-\bar T$$  
- **해석**: **푸시가 있을 때 세션의 한계효과가 $$\beta_4$$만큼 달라진다**.  
- **테스트**: $$H_0:\beta_4=0$$ (상호작용 없음). **유의**면 “푸시에 따라 세션의 효율이 변한다”.

### 5.5 4단계: 대안 모형(로그/GLM)
- **로그변환 OLS**: $$\log(1+\text{ARPU})\sim S^\star+T^\star+P+S^\star\!\times\!P$$  
- **Gamma GLM(로그링크)**: $$E[\text{ARPU}\mid X]=\exp(\beta_0+\beta_1 S^\star+\cdots)$$  
  - **로그-링크 해석**: $$\beta_j$$는 **곱셈적 변화율**(1단위 증가당 **% 변화**)를 의미(§7).

---

## 6. 해석의 기술 — 절편, 계수, 표준화, 부분회귀

### 6.1 절편(β₀)
- 모든 설명변수가 0(또는 **센터링된 경우 평균 수준**)일 때의 **기준 ARPU**.  
- **센터링 없이** 해석하려면 0이 **의미 있는 지점**일 때만 직관적.

### 6.2 표준화 계수(β_std)
- 각 설명변수와 **Y**를 **z-score**로 표준화하면 **단위 영향력 비교 가능**.  
- $$\beta_j^{\text{std}}=\beta_j\cdot \frac{\sigma_{X_j}}{\sigma_Y}$$  
- **주문장**: “같은 1 표준편차 증가” 기준으로 **상대 중요도**를 비교해 보고서에 병기.

### 6.3 부분회귀/Added-Variable Plot
- X_j의 **순수 효과**(나머지 고정)를 그림으로 확인.  
- **잔차-대-잔차** 플롯: (Y를 다른 X로 회귀한 잔차) vs (X_j를 다른 X로 회귀한 잔차).

---

## 7. **로그-링크 해석**: 로그변환 vs GLM 로그링크

### 7.1 로그변환 OLS
- $$Z=\log(1+Y)$$ 로 **변환** 후 선형회귀: $$Z\sim X\beta$$  
- **해석**: $$\beta_j$$는 **로그척도에서의 변화량** → 원척도에서의 **근사 % 변화**는  
  $$\Delta Y/Y \approx \beta_j$$ (작은 변화 가정).  
- **역변환 바이어스**: $$E[Y]\neq \exp(E[\log(1+Y)])-1$$ → **스머드지 보정**나 **델타법**으로 보고(2편 참고).

### 7.2 GLM(감마/로그링크)
- $$E[Y\mid X]=\exp(X\beta)$$, 분산 $$\propto \mu^2$$(감마).  
- **해석**: $$\beta_j$$가 **곱셈 효과**. X가 1 증가하면 기대값이 **$$e^{\beta_j}$$배**.  
- **장점**: 양수·이분산(평균↑→분산↑) 데이터에 자연.  
- **주의**: **링크=로그**와 **변환=로그**는 **다르다**. 전자는 “기대값의 로그가 선형”, 후자는 “로그값 자체를 선형”.

> **실무 기준**:  
> - 해석의 간결함(“% 변화”)이 중요하고 **양수·이분산**이면 **GLM 로그링크**를 먼저 시도.  
> - 리포팅은 “**β=0.07 ⇒ 1단위 증가에 기대 ARPU가 ~7.25% 증가**(=e^0.07−1)”처럼 **% 변화**로 적는다.

---

## 8. 신뢰구간·가설검정·적합도

### 8.1 계수 추론
- OLS에서 $$\hat\beta\sim \mathcal{N}(\beta,\ \sigma^2(X^\top X)^{-1})$$(정규/큰 n).  
- **t-통계량**: $$t_j=\hat\beta_j/\mathrm{SE}(\hat\beta_j)$$  
- **95% CI**: $$\hat\beta_j\pm t_{0.975,\ \nu}\cdot \mathrm{SE}$$

### 8.2 모형 비교
- **F-검정**(중첩 모형): “상호작용항 추가가 유의한가?”  
- **AIC/BIC**: **일반화 가능성**과 **단순성**의 균형으로 모형 선택.  
- **Adjusted R²**: 설명변수 늘려도 무작정 오르지 않게 벌점.

### 8.3 예측 구간
- **개별 예측**은 평균 예측보다 불확실성 ↑. **Prediction Interval**을 구분해 리포트.

---

## 9. 과적합 vs 설명가능성 — 운영 지침

### 9.1 과적합 징후
- 학습 R²는 높은데 **검증/홀드아웃**에서 R²↓, 오차↑.  
- 상호작용·고차항·더미 과다.

### 9.2 진단·완화
- **K-겹 교차검증**으로 **일반화 성능** 추정.  
- **정규화(Ridge/Lasso/Elastic Net)**:  
  - **Ridge**: 공선성 완화, 해석은 덜 직관적(계수 축소).  
  - **Lasso**: **희소성**(변수 선택), 다만 **추론**은 조심(편향·선택불확실성).  
- **도메인 기반 축소**: KPI와 무관한 파생변수 삭제, **계층 원칙** 준수.  
- **간결성** 지표: 변수 수, AIC/BIC, 설명가능한 Story 유무.

> **보고 팁**: “**검증 R²와 CV-RMSE**”, “**변수 수(상호작용 포함)**”, “**선택 이유**”를 항상 함께 제시.

---

## 10. 실무 예제 — 단계별 숫자 해석 (개념 수치)

### 10.1 가상의 적합 결과(센터링 OLS)
- $$\widehat{\text{ARPU}} = 1800 + 120\ S^\star + 8\ T^\star + 400\ P + 55\ (S^\star\!\times\!P)$$  
  (단위: 원; **S**=세션 수, **T**=체류시간(분), **P**=푸시(0/1))
- **해석**  
  - 평균 수준에서 **세션 1 증가** → **+120원**  
  - 평균 대비 **체류 1분 증가** → **+8원**  
  - **푸시 노출 사용자**는 **절편 +400원**  
  - **푸시×세션 상호작용 = +55원**: 푸시가 **있으면**, **세션 1 증가당 ARPU**가 **추가 +55원** (총 +175원/세션)

### 10.2 GLM(감마·로그링크) 개념 결과
- $$\log E[\text{ARPU}\mid X]=\beta_0 + 0.06\ S^\star + 0.01\ T^\star + 0.18\ P + 0.03\ (S^\star\!\times\!P)$$  
- **해석(곱셈)**  
  - **세션 1 증가**: 기대 ARPU **+6.18%**(=e^{0.06}-1)  
  - **푸시**: **+19.7%**  
  - **상호작용**: 푸시가 있을 때 **세션 효과가 추가 +3.0%p** → 총 **약 +9.3%/세션**

> **비즈니스 문장**: “푸시 노출군에서 **세션의 수익 기여도가 더 큼**(상호작용 **유의**). 푸시 전략은 **세션 증대 활동**과 결합할 때 **ARPU 상승**이 크다.”

---

## 11. 강건화(robustness) — “현실의 데이터는 교과서가 아니다”

### 11.1 이분산·heavy-tail
- **HC 표준오차(White/HC3)**로 **신뢰구간 보정**.  
- **로그/Box–Cox 변환**, **Gamma GLM** 시도.  
- **영향점**: Cook’s D 상위 몇 % 제거/조사 후 **민감도 분석**.

### 11.2 군집·반복노출
- 사용자/일 단위로 **군집-강건 SE**(cluster-robust).  
- **패널 회귀**(고정효과)로 **개인/일 효과** 제거.

### 11.3 누락변수·인과 해석 주의
- 회귀계수는 **상관적 해석**.  
- **누락변수 편향**(예: 구매성향) → 실험/IV/이중차분 등 별도 인과 설계 필요.

---

## 12. 코드 스니펫(개념): Python(statsmodels) 예시

```python
# 해석 중심 데모(실행용 아님; 실무에선 라이브러리 버전 확인)
import pandas as pd
import statsmodels.api as sm
import statsmodels.formula.api as smf

# df: ['ARPU','sessions','time','push'] (push=0/1)
df = df.dropna().copy()

# 센터링
for col in ['sessions','time']:
    df[col+'_c'] = df[col] - df[col].mean()

# --- OLS with interaction
model = smf.ols('ARPU ~ sessions_c + time_c + push + sessions_c:push', data=df).fit(cov_type='HC3')
print(model.summary())          # HC3: 이분산 강건 SE
print(sm.stats.outliers_influence.variance_inflation_factor(sm.add_constant(df[['sessions_c','time_c','push','sessions_c']]).values, i)
      for i in range(1,4))     # 대략적인 VIF(상호작용 VIF는 주의해서 산출)

# --- 로그변환 OLS
df['log1p_ARPU'] = np.log1p(df['ARPU'])
model_log = smf.ols('log1p_ARPU ~ sessions_c + time_c + push + sessions_c:push', data=df).fit(cov_type='HC3')

# --- Gamma GLM (log link)
glm_g = smf.glm('ARPU ~ sessions_c + time_c + push + sessions_c:push',
                data=df, family=sm.families.Gamma(sm.families.links.log())).fit()
print(glm_g.summary())

# --- 교차검증은 sklearn로 (예측지표), 추론은 statsmodels로
```

> **주의**: 상호작용 포함 시 **VIF 계산**은 “상호작용 포함한 디자인 행렬” 기준으로 하되, **센터링**으로 공선성 완화 후 해석.

---

## 13. 보고 템플릿(요약)

- **모형**: `ARPU ~ sessions_c + time_c + push + sessions_c:push` (HC3)  
- **적합도**: Train R²/Adj R², CV-RMSE, AIC/BIC.  
- **주효과**: `sessions_c` **+**, `time_c` **+**, `push` **+** (수치/CI 명시).  
- **상호작용**: `sessions_c:push` **유의(β>0)** → 푸시 노출 시 세션의 한계수익 증가.  
- **진단**: 잔차 패턴 무(완만한 이분산 → HC3), 영향점 상위 1% 검토 결과 동일 결론.  
- **대안**: Gamma GLM(log link)에서 **비슷한 방향·%해석**.  
- **주의**: 인과 해석 아님(누락변수 가능). **실험/오프라인 매칭**으로 재검증 권장.

---

## 14. 체크리스트 — 배포 전 마지막 점검 12문항
1) 변수 스케일/단위 통일(분↔초, 원↔천 원)  
2) 센터링 여부(상호작용 포함 시 필수)  
3) 잔차 vs 적합 그래프에서 패턴/부채꼴 유무  
4) QQ-플롯 꼬리 확인(heavy-tail이면 로버스트/GLM)  
5) Cook’s D 상위 점검 및 민감도 분석  
6) VIF(>5/10) 변수 조합 검토(의미 중복 제거/축소)  
7) Adjusted R², AIC/BIC, CV-RMSE 보고  
8) 계수에 **CI** 및 **효과크기(표준화/%)** 병기  
9) 상호작용 해석(조건부 기울기 문장) 포함  
10) 로그-링크/로그변환 구분해 리포트  
11) 과적합 방지 근거(교차검증, 간결성) 제시  
12) 인과 주장은 보류(실험/IV/DiD 예정 문구)

---

## 15. 미니 연습문제(정답 스케치)

**[1] 상호작용 해석**  
- $$\hat y=2000+100S+5T+300P+40(S\times P)$$(센터링 없음).  
- **질문**: P=1일 때 **S의 한계효과**? → **100+40=140/세션**. P=0일 때는 **100/세션**.

**[2] VIF 계산 직관**  
- `sessions ~ time + push` 회귀에서 $$R^2=0.84$$. `sessions`의 **VIF**? → **1/(1−0.84)=6.25** ⇒ 공선성 주의.

**[3] 로그링크 해석**  
- Gamma GLM에서 `β_sessions=0.05`. S가 1 늘면 **기대 ARPU**는? → **e^{0.05}−1 ≈ +5.13%**.

**[4] 이분산 대응**  
- 잔차가 적합값에 비례해 증가(부채꼴). 세 가지 대응? → **HC 표준오차**, **로그/Box–Cox 변환**, **WLS**.

---

## 16. TL;DR
- **선형회귀**는 **선형-인-계수**의 단순함으로 **해석가능성**이 뛰어나며,  
  **상호작용**으로 “조건에 따른 효과 변화”를 표현한다.  
- **잔차진단**(선형성·등분산·정규성·독립성)과 **VIF**로 **신뢰성**을 확보하라.  
- **로그-링크**: **로그변환 OLS** vs **GLM 로그링크**는 다르다. **% 해석**은 GLM이 깔끔.  
- **과적합 vs 설명가능성**: 교차검증·정규화·간결성으로 균형을 잡자.

---

## 수학 박스 C — 강건 분산: 샌드위치·클러스터·HAC
> **붙이는 위치 권장**: 9) 회귀, 10) ANOVA, 14) CUPED/ANCOVA 분석 섹션 말미

**M-추정량 일반형**  
$\hat\beta$가 점수합 $\sum_i \psi(W_i,\beta)=0$의 해이면, 약한 정규성 하
$$
\sqrt n(\hat\beta-\beta_0)\Rightarrow \mathcal N\big(0,\ A^{-1} B A^{-1}\big),
$$
여기서 $A=\mathbb E[\partial_\beta \psi]$, $B=\mathbb E[\psi\psi']$.

**이분산-강건(White, 샌드위치)**  
선형회귀 $Y=X\beta+u$에서
$$
\widehat{\mathrm{Var}}(\hat\beta)=(X'X)^{-1}\Big(\sum_i \hat u_i^2 x_i x_i'\Big)(X'X)^{-1}.
$$

**클러스터-강건(CRVE)**  
클러스터 $g=1,\dots,G$가 서로 독립(내부 상관 허용)일 때
$$
\widehat{\mathrm{Var}}(\hat\beta)=(X'X)^{-1}\Big(\sum_{g=1}^G X_g'\hat u_g \hat u_g' X_g\Big)(X'X)^{-1}.
$$
- 가정: $G\to\infty$ 점근. **소수 클러스터**는 CR2/CR3 또는 와일드부트스트랩 권장.

**HAC(Newey–West)**  
약한 의존(예: $\alpha$-mixing)과 유한 2차 모멘트 하에서
$$
\widehat{\mathrm{Var}}(\hat\beta)=(X'X)^{-1}\!\left(\sum_{k=-L}^{L} w_k \sum_{t} X_t' \hat u_t \hat u_{t-k} X_{t-k}\right)\!(X'X)^{-1},
$$
$w_k$는 커널가중(예: Bartlett), 대역 $L\to\infty$, $L/n\to 0$이면 일치.  
**용례**: 스위치백/시계열 실험의 자기상관 교정.
