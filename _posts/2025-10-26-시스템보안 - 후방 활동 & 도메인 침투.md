---
layout: post
title: 시스템보안 - 후방 활동 & 도메인 침투
date: 2025-10-26 18:30:23 +0900
category: 시스템보안
---
# 9. 후방 활동(Lateral Movement) & 도메인 침투

## 9.1 AD 기본기: 도메인/포리스트/트러스트

### 9.1.1 핵심 구성요소 큰 지도
- **포리스트(Forest)**
  AD의 최상위 보안 경계. **스키마·글로벌 카탈로그·포리스트 신뢰**를 공유.
  - 스키마 변경은 **포리스트 전체에 영향**. 변경 권한은 엄격히 통제.
- **도메인(Domain)**
  계정/정책의 기본 단위. **SID 네임스페이스**가 고유.
  - **도메인 기능 수준(DFL)**: 암호 알고리즘, Kerberos 기능 등.
- **사이트(Site)**
  물리 네트워크(서브넷) 기반 복제 토폴로지. **부하/대역폭**에 영향.
- **트러스트(Trust)**
  보안 경계 간 **인증 위임**. 트러스트 방향/유형/격리 수준이 중요.
- **OU / GPO**
  관리 위임·정책 적용 단위. **GPO 링크**가 권한 흐름에 직접 영향.
- **DC(도메인 컨트롤러)**
  Kerberos KDC, LDAP/GC, 복제(DFSR/NTDS) 핵심. **가장 민감한 자산**.

### 9.1.2 트러스트 유형(요약)
- **포리스트 트러스트(양방향, 트랜시티브)**: 포리스트 간 **보안 범위 확대**.
- **외부(External) 트러스트(비트랜시티브)**: NT4/별도 도메인과 1:1 연결.
- **리얼름(Realm) 트러스트**: Kerberos 기반 다른 디렉터리(예: MIT KDC).
- **단축(Shortcut) 트러스트**: 동일 포리스트 내 도메인 간 인증 지연 축소.

> 운영 포인트
> - 트러스트는 **최소화**. 불가피하면 **선택적 인증(Selective Auth)**, **SID 필터링** 활성화.
> - 트러스트 방향(인바운드/아웃바운드)을 **정확히 문서화**하고 정기 재검토.

### 9.1.3 계정·객체 속성에서 중요 포인트
- **SPN(ServicePrincipalName)**: 서비스 티켓 발급의 키. 잘못된 SPN/권한은 **권한 위임** 표면 확대.
- **Delegation**:
  - Unconstrained / Constrained / **Resource-based constrained delegation(RBCD)**
  - 불필요 위임은 제거. RBCD는 **소유자/ACL**까지 세밀히 점검.
- **AdminSDHolder / SDProp**:
  보호 그룹(Enterprise/Domain Admins 등) 구성원의 ACL을 **주기적으로 ‘고정’**.
  → **예외 위임**이 사라질 수 있으니 설계/감사 시 고려.
- **SIDHistory**: 마이그레이션 시 과거 SID를 보존. **오·악용 시 권한 상승 경로**가 됨.
  → 트러스트 경계에서 **SID 필터링 활성화**.

### 9.1.4 안전한 인벤토리/가시성 예제

#### (PowerShell) 포리스트/도메인/트러스트 현황 리포트(읽기 전용)
```powershell
Import-Module ActiveDirectory

# 포리스트/도메인 요약
$forest = Get-ADForest
$domains = $forest.Domains | ForEach-Object { Get-ADDomain $_ }
[pscustomobject]@{
  ForestRoot = $forest.RootDomain
  ForestFunctionalLevel = $forest.ForestMode
  Domains = ($domains | Select-Object -ExpandProperty DNSRoot) -join ','
}

# 트러스트 나열
$trusts = @()
foreach ($d in $domains) {
  $trusts += (Get-ADTrust -Filter * -Server $d.PDCEmulator)
}
$trusts | Select Name, Source, Target, Direction, TrustType, IsTransitive | Format-Table -Auto

# 선택적 인증/ SID 필터링 등 중요한 속성들 파악
$trusts | ForEach-Object {
  [pscustomobject]@{
    Trust = $_.Name
    SelectiveAuth = $_.SelectiveAuthentication
    SIDFiltering = $_.SIDFilteringForestAware
    TGTDelegation = $_.TGTDelegation
  }
} | Format-Table -Auto
```

#### (PowerShell) 위임(Delegation)·RBCD·Unconstrained 점검(읽기 전용)
```powershell
# Unconstrained delegation 컴퓨터/계정
Get-ADComputer -Filter {TrustedForDelegation -eq $true} -Properties TrustedForDelegation |
  Select-Object Name, DNSHostName

# Constrained delegation(서비스 제한 위임) 계정
Get-ADUser -Filter {msDS-AllowedToDelegateTo -like "*"} -Properties msDS-AllowedToDelegateTo |
  Select-Object SamAccountName, @{n="AllowedTo"; e={$_.("msDS-AllowedToDelegateTo")}}

# RBCD (msDS-AllowedToActOnBehalfOfOtherIdentity) 보유 객체
Get-ADComputer -Filter * -Properties 'msDS-AllowedToActOnBehalfOfOtherIdentity' |
  Where-Object {$_.('msDS-AllowedToActOnBehalfOfOtherIdentity')} |
  Select-Object Name, @{n='RBCD_SDDL';e={$_.('msDS-AllowedToActOnBehalfOfOtherIdentity').Access}}
```

---

## 9.2 공격 벡터: BloodHound 그래프, ACL/Spooler/NTLM 릴레이
*(방어/모델링 관점 — “악용”이 아니라 “가시화·차단·탐지”에 초점)*

### 9.2.1 BloodHound로 **권한 그래프**를 “방어 관점”에서 보는 법

> 목적: **누가/무엇이/어떻게** 고가치 자산(HVT: DC, DA, Tier-0)에 닿는지 **그래프로 시각화**하여, **조합 위험**(개별은 약하지만 연결되면 강력)을 찾고 제거.

**수집(안전 가이드)**
- 랩·본인 AD에서 **읽기 권한** 계정만 사용(도메인 정책·법 준수)
- LDAP/ADSI로 자체 스크립트 수집 또는 공식 수집기(조직 승인 하에)
- OSQuery/LDAP 쿼리로도 일부 엣지(로컬 관리자 매핑/GPO 링크 등) 대체 가능

**그래프에서 주로 보는 엣지/패턴**
- **AdminTo / HasSession**: 로컬 관리자권/세션 존재 → 이동 경로
- **GenericAll / GenericWrite / WriteDacl / WriteOwner**: ACL로 **객체 장악** 가능성
- **AddMember**: 보호 그룹으로의 경로
- **RBCD / Constrained Delegation / Unconstrained**: 위임 기반 경로
- **HasSPN / AS-REP Roastable / Kerberoastable**: 티켓 남용 위험
- **GPO -> OU -> Computer**: GPO가 **실행 권한/스크립트/서비스**를 부여하는 경로

**방어적 쿼리 아이디어(예시)**
- **“Shortest paths to Tier-0”**: 모든 계정/컴퓨터에서 Tier-0까지 경로 길이/빈도
- **“Nodes with multiple inbound edges”**: **허브 노드**(집중 위험)
- **“Unconstrained delegation near Tier-0”**: DC/서버 인접 Unconstrained 존재 여부
- **“Objects with WriteDACL on AdminSDHolder descendants”**: 보호 그룹 구성원 계정에 DACL 쓰기 권한을 가진 비정상 주체

**개선 루프**
1) 경로 제거(권한 축소/ACL 정정/위임 제거/세션 분리)
2) 위험 변경 감시(GitOps-like AD 권한 템플릿 + 주간 비교 리포트)
3) 예외는 **만료일** + 근거 문서화

---

### 9.2.2 ACL 기반 권한 전이(WriteDACL/WriteOwner/GenericAll 등)

**원리(방어 요약)**
- AD 객체(사용자/컴퓨터/그룹/GPO/컨테이너)에는 **보안 디스크립터**(DACL)가 있고, 여기에 **ACE**가 기록됨.
- 어떤 주체가 타 객체에 **GenericAll/WriteDACL/WriteOwner/ExtendedRight**를 가지면,
  - (모델상) **멤버 추가/속성 변경/권한 재위임** 등 **간접 권한 상승** 경로가 생김.
- 실제 운영에서는 **의도하지 않은 위임**이 누적되며 “긴 사슬”을 만든다.

**(PowerShell) 특정 권한 보유자 찾기(읽기 전용)**
```powershell
# 예: "Replicating Directory Changes" 권한(일명 DCSync 관련 ExtendedRights)을 가진 주체 찾기
Import-Module ActiveDirectory
$dc = (Get-ADDomain).DNSRoot
$root = Get-ADRootDSE
$nc = $root.defaultNamingContext
$guidMap = @{
  "Replicating Directory Changes" = "1131f6aa-9c07-11d1-f79f-00c04fc2dcd2";
  "Replicating Directory Changes All" = "1131f6ad-9c07-11d1-f79f-00c04fc2dcd2";
  "Replicating Directory Changes In Filtered Set" = "89e95b76-444d-4c62-991a-0facbeda640c"
}
$sd = Get-ACL ("AD:$nc")
$sd.Access | Where-Object {
  $_.ObjectType -in $($guidMap.Values) -and $_.ActiveDirectoryRights -match "ExtendedRight"
} | Select-Object IdentityReference, ActiveDirectoryRights, ObjectType
```

**점검 체크리스트**
- [ ] **DCSync 권한**(Replicating Directory Changes*) 보유자 최소화(백업/IDM 등 필수만)
- [ ] **WriteDACL/Owner** 권한을 가진 비관리 주체 제거
- [ ] **AdminSDHolder** 하위(보호 그룹 구성원) 객체의 **예외 ACE** 파악/정리
- [ ] **GPO 권한**: GPO 편집/링크 변경 권한이 비인가 팀에 있지 않은지 확인
- [ ] **RBCD**: `msDS-AllowedToActOnBehalfOfOtherIdentity`가 의도한 소유자/ACL인지 재검토

---

### 9.2.3 Spooler(인쇄 스풀러) 관련 공격 **모델**과 방어

> 과거 여러 CVE/기법이 “스풀러 서비스”의 설계·구현 상 문제를 통해 **권한 위임/접근**을 가능하게 했던 바가 있습니다. **악용 절차는 제외**하고, **방어 관점 행동 지침**만 기록합니다.

**방어 원칙**
- **서버/특히 DC에서 Spooler 비활성화**
- 클라이언트에서만 필요 최소로 유지, **Point and Print 제한**
- 스풀러 관련 **RPC/SMB** 흐름을 네트워크 정책으로 축소

**(PowerShell) DC/서버 스풀러 상태 점검**
```powershell
$servers = (Get-ADComputer -Filter {OperatingSystem -like "*Server*"} -Properties DNSHostName).DNSHostName
Invoke-Command -ComputerName $servers -ScriptBlock {
  $s = Get-Service -Name Spooler -ErrorAction SilentlyContinue
  [pscustomobject]@{ Computer=$env:COMPUTERNAME; Status=$s.Status; StartType=$s.StartType }
} | Format-Table -Auto
```

**(GPO 권장)**
- 컴퓨터 구성 → 관리 템플릿 → 프린터 → **“프린터 자동 설치 비활성/Point and Print 제한/서명된 드라이버만”**
- 서버 OU에 **Spooler 서비스 비활성(Start=Disabled)** GPO 배포

**탐지 힌트**
- `Microsoft-Windows-PrintService/Operational` 채널의 비정상 원격 작업
- 스풀러 관련 **RPC 호출 급증/이상 포트 접근**(NTA/IDS로 모니터)

---

### 9.2.4 NTLM 릴레이(모델)와 차단

**모델 요약**
- **서버 A**가 **서버 B**로 인증(HTTP/SMB/LDAP 등)할 때 **서버 A의 NTLM 인증**을 중계(릴레이)하여 B에서 **A 권한으로 동작**을 유발.
- **SMB 서명 미필수**, **LDAP/HTTP 채널 바인딩 미사용**, **NTLM 허용 환경**이 결합되면 위험.

**핵심 방어**
- **NTLM 비활성/축소**, Kerberos 우선
- **SMB 서명·암호화** 강제(**RequireSecuritySignature**, **EncryptData**)
- **LDAP Signing & Channel Binding** 강제
- **EPA(Extended Protection for Authentication)**, **MIC** 준수
- **WebClient 서비스 비활성(웹DAV)**, **LLMNR/NBNS** 비활성
- **IIS/HTTP**: Negotiate(Kerberos) 우선, NTLM fallback 제한

**(PowerShell) 서버 SMB/NTLM 정책 요약**
```powershell
# SMB 서버 구성
Get-SmbServerConfiguration | Select EnableSMB1Protocol, EnableSMB2Protocol, RequireSecuritySignature, EncryptData

# 로컬 NTLM 정책 일부(레지스트리 조회 예시)
$pol = 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0'
Get-ItemProperty $pol | Select-Object RestrictNTLM*, NtlmMinClientSec, NtlmMinServerSec
```

**(GPO)**
- 보안 옵션 → **Microsoft 네트워크 서버: 통신에 디지털 서명 필요** = 사용
- 보안 옵션 → **도메인 컨트롤러: LDAP 서버 서명 요구** = 사용
- 보안 옵션 → **네트워크 보안: NTLM 트래픽 제한** 정책 단계적 적용(감사→거부)

**탐지 힌트**
- 4624(Logon Type 3, **NTLM**), **SMB 서명 미사용** 탐지(서버 측 감사/Netlogon 로그)
- DC의 Kerberos 기대 구간에서 **NTLM 비율 급증**(SIEM)

---

## 9.3 “안전 실패” 중심 랩: **합법적 원격 관리**로 로그 시그널만 만들기

> 목적: 실제 악용 없이 **후방 활동의 흔적과 유사한 로그**를 만들어 **탐지 규칙/임계치**를 조정.

### 9.3.1 WinRM/PowerShell Remoting(정상 행위)으로 이동 시그널 관찰
```powershell
# (랩) 관리용 계정으로 합법 호스트에 진입(자체 랩 내)
$hosts = @("LAB-APP01","LAB-APP02","LAB-FS01")
$sec = Get-Credential  # 랩용 계정
Invoke-Command -ComputerName $hosts -Credential $sec -ScriptBlock { hostname; whoami; date }

# 기대 로그(멤버 서버): 4624 LogonType=3 or 10 (원격), 4688(명령 프로세스), Sysmon(1/3)
# DC: 관련 TGS(4769) 증가
```

**탐지 규칙 스케치**
- 특정 사용자/시간대에 **다중 호스트**로 원격 명령 분산 → 경고
- 단시간에 **새로운 관리 세션**이 **서버군**에 동시다발 → 경고
- WinRM/PSRemoting 허용 목록 외 대상 → 경고

---

## 9.4 운영 하드닝 체크리스트 (압축)

**권한·계층화**
- [ ] **Tier 모델**(Tier-0: DC/PKI/IDM, Tier-1: 서버, Tier-2: 워크스테이션) + **PAW(Privileged Access Workstation)**
- [ ] **로컬 관리자 제거**(LAPS/Windows LAPS), **원격 로컬 관리자 로그인 차단**
- [ ] 보호 그룹(DA/EA 등) **세션 금지**: 서버/워크스테이션에 로그인 금지 정책

**위임·트러스트**
- [ ] **Unconstrained/과도한 Constrained/RBCD** 제거
- [ ] 트러스트: **SelectiveAuth, SID 필터링, 단방향 최소화**
- [ ] **DCSync 권한 최소화**, 정기 감사(권한 변동 리포트)

**프로토콜·서명**
- [ ] Kerberos 우선, NTLM 단계적 폐지(감사→거부)
- [ ] **SMB 서명/암호화**, LDAP 서명/채널 바인딩, EPA
- [ ] WebClient/LLMNR/NBNS 비활성

**스풀러·서비스**
- [ ] 서버(특히 DC) **스풀러 비활성**
- [ ] GPO: Point and Print 제한/서명 요구

**가시성**
- [ ] DC: 4768/4769/4771/4776, 멤버: 4624/4672/4688, PrintService/Operational
- [ ] Sysmon: 1/3/7/10/12~14, WEF/센터로 집계
- [ ] BloodHound **리뷰 사이클**: 월 1회 경로 제거 워킹미팅

---

## 9.5 자주 묻는 질문(운영 관점)

- **“BloodHound 그래프가 너무 복잡해요.”**
  → Tier-0 자산만 노드로 고정하고, “경로 길이 ≤ 3” 필터로 출발. in-degree 상위 5개 허브부터 정리.

- **“NTLM을 바로 끄기 어렵습니다.”**
  → **감사 모드**로 4~8주 패턴 수집 → **서버/세그먼트 단위** 단계적 거부. SMB 서명/LDAP Signing을 우선 강제.

- **“위임이 필요한 레거시 앱이 있어요.”**
  → Constrained/RBCD로 **정확히 필요한 서비스 SPN만 허용**, 소유자/ACL 주체는 **전담 그룹**으로 고정하고 만료일 운영.

- **“스풀러를 끄면 인쇄가 멈춥니다.”**
  → DC/서버 OU에만 비활성. 프린트 서버 전용 OU 운영, 드라이버 서명/제한 정책 강화.

---

### 부록 A — 안전한 “권한 변경 감시” GitOps 흐름(개념)
1) LDAP 덤프/AD PowerShell로 **권한 스냅샷(JSON)** 추출
2) Git 저장소에 커밋 → PR 리뷰(변경 diff)
3) 승인된 변경만 실제 AD에 적용(자동화는 **읽기 전용**부터 시작)
4) 주간 리포트: 신규 AdminTo/WriteDACL/Trust 변경 요약

### 부록 B — SIEM 룰 템플릿(요약)
- **High TGS volume per user**(4769, 5~15분 윈도우)
- **New NTLM burst on Kerberos-expected segment**
- **Spooler remote operations on server/DC**
- **New RBCD SDDL set** 이벤트(디렉터리 감사 필요)

---

## 한 줄 요약
- 후방 활동은 **개별 약점**보다 **권한·위임·세션·서비스**가 **연결되며 강해지는 그래프 문제**입니다.
- **BloodHound = 공격지침**이 아니라 **권한 그래프 가시화 도구**로 보고, **경로 제거의 워크플로**를 만드세요.
- **ACL(특히 DCSync/WriteDACL/Owner)**, **Spooler**, **NTLM 릴레이**는 “설정·정책”으로 **구조적으로 차단**해야 합니다.
- 본 문서의 스크립트/체크리스트/정책을 **정기 감사 + CI/PR 리뷰**에 연결하면, **지속 가능한 AD 방어**가 가능합니다.
