---
layout: post
title: 확률과 통계 - 다변량 확률 & 공분산 구조
date: 2025-09-19 19:25:23 +0900
category: 확률과 통계
---
# 5) 다변량 확률 & 공분산 구조

> **목표**  
> - **공분산/상관 행렬**의 의미, 성질(양의 반정정, 표준화, 부분상관)을 정확히 안다.  
> - **다변량 정규(MVN)**의 핵심(선형결합 보존, 조건부분포/정밀행렬, 가우시안 그래프)을 익힌다.  
> - **조건부독립**: “상관 0 ↛ 독립”, “가우시안에서만 상관 0 ⇒ 독립”, “부분상관 0 ⇒ 조건부독립(가우시안)”을 정리한다.  
> - **예시**: 퍼널 3변수 **(S=노출, K=클릭, V=전환)**의 공분산 구조로 **안정성/품질 vs 양**을 분해하고, **공변동의 오해(상관≠인과)**를 해소한다.  

---

## 0) Hook — “같이 오르는 것과, 서로 ‘때문’인 것은 다르다”
- 트래픽이 폭증한 날 **S(노출)**, **K(클릭)**, **V(전환)**가 **함께 상승**한다 → 공분산/상관은 커진다.  
- 그러나 그날의 개선이 **클릭 품질(전환|클릭)** 때문인지, **노출량** 때문인지는 다르다.  
- 이 장의 무기: **공분산 행렬 Σ**, **상관 행렬 R**, **정밀행렬(Σ⁻¹)**, **부분상관**.

---

## 1) 표기·정의 — 확률벡터, 공분산/상관 행렬, 부분상관

### 1.1 확률벡터와 1·2차 모멘트
- 확률벡터: $$\mathbf{X}=(X_1,\dots,X_d)^\top$$  
- 평균벡터: $$\boldsymbol{\mu}=E[\mathbf{X}]$$  
- **공분산 행렬(Σ)**  
  $$
  \Sigma=\mathrm{Cov}(\mathbf{X})=E[(\mathbf{X}-\boldsymbol{\mu})(\mathbf{X}-\boldsymbol{\mu})^\top]
  $$
  - 대각: $$\Sigma_{ii}=\mathrm{Var}(X_i)$$  
  - 비대각: $$\Sigma_{ij}=\mathrm{Cov}(X_i,X_j)$$  
  - **성질**: $$\Sigma\succeq 0$$(양의 반정정), 대칭, 임의의 벡터 $$\mathbf{a}$$에 대해 $$\mathrm{Var}(\mathbf{a}^\top \mathbf{X})=\mathbf{a}^\top \Sigma \mathbf{a}\ge 0$$.

### 1.2 상관 행렬
- 표준화: $$Z_i=\frac{X_i-\mu_i}{\sigma_i}$$, $$\sigma_i=\sqrt{\Sigma_{ii}}$$  
- **상관 행렬** $$R=(\rho_{ij})=\mathrm{Corr}(\mathbf{X})=D^{-1}\Sigma D^{-1}$$ (단, $$D=\mathrm{diag}(\sigma_1,\dots,\sigma_d)$$)  
- $$\rho_{ij}=\frac{\Sigma_{ij}}{\sigma_i\sigma_j}\in[-1,1]$$

### 1.3 부분상관(Partial correlation)
- **정밀행렬** $$\Omega=\Sigma^{-1}$$ (가정: 가역)  
- **가우시안일 때** $$\rho_{ij\cdot -ij}=-\frac{\Omega_{ij}}{\sqrt{\Omega_{ii}\Omega_{jj}}}$$  
  - 해석: “나머지 변수들을 **고정**했을 때” $$X_i, X_j$$의 순수 상관.  
  - 가우시안에서는 **부분상관 0 ⇔ 조건부독립**.

---

## 2) 다변량 정규(MVN) 핵심

### 2.1 정의
- $$\mathbf{X}\sim \mathcal{N}_d(\boldsymbol{\mu}, \Sigma)$$ ⇔ 임의의 벡터 $$\mathbf{a}$$에 대해 $$\mathbf{a}^\top\mathbf{X} \sim \mathcal{N}(\mathbf{a}^\top\boldsymbol{\mu},\mathbf{a}^\top\Sigma\mathbf{a})$$.  
- 밀도:
$$
f(\mathbf{x})=\frac{1}{(2\pi)^{d/2}|\Sigma|^{1/2}}\exp\!\left(-\tfrac{1}{2}(\mathbf{x}-\boldsymbol{\mu})^\top\Sigma^{-1}(\mathbf{x}-\boldsymbol{\mu})\right)
$$

### 2.2 선형변환·부분·조건
- 선형: $$\mathbf{Y}=A\mathbf{X}+b \Rightarrow \mathbf{Y}\sim \mathcal{N}(A\boldsymbol{\mu}+b, A\Sigma A^\top)$$  
- 부분벡터: $$\mathbf{X}=(\mathbf{X}_1,\mathbf{X}_2)$$, 블록 $$\Sigma=\begin{pmatrix}\Sigma_{11}&\Sigma_{12}\\\Sigma_{21}&\Sigma_{22}\end{pmatrix}$$  
- **조건부분포**:
$$
\mathbf{X}_1\mid \mathbf{X}_2=\mathbf{x}_2 \sim \mathcal{N}\!\left(\mu_1+\Sigma_{12}\Sigma_{22}^{-1}(\mathbf{x}_2-\mu_2,\ ),\ \Sigma_{11}-\Sigma_{12}\Sigma_{22}^{-1}\Sigma_{21}\right)
$$
- **가우시안에서만** “상관 0 ⇒ 독립”이 성립(중요!).

### 2.3 정밀행렬과 그래프
- $$\Omega_{ij}=0 \Rightarrow X_i \perp\!\!\!\perp X_j \mid \mathbf{X}_{-ij}$$ (가우시안 그래픽 모델).  
- 데이터 과학 실무: **스파스 정밀행렬**(Graphical Lasso 등)로 **희소 그래프**를 추정 → **직접 연결 관계** 파악.

---

## 3) 퍼널 3변수 모형: (S=노출, K=클릭, V=전환)

### 3.1 단순 ‘희석(thinning)’ 포아송 퍼널
- **가정**  
  1) **노출 수** $$S\sim \mathrm{Pois}(\lambda)$$  
  2) **클릭**: $$K\mid S\sim \mathrm{Bin}(S, p) \Rightarrow K\sim \mathrm{Pois}(p\lambda)$$ (포아송 희석)  
  3) **전환**(클릭경로만): $$V\mid K\sim \mathrm{Bin}(K, q) \Rightarrow V\sim \mathrm{Pois}(pq\lambda)$$
- **1차 모멘트**  
  $$E[S]=\lambda,\; E[K]=p\lambda,\; E[V]=pq\lambda$$
- **2차 모멘트(공분산)**  
  $$\mathrm{Var}(S)=\lambda$$  
  $$\mathrm{Cov}(S,K)=p\lambda,\quad \mathrm{Cov}(S,V)=pq\lambda,\quad \mathrm{Cov}(K,V)=q\,\mathrm{Var}(K)=pq\lambda$$  
  $$\mathrm{Var}(K)=p\lambda,\quad \mathrm{Var}(V)=pq\lambda$$
- **상관**  
  $$
  \rho_{SK}=\sqrt{p},\quad \rho_{SV}=\sqrt{pq},\quad \rho_{KV}=\sqrt{q}
  $$
  → **“양(traffic)”**과 **“품질”**이 공분산에 어떻게 반영되는지 직관적.

> 메시지: 단순 퍼널에서는 모든 공분산이 **한 축(트래픽)** 으로 동조. 이 상황에서 **상관이 높다**고 “품질 개선”이라 결론 내리면 착시.

### 3.2 두 경로 전환: (클릭경로 q₁ + 비클릭경로 q₀)
- $$V = V_{\text{click}} + V_{\text{other}}$$  
  - $$V_{\text{click}}\mid K\sim \mathrm{Bin}(K,q_1)$$  
  - $$V_{\text{other}}\mid (S,K)\sim \mathrm{Bin}(S-K,q_0)$$
- **기대**  
  $$
  E[V]=q_1\,E[K]+q_0\,(E[S]-E[K])=\lambda\{q_0+(q_1-q_0)p\}
  $$
- **공분산 요약(법칙 사용)**  
  - 총공분산: $$\mathrm{Cov}(X,Y)=E[\mathrm{Cov}(X,Y\mid S)]+\mathrm{Cov}(E[X\mid S],E[Y\mid S])$$  
  - 계산 결과:
    $$
    \mathrm{Cov}(S,V)=\lambda\{q_0+(q_1-q_0)p\},\qquad
    \mathrm{Cov}(K,V)=\lambda\,p\,q_1
    $$
  - **핵심 해석**:  
    - **Cov(K,V)**는 **클릭경로 품질 q₁**만 반영(비클릭 경로는 **S만**과 결부).  
    - **Cov(S,V)**는 **두 경로**가 모두 반영.

> 실무 팁: **클릭과 전환의 공분산/상관이 올라가도**, 그게 **q₁** 때문인지, **q₀**(다른 경로) + 트래픽 때문인지 분리해서 봐야 한다.

---

## 4) 조건부독립과 부분상관으로 ‘품질 vs 양’ 분리

### 4.1 조건부독립의 아이디어
- 관심: 클릭이 **있을 때** 전환이 잘 일어나는가(품질)?  
- **S(트래픽)** 을 조건에 두면, **양 효과**를 고정하고 **품질(q₁)** 신호를 본다.  
- 가우시안 근사에서:
  $$
  \rho_{KV\cdot S}=\frac{\rho_{KV}-\rho_{KS}\rho_{VS}}{\sqrt{(1-\rho_{KS}^2)(1-\rho_{VS}^2)}}
  $$
  - **클릭이 전환에 아무 영향 없음**(q₁=q₀) → 이론적으로 $$\rho_{KV\cdot S}\approx 0$$.

### 4.2 정밀행렬(Σ⁻¹) 활용
- 관측 공분산 $$\hat \Sigma$$ 로부터 $$\hat \Omega=\hat \Sigma^{-1}$$  
- (가우시안 가정하)  
  $$
  \widehat{\rho}_{ij\cdot -ij}=-\frac{\hat \Omega_{ij}}{\sqrt{\hat \Omega_{ii}\hat \Omega_{jj}}}
  $$
- 사용처  
  - **직접 연결**(간선)을 본다: “K—V 직결?”  
  - “S를 거치지 않고도 K가 V에 직접 힘을 미치는가?” 바라보기.

---

## 5) ‘상관 ≠ 인과’ · ‘공분산 0이라도 종속 가능’ 증명 예시

### 5.1 상관은 인과가 아니다(공변동의 함정)
- “S(트래픽) ↑ ⇒ K,V 함께 ↑” → **공통 원인(confounder)**.  
- 실무: **요일/캠페인/세그먼트**를 통제(조건부)하지 않으면, 상관이 인과처럼 보인다.

### 5.2 공분산 0이지만 종속(비선형) — 고전 예
- $$X\sim \mathrm{Unif}(-1,1)$$, $$Y=X^2$$  
- $$E[X]=0,\ E[Y]=1/3,\ E[XY]=E[X^3]=0$$ → $$\mathrm{Cov}(X,Y)=0$$  
- 하지만 Y는 X의 **결정적 함수** → 완전 종속. **상관 0은 독립을 뜻하지 않는다.**

---

## 6) 시간단위 집계(일별)에서의 공분산 — 총분산/총공분산 법칙

### 6.1 법칙(ANOVA의 벡터 버전)
- $$\mathrm{Cov}(X,Y)=E[\mathrm{Cov}(X,Y\mid Z)]+\mathrm{Cov}(E[X\mid Z],E[Y\mid Z])$$  
- **일별 요일효과 Z**를 통제하면, **내부(일 내) 변동** vs **일 간 평균 변동**을 분해 가능.  
  - 날씨/프로모션/시즌 등 Z가 **공통 원인**이면, 두 번째 항이 커진다.

### 6.2 퍼널 적용
- Z=**세그먼트 믹스**(모바일/데스크톱 비율).  
  - **Cov(K,V)**가 커져도, **Cov(E[K|Z], E[V|Z])** 항이 커서 생기는 착시일 수 있다.  
  - **세그먼트별 보고 + 가중 평균**으로 감시.

---

## 7) ‘퍼널 안정성’ 지표화: 공변동 관점의 3가지

### 7.1 공분산 기반 안정성(트래픽-클릭)
- $$\mathrm{Cov}(S,K) / E[S] \approx p$$ (포아송 희석 근사)  
- 일별로 추적해 **p(CTR)의 일관성**을 감시(급락/급등 탐지).

### 7.2 부분상관 기반 ‘품질’ 감시
- $$\rho_{KV\cdot S}$$ 를 **주간** 이동창으로 추정 →  
  - **양(traffic)** 고정 후 **클릭→전환 품질**의 순수 상관.

### 7.3 공분산 구조의 안정성 테스트
- **주/월** 블록으로 $$\hat \Sigma$$ 를 추정, 블록 간 차이를 **Box’s M**(정규 근사)나 **부트스트랩**으로 비교.  
- **변동성 지표**: $$\|\hat \Sigma_t - \hat \Sigma_{t-1}\|_F$$(Frobenius norm) 트렌드.

---

## 8) 실전 수치 예시 — 퍼널 파라미터와 Σ의 관계

가정 A(기준): $$\lambda=10^6,\ p=0.015,\ q_1=0.12,\ q_0=0.02$$  
- 기대:  
  $$E[S]=10^6,\ E[K]=15{,}000,\ E[V]=0.12\cdot 15{,}000 + 0.02\cdot(10^6-15{,}000)\approx 30{,}300$$  
- 공분산(요약)  
  - $$\mathrm{Cov}(S,K)=p\lambda=15{,}000$$  
  - $$\mathrm{Cov}(K,V)=p q_1\lambda=1{,}800$$  
  - $$\mathrm{Cov}(S,V)=\lambda\{q_0+(q_1-q_0)p\}\approx 10^6\cdot(0.02+0.10\cdot 0.015)=21{,}500$$

해석  
- **Cov(S,V) ≫ Cov(K,V)**: 전환의 **큰 변동**은 **트래픽**과 강결합.  
- **Cov(K,V)**는 **클릭 품질 q₁**만 반영하므로, q₁ 변화 감시에 유용.  
- **부분상관** $$\rho_{KV\cdot S}$$ 를 따로 모니터링해야 품질 변화를 놓치지 않는다.

---

## 9) 시뮬레이션(개념용) — Σ, R, 부분상관 추정
```python
# 개념 데모용 시뮬 (실무는 검증된 라이브러리 사용 권장)
import random, math

def pois(lam):
    # Knuth 알고리즘 (lam 크면 정규근사 권장)
    L = math.exp(-lam)
    k, p = 0, 1.0
    while p > L:
        k += 1
        p *= random.random()
    return k-1

def simulate(n=1000, lam=1e6, p=0.015, q1=0.12, q0=0.02):
    data = []
    for _ in range(n):
        S = pois(lam)
        # 클릭
        K = sum(1 for _ in range(S) if random.random() < p)
        # 전환: 클릭 경로와 비클릭 경로
        V_click = sum(1 for _ in range(K) if random.random() < q1)
        V_other = sum(1 for _ in range(S-K) if random.random() < q0)
        V = V_click + V_other
        data.append((S, K, V))
    return data

def mean(xs): return sum(xs)/len(xs)
def cov(x,y):
    mx,my = mean(x), mean(y)
    return sum((a-mx)*(b-my) for a,b in zip(x,y))/(len(x)-1)

def corr(x,y):
    import math
    vx = cov(x,x); vy = cov(y,y)
    return cov(x,y)/math.sqrt(vx*vy)

# 주의: lam이 매우 커서 느릴 수 있음. 개념 확인은 lam을 줄여서 실행.
```

---

## 10) 비선형·비정규에서의 공분산 해석 주의

### 10.1 비선형 의존
- **공분산 0**이라도 비선형 종속(예: $$Y=X^2$$)이면 **정보를 놓친다**.  
- 해결: **스피어먼 상관**(순위), **미행렬/커널 상관(HSIC)**, **상호정보량** 등 **비선형** 의존 지표 병행.

### 10.2 분포의 비대칭/꼬리
- 포아송/로그정규 꼬리에서 **공분산 추정**은 극단값에 민감 → **윈저라이징/로버스트 공분산**(MCD 등) 고려.

### 10.3 비정규에서 부분상관 해석
- 정밀행렬 기반 “부분상관=조건부독립”은 **가우시안에서만 정확**.  
- 비정규라면 **회귀잔차 기반**(선형) 부분상관으로 “선형적 조건부 관계”만 본다.

---

## 11) 공분산 행렬의 수치·선형대수 메모

### 11.1 고유분해와 주성분
- $$\Sigma=Q\Lambda Q^\top$$, $$\Lambda=\mathrm{diag}(\lambda_1\ge\dots\ge\lambda_d\ge 0)$$  
- **PC(주성분)**: 변동의 큰 축. 퍼널에서는 보통 **트래픽 축**이 1주성분을 지배.

### 11.2 스케일 불변성
- 상관 행렬 R는 **단위**에 불변. 서로 다른 규모의 지표(“건수 vs 비율”) 비교 시 **R**로 시작.

### 11.3 특이/반가역
- 완전한 선형결합(예: $$V=K$$ 인 날) 발생 시 Σ는 **특이** → 역행렬 없음 → 정밀행렬 기반 분석 불가.  
- 해결: **정규화(노이즈 추가)**, **축소(리지만 공분산)**, **변수 축소**.

---

## 12) 모델-기반 해석: 가우시안 회귀 vs 카운트 회귀

### 12.1 가우시안 근사 회귀
- $$V=\beta_0+\beta_S S+\beta_K K+\varepsilon,\quad \varepsilon\sim \mathcal{N}(0,\sigma^2)$$  
- **주의**: 카운트/비율에 가우시안 잔차 가정은 종종 위배.

### 12.2 포아송/음이항 회귀(오프셋)
- $$V\sim \mathrm{Pois}(\exp(\beta_0+\beta_S \log S + \beta_K \log K))$$ 처럼 **로그-링크** + **오프셋** 활용.  
- “양(노출)”과 “품질(클릭→전환)” 효과를 **파라미터 분리**로 추정 가능.

---

## 13) 보고서 문장 패턴 — 공분산 구조를 풀어 쓰기
- “일간 공분산에서 **Cov(S,V)** 가 **대부분의 변동**을 설명(트래픽 동조).  
- **Cov(K,V)** 는 **클릭 품질(q₁)** 민감 지표.  
- **부분상관** $$\rho_{KV\cdot S}$$ 상승은 **양 고정 시 품질 개선** 신호.  
- 상관 0은 독립이 아니며(비선형 가능), 가우시안이 아닐 땐 **조건부독립 해석 주의**.”

---

## 14) 체크리스트 — 실무 적용 전 10문항
1) 공분산/상관 **행렬**을 먼저 보고, **주성분**으로 큰 변동 축을 파악했는가?  
2) **트래픽(S)** 을 조건에 두고 **품질(K→V)** 를 봤는가(부분상관/조건부 분석)?  
3) **세그먼트 Z**(디바이스/캠페인)를 **층화**하거나 **라벨**로 넣었는가?  
4) **시간효과**(요일/시즌)를 Z로 통제했는가(총공분산 법칙)?  
5) **비선형** 의존(순위/커널/MI) 신호를 체크했는가?  
6) **극단치**가 공분산을 왜곡하지 않는가(로버스트화)?  
7) Σ가 **가역**인지, 아니면 **축소/정규화**가 필요한가?  
8) 가우시안 가정이 필요한 지점(부분상관=조건부독립 해석)을 명확히 구분했는가?  
9) **오프셋/링크**를 갖춘 **카운트 회귀**로 대안을 검토했는가?  
10) 리포트에 **양 vs 품질**을 **분리 문장**으로 적었는가?

---

## 15) 미니 퀴즈(개념 확인)

**Q1.** 가우시안에서 $$\Omega_{KV}=0$$ 가 의미하는 것은?  
→ **K ⟂ V | S(및 나머지)**, 부분상관 0.

**Q2.** “공분산 0 ⇒ 독립”이 **항상** 성립하지 않음을 보이는 예는?  
→ $$X\sim \mathrm{Unif}(-1,1),\ Y=X^2$$ (Cov=0, 종속).

**Q3.** 퍼널에서 **Cov(K,V)** 가 커졌을 때 가능한 두 해석은?  
→ (1) **q₁(전환|클릭) 개선** (2) **세그먼트/시간 공통 원인**으로 **동조**. → Z를 통제하거나 부분상관 확인.

---

## 16) TL;DR
- **Σ(공분산)**: 함께 흔들림의 기하학; **R(상관)**: 스케일 불변 비교; **Ω=Σ⁻¹(정밀)**: **직접 연결**과 **부분상관**.  
- **가우시안**: 선형결합 보존, **상관 0 ⇒ 독립**, **Ω의 0 ⇔ 조건부독립**.  
- **퍼널(S,K,V)**: **Cov(S,V)** 는 트래픽 동조, **Cov(K,V)** 는 **클릭 품질** 민감. **부분상관**으로 “양 vs 품질” 분해.  
- **상관≠인과**, **Cov=0**이라도 종속 가능(비선형). **층화/조건/모형화**로 해석을 안전하게.
