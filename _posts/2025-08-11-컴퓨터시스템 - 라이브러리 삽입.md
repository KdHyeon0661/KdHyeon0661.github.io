---
layout: post
title: 컴퓨터시스템 - 라이브러리 삽입
date: 2025-08-11 21:20:23 +0900
category: 컴퓨터시스템
---
# 라이브러리 삽입(Library Injection) — 원리, 방식, 보안, 사례

> “라이브러리 삽입”은 **프로세스 실행 중에 새로운 동적 라이브러리(.so/.dll)를 로드하여 동작을 바꾸거나 기능을 추가하는 기술**을 말합니다.  
> 운영체제의 **동적 로더(dynamically linker/loader)** 동작 원리를 이용하는 경우가 많으며, 성능 개선·디버깅·보안 연구뿐 아니라 악성 행위에도 쓰입니다.

---

## 1. 개념과 기본 원리

- **정의**: 실행 중인 프로세스의 **주소 공간에 원하는 라이브러리를 로드**시켜 기존 코드 흐름에 영향을 주거나 새로운 기능을 실행하게 만드는 기법.
- **핵심 아이디어**: OS는 동적 링크 시 `dlopen()`(Linux) 또는 `LoadLibrary()`(Windows) 같은 API를 통해 **런타임에 동적 라이브러리를 로드**할 수 있도록 설계됨.  
  이를 **정상적인 방법** 또는 **우회 기법**으로 이용하면, 원래 설계에 없던 코드가 프로세스에 삽입됨.
- **적용 범위**:
  - 성능 분석기/프로파일러(함수 호출 추적)
  - 디버깅(런타임 변수 모니터링, 코드 패치)
  - API 후킹(hooking)
  - 악성코드(키로거, 게임 핵 등)

---

## 2. 주요 기법

### 2.1 환경변수 기반 라이브러리 삽입 (LD_PRELOAD)
- **플랫폼**: Linux/Unix
- **원리**:
  - `LD_PRELOAD` 환경 변수를 통해 지정한 라이브러리가 **다른 모든 라이브러리보다 먼저** 로드됨.
  - 동일한 심볼(함수/전역 변수)을 재정의하면 원래 심볼 대신 실행.
- **예시**:
  ```bash
  LD_PRELOAD=./myhook.so target_program
  ```
- **장점**:
  - 코드 변경 없이 적용 가능.
  - 간단히 함수 후킹 가능.
- **단점**:
  - 자식 프로세스에만 영향.
  - SUID 프로그램 등 보안 제한.

---

### 2.2 런타임 API 이용 (dlopen / LoadLibrary)
- **Linux**: `dlopen()`, `dlsym()`, `dlclose()`  
- **Windows**: `LoadLibrary()`, `GetProcAddress()`, `FreeLibrary()`
- **사용 방법**:
  - 프로세스 내부 코드에서 직접 호출하거나, 원격 쓰기+스레드 생성으로 타 프로세스에서 호출.
- **예시 (Linux)**:
  ```c
  #include <dlfcn.h>
  void* handle = dlopen("./plugin.so", RTLD_NOW);
  void (*func)() = dlsym(handle, "entry");
  func();
  dlclose(handle);
  ```

---

### 2.3 원격 프로세스 주입 (ptrace, WriteProcessMemory)
- **Linux**: `ptrace()`를 이용해 타 프로세스 메모리에 `dlopen()` 호출 코드 삽입.
- **Windows**: `VirtualAllocEx()` + `WriteProcessMemory()`로 문자열·코드 쓰기 → `CreateRemoteThread()`로 `LoadLibrary()` 호출.
- **특징**:
  - 이미 실행 중인 프로세스에 라이브러리 삽입 가능.
  - 악성코드나 치트 툴에서 자주 사용.
  - 높은 권한 필요.

---

### 2.4 실행파일 패치 / 링커 옵션 이용
- 빌드 시 의도적으로 특정 라이브러리 연결 후, 런타임에 교체.
- ELF에서는 `DT_NEEDED` 항목 수정, Windows에서는 IAT(Import Address Table) 수정.

---

## 3. 심볼 재정의와 후킹

- 라이브러리 삽입의 주된 목적은 **기존 함수의 동작 변경**.
- 방법:
  - **심볼 재정의**: 같은 함수 이름을 가진 심볼 제공 → 동적 링커가 우선 로드.
  - **PLT/GOT 패치**: ELF의 PLT/GOT 엔트리를 원하는 함수 주소로 바꿈.
  - **인라인 후킹**: 함수 첫 부분에 jump 명령 삽입해 다른 코드로 분기.

---

## 4. 보안 관점

### 4.1 위험 요소
- 악성코드가 합법적인 프로세스 권한을 빌려 동작.
- 금융, 게임, 브라우저 등 민감한 프로그램의 보안 무력화.
- ASLR, RELRO, 코드 서명 우회 시 심각한 피해.

### 4.2 방어 기법
- **코드 서명 검증**: Windows AppLocker, macOS SIP.
- **환경변수 무시**: SUID 프로그램은 LD_PRELOAD 무효.
- **SELinux/AppArmor**로 라이브러리 로드 제한.
- **무결성 검사**: 해시 체크, 런타임 검증.

---

## 5. 활용 사례

| 목적 | 예시 |
|------|------|
| 성능 분석 | `gperftools`, `Valgrind`의 LD_PRELOAD 기반 프로파일러 |
| 디버깅 | `ltrace`, `strace` |
| 기능 확장 | 오픈소스 앱에 플러그인 주입 |
| 보안 연구 | API 호출 로그, 암호화 키 추적 |
| 악성 행위 | 게임 핵, 키로거, 백도어 |

---

## 6. 요약

- **라이브러리 삽입**은 OS의 **동적 로딩 메커니즘**을 이용해 새로운 코드를 실행 중인 프로세스에 주입하는 기술.
- 개발·분석·보안 분야에서 유용하지만, 악성 목적으로도 악용될 수 있어 **양날의 검**.
- **LD_PRELOAD**, **dlopen/LoadLibrary**, **원격 쓰기+스레드 생성** 등 다양한 방식이 있고,  
  보안 체계와 정책에 따라 허용 범위가 다르다.