---
layout: post
title: TCPIP - IP 데이터그램
date: 2025-08-29 23:25:23 +0900
category: TCPIP
---
# IP 데이터그램 크기, MTU, 단편화 및 재조립

## IP 데이터그램 크기, 최대 전송 단위(MTU) 및 단편화 개요

IP 데이터그램은 인터넷을 통해 전송되는 기본 데이터 단위입니다. 그러나 네트워크의 이질성으로 인해 데이터그램 크기에 한계가 발생하는데, 이를 해결하기 위해 **단편화(Fragmentation)**와 **재조립(Reassembly)** 메커니즘이 필요합니다.

### 최대 전송 단위(MTU)의 개념
MTU는 특정 네트워크 링크가 한 번에 전송할 수 있는 **최대 데이터 크기**를 의미합니다. 각 네트워크 기술마다 고유한 MTU 값을 가지며, 데이터그램이 MTU보다 크면 단편화되어야 합니다.

**일반적인 MTU 값:**
- 이더넷(Ethernet): 1500바이트
- PPP(점대점 프로토콜): 296~1500바이트
- 토큰링(Token Ring): 4464바이트
- FDDI: 4352바이트
- PPPoE: 1492바이트 (이더넷 헤더 제외)

```
송신 호스트 → [1500바이트 데이터그램] → 라우터
라우터 → 다음 링크 MTU 576바이트 → 단편화 필요!
```

## IP 메시지 단편화 과정

단편화는 라우터나 송신 호스트에서 데이터그램이 MTU를 초과할 때 수행됩니다. 각 단편은 독립적인 IP 데이터그램으로 취급되며, 목적지에서만 재조립됩니다.

### 단편화 헤더 필드
IP 헤더에는 단편화를 관리하기 위한 세 가지 필드가 있습니다:

1. **식별자(Identification)**: 16비트, 원본 데이터그램을 식별
2. **플래그(Flags)**: 3비트 (예비비트, DF, MF)
   - **DF(Don't Fragment)**: 1이면 단편화 금지
   - **MF(More Fragments)**: 마지막 단편이면 0, 나머지는 1
3. **단편 오프셋(Fragment Offset)**: 13비트, 원본 데이터그램 내 상대적 위치 (8바이트 단위)

### 단편화 알고리즘 예시
```
원본 데이터그램: 4000바이트 (헤더 20바이트 + 데이터 3980바이트)
MTU: 1500바이트

1단편: 헤더(20) + 데이터(1480) = 1500바이트, MF=1, 오프셋=0
2단편: 헤더(20) + 데이터(1480) = 1500바이트, MF=1, 오프셋=185 (1480/8)
3단편: 헤더(20) + 데이터(1020) = 1040바이트, MF=0, 오프셋=370 (2960/8)
```

**단편화 패킷 구조:**
```
원본 데이터그램: [IP 헤더 | 데이터 3980바이트]
↓ 단편화 후
단편 1: [IP 헤더(MF=1, 오프셋=0) | 데이터 1480바이트]
단편 2: [IP 헤더(MF=1, 오프셋=185) | 데이터 1480바이트] 
단편 3: [IP 헤더(MF=0, 오프셋=370) | 데이터 1020바이트]
```

## IP 메시지 재조립 과정

재조립은 **수신 호스트에서만 수행**됩니다. 중간 라우터들은 단편을 재조립하지 않고 그대로 전달합니다.

### 재조립 단계
1. **단편 수신**: 같은 식별자를 가진 단편들을 버퍼에 저장
2. **순서 확인**: 오프셋 값으로 단편의 순서와 위치 확인
3. **완성 여부 판단**: MF=0인 단편 도착 시 전체 크기 계산
   - 전체 크기 = 마지막 단편 오프셋 × 8 + 마지막 단편 데이터 길이
4. **타이머 관리**: 재조립 타이머(일반적으로 15~60초) 시작
   - 일정 시간 내 모든 단편이 도착하지 않으면 모든 단편 폐기
   - ICMP 시간 초과 메시지 송신

### 재조립 도표
```
수신 호스트 버퍼:
[단편1: 오프셋0, MF=1, 길이1480]
[단편2: 오프셋185, MF=1, 길이1480]
[단편3: 오프셋370, MF=0, 길이1020] ← 마지막 단편 도착

재조립 계산:
전체 크기 = 370 × 8 + 1020 = 2960 + 1020 = 3980바이트
모든 단편 도착 확인 → 원본 데이터 재구성
```

# IP 데이터그램 전달과 라우팅

## IP 데이터그램 직접 전달과 간접 전달(라우팅)

IP 데이터그램 전달은 크게 두 가지 방식으로 구분됩니다:

### 직접 전달 (Direct Delivery)
- 송신 호스트와 수신 호스트가 **동일한 물리적 네트워크**에 있는 경우
- ARP를 통해 MAC 주소 획득 후 직접 프레임 전송
- 라우터를 통하지 않는 전달

### 간접 전달 (Indirect Delivery)
- 송신 호스트와 수신 호스트가 **서로 다른 네트워크**에 있는 경우
- 데이터그램을 **기본 게이트웨이**(라우터)로 전송
- 라우터가 목적지 네트워크까지 경로를 따라 패킷 전달

**결정 알고리즘:**
```
if (목적지 IP 주소의 네트워크 부분 == 내 네트워크 주소) then
    직접 전달
else
    간접 전달 (기본 게이트웨이 사용)
endif
```

## IP 라우팅 개념과 다음 홉 라우팅 과정

### 라우팅의 기본 원리
라우팅은 데이터그램이 출발지에서 목적지까지 이동하는 **경로 선택 과정**입니다. 각 라우터는 패킷을 다음 적절한 라우터(다음 홉)로 전달하는 결정을 내립니다.

**라우팅 프로세스:**
1. **라우팅 테이블 조회**: 목적지 IP 주소에 대한 가장 일치하는 경로 탐색
2. **다음 홉 결정**: 패킷을 전달할 다음 라우터 또는 인터페이스 결정
3. **TTL 감소**: Time To Live 값 1 감소 (0이 되면 패킷 폐기)
4. **체크섬 재계산**: 헤더 체크섬 재계산
5. **전송**: 적절한 네트워크 인터페이스를 통해 다음 홉으로 전송

### 다음 홉 라우팅 예시
```
호스트 A(10.0.0.2) → 호스트 B(192.168.1.10) 통신

1. 호스트 A: 목적지 192.168.1.10이 로컬 네트워크 아님
2. 기본 게이트웨이(10.0.0.1)로 패킷 전송
3. 라우터 R1: 라우팅 테이블에서 192.168.1.0/24 찾음
4. 다음 홉: 라우터 R2(203.0.113.1) 
5. 라우터 R2: 직접 연결된 네트워크 확인
6. ARP로 192.168.1.10의 MAC 주소 획득
7. 최종 전달 완료
```

## IP 경로와 라우팅 테이블

### 라우팅 테이블 구조
라우팅 테이블은 라우터가 패킷 전달 결정을 내리는 데 사용하는 데이터베이스입니다.

**일반적인 라우팅 테이블 항목:**
```
목적지 네트워크 | 넷마스크 | 게이트웨이 | 인터페이스 | 메트릭
-------------------------------------------------------------
0.0.0.0        | 0.0.0.0 | 10.0.0.1   | eth0       | 100    # 기본 경로
10.0.0.0       | 255.0.0.0| 0.0.0.0    | eth0       | 0      # 직접 연결
192.168.1.0    | 255.255.255.0 | 203.0.113.1 | eth1 | 10    # 정적 경로
```

**라우팅 테이블 검색 알고리즘 (최장 일치 규칙):**
1. 목적지 IP와 넷마스크를 AND 연산
2. 결과가 목적지 네트워크와 일치하는 모든 항목 찾기
3. 가장 긴 넷마스크(가장 구체적인 경로) 선택
4. 동일한 넷마스크 길이가 여러 개면 메트릭으로 결정

### 라우팅 테이블 예시
```
라우터의 라우팅 테이블:

목적지        넷마스크       게이트웨이     인터페이스
10.0.0.0      255.255.255.0  0.0.0.0       eth0
192.168.1.0   255.255.255.0  10.0.0.2      eth0
172.16.0.0    255.255.0.0    10.0.0.3      eth0
0.0.0.0       0.0.0.0        10.0.0.1      eth0    # 기본 경로

패킷 목적지: 192.168.1.100
→ 192.168.1.0/24 항목과 일치 (넷마스크 255.255.255.0)
→ 게이트웨이 10.0.0.2로 전송
```

## 서브넷 또는 클래스리스 주소 지정(CIDR) 환경에서의 IP 라우팅

CIDR(Classless Inter-Domain Routing) 환경에서는 전통적인 클래스 개념이 사라지고, 유연한 네트워크 주소 할당이 가능해졌습니다.

### CIDR 라우팅 특징
1. **가변 길이 서브넷 마스크(VLSM) 지원**: 서브넷마다 다른 마스크 사용 가능
2. **라우팅 정보 집계**: 여러 네트워크를 하나의 슈퍼넷으로 통합
3. **더 효율적인 주소 활용**: 클래스 경계에 구애받지 않음

**CIDR 표기법 예시:**
```
192.168.1.0/24  → 192.168.1.0 ~ 192.168.1.255
192.168.0.0/22  → 192.168.0.0 ~ 192.168.3.255 (1024개 주소)
10.0.0.0/8      → 10.0.0.0 ~ 10.255.255.255
```

**라우팅 집계 예시:**
```
네 개의 네트워크:
192.168.0.0/24
192.168.1.0/24  
192.168.2.0/24
192.168.3.0/24

집계 후:
192.168.0.0/22 (상위 22비트 동일)
```

## IP 멀티캐스팅

### 멀티캐스트 개요
멀티캐스트는 하나의 송신자가 특정 그룹의 여러 수신자에게 데이터를 전송하는 방식입니다.

**주소 범위:**
- **멀티캐스트 주소**: 224.0.0.0 ~ 239.255.255.255 (D 클래스)
- **예약된 멀티캐스트 주소**:
  - 224.0.0.1: 모든 호스트
  - 224.0.0.2: 모든 라우터
  - 224.0.0.5: OSPF 라우터
  - 224.0.0.9: RIPv2 라우터

### 멀티캐스트 프로토콜
1. **IGMP(Internet Group Management Protocol)**: 호스트가 멀티캐스트 그룹 가입/탈퇴
2. **멀티캐스트 라우팅 프로토콜**:
   - **PIM(Protocol Independent Multicast)**: 가장 일반적
   - **DVMRP(Distance Vector Multicast Routing Protocol)**
   - **MOSPF(Multicast OSPF)**

### 멀티캐스트 전송 모델
```
송신자 → [멀티캐스트 패킷] → 라우터
                ↓
       라우터는 멀티캐스트 라우팅 테이블 참조
                ↓
[가입한 수신자1]  [가입한 수신자2]  [미가입 수신자]
     ↓                  ↓                  ✗
데이터 수신        데이터 수신        데이터 무시
```

## 결론

IP 데이터그램의 크기 관리와 라우팅은 인터넷이 작동하는 데 있어 가장 근본적인 메커니즘입니다. MTU와 단편화는 이기종 네트워크 환경에서 데이터가 원활하게 전달될 수 있도록 보장하는 안전장치 역할을 합니다. 특히 단편화는 성능 오버헤드를 유발하므로, 현대 네트워크에서는 PMTUD(Path MTU Discovery)와 같은 기술을 통해 단편화를 최소화하는 방향으로 발전해 왔습니다.

라우팅 시스템은 인터넷을 하나의 통합된 네트워크로 만드는 핵심 기술입니다. 직접 전달과 간접 전달의 구분, 라우팅 테이블의 최장 일치 규칙, CIDR을 통한 라우팅 집계는 모두 인터넷의 확장성과 효율성을 유지하는 데 기여합니다. 특히 CIDR의 도입은 IPv4 주소 고갈 문제를 완화하고 라우팅 테이블 크기를 관리 가능한 수준으로 유지하는 데 결정적인 역할을 했습니다.

멀티캐스팅은 일대다 통신 패러다임을 실현하며, 실시간 비디오 스트리밍, 화상 회의, 소프트웨어 배포 등 현대 인터넷 서비스의 근간을 제공합니다. IGMP와 PIM 같은 프로토콜은 멀티캐스트 트리를 효율적으로 구성하고 관리하는 데 필수적입니다.

이러한 기술들은 상호 연관되어 작동합니다. 예를 들어, 라우팅 경로상의 MTU 차이는 단편화를 유발할 수 있으며, 멀티캐스트 트리 구성은 라우팅 프로토콜에 의존합니다. 따라서 네트워크 엔지니어는 개별 기술의 동작 원리를 이해하는 것뿐만 아니라, 이들이 어떻게 상호작용하는지 통합적인 시각으로 바라볼 수 있어야 합니다. 이러한 이해는 복잡한 네트워크 문제를 진단하고 최적의 솔루션을 설계하는 데 필수적인 역량입니다.