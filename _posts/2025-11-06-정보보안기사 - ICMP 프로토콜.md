---
layout: post
title: 정보보안기사 - ICMP 프로토콜
date: 2025-11-06 23:25:23 +0900
category: 정보보안기사
---
# SECTION 04 네트워크 기본 학습 — 05. ICMP 프로토콜

## 개요: ICMP는 왜 필요한가

- **역할**: IP 계층(네트워크 레이어)을 보조하는 **제어·진단 메시지** 전달. 데이터 전송 품질 개선과 **오류/혼잡 상황 전달**이 목적.
- **특징**
  - **상위 프로토콜이 아닌 IP의 “동반자”**로 간주되며, 일반적으로 **IP 프로토콜 번호 1**(IPv4)로 캡슐화된다.
  - **연결 지향/신뢰 보장 없음**. 단, 진단/제어에 필수(예: PMTUD).
  - 에러 메시지에는 **원본 IP 헤더 + 데이터 앞부분(8바이트 이상)**가 포함되어 상응하는 세션/플로우 매칭에 쓰인다.
- **보안 관점**
  - “ICMP는 위험하니까 차단”은 **오답**. **필수 타입(예: Time Exceeded, Fragmentation Needed)**를 막으면 경로 MTU 검출 실패/성능 저하/연결 장애가 발생한다.
  - 정답은 **선별 허용 + 레이트 리밋 + 로깅/가시성**.

---

## 프레임/헤더 구조

### 캡슐화 개요 (ASCII 다이어그램)

```
[ Ethernet ] -> [ IPv4 Header ] -> [ ICMP Header | ICMP Payload ]
```

### ICMPv4 헤더 공통 필드

| 필드 | 크기 | 설명 |
|---|---:|---|
| **Type** | 1B | 메시지 종류 |
| **Code** | 1B | 세부 코드 |
| **Checksum** | 2B | ICMP 전체에 대한 1의 보수 합 |
| **Rest of Header** | 4B | 타입별 의미 상이 (예: Echo의 Identifier/Sequence) |
| **Payload** | 가변 | 에러류는 “원본 IP 헤더 + 8B 데이터” 포함 |

**체크섬**(1의 보수 합) 메모:
$$
\text{Checksum} = \neg \left(\sum_{i=1}^{n} w_i \right)_{\text{1's complement}}
$$
- \(w_i\): 16비트 워드.
- 전송 중 변형(예: NAT/라우터)이 있으면 재계산.

---

## 주요 Type/Code — 요약표(IPv4)

> 시험/운영에서 **자주 언급되는 항목들에 ★ 표시**.

| Type | Code | 이름 | 용도/설명 |
|---:|---:|---|---|
| **0** | 0 | **Echo Reply** ★ | Ping 응답 |
| **3** | 0 | **Destination Unreachable – Network** | 라우팅 불가(네트워크) |
|  | 1 | **Host** | 호스트 불가 |
|  | 2 | **Protocol** | 상위 프로토콜 불가 |
|  | 3 | **Port** ★ | 포트 닫힘(UDP에 흔함) |
|  | **4** | **Fragmentation Needed** ★ | **PMTUD** 핵심(DF=1, 경로 MTU 작음) |
|  | 5 | Source Route Failed | (옵션 관련, 드묾) |
| **4** | - | Source Quench | 혼잡 제어(폐기/비활성, 사용하지 않음) |
| **5** | 0–3 | **Redirect** | 더 나은 라우터로 경로 변경(보안상 비권장) |
| **8** | 0 | **Echo Request** ★ | Ping 요청 |
| **9** | - | Router Advertisement | (과거 라우터 광고, 오늘날 ICMPv6 중심) |
| **10** | - | Router Solicitation | - |
| **11** | 0 | **Time Exceeded (TTL)** ★ | TTL=0 시 폐기(Traceroute 근간) |
|  | 1 | Fragment Reassembly Time Exceeded | 재조립 시간 초과 |
| **12** | 0 | Parameter Problem (Pointer) | 헤더 문제(잘못된 필드) |
| **13** | 0 | Timestamp Request | 시간 측정(거의 사용 안 함) |
| **14** | 0 | Timestamp Reply | - |
| **17** | 0 | Address Mask Request | 서브넷 마스크 질의(레거시) |
| **18** | 0 | Address Mask Reply | - |

---

## Echo(Ping) — 구조·동작·실무 팁

### 구조

- Type 8(Echo Request), Type 0(Echo Reply)
- Rest of Header: **Identifier(2B), Sequence Number(2B)**
- Payload: 임의 데이터(대개 타임스탬프/패턴)

### 사용 목적

- **연결성/지연(RTT) 측정**, 패킷 손실률 확인.
- **방화벽/ACL**이 ICMP를 막는 경우, Ping은 실패할 수 있으나 **연결성 자체가 없는 것은 아님**(TCP/UDP는 성공 가능).

### 예제

**Linux**
```bash
# 기본

ping 8.8.8.8
# 카운트/인터벌/타임아웃 조정

ping -c 4 -i 0.2 -W 2 1.1.1.1
# DF=1로 보내 MTU 경로 확인 (PMTUD 테스트)

ping -M do -s 1472 8.8.8.8
```

**Windows**
```cmd
ping -n 4 8.8.8.8
ping -f -l 1472 1.1.1.1   REM DF=1, 페이로드 1472
```

**PowerShell**
```powershell
Test-Connection -TargetName 8.8.8.8 -Count 4 -Quiet
```

**Wireshark 필터**
```
icmp.type == 8 or icmp.type == 0
```

---

## Traceroute/Tracert — TTL·ICMP Time Exceeded

### 원리

- **TTL 1부터 시작**해 홉마다 1씩 증가시키며 전송. 중간 라우터는 TTL=0 시 **ICMP Type 11(Code 0)**를 원발신자에게 보냄.
- 수신 측은 **응답한 라우터의 IP**를 기록하여 경로를 추적.

### 도구 차이(기본값)

- Linux `traceroute`: UDP(기본) 또는 ICMP 모드(`-I`) 가능.
- Windows `tracert`: **ICMP Echo** 기반.

**예제**
```bash
# Linux: 숫자만(-n), ICMP 모드(-I)

traceroute -n -I 1.1.1.1

# Windows

tracert -d 1.1.1.1
```

**Wireshark 필터**
```
icmp.type == 11 && icmp.code == 0
```

---

## PMTUD(Path MTU Discovery) — ICMP Type 3 Code 4

### 개념

- 송신자는 **DF=1**로 패킷을 전송. 경로상의 어떤 링크 MTU가 더 작으면 라우터가 **Destination Unreachable – Fragmentation Needed(Type 3, Code 4)**를 회신.
- 송신자는 **MSS/세그먼트 크기**를 낮춰 재전송.

### 왜 중요?

- **ICMP 차단** 시 PMTUD 실패 → **대용량 전송 정지**(TCP “블랙홀”), 애플리케이션 타임아웃.

### 실습

```bash
# 성공: 1472+8(ICMP)+20(IP)=1500

ping -M do -s 1472 8.8.8.8
# 실패: 1473 페이로드는 MTU 1500 경로에서 불가

ping -M do -s 1473 8.8.8.8
```

**Wireshark 필터**
```
icmp.type == 3 && icmp.code == 4
```

**방화벽 권장(요지)**
- **허용**: ICMP Time Exceeded, Dest Unreach(Fragmentation Needed), (선택) Echo Reply/Request(레이트 리밋).
- **차단/제한**: Redirect, Timestamp/Address Mask 등 레거시, 과도한 Echo.

---

## ICMP Redirect — 피해야 할 레거시

- **의미**: 라우터가 “더 좋은 다음 홉”을 알려주며 **호스트 라우팅 테이블**을 동적으로 바꾸도록 유도.
- **위험**: **MITM 유도/우회** 가능.
- **권장**: **수신/송신 모두 비활성**.

**Linux sysctl**
```bash
# 수신/송신 리다이렉트 비활성

sysctl -w net.ipv4.conf.all.accept_redirects=0
sysctl -w net.ipv4.conf.default.accept_redirects=0
sysctl -w net.ipv4.conf.all.send_redirects=0
sysctl -w net.ipv4.conf.default.send_redirects=0
```

---

## 기타 메시지: Parameter Problem, (폐기된) Source Quench 등

- **Parameter Problem(Type 12)**: IP 헤더 필드 오류(포인터로 문제 바이트 지시).
- **Source Quench(Type 4)**: 혼잡 제어 시그널 **폐기됨**(사용 금지).
- **Timestamp/Address Mask**: 레거시/시험용(현대 환경에서는 비활성 권장).

---

## 운영/보안 하드닝 — “막지 말고, **선별 허용**”

### Linux sysctl (핵심)

```bash
# 브로드캐스트 ping 거부(스머프 방지)

sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=1

# 허접 에러 응답 무시

sysctl -w net.ipv4.icmp_ignore_bogus_error_responses=1

# ICMP 레이트 리밋 (기본값 확인/조정)

sysctl -w net.ipv4.icmp_ratelimit=100   # ms 단위 토큰 버킷 유사
sysctl -w net.ipv4.icmp_ratemask=6168   # 어떤 타입에 적용할지 비트마스크

# Redirect 비활성(§7)

sysctl -w net.ipv4.conf.all.accept_redirects=0
sysctl -w net.ipv4.conf.all.send_redirects=0

# 소스 검증(간단 uRPF)

sysctl -w net.ipv4.conf.all.rp_filter=1
```

### nftables/iptables 예시

**nftables(권장)**
```bash
# 합리적 허용: Echo는 레이트 리밋, 핵심 에러 타입은 허용

nft add table inet filter
nft add chain inet filter input { type filter hook input priority 0; policy drop; }

# 관련 상태 허용(예시)

nft add rule inet filter input ct state established,related accept

# Echo: 초당 10개로 제한

nft add rule inet filter input icmp type echo-request limit rate 10/second accept
nft add rule inet filter input icmp type echo-request drop

# Time Exceeded / Frag Needed 허용

nft add rule inet filter input icmp type time-exceeded accept
nft add rule inet filter input icmp type destination-unreachable accept

# 기타는 필요시 화이트리스트

```

**iptables**
```bash
# Echo 요청 10/s 허용, 초과 드롭

iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 10/second -j ACCEPT
iptables -A INPUT -p icmp --icmp-type echo-request -j DROP

# PMTUD/Traceroute용 허용

iptables -A INPUT -p icmp --icmp-type time-exceeded -j ACCEPT
iptables -A INPUT -p icmp --icmp-type fragmentation-needed -j ACCEPT
iptables -A INPUT -p icmp --icmp-type destination-unreachable -j ACCEPT
```

### 라우터/방화벽(예: IOS) ACL 힌트

```
ip access-list extended ICMP-PERMIT-ESSENTIAL
 permit icmp any any time-exceeded
 permit icmp any any unreachable
 deny   icmp any any redirect
 permit icmp any any echo-reply
 remark echo-request는 관리망/모니터링망에서만 허용
```

**운영 요점**
- **서버 인바운드 Echo**는 기본 거부 + **관리망**에서만 허용.
- **PMTUD 관련**: **Type 3 Code 4**와 **Type 11**은 **반드시 허용**(경계/서버).

---

## 탐지/가시성 — tcpdump·Wireshark·로그

**tcpdump**
```bash
# 모든 ICMP

sudo tcpdump -nni any icmp

# Echo만

sudo tcpdump -nni eth0 "icmp[0] == 8 or icmp[0] == 0"

# PMTUD (Frag Needed)

sudo tcpdump -nni eth0 "icmp[0] == 3 and icmp[1] == 4"

# Traceroute(Time Exceeded)

sudo tcpdump -nni eth0 "icmp[0] == 11 and icmp[1] == 0"
```

**Wireshark 디스플레이**
```
icmp
icmp.type == 8 || icmp.type == 0
icmp.type == 3 && icmp.code == 4
icmp.type == 11 && icmp.code == 0
```

**이상 징후**
- **Ping Sweep**: 짧은 시간, 연속된 주소 범위로 Echo Request → NetFlow/IPFIX에서 “단명 플로우 다량+ICMP Echo” 패턴.
- **Smurf(과거)**: 브로드캐스트 대상으로 Echo Request를 보내 다수 호스트가 피해자에게 Echo Reply → 오늘날 **디렉티드 브로드캐스트 차단**으로 현저히 줄었음.
- **ICMP 기반 은닉 채널**: Echo payload에 데이터 삽입. 탐지: **비정상 패턴/길이**, 고정 간격, 내부→외부 단일 호스트로 향하는 Echo 빈발 등.

---

## NAT와 ICMP — 주의사항

- NAT 장비는 **ICMP 에러 메시지 페이로드의 “내부 원본 IP 헤더”**를 참조/변환해야 **세션 상태**가 맞는다.
- **문제 패턴**: 외부 서버에서 내부 클라이언트로 오는 **Unreachable/Frag Needed**가 NAT/방화벽에서 드롭 → PMTUD 실패.
- **운영 팁**: 경계 NAT/방화벽에서 **관련 ICMP 에러**를 **RELATED**로 간주하여 허용(Conntrack), **로그/레이트 리밋** 적용.

---

## 실습 시나리오(안전/합법 환경)

> 모든 실습은 **사설 랩**에서만. 제3자 네트워크에 공격성 트래픽을 보내지 않는다.

### 랩 A — “Ping/Traceroute 가시성”

1) 서버와 라우터 사이에 `tcpdump` 캡처.
2) 클라이언트에서 `ping -c 5`, `traceroute -I` 실행.
3) 캡처에서 Type 8/0, Type 11을 식별하고 **RTT/홉별 응답**을 기록.

```bash
sudo tcpdump -nni eth0 icmp -w icmp_labA.pcap
ping -c 5 192.168.10.1
traceroute -I -n 8.8.8.8
```

### 랩 B — “PMTUD 동작 확인”

1) 경계에 GRE/IPSec 터널 구성(오버헤드로 경로 MTU 하락 가정).
2) `ping -M do -s` 크기를 늘려가며 최초 실패 지점 기록.
3) Wireshark에서 **Type 3 Code 4** 패킷의 `Next-Hop MTU`(있는 경우) 필드 확인.

### 랩 C — “ICMP 하드닝 효과”

1) 서버에서 **Echo 요청 레이트 리밋** 설정(iptables/nftables).
2) 모니터 VM에서 초당 수백 개 `ping`(랩 내부 전용) → 서버에서 제한 동작/로그 확인.
3) **Time Exceeded/Frag Needed**는 정상 허용되는지 재확인.

---

## 체크리스트(운영 표준)

- [ ] **ICMP 전면 차단 금지**: PMTUD/Traceroute 필수 타입 허용(§6).
- [ ] **Echo 요청 인바운드**: 서버에는 기본 거부, **관리망**/모니터링 노드에서만 허용(레이트 리밋).
- [ ] **Redirect**: 수신/송신 **모두 비활성**(§7).
- [ ] **브로드캐스트 Echo 무시**: `icmp_echo_ignore_broadcasts=1`.
- [ ] **레이트 리밋**: `icmp_ratelimit`, 방화벽 레이트 리밋 규칙 적용.
- [ ] **NAT/경계**: ICMP 에러 RELATED 허용, 로깅/관제.
- [ ] **가시성**: tcpdump/Wireshark 필터, NetFlow/IPFIX로 **스윕/플러드** 탐지.
- [ ] **문서화**: 허용 타입/코드 표, 변경관리/예외 승인 절차.

---

## 자주 묻는 질문(FAQ)

**Q1. ICMP를 모두 차단하면 안전해지나요?**
A. 아니오. PMTUD/Traceroute/오류 보고가 모두 **망가져** 오히려 장애/성능 저하를 초래한다. **선별 허용**이 정석.

**Q2. 어떤 타입을 꼭 허용해야 하나요?**
A. **Time Exceeded(Type 11)**, **Dest Unreach – Frag Needed(Type 3/4)**. 필요 시 **Port Unreachable(Type 3/3)**도 진단에 유용.

**Q3. Echo는 꼭 허용해야 하나요?**
A. 서버 인바운드는 **관리망 한정 + 레이트 리밋** 권장. 외부 전체 허용은 불필요.

**Q4. ICMP Redirect는 왜 위험하죠?**
A. 호스트 라우팅 테이블을 **원격에서 조작**하게 만들어 MITM/우회 가능. 현대 환경에서는 **비활성**이 표준.

---

## 예상 문제(필기/실무)

1) **ICMP 에러 메시지**에 원본 패킷의 어느 부분이 포함되며, 그 이유는 무엇인가?
2) **PMTUD**의 동작을 **Type/Code**와 함께 설명하고, 방화벽에서 필요한 허용 규칙을 쓰라.
3) **Traceroute**가 ICMP를 어떻게 활용하는지, Linux/Windows 기본 차이를 포함해 설명하라.
4) **ICMP Redirect**의 동작과 보안상 위험, 시스템 레벨에서의 차단 설정을 제시하라.
5) 서버 인바운드 Echo를 제한하면서도 **연결 진단** 기능을 유지하는 **방화벽 정책** 예시를 작성하라.
6) **Smurf 공격**의 원리와, 현대 네트워크에서 이 공격이 잘 통하지 않는 이유를 기술하라.

---

## 부록 — 스니펫 모음

```bash
# Linux: sysctl 일괄 (권장값 샘플)

sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=1
sysctl -w net.ipv4.icmp_ignore_bogus_error_responses=1
sysctl -w net.ipv4.icmp_ratelimit=100
sysctl -w net.ipv4.conf.all.accept_redirects=0
sysctl -w net.ipv4.conf.all.send_redirects=0
sysctl -w net.ipv4.conf.all.rp_filter=1
```

```bash
# nftables: Echo 리밋 + PMTUD/Traceroute 허용

nft add table inet filter
nft add chain inet filter input { type filter hook input priority 0; policy drop; }
nft add rule inet filter input ct state established,related accept
nft add rule inet filter input icmp type echo-request limit rate 10/second accept
nft add rule inet filter input icmp type time-exceeded accept
nft add rule inet filter input icmp type destination-unreachable accept
```

```bash
# tcpdump: 흔한 진단 필터

sudo tcpdump -nni any "icmp"
sudo tcpdump -nni any "icmp[0] == 3 and icmp[1] == 4"   # Frag Needed
sudo tcpdump -nni any "icmp[0] == 11"                   # Time Exceeded
```

```powershell
# PowerShell: Ping/Traceroute 대체

Test-Connection 1.1.1.1 -Count 4
tracert -d 8.8.8.8
```

---

## 결론

- ICMP는 **IPv4 운영의 신경계**다. **에러 보고/경로 탐색/MTU 조정**에 필수적이므로 **무조건 차단**은 금물.
- 올바른 전략은 **핵심 타입/코드 허용 + Echo 제한 + Redirect 금지 + 레이트 리밋 + 가시성 확보**다.
