---
layout: post
title: AWS - S3 + KMS
date: 2025-08-03 21:20:23 +0900
category: AWS
---
# S3 + KMS 권한 정책 완전 예제

## 목표/구성 시나리오(재정의)

- **S3 버킷**: `my-secure-bucket`
- **KMS CMK(고객관리형 키)**: `arn:aws:kms:ap-northeast-2:123456789012:key/abcd-efgh-ijkl`
- **IAM Role**: `DataUploaderRole` (EC2, Lambda 등 애플리케이션에서 사용)
- **보안 요구사항**
  1) `DataUploaderRole`만 업로드/다운로드 가능
  2) 업로드는 **반드시 SSE-KMS**(지정 키)로 암호화
  3) 해당 **KMS 키는 DataUploaderRole만 사용**
  4) 제3자 사용자/역할 접근 금지
  5) 암호화 누락/평문 전송/공개 설정 등 **오구성 우회 불가**

---

## S3 버킷 선행 보안 설정

### S3 Block Public Access (BPA)

버킷/계정 차원 BPA **모두 활성화** (정책 우회로를 사전에 차단).

```bash
aws s3control put-public-access-block \
  --account-id 123456789012 \
  --public-access-block-configuration \
'{
  "BlockPublicAcls": true,
  "IgnorePublicAcls": true,
  "BlockPublicPolicy": true,
  "RestrictPublicBuckets": true
}'
```

### 소유권 강제(Object Ownership)

버킷 소유자 강제(Bucket owner enforced)로 ACL 이슈 제거.

```bash
aws s3api put-bucket-ownership-controls \
  --bucket my-secure-bucket \
  --ownership-controls '{
    "Rules":[{"ObjectOwnership":"BucketOwnerEnforced"}]
  }'
```

### 버킷 기본 암호화(Default Encryption) + S3 Bucket Keys(비용절감)

기본 암호화를 **지정 KMS 키**로, S3 Bucket Keys는 **활성화**.

```bash
aws s3api put-bucket-encryption \
  --bucket my-secure-bucket \
  --server-side-encryption-configuration '{
    "Rules":[
      {
        "ApplyServerSideEncryptionByDefault":{
          "SSEAlgorithm": "aws:kms",
          "KMSMasterKeyID": "arn:aws:kms:ap-northeast-2:123456789012:key/abcd-efgh-ijkl"
        },
        "BucketKeyEnabled": true
      }
    ]
  }'
```

> Bucket Keys는 요청당 KMS 호출을 줄여 비용을 낮춘다.

---

## 버킷 정책(강화판)

### 필수 조건을 모두 포함한 정책

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowPutObjectWithSpecificKmsByRole",
      "Effect": "Allow",
      "Principal": { "AWS": "arn:aws:iam::123456789012:role/DataUploaderRole" },
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::my-secure-bucket/*",
      "Condition": {
        "StringEquals": {
          "s3:x-amz-server-side-encryption": "aws:kms",
          "s3:x-amz-server-side-encryption-aws-kms-key-id": "arn:aws:kms:ap-northeast-2:123456789012:key/abcd-efgh-ijkl"
        }
      }
    },
    {
      "Sid": "AllowGetObjectByRole",
      "Effect": "Allow",
      "Principal": { "AWS": "arn:aws:iam::123456789012:role/DataUploaderRole" },
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::my-secure-bucket/*"
    },
    {
      "Sid": "AllowListBucketByRole",
      "Effect": "Allow",
      "Principal": { "AWS": "arn:aws:iam::123456789012:role/DataUploaderRole" },
      "Action": "s3:ListBucket",
      "Resource": "arn:aws:s3:::my-secure-bucket"
    },

    /* 보안 강제 Deny (우선 적용) */
    {
      "Sid": "DenyUnEncryptedUploads",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::my-secure-bucket/*",
      "Condition": {
        "StringNotEquals": { "s3:x-amz-server-side-encryption": "aws:kms" }
      }
    },
    {
      "Sid": "DenyWrongKmsKey",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::my-secure-bucket/*",
      "Condition": {
        "StringNotEquals": {
          "s3:x-amz-server-side-encryption-aws-kms-key-id": "arn:aws:kms:ap-northeast-2:123456789012:key/abcd-efgh-ijkl"
        }
      }
    },
    {
      "Sid": "DenyInsecureTransport",
      "Effect": "Deny",
      "Principal": "*",
      "Action": ["s3:*"],
      "Resource": [
        "arn:aws:s3:::my-secure-bucket",
        "arn:aws:s3:::my-secure-bucket/*"
      ],
      "Condition": { "Bool": { "aws:SecureTransport": "false" } }
    }
  ]
}
```

#### 해설 포인트

- **Allow** 는 오직 `DataUploaderRole` 에 제한
- **Deny** 블록 3종:
  - **암호화 미지정 업로드 차단**
  - **다른 KMS 키 사용 차단**
  - **HTTPS 미사용(전송 암호화 미적용) 차단**
- 필요 시 **VPC 엔드포인트 제한**도 추가 가능(아래 2.2 참고)

### VPC 엔드포인트 한정(옵션)

사내망에서만 접근시키려면 다음 Deny 추가(인터넷경로 차단):

```json
{
  "Sid": "DenyRequestsNotFromSpecificVPCE",
  "Effect": "Deny",
  "Principal": "*",
  "Action": "s3:*",
  "Resource": [
    "arn:aws:s3:::my-secure-bucket",
    "arn:aws:s3:::my-secure-bucket/*"
  ],
  "Condition": {
    "StringNotEquals": {
      "aws:sourceVpce": "vpce-0abc123def456"
    }
  }
}
```

---

## KMS 키 정책(강화판)

**핵심:** KMS 키는 **누가** 사용할 수 있는지, **어떤 서비스 경유**만 허용할지 세밀히 제어.

```json
{
  "Version": "2012-10-17",
  "Id": "key-policy-s3-kms",
  "Statement": [
    {
      "Sid": "KeyAdmins",
      "Effect": "Allow",
      "Principal": { "AWS": "arn:aws:iam::123456789012:root" },
      "Action": "kms:*",
      "Resource": "*"
    },
    {
      "Sid": "AllowAppRoleUseKey",
      "Effect": "Allow",
      "Principal": { "AWS": "arn:aws:iam::123456789012:role/DataUploaderRole" },
      "Action": [
        "kms:Encrypt",
        "kms:Decrypt",            // 필요 시 다운로드/서버측 복호화가 일어날 수 있으므로 명시
        "kms:ReEncrypt*",
        "kms:GenerateDataKey*",
        "kms:DescribeKey"
      ],
      "Resource": "*",
      "Condition": {
        "StringEquals": {
          "kms:ViaService": "s3.ap-northeast-2.amazonaws.com",
          "aws:PrincipalAccount": "123456789012"
        }
      }
    }
  ]
}
```

#### 해설 포인트

- `kms:ViaService` 로 **S3 경유 사용만 허용** → 다른 서비스/직접 Encrypt 오남용 차단
- `aws:PrincipalAccount` 로 **동일 계정 주체**만 허용(교차계정 필요 시 별도 섹션 참고)
- 운영상 `kms:Decrypt` 가 꼭 필요한가 판단(일반 SSE-KMS 다운로드 경로는 S3가 KMS를 호출해 복호화)

> 더 촘촘히 하려면 `kms:EncryptionContext` 제약(예: `aws:s3:arn` 이 해당 버킷/오브젝트 경로일 때만 허용)을 검토한다.

---

## IAM Role 정책(최소 권한)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "S3Access",
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::my-secure-bucket",
        "arn:aws:s3:::my-secure-bucket/*"
      ]
    },
    {
      "Sid": "KmsUseSpecificKey",
      "Effect": "Allow",
      "Action": [
        "kms:Encrypt",
        "kms:Decrypt",
        "kms:ReEncrypt*",
        "kms:GenerateDataKey*",
        "kms:DescribeKey"
      ],
      "Resource": "arn:aws:kms:ap-northeast-2:123456789012:key/abcd-efgh-ijkl"
    }
  ]
}
```

---

## 업로드/다운로드 코드 예제

### AWS CLI 업로드(키 강제 지정)

```bash
aws s3 cp file.txt s3://my-secure-bucket/ \
  --sse aws:kms \
  --sse-kms-key-id arn:aws:kms:ap-northeast-2:123456789012:key/abcd-efgh-ijkl
```

### Python Boto3 업로드/다운로드

```python
import boto3

s3 = boto3.client('s3')

# 업로드 (SSE-KMS 지정)

s3.put_object(
    Bucket='my-secure-bucket',
    Key='docs/file.txt',
    Body=b'Hello Secure World!',
    ServerSideEncryption='aws:kms',
    SSEKMSKeyId='arn:aws:kms:ap-northeast-2:123456789012:key/abcd-efgh-ijkl'
)

# 다운로드 (정상 권한/정책이면 S3가 내부적으로 KMS와 연동해 복호화 수행)

obj = s3.get_object(Bucket='my-secure-bucket', Key='docs/file.txt')
print(obj['Body'].read())
```

### 멀티파트 업로드(중요 헤더)

멀티파트 업로드는 **Initiate/UploadPart** 단계 모두 SSE 헤더 강제가 필요.
버킷 정책의 Deny가 없으면 일부 파트가 암호화 없이 올라갈 수 있어 반드시 차단 규칙을 둔다(본 가이드의 Deny가 그 역할).

```bash
aws s3api create-multipart-upload \
  --bucket my-secure-bucket \
  --key big.bin \
  --server-side-encryption aws:kms \
  --ssekms-key-id arn:aws:kms:ap-northeast-2:123456789012:key/abcd-efgh-ijkl
# 이후 upload-part 호출 시에도 동일 SSE 헤더를 사용(클라이언트/SDK가 처리)

```

---

## 교차계정 액세스(옵션)

### 교차계정 시나리오

- 버킷: **Account A**
- 업로더 역할: **Account B**
- KMS 키: **Account A**(버킷과 동일)

구성 포인트:
1) **버킷 정책**: `Principal` 에 **Account B의 역할 ARN** 허용
2) **KMS 키 정책**: `Principal` 을 Account B의 역할로 추가,
   그리고 `aws:SourceAccount` 또는 `aws:PrincipalAccount` 조건으로 제어
3) 가능하면 `kms:ViaService` 로 S3만 허용

### KMS 키 정책(교차계정 예)

```json
{
  "Sid": "AllowCrossAccountRoleUseKeyViaS3",
  "Effect": "Allow",
  "Principal": { "AWS": "arn:aws:iam::222222222222:role/CrossUploaderRole" },
  "Action": [ "kms:Encrypt", "kms:Decrypt", "kms:GenerateDataKey*", "kms:DescribeKey" ],
  "Resource": "*",
  "Condition": {
    "StringEquals": {
      "kms:ViaService": "s3.ap-northeast-2.amazonaws.com"
    }
  }
}
```

---

## S3 객체의 KMS 키 변경(재암호화) — 운영 패턴

### S3 Copy로 SSE-KMS 키 교체(서버사이드)

S3 내부 Copy(또는 S3 Batch Operations)를 사용:

```bash
aws s3api copy-object \
  --bucket my-secure-bucket \
  --copy-source my-secure-bucket/docs/file.txt \
  --key docs/file.txt \
  --server-side-encryption aws:kms \
  --ssekms-key-id arn:aws:kms:ap-northeast-2:123456789012:key/NEW-KEY-ID
```

- 대량 전환: **S3 Inventory + S3 Batch Operations**.
- 애플리케이션 EDK(Encrypted Data Key)를 사용하는 **클라이언트측 Envelope** 패턴이면 **KMS ReEncrypt**(EDK만 교체) 접근이 더 효율적(데이터 본문 재쓰기 불필요).

---

## Presigned URL과 SSE-KMS

Presigned PUT/GET을 사용할 때도 **SSE-KMS 헤더가 포함**되어야 하며, 서명 시점의 요청 헤더와 사용 시점이 **완전히 일치**해야 한다.
또한 버킷 정책의 Deny 규칙과 충돌하지 않도록 해야 한다.

- PUT Presign 시 헤더 포함 예: `x-amz-server-side-encryption: aws:kms`, `x-amz-server-side-encryption-aws-kms-key-id: <키 ARN>`
- 클라이언트 업로드 호출 시 **동일 헤더** 전달 필수

---

## 모니터링/감사/비용

- **CloudTrail**: `kms:Encrypt/Decrypt/GenerateDataKey` 호출 로그 감시
- **S3 서버 접근 로그 또는 CloudTrail data event**: 누가 어떤 객체를 Put/Get 했는지 감사
- **S3 Storage Class/Lifecycle + Intelligent-Tiering**: 저장비용 최적화
- **S3 Bucket Keys** 활성화로 KMS 호출 비용 절감

> 간이 비용식(아이디어):
> $$
> \text{월 KMS비용} \approx (\text{요청수}) \times \text{KMS요청단가} + (\text{키 수}) \times \text{월 키비용}
> $$

---

## 트러블슈팅(에러별 원인/해결)

| 증상/에러 | 원인 | 해결 |
|---|---|---|
| `AccessDenied`(S3 Put/Get) | Principal 불일치, 버킷 정책 Deny 우선 | 버킷 정책의 Allow/Deny 조건과 IAM Role ARN 정확히 검증 |
| `InvalidArgument: SSE params missing` | 멀티파트 initiate/part에 SSE 누락 | 클라이언트 코드/SDK가 **모든 단계에 SSE 헤더** 포함하도록 보정 |
| `AccessDeniedException`(KMS) | 키 정책 혹은 IAM 정책에 권한 미부여 | `kms:Encrypt/Decrypt/GenerateDataKey*` 및 `kms:ViaService` 조건 검토 |
| Presigned PUT 실패 | 서명 시점의 헤더 ≠ 사용 시점 헤더 | Presign 생성 코드와 실제 업로더가 동일 헤더 사용 보장 |
| `S3 Copy` 로 키 변경 실패 | 대상 KMS 키 사용 권한 부재 | 대상 KMS 키 정책에 버킷/역할을 허용하고 버킷 정책 Deny 충돌 제거 |

---

## IaC 스니펫(옵션)

### Terraform(요지)

```hcl
resource "aws_kms_key" "cmk" {
  description         = "S3 CMK"
  enable_key_rotation = true
  policy              = file("kms-policy.json")
}

resource "aws_s3_bucket" "secure" {
  bucket = "my-secure-bucket"
}

resource "aws_s3_bucket_server_side_encryption_configuration" "default" {
  bucket = aws_s3_bucket.secure.id
  rule {
    apply_server_side_encryption_by_default {
      kms_master_key_id = aws_kms_key.cmk.arn
      sse_algorithm     = "aws:kms"
    }
    bucket_key_enabled = true
  }
}
```

---

## 종합 체크리스트

- [ ] **BPA**(Block Public Access) 전부 활성화
- [ ] **ObjectOwnership=BucketOwnerEnforced**
- [ ] 기본 암호화(SSE-KMS) + **Bucket Keys** 활성화
- [ ] 버킷 정책: **Allow 최소화**, **Deny(암호화/키/HTTPS)** 우선 적용
- [ ] KMS 키 정책: **ViaService=S3**, **PrincipalAccount 제한**, 필요 시 EncryptionContext 조건
- [ ] IAM Role: **최소 권한**(s3:Put/Get/List + 지정 CMK에 kms 권한)
- [ ] 멀티파트 업로드: **모든 단계 SSE 헤더**
- [ ] Presigned URL: **헤더 일치**
- [ ] CloudTrail/감사/비용 모니터링

---

## 부록: “조합형” 정책 템플릿(즉시 사용)

### 버킷 정책(템플릿)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    { "Sid": "AllowPutByAppRoleWithKMS", "Effect": "Allow",
      "Principal": { "AWS": "arn:aws:iam::123456789012:role/DataUploaderRole" },
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::my-secure-bucket/*",
      "Condition": {
        "StringEquals": {
          "s3:x-amz-server-side-encryption": "aws:kms",
          "s3:x-amz-server-side-encryption-aws-kms-key-id": "arn:aws:kms:ap-northeast-2:123456789012:key/abcd-efgh-ijkl"
        }
      }
    },
    { "Sid": "AllowGetByAppRole", "Effect": "Allow",
      "Principal": { "AWS": "arn:aws:iam::123456789012:role/DataUploaderRole" },
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::my-secure-bucket/*"
    },
    { "Sid": "AllowListByAppRole", "Effect": "Allow",
      "Principal": { "AWS": "arn:aws:iam::123456789012:role/DataUploaderRole" },
      "Action": "s3:ListBucket",
      "Resource": "arn:aws:s3:::my-secure-bucket"
    },

    /* Hard Denies */
    { "Sid": "DenyNoSSE", "Effect": "Deny",
      "Principal": "*", "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::my-secure-bucket/*",
      "Condition": { "StringNotEquals": { "s3:x-amz-server-side-encryption": "aws:kms" } }
    },
    { "Sid": "DenyWrongKey", "Effect": "Deny",
      "Principal": "*", "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::my-secure-bucket/*",
      "Condition": { "StringNotEquals": {
        "s3:x-amz-server-side-encryption-aws-kms-key-id":
        "arn:aws:kms:ap-northeast-2:123456789012:key/abcd-efgh-ijkl" } }
    },
    { "Sid": "DenyIfNotTLS", "Effect": "Deny",
      "Principal": "*", "Action": "s3:*",
      "Resource": [ "arn:aws:s3:::my-secure-bucket", "arn:aws:s3:::my-secure-bucket/*" ],
      "Condition": { "Bool": { "aws:SecureTransport": "false" } }
    }
  ]
}
```

### KMS 키 정책(템플릿)

```json
{
  "Version": "2012-10-17",
  "Id": "s3-kms-template",
  "Statement": [
    { "Sid": "Admins", "Effect": "Allow",
      "Principal": { "AWS": "arn:aws:iam::123456789012:root" },
      "Action": "kms:*", "Resource": "*" },

    { "Sid": "AppRoleUseViaS3Only", "Effect": "Allow",
      "Principal": { "AWS": "arn:aws:iam::123456789012:role/DataUploaderRole" },
      "Action": [ "kms:Encrypt", "kms:Decrypt", "kms:ReEncrypt*", "kms:GenerateDataKey*", "kms:DescribeKey" ],
      "Resource": "*",
      "Condition": {
        "StringEquals": { "kms:ViaService": "s3.ap-northeast-2.amazonaws.com" },
        "StringLike": { "kms:EncryptionContext:aws:s3:arn": "arn:aws:s3:::my-secure-bucket/*" }
      }
    }
  ]
}
```

> `kms:EncryptionContext:aws:s3:arn` 제약은 S3가 KMS 호출 시 전달하는 컨텍스트와 맞아야 한다.
> 리전/버킷/키 ARN은 환경에 맞게 치환.

---

## 결론

- **핵심 요지**: S3와 KMS를 **함께** 설계해야 “암호화 강제 + 세분 권한 + 우회 차단”이 완성된다.
- **정책 3종 세트**(버킷 정책 / KMS 키 정책 / IAM Role 정책)를 **정합성 있게** 구성하고, **Deny 우선** 전략으로 오구성 우회 경로를 차단하라.
- 운영에서는 **멀티파트·Presign 헤더 일치**, **S3 Bucket Keys(비용절감)**, **CloudTrail 감사**, **S3 Batch 재암호화** 등 **현장 이슈**를 포함해 설계해야 한다.
