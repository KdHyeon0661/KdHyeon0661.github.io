---
layout: post
title: AWS - S3 + KMS
date: 2025-08-03 21:20:23 +0900
category: AWS
---
# S3 + KMS 권한 정책 완전 예제

AWS S3에 데이터를 저장할 때, **서버 측 암호화(Server-Side Encryption, SSE)**를 사용하면 저장된 객체를 안전하게 보호할 수 있습니다.  
특히 **AWS KMS(Key Management Service)**와 함께 사용하면, 키를 직접 관리하고 세부적인 권한 제어까지 가능합니다.

---

## 1. 구성 시나리오

이번 예제에서는 다음 조건을 만족하는 **S3 + KMS 연동** 환경을 만듭니다.

- **S3 버킷**: `my-secure-bucket`
- **KMS Customer Managed Key(CMK)**: `arn:aws:kms:ap-northeast-2:123456789012:key/abcd-efgh-ijkl`
- **IAM Role**: `DataUploaderRole` (EC2 또는 Lambda에서 사용)
- **요구사항**:
  1. `DataUploaderRole`만 S3에 업로드 가능
  2. 업로드 시 **반드시 KMS 키로 암호화**
  3. KMS 키는 `DataUploaderRole`만 사용할 수 있음
  4. 다른 사용자는 읽기/쓰기 금지

---

## 2. S3 버킷 정책

버킷 정책에서 **SSE-KMS 강제 적용**과 **IAM Role 제한**을 설정합니다.

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowPutObjectWithKMSEncryption",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:role/DataUploaderRole"
      },
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::my-secure-bucket/*",
      "Condition": {
        "StringEquals": {
          "s3:x-amz-server-side-encryption": "aws:kms",
          "s3:x-amz-server-side-encryption-aws-kms-key-id": "arn:aws:kms:ap-northeast-2:123456789012:key/abcd-efgh-ijkl"
        }
      }
    },
    {
      "Sid": "AllowGetObject",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:role/DataUploaderRole"
      },
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::my-secure-bucket/*"
    },
    {
      "Sid": "DenyUnEncryptedUploads",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::my-secure-bucket/*",
      "Condition": {
        "StringNotEquals": {
          "s3:x-amz-server-side-encryption": "aws:kms"
        }
      }
    }
  ]
}
```

### 주요 포인트
- `Condition`을 이용해 **KMS 키 ID**를 강제로 지정 (`s3:x-amz-server-side-encryption-aws-kms-key-id`)
- 암호화 옵션 없이 업로드하면 **Deny**
- **Principal**에 IAM Role만 지정 → 다른 사용자 접근 불가

---

## 3. KMS 키 정책

KMS 키 정책에서 이 키를 사용할 수 있는 주체를 **DataUploaderRole**로 제한합니다.

```json
{
  "Version": "2012-10-17",
  "Id": "key-policy-s3",
  "Statement": [
    {
      "Sid": "AllowKeyAdministration",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:root"
      },
      "Action": [
        "kms:*"
      ],
      "Resource": "*"
    },
    {
      "Sid": "AllowUseOfKeyForUploaderRole",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:role/DataUploaderRole"
      },
      "Action": [
        "kms:Encrypt",
        "kms:Decrypt",
        "kms:ReEncrypt*",
        "kms:GenerateDataKey*",
        "kms:DescribeKey"
      ],
      "Resource": "*"
    }
  ]
}
```

### 주요 포인트
- `kms:Encrypt`, `kms:Decrypt` 등 **S3 암호화/복호화에 필요한 권한**만 부여
- 키 관리는 `root` 계정에서만 가능하도록 분리
- 다른 IAM 사용자나 역할에는 권한 부여하지 않음

---

## 4. IAM Role 정책

`DataUploaderRole`이 S3에 접근할 수 있도록 IAM 정책을 부여합니다.

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject"
      ],
      "Resource": "arn:aws:s3:::my-secure-bucket/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "kms:Encrypt",
        "kms:Decrypt",
        "kms:ReEncrypt*",
        "kms:GenerateDataKey*",
        "kms:DescribeKey"
      ],
      "Resource": "arn:aws:kms:ap-northeast-2:123456789012:key/abcd-efgh-ijkl"
    }
  ]
}
```

---

## 5. 업로드 명령 예시

### AWS CLI로 업로드 (KMS 지정)
```bash
aws s3 cp file.txt s3://my-secure-bucket/ \
  --sse aws:kms \
  --sse-kms-key-id arn:aws:kms:ap-northeast-2:123456789012:key/abcd-efgh-ijkl
```

### Python Boto3 예제
```python
import boto3

s3 = boto3.client('s3')
s3.put_object(
    Bucket='my-secure-bucket',
    Key='file.txt',
    Body=b'Hello Secure World!',
    ServerSideEncryption='aws:kms',
    SSEKMSKeyId='arn:aws:kms:ap-northeast-2:123456789012:key/abcd-efgh-ijkl'
)
```

---

## 6. 보안 모범 사례

1. **KMS 키와 S3 버킷 정책을 함께 사용**  
   → 하나만 설정하면 우회 가능성이 존재  
2. **Deny 규칙 우선 적용**  
   → 암호화 없이 업로드 시 무조건 차단  
3. **IAM Role 최소 권한 부여**  
   → 불필요한 S3, KMS 권한 제거  
4. **CloudTrail 활성화**  
   → KMS 키 사용 기록 및 S3 접근 로그 추적  
5. **키 회전(Key Rotation)**  
   → KMS의 자동 키 회전 활성화

---

## 7. 결론

S3와 KMS를 결합하면 **저장 데이터 암호화 + 세밀한 접근 제어**가 동시에 가능합니다.  
하지만 S3 정책, KMS 정책, IAM 정책을 함께 설계해야 **보안이 완전해집니다**.  
특히 `Condition`을 활용해 *반드시 KMS로 암호화*하도록 강제하는 것이 핵심입니다.