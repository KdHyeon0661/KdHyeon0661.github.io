---
layout: post
title: MFC - 레지스트리, INI, 앱 데이터 폴더 구조
date: 2025-08-26 15:25:23 +0900
category: MFC
---
# 파일/설정 저장: 레지스트리, INI, 앱 데이터 폴더 구조 (MFC 관점 총정리)

이 글은 **MFC 애플리케이션의 설정/상태**를 어디에, 어떻게 저장할지에 대한 **실전 가이드**입니다.  
대상: MFC `CWinApp`/`CWinAppEx` 기반 앱(대화상자/SDI/MDI 모두), Windows 10/11 환경.

---

## 0) 한눈에 보는 선택 기준

| 상황 | 추천 저장소 | 이유/메모 |
|---|---|---|
| **개인별(사용자별) 설정** (테마, 최근 파일, 창 위치 등) | **레지스트리 HKCU** 또는 **`%APPDATA%`(Roaming)** | 계정별 격리/프로필 로밍(AD/도메인) |
| **캐시/썸네일/큰 임시 데이터** | **`%LOCALAPPDATA%`(Local)** | 용량 큼, 로밍 불필요 |
| **머신 전체 설정(모든 사용자 공통)** | **`%PROGRAMDATA%`** 또는 **레지스트리 HKLM(관리자 권한 필요)** | 시스템 범위, 배포·정책과 궁합 |
| **휴대/외부 편집이 쉬운 텍스트 설정** | **INI/JSON 파일(앱 데이터 하위)** | 백업/이식성, 형상관리 친화 |
| **UI 상태 자동 저장(MFC Feature Pack의 도킹/리본 등)** | **레지스트리 HKCU** | MFC가 레지스트리 기반 헬퍼 제공 |

> 원칙: **코드/실행 파일 폴더(Program Files)** 에 쓰려고 하지 마세요(UAC로 차단/가상화).  
> 사용자 데이터는 **사용자 폴더**, 시스템 전역은 **ProgramData/HKLM**에 둡니다.

---

## 1) 레지스트리(Registry)

### 1-1. 기본 개념
- **HKCU**(HKEY_CURRENT_USER): 현재 로그인 사용자 **개인 영역**. 앱 설정에 가장 일반적.
- **HKLM**(HKEY_LOCAL_MACHINE): **머신 전역**(관리자 권한 필요). 정책/라이선스·서비스 설정에 사용.
- MFC의 `GetProfile…/WriteProfile…` 계열은 **레지스트리/INI를 추상화**합니다.  
  - `SetRegistryKey(L"회사명")`을 호출하면 **레지스트리 사용 모드**로 전환(권장).
  - 경로 관례(개념): `HKCU\Software\<회사명>\<앱명 or 프로파일명>\…`

### 1-2. 장점/단점
- **장점**: 트랜잭션성(상대적으로 안전), 빠른 조회, 접근 제어(ACL), UI 상태 자동 저장 기능들과 궁합.
- **단점**: 외부 편집/백업을 사용자에게 노출하기 어렵고, **설정 이식**(다른 PC로 복사)이 번거로울 수 있음.

### 1-3. 키/값 설계 팁
- **키 구조 예시(개념)**  
  ```
  HKCU\Software\Acme\PhotoTool\
      Settings\
          Theme = "Dark"
          Language = "ko-KR"
          RecentFiles = "C:\A.jpg;C:\B.jpg"
      UI\
          MainWindow\Pos = "x=120,y=80,w=1280,h=800"
          Ribbon\State = <바이너리>
  ```
- **값 타입**: 문자열(REG_SZ), 숫자(REG_DWORD/QWORD), 바이너리(REG_BINARY) 등 **의도에 맞게** 사용.
- **버전 마이그레이션**: `ConfigVersion` 값을 두고, 앱 시작 시 **구버전 → 신버전 변환** 로직 실행.

### 1-4. 보안/권한
- **민감 정보(토큰/암호)**: 평문 저장 금지. **DPAPI**(Windows Data Protection, 사용자/머신 바인딩 암호화)를 사용.
- **HKLM 쓰기**: 설치 프로그램(관리자 권한)에서 1회 설정하고, 런타임은 읽기 전용으로 설계.

### 1-5. 유지보수
- **내보내기/가져오기** 기능(메뉴 제공)을 통해 설정 백업/복원 UX 제공(레지스트리/파일 모두 지원 가능).
- **클린업**: 제거(언인스톨) 시 **앱 전용 키만** 정리. 공용 키/타 앱 키 삭제 금지.

---

## 2) INI(또는 JSON 등 파일 기반 설정)

### 2-1. INI의 현재 위치
- Win32의 `GetPrivateProfileString`/`WritePrivateProfileString` 등 **INI API는 여전히 존재**하지만,  
  **복잡한 구조/유니코드/대용량**에는 한계가 있습니다.
- 현대 앱에서는 **JSON/YAML/XML** 등 **자기서술적 포맷**을 **앱 데이터 폴더**에 저장하는 방식이 보편적입니다.

### 2-2. INI 포맷 빠른 요약
```
[Settings]
Theme=Dark
Language=ko-KR

[Window]
X=120
Y=80
W=1280
H=800
```
- **장점**: 이해·편집 용이, 휴대성 좋음(파일 복사로 이전 완료).
- **단점**: 동시 접근/경합, 원자적 쓰기, 인코딩 일관성, 데이터 형식(배열/객체) 표현이 제한적.

### 2-3. JSON을 쓴다면(권장 시나리오)
- 중첩 구조/배열/리스트가 많은 **복합 설정**(예: 최근 문서 목록·개별 옵션 세트).
- **버전 필드** 포함(예: `"configVersion": 3`) → 마이그레이션 수월.
- **원자적 저장**: 임시 파일(`settings.json.tmp`)에 먼저 쓰고 **교체(atomic replace)** 하여 전원 차단·크래시 시에도 손상 최소화.

### 2-4. 동시성/락
- 다중 인스턴스가 동시에 쓰지 않게 **네임드 뮤텍스** 또는 파일 잠금(예: `LockFileEx`) 사용.
- UI 스레드 블로킹 방지: **백그라운드 저장** + 완료 후 **파일 교체** 패턴.

---

## 3) 앱 데이터 폴더 구조(권장 레이아웃)

Windows의 **공식 위치**를 사용하세요. (환경 변수와 Known Folder)

- **`%APPDATA%`** → `C:\Users\<User>\AppData\Roaming`  
  - **로밍**: 기업/도메인 환경에서 사용자 프로필과 함께 이동.  
  - 개인 설정/프로필/작은 데이터에 적합.
- **`%LOCALAPPDATA%`** → `C:\Users\<User>\AppData\Local`  
  - **로컬 전용**: 큰 캐시/임시/썸네일/인덱스(로밍 불필요).
- **`%PROGRAMDATA%`** → `C:\ProgramData`  
  - **머신 전역**: 모든 사용자 공용 설정/데이터.

### 3-1. 예시 레이아웃
```
%APPDATA%\Acme\PhotoTool\
    config\
        settings.json          // UI/기능 설정(로밍)
        shortcuts.json         // 사용자 단축키
    profiles\
        default\               // 사용자 프로필별 디렉터리
            presets.json
            ui-layout.dat      // 도킹/리본 상태(바이너리)
%LOCALAPPDATA%\Acme\PhotoTool\
    cache\
        thumbs\                // 썸네일/미리보기
        index\
    logs\
        app-2025-09-04.log
    temp\
        export\                // 임시 내보내기 작업물
%PROGRAMDATA%\Acme\PhotoTool\
    machine.conf               // 머신 범위(프록시, 라이선스 서버 등)
```

### 3-2. 설계 체크리스트
- **읽기/쓰기 경로 분리**: 설정(작음)과 캐시/로그(큼)를 분리하면 **성능·백업** 모두 유리.
- **파일 이름 규칙**: `kebab-case` 또는 `snake_case`, 확장자 통일(`.json`, `.dat`).
- **로그 롤링**: 일자별 파일 또는 크기 기준 롤링.
- **권한**: `ProgramData`/`HKLM`은 쓰기에 **관리자 권한**이 필요할 수 있음(설치 시 초기화 권장).

---

## 4) MFC 프로필 API로 추상화(개념)

> 코드 없이 작동 원리만 요약합니다.

- `CWinApp::GetProfileInt/String/Section…` → **레지스트리/INI를 통일된 인터페이스**로 접근.
- **초기화 시점**에 `SetRegistryKey("회사명")`을 호출하면 이후 `GetProfile…`/`WriteProfile…`은  
  **레지스트리(HKCU\Software\회사명\앱명\… )**에 저장됩니다.  
  (Feature Pack `CWinAppEx`는 `SetRegistryBase`로 하위 경로 세분화 가능)
- **장점**: 코드 변경 없이 레지스트리 ↔ INI 백엔드를 **쉽게 전환** 가능.  
- **용도**: 가벼운 **키-값 설정**, MRU(최근 파일) 목록, 창 좌표, 패널 가시성 등.

---

## 5) 민감 정보/보안

- **암호/토큰/쿠키** 등은 **평문 파일/레지스트리 금지**.  
- Windows **DPAPI**(사용자 또는 머신에 바인딩되는 보호)로 **암호화** 후 보관.  
- 노출 필요 시(예: 외부 툴 연동) **재암호화/일회성 토큰** 정책 설계.

---

## 6) 마이그레이션 & 호환성

- 설정 파일/레지스트리에 **`ConfigVersion`** 필드를 두고,  
  앱 시작 시 현재 버전과 다르면 **변환기(Migration)** 를 수행.  
- **되돌리기 전략**: 변환 전 원본을 `*.bak`으로 **백업** 후 진행.  
- **이전 MFC 앱에서 Windows 폴더 INI** 를 쓰던 경우:  
  - 최신 Windows에선 쓰기 권한/가상화 문제가 생길 수 있으므로,  
  - **초기 실행 시 새 위치(AppData/레지스트리)로 이동** + 사용자 고지.

---

## 7) 원자적(안전) 쓰기 & 복구

- **파일 저장 단계**:  
  1) `settings.tmp`에 먼저 저장 →  
  2) **플러시/닫기** →  
  3) `settings.json`으로 **교체(Replace/Move)**.  
- **전원 차단/크래시** 시 **tmp/백업 파일**을 감지해 복구 안내.  
- **레지스트리**는 보통 안전하지만, **자주 쓰기**는 배치/지연 쓰기(타이머)로 묶어 부담 완화.

---

## 8) 백업/내보내기 UX

- **메뉴: 설정 내보내기/가져오기**  
  - 레지스트리: 앱이 **키를 파일(.reg 또는 .json)** 로 덤프/로드.  
  - 파일 설정: `config` 디렉터리 압축/해제.  
- **자동 백업**: 주요 변경(예: 프로필 삭제/대규모 옵션 변경) 전에 **스냅샷** 생성.

---

## 9) QA 체크리스트

1. **UAC 충돌 없음**: Program Files/Windows 폴더에 쓰지 않음  
2. **다중 사용자/다중 인스턴스**에서 경합·손상 없음(락/뮤텍스)  
3. **로밍 정책**에 맞춰 Roaming vs Local을 구분  
4. **민감 정보 암호화**(DPAPI)  
5. **버전 관리/마이그레이션 로직** 내장  
6. **로그/캐시 정리 정책**(최대 용량/기간)  
7. **백업/복원** 경로 제공(문서화 포함)

---

## 10) 실무 권장 조합(예시)

- **일반 앱**:  
  - 사용자 설정/최근 항목/도킹 상태 → **HKCU 레지스트리(MFC 프로필 API)**  
  - 단축키/환경설정(사람이 편집할 수도) → **`%APPDATA%\Vendor\App\config\*.json`**  
  - 캐시/썸네일/로그 → **`%LOCALAPPDATA%\Vendor\App\…`**  
- **기업 배포**:  
  - 기본 정책/머신 전역 프록시 → **`%PROGRAMDATA%`**(설치 시 생성) 또는 **HKLM**  
  - 사용자 오버라이드 → HKCU/`%APPDATA%` 우선 적용(레이어링)

---

### 마무리

- **저장 위치를 올바르게 설계**하면 권한/배포/백업/성능 문제의 대부분이 예방됩니다.  
- **레지스트리(MFC 프로필)** 는 **가벼운 설정**과 **UI 상태**에,  
  **앱 데이터(파일)** 는 **이식/편집/대용량/복잡 구조**에 강합니다.  
- 위의 폴더 구조와 체크리스트를 프로젝트 초기에 반영하면, 이후 **기능 확장·유지보수**가 훨씬 수월해집니다.