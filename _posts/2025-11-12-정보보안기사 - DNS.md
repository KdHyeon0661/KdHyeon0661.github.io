---
layout: post
title: 정보보안기사 -
date: 2025-11-12 15:25:23 +0900
category: 정보보안기사
---
# SECTION 07 애플리케이션 기본 학습 — 01. DNS(Domain Name System) 완전 정리 (리졸버/권한 서버/루트–TLD 구조, 레코드 타입, 메시지·캐싱, DNSSEC, DoT/DoH, 보안 위협·완화, BIND/Unbound/CoreDNS/Windows 실습)

## 개요 — “이름을 주소로, 정책을 신뢰로”
DNS는 **사람이 읽기 쉬운 이름**(예: `www.example.com`)을 **네트워크가 쓰는 주소·속성**(IP, 메일 교환기, 키 등)로 변환한다.
실무에서 DNS는 단순 주소록을 넘어 **보안 경계**(차단·허용·격리), **신뢰 사슬**(DNSSEC), **프라이버시**(DoT/DoH)까지 관여한다.

- **주요 역할**: 이름해석, 서비스 탐색, 정책 배포(SPF/DMARC/RPZ 등)
- **주요 구성**: Stub Resolver(클라이언트) ↔ **Recursive Resolver**(캐싱·검증) ↔ **Authoritative**(권한 서버: 루트/TLD/도메인)
- **질의 방식**: 재귀(Recursive) vs 반복(Iterative), 캐싱/TTL, 음성(부재) 캐싱
- **보안 주제**: 캐시 포이즈닝, 재귀·증폭(앰플리피케이션) DDoS, DNS 리바인딩, DNSSEC, QNAME 최소화, RRL, DoT/DoH/DoQ

---

## DNS 구성요소와 흐름

### 요소 요약
| 요소 | 설명 | 예 |
|---|---|---|
| Stub Resolver | OS/앱 내장 간이 리졸버 | glibc `libresolv`, Windows DNS Client |
| Recursive Resolver(검증/캐싱) | 클라 대신 전체 탐색·검증·캐싱 | Unbound, BIND(리졸버), PowerDNS Recursor, CoreDNS |
| Authoritative | 존(zone) 데이터 권한 보유·응답 | BIND/Knot/NSD, 클라우드 DNS(ROUTE53·Cloud DNS 등) |
| Root | `.` 루트 힌트, TLD NS 반환 | a.root-servers.net 등(애니캐스트) |
| TLD | `.com`, `.kr` 등 | TLD 네임서버 |
| Zone | 도메인 단위 데이터 파일 | `example.com` 존 파일 |

### 이름 해석 흐름(재귀, ASCII)
```
Client(Stub) ──Q: A www.example.com?──▶ Recursive
Recursive ──Q: NS .──▶ Root         ──A: NS for .com
Recursive ──Q: NS example.com?──▶ .com TLD ──A: NS ns1.example.com (glue)
Recursive ──Q: A www.example.com?──▶ ns1.example.com ──A: A 203.0.113.10
Recursive ──A: 203.0.113.10 (TTL=3600)──▶ Client
```
- **Iterative**: 리졸버가 다음 물어볼 곳(NS)만 돌려받아 스스로 순회
- **Recursive**: 클라이언트가 “끝까지 해결”을 리졸버에 위임(일반적)

---

## 리소스 레코드(RR) 타입 정리

| 타입 | 의미 | 예 |
|---|---|---|
| **A** | IPv4 주소 | `www → 203.0.113.10` |
| **AAAA** | IPv6 주소 | `www → 2001:db8::10` |
| **CNAME** | 별칭 → 정규 이름 | `www → web-1.example.com.` |
| **NS** | 권한 네임서버 | `example.com → ns1.example.net.` |
| **SOA** | 존 시작/버전/타이머 | 마스터, 시리얼, 리프레시/리트라이 |
| **MX** | 메일 교환 | `example.com → 10 mail.example.com.` |
| **TXT** | 임의 텍스트 | SPF/DMARC/도메인 검증 등 |
| **SRV** | 서비스 위치 | `_sip._tcp.example.com → host:port` |
| **PTR** | 역방향 이름 | `10.113.0.203.in-addr.arpa → host` |
| **CAA** | 허용 CA 목록 | 인증서 발급 제한 |
| **DNSKEY/DS/RRSIG/NSEC(3)** | **DNSSEC**용 키/서명/존 걷기 방지 | 검증 신뢰 사슬 |
| **HTTPS/SVCB** | 신형 서비스 바인딩 | ALPN, alt svc(지원 환경) |

> 실무 주의: **CNAME은 같은 이름에 다른 데이터(A/AAAA/MX 등)와 공존 불가**(RFC). 필요한 경우 이름을 분리.

---

## DNS 메시지 구조·플래그·RCODE

### 헤더 개요
- **ID**(16bit)
- **Flags**: QR(쿼리/응답), AA(Authoritative), TC(Truncated), RD/RA(재귀 원함/가능), AD(Crypto Verified), CD(Do not validate)
- **Counts**: QDCOUNT/ANCOUNT/NSCOUNT/ARCOUNT

### 대표 RCODE
| 코드 | 의미 |
|---|---|
| NOERROR(0) | 성공 |
| FORMERR(1) | 포맷 오류 |
| SERVFAIL(2) | 서버 실패(검증 실패 포함) |
| NXDOMAIN(3) | 이름 없음 |
| REFUSED(5) | 정책/권한 거부 |

---

## 필수 툴 실습: dig/kdig/drill/delv

### 1. 기본 질의
```bash
# A/AAAA, MX, NS, SOA, TXT 등
dig A www.example.com +noall +answer
dig AAAA www.example.com +noall +answer
dig MX example.com +noall +answer
dig NS example.com +noall +authority
dig SOA example.com +noall +answer
```

### 2. 이름해석 경로 추적(+trace)
```bash
dig +trace www.example.com
```

### 3. 재귀/반복 제어(리졸버 특성 확인)
```bash
# 재귀 금지로 권한 응답만 확인(권한 서버에 직접)
dig @ns1.example.com www.example.com A +norecurse +noall +answer
```

### 4. EDNS/섹션 표시·검증
```bash
dig www.example.com +edns=0 +dnssec +multi
```

### 5. DNSSEC 검증(dlv/delv)
```bash
# delv는 DNSSEC 검증 상태를 설명
delv www.dnssec-failed.org
# 정상 존: AD 비트(Authenticated Data) 확인
dig www.example-dnssec.com +dnssec +noall +answer +adflag
```

> 팁: **`+adflag`**가 응답에 **AD=1**이면 리졸버가 DNSSEC 검증을 **성공**했다는 뜻.

---

## 캐싱·TTL·음성(부재) 캐싱(Negative Caching)

### TTL과 캐시 히트 직관(근사)
도착률 \(\lambda\)의 동일 질의에 대해 TTL이 \(T\)일 때, 캐시 히트율 \(H\)는 경험적으로
$$
H \approx 1 - e^{-\lambda T}
$$
로 증가(포아송 근사). TTL↑은 히트율↑/신선도↓의 트레이드오프.

### 음성 캐싱(RFC 2308)
- **NXDOMAIN** 또는 **NODATA** 응답도 **SOA의 `MINIMUM` 또는 TTL**로 캐싱
- 급격한 레코드 신설 시 전파 지연의 원인 → **짧은 TTL**로 배포 전 롤아웃

### 테스트
```bash
dig www.new.example.com A +noall +answer +ttlid
# (없다면 NXDOMAIN, 이후 생성했을 때도 일정 시간 NXDOMAIN 캐시 지속 가능)
```

---

## BIND 권한 존 구축(Authoritative) — 실습

### 1. `named.conf`(핵심만)
```conf
options {
    directory "/var/named";
    dnssec-validation no;        // 권한 서버는 보통 '검증' 안 함
    listen-on port 53 { any; };
    allow-transfer { 203.0.113.53; };  // 세컨더리로 제한
    rate-limit {
        responses-per-second 5;
    };
};

zone "example.com" IN {
    type master;
    file "db.example.com";
    allow-update { none; };      // 동적 업데이트 비활성
};
```

### 2. `db.example.com`(권한 존 파일)
```zone
$TTL 3600
@   IN SOA ns1.example.com. hostmaster.example.com. (
        2025111101 ; Serial (YYYYMMDDnn)
        3600       ; Refresh
        900        ; Retry
        1209600    ; Expire
        300 )      ; Minimum (negative caching)

    IN NS   ns1.example.com.
    IN NS   ns2.example.net.

ns1 IN A    203.0.113.53
www IN A    203.0.113.10
api IN A    203.0.113.20
; 메일
@   IN MX 10 mail.example.com.
mail IN A   203.0.113.30
; SPF/DMARC/DKIM 예시
@   IN TXT  "v=spf1 ip4:203.0.113.30 -all"
_dmarc IN TXT "v=DMARC1; p=reject; rua=mailto:dmarc@example.com"
default._domainkey IN TXT "v=DKIM1; k=rsa; p=MIIBIjANBgkqh..."
```

### 3. 구동·검증
```bash
named-checkzone example.com /var/named/db.example.com
systemctl restart named
dig @127.0.0.1 NS example.com +noall +answer
dig @127.0.0.1 A www.example.com +noall +answer
```

---

## Unbound 검증·캐싱 리졸버 — 실습

### 1. `unbound.conf`(핵심)
```conf
server:
  interface: 0.0.0.0
  interface: ::0
  access-control: 10.10.0.0/16 allow
  hide-identity: yes
  hide-version: yes
  rrset-cache-size: 256m
  msg-cache-size: 128m
  prefetch: yes
  qname-minimisation: yes
  aggressive-nsec: yes
  harden-below-nxdomain: yes
  harden-referral-path: yes
  val-clean-additional: yes

  # DoT 아웃바운드 (선택)
  tls-cert-bundle: "/etc/ssl/certs/ca-certificates.crt"
forward-zone:
  name: "."
  forward-tls-upstream: yes
  forward-addr: 1.1.1.1@853
  forward-addr: 9.9.9.9@853
```

### 2. 검증
```bash
unbound-anchor -a /var/lib/unbound/root.key   # 루트 KSK 앵커
systemctl restart unbound
dig @127.0.0.1 www.example.com +dnssec +adflag +noall +answer
delv @127.0.0.1 www.dnssec-failed.org
```

---

## DNSSEC — 신뢰 사슬(권한 존 서명)

### 핵심 개념
- **DNSKEY**: 존 공개키, **KSK**(키 사인 키) vs **ZSK**(존 서명 키) 역할 분리
- **DS**: 부모 존에 올라가는 KSK의 지문(체인 연결)
- **RRSIG**: 레코드 집합에 대한 서명
- **NSEC/NSEC3**: 부존재 증명(존 걷기 방지 목적의 NSEC3 해시)

### 간단 서명 절차(BIND)
```bash
cd /var/named
# KSK/ZSK 생성(예: ECDSAP256SHA256)
dnssec-keygen -a ECDSAP256SHA256 -f KSK example.com
dnssec-keygen -a ECDSAP256SHA256 example.com

# 존 서명
dnssec-signzone -A -3 $(head -c 20 /dev/urandom | sha1sum | cut -b 1-16) \
 -N increment -o example.com -t db.example.com

# named.conf: signed zone 파일 지정
zone "example.com" { type master; file "db.example.com.signed"; };
```
- **DS 제출**: 레지스트라에 KSK로부터 만든 **DS**를 올려 체인 완성
- **롤오버**: ZSK(자주), KSK(드물게). 이중 게시–서명–교체 절차 준수

### 검증 보기
```bash
dig A www.example.com +dnssec +multi +adflag
delv example.com DS
```

---

## 트랜스포트 보안·프라이버시: DoT/DoH/DoQ

| 방식 | 포트/계층 | 장점 | 주의 |
|---|---|---|---|
| **DoT** | 853/TCP+TLS | 단순, DPI 회피 일부 | 포트 차단 환경 |
| **DoH** | 443/HTTPS | 방화벽 우회 쉬움, 브라우저 내장 | 엔드포인트 정책 충돌 가능 |
| **DoQ** | 853/QUIC | 0-RTT·지연↓ | 지원 미보급 환경 많음 |

### systemd-resolved에서 DoT(예)
```bash
# /etc/systemd/resolved.conf
[Resolve]
DNS=1.1.1.1#cloudflare-dns.com 9.9.9.9#dns.quad9.net
DNSOverTLS=yes
```

---

## 보안 위협과 대응

### 1. 캐시 포이즈닝
- **대응**: **DNSSEC 검증**, **소스포트 랜덤화**, **TXID 예측 어려움**, **권한 위임(베일릭) 엄격화**, **0x20 대소문자 난수화**
```conf
# Unbound (일부 하드닝)
harden-glue: yes
harden-referral-path: yes
use-caps-for-id: yes         # 0x20
```

### 2. 증폭(앰플리피케이션) DDoS
- 작은 쿼리→큰 응답(ANY/large TXT/DNSSEC)로 증폭, 소스 스푸핑 이용
- **대응**: **오픈 리졸버 금지**, 권한 서버 **RRL(Response Rate Limiting)**, `TC` set + TCP 전환, Anycast 스케일
```conf
# BIND RRL 예
rate-limit {
  responses-per-second 10;
  window 5;
  slip 2;      # 일부 응답에 TC
  ipv4-prefix-length 24;
};
```

### 3. DNS 리바인딩
- 악성 스크립트가 DNS TTL·CNAME 트릭으로 사설망에 접근 유도
- **대응**: 브라우저/앱 **ORB/Host 검증**, 리졸버 **Private IP 응답 거부**(필요 시)
```conf
# Unbound: private-address/response-policy-zone(RPZ)
private-address: 10.0.0.0/8
private-address: 192.168.0.0/16
private-address: 172.16.0.0/12
```

### 4. 잘못된 위임/서브도메인 테이크오버
- **dangling CNAME**: 제거된 SaaS 인스턴스로 CNAME 남음 → 공격자 점유
- **대응**: 정기 **존 점검**, 3rd-party 이름들 **헬스체크 & 검증 자동화**

### 5. QNAME Minimization
- 루트/TLD에 전체 QNAME이 아닌 **필요 최소 이름만** 보냄(프라이버시·노이즈↓)
```conf
qname-minimisation: yes   # Unbound
```

---

## Split-horizon DNS, Views, RPZ(정책 DNS)

### Split-horizon / Views (BIND)
```conf
acl "corp" { 10.100.0.0/16; };

view "internal" {
    match-clients { "corp"; };
    recursion yes;
    zone "example.com" { type master; file "db.example.internal"; };
};

view "external" {
    match-clients { any; };
    recursion no;
    zone "example.com" { type master; file "db.example.external"; };
};
```

### RPZ(차단/리라이트 정책)
```conf
zone "rpz.local" { type master; file "rpz.db"; };

# rpz.db
$TTL 300
@ IN SOA ns1.rpz.local. hostmaster.rpz.local. (1 3600 900 1209600 300)
  IN NS  ns1.rpz.local.
bad.com          CNAME   rpz-drop.
malware.example  CNAME   rpz-passthru.   ; 화이트리스트 예
```

리졸버에 RPZ를 적용하면 **도메인 기반 차단/재지정**을 수행(보안·정책 통제).

---

## 메일·인증 관련 레코드(시험 빈출)

### SPF
```zone
@ IN TXT "v=spf1 ip4:203.0.113.30 include:_spf.mailer.net -all"
```

### DKIM
- MTA가 본문/헤더 서명 → **`selector._domainkey.example.com`**에 공개키(TXT)
```zone
selector1._domainkey IN TXT "v=DKIM1; k=rsa; p=MIIBIjANBgkq..."
```

### DMARC
```zone
_dmarc IN TXT "v=DMARC1; p=reject; rua=mailto:dmarc@example.com; ruf=mailto:dmarc-rua@example.com; adkim=s; aspf=s"
```

---

## SRV·SVCB/HTTPS, 서비스 디스커버리

### SRV
```zone
_sip._tcp IN SRV 10 5 5060 sipserver.example.com.
_kerberos._udp.EXAMPLE.COM. IN SRV 0 0 88 krb1.example.com.
```

### HTTPS/SVCB (신형, 지원 환경 확인)
```zone
; 우선순위 1, 알트 서비스 ALPN=h2
example.com. IN HTTPS 1 . alpn="h2"
```

---

## 역방향(PTR) — in-addr.arpa / ip6.arpa

### IPv4 예제: `203.0.113.0/24`
```zone
$ORIGIN 113.0.203.in-addr.arpa.
$TTL 3600
@ IN SOA ns1.example.com. hostmaster.example.com. (2025111101 3600 900 1209600 300)
  IN NS ns1.example.com.
10 IN PTR www.example.com.
30 IN PTR mail.example.com.
```

### IPv6 예제: `2001:db8::/32` (nybble 단위)
```zone
$ORIGIN 8.b.d.0.1.0.0.2.ip6.arpa.
; ... PTR 레코드들 ...
```

---

## CoreDNS/Kubernetes — 서비스 디스커버리

### CoreDNS ConfigMap 예(일부)
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
data:
  Corefile: |
    .:53 {
        errors
        health
        kubernetes cluster.local in-addr.arpa ip6.arpa {
            pods verified
            fallthrough in-addr.arpa ip6.arpa
        }
        forward . 1.1.1.1 9.9.9.9
        cache 30
        reload
        log
    }
```
- `kubernetes` 플러그인: `svc.namespace.svc.cluster.local` 식 이름을 서비스로 매핑

---

## Windows DNS Server — 빠른 실습

### 존 생성·레코드 추가(dnscmd)
```powershell
dnscmd /ZoneAdd example.com /Primary /file db.example.com.dns
dnscmd /RecordAdd example.com www A 203.0.113.10
dnscmd /RecordAdd example.com @ MX 10 mail.example.com
```

### 포워더/보안
- 외부 포워더 지정(검증 리졸버), 재귀 제한, 로깅 활성
- DNS 정책(Windows Server 2016+)으로 지역/시간대 기반 응답 제어 가능

---

## 모니터링/로깅/분석

### BIND
```conf
logging {
  channel querylog { file "/var/log/named/query.log" versions 5 size 50m; severity info; print-time yes; };
  category queries { querylog; };
};
```

### dnStap(고성능 바이너리 로깅)
- BIND/Unbound/Knot에서 지원, 실시간 파이프라인으로 SIEM 연계

### Wireshark 필터
```
dns && (dns.flags.rcode != 0 || dns.flags.tc == 1)
dns.qry.name contains "example.com"
```

---

## 운영 체크리스트(요약)

- [ ] **권한 존**: SOA 시리얼·타이머·NS/glue 정확도, 세컨더리 전용 전송(ACL/TSIG)
- [ ] **리졸버**: 검증(DNSSEC) ON, QNAME Min, 하드닝(하단 옵션), 오픈 재귀 금지
- [ ] **전송·프라이버시**: DoT/DoH(정책 충돌 점검), 루트 앵커 최신
- [ ] **RRL/Rate-limit**: 권한 서버 응답 제한, ANY 응답 최소화
- [ ] **RPZ/정책**: 악성 도메인 차단, 내부/외부 분리(View)
- [ ] **이메일 레코드**: SPF/DKIM/DMARC 정합
- [ ] **서브도메인 관리**: dangling CNAME·3rd-party 검증 자동화
- [ ] **가시성**: dnStap/쿼리로그/플로우/대시보드
- [ ] **백업/DR**: 존 파일/키(KSK/ZSK) 보관, 세컨더리/Anycast

---

## 실습 시나리오 모음

### 시나리오 A — “작은 회사 권한 DNS + 메일 레코드”
1) BIND로 `example.com` 권한 존 구축(위 존 파일)
2) MX·SPF·DKIM·DMARC 셋
3) 세컨더리 추가(AXFR 제한, TSIG)
4) `dig MX`, `dig txt _dmarc`, `opendkim-testkey`로 검증

### 시나리오 B — “검증 리졸버(Unbound) + RPZ”
1) Unbound 설치·DNSSEC 검증·QNAME Min 활성
2) RPZ 존 작성(차단 목록)
3) 사내 클라이언트의 DNS를 Unbound로 지정
4) 차단 도메인 요청 시 동작 확인

### 시나리오 C — “DNSSEC 서명 + DS 체인”
1) KSK/ZSK 생성·서명
2) 레지스트라에 DS 업로드
3) `delv`, `dig +dnssec +adflag`로 검증
4) ZSK 롤오버 리허설

---

## 트러블슈팅

| 증상 | 확인/조치 |
|---|---|
| NXDOMAIN 캐시 계속 | 음성 캐시 TTL(RFC 2308), SOA MINIMUM 확인, 리졸버 캐시 플러시 |
| SERVFAIL 잦음 | DNSSEC 검증 실패(시간/루트앵커), 권한 서버 체인/서명 만료 확인 |
| 대용량 응답 단절 | EDNS 크기/프래그먼테이션, `TC=1` 후 TCP 재시도 허용 |
| 메일 거부 | SPF/DMARC 정책·발송 IP 불일치, 역방향 PTR 누락 |
| 재귀 공개됨 | “오픈 리졸버” 테스트, ACL로 클라이언트 제한 |

---

## 시험(실기) 포인트 & 미니 문제

### 포인트 정리
- **레코드 타입 상호 제약**(CNAME 충돌)
- **DNSSEC 체인**: DS(부모) ↔ KSK(DNSKEY) ↔ RRSIG 검증 흐름
- **음성 캐싱** vs TTL, 전파 지연
- **증폭 공격 원리**와 **RRL/오픈 리졸버 금지**
- **QNAME Minimization**와 프라이버시/권위 위임
- **RPZ/Views**로 내부/외부 정책 분리
- **SPF/DKIM/DMARC** 배치·검증 절차

### 예상 실기 Q&A

**Q1.** `www`가 CNAME인데 같은 이름에 `MX`를 추가했다. 결과는?
**A.** RFC 위반. CNAME 이름에는 **다른 RR 동존 불가** → 이름 분리.

**Q2.** NXDOMAIN 후 즉시 레코드를 생성했지만 계속 없다고 나온다. 원인?
**A.** **음성 캐싱**(RFC 2308). **SOA MINIMUM/Neg TTL** 동안 NXDOMAIN 유지.

**Q3.** DNSSEC 실패가 잦다. 점검 순서 3가지만?
**A.** (1) 서버·리졸버 **시간 동기(NTP)** (2) **루트 앵커** 최신 (3) **DS/KSK 일치** 및 RRSIG 만료 확인.

**Q4.** 증폭 공격 완화 세 가지?
**A.** 오픈 재귀 금지, **RRL**, 큰 응답(ANY) 제한/`TC` 유도(+Anycast 확장).

**Q5.** 리바인딩 방어 두 가지?
**A.** 리졸버 **private-address 필터**/RPZ, 앱/브라우저 **Host/Origin 엄격 검증**.

---

## 보너스: 간단 계산과 직관

### 1. 캐시 히트율 근사
\[
H \approx 1 - e^{-\lambda T}
\]
- \( \lambda \): 동일 QNAME 질의 도착률(1/s), \(T\): TTL(s)
- 운영 감각: 인기 도메인 TTL↑은 히트↑→권한 부하↓, 단 변경 전파 느려짐

### 2. 응답 증폭 계수(대략)
\[
\text{Amplification} \approx \frac{\text{응답 바이트}}{\text{질의 바이트}}
\]
- TXT/ANY/DNSSEC 서명이 클수록 ↑ → RRL·최소화가 필요

---

## 요약
- DNS는 **주소록+정책 플랫폼**이다.
- 실무 필수: **검증 리졸버(Unbound)**, **권한 존(BIND)**, **QNAME Min**, **DNSSEC**, **RRL**, **RPZ**, **Split-horizon**, **메일 관련 레코드** 정합.
- 보안 관점 핵심: **오픈 리졸버 금지**, **캐시 포이즈닝 방어**, **증폭 완화**, **리바인딩 방지**, **Dangling CNAME 점검**.
- 본 문서의 예제 스니펫을 랩에서 실행해 **dig/delv로 가시화**하며 체득하라.
