---
layout: post
title: 시스템보안 - 로그·텔레메트리·위협 헌팅
date: 2025-10-30 22:30:23 +0900
category: 시스템보안
---
# 16. 로그·텔레메트리·위협 헌팅

## 16.1 이벤트 수집 표준화: Windows(EventID), Linux(auditd), Sysmon/ETW

### 16.1.1 수집 아키텍처(큰 그림)

```
[Windows Hosts] --(Winlog/ETW/Sysmon)--> [WEC or Agent(Winlogbeat/Fluent Bit)]
[Linux Hosts]   --(auditd/syslog/journald)--> [Fluent Bit/Vector/Logstash]
                                      ↓
                          [Normalize / Enrich / Filter]
                                      ↓
                          [SIEM: Sentinel / Splunk / ELK]
                                      ↓
                        [Detection(Sigma) / Hunting(KQL,SPL)]
```

**핵심 원칙**
- **스키마 통일**: 공통 필드(아래)로 **조인 가능한 형태** 확보  
- **필수 이벤트만 고해상도**(Sysmon, ETW) + 나머지 기본 보안 이벤트  
- **에이전트·서버 성능 가드**(필터·샘플링·버퍼·백프레셔)  
- **해시·서명·경로·부모/자식 PID** 등 **프로세스 혈통** 필수

**권장 공통 스키마 (예: OSSEM/ECS-풍)**
- `@timestamp` (UTC), `event.provider`, `event.id`, `event.action`, `event.category`  
- `host.name`, `host.ip[]`, `user.name`, `user.domain`, `logon.id`(Windows LUID)  
- `process.pid`, `process.parent.pid`, `process.name`, `process.executable`, `process.command_line`, `process.integrity_level`, `process.hash.sha256`  
- `file.path`, `file.hash.*`, `registry.path`, `registry.value`, `network.direction`, `network.transport`, `source.ip`, `destination.ip`, `destination.port`  
- `cloud.account.id`, `device.id`(자산 ID), `rule.name`, `rule.uuid`

---

### 16.1.2 Windows 보안 이벤트(EventID) 요약(헌팅 핵심)

| 범주 | EventID | 설명 (요약) |
|---|---:|---|
| 로그온 | **4624** | 성공 로그온(유형 2/3/10/11 구분 중요) |
|  | **4625** | 실패 로그온 |
|  | 4634/4647 | 로그오프 |
| 권한 | **4672** | 특권 할당(SeDebugPrivilege 등) |
| 계정 | 4720/4722/4723/4724 | 사용자 생성/활성화/암호 변경/재설정 |
| 그룹 | 4732/4728/4756 | 보안 그룹/로컬 그룹/도메인 로컬 그룹에 멤버 추가 |
| 정책 | **4719** | 감사 정책 변경 |
| 프로세스 | **4688** | 프로세스 생성(명령행, 해시는 Sysmon이 보강) |
| 작업/서비스 | **4697** / **7045** | 서비스 설치(보안 로그/시스템 로그) |
| Kerberos | 4768/4769/4770 | TGT, TGS 발급/갱신 |
| RDP | 1149(MSFT-TerminalServices-RemoteConnectionManager) | 원격 로그온 시도 |
| 로그 지움 | **1102** | 보안 로그 지움 |

> 4688의 **명령행**은 정책에 따라 비포함일 수 있음(감사 옵션/WDAC/EDR로 보강).

---

### 16.1.3 Sysmon 이벤트 맵(추천 최소 셋)

| Sysmon EventID | 의미 | 핵심 필드 |
|---:|---|---|
| **1** | 프로세스 생성 | Image, CommandLine, ParentImage, ParentCommandLine, Hashes, IntegrityLevel, User |
| 3 | 네트워크 연결 | DestinationIp, DestinationPort, Image, Initiated |
| 7 | 이미지 로드 | ImageLoaded, Signed, SignatureStatus |
| 8 | CreateRemoteThread | SourceImage, TargetImage |
| 10 | ProcessAccess | GrantedAccess, CallTrace |
| 11 | 파일 생성 | TargetFilename, CreationUtcTime |
| 12/13/14 | 레지스트리 이벤트(생성/값 설정/키명 변경) | EventType, TargetObject, Details |
| 15 | 파일 스트림 해시(ADS) | TargetFilename |
| 22 | DNS 쿼리 | QueryName, QueryStatus |
| 25 | 프로세스 변조 | Type, TargetProcessId |
| 26 | 파일 삭제(최근 버전) | TargetFilename |

**Sysmon 설치 & 예제 구성(XML)**
```powershell
# 설치
.\Sysmon64.exe -i .\sysmon_config.xml
# 제거/업데이트 시
.\Sysmon64.exe -u
```

```xml
<!-- sysmon_config.xml (핵심 필터 발췌) -->
<Sysmon schemaversion="4.90">
  <HashAlgorithms>sha256</HashAlgorithms>
  <EventFiltering>
    <ProcessCreate onmatch="include">
      <CommandLine condition="contains">-enc</CommandLine>
      <Image condition="end with">powershell.exe</Image>
      <ParentImage condition="end with">winword.exe</ParentImage>
    </ProcessCreate>
    <NetworkConnect onmatch="include">
      <DestinationPort name="HighRiskPorts">4444,8080,1337</DestinationPort>
    </NetworkConnect>
    <DnsQuery onmatch="include">
      <QueryName condition="ends with">.onion</QueryName>
    </DnsQuery>
  </EventFiltering>
</Sysmon>
```

---

### 16.1.4 Linux auditd 표준화

**설치/활성**
```bash
sudo apt-get install -y auditd audispd-plugins
sudo systemctl enable --now auditd
```

**감사 규칙 예시 (고가치 행동)**
```bash
# /etc/audit/rules.d/hardening.rules
# 1. execve 전역 감시(성능 주의: 화이트리스트와 함께)
-a always,exit -F arch=b64 -S execve -k exec
-a always,exit -F arch=b32 -S execve -k exec

# 2. SUID/SGID 파일 실행
-a always,exit -F perm=x -F euid=0 -S execve -k suid_exec

# 3. passwd/sudoers 변경
-w /etc/passwd -p wa -k etc_passwd
-w /etc/sudoers -p wa -k sudoers
-w /etc/sudoers.d/ -p wa -k sudoers

# 4. 모듈 로드/언로드
-a always,exit -F arch=b64 -S init_module,delete_module -k mod

# 5. 네트워크 설정 변경
-w /etc/hosts -p wa -k netcfg
-w /etc/resolv.conf -p wa -k netcfg
```

**ausearch / aureport 요약**
```bash
ausearch -k exec --start today
aureport -x --summary
```

**Fluent Bit로 audit 로그 수집(ELK/SIEM로)**
```ini
# /etc/fluent-bit/fluent-bit.conf
[INPUT]
  Name              tail
  Path              /var/log/audit/audit.log
  Parser            json
  Tag               linux.audit

[FILTER]
  Name              modify
  Match             linux.audit
  Add               event.provider auditd

[OUTPUT]
  Name              es
  Match             linux.audit
  Host              elasticsearch.local
  Index             linux-audit-%Y.%m.%d
```

---

### 16.1.5 ETW 수집(Windows) — 커널/보안/앱 실시간

**핵심 프로바이더**
- `Microsoft-Windows-Kernel-Process` (프로세스/스레드)  
- `Microsoft-Windows-Kernel-Network` (TCP/UDP)  
- `Microsoft-Windows-Sysmon` (Sysmon 자체도 ETW 발행)  
- 다양한 앱/보안 프로바이더(AMSI, PowerShell Operational 등)

**C# (TraceEvent) 실시간 구독 예**
```csharp
// EtwProcessNetWatcher.csproj (요약)
using Microsoft.Diagnostics.Tracing;
using Microsoft.Diagnostics.Tracing.Parsers;
using Microsoft.Diagnostics.Tracing.Session;

class Program {
  static void Main() {
    if (!TraceEventSession.IsElevated())
      throw new Exception("Run as Administrator");
    using var session = new TraceEventSession("ProcNetWatch");
    session.EnableKernelProvider(KernelTraceEventParser.Keywords.Process | KernelTraceEventParser.Keywords.NetworkTCPIP);

    session.Source.Kernel.ProcessStart += data =>
      Console.WriteLine($"PROC START: {data.ImageFileName} PID={data.ProcessID} PPID={data.ParentID}");
    session.Source.Kernel.TcpIpSend += data =>
      Console.WriteLine($"NET OUT: PID={data.ProcessID} {data.saddr}:{data.sport} -> {data.daddr}:{data.dport} size={data.size}");

    session.Source.Process(); // block
  }
}
```

> 운영은 **WEC(Windows Event Collector)** 또는 **Winlogbeat/Fluent Bit**로 중앙 수집 권장.

---

### 16.1.6 정규화(파서/맵핑) 팁

- Windows 4688 ↔ Sysmon 1 **매칭키**: `process.pid`, `process.parent.pid`, `process.executable`, `user.name`, `logon.id`  
- 여럿 테이블 조인 시 **시간 윈도우 조인**(`bin()`/`span`) 사용  
- 해시/서명 **부가 정보**(서명자/서명상태) 필드 정규화 → TTP 피벗이 쉬워짐  
- IP/도메인 **지식 그래프**(자체/위협 인텔) **Enrich**: WHOIS, ASN, SCD(새로 생성 도메인) 등

---

## 16.2 헌팅 쿼리: Sigma → SIEM(KQL/SPL) 변환

### 16.2.1 Sigma란?
- **SIEM-불문 공통 규칙 포맷(YAML)** → 백엔드별(KQL/SPL/ES DSL 등) **자동 변환** 가능  
- 장점: **버전관리/코드리뷰/협업** 용이, 멀티 SIEM 대응

**예: 의심 PowerShell 다운로드 크래들(Sigma)**
```yaml
title: Suspicious PowerShell Web Download
id: 2f3f1c19-9e0a-4dbd-9b7f-ps-web-dl
status: experimental
description: Detects PowerShell using web download cradles and encoded commands
author: blue-team
logsource:
  product: windows
  category: process_creation
detection:
  sel_image:
    Image|endswith:
      - '\powershell.exe'
      - '\pwsh.exe'
  sel_cmd:
    CommandLine|contains:
      - 'IEX(New-Object Net.WebClient).DownloadString'
      - 'Invoke-WebRequest'
      - 'Invoke-Expression'
      - 'FromBase64String'
      - '-enc '
  condition: sel_image and sel_cmd
fields:
  - Image
  - CommandLine
  - ParentImage
  - User
  - Hashes
level: high
tags:
  - attack.t1059.001
  - attack.t1105
```

---

### 16.2.2 Sigma → **KQL** 변환(예시: Microsoft Sentinel)

**KQL (Sysmon + SecurityEvent 통합)**
```kusto
let ps_images = dynamic(["powershell.exe","pwsh.exe"]);
let t1 = (
  SecurityEvent
  | where EventID == 4688
  | extend Image = tostring(parse_path(TargetFileName).Filename)
  | where tolower(Image) in (ps_images)
  | extend CommandLine = tostring(CommandLine), ParentImage = tostring(ParentProcessName)
  | where CommandLine has_any ("IEX(New-Object Net.WebClient).DownloadString",
                               "Invoke-WebRequest","Invoke-Expression","FromBase64String"," -enc ")
  | project TimeGenerated, Computer, User=tostring(SubjectUserName), Image, CommandLine, ParentImage, EventID, _ItemId
);
let t2 = (
  Sysmon
  | where EventID == 1
  | extend Image = tostring(split(Image, "\\")[-1])
  | where tolower(Image) in (ps_images)
  | where CommandLine has_any ("IEX(New-Object Net.WebClient).DownloadString",
                               "Invoke-WebRequest","Invoke-Expression","FromBase64String"," -enc ")
  | project TimeGenerated, Computer, User, Image, CommandLine, ParentImage, EventID
);
union t1, t2
| sort by TimeGenerated desc
| extend risk="high", rule="Suspicious PowerShell Web Download"
```

**헌팅 팁**
- `has_any` vs `contains`: KQL의 **토크나이즈 차이** 주의  
- `tolower()` 후 비교로 **대소문자 이슈** 제거  
- **Parent**가 `winword.exe`, `excel.exe`, `outlook.exe` 등일 때 **가중치** 상승

---

### 16.2.3 Sigma → **SPL**(Splunk) 변환

```spl
(index=winsec sourcetype="WinEventLog:Security" EventCode=4688
  OR index=sysmon sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=1)
| eval Image=coalesce(process_name, mvindex(split(Image,"\\",-1)))
| eval cmd=coalesce(CommandLine, CommandLine)
| where like(lower(Image), "%powershell.exe%") OR like(lower(Image), "%pwsh.exe%")
| where cmd LIKE "%IEX(New-Object Net.WebClient).DownloadString%"
  OR cmd LIKE "%Invoke-WebRequest%"
  OR cmd LIKE "%Invoke-Expression%"
  OR cmd LIKE "%FromBase64String%"
  OR cmd LIKE "% -enc %"
| table _time host user Image cmd parent_process_name EventCode
| sort - _time
```

**운영 팁**
- `coalesce()`로 보안 이벤트/시스몬 필드 **정규화**  
- 필드명 충돌 시 `rename` 또는 `eval`로 교정  
- 인덱스/소스타입 네이밍은 **현장 표준**으로 치환

---

### 16.2.4 전술별 헌팅 레시피(실전)

#### A) LOLBins(합법 바이너리 악용) — mshta/regsvr32/rundll32/wmic

**KQL**
```kusto
let targets = dynamic(["mshta.exe","rundll32.exe","regsvr32.exe","wmic.exe","installutil.exe","msbuild.exe"]);
Sysmon
| where EventID == 1
| extend ImageName = tolower(tostring(split(Image, "\\")[-1]))
| where ImageName in (targets)
| extend Susp = iff(CommandLine has_any (".js", "http://", "https://", "script:", "javascript:"), 1, 0)
| project TimeGenerated, Computer, User, Image, CommandLine, ParentImage, Susp
| order by TimeGenerated desc
```

**SPL**
```spl
index=sysmon EventCode=1
| eval img=lower(mvindex(split(Image,"\\",-1)))
| search img IN ("mshta.exe","rundll32.exe","regsvr32.exe","wmic.exe","installutil.exe","msbuild.exe")
| eval susp=if(like(CommandLine,"%http://%") OR like(CommandLine,"%https://%") OR like(CommandLine,"%.js%"),1,0)
| table _time host user Image CommandLine ParentImage susp
| sort - _time
```

---

#### B) PowerShell `-enc` Base64 + AMSI 우회

**KQL**
```kusto
Sysmon
| where EventID == 1
| extend img = tolower(tostring(split(Image,"\\")[-1]))
| where img in ("powershell.exe","pwsh.exe")
| where CommandLine has " -enc "
   or CommandLine has "Bypass"
   or CommandLine has "System.Management.Automation.Amsi"
| project TimeGenerated, Computer, User, Image, CommandLine, ParentImage
```

---

#### C) DNS exfil/터널링(대량·긴 서브도메인)

**KQL(Sysmon 22)**
```kusto
Sysmon
| where EventID == 22
| extend s = strlen(QueryName)
| summarize cnt=count(), avglen=avg(s), maxlen=max(s) by Computer, bin(TimeGenerated, 5m), QueryName
| where cnt > 50 or maxlen > 60
| order by cnt desc
```

---

#### D) 서비스 설치/지속성(7045/4697 + Sysmon 1 Join)

**KQL**
```kusto
let svc =
Event
| where EventLog == "System" and EventID == 7045
| extend ServiceName = tostring(EventData.ServiceName), ImagePath = tostring(EventData.ImagePath);
let procs =
Sysmon
| where EventID == 1
| project TimeGenerated, Computer, Image, CommandLine, Hashes;
svc
| join kind=leftouter (procs) on Computer
| where TimeGenerated1 between (TimeGenerated-1m .. TimeGenerated+5m)
| project TimeGenerated, Computer, ServiceName, ImagePath, Image, CommandLine, Hashes
| order by TimeGenerated desc
```

---

#### E) Linux — `sudoers`/`passwd` 변경 사냥

**SPL (auditd)**
```spl
index=linux-audit type=PATH OR type=SYSCALL
| stats values(name) as files, values(syscall) as syscalls by _time, host, auid, uid, exe
| where mvfind(files, "/etc/sudoers")>=0 OR mvfind(files,"/etc/passwd")>=0
| sort - _time
```

**KQL(Elastic/Log Analytics로 수집 시 필드명 매핑 필요)**
```kusto
LinuxAuditd_CL
| where FilePath has_any ("/etc/sudoers","/etc/passwd")
| summarize by Computer, User=UserAuid_s, Syscall=Syscall_s, Exe=Exe_s, bin(TimeGenerated, 5m)
| order by TimeGenerated desc
```

---

### 16.2.5 Sigma → 다중 백엔드 변환 파이프라인(개념)

1) Git 리포에 `sigma/` 디렉토리로 룰 관리  
2) CI에서 `sigmac`/`sigma-cli`로 **KQL/SPL** 생성  
3) 각 환경(Sentinel/Splunk)에 **API로 룰 동기화**  
4) E2E 테스트: pcap/replay 또는 샘플 로그로 **검증 쿼리** 실행 → 결과 ≥1 보장

**예: CI 스크립트(의사 bash)**
```bash
sigma-cli convert -t sentinel --output build/kql/ ./sigma/**/*.yml
sigma-cli convert -t splunk  --output build/spl/ ./sigma/**/*.yml
# 배포 스텝: az sentinel automation-rule create ... / Splunk REST API
```

---

### 16.2.6 ‘기저선 vs 이상치’ 헌팅(행동 통계)

**KQL — 프로세스 이미지별 정상 커맨드라인 길이 베이스라인**
```kusto
let baseline =
Sysmon
| where EventID == 1
| summarize avgLen=avg(strlen(CommandLine)), p95Len=percentile(strlen(CommandLine),95) by Image=tostring(split(Image,"\\")[-1]);
Sysmon
| where EventID == 1
| extend ImageName = tostring(split(Image,"\\")[-1]), L = strlen(CommandLine)
| join kind=leftouter (baseline) on $left.ImageName == $right.Image
| where L > p95Len * 2
| project TimeGenerated, Computer, User, Image, CommandLine, L, p95Len
| order by L desc
```

---

### 16.2.7 성능/가용성 팁

- **Windows**: WEC 구독 필터로 **필수 로그만** 중앙 전송(4688/4624/4625/4672/4697/7045 등)  
- **Sysmon**: 화이트리스트 필터 적극 활용(시스템 경로, 서명된 이미지 제외)  
- **auditd**: `execve` 전역은 비용 큼 → **예외/화이트리스트** 병행 및 `audispd` 큐 튜닝  
- SIEM: **요약 테이블(materialized)**, **역색인 필드 최적화**, **비정규화된 큰 필드 줄이기**(원문은 archive)

---

## 부록 A. 수집 에이전트 설정 스니펫

**Winlogbeat(Windows 보안 + Sysmon)**
```yaml
winlogbeat.event_logs:
  - name: Security
    processors:
      - script:
          lang: javascript
          id: security-normalizer
          source: >
            function process(evt) {
              var eid = evt.Get("winlog.event_id");
              if (eid == 4688) {
                evt.Put("event.category","process");
              }
            }
  - name: Microsoft-Windows-Sysmon/Operational

output.elasticsearch:
  hosts: ["es.local:9200"]
setup.template.enabled: true
```

**Fluent Bit(Windows) — ETW via Windows EventLog 채널**
```ini
[INPUT]
  Name              winlog
  Channels          Microsoft-Windows-Sysmon/Operational
  DB                C:\ProgramData\fluent-bit\winlog.db
[OUTPUT]
  Name              es
  Host              es.local
  Index             win-sysmon-%Y.%m.%d
```

---

## 부록 B. 샘플 시그널 튜닝(오탐 감소 규칙)

- PowerShell `-enc` 탐지에서 **Intune/Defender 유지관리 스크립트** 경로 화이트리스트  
- RDP 1149 헌팅에서 **점검 봇 계정/점검 시간대** 제외  
- DNS 터널링 룰에서 **CI CDN** 도메인의 긴 쿼리 제외(예: `_msedge.net` 텔레메트리)

---

## 결론

- **표준화된 스키마**와 **선택적 고해상도 로그(Sysmon/auditd/ETW)** 수집은 **위협 헌팅의 민첩성**을 좌우합니다.  
- Sigma로 **규칙을 소스코드처럼** 관리하고, **KQL/SPL 자동 변환·배포** 파이프라인을 갖추면 **SIEM 종속성**을 줄일 수 있습니다.  
- 본문 예제(수집/정규화/룰/헌팅 쿼리)를 **파일럿**으로 적용 후, **오탐 튜닝**과 **기저선 모델**을 도입하면 **탐지 품질과 성능**을 동시에 확보할 수 있습니다.
