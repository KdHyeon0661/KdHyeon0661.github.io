---
layout: post
title: AWS - IAM 정책 설계 가이드
date: 2025-08-03 19:20:23 +0900
category: AWS
---
# IAM 정책 설계 가이드: AWS 보안을 위한 권한 제어 전략

## 0. 왜 IAM 정책 설계가 ‘아키텍처’인가

- **보안·운영·감사**의 공통 분모: IAM이 실패하면 데이터/리소스/비용/가용성 모두 위험.
- **확장성**: 팀·계정·리전·워크로드가 늘수록, **역할·정책·태그 전략**의 표준화가 성패를 가름.
- **자동화 가능성**: CI/CD, IaC(CDK/CloudFormation/Terraform), Access Analyzer, EventBridge와의 **정책 검증 파이프라인**이 필수.

---

## 1. IAM 정책의 평가 논리(Evaluation Logic)를 먼저 이해하자

1. **기본은 Deny** (암묵적 거부).
2. **Allow 가 하나라도 있으면 잠정 허용**.
3. **명시적 Deny 가 하나라도 있으면 최종 거부**(모든 Allow 를 이김).
4. **SCP / Permission Boundary / Session Policy**가 추가 상한선 역할:
   - **SCP(조직 제어)**: OU/계정 차원의 **상한선**.
   - **Permission Boundary(경계)**: 역할/사용자에 부착된 **상한선**.
   - **Session Policy**: STS 세션에 일시 적용되는 **상한선**.
   - 결국 **실효 권한 = Allow ∩ (SCP ∩ Boundary ∩ Session)**.

**한 줄 공식**
$$
\text{EffectiveAllow} = \big( \textstyle\bigcup \text{Identity & Resource Allows} \big) \cap \text{SCP} \cap \text{Boundary} \cap \text{Session} - \text{Any Explicit Deny}
$$

---

## 2. 정책의 기본 구조(복습 + 확장)

```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Sid": "Describe",
    "Effect": "Allow",
    "Action": "ec2:DescribeInstances",
    "Resource": "*",
    "Condition": {
      "StringEquals": { "aws:RequestedRegion": "ap-northeast-2" }
    }
  }]
}
```

- **Action**: `service:Verb` 또는 와일드카드(지양).
- **Resource**: 가능한 ARN 명시. 서비스에 따라 지원 범위 상이.
- **Condition**: `aws:*`(글로벌), 서비스별 전용 키, 태그 기반 키(`aws:ResourceTag/*`, `aws:PrincipalTag/*`).
- **Sid**: 운영/감사 시 단위 식별에 유용.

---

## 3. 최소 권한(Least Privilege) 설계 7원칙

1. **작업단위 최소화**: CRUD 분리, `List* / Describe*`를 별도로.
2. **리소스 범위 최소화**: `*` 대신 **정확한 ARN**.
3. **시간/위치/디바이스 제약**: `Date*`, `aws:SourceIp`, `aws:UserAgent`, `aws:RequestedRegion`, `aws:SecureTransport`(TLS).
4. **MFA 강제**: `aws:MultiFactorAuthPresent` 또는 콘솔 로그인 정책.
5. **태그 기반 ABAC**: 부서/프로덕트/환경 태그를 권한 조건으로.
6. **명시적 Deny**의 전략적 사용: 고위험 API / 외부망 / 비인가 리전에 대한 보호벽.
7. **권한 생명주기 관리**: 만료일/리뷰 주기, 자동 검출·자동 시정.

---

## 4. ABAC vs RBAC, 그리고 하이브리드

- **RBAC**(Role-Based): 역할에 권한을 묶고 사용자/서비스에 할당. **예측 가능/감사 용이**.
- **ABAC**(Attribute-Based): **태그/속성**으로 권한 결정. **스케일에 강함**(새 리소스 자동 포함).
- **하이브리드**: 공통 권한은 RBAC, **소유권/팀/환경**은 ABAC로 미세 제어.

### ABAC 예시(소유자 태그 일치한 리소스만 조작 허용)

```json
{
  "Effect": "Allow",
  "Action": [ "ec2:StartInstances", "ec2:StopInstances" ],
  "Resource": "arn:aws:ec2:ap-northeast-2:123456789012:instance/*",
  "Condition": {
    "StringEquals": {
      "aws:ResourceTag/Owner": "${aws:PrincipalTag/Owner}"
    }
  }
}
```

- 사용자/역할에는 `Owner=alice` 태그를, 인스턴스에는 `Owner=alice` 태그가 있어야 함.

---

## 5. 리소스 기반 정책 vs 아이덴티티 기반 정책

| 구분 | 부착 위치 | 대표 리소스 | 사용 목적 |
|---|---|---|---|
| 아이덴티티 기반 | User/Role/Group | 모든 서비스 | 주체에 권한 부여(주체 중심) |
| 리소스 기반 | S3/Lambda/SQS/SNS/KMS 등 | 버킷/함수/큐/토픽/키 | 리소스가 **누구**를 허용할지 선언(교차계정 용이) |

### S3 버킷 정책(조직 외부 전부 차단 + TLS 강제 + 특정 VPCe만 허용)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyNonTLS",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:*",
      "Resource": ["arn:aws:s3:::corp-data", "arn:aws:s3:::corp-data/*"],
      "Condition": { "Bool": { "aws:SecureTransport": "false" } }
    },
    {
      "Sid": "AllowOnlyOrgAndVpce",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:*",
      "Resource": ["arn:aws:s3:::corp-data", "arn:aws:s3:::corp-data/*"],
      "Condition": {
        "StringNotEquals": { "aws:PrincipalOrgID": "o-abc123xyz" },
        "StringNotEqualsIfExists": { "aws:SourceVpce": "vpce-0abc1234def567890" }
      }
    }
  ]
}
```

---

## 6. 교차 계정 접근(AssumeRole, ExternalId, Session Policy)

### 6.1 신뢰 정책(Trust Policy) — `sts:AssumeRole`

```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": { "AWS": "arn:aws:iam::111111111111:role/PartnerRole" },
    "Action": "sts:AssumeRole",
    "Condition": {
      "StringEquals": { "sts:ExternalId": "partner-unique-id-2025" }
    }
  }]
}
```

- **ExternalId**: 공급망/3rd-party로부터의 **혼동 공격 방지**.
- 세션 지속시간 제한: `sts:DurationSeconds`.

### 6.2 세션 정책(세션 상한선)

```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Action": ["s3:GetObject"],
    "Resource": "arn:aws:s3:::audit-logs/*"
  }]
}
```

Assume 시 `--policy`로 위 JSON을 전달 → **이미 허용된 권한보다 더 넓어질 수 없음**.

---

## 7. Permission Boundary(권한 경계) — 현장 운영의 안전망

> “관리자가 만든 역할이라도 **경계가 허용하지 않는 권한은 절대 가질 수 없음**.”

### 경계 정책(예: S3 읽기만 상한선)

```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Action": ["s3:Get*", "s3:List*"],
    "Resource": "*"
  }]
}
```

- 개발자들이 자신의 역할을 생성/수정할 수 있는 조직에서 **오남용 방지 필수**.
- 실효 권한 = 역할 Allow ∩ 경계 Allow.

---

## 8. 조직 정책(SCP) — 다계정 거버넌스의 루트

- **SCP**는 계정/OU 수준에서 **허용 가능한 API 상한선**을 설정.
- **루트 사용자**까지 구속(중요).
- “이 리전에선 EC2 생성 금지”, “KMS 없는 S3 PutObject 금지” 등.

### 예시: 서울/도쿄 외 리전 금지

```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Sid": "AllowOnlyKRJP",
    "Effect": "Deny",
    "Action": "*",
    "Resource": "*",
    "Condition": {
      "StringNotEquals": {
        "aws:RequestedRegion": ["ap-northeast-2","ap-northeast-1"]
      }
    }
  }]
}
```

---

## 9. 고급 Condition 레시피 모음

- **네트워크**:
  - `aws:SourceIp`(고정망/사내망 화이트리스트)
  - `aws:SourceVpce`(VPC Endpoint로만 접근)
  - `aws:ViaAWSService`(서비스 간 프록시 여부)
- **세션/장치**: `aws:MultiFactorAuthPresent`, `aws:UserAgent`, `aws:PrincipalType`
- **조직 기준**: `aws:PrincipalOrgID`
- **데이터 보호**: `s3:x-amz-server-side-encryption`, `kms:EncryptionContext:*`
- **태그**: `aws:ResourceTag/Key`, `aws:PrincipalTag/Key`, `aws:RequestTag/Key`, `aws:TagKeys`

### 예: KMS 없이 S3 업로드 금지

```json
{
  "Effect": "Deny",
  "Action": "s3:PutObject",
  "Resource": "arn:aws:s3:::secure-bucket/*",
  "Condition": {
    "Null": { "s3:x-amz-server-side-encryption": "true" },
    "StringNotEqualsIfExists": { "s3:x-amz-server-side-encryption": "aws:kms" }
  }
}
```

---

## 10. 서비스별 모범사례 스니펫

### 10.1 S3 (읽기 전용 + TLS + 특정 프리픽스)

```json
[
  {
    "Sid": "ListBucket",
    "Effect": "Allow",
    "Action": "s3:ListBucket",
    "Resource": "arn:aws:s3:::myapp-data",
    "Condition": { "StringLike": { "s3:prefix": ["reports/*"] } }
  },
  {
    "Sid": "GetObjects",
    "Effect": "Allow",
    "Action": "s3:GetObject",
    "Resource": "arn:aws:s3:::myapp-data/reports/*",
    "Condition": { "Bool": { "aws:SecureTransport": "true" } }
  }
]
```

### 10.2 DynamoDB (테이블 특정 파티션키만 허용)

```json
{
  "Effect": "Allow",
  "Action": ["dynamodb:GetItem","dynamodb:PutItem","dynamodb:UpdateItem"],
  "Resource": "arn:aws:dynamodb:ap-northeast-2:123456789012:table/Orders",
  "Condition": {
    "ForAllValues:StringEquals": { "dynamodb:LeadingKeys": ["${aws:PrincipalTag/TenantId}"] }
  }
}
```

### 10.3 Lambda(특정 함수 호출만)

```json
{
  "Effect": "Allow",
  "Action": ["lambda:InvokeFunction"],
  "Resource": "arn:aws:lambda:ap-northeast-2:123456789012:function:invoice-generate:*"
}
```

### 10.4 KMS(Key 사용 제한: 특정 S3 버킷에만)

```json
{
  "Sid": "AllowEncryptForBucket",
  "Effect": "Allow",
  "Action": [
    "kms:Encrypt","kms:Decrypt","kms:GenerateDataKey*","kms:ReEncrypt*","kms:DescribeKey"
  ],
  "Resource": "*",
  "Condition": {
    "StringEquals": { "kms:EncryptionContext:aws:s3:arn": "arn:aws:s3:::secure-bucket" }
  }
}
```

### 10.5 SQS(특정 프리픽스 큐만, VPCe 경유)

```json
{
  "Effect": "Allow",
  "Action": ["sqs:SendMessage","sqs:ReceiveMessage","sqs:DeleteMessage","sqs:GetQueueAttributes"],
  "Resource": "arn:aws:sqs:ap-northeast-2:123456789012:order-*",
  "Condition": { "StringEquals": { "aws:SourceVpce": "vpce-0abc1234def567890" } }
}
```

---

## 11. OIDC(예: GitHub Actions) + 역할 연동

**신뢰 정책**: GitHub Actions OIDC 주체의 리포/브랜치 제한

```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": { "Federated": "arn:aws:iam::123456789012:oidc-provider/token.actions.githubusercontent.com" },
    "Action": "sts:AssumeRoleWithWebIdentity",
    "Condition": {
      "StringEquals": { "token.actions.githubusercontent.com:aud": "sts.amazonaws.com" },
      "StringLike": {
        "token.actions.githubusercontent.com:sub": "repo:YourOrg/your-repo:ref:refs/heads/main"
      }
    }
  }]
}
```

- **세션 정책**으로 빌드·배포 단계 권한 상한선을 추가하면 더 안전.

---

## 12. 콘솔 접근 제어(고급)

- **Service Catalog / Permission Sets(SSO/Identity Center)**로 **역할 기반 콘솔 UX** 제공.
- 콘솔 전용 제약: `aws:ViaAWSService=false` + `aws:UserAgent` 패턴 제어(조심스럽게).
- **MFA 필수** + **IP/VPCe/TLS** 조건으로 **원격 콘솔 접근을 엄격히**.

---

## 13. 감시·검증·자동시정 파이프라인

- **Access Analyzer**: 외부 접근 가능 정책 탐지(버킷/키/함수/큐/역할 등).
- **CloudTrail**: 변경 이벤트(EventBridge 규칙) → **자동 롤백 람다**.
- **Config**: 비준수(예: `Resource: *` 있는 정책) → **수정 액션**.
- **CI 단계**: 정책 린팅(스키마/액션 유효성/`*` 검출), **권한 시뮬레이션** 자동화.

### 권한 시뮬레이터(CLI 예)

```bash
aws iam simulate-principal-policy \
  --policy-source-arn arn:aws:iam::123456789012:role/AppDeployer \
  --action-names s3:PutObject s3:GetObject \
  --resource-arns arn:aws:s3:::my-bucket/* \
  --context-entries ContextKeyName=aws:SecureTransport,ContextKeyType=boolean,ContextKeyValue=true
```

---

## 14. 정책 크기/유지보수 전략

- **정책 분리**: `List/Describe` vs `Write/Delete` vs `Admin`.
- **Sid 단위 리팩터링**: 감사/검색/차등 배포 용이.
- **관리형 정책 재사용** + **인라인 정책은 예외 관리**.
- **버전 고정**: IaC 저장소에서 변경 이력·승인 프로세스.

---

## 15. 실전 템플릿 라이브러리

### 15.1 “운영자(ReadOnly+특정 Write)” 역할

```json
{
  "Version": "2012-10-17",
  "Statement": [
    { "Sid": "ReadOnlyAll",
      "Effect": "Allow",
      "Action": ["*:*"],
      "Resource": "*",
      "Condition": { "StringEquals": { "aws:RequestedRegion": "ap-northeast-2" } }
    },
    { "Sid": "BlockWriteByDefault",
      "Effect": "Deny",
      "Action": ["*:*"],
      "Resource": "*",
      "Condition": { "Null": { "aws:ViaAWSService": "true" } }
    },
    { "Sid": "AllowSafeWrites",
      "Effect": "Allow",
      "Action": ["s3:PutObject","s3:DeleteObject"],
      "Resource": "arn:aws:s3:::ops-temporary/*",
      "Condition": { "Bool": { "aws:SecureTransport": "true" } }
    }
  ]
}
```

> 첫 문은 조심스럽다(“ReadOnlyAll”). 실제로는 AWS 제공 **ReadOnlyAccess** 관리형 정책 사용 + 필요한 최소 Write 를 별도 문으로.

### 15.2 “프로덕션 데이터 보호” SCP

```json
{
  "Version": "2012-10-17",
  "Statement": [
    { "Sid": "DenyNonTLS",
      "Effect": "Deny",
      "Action": "s3:*",
      "Resource": "*",
      "Condition": { "Bool": { "aws:SecureTransport": "false" } }
    },
    { "Sid": "DenyNoKmsOnPut",
      "Effect": "Deny",
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::prod-*/*",
      "Condition": { "Null": { "s3:x-amz-server-side-encryption": "true" } }
    },
    { "Sid": "DenyOutsideKRJP",
      "Effect": "Deny",
      "Action": "*",
      "Resource": "*",
      "Condition": { "StringNotEquals": { "aws:RequestedRegion": ["ap-northeast-2","ap-northeast-1"] } }
    }
  ]
}
```

### 15.3 “개발자 개인 샌드박스” Permission Boundary

```json
{
  "Version": "2012-10-17",
  "Statement": [
    { "Effect": "Allow", "Action": ["ec2:*","s3:*","iam:PassRole"], "Resource": "*" },
    { "Effect": "Deny", "Action": ["iam:*","organizations:*","kms:*"], "Resource": "*" },
    { "Effect": "Deny", "Action": "*", "Resource": "*",
      "Condition": { "StringNotEquals": { "aws:RequestedRegion": "ap-northeast-2" } } }
  ]
}
```

> 샌드박스에서 계정·조직·KMS 오용 차단 + 리전 제한.

---

## 16. 수학으로 보는 권한 리스크(개념적)

권한의 **폭발 반경(Blast Radius)** 를 단순화해 보면,
$$
\text{BlastRadius} \propto
f\big(|\text{Principals}|,\ |\text{Actions}|,\ |\text{Resources}|,\ 1-\text{Selectivity(Condition)}\big)
$$
- 주체/액션/리소스가 늘수록, Condition 선택도가 낮을수록 위험이 선형~초선형적으로 증가.
- 해결: 각 축을 **최소화**하고, Condition **선택도**를 높여 전체 위험을 감소.

---

## 17. 운영 체크리스트

- [ ] **루트 계정 MFA** + Access Keys 미사용.
- [ ] **Identity Center(SSO)** 기반 역할-기반 접근 정착.
- [ ] **SCP**로 리전/암호화/고위험 서비스 가드레일.
- [ ] **Permission Boundary**로 셀프서비스 안전화.
- [ ] **ABAC 태그 표준**(Owner, Department, Env, System, DataClass).
- [ ] **정책 린트/시뮬레이터** CI 파이프라인 통합.
- [ ] **CloudTrail/Config/Analyzer**로 지속 모니터링.
- [ ] **정기 권한 검토**(분기/반기), 미사용 권한 제거.
- [ ] **KMS 기본화** + S3/TLS 강제.
- [ ] 인시던트 대응 Runbook: 키 회수, 역할 비활성, 로그 스냅샷, 영향평가.

---

## 18. 빠른 문제해결(트러블슈팅)

- “권한 있는데 왜 안 돼?” → **명시적 Deny / SCP / Boundary / SessionPolicy** 교집합 확인.
- “콘솔은 되는데 CLI는 안 돼” → `aws:SecureTransport`, `aws:SourceIp`, `aws:UserAgent`, VPCe 조건.
- “교차 계정이 꼬임” → **리소스 기반 정책**과 **신뢰 정책** 양쪽 확인(둘 중 하나만 맞아도 실패).
- “S3 업로드 실패” → SSE 요구/키 권한/KMS Context 조건 확인.
- “KMS Decrypt 실패” → Key policy, Grants, Caller role trust, Context 키 일치 체크.

---

## 19. 실전 시나리오: 데이터 레이크 팀 권한 설계(요약)

1) **조직 가드레일**: SCP로 리전/암호화 의무화.
2) **역할 모델**: `dl-admin`, `dl-dataeng`, `dl-analyst`, `dl-ro`.
3) **ABAC**: `Env=dev|stg|prd`, `Domain=retail|iot`, `Owner=<team>`.
4) **S3 정책**: 버킷마다 TLS/KMS/VPCe 강제, `aws:PrincipalOrgID`로 외부 차단.
5) **KMS 키**: 데이터 클래스별 Key 분리, Key policy 최소화 + IAM으로 위임.
6) **Athena/Glue**: 카탈로그 권한은 Lake Formation으로 열/행 제어.
7) **CI 파이프라인**: Access Analyzer + Policy Simulator 자동 검증.
8) **비상 권한**: Break-glass 역할은 별도 MFA + 짧은 세션 + Session Policy로 제한.

---

## 20. 결론

- IAM 정책은 **문서가 아닌 아키텍처**다.
- **평가 논리(Allow/Deny/SCP/Boundary/Session)**를 바탕으로, **RBAC+ABAC 하이브리드**와 **리소스/세션/조직 정책**을 조합하면 **안전하고 확장가능**한 권한 모델을 만들 수 있다.
- 최종 성패는 **자동화**(검증·모니터링·시정)와 **주기 리뷰**에 달려 있다.

---

## 부록 A) 빈출 정책 스니펫 컬렉션

### A-1. MFA 없으면 전부 거부(예외: STS AssumeRole만 허용)

```json
[
  {
    "Effect": "Deny",
    "Action": "*",
    "Resource": "*",
    "Condition": { "BoolIfExists": { "aws:MultiFactorAuthPresent": "false" } }
  },
  {
    "Effect": "Allow",
    "Action": "sts:AssumeRole",
    "Resource": "arn:aws:iam::123456789012:role/*"
  }
]
```

### A-2. 콘솔 로그인 금지(머신 전용 역할)

```json
{
  "Effect": "Deny",
  "Action": "aws-portal:*",
  "Resource": "*"
}
```

> 실제 콘솔 차단은 **비사용자(인증서/키 없음) 역할** 원칙으로 운영.

### A-3. S3 정적 웹 호스팅 전용(읽기 오픈 + 업로드는 내부만)

```json
[
  {
    "Sid": "PublicRead",
    "Effect": "Allow",
    "Principal": "*",
    "Action": ["s3:GetObject"],
    "Resource": "arn:aws:s3:::site-public/*"
  },
  {
    "Sid": "PrivateWriteOnlyFromVpce",
    "Effect": "Deny",
    "Principal": "*",
    "Action": "s3:PutObject",
    "Resource": "arn:aws:s3:::site-public/*",
    "Condition": { "StringNotEquals": { "aws:SourceVpce": "vpce-0abc1234" } }
  }
]
```

---

## 부록 B) 정책 작성 체크리스트(요약)

- [ ] Action 최소화(명시형, 와일드카드 지양).
- [ ] Resource ARN 명시(프리픽스/패턴 주의).
- [ ] Condition 적극 사용(TLS, VPCe, Region, Tag, Time).
- [ ] 명시적 Deny 로 고위험 시나리오 차단.
- [ ] SCP/Boundary/SessionPolicy 교집합 고려.
- [ ] 리소스 기반 정책과 아이덴티티 기반 정책의 **맞물림** 확인.
- [ ] 시뮬레이터/Analyzer/Config 로 자동 검증.
- [ ] 변경은 **IaC + 코드리뷰 + 승인**으로만.
