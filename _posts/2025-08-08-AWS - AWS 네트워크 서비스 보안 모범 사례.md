---
layout: post
title: AWS - AWS 네트워크 서비스 보안 모범 사례
date: 2025-08-08 23:20:23 +0900
category: AWS
---
# AWS 네트워크 서비스 보안 모범 사례

> 목표: **네트워크 경계–전송–애플리케이션–내부 동서 트래픽(East/West)** 까지 “다층 방어(Defense in Depth)”를 **실전 템플릿/코드**와 함께 정리한다.  
> 원칙: **최소 권한(Least Privilege)** · **기본 거부(Default Deny)** · **제로 트러스트 세그멘테이션(Zero-Trust Segmentation)** · **관찰가능성(Observability)**.

---

## 0) 전체 아키텍처 개요

```
[Internet]
    │
    ▼
[CloudFront] ──(WAF WebACL + Shield Advanced)──► [ALB] ──(authenticate-oidc)──► [App]
    │
    └── S3/Media/Static  (Origin Access Control, private bucket)
    
[VPC Private Subnets] ──► [VPC Endpoint: S3, DynamoDB, API GW, Secrets Manager, STS...]
      │
      └─ East/West 트래픽 ─► [GWLB] ─► [IDS/IPS ASG] ─► [VPC/On-Prem via TGW]
```

- **North/South**: CloudFront + WAF + Shield로 **외부 공격 차단/완화**  
- **App 인증**: ALB OIDC로 **프론트도어에서 인증**  
- **Data Plane**: VPC Endpoint Policy + 리소스 정책으로 **프라이빗 최소 권한**  
- **East/West**: GWLB + IDS/IPS로 **내부 트래픽 검열/감시**  
- **모니터링**: CloudWatch, WAF Logs, VPC Flow Logs, IDS 이벤트, GuardDuty, Security Hub

---

## 1) VPC Endpoint Policy로 S3 접근 최소 권한 (Gateway/Interface 공통 개념)

### 1-1) 핵심 개념
- **VPC Endpoint**는 **네트워크 경로** + **정책(Policy)** 두 레이어에서 통제한다.  
- **리소스 정책(S3 Bucket Policy 등)** 과 **Endpoint Policy**를 **동시에** 좁힌다.  
- **조건 키**: `aws:SourceVpce`(엔드포인트 ID), `aws:PrincipalAccount`, `s3:prefix`, `s3:ExistingObjectTag/*` 등을 조합.

### 1-2) S3 읽기 전용: Endpoint Policy (Gateway Endpoint: com.amazonaws.<region>.s3)
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "S3ReadOnlyFromSpecificVPCE",
      "Effect": "Allow",
      "Principal": "*",
      "Action": ["s3:GetObject", "s3:ListBucket"],
      "Resource": [
        "arn:aws:s3:::example-bucket",
        "arn:aws:s3:::example-bucket/*"
      ],
      "Condition": {
        "StringEquals": { "aws:SourceVpce": "vpce-0abcd1234efgh5678" }
      }
    }
  ]
}
```

> **설명**: 해당 VPC Endpoint에서만 `example-bucket`에 **List/Get** 허용. 다른 경로(IGW/NAT/외부)는 **버킷 정책**에서 차단해야 완전함.

### 1-3) S3 Bucket Policy: 프라이빗 강제 (Endpoint + Principal + TLS)
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyIfNotFromSpecificVPCE",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:*",
      "Resource": ["arn:aws:s3:::example-bucket", "arn:aws:s3:::example-bucket/*"],
      "Condition": {
        "StringNotEquals": { "aws:SourceVpce": "vpce-0abcd1234efgh5678" }
      }
    },
    {
      "Sid": "DenyInsecureTransport",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:*",
      "Resource": ["arn:aws:s3:::example-bucket", "arn:aws:s3:::example-bucket/*"],
      "Condition": { "Bool": { "aws:SecureTransport": "false" } }
    },
    {
      "Sid": "AllowLeastPrivilegeAppRole",
      "Effect": "Allow",
      "Principal": { "AWS": "arn:aws:iam::111122223333:role/DataUploaderRole" },
      "Action": ["s3:PutObject", "s3:GetObject", "s3:ListBucket"],
      "Resource": ["arn:aws:s3:::example-bucket", "arn:aws:s3:::example-bucket/*"]
    }
  ]
}
```

> **포인트**  
> - **이중 방어**: Endpoint Policy(“경로”), Bucket Policy(“목적지”)  
> - **기본 거부**: `Deny`부터 구성하고 **허용은 최소화**  
> - **TLS 강제**: `aws:SecureTransport`  

### 1-4) 검증(실행) 예시
```bash
# 엔드포인트 경유로 프라이빗 S3 접근 (리눅스 EC2 내부)
aws s3 ls s3://example-bucket/ --region ap-northeast-2

# 공인망 우회 시도(프록시/IGW 경유) → Bucket Deny 로 차단되어야 함
curl -I https://example-bucket.s3.ap-northeast-2.amazonaws.com/secret.txt
# 기대: 403 Forbidden (리소스 정책으로 차단)
```

### 1-5) DynamoDB 예 (Gateway Endpoint)
```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Sid": "DDBQueryFromThisVPCEOnly",
    "Effect": "Allow",
    "Principal": "*",
    "Action": ["dynamodb:Query", "dynamodb:GetItem"],
    "Resource": "arn:aws:dynamodb:ap-northeast-2:111122223333:table/Orders",
    "Condition": { "StringEquals": { "aws:SourceVpce": "vpce-0123ddb4567" } }
  }]
}
```

> **참고**: Interface Endpoint(PrivateLink) 서비스들(Secrets Manager, STS, ECR 등)도 **Endpoint Policy**로 액션/리소스를 좁힐 수 있다.

---

## 2) CloudFront + WAF + Shield Advanced로 DDoS/웹공격 방어

### 2-1) 설계 원칙
- **Edge 우선 차단**: 공격을 **오리진(앱)** 까지 보내지 않는다.  
- **다층 룰**: Managed Rule + Rate-based + 커스텀 시그니처 + Geo/ASN 제한.  
- **자동화**: Firewall Manager 정책으로 계정/리전 전체 표준화.  
- **기록**: WAF Logs → S3/Kinesis Firehose → Athena/Glue로 분석.

### 2-2) CloudFront + OAC + Private S3(정적 자산)
- **OAC(Origin Access Control)** 또는 **OAI**로 **S3 퍼블릭 차단**, CloudFront만 접근.
- S3 버킷 정책: `aws:PrincipalService = cloudfront.amazonaws.com` + OAC 서명 조건.

```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Sid": "AllowCFOnly",
    "Effect": "Allow",
    "Principal": { "Service": "cloudfront.amazonaws.com" },
    "Action": "s3:GetObject",
    "Resource": "arn:aws:s3:::static-assets-bucket/*",
    "Condition": {
      "StringEquals": { "AWS:SourceArn": "arn:aws:cloudfront::111122223333:distribution/EXAMPLE" }
    }
  }]
}
```

### 2-3) WAF Web ACL (핵심 룰 세트)
- **AWS Managed Rule**: Common, Known Bad Inputs, SQLi/XSS, BotControl(옵션)  
- **Rate-based Rule**: 예) `/login` 5분 1,000req/ip 초과 **차단**  
- **Geo Restriction**: 사업 관할 외 국가 **블록**  
- **Header/Body Size/URI 패턴**: 비정상 페이로드 컷오프

#### Terraform 예 (간략)
```hcl
resource "aws_wafv2_web_acl" "web_acl" {
  name        = "cf-web-acl"
  scope       = "CLOUDFRONT"
  default_action { allow {} }
  rule {
    name     = "AWSManagedCommon"
    priority = 1
    statement { managed_rule_group_statement { vendor_name = "AWS" name = "AWSManagedRulesCommonRuleSet" } }
    override_action { none {} }
    visibility_config { sampled_requests_enabled = true cloudwatch_metrics_enabled = true metric_name = "common" }
  }
  rule {
    name     = "RateLimitLogin"
    priority = 10
    statement {
      rate_based_statement {
        limit              = 1000
        aggregate_key_type = "IP"
        scope_down_statement {
          byte_match_statement {
            field_to_match { uri_path {} }
            positional_constraint = "EXACTLY"
            search_string         = "/login"
            text_transformations { priority = 0 type = "NONE" }
          }
        }
      }
    }
    action { block {} }
    visibility_config { sampled_requests_enabled=true cloudwatch_metrics_enabled=true metric_name="ratelogin" }
  }
  visibility_config { sampled_requests_enabled = true cloudwatch_metrics_enabled = true metric_name = "cfwebacl" }
}
```

### 2-4) Shield Advanced
- **Layer 3/4** 대규모 공격 완화, **DRT(응답팀) 연계**, **글로벌 통계 기반** 탐지.  
- CloudFront/ALB/Route 53/Global Accelerator 보호 대상 등록.  
- 비용 이슈: 고정 구독 + 데이터 전송 크레딧, **보호 자산 선택** 최적화.

### 2-5) 로깅/관찰가능성
- WAF Logs → Kinesis Firehose → S3 → **Athena 쿼리**  
- CloudFront Standard logs/Real-time logs → 공격 피크/오리진 부하 상관 분석  
- Security Hub/GuardDuty 통합 알람.

---

## 3) ALB + OIDC 인증: 프론트도어 인증/인가

### 3-1) 개념
- **ALB 리스너 규칙**에서 `authenticate-oidc` 수행 → 미인증 사용자는 **IdP 로그인**으로 리다이렉트.  
- 인증 성공 시 **JWT 토큰**(ID/Access)을 **헤더로 백엔드 전달**.  
- 백엔드는 토큰 클레임(roles, groups, email)을 확인하여 **세분화된 권한**.

### 3-2) ALB 리스너 규칙 (예: AWS CLI)
```bash
aws elbv2 create-rule \
  --listener-arn arn:aws:elasticloadbalancing:ap-northeast-2:111122223333:listener/app/my-alb/xxx/yyy \
  --priority 10 \
  --conditions Field=path-pattern,Values='/app/*' \
  --actions Type=authenticate-oidc,AuthenticateOidcConfig='{
    "Issuer":"https://cognito-idp.ap-northeast-2.amazonaws.com/ap-northeast-2_ABCDEF",
    "AuthorizationEndpoint":"https://your-domain.auth.ap-northeast-2.amazoncognito.com/oauth2/authorize",
    "TokenEndpoint":"https://your-domain.auth.ap-northeast-2.amazoncognito.com/oauth2/token",
    "UserInfoEndpoint":"https://your-domain.auth.ap-northeast-2.amazoncognito.com/oauth2/userInfo",
    "ClientId":"YOUR_CLIENT_ID",
    "ClientSecret":"YOUR_CLIENT_SECRET",
    "SessionCookieName":"alb-auth",
    "Scope":"openid profile email",
    "SessionTimeout":"604800"
  }' \
  Type=forward,TargetGroupArn=arn:aws:elasticloadbalancing:ap-northeast-2:111122223333:targetgroup/app-tg/zzz
```

> **보안 팁**  
> - ALB는 **HTTPS(ACM)** 필수  
> - 백엔드는 `x-amzn-oidc-*` 헤더 또는 `Authorization`(JWT) 검증 로직 포함  
> - **토큰 만료/리프레시 전략**, **로그아웃/세션 삭제** 시나리오 정의  
> - OIDC 클라이언트 시크릿 **Secrets Manager + IAM Role**로 안전 보관

### 3-3) 백엔드 예 (Node.js Express: JWT 검증)
```js
import express from 'express';
import jwt from 'jsonwebtoken'; // 또는 jose 라이브러리 권장
import jwksClient from 'jwks-rsa';

const app = express();
const ISSUER = 'https://cognito-idp.ap-northeast-2.amazonaws.com/ap-northeast-2_ABCDEF';
const client = jwksClient({ jwksUri: `${ISSUER}/.well-known/jwks.json` });

function getKey(header, callback) {
  client.getSigningKey(header.kid, (err, key) => {
    if (err) return callback(err);
    const signingKey = key.getPublicKey();
    callback(null, signingKey);
  });
}

app.use('/app', (req, res, next) => {
  const token = req.headers['authorization']?.replace(/^Bearer\s+/i, '');
  if (!token) return res.status(401).send('No token');
  jwt.verify(token, getKey, { algorithms: ['RS256'], issuer: ISSUER }, (err, decoded) => {
    if (err) return res.status(403).send('Invalid token');
    // 세분화 인가(roles, groups)
    if (!decoded['cognito:groups']?.includes('app-users')) {
      return res.status(403).send('Forbidden');
    }
    req.user = decoded;
    next();
  });
});

app.get('/app/hello', (req, res) => res.json({ hello: req.user.email }));
app.listen(3000);
```

### 3-4) 수식으로 정하는 레이트 제한(참고)
- IDP/ALB/백엔드 보호를 위해 **요청 상한(RPS)** 을 설계한다.
$$
R_{\text{max}} = \min\big(R_{\text{ALB}},\ R_{\text{IdP}},\ R_{\text{WAF}}\big)
$$

---

## 4) GWLB + IDS/IPS: 동서 트래픽 검사(세그멘테이션)

### 4-1) 개념
- **GWLB** = L3/L4 트래픽을 **GENEVE** 캡슐화로 **보안 어플라이언스**(IDS/IPS/NGFW)로 라우팅.  
- **Auto Scaling** + **Target Health**로 **수평 확장/고가용성**.  
- **Cross-Account/Shared Services** 패턴: 중앙 보안계정의 **Endpoint Service**를 여러 VPC에서 사용.

### 4-2) 구성 절차(요약)
1) 보안계정에서 **GWLB + Target Group(“GENEVE”)** 생성  
2) **보안 어플라이언스 ASG**(예: Suricata AMI) 등록  
3) **Endpoint Service**를 만들고 **원하는 계정 허용**  
4) 워크로드 계정 VPC에서 **GWLB Endpoint**를 생성, Route Table에 **트래픽 경유**  
5) CloudWatch/VPC Flow Logs/어플라이언스 로그 연계

### 4-3) Suricata 부팅 스크립트(간단 데모용)
```bash
#!/bin/bash
yum update -y
yum install -y suricata
cat >/etc/suricata/suricata.yaml <<'EOF'
# (실전은 최신 룰셋/출력 포맷/GENEVE MTU 고려 등 상세 튜닝 필요)
default-rule-path: /etc/suricata/rules
rule-files:
  - emerging-threats.rules
outputs:
  - eve-log:
      enabled: yes
      filetype: regular
      filename: /var/log/suricata/eve.json
EOF
systemctl enable --now suricata
```

### 4-4) 라우팅(예시)
- **프라이빗 서브넷 라우트 테이블**의 **0.0.0.0/0**(또는 특정 CIDR)을 **GWLB Endpoint**로 보내도록 설정  
- 특정 세그먼트/포트만 보낼 수도 있음(정책적 분기)

### 4-5) 오토스케일 정책 (네트워크 기준)
- **네트워크In/Out**, ENI PPS, CPU를 지표로 스케일 아웃/인  
- IDS/IPS가 과부하일 때 **드롭 대신 바이패스 여부**(운영 규칙) 명확화

### 4-6) 운영 팁
- 보안 어플라이언스 AMI/룰셋 **자동 업데이트 파이프라인**  
- **세그멘테이션 룰북**(허용/차단/로깅 수준) 관리 → GitOps  
- **MTU/Fragmentation/GENEVE 오버헤드** 고려한 패스 MTU 튜닝

---

## 5) 통합 IaC 예시(CloudFormation 스니펫 모음)

### 5-1) VPC Endpoint (S3, DynamoDB)
```yaml
Resources:
  S3Endpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: vpc-xxxx
      ServiceName: com.amazonaws.ap-northeast-2.s3
      VpcEndpointType: Gateway
      RouteTableIds: [rtb-aaa, rtb-bbb]
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action: ["s3:GetObject","s3:ListBucket"]
            Resource:
              - arn:aws:s3:::example-bucket
              - arn:aws:s3:::example-bucket/*
  DDBEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: vpc-xxxx
      ServiceName: com.amazonaws.ap-northeast-2.dynamodb
      VpcEndpointType: Gateway
      RouteTableIds: [rtb-aaa, rtb-bbb]
```

### 5-2) CloudFront + WAF 연결(핵심 속성만)
```yaml
Resources:
  WebACL:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: CfWebACL
      Scope: CLOUDFRONT
      DefaultAction: { Allow: {} }
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: CfWebACL
      Rules:
        - Name: ManagedCommon
          Priority: 1
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesCommonRuleSet
          OverrideAction: { None: {} }
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: Common
  Distribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultCacheBehavior:
          TargetOriginId: app-origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: ["GET","HEAD","OPTIONS","PUT","POST","PATCH","DELETE"]
        Origins:
          - Id: app-origin
            DomainName: alb-xyz.ap-northeast-2.elb.amazonaws.com
            CustomOriginConfig:
              OriginProtocolPolicy: https-only
        WebACLId: !GetAtt WebACL.Arn
```

### 5-3) ALB OIDC Rule (간단)
```yaml
Resources:
  OidcRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      Actions:
        - Type: authenticate-oidc
          AuthenticateOidcConfig:
            Issuer: https://cognito-idp.ap-northeast-2.amazonaws.com/ap-northeast-2_ABCDEF
            AuthorizationEndpoint: https://your-domain.auth.ap-northeast-2.amazoncognito.com/oauth2/authorize
            TokenEndpoint: https://your-domain.auth.ap-northeast-2.amazoncognito.com/oauth2/token
            UserInfoEndpoint: https://your-domain.auth.ap-northeast-2.amazoncognito.com/oauth2/userInfo
            ClientId: your_client_id
            ClientSecret: your_client_secret
            SessionCookieName: alb-auth
            Scope: "openid email profile"
        - Type: forward
          TargetGroupArn: arn:aws:elasticloadbalancing:ap-northeast-2:111122223333:targetgroup/app/xxx
      Conditions:
        - Field: path-pattern
          Values: ["/app/*"]
      ListenerArn: arn:aws:elasticloadbalancing:ap-northeast-2:111122223333:listener/app/my-alb/xxx/yyy
      Priority: 10
```

---

## 6) 운영 체크리스트(필수)

- [ ] **기본 거부** 후 **정밀 허용**: Endpoint Policy, 리소스 정책, SG, NACL  
- [ ] **TLS 강제**: `aws:SecureTransport`, HSTS, TLS1.2+  
- [ ] **CloudFront 앞단 의무화**: 외부 유입 경로 단일화  
- [ ] **WAF 관리형 룰 + Rate 기반 + 커스텀** 병행  
- [ ] **Shield Advanced**: 중요 업무 대상만 선별 보호  
- [ ] **ALB OIDC**: 프론트도어 인증/인가, 토큰 검증 로깅  
- [ ] **GWLB**: East/West 검사, 세그멘테이션 룰북 관리  
- [ ] **관찰가능성**: WAF Logs, CF Logs, VPC Flow Logs, IDS 이벤트를 **중앙 분석(ATHENA/SIEM)**  
- [ ] **IaC**: 정책/룰/분배/버전관리 자동화, Drift 감시  
- [ ] **침해사고 대비**: 블록리스트/레이트 조정/오토스케일 **런북** 문서화 및 리허설

---

## 7) 자주 하는 실수 & 방지

- **엔드포인트만 만들고 버킷 정책 미구성** → IGW 경유로 새는 트래픽 존재  
- **WAF 기본만 켜고 튜닝 없음** → 오탐/과탐으로 운영 혼선  
- **ALB OIDC 후 백엔드 검증 생략** → 토큰 헤더 신뢰 취약점  
- **GWLB 바이패스 경로 방치** → IDS 사각지대  
- **로그 수집만 하고 분석 미구현** → 탐지 지연  
- **멀티어카운트 표준화 실패** → 정책 일관성 붕괴(→ Firewall Manager/Org SCP 고려)

---

## 8) 성능/용량/비용 간단 수식

- **WAF Rate Rule 상한 추정**
$$
N_{\text{threshold}} \approx \alpha \cdot \bar{R}_{\text{정상}} + \beta \cdot \sigma
$$
- 정상 평균 RPS \(\bar{R}\), 표준편차 \(\sigma\), 안전계수 \(\alpha,\beta\) (업무 특성에 맞게 보정)

- **GWLB 어플라이언스 스케일 용량**
$$
C_{\text{need}} = \left\lceil \frac{PPS_{\text{peak}}}{PPS_{\text{inst}} \cdot U_{\max}} \right\rceil
$$
- 피크 패킷/초, 단일 인스턴스 처리 PPS, 허용 최대 이용률 \(U_{\max}\)

---

## 9) 트러블슈팅(현장 Q&A)

**Q. S3가 여전히 퍼블릭으로 열려 보입니다.**  
A. **퍼블릭 액세스 차단(S3 Block Public Access)** 전역·버킷 수준 모두 활성화, 버킷 정책에서 CloudFront OAC만 허용, **정책 시뮬레이터**로 검증.

**Q. WAF 룰이 과차단합니다.**  
A. “Count → Monitor → Block” 3단계 전환. 샘플링 로그로 원인 패턴 추출 후 예외 스코프(URI/쿼리/헤더) 최소화.

**Q. ALB OIDC 후 특정 브라우저에서 간헐 인증 실패.**  
A. 쿠키 도메인/패스, SameSite/보안 플래그, ALB/IdP 시간 동기화, Cognito 앱 클라이언트의 리다이렉트 URI 검증.

**Q. GWLB 경로에서 MTU 문제로 일부 서비스 끊김.**  
A. GENEVE 오버헤드 고려해 **Path MTU Discovery**/MSS 클램핑/어플라이언스 MTU 조정.

---

## 10) 마무리

이 문서의 템플릿들을 **그대로 복붙**해도 기본적인 보안 표준을 갖춘다.  
그러나 진짜 강건함은 **관찰–튜닝–자동화–리허설**의 반복에서 나온다.

- **VPC Endpoint Policy + 리소스 정책**으로 **프라이빗 최소 권한**  
- **CloudFront + WAF + Shield**로 **엣지에서 공격 차단**  
- **ALB OIDC**로 **프론트도어 인증**  
- **GWLB + IDS/IPS**로 **내부 트래픽 심층 검사**