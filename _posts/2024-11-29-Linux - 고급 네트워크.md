---
layout: post
title: Linux - 고급 네트워크
date: 2024-11-29 19:20:23 +0900
category: Linux
---
# 고급 네트워크 — VLAN, Bonding, 브리지, 고급 IP/라우팅, DNS 캐싱

## 사전 준비: 필수 도구 및 용어 이해

### 핵심 네트워크 진단 도구

```bash
ip -br a            # IP 주소 요약 표시
ip -d link show     # 링크 상세 정보 확인
ip -s link          # 인터페이스 통계 확인
ip -br r            # 라우팅 테이블 요약
ss -tulpen          # 포트 및 소켓 상태 확인
ethtool -i eth0     # 드라이버 정보 및 오프로드 설정
ethtool -k eth0     # 커널 오프로드 기능 상태
ethtool -g eth0     # 링 버퍼 크기 확인
tcpdump -ni eth0 vlan 10 or host 8.8.8.8  # VLAN 트래픽 캡처
mtr -4 -rw example.com  # 경로 추적 및 품질 측정
```

### 배포판별 네트워크 구성 파일

시스템 네트워크 구성을 위해 배포판별로 다른 구성 파일을 사용합니다:

- **Debian/Ubuntu 계열**
  - **Netplan (현대)**: `/etc/netplan/*.yaml` → `netplan apply`
  - **전통 방식**: `/etc/network/interfaces`
  - **systemd-networkd**: `/etc/systemd/network/*.network|*.netdev|*.link`

- **RHEL/Fedora/CentOS/Alma/Rocky 계열**
  - **NetworkManager + nmcli (권장)**
  - **전통 방식**: `/etc/sysconfig/network-scripts/ifcfg-*`

중요한 원칙은 하나의 시스템에서 여러 네트워크 관리 스택을 혼용하지 않는 것입니다. 예를 들어 NetworkManager만 사용하거나 systemd-networkd만 사용하는 것이 안정성에 도움이 됩니다.

---

## VLAN — 하나의 물리적 링크에 여러 논리적 네트워크

### VLAN의 기본 원리

VLAN(가상 LAN)은 하나의 물리적 네트워크 연결을 여러 개의 논리적 브로드캐스트 도메인으로 분할합니다:

- **802.1Q 태깅**: 4바이트 VLAN 태그를 이더넷 프레임에 추가 (VLAN ID 1-4094)
- **Access 포트**: 단일 VLAN에 속하는 포트 (태그 없음)
- **Trunk 포트**: 여러 VLAN 트래픽을 전달하는 포트 (태그 포함)
- 서버 NIC는 일반적으로 Trunk 모드로 구성되며, 운영체제에서 서브 인터페이스(`eth0.10`)를 통해 각 VLAN을 분리합니다

### 실시간 VLAN 인터페이스 생성

```bash
# eth0에 VLAN ID 10인 서브 인터페이스 생성
sudo ip link add link eth0 name eth0.10 type vlan id 10

# VLAN 인터페이스에 IP 주소 할당
sudo ip addr add 192.168.10.2/24 dev eth0.10

# VLAN 인터페이스 활성화
sudo ip link set eth0.10 up

# 확인
ip -d link show eth0.10
ip -br a | grep eth0.10
```

### 영구적인 VLAN 설정 예제

#### Netplan을 사용한 설정 (Debian/Ubuntu)

```yaml
# /etc/netplan/01-vlan.yaml
network:
  version: 2
  ethernets:
    eth0: {}  # 기본 이더넷 인터페이스
  vlans:
    vlan10:
      id: 10
      link: eth0
      addresses: [192.168.10.2/24]
      mtu: 1500
```
```bash
sudo netplan apply
```

#### systemd-networkd를 사용한 설정

```ini
# /etc/systemd/network/10-eth0.link
[Match]
MACAddress=aa:bb:cc:dd:ee:ff
[Link]
Name=eth0

# /etc/systemd/network/20-vlan10.netdev
[NetDev]
Name=vlan10
Kind=vlan
[VLAN]
Id=10

# /etc/systemd/network/30-vlan10.network
[Match]
Name=vlan10
[Network]
Address=192.168.10.2/24
```
```bash
sudo systemctl restart systemd-networkd
```

#### NetworkManager를 사용한 설정 (RHEL/Fedora)

```bash
nmcli con add type vlan con-name vlan10 dev eth0 id 10 ip4 192.168.10.2/24
nmcli con up vlan10
```

### VLAN 설정 검증 및 문제 해결

```bash
# VLAN 태그 정보 확인
ip -d link show eth0.10

# VLAN 트래픽 모니터링
tcpdump -ni eth0 vlan 10

# 스위치 측 설정 확인 필요
# - 포트가 Trunk 모드인지
# - VLAN 10이 허용되는지
# - Native VLAN 설정 확인
```

VLAN 환경에서 MTU(최대 전송 단위) 불일치 문제에 주의해야 합니다. 특히 점보 프레임을 사용하는 경우 모든 네트워크 장비에서 일관된 MTU 설정이 필요합니다.

---

## NIC Bonding/Teaming — 고가용성 및 대역폭 확장

### Bonding 모드 비교

| 모드 | 이름 | 특징 | 스위치 지원 필요 | 비고 |
|---|---|---|---|---|
| 0 | balance-rr | 라운드로빈 전송 | 아니오 | 순차적 전송, 일부 환경에서 호환성 문제 |
| 1 | active-backup | 장애 조치 전용 | 아니오 | 가장 안전하고 단순한 구성 |
| 2 | balance-xor | MAC 주소 기반 균형 | 부분적 | 스위치 설정 필요 가능성 |
| 4 | 802.3ad | LACP (링크 집합) | **필수** | 대역폭 집적 + 고가용성 |
| 6 | balance-alb | 적응형 부하 균형 | 아니오 | L2/L3 레벨 균형, 환경 의존적 |

최신 리눅스 배포판에서는 **bonding** 드라이버와 **teamd** 두 가지 기술이 공존합니다. NetworkManager는 이러한 차이를 추상화하여 관리합니다.

### Bonding 설정 예제

#### Netplan을 사용한 Bonding 설정

```yaml
# /etc/netplan/02-bond.yaml
network:
  version: 2
  ethernets:
    eth0: {}
    eth1: {}
  bonds:
    bond0:
      interfaces: [eth0, eth1]
      addresses: [192.168.1.100/24]
      parameters:
        mode: active-backup       # 또는 802.3ad
        primary: eth0
        mii-monitor-interval: 100  # 링크 모니터링 간격(ms)
```
```bash
sudo netplan apply
```

#### NetworkManager를 사용한 LACP Bonding

```bash
# Bond 인터페이스 생성
nmcli con add type bond ifname bond0 mode 802.3ad

# 슬레이브 인터페이스 추가
nmcli con add type ethernet ifname eth0 master bond0
nmcli con add type ethernet ifname eth1 master bond0

# IP 설정
nmcli con mod bond0 ipv4.addresses 192.168.1.100/24 ipv4.method manual

# 활성화
nmcli con up bond0
```

### Bonding 상태 확인

```bash
# Bonding 상태 정보 확인
cat /proc/net/bonding/bond0

# 인터페이스 상태 확인
ip -br a show bond0
```

LACP(802.3ad) 모드를 사용하는 경우 스위치 측 설정이 서버와 일치해야 정상적으로 작동합니다. `miimon=100` 파라미터는 링크 상태를 100ms 간격으로 모니터링합니다.

---

## Linux Bridge — 가상 스위치로 VM과 컨테이너 연결

### 브리지의 기본 개념

Linux Bridge는 소프트웨어 기반의 가상 스위치로, 가상 머신(KVM)이나 컨테이너(LXC/Docker)를 물리적 네트워크에 연결하는 데 사용됩니다. 브리지에 연결된 물리적 NIC는 직접 IP 주소를 갖지 않고, 브리지 인터페이스가 IP 주소를 관리합니다.

### 실시간 브리지 생성

```bash
# 브리지 인터페이스 생성
sudo ip link add name br0 type bridge

# 물리적 인터페이스를 브리지에 연결
sudo ip link set dev eth0 master br0

# 원래 인터페이스의 IP 주소 제거
sudo ip addr flush dev eth0

# 브리지에 IP 주소 할당
sudo ip addr add 192.168.1.10/24 dev br0

# 인터페이스 활성화
sudo ip link set br0 up
sudo ip link set eth0 up
```

### 영구적인 브리지 설정

#### Netplan 브리지 구성

```yaml
# /etc/netplan/03-bridge.yaml
network:
  version: 2
  ethernets:
    eth0: {}
  bridges:
    br0:
      interfaces: [eth0]
      addresses: [192.168.1.10/24]
      parameters:
        stp: true           # Spanning Tree Protocol 활성화
        forward-delay: 4    # 포워딩 지연 시간(초)
```

#### NetworkManager 브리지 구성

```bash
nmcli con add type bridge con-name br0 ifname br0
nmcli con add type ethernet con-name br0-port ifname eth0 master br0
nmcli con mod br0 ipv4.addresses 192.168.1.10/24 ipv4.method manual
nmcli con up br0
```

### 고급 브리지 관리

```bash
# 브리지 연결 상태 확인
bridge link show

# VLAN 설정 확인
bridge vlan show

# STP 상태 확인
bridge link show dev eth0 | grep state
```

브리지 환경에서는 STP(Spanning Tree Protocol)를 활성화하여 네트워크 루프를 방지하는 것이 중요합니다. 대규모 가상화 환경에서는 VXLAN이나 OVS(Open vSwitch)와 같은 고급 네트워킹 기술도 고려할 수 있습니다.

---

## 고급 IP 및 라우팅 — 다중 경로, 정책 라우팅, ECMP

### 다중 IP 및 다중 NIC 구성

```bash
# 여러 인터페이스에 IP 주소 할당
ip addr add 10.10.10.10/24 dev eth0
ip addr add 10.10.20.10/24 dev eth1
```

다중 인터페이스 환경에서는 반환 트래픽이 올바른 경로를 통해 돌아올 수 있도록 정책 라우팅이 필요합니다.

### 정책 라우팅 (소스 기반 라우팅)

정책 라우팅은 패킷의 소스 주소에 따라 다른 라우팅 테이블을 사용하도록 설정합니다:

```bash
# 커스텀 라우팅 테이블 정의
echo "200 wan1" | sudo tee -a /etc/iproute2/rt_tables
echo "201 wan2" | sudo tee -a /etc/iproute2/rt_tables

# 각 서브넷에 대한 라우팅 규칙 설정
sudo ip rule add from 10.10.10.0/24 table wan1
sudo ip route add default via 10.10.10.1 dev eth0 table wan1

sudo ip rule add from 10.10.20.0/24 table wan2
sudo ip route add default via 10.10.20.1 dev eth1 table wan2

# 현재 라우팅 규칙 확인
ip rule show
```

### ECMP (동등 비용 다중 경로)

ECMP를 사용하면 동일한 목적지에 대해 여러 개의 동등한 경로를 통해 트래픽을 분산할 수 있습니다:

```bash
sudo ip route replace default scope global \
  nexthop via 10.10.10.1 dev eth0 weight 1 \
  nexthop via 10.10.20.1 dev eth1 weight 1
```

ECMP는 커넥션 해시를 기반으로 부하 분산을 수행합니다. 대칭 라우팅을 보장하기 위해서는 방화벽 설정과 반환 경로도 함께 고려해야 합니다.

### rp_filter 설정 (리버스 경로 검증)

```bash
# 느슨한 소스 주소 검증 (정책 라우팅 시 권장)
sudo sysctl -w net.ipv4.conf.all.rp_filter=2
```

### Netplan을 통한 정책 라우팅 영구 설정

```yaml
# /etc/netplan/50-policy.yaml
network:
  version: 2
  ethernets:
    eth0:
      addresses: [10.10.10.10/24]
      routes: []
    eth1:
      addresses: [10.10.20.10/24]
      routes: []
  routing-policy:
    - from: 10.10.10.0/24
      table: 200
    - from: 10.10.20.0/24
      table: 201
  routing-tables:
    200: wan1
    201: wan2
```

---

## DNS 캐싱 및 포워딩 — dnsmasq 실전 구성

### dnsmasq 설치 및 기본 설정

```bash
# 설치
sudo apt install -y dnsmasq

# 서비스 활성화
sudo systemctl enable --now dnsmasq
```

### 기본 dnsmasq 구성

```ini
# /etc/dnsmasq.conf
domain-needed
bogus-priv

# 로컬 캐시 서버로 구성
no-resolv
server=1.1.1.1
server=8.8.8.8

# 수신 주소 지정
listen-address=127.0.0.1,192.168.1.10

# 캐시 설정
cache-size=2000
neg-ttl=60
```
```bash
sudo systemctl restart dnsmasq
```

### 로컬 도메인 오버라이드 및 분할 DNS

```ini
# /etc/dnsmasq.conf에 추가 또는 별도 파일로 관리
address=/dev.local/10.0.0.100
address=/api.internal/10.0.5.20
```

### resolv.conf 관리 주의사항

dnsmasq를 사용할 때는 DNS 확인자(resolver) 관리 주체를 하나로 통일해야 합니다:

```bash
# systemd-resolved와의 충돌 방지
# dnsmasq를 기본 DNS 서버로 설정
sudo rm -f /etc/resolv.conf
echo "nameserver 127.0.0.1" | sudo tee /etc/resolv.conf

# NetworkManager 사용 시
nmcli con mod <connection-name> ipv4.dns 127.0.0.1
```

### DNS 캐시 성능 검증

```bash
# DNS 쿼리 테스트 및 통계 확인
dig @127.0.0.1 example.com +stats

# 캐시 적중률 확인
dnsmasq --test
```

대규모 환경이나 보안 요구사항이 높은 환경에서는 **unbound**를 고려할 수 있습니다. unbound는 DNSSEC 검증 기능을 내장하고 있습니다.

---

## 네트워크 진단 및 운영을 위한 필수 명령어

### 링크 상태 및 성능 분석

```bash
# 인터페이스 상세 정보
sudo ethtool eth0

# 오프로드 기능 상태 확인
sudo ethtool -k eth0

# 링 버퍼 크기 조정 (드라이버 지원 시)
sudo ethtool -G eth0 rx 4096 tx 4096
```

고속 네트워크 인터페이스(10Gbps 이상)의 경우 오프로드 기능, 큐 관리, IRQ 바인딩, NUMA 친화성 등을 고려한 튜닝이 필요합니다.

### MTU 및 점보 프레임 설정

```bash
# MTU 설정
sudo ip link set eth0 mtu 9000

# 경로 MTU 검증
ping -M do -s 8972 <대상_IP>
```

점보 프레임을 사용하는 경우 네트워크 경로상의 모든 장비에서 일관된 MTU 설정이 필요합니다. 불일치 시 패킷 분할(fragmentation)이나 드롭이 발생할 수 있습니다.

### 네트워크 대기 시간 및 패킷 손실 모니터링

```bash
# 경로 추적 및 품질 측정
mtr -rw example.com

# 소켓 통계
ss -s

# 네트워크 통계
nstat -az | head
```

### 패킷 캡처 및 분석

```bash
# 특정 호스트와의 통신 캡처
sudo tcpdump -ni eth0 -w cap.pcap host 8.8.8.8

# DHCP 트래픽 모니터링
sudo tcpdump -ni br0 -vvv port 67 or port 68
```

---

## 방화벽 및 브리지 필터링 (nftables)

### 기본 nftables 방화벽 규칙

```bash
# 테이블 생성
sudo nft add table inet filter

# 입력(input) 체인 생성 (기본 정책: 거부)
sudo nft add chain inet filter input '{ type filter hook input priority 0; policy drop; }'

# 기본 허용 규칙 추가
sudo nft add rule inet filter input ct state established,related accept
sudo nft add rule inet filter input iif lo accept
sudo nft add rule inet filter input tcp dport {22,80,443} accept
sudo nft add rule inet filter input counter drop

# 규칙 확인
sudo nft list ruleset
```

### 브리지 레벨 필터링

```bash
# 브리지 필터 테이블 생성
sudo nft add table bridge brfilter

# 포워드 체인 생성
sudo nft add chain bridge brfilter forward '{ type filter hook forward priority 0; }'

# VLAN 태그 트래픽 허용
sudo nft add rule bridge brfilter forward ether type 0x8100 accept
```

브리지 패밀리는 L2(데이터 링크 계층) 수준에서 필터링을 수행합니다. L3/L4 필터링은 `inet`, `ip`, `ip6` 패밀리를 사용해야 합니다.

---

## 가상화 및 컨테이너 네트워킹 팁

### KVM/libvirt 네트워킹

- **기본 NAT**: `virbr0` 브리지와 내장 DHCP 서버
- **브리지 네트워킹**: 외부 IP 직접 할당이 필요한 경우 브리지 생성 후 가상 머신 연결
- **macvtap/macvlan**: 호스트와 L2 수준에서 분리된 가상 인터페이스

### 컨테이너 네트워킹

- **Docker 기본**: bridge 네트워크 드라이버
- **Kubernetes CNI**: Flannel, Calico, Cilium 등의 플러그인
- **서비스 메시**: NodePort, LoadBalancer, Inress 컨트롤러와의 통합

---

## 고가용성 클러스터링: VIP 페일오버 (Keepalived)

### Keepalived 기본 구성

```ini
# /etc/keepalived/keepalived.conf
vrrp_instance VI_1 {
    state MASTER                 # 주 노드
    interface eth0               # 모니터링 인터페이스
    virtual_router_id 51         # 가상 라우터 ID (클러스터 내 고유)
    priority 200                 # 선호도 (높을수록 우선순위 높음)
    advert_int 1                 # 알림 간격(초)
    
    virtual_ipaddress {
        192.168.1.50/24 dev eth0  # 가상 IP 주소
    }
    
    track_interface {
        eth0                    # 모니터링할 인터페이스
    }
}
```

보조 노드에서는 `state BACKUP`과 더 낮은 `priority` 값을 설정합니다. VIP(가상 IP) 기반의 L2 페일오버를 통해 서비스의 무중단 전환이 가능합니다.

---

## 실전 네트워크 시나리오

### 시나리오: 단일 NIC로 사내망과 DMZ 분리 (VLAN + 정책 라우팅)

```bash
# VLAN 인터페이스 생성 (VLAN 10: LAN, VLAN 20: DMZ)
ip link add link eth0 name eth0.10 type vlan id 10
ip link add link eth0 name eth0.20 type vlan id 20

# IP 주소 할당
ip addr add 10.0.10.2/24 dev eth0.10
ip addr add 10.0.20.2/24 dev eth0.20

# 커스텀 라우팅 테이블 정의
echo "200 lan" | tee -a /etc/iproute2/rt_tables
echo "201 dmz" | tee -a /etc/iproute2/rt_tables

# 정책 라우팅 규칙 설정
ip rule add from 10.0.10.0/24 table lan
ip route add default via 10.0.10.1 dev eth0.10 table lan

ip rule add from 10.0.20.0/24 table dmz
ip route add default via 10.0.20.1 dev eth0.20 table dmz
```

### 시나리오: KVM 가상 머신에 퍼블릭 IP 직접 할당

```bash
# 브리지 인터페이스 생성
ip link add name br0 type bridge

# 물리적 인터페이스를 브리지에 연결
ip link set eth0 master br0

# 원래 인터페이스의 IP 설정 제거
ip addr flush dev eth0

# 브리지에 퍼블릭 IP 할당
ip addr add 203.0.113.10/27 dev br0

# 인터페이스 활성화
ip link set br0 up
ip link set eth0 up

# 가상 머신의 네트워크 인터페이스를 br0에 연결하면
# 외부 IP를 직접 할당할 수 있습니다
```

### 시나리오: 사내 DNS 캐시 서버 구성

```ini
# /etc/dnsmasq.conf
domain-needed
bogus-priv
no-resolv
server=1.1.1.1
server=8.8.8.8
listen-address=127.0.0.1,10.0.0.1
cache-size=5000

# 내부 도메인 매핑
address=/intra.local/10.0.0.100
address=/git.intra.local/10.0.0.50
```
```bash
# 클라이언트 설정
echo "nameserver 10.0.0.1" > /etc/resolv.conf
```

---

## 네트워크 문제 해결 체크리스트

- **링크 업 상태지만 통신 불가**
  - `ip -s link`로 에러/드롭 통계 확인
  - `ethtool eth0`로 속도/듀플렉스/자동협상 상태 확인
  - 케이블, 광모듈, 스위치 포트 상태 점검

- **VLAN 통신 문제**
  - 서버 측 `eth0.10` 인터페이스 상태 확인
  - 스위치 측 Trunk 설정 및 VLAN 허용 목록 확인
  - `tcpdump -ni eth0 vlan 10`로 트래픽 확인

- **Bonding 불안정**
  - `/proc/net/bonding/bond0`로 LACP 상태 및 링크 파라미터 확인
  - 스위치 측 채널 그룹 및 해시 정책 일치성 점검

- **브리지 네트워크 문제**
  - STP 활성화 상태 확인
  - 불필요한 L2 루프 제거
  - 브리지 포워딩 상태 확인

- **정책 라우팅 비대칭 문제**
  - `ip rule` 및 라우팅 테이블 순서 확인
  - `rp_filter` 설정 모드 재점검
  - 방화벽 세션 정책 일관성 확인

- **DNS 캐시 성능 문제**
  - `dig +trace`로 재귀 확인 경로 분석
  - 상위 DNS 서버 응답 시간 확인
  - `dnsmasq --log-queries`로 캐시 적중률 분석

---

## 네트워크 성능 튜닝 참고사항

- **오프로드 최적화**: `ethtool -K eth0 tso on gso on gro on rx on tx on`
- **IRQ 분배**: `irqbalance` 서비스 또는 수동 CPU affinity 설정
- **RSS/RPS/RFS**: 다중 큐 NIC에서 CPU 병렬 처리 최적화
- **고성능 네트워킹**: HugePages, DPDK, eBPF 기술 활용 (특수 워크로드용)

---

## 핵심 명령어 및 파일 요약

| 범주 | 주요 명령어/파일 |
|---|---|
| VLAN 관리 | `ip link add link <nic> name <nic>.<id> type vlan id <id>` |
| Bonding 관리 | `/proc/net/bonding/*`, Netplan bonds, `nmcli con add ... mode 802.3ad` |
| Bridge 관리 | `ip link add name br0 type bridge`, Netplan bridges, `nmcli bridge` |
| 고급 라우팅 | `ip rule`, `ip route`, Netplan `routing-policy` |
| DNS 캐싱 | `dnsmasq`, `/etc/dnsmasq.conf`, `dig @127.0.0.1` |
| 네트워크 진단 | `ip -s link`, `ss -tulpen`, `ethtool`, `tcpdump`, `mtr` |
| 방화벽 구성 | `nft list ruleset`, `nft add rule ...` |

---

## 결론

고급 네트워크 관리는 리눅스 시스템 운영의 핵심 기술 중 하나입니다. 이 문서에서는 현장에서 바로 적용할 수 있는 실용적인 지식과 기술을 제공했습니다:

**L2 네트워킹**에서는 VLAN을 통해 논리적 네트워크를 분리하고, Bonding을 통해 고가용성과 대역폭을 확보하며, Linux Bridge를 통해 가상화 환경을 구성할 수 있습니다. 각 기술은 특정 사용 사례에 맞게 선택하고 조합해야 합니다.

**L3 네트워킹**에서는 정책 라우팅과 ECMP를 활용하여 복잡한 네트워크 토폴로지를 효율적으로 관리할 수 있습니다. 다중 경로 환경에서의 트래픽 분산과 장애 조치는 현대 네트워크 운영의 필수 요소입니다.

**DNS 인프라**에서는 dnsmasq와 같은 로컬 캐시 서버를 통해 네트워크 성능을 향상시키고, 내부 도메인 관리를 체계화할 수 있습니다. 적절한 DNS 캐싱 전략은 응용 프로그램 성능에 직접적인 영향을 미칩니다.

**보안 및 성능 최적화**에서는 nftables를 통한 방화벽 구성과 ethtool을 통한 네트워크 인터페이스 튜닝이 중요합니다. 특히 고속 네트워크 환경에서는 오프로드 기능과 큐 관리가 성능에 결정적인 역할을 합니다.

실제 운영 환경에서는 이러한 기술들을 단독으로 사용하기보다는 필요에 따라 조합하여 사용하게 됩니다. 예를 들어, VLAN으로 논리적 네트워크를 분리하고, Bonding으로 물리적 링크의 신뢰성을 확보하며, 정책 라우팅으로 트래픽을 제어하는 복합적인 구성을 흔히 볼 수 있습니다.

가장 중요한 것은 네트워크 변경 전에 충분한 테스트와 롤백 계획을 수립하는 것입니다. 네트워크 구성은 시스템의 핵심 인프라이므로 신중한 접근이 필요합니다. 문서화된 구성과 정기적인 검증 절차를 통해 안정적이고 예측 가능한 네트워크 운영 환경을 구축할 수 있습니다.