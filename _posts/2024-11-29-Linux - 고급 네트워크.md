---
layout: post
title: Linux - 고급 네트워크
date: 2024-11-29 19:20:23 +0900
category: Linux
---
# 고급 네트워크 — VLAN, Bonding, 브리지, 고급 IP/라우팅, DNS 캐싱

## 0) 사전 준비: 관측 도구·용어 정리

### 핵심 도구
```bash
ip -br a            # 주소 요약
ip -d link show     # 링크 + 확장 정보
ip -s link          # 인터페이스 통계
ip -br r            # 라우팅 요약
ss -tulpen          # 포트/소켓
ethtool -i eth0     # 드라이버/오프로드/링버퍼
ethtool -k eth0     # 오프로드 기능
ethtool -g eth0     # 링 버퍼 사이즈
tcpdump -ni eth0 vlan 10 or host 8.8.8.8
mtr -4 -rw example.com
```

### 구성 파일 계열(배포판/환경별 상이)
- **Debian/Ubuntu**  
  - (신) **Netplan**: `/etc/netplan/*.yaml` → `netplan apply`  
  - (전통) `/etc/network/interfaces`  
  - 또는 **systemd-networkd**: `/etc/systemd/network/*.network|*.netdev|*.link`
- **RHEL/Fedora/CentOS/Alma/Rocky**  
  - **NetworkManager + nmcli** (권장)  
  - (전통) `ifcfg-*` 파일

> 하나의 노드에 **여러 스택을 혼용하지 않는 것**이 안정적입니다(예: NM만 사용).

---

## 1) VLAN(Virtual LAN) — 하나의 물리선에 여러 브로드캐스트 도메인

### 1.1 원리 스냅샷
- 태깅 포맷: 802.1Q(4B Tag, VLAN ID 0~4095, 실제 1~4094)
- **Access 포트**: 단일 VLAN, **Trunk 포트**: 복수 VLAN 태그 전송
- 서버 NIC는 일반적으로 **Trunk**에 물리고, OS 측에서 **서브 인터페이스**(`eth0.10`)로 분리

### 1.2 즉시 실습(ip 명령)
```bash
# eth0의 VLAN 10 인터페이스 생성 + 주소 부여 + 업
sudo ip link add link eth0 name eth0.10 type vlan id 10
sudo ip addr add 192.168.10.2/24 dev eth0.10
sudo ip link set eth0.10 up

# 확인
ip -d link show eth0.10
ip -br a | grep eth0.10
```

### 1.3 영구 설정 예시

#### (A) Debian/Ubuntu — Netplan
```yaml
# /etc/netplan/01-vlan.yaml
network:
  version: 2
  ethernets:
    eth0: {}
  vlans:
    vlan10:
      id: 10
      link: eth0
      addresses: [192.168.10.2/24]
      mtu: 1500
```
```bash
sudo netplan apply
```

#### (B) systemd-networkd
```ini
# /etc/systemd/network/10-eth0.link
[Match]
MACAddress=aa:bb:cc:dd:ee:ff
[Link]
Name=eth0

# /etc/systemd/network/20-vlan10.netdev
[NetDev]
Name=vlan10
Kind=vlan
[VLAN]
Id=10

# /etc/systemd/network/30-vlan10.network
[Match]
Name=vlan10
[Network]
Address=192.168.10.2/24
```
```bash
sudo systemctl restart systemd-networkd
```

#### (C) 전통 /etc/network/interfaces
```ini
auto eth0.10
iface eth0.10 inet static
    address 192.168.10.2
    netmask 255.255.255.0
    vlan-raw-device eth0
```

#### (D) RHEL/Fedora — nmcli
```bash
nmcli con add type vlan con-name vlan10 dev eth0 id 10 ip4 192.168.10.2/24
nmcli con up vlan10
```

### 1.4 검증과 트러블슈팅
```bash
ip -d link show eth0.10        # 태그/프로토콜 확인
tcpdump -ni eth0 vlan 10       # 태깅 프레임 관측
```
- **스위치** 포트가 trunk인지, VLAN 10이 허용되는지 확인.
- 상호 MTU 불일치(점보프레임) 주의.

---

## 2) NIC Bonding/Teaming — 고가용성/대역폭/부하분산

### 2.1 모드 비교 요약
| 모드 | 특징 | 스위치 지원 | 비고 |
|---|---|---|---|
| 0 rr | 라운드로빈 | X | 순차 TX. 일부 장비 호환성 이슈 |
| 1 active-backup | 장애 조치 전용 | X | 가장 안전/단순 |
| 2 xor | MAC 기반 | △ | 스위치 설정 필요할 수도 |
| 4 802.3ad(LACP) | 표준 링크 집합 | **필요** | 대역폭 집적 + HA |
| 6 balance-alb | ARP/NIC 특수 | X | L2/L3 균형, 환경 의존 |

> 최신 배포판은 **bonding** 또는 **teamd**(RHEL 계열) 두 계열이 공존합니다. NetworkManager가 추상화해줍니다.

### 2.2 설정 예시

#### (A) Debian/Ubuntu — Netplan(bonding)
```yaml
# /etc/netplan/02-bond.yaml
network:
  version: 2
  ethernets: { eth0: {}, eth1: {} }
  bonds:
    bond0:
      interfaces: [eth0, eth1]
      addresses: [192.168.1.100/24]
      parameters:
        mode: active-backup       # 또는 802.3ad
        primary: eth0
        mii-monitor-interval: 100
```
```bash
sudo netplan apply
```

#### (B) RHEL/Fedora — nmcli(802.3ad)
```bash
nmcli con add type bond ifname bond0 mode 802.3ad
nmcli con add type ethernet ifname eth0 master bond0
nmcli con add type ethernet ifname eth1 master bond0
nmcli con mod bond0 ipv4.addresses 192.168.1.100/24 ipv4.method manual
nmcli con up bond0
```

### 2.3 상태·검증
```bash
cat /proc/net/bonding/bond0
ip -br a show bond0
```
- LACP는 **스위치 양단** 설정이 일치해야 집합됨.  
- `miimon=100`(링크 모니터링)으로 장애 감지 주기 설정.

---

## 3) Linux Bridge — 가상 스위치로 VM/컨테이너 L2 연결

### 3.1 원리
- Linux Bridge는 **소프트웨어 스위치**.  
- VM/KVM, LXC 등이 veth/tap으로 **br0**에 붙고, 물리 NIC(`eth0`)도 **br0 슬레이브**로 편입하면 **직접 IP** 할당 가능.

### 3.2 즉시 실습(ip)
```bash
sudo ip link add name br0 type bridge
sudo ip link set dev eth0 master br0
sudo ip addr flush dev eth0
sudo ip addr add 192.168.1.10/24 dev br0
sudo ip link set br0 up
sudo ip link set eth0 up
```

### 3.3 영구 설정

#### (A) Netplan
```yaml
# /etc/netplan/03-bridge.yaml
network:
  version: 2
  ethernets: { eth0: {} }
  bridges:
    br0:
      interfaces: [eth0]
      addresses: [192.168.1.10/24]
      parameters:
        stp: true
        forward-delay: 4
```

#### (B) nmcli
```bash
nmcli con add type bridge con-name br0 ifname br0
nmcli con add type ethernet con-name br0-port ifname eth0 master br0
nmcli con mod br0 ipv4.addresses 192.168.1.10/24 ipv4.method manual
nmcli con up br0
```

### 3.4 고급 옵션
```bash
bridge link show
bridge vlan show
# hairpin 포워딩(동일 포트로 리플렉션), 포트별 VLAN tagging 등 가능
```
- STP(Spanning Tree) 활성화로 루프 방지.
- VXLAN/OVS로 확장 네트워킹도 가능(데이터센터/클러스터링).

---

## 4) 고급 IP/라우팅 — 다중 경로, 정책 라우팅(SRP), ECMP

### 4.1 다중 IP, 다중 NIC
```bash
ip addr add 10.10.10.10/24 dev eth0
ip addr add 10.10.20.10/24 dev eth1
```
- **반환 경로**가 올바르게 잡히도록 **정책 라우팅** 필요.

### 4.2 정책 라우팅(소스 기반)
```bash
# 라우팅 테이블 정의
echo "200 wan1" | sudo tee -a /etc/iproute2/rt_tables
echo "201 wan2" | sudo tee -a /etc/iproute2/rt_tables

# 각 소스 대역은 각 게이트웨이로
sudo ip rule add from 10.10.10.0/24 table wan1
sudo ip route add default via 10.10.10.1 dev eth0 table wan1

sudo ip rule add from 10.10.20.0/24 table wan2
sudo ip route add default via 10.10.20.1 dev eth1 table wan2

# 우선순위 확인
ip rule show
```

### 4.3 ECMP(동가중 다중 경로)
```bash
sudo ip route replace default scope global \
  nexthop via 10.10.10.1 dev eth0 weight 1 \
  nexthop via 10.10.20.1 dev eth1 weight 1
```
- 커넥션 해시 기반 부하분산. **대칭 라우팅** 필요 시 방화벽/리턴 경로도 고려.

### 4.4 rp_filter/반사 방지
```bash
# 소스 주소 검증(느슨/엄격)
sudo sysctl -w net.ipv4.conf.all.rp_filter=2  # loose 추천(정책라우팅 시)
```

### 4.5 영구화(Netplan 예)
```yaml
# /etc/netplan/50-policy.yaml
network:
  version: 2
  ethernets:
    eth0: { addresses: [10.10.10.10/24], routes: [] }
    eth1: { addresses: [10.10.20.10/24], routes: [] }
  routing-policy:
    - from: 10.10.10.0/24
      table: 200
    - from: 10.10.20.0/24
      table: 201
  routing-tables:
    200: wan1
    201: wan2
```

---

## 5) DNS 캐시/포워더 — dnsmasq 실전

### 5.1 설치·기동
```bash
sudo apt install -y dnsmasq
sudo systemctl enable --now dnsmasq
```

### 5.2 기본 설정
```ini
# /etc/dnsmasq.conf
domain-needed
bogus-priv

# 로컬 캐시서버로 운용
no-resolv
server=1.1.1.1
server=8.8.8.8

listen-address=127.0.0.1,192.168.1.10
cache-size=2000
neg-ttl=60
```
```bash
sudo systemctl restart dnsmasq
```

### 5.3 로컬 오버라이드/스플릿 DNS
```ini
# /etc/hosts 또는 별도 파일
address=/dev.local/10.0.0.100
address=/api.internal/10.0.5.20
```

### 5.4 resolv.conf 상호작용 주의
- `systemd-resolved`와 **중복 제공 금지**.  
- `resolv.conf` 관리 주체를 **하나로 통일**.  
  - 예) dnsmasq 사용 시:
    ```bash
    sudo rm -f /etc/resolv.conf
    echo "nameserver 127.0.0.1" | sudo tee /etc/resolv.conf
    ```
- NM 사용 중이면 `nmcli`로 DNS를 127.0.0.1로 지정.

### 5.5 검증
```bash
dig @127.0.0.1 example.com +stats
```
- **RTT, SERVER, MSG SIZE**와 **캐시 적중 여부** 확인.

> 대규모/보안 중심이면 **unbound**(검증·DNSSEC) 조합도 고려.

---

## 6) 네트워크 진단·운영 치트시트

### 6.1 링크/속도/오프로드
```bash
sudo ethtool eth0
sudo ethtool -k eth0      # tso/gso/gro/lro rx/tx csum
sudo ethtool -G eth0 rx 4096 tx 4096   # 링버퍼 확장(드라이버 지원시)
```
- 고속 NIC(10G↑)는 **오프로드/큐/IRQ 바인딩/NUMA** 고려.

### 6.2 MTU/점보프레임
```bash
sudo ip link set eth0 mtu 9000
ping -M do -s 8972 <peer>   # 패스 MTU 검증
```
- 경로 상 **모든 구간**의 MTU 일치 필요(미스매치 → 프래그먼트/드롭).

### 6.3 대기/손실 관측
```bash
mtr -rw example.com
ss -s
nstat -az | head
```

### 6.4 패킷 캡처
```bash
sudo tcpdump -ni eth0 -w cap.pcap host 8.8.8.8
sudo tcpdump -ni br0 -vvv port 67 or port 68   # DHCP
```

---

## 7) 방화벽·브리지 포워딩 보안(nftables)

### 7.1 기본 정책(nft)
```bash
sudo nft add table inet filter
sudo nft add chain inet filter input  '{ type filter hook input  priority 0; policy drop; }'
sudo nft add rule  inet filter input ct state established,related accept
sudo nft add rule  inet filter input iif lo accept
sudo nft add rule  inet filter input tcp dport {22,80,443} accept
sudo nft add rule  inet filter input counter drop
sudo nft list ruleset
```

### 7.2 브리지 필터링(계층 주의)
```bash
sudo nft add table bridge brfilter
sudo nft add chain bridge brfilter forward '{ type filter hook forward priority 0; }'
sudo nft add rule  bridge brfilter forward ether type 0x8100 accept  # VLAN 태그 허용 예시
```
- **bridge 패밀리**는 L2 레벨 필터(ebtables 대체).  
- L3/L4는 `inet`/`ip`/`ip6` 패밀리에서 처리.

---

## 8) 가상화/컨테이너 네트워킹 팁

### 8.1 libvirt 기본 NAT
- `virbr0` NAT, DHCP 자동.  
- 외부 직접 IP가 필요하면 **브리지 br0**를 생성 후 도메인 NIC를 br0에 연결.

### 8.2 macvtap/macvlan
- 호스트와 **L2 분리**되어 **호스트 ↔ 게스트 통신 제한** 가능.  
- 외부 스위치와 직접 통신이 필요하지만 브리지를 쓰기 어려울 때 유용.

### 8.3 컨테이너(CNI) 개요
- Docker 기본 bridge, Kubernetes는 CNI(Flannel, Calico, Cilium 등).  
- NodePort/LoadBalancer/Ingress의 **경로/포트/정책**을 방화벽과 함께 설계.

---

## 9) HA — VRRP(keepalived) 맛보기

### 9.1 VIP 떠넘기기
```ini
# /etc/keepalived/keepalived.conf(요지)
vrrp_instance VI_1 {
  state MASTER
  interface eth0
  virtual_router_id 51
  priority 200
  advert_int 1
  virtual_ipaddress {
    192.168.1.50/24 dev eth0
  }
  track_interface {
    eth0
  }
}
```
- 보조 노드는 `state BACKUP`, `priority` 낮게.
- VIP(가상 IP) 기반 L2 이동으로 **서비스 무중단 전환**.

---

## 10) 운영 체크리스트(성능/안정/보안)

- **네트워크 설계**: VLAN 설계서(ACL/트렁크/MTU/라우팅) 문서화
- **LACP**: 스위치·서버 모드 일치, LAG 상태 모니터링
- **경로대칭**: 정책 라우팅 시 rp_filter=loose, 방화벽 세션 테이블 일관
- **DNS**: 캐시/오버라이드/업스트림 구조, `resolv.conf` 소유권 통일
- **관측**: 링크에러(ethtool), 드롭 카운터(ip -s), 큐 오버런, 세그오프로드
- **보안**: nftables 기본 `drop`, 필요 포트만 개방, 브리지 필터 분리
- **장애복구**: 변경 전 `ip addr`/`ip route` 스냅샷, 롤백 스크립트 보유

---

## 11) 실전 시나리오

### 11.1 “한 NIC로 사내망/DMZ 분리” (VLAN trunk + 정책 라우팅)
```bash
# VLAN 10=LAN, VLAN 20=DMZ
ip link add link eth0 name eth0.10 type vlan id 10
ip link add link eth0 name eth0.20 type vlan id 20
ip addr add 10.0.10.2/24 dev eth0.10
ip addr add 10.0.20.2/24 dev eth0.20

# 라우팅 정책
echo "200 lan" | tee -a /etc/iproute2/rt_tables
echo "201 dmz" | tee -a /etc/iproute2/rt_tables
ip rule add from 10.0.10.0/24 table lan
ip route add default via 10.0.10.1 dev eth0.10 table lan
ip rule add from 10.0.20.0/24 table dmz
ip route add default via 10.0.20.1 dev eth0.20 table dmz
```

### 11.2 “KVM에 퍼블릭 IP 직결” (br0)
```bash
ip link add name br0 type bridge
ip link set eth0 master br0
ip addr flush dev eth0
ip addr add 203.0.113.10/27 dev br0
ip link set br0 up
ip link set eth0 up

# VM NIC을 br0에 붙이면 외부 IP 직접 할당 가능
```

### 11.3 “사내 전체 DNS 캐시 + 내부 도메인”
```ini
# /etc/dnsmasq.conf
domain-needed
bogus-priv
no-resolv
server=1.1.1.1
server=8.8.8.8
listen-address=127.0.0.1,10.0.0.1
cache-size=5000

# 내부 도메인
address=/intra.local/10.0.0.100
address=/git.intra.local/10.0.0.50
```
```bash
echo "nameserver 10.0.0.1" > /etc/resolv.conf
```

---

## 12) 트러블슈팅 플레이북

- **링크는 up인데 통신 X**  
  - `ip -s link`(에러/드롭), `ethtool eth0`(Speed/Duplex/Auto-negotiation)  
  - 케이블/광모듈/스위치 포트 상태 확인
- **VLAN 통신 X**  
  - 서버 `eth0.10` 정상? 스위치 트렁크에 VLAN 허용? Native VLAN 충돌?  
  - `tcpdump -ni eth0 vlan 10`
- **Bonding 불안정**  
  - `/proc/net/bonding/bond0`로 LACP/링크 파라미터 확인  
  - 스위치 채널그룹/해시 정책 일치성 점검
- **브리지 루프/폭풍**  
  - STP 활성화, 포트비용 조정, 불필요한 L2 루프 제거
- **정책 라우팅 비대칭**  
  - `ip rule`/테이블 순서, `rp_filter` 모드 재점검, 방화벽 세션 정책
- **DNS 캐시 미적중/지연**  
  - `dig +trace`, 상위 서버 RTT, 도메인 재귀/권한 문제 점검  
  - `dnsmasq --log-queries`로 캐시 적중률 관찰

---

## 13) 보너스: 성능 튜닝 퀵노트

- **오프로드**: `ethtool -K eth0 tso on gso on gro on rx on tx on`
- **IRQ 분배/NUMA 친화**: `irqbalance` 또는 수동 CPU affinity
- **RSS/RPS/RFS**: 멀티큐 NIC에서 CPU 병렬 처리 최적화
- **HugePages/DPDK/eBPF**: 초고속(특수) 워크로드

---

## 14) 명령/파일 요약표

| 범주 | 주요 명령/파일 |
|---|---|
| VLAN | `ip link add link <nic> name <nic>.<id> type vlan id <id>` |
| Bonding | `/proc/net/bonding/*`, Netplan bonds, `nmcli con add ... mode 802.3ad` |
| Bridge | `ip link add name br0 type bridge`, Netplan bridges, `nmcli bridge` |
| 라우팅 | `ip rule`, `ip route`, Netplan `routing-policy` |
| DNS 캐시 | `dnsmasq`, `/etc/dnsmasq.conf`, `dig @127.0.0.1` |
| 진단 | `ip -s link`, `ss -tulpen`, `ethtool`, `tcpdump`, `mtr` |
| 방화벽 | `nft list ruleset`, `nft add rule ...` |

---

## 마무리

이 글은 **현장용 레퍼런스**를 지향했습니다.  
- L2: **VLAN/브리지/Bonding**으로 토폴로지를 설계하고,  
- L3: **정책 라우팅/ECMP**로 다중 경로를 안정화하며,  
- **DNS 캐시**로 지연을 줄이고,  
- **nftables/오프로드 튜닝**으로 안전성과 성능을 함께 확보합니다.