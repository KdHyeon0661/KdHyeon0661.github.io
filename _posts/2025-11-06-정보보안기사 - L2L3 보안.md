---
layout: post
title: 정보보안기사 - L2/L3 보안
date: 2025-11-06 20:25:23 +0900
category: 정보보안기사
---
# L2/L3 보안(스위칭·VLAN·STP, 라우팅·ACL·uRPF)

## 0) 토폴로지(예시)

```
        [ISP/Internet]
              |
        [Edge Router R1]  <-- uRPF/BCP38, BGP/OSPF 인증, CoPP, Edge ACL
              |
        [Core L3 SW C1]   <-- Inter-VLAN Routing, VACL, PVLAN(옵션)
           /        \
 [Access SW A1]   [Access SW A2]  <-- DHCP Snooping/DAI/IPSG, Port-Sec, Storm Control, STP 보호
      |                    |
   (유선단말/서버)     (IP Phone/PC/프린터 등)
```

- **VLAN**: `10=USER`, `20=VOIP`, `30=PRINTER`, `99=MGMT`, `999=BLACKHOLE`  
- **Native VLAN**은 사용하지 않거나(=999 블랙홀) 철저히 **트렁크 외부와 격리**.

---

# 1) L2 보안: 스위칭·VLAN·트렁크 베스트 프랙티스

## 1.1 공통 기본(Access Switch)

- **사용하지 않는 포트**는 `shutdown` + `access vlan 999(폐기)` + `spanning-tree portfast`, `bpduguard` **활성**
- **트렁크는 최소화**: 필요한 링크만 수동으로 지정(`switchport mode trunk`), **DTP 비활성**
- **VLAN 허용 리스트**를 **선택적**으로(`allowed vlan 10,20,30,99`) — **전체 허용 금지**
- **Native VLAN**은 운영 VLAN과 분리(예: `999`) 또는 **트렁크에서 native 사용 금지**(벤더 의존)

### Cisco IOS-XE(Access 포트 표준 템플릿)
```cisco
interface range gi1/0/1 - 24
 switchport mode access
 switchport access vlan 10
 spanning-tree portfast
 spanning-tree bpduguard enable
 storm-control broadcast level 1.00 0.50
 storm-control multicast level 1.00 0.50
 storm-control unicast level 1.00 0.50
 ip dhcp snooping limit rate 30
 switchport port-security
 switchport port-security maximum 2
 switchport port-security violation restrict
 switchport port-security mac-address sticky
!
interface gi1/0/25
 switchport mode trunk
 switchport trunk allowed vlan 10,20,30,99
 switchport trunk native vlan 999
 switchport nonegotiate       ! DTP 비활성
 spanning-tree guard root     ! 코어 측에서만 고려, 액세스단은 BPDU Guard 선호
```

### Juniper Junos(개념 유사)
```junos
set interfaces ge-0/0/1 unit 0 family ethernet-switching port-mode access
set interfaces ge-0/0/1 unit 0 family ethernet-switching vlan members VLAN10
set ethernet-switching-options storm-control interface ge-0/0/1 level 1
set protocols stp edge-interface ge-0/0/1
set protocols stp bpdu-block-on-edge
```

> **왜?**  
> - **VLAN Hopping(DTP, Native VLAN 이슈)** 차단  
> - **BPDU 스푸핑**에 의한 루프/루트 탈취 방지  
> - 브로드캐스트/멀티캐스트 **스톰 제어**로 L2 고장 격리

---

## 1.2 VLAN Hopping 방지 포인트

- DTP 비활성: `switchport nonegotiate`  
- 트렁크 수동 지정 + **허용 VLAN 최소화**  
- **Native VLAN**은 사용자 VLAN과 분리(예: `999`)  
- Access 포트에 **트렁크 허용 금지**(자동 협상 끔)

---

# 2) STP(Spanning Tree) 보안

## 2.1 목표

- 루프 방지(기본), **루트 위치 고정**(Core/Distribution), **엣지 포트 보호**  
- 악의적/오동작 장비의 **BPDU 주입** 차단

## 2.2 필수 기능

- **PortFast(Edge)**: 단말포트 즉시 포워딩(링크업 지연 최소화)  
- **BPDU Guard**: Edge 포트에서 **BPDU 수신 시 에러-디스에이블**  
- **Root Guard**: **원치 않는 루트**로 승격 방지(업링크에)  
- **Loop Guard**: 일방향 링크로 인한 **고스트 루프** 방지  
- **BPDU Filter**: 특별 케이스(대개 권장 X, 오용 위험)

### Cisco 예시
```cisco
spanning-tree mode rapid-pvst
spanning-tree extend system-id
! 루트는 코어에서 명시
spanning-tree vlan 10,20,30 priority 4096

interface range gi1/0/1 - 24
 spanning-tree portfast
 spanning-tree bpduguard enable
!
interface gi1/0/25
 spanning-tree guard root    ! 루트는 코어, 액세스단 uplink에 설정
```

### 검증
```cisco
show spanning-tree summary
show spanning-tree interface gi1/0/1 detail
show errdisable recovery
```

> **운영 팁**: BPDU Guard로 떨어진 포트는 **원인 조사 후** 타이머 기반 자동복구(선택) 설정.

---

# 3) L2 데이터 평면 보호: DHCP Snooping / DAI / IP Source Guard / Port-Security / Storm Control

## 3.1 DHCP Snooping (필수)

- **신뢰 포트**(Upstream DHCP 서버/릴레이) vs **비신뢰 포트**(엣지)  
- 바인딩 테이블 생성: (MAC, VLAN, IP, Lease, Port)  
- **Option-82** 삽입/검증

### Cisco 구성
```cisco
ip dhcp snooping
ip dhcp snooping vlan 10,20,30
ip dhcp snooping information option
!
interface gi1/0/1
 ip dhcp snooping limit rate 30
! 업링크(서버 방향)
interface gi1/0/25
 ip dhcp snooping trust
```

**검증**
```cisco
show ip dhcp snooping
show ip dhcp snooping binding
```

## 3.2 DAI(Dynamic ARP Inspection)

- **DHCP Snooping 바인딩**을 신뢰 기반으로 ARP 검증  
- 고정 IP(정적 장비)는 **ARP ACL**로 예외 등록

```cisco
ip arp inspection vlan 10,20,30
!
ip arp inspection limit rate 30 burst interval 1
!
! 바인딩이 없는 정적 IP용 ARP ACL(필요시)
arp access-list STATIC-PRINTER
 permit ip host 192.168.10.50 mac host aaaa.bbbb.cccc
!
interface gi1/0/1
 ip arp inspection trust            ! DHCP 서버/업링크만 trust
!
ip arp inspection filter STATIC-PRINTER vlan 10
```

**검증**
```cisco
show ip arp inspection interfaces
show ip arp inspection statistics
```

## 3.3 IP Source Guard (IPSG)

- **DHCP Snooping 바인딩** or **IP/MAC 정적 바인딩**을 이용해 **소스 IP 스푸핑 차단**

```cisco
interface gi1/0/10
 ip verify source                 ! DHCP 바인딩 기반
! 또는
ip source binding 0011.2233.4455 vlan 10 192.168.10.101 interface gi1/0/10
```

## 3.4 Port Security

- MAC 개수 제한 + Sticky + 위반 액션(`protect/restrict/shutdown`)

```cisco
interface gi1/0/11
 switchport mode access
 switchport access vlan 10
 switchport port-security
 switchport port-security maximum 2
 switchport port-security mac-address sticky
 switchport port-security violation restrict
```

## 3.5 Storm Control

```cisco
interface range gi1/0/1-24
 storm-control broadcast level 1.00 0.50
 storm-control multicast level 1.00 0.50
 storm-control action trap
```

---

# 4) VACL / PACL / Private VLAN / (옵션) VLAN 방화벽

## 4.1 PACL(Port ACL): **포트** 단위 L3/L4 필터
```cisco
ip access-list extended PACL-USER10
 permit tcp any host 192.168.30.10 eq 9100
 deny   ip any 192.168.30.0 0.0.0.255
 permit ip any any
!
interface gi1/0/12
 ip access-group PACL-USER10 in
```

## 4.2 VACL(VLAN ACL): **VLAN 내 트래픽** 필터(동일 VLAN 내 접근 제어)
```cisco
ip access-list extended VACL-BLOCK-TO-PRN
 deny ip any 192.168.30.0 0.0.0.255
 permit ip any any
!
vlan access-map VACL10 10
 match ip address VACL-BLOCK-TO-PRN
 action drop
vlan access-map VACL10 20
 action forward
!
vlan filter VACL10 vlan-list 10
```

## 4.3 Private VLAN(PVLAN)

- **Community/Isolated/Promiscuous** 포트로 L2 격리  
- 같은 VLAN에 있어도 **서로 통신 못함**, 게이트웨이만 접근 허용

> 벤더/모델별 구성 차이가 크므로 설계 단계에서 미리 검증하세요.

---

# 5) IPv6 L2 보호 (간단 요점)

- **RA Guard**: 악성 Router Advertisement 차단  
- **DHCPv6 Guard**: 비허가 서버 차단  
- **ND Inspection**: NDP 스푸핑 방지(벤더 종속)  
- **MLD Snooping**: 멀티캐스트 제어

> IPv6는 ARP 대신 **NDP(ICMPv6)** 사용 → ARP 기반 DAI 대신 **ND 보호** 필요.

---

# 6) L3 보안: 라우팅·ACL·uRPF·CoPP

## 6.1 ACL(경계·인터-VLAN)

### 6.1.1 표준/확장 ACL (Cisco)
```cisco
ip access-list extended EDGE-IN
 remark Drop bogon (예시, 실제 bogon 목록은 최신화)
 deny   ip 10.0.0.0 0.255.255.255 any
 deny   ip 172.16.0.0 0.15.255.255 any
 deny   ip 192.168.0.0 0.0.255.255 any
 permit tcp any host 203.0.113.10 eq 443
 permit icmp any any echo-reply
 deny   ip any any log
!
interface gi0/0
 ip access-group EDGE-IN in
```

> **BCP38(소스 주소 검증)**: 엣지에서 사설/유효하지 않은 소스의 **인바운드**를 차단.

### 6.1.2 인터-VLAN ACL(코어 L3 스위치)
```cisco
ip access-list extended FROM-USER10
 deny   ip any 192.168.30.0 0.0.0.255
 permit ip any any
!
interface vlan 10
 ip access-group FROM-USER10 in
```

---

## 6.2 uRPF (Unicast Reverse Path Forwarding)

**개념**: **소스 IP**가 라우팅 테이블(FIB)상 **합당한 경로**로 회신 가능한지 검증  
- **Strict**: 패킷이 들어온 **그 인터페이스로** 소스에 대한 **역방향 경로**가 있어야 함(**대칭 라우팅** 전제)  
- **Loose**: 라우터에 **어떤 인터페이스로든** 소스 접두사가 **존재**하면 통과(인터넷 엣지에서 흔함)

### Cisco IOS-XE
```cisco
! 인터페이스 단위
interface gi0/0
 ip verify unicast source reachable-via rx    ! Strict
 ip verify unicast source reachable-via any   ! Loose
! 옵션
 ip verify unicast source reachable-via rx allow-default allow-self-ping
```

### Juniper Junos
```junos
set interfaces ge-0/0/0 unit 0 family inet rpf-check
! 또는 정책 기반(루즈/스트릭트 유사 동작은 정책과 함께 설계)
```

> **주의**: **ECMP/비대칭 라우팅** 환경에서는 Strict가 정상 트래픽을 차단할 수 있음 → **Loose** 또는 **uRPF 예외(ACL)** 고려.  
> NAT/VRF 환경에서는 **FIB 조회 결과**가 변형되므로 반드시 **랩 검증**.

---

## 6.3 CoPP(Control Plane Policing) — 제어평면 보호

- 라우터/스위치 **CPU를 향한 트래픽**(TTL-Expired, ICMP, BGP, OSPF 등)에 **Rate-Limit/Permit**  
- 공격성 패킷/폭주로 인한 **제어평면 마비** 방지

```cisco
ip access-list extended COPP-ALLOWED-ICMP
 permit icmp any any time-exceeded
 permit icmp any any unreachable
!
class-map match-any CMP-ICMP
 match access-group name COPP-ALLOWED-ICMP
class-map match-any CMP-ROUTING
 match protocol bgp
 match protocol ospf
!
policy-map CONTROL-PLANE-POLICY
 class CMP-ICMP
  police 64000 conform-action transmit exceed-action drop
 class CMP-ROUTING
  police 64000 conform-action transmit exceed-action drop
 class class-default
  drop
!
control-plane
 service-policy input CONTROL-PLANE-POLICY
```

---

## 6.4 라우팅 프로토콜 보안

### OSPF
- **인증**: OSPFv2(MD5), OSPFv3(IPsec AH/ESP)  
- **패시브 인터페이스**: 불필요한 네트워크에서 Hello 차단

```cisco
router ospf 10
 area 0 authentication message-digest
 interface gi0/1
  ip ospf message-digest-key 1 md5 Secr3tKey
!
router ospf 10
 passive-interface default
 no passive-interface gi0/1
```

### BGP (엣지)
- **TTL Security(Hop-limit)**: eBGP는 일반적으로 **TTL=1**(직접 연결), TTL-Hack으로 보호  
- **MD5 키체인**(TCP-AO가 이상적이나 호환 문제)  
- **Prefix 제한**, **Bogon 필터**, **Max-Prefix**  
- **Route-Map**으로 **수신/송신 필터**

```cisco
router bgp 64512
 neighbor 198.51.100.1 remote-as 64513
 neighbor 198.51.100.1 ebgp-multihop 2
 neighbor 198.51.100.1 ttl-security hops 2
 neighbor 198.51.100.1 password 7 05080F1A0C...   ! MD5
 neighbor 198.51.100.1 maximum-prefix 50 80 restart 5
!
ip prefix-list ALLOW-IN seq 5 permit 203.0.113.0/24
route-map BGP-IN permit 10
 match ip address prefix-list ALLOW-IN
!
neighbor 198.51.100.1 route-map BGP-IN in
```

---

# 7) 검증·모니터링

### 스위치
```cisco
show interfaces status err-disabled
show spanning-tree summary
show ip dhcp snooping binding
show ip arp inspection statistics
show port-security interface gi1/0/11
show storm-control
```

### 라우터/코어
```cisco
show ip route
show cef drop
show policy-map control-plane
show ip bgp summary
show ip ospf neighbor
```

### 서버/호스트
```bash
ip addr; ip route; ip neigh
ping -c 3 default-gw
arp -an
```

---

# 8) 랩 시나리오

## 시나리오 A — “DHCP Snooping + DAI + IP Source Guard” 한 번에

**목표**: 임의 DHCP 서버/ARP 스푸핑 차단, IP 스푸핑 방지  
**단계**

1) 스위치 전역에 `ip dhcp snooping` + VLAN 지정  
2) DHCP 서버로 가는 업링크만 `trust`, 엣지는 `untrust` + `rate limit`  
3) `ip arp inspection vlan` 적용, 업링크만 `ip arp inspection trust`  
4) DHCP 바인딩 확인 후 `ip verify source` (IPSG) 적용  
5) 정적 IP 장비는 `arp access-list` 예외 및 `ip source binding` 정적 바인딩

**검증**
```cisco
show ip dhcp snooping binding
show ip arp inspection interfaces
show ip verify source
```

---

## 시나리오 B — “STP 보호 + 포트 보안”

**목표**: 엣지 포트(BPDU Guard/PortFast), 업링크(Root Guard), MAC 제한  
**단계**

- 액세스 포트: `spanning-tree portfast`, `bpduguard enable`  
- 업링크: `guard root`  
- Port Security: `maximum 2`, `sticky`, `violation restrict`  
- 스톰 컨트롤: 브로드/멀티/유니캐스트 1%/0.5%

**검증**
```cisco
show spanning-tree interface gi1/0/10 detail
show port-security interface gi1/0/10
```

---

## 시나리오 C — “경계 라우터: uRPF(Loose) + Edge ACL + CoPP”

**목표**: 스푸핑/제어평면 공격 방지  
**단계**

1) 인바운드 Edge ACL로 **사설/예약** 소스 차단(BCP38)  
2) 인터페이스에 `ip verify unicast source reachable-via any`(Loose uRPF)  
3) CoPP로 ICMP/OSPF/BGP 등 **속도 제한**  
4) BGP는 **MD5/TTL-Security** + **prefix-limit**

**검증**
```cisco
show cef drop
show ip interface | i verify
show policy-map control-plane
```

---

# 9) 운영 체크리스트

- [ ] **Access 포트**: `access vlan` 지정, `portfast+bpduguard`, `port-security`, storm-control  
- [ ] **트렁크**: DTP 비활성, Native VLAN 분리(999), 허용 VLAN 최소화  
- [ ] **DHCP Snooping/DAI/IPSG**: 전역/포트별 신뢰/바인딩/예외  
- [ ] **STP Root**: 코어에서 우선순위 설정, 액세스 업링크 Root Guard  
- [ ] **IPv6 L2 보호**: RA/DHCPv6 Guard, ND 검증  
- [ ] **Edge ACL**: Bogon/사설 소스 Drop(BCP38)  
- [ ] **uRPF**: 엣지는 Loose, 내부는 트래픽 특성에 따라 Strict/예외  
- [ ] **CoPP**: 제어평면 트래픽은 폴리싱/화이트리스트  
- [ ] **라우팅 인증**: OSPF MD5/OSPFv3 IPsec, BGP MD5/TTL-Sec, Max-Prefix  
- [ ] **로그/알림**: DHCP Snooping/DAI/Port-Sec/Err-Disable 이벤트 Syslog/SNMP Trap

---

# 10) 트러블슈팅 & 롤백

- **DAI로 정상 단말 차단**: DHCP 바인딩 확인 → 정적 단말은 `arp access-list` 추가 or `ip source binding`  
- **uRPF로 정상 트래픽 Drop**: 비대칭 경로 여부 확인 → Loose로 조정 or 예외 ACL  
- **BPDU Guard 연동 중단**: 원인(허브/스위치 연결) 확인 → 자동복구 타이머 설정 고려  
- **CoPP 과도한 폴리싱**: BGP/OSPF 이웃 Flap → 폴리싱 수치 상향/분류 정교화

**롤백 예시**
```cisco
no ip arp inspection vlan 10
interface gi1/0/10
 no ip verify source
!
interface gi0/0
 no ip verify unicast source reachable-via any
!
control-plane
 no service-policy input CONTROL-PLANE-POLICY
```

---

# 11) 미니 과제(실전형)

1) **DHCP Snooping + DAI**만으로 **ARP 스푸핑 툴**이 차단되는지 랩에서 증명(로그/카운터 캡처)  
2) Access 포트에 **포트 시큐리티**를 걸고 허브 장착 시 어떤 이벤트가 발생하는지 확인(Err-Disable?)  
3) 경계 라우터에 **uRPF Loose**와 **Edge ACL**을 동시 적용, 사설 소스 ICMP가 차단되는지 패킷 캡처로 확인  
4) 코어 스위치에서 **STP 루트 우선순위**를 변경하고, 액세스 업링크에 **Root Guard**가 동작하는지 Failover 테스트

---

# 12) 요약

- L2: **PortFast + BPDU Guard + DHCP Snooping + DAI + IPSG + Port-Sec + Storm Control** = 액세스 단 보안의 표준 조합  
- L3: **Edge ACL(BCP38) + uRPF(Loose/Strict 선택) + CoPP + 라우팅 인증** = 경계/코어 방어의 기본  
- 운영: **DTP/NATIVE VLAN 정리**, **허용 VLAN 최소화**, **로그/알림**으로 가시성 확보 → **변경은 파일럿 → 단계적 배포**