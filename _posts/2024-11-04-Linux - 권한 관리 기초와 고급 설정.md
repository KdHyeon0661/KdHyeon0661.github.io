---
layout: post
title: Linux - 권한 관리 기초와 고급 설정
date: 2024-11-04 19:20:23 +0900
category: Linux
---
# 권한 관리 기초와 고급 설정

## 1. 파일 권한의 의미(기초 복습 + 디렉터리 차이)

- 권한은 **소유자(owner)**, **그룹(group)**, **기타(others)** 세 축에 대해 **읽기(r)** **쓰기(w)** **실행(x)**을 부여한다.
- **파일과 디렉터리의 권한 의미가 다르다**는 점이 핵심이다.

| 대상 | r | w | x |
|---|---|---|---|
| **파일** | 읽기 | 수정 | 실행 |
| **디렉터리** | 목록 조회(ls) | 엔트리 생성/삭제/이름변경 | **진입/탐색(traverse)** |

> 디렉터리에 `x`가 없으면 `cd` 진입이 안 되고, `r`이 없으면 목록은 못 보지만 **정확한 이름을 알고 있으면 접근**은 가능할 수 있다(상위 권한에 따라).

**권한 표기와 8진수**
- 기호: `rwxr-x---`
- 8진수: `u=7(111), g=5(101), o=0(000)` → `750`

권한 합성 공식:
$$
\text{perm} = 4\cdot I(r) + 2\cdot I(w) + 1\cdot I(x)
$$

검증:
```bash
ls -ld some_dir
namei -l /path/to/some_dir   # 경로 전체의 권한 체인 확인(탐색 실패 지점 파악)
```

---

## 2. `chmod` — 변경 패턴 총정리(숫자/기호/특수비트)
```bash
# 숫자 표기
chmod 755 script.sh            # rwxr-xr-x
chmod 640 secret.txt           # rw-r-----

# 기호 표기
chmod u+x,g-w,o= file.sh       # u: +x, g: -w, o: 아무 권한 없음
chmod -R u=rwX,go-rwx data/    # X: 디렉터리 또는 원래 x 있던 파일에만 실행 부여

# 디렉터리 일괄
find /srv/www -type d -exec chmod 755 {} \;
find /srv/www -type f -exec chmod 644 {} \;
```

**숫자 요약**

| 숫자 | 권한 | 의미 |
|---|---|---|
| 7 | rwx | 읽기/쓰기/실행 |
| 6 | rw- | 읽기/쓰기 |
| 5 | r-x | 읽기/실행 |
| 4 | r-- | 읽기 |
| 0 | --- | 없음 |

**특수비트(앞자리)**  
- setuid(4), setgid(2), sticky(1)

```bash
chmod 4755 /usr/local/bin/tool   # setuid + 755
chmod 2755 /shared/teamdir       # setgid 디렉터리: 그룹 상속
chmod 1777 /tmp                  # sticky: 소유자만 삭제 가능
```

실행 파일의 setuid는 보안 리스크가 크다. **가능하면 Capabilities(섹션 7)** 로 대체한다.

---

## 3. `chown` / `chgrp` — 소유자·그룹 제어
```bash
sudo chown user:group file.txt
sudo chown -R www-data:www-data /var/www
sudo chgrp developers /srv/repo
```
- **NFS/CIFS** 등 원격 FS는 서버측 ID 매핑/마운트 옵션에 따라 동작이 달라진다(UID/GID 매칭 필요).

---

## 4. `umask` — 기본 권한의 근본
**신규 파일 기본 모드**는 보통 **파일 666, 디렉터리 777에서 umask를 뺀 값**이다.

$$
\text{final} = \text{base} - \text{umask}
$$

예:
- `umask 022` → 파일: 666-022=**644**, 디렉토리: 777-022=**755**
- `umask 077` → 파일: **600**, 디렉토리: **700**

```bash
umask          # 현재 마스크
umask 027      # 그룹 r-x, 기타 ---
```

**서비스 단위 umask**는 systemd 서비스 파일의 `UMask=` 또는 ExecStart 전 `umask` 호출로 조정 가능.

---

## 5. 특수 비트의 실제 효과(디렉터리/공유 작업)
- **setgid 디렉터리**: 그 디렉터리에서 만들어지는 파일/디렉터리의 **그룹이 상속**된다(협업에 유용).
```bash
sudo chgrp -R devs /srv/project
sudo chmod 2775 /srv/project
```
- **sticky 디렉터리**: `/tmp`처럼 여러 사용자가 쓰는 공간에서 **소유자만 자신의 파일을 삭제**할 수 있게 강제.

---

## 6. ACL(Access Control List) — 세분화 권한의 핵심
기본 3축(u/g/o)만으로는 부족할 때 **개별 사용자/그룹에 추가 권한을 부여**한다.

### 6.1 사전 준비/마운트 옵션
```bash
# 패키지
sudo apt install -y acl        # Debian/Ubuntu
sudo dnf install -y acl        # Fedora/RHEL

# 마운트 옵션 확인 (ext4 등)
mount | grep -E ' / | acl'
# 또는 /etc/fstab에 acl 옵션: defaults,acl
```

### 6.2 파일/디렉터리 ACL 설정
```bash
# 단일 파일
setfacl -m u:john:r-- file.txt        # john에게 읽기
setfacl -m g:devs:rw- project.log     # devs 그룹에 rw

# 재귀/디렉터리
setfacl -Rm u:john:rwX /data/project/
# X: 디렉터리에만 x 부여, 파일에는 원래 x 있을 때만
```

### 6.3 **디폴트 ACL(상속 규칙)**
디렉터리에 **default ACL**을 걸면 **새로 생성되는 항목**에 ACL이 상속된다.
```bash
# default ACL 부여(디렉터리)
setfacl -m d:u:john:rwX /data/project
setfacl -m d:g:devs:rwX /data/project
```

### 6.4 ACL 제거/확인
```bash
setfacl -x u:john file.txt    # 특정 엔트리 제거
setfacl -b file.txt           # ACL 전체 제거
getfacl file.txt              # ACL 확인
```

### 6.5 **ACL의 마스크(MASK) 주의**
ACL의 **mask** 엔트리는 **추가 권한의 상한**이다. `chmod`가 mask를 갱신해 **의도치 않게 효과가 줄어들 수 있음**.  
`getfacl`에서 `mask::rwx` 등을 확인하고 필요 시 `setfacl -m m::rwx`로 조정.

---

## 7. Linux Capabilities — setuid의 현대적 대안
setuid는 **루트 전체 권한**을 얻는 위험한 방식. **Capabilities**로 **필요한 능력만 최소 부여**한다.

### 7.1 기본 명령
```bash
# 바이너리에 능력 부여(퍼시스턴트)
sudo setcap cap_net_bind_service=+ep /usr/local/bin/myserver   # 1024 미만 포트 바인딩 권한

# 확인
getcap /usr/local/bin/myserver
```

### 7.2 자주 쓰는 캡 능력 예
- `cap_net_bind_service`: 80/443 등 **low port 바인딩** 허용
- `cap_sys_admin`: 매우 광범위(지양)
- `cap_dac_override`: 접근제어 무시(지양)

**원칙**: **정말 필요한 최소 권한만** 부여.

---

## 8. 파일 속성(immutability 등) — `chattr` / `lsattr`
일반 퍼미션과 별개로 **확장 파일 속성**을 설정해 삭제/변경을 더 강하게 막을 수 있다(ext 계열 등).

```bash
# 변경 불가(루트라도 삭제/수정 불가, 먼저 속성 해제 필요)
sudo chattr +i /important/config.yml
sudo chattr -i /important/config.yml

# append-only(추가만 가능, 로그 무결성 강화)
sudo chattr +a /var/log/secure
```
확인:
```bash
lsattr /important/config.yml
```

---

## 9. 확장 속성(XAttr) — `getfattr` / `setfattr`
애플리케이션/보안 시스템이 활용하는 **키-값 메타데이터**.

```bash
sudo apt install -y attr
setfattr -n user.comment -v "owned-by-data-team" data.csv
getfattr -d data.csv
```

---

## 10. `sudo`/`su`/`passwd`/`id` — 계정·권한 승격의 모범 사례
```bash
# 현재 사용자의 UID/GID/그룹
id

# 현재 사용자 이름
whoami

# 일시적 승격
sudo <command>
sudo -u www-data ls /var/www
sudo -i                       # root 로그인 셸

# 사용자 전환 (root 비밀번호 필요)
su -                          # root 환경으로 전환
su otheruser                  # 특정 사용자로 전환

# 비밀번호 정책
passwd                        # 자기 비밀번호 변경
sudo passwd -l testuser       # 계정 잠금
```

### 10.1 sudoers 안전 편집
```bash
sudo visudo
```
예시(비밀번호 없이 특정 명령 허용 — 신중!):
```
%deploy ALL=(root) NOPASSWD: /usr/bin/systemctl restart myapp
```

### 10.2 PAM/로그인 정책(개요)
- `/etc/login.defs`, `/etc/pam.d/`에서 **패스워드 만료, 복잡도, 재사용 금지** 설정 가능.
- 예: `pam_pwquality.so`, `pam_faillock.so`로 시도 제한/락아웃.

---

## 11. 네임스페이스/컨테이너와 권한
- 컨테이너는 user/mount/net/pid 네임스페이스로 **격리**.  
- rootless 컨테이너는 userns 매핑으로 **호스트 root 권한을 직접 갖지 않음**.  
- 컨테이너 내 Capabilities는 **필요 최소**로 유지(`--cap-drop ALL` + `--cap-add ...`).

```bash
# Podman 예: rootless 실행
podman run --rm -it --cap-drop ALL --cap-add NET_BIND_SERVICE nginx
```

---

## 12. SELinux/AppArmor(정책 기반 MAC) — 개념과 빠른 진단
**DAC(일반 퍼미션/ACL)** 위에 **MAC(강제 접근 제어)**를 얹어 **정책으로 차단**한다.

### 12.1 SELinux (RHEL/Fedora/Alma/Rocky 등)
상태 확인:
```bash
getenforce
sestatus
```
로그/진단:
```bash
# 거부로그 확인 (audit 패키지)
sudo ausearch -m avc -ts recent
# 또는
sudo journalctl -t setroubleshoot
```
임시 Permissive(원인 파악용, 상용환경 주의):
```bash
sudo setenforce 0
```
**정석은 booleans/contexts 조정**:
```bash
# 컨텍스트 라벨 보기
ls -Z /var/www/html

# httpd가 네트워크 연결 허용 예(환경에 맞춰)
sudo setsebool -P httpd_can_network_connect on
```
파일 컨텍스트 복원:
```bash
sudo restorecon -Rv /var/www/html
```

### 12.2 AppArmor (Ubuntu 등)
```bash
sudo aa-status
sudo aa-logprof     # 거부 로그 기반 정책 학습
```

> **포인트**: 퍼미션/ACL이 맞는데도 접근이 막히면 **SELinux/AppArmor**를 의심하고 **정책/컨텍스트/프로파일**을 점검한다.

---

## 13. 실전 시나리오 모음

### 13.1 팀 공유 디렉터리 — 그룹 상속 + 기본 ACL
목표: 모든 파일이 `devs` 그룹 소유, 기본 권한 `rw` 보장.
```bash
sudo mkdir -p /srv/project
sudo chgrp -R devs /srv/project
sudo chmod 2775 /srv/project                   # setgid 디렉터리
setfacl -m d:g:devs:rwx /srv/project           # 디폴트 ACL
setfacl -m d:o::--- /srv/project               # others 차단
```
검증:
```bash
touch /srv/project/a
ls -l /srv/project/a            # 그룹이 devs로 상속되는지
getfacl /srv/project            # default ACL 확인
```

### 13.2 80/443 포트 바인딩 — setuid 없이 Capabilities
```bash
sudo setcap cap_net_bind_service=+ep /usr/local/bin/myserver
getcap /usr/local/bin/myserver
```

### 13.3 로그 무결성 — append-only + sticky
```bash
sudo chattr +a /var/log/myapp.log
sudo chmod 1755 /var/log/myapplogdir     # sticky
```

### 13.4 배포 자동화 계정 — sudo 제한
```
# visudo
%deploy ALL=(root) NOPASSWD: /usr/bin/systemctl restart myapp, /usr/bin/journalctl -u myapp
```
배포 스크립트:
```bash
sudo -n systemctl restart myapp
```

### 13.5 “권한은 맞는데 접근 실패” — 진단 루틴
```bash
# 1. 경로 전체 탐색 권한 확인
namei -l /srv/app/config.yaml

# 2. ACL/마스크 점검
getfacl /srv/app/config.yaml

# 3. SELinux/AppArmor
getenforce && sudo ausearch -m avc -ts recent
sudo aa-status
```

---

## 14. 권한 검색/감사/리포팅 팁

**이상 권한 빠르게 찾기**
```bash
# world-writable 파일
find /var/www -type f -perm -o=w -ls

# setuid/setgid 바이너리
find / -perm -4000 -o -perm -2000 -xdev -type f -ls 2>/dev/null
```

**감사 로그(auditd) 개요**
```bash
sudo apt install -y auditd
sudo auditctl -w /etc/shadow -p rwxa -k shadow_watch
sudo ausearch -k shadow_watch
```

---

## 15. 퍼미션 수학(umask/ACL/마스크) — 빠른 계산 예시

### 15.1 umask 계산
$$
\text{file\_mode} = 666 - \text{umask}, \quad \text{dir\_mode} = 777 - \text{umask}
$$
- `umask 027` → 파일: `640`, 디렉토리: `750`.

### 15.2 ACL 마스크와 유효 권한
**effective** 권한 = **(기본 권한 ∪ 추가 ACL)** **∩** **mask**  
마스크가 `r--`이면 추가로 준 `x`도 막힌다.  
`getfacl`에서 `mask::` 행을 꼭 확인하라.

---

## 16. 체크리스트 — 안전한 초기 권한 표준안

- 디렉터리: **750**, 파일: **640** (개인/팀용), `umask 027`
- 공개 정적 자산(웹 루트): 디렉터리 **755**, 파일 **644**
- 공유 작업 디렉터리: **setgid + default ACL**로 그룹 상속
- 중요 설정 파일: **600**(소유자만)
- 실행 파일/스크립트: **750**(팀 실행), 필요 시 Capabilities
- `/tmp` 유사 디렉터리: **1777**(sticky)
- setuid 바이너리: **최소화**, 필요 시 **Capabilities** 전환 검토
- SELinux/AppArmor: **Enforcing** 유지, 정책/라벨링으로 해결

---

## 17. 자주 하는 실수와 예방

- `chmod -R 777` 남발 → **최소 권한 원칙** 위배  
- `setfacl` 후 `chmod`로 마스크가 바뀌어 권한이 **사라진 것처럼 보임**  
- 디렉터리에서 `x` 빠져 **탐색 불가**  
- NFS/컨테이너에서 UID/GID 매칭 실패로 권한 오동작  
- SELinux/AppArmor 무지로 “퍼미션 정상인데 접근 불가” 상황 장기화

---

## 18. 요약(명령어 표)

| 범주 | 핵심 명령/파일 |
|---|---|
| 기본 퍼미션 | `chmod`, `chown`, `chgrp`, `umask` |
| 특수비트 | `chmod 4/2/1xxx` (setuid/setgid/sticky) |
| ACL | `setfacl`, `getfacl` (`-m`, `-x`, `-b`, `-R`, `d:`) |
| Capabilities | `setcap`, `getcap` |
| 파일 속성 | `chattr`, `lsattr` |
| 확장 속성 | `setfattr`, `getfattr` |
| 탐색/진단 | `namei -l`, `find -perm`, `stat`, `ls -lZ` |
| sudoers | `visudo`, `/etc/sudoers`, `/etc/sudoers.d/*` |
| SELinux | `getenforce`, `setenforce`, `semanage`, `restorecon`, `ausearch` |
| AppArmor | `aa-status`, `aa-logprof` |
| 감사 | `auditd`, `auditctl`, `ausearch` |

---

## 19. 마무리
- **퍼미션/ACL/Capabilities/정책(MAC)**를 **계층적으로** 이해하면, “최소 권한” 원칙을 실무에서 실현할 수 있다.
- 문제 발생 시에는 **경로 탐색권한 → ACL/마스크 → Capabilities → SELinux/AppArmor** 순서로 점검하라.
- 팀 공유/서비스 운영/규제 대응(감사)까지 고려한다면, 본문 체크리스트를 **기본 보안 표준**으로 삼아 일관되게 적용하라.