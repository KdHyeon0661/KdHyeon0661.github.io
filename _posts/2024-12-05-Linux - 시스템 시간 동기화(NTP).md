---
layout: post
title: Linux - 시스템 시간 동기화(NTP)
date: 2024-12-05 19:20:23 +0900
category: Linux
---
# 리눅스 시스템 시간 동기화 자세히 알아보기

> 목표
> - 분산 시스템, 보안, 로그 관리 관점에서 **시간 동기화의 중요성** 이해하기
> - `ntpd`, `chronyd`, `systemd-timesyncd`의 **특징 비교와 선택 기준** 확립하기
> - NTP의 **핵심 개념(스트라텀, 오프셋, 지연, 지터, Slew/Step 조정)** 을 수식과 함께 깊이 있게 이해하기
> - 다양한 환경(서버/클라이언트, 가상화/컨테이너)을 위한 **정확한 설정 예시**와 **보안(NTS, 방화벽)** 적용하기
> - 운영 자동화(Ansible)와 효과적인 **모니터링 방법** 익히기

---

## 핵심 개념 요약

**NTP(Network Time Protocol)** 는 인터넷을 통해 컴퓨터 시계를 동기화하는 프로토콜로, 계층적(**Stratum**) 구조를 가집니다.

**오프셋(Offset)** 은 내 시스템 시계와 실제 참조 시간 사이의 차이(초 단위)를 의미합니다.
**지연(Delay)** 은 네트워크 왕복 통신에 걸리는 시간입니다.
**지터(Jitter)** 는 시간 측정값의 통계적 변동성(분산)을 나타냅니다.

**Slew와 Step**은 시계 보정의 두 가지 방식입니다.
*Slew*는 시계 속도를 서서히 조정하여 응용 프로그램에 미치는 영향을 최소화하지만, 큰 오차를 수정하는 데는 시간이 걸립니다.
*Step*은 시계를 즉시 점프시켜 큰 오차를 빠르게 해결하지만, 타임스탬프에 민감한 일부 애플리케이션에 문제를 일으킬 수 있습니다.

**드리프트(Drift)** 는 하드웨어 오실레이터의 고유 오차로, `driftfile`을 통해 장기적으로 추정하고 보정합니다.
**RTC(Real Time Clock, 하드웨어 시계)** 는 CMOS 배터리로 구동되며, 시스템 부팅 시 시스템 시계를 초기화하는 데 사용됩니다.

NTP의 기본 계산식은 다음과 같습니다. \(t_1\)은 클라이언트 전송 시간, \(t_2\)는 서버 수신 시간, \(t_3\)는 서버 전송 시간, \(t_4\)는 클라이언트 수신 시간을 의미합니다.
$$
\delta = (t_4 - t_1) - (t_3 - t_2), \quad
\theta = \frac{(t_2 - t_1) + (t_3 - t_4)}{2}
$$
여기서 \( \delta \)는 왕복 지연, \( \theta \)는 오프셋을 나타냅니다. \( \delta \)가 작을수록 네트워크 대칭성이 좋아져 오프셋 추정이 더 정확해집니다.

---

## `ntpd` — 전통적인 NTP 데몬

안정성이 검증되어 서버 환경에서 여전히 널리 사용됩니다.

### 설치 및 기본 명령어

```bash
# Debian/Ubuntu
sudo apt update
sudo apt install -y ntp

# 상태 확인
ntpq -p # 피어 상태 상세 확인
ntpstat # 동기화 상태 간단 확인
```

`ntpq -p` 출력의 주요 열:
* `remote`: 서버 주소. `*`는 현재 선택된 서버, `+`는 사용 가능한 후보, `-`는 제외된 서버를 의미합니다.
* `refid`: 해당 서버가 참조하는 상위 시간 소스.
* `st`: Stratum(계층).
* `when`: 마지막으로 응답을 받은 때부터 지난 시간(초).
* `poll`: 다음 폴링까지의 시간(초, 2의 지수).
* `reach`: 8진수로 표시된 연결 성공 비트 필드(값 377이 이상적).
* `delay`, `offset`, `jitter`: 각각 지연, 오프셋, 지터 값입니다.

### 구성 파일 예시 (`/etc/ntp.conf`)

```conf
# 지역 NTP 풀 프로젝트 서버 사용 (빠른 초기 동기화를 위한 iburst 옵션)
pool 0.kr.pool.ntp.org iburst
pool 1.kr.pool.ntp.org iburst

# 하드웨어 클럭 드리프트 파일 지정
driftfile /var/lib/ntp/ntp.drift

# 접근 제어 (보안 강화)
restrict default kod nomodify notrap nopeer noquery # 기본적으로 모든 변조 및 쿼리 거부
restrict 127.0.0.1 # 로컬 호스트는 허용
restrict ::1
```

큰 시간 오차가 있을 경우 초기화하는 방법:
```bash
sudo service ntp stop
sudo ntpd -gq # -g: 큰 오차 허용, -q: 한 번 동기화 후 종료
sudo service ntp start
```

---

## `chronyd` — 현대적이고 유연한 NTP 구현체

네트워크 상태가 불안정하거나 가상 머신 환경에서 뛰어난 성능을 보이며, 현재 가장 권장되는 도구입니다.

### 설치 및 기본 명령어

```bash
# 대부분의 배포판
sudo apt install -y chrony  # 또는 dnf install -y chrony
sudo systemctl enable --now chronyd

# 상태 모니터링
chronyc tracking # 핵심 동기화 상태 요약
chronyc sources -v # 모든 시간 소스의 상세 상태
chronyc sourcestats -v # 소스별 통계 정보
```

### 구성 파일 예시 (`/etc/chrony/chrony.conf`)

```conf
# 외부 NTP 서버 풀 사용
pool 0.kr.pool.ntp.org iburst maxsources 4
pool 1.kr.pool.ntp.org iburst maxsources 4

# 초기 큰 오차는 Step으로 즉시 수정, 이후에는 Slew로 안정적으로 조정
makestep 1.0 3

# 시스템 클럭 드리프트를 RTC에 주기적으로 동기화
rtcsync
driftfile /var/lib/chrony/chrony.drift

# 로깅 설정
logdir /var/log/chrony
log measurements statistics tracking
```

### 운영 팁

* `sudo chronyc makestep` 명령으로 즉시 큰 오차를 수정할 수 있습니다.
* 가상 머신 스냅샷 복원 후나 시스템 부팅 직후에 유용하게 사용할 수 있습니다.

---

## `systemd-timesyncd` — 경량 클라이언트

systemd에 내장된 간단한 NTP 클라이언트로, 단일 데스크톱이나 간단한 클라이언트 시스템에 적합합니다.

### 사용법

```bash
# 상태 확인 및 설정
timedatectl status
timedatectl set-ntp true # NTP 동기화 활성화
timedatectl set-timezone Asia/Seoul # 시간대 설정

# 설정 파일: /etc/systemd/timesyncd.conf
sudo systemctl restart systemd-timesyncd
```

---

## 고급 구성 및 보안

### 방화벽 구성

NTP는 UDP 123번 포트를 사용합니다.
* **클라이언트**: 외부 NTP 서버로의 아웃바운드(UDP/123) 연결을 허용해야 합니다.
* **서버**: 내부 클라이언트로부터의 인바운드(UDP/123) 연결을 허용하고, `restrict`(ntpd) 또는 `allow`(chronyd) 지시어로 특정 네트워크만 접근하도록 제한해야 합니다.

### NTS(Network Time Security)

NTS는 NTP 통신에 TLS 기반 인증과 암호화를 제공하여 중간자 공격을 방지합니다. chrony 4.0 이상에서 지원됩니다.

```conf
# /etc/chrony/chrony.conf
server time.cloudflare.com nts iburst
```

### 로컬 Stratum 1 서버 구성 (GPS/PPS)

고정밀 시간 동기화가 필요한 환경에서는 GPS 수신기와 PPS(초당 펄스) 신호를 이용해 로컬 Stratum 1 서버를 구성할 수 있습니다.

```conf
# /etc/chrony/chrony.conf (개요)
refclock SHM 0 poll 3 refid GPS precision 1e-1
refclock PPS /dev/pps0 refid PPS precision 1e-7
```

---

## 특수 환경: 가상화 및 컨테이너

### 가상 머신

하이퍼바이저의 시간 공유는 정밀도가 떨어질 수 있습니다. 게스트 OS 내부에서 `chronyd`를 실행하고 `makestep` 정책을 활성화하여 VM 일시 정지 또는 스냅샷 복원 후 빠르게 재동기화하도록 구성하는 것이 좋습니다.

### 컨테이너 (도커/쿠버네티스)

컨테이너는 호스트 커널의 시간을 공유합니다. 따라서 컨테이너 내부가 아닌 **호스트 시스템**에서 NTP 데몬을 실행하여 시간을 관리해야 합니다. 쿠버네티스 클러스터에서는 모든 노드의 시간 동기화가 etcd, 인증서 검증 등에 필수적입니다.

---

## 모니터링 및 운영 자동화

### 모니터링 지표

주요 모니터링 지표로는 `오프셋`, `지터`, `스트라텀`, `도달성(reach)` 등이 있습니다. 이러한 지표를 통해 시간 서비스의 건강 상태를 판단할 수 있습니다.

간단한 오프셋 경고 스크립트 예시:
```bash
#!/bin/bash
# 오프셋이 100ms를 초과하면 경고
THRESHOLD=0.100
OFFSET=$(chronyc tracking | awk '/Last offset/ {print $4}')
if (( $(echo "$OFFSET > $THRESHOLD" | bc -l) )); then
    echo "경고: 시간 오프셋이 ${OFFSET}s로 임계값(${THRESHOLD}s)을 초과했습니다."
    exit 1
fi
```

### Ansible을 이용한 자동화 배포

```yaml
# chrony_client.yml
- hosts: all
  become: yes
  tasks:
    - name: chrony 설치
      package:
        name: chrony
        state: present
    - name: chrony 구성 파일 배포
      copy:
        dest: /etc/chrony/chrony.conf
        content: |
          pool 0.kr.pool.ntp.org iburst
          pool 1.kr.pool.ntp.org iburst
          makestep 1.0 3
          rtcsync
          driftfile /var/lib/chrony/chrony.drift
    - name: chrony 서비스 시작 및 활성화
      systemd:
        name: chronyd
        enabled: yes
        state: started
```

---

## 선택 가이드 및 결론

| 기준 | **chronyd** | **ntpd** | **systemd-timesyncd** |
| :--- | :--- | :--- | :--- |
| **수렴 속도 & 동적 환경** | 우수 (네트워크 불안정, VM에 강점) | 보통 | 제한적 |
| **구성 및 관리 용이성** | 매우 우수 | 보통 | 매우 우수 (기본 내장) |
| **고급 기능 및 서버 용도** | 우수 (서버 모드, NTS 지원) | 우수 | 지원 안 함 |
| **권장 사용 사례** | **대부분의 서버, VM, 클라우드 인스턴스** | 레거시 시스템, 특정 고급 구성 | 단순 데스크톱, 임베디드 클라이언트 |

**정확한 시간 동기화는 현대 IT 인프라의 보이지 않는 핵심 기반**입니다. SSL/TLS 인증서 유효성 검사, 분산 데이터베이스의 일관성, 로그 분석의 정확성, 그리고 복잡한 마이크로서비스 간의 조정까지 모든 시스템 계층이 정확한 시간에 의존합니다.

따라서, 새로운 서버나 클라우드 인프라를 구축할 때는 `chronyd`를 기본 시간 동기화 수단으로 채택하는 것이 좋습니다. 내부망에서는 이중화된 NTP 서버를 구성하고, 모든 클라이언트가 여러 피어를 참조하도록 설정하여 안정성을 높이세요. 마지막으로, 시간 동기화도 중요한 인프라 구성 요소로 간주하여 방화벽 규칙, 보안 설정(NTS), 지속적인 모니터링, 그리고 Ansible과 같은 도구를 통한 자동화된 배포와 관리의 대상으로 삼아야 합니다.