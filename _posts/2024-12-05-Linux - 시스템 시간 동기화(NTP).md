---
layout: post
title: Linux - ì‹œìŠ¤í…œ ì‹œê°„ ë™ê¸°í™”(NTP)
date: 2024-12-05 19:20:23 +0900
category: Linux
---
# ë¦¬ëˆ…ìŠ¤ 34í¸: ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œ ì‹œê°„ ë™ê¸°í™” ìì„¸íˆ ì•Œì•„ë³´ê¸°

> ëª©í‘œ
> - **ì™œ ì‹œê°„ ë™ê¸°í™”ê°€ ì¤‘ìš”í•œê°€**ë¥¼ ë¶„ì‚°ì‹œìŠ¤í…œÂ·ë³´ì•ˆÂ·ë¡œê·¸ ê´€ì ì—ì„œ ì •ë¦¬
> - `ntpd`, `chronyd`, `systemd-timesyncd(timedatectl)`ì˜ **ì°¨ì´ì™€ ì„ íƒ ê¸°ì¤€**
> - **NTP ê°œë…(ìŠ¤íŠ¸ë¼í…€, ì§€ì—°Â·ì˜¤í”„ì…‹Â·ì§€í„°, Slew vs Step)** ì„ ìˆ˜ì‹ìœ¼ë¡œ ì´í•´
> - **ì •í™•í•œ ì„¤ì • ì˜ˆì‹œ**(ì„œë²„/í´ë¼ì´ì–¸íŠ¸, ê°€ìƒí™”/ì»¨í…Œì´ë„ˆ, ë°©í™”ë²½, ë³´ì•ˆ NTS, ë¡œì»¬ ë¦¬í¼ëŸ°ìŠ¤/ì˜¤í”ˆì†ŒìŠ¤ GPS/PPS)
> - **íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ì²´í¬ë¦¬ìŠ¤íŠ¸**ì™€ **ìš´ì˜ ìë™í™”(Ansible)**

---

## ğŸ“š 0. í•µì‹¬ ê°œë… ìš”ì•½

- **NTP(Network Time Protocol)**: ì¸í„°ë„·ì„ í†µí•œ ì‹œê³„ í•©ì˜ í”„ë¡œí† ì½œ. ìœ„/ì•„ë˜ ê³„ì¸µ(**Stratum**) êµ¬ì¡°.
- **ì˜¤í”„ì…‹(offset)**: ë‚´ ì‹œê³„ê°€ ì‹¤ì œ ì‹œê°„ì—ì„œ ì–¼ë§ˆë‚˜ ì–´ê¸‹ë‚¬ëŠ”ì§€(ì´ˆ).
- **ì§€ì—°(delay)**: ì™•ë³µ ë„¤íŠ¸ì›Œí¬ ì§€ì—°.
- **ì§€í„°(jitter)**: ì‹œê°„ ì¸¡ì •ì˜ ë³€ë™ì„±(í†µê³„ì  ë¶„ì‚°).
- **Slew vs Step**:
  - *Slew* â€” ì‹œê³„ë¥¼ **ì„œì„œíˆ** ì¡°ì •(ì†ë„ ë³´ì •): í”„ë¡œì„¸ìŠ¤ì— ì¶©ê²© ì ìŒ, í° ì˜¤ì°¨ì—” ëŠë¦¼.
  - *Step* â€” ì‹œê³„ë¥¼ **ì¦‰ì‹œ** ì í”„: í° ì˜¤ì°¨ ë¹ ë¥´ê²Œ í•´ê²°, ì¼ë¶€ ì• í”Œë¦¬ì¼€ì´ì…˜(íƒ€ì„ìŠ¤íƒ¬í”„ ì—„ê²©) ì£¼ì˜.
- **ë“œë¦¬í”„íŠ¸(drift)**: í•˜ë“œì›¨ì–´ ì˜¤ì‹¤ë ˆì´í„°(ì¿¼ì¸ )ì˜ ê¸¸ë“¤ì´ê¸°â€”ì¥ê¸° ì£¼íŒŒìˆ˜ ì˜¤ì°¨ ì¶”ì •/ë³´ì •(`driftfile`).
- **RTC(í•˜ë“œì›¨ì–´ ì‹œê³„)**: CMOS ë°°í„°ë¦¬ë¡œ ìœ ì§€, ë¶€íŒ… ì‹œ **ì‹œìŠ¤í…œ ì‹œê³„** ì´ˆê¸°í™”ì— ì‚¬ìš©.

NTPì˜ ëŒ€í‘œ ê³„ì‚°ì‹(ì™•ë³µ ì§€ì—° \( \delta \), ì˜¤í”„ì…‹ \( \theta \)):
$$
\delta = (t_4 - t_1) - (t_3 - t_2), \quad
\theta = \frac{(t_2 - t_1) + (t_3 - t_4)}{2}
$$
- \(t_1\): í´ë¼ì´ì–¸íŠ¸ ì „ì†¡, \(t_2\): ì„œë²„ ìˆ˜ì‹ , \(t_3\): ì„œë²„ ì „ì†¡, \(t_4\): í´ë¼ì´ì–¸íŠ¸ ìˆ˜ì‹ .

---

## `ntpd` â€” ì „í†µ NTP ë°ëª¬ (ì„œë²„ í™˜ê²½ì— ì—¬ì „íˆ ë„ë¦¬ ì‚¬ìš©)

### ì„¤ì¹˜

```bash
# Debian/Ubuntu

sudo apt update
sudo apt install -y ntp

# RHEL/CentOS 7 ê³„ì—´(legacy)

sudo yum install -y ntp
```

### í•„ìˆ˜ ëª…ë ¹

| ëª…ë ¹ | ì„¤ëª… |
|---|---|
| `ntpq -p` | í”¼ì–´ ëª©ë¡ / ì§€ì—°Â·ì˜¤í”„ì…‹Â·ì§€í„° í™•ì¸ |
| `ntpstat` | ë‹¨ìˆœ ë™ê¸°í™” ìƒíƒœ |
| `sudo ntpd -q` | 1íšŒ ë™ê¸°í™” í›„ ì¢…ë£Œ(í° ì˜¤ì°¨ ì´ˆê¸° ì •ë ¬) |
| `sudo service ntp restart` | ì„œë¹„ìŠ¤ ì¬ì‹œì‘ |

`ntpq -p` ì—´ í•´ì„(ìš”ì§€):
- `remote`: ì„œë²„ ì£¼ì†Œ(ë§¨ ì• ê¸°í˜¸ `*` í˜„ì¬ ì„ íƒ, `+` í›„ë³´, `-` ì œì™¸, `x` ê³ ì¡ìŒ ë“±)
- `refid`: ì„œë²„ì˜ ìƒìœ„ ì°¸ì¡°
- `st`: stratum
- `t`: u(unicast), l(local), p(PPS), etc.
- `when`/`poll`: ë§ˆì§€ë§‰ êµì‹ /í´ ì£¼ê¸°
- `reach`: 8ì§„ìˆ˜ ë„ë‹¬ì„± ë¹„íŠ¸í•„ë“œ(377ê°€ ë§Œì )
- `delay`/`offset`/`jitter`: ì§€ì—°/ì˜¤í”„ì…‹/ì§€í„°

### `/etc/ntp.conf` ì˜ˆì‹œ(ì•ˆì •Â·ë³´ì•ˆ ìœ„ì£¼)

```conf
# ê³µìš© í’€(NTP Pool Projectâ€”ì§€ì—­ ê°€ê¹Œìš´ í’€ ì¶”ì²œ)

pool 0.kr.pool.ntp.org iburst
pool 1.kr.pool.ntp.org iburst
pool 2.kr.pool.ntp.org iburst
pool 3.kr.pool.ntp.org iburst

# ë¹ ë¥¸ ì´ˆê¸° ë™ê¸°í™”

tos minclock 3 minsane 2
driftfile /var/lib/ntp/ntp.drift

# ì ‘ê·¼ì œì–´(ì„œë²„ë¡œ ìš´ì˜ ì‹œ)

restrict default kod nomodify notrap nopeer noquery
restrict 127.0.0.1
restrict ::1

# ë‚´ë¶€ë§ì—ì„œ ì§ˆì˜ í—ˆìš©(í•„ìš” ì‹œ)
# restrict 192.168.0.0 mask 255.255.0.0 nomodify notrap

```
- `iburst`: ì‹œì‘ ì‹œ 1íšŒê°€ ì•„ë‹Œ 8íšŒ ë¹ ë¥¸ íŒ¨í‚·ìœ¼ë¡œ **ì´ˆê¸° ìˆ˜ë ´ ê°€ì†**
- `restrict`: **ì§ˆì˜/ë³€ì¡° ì œí•œ**(DDoS/amplification ì™„í™”)
- `driftfile`: ì£¼íŒŒìˆ˜ ë“œë¦¬í”„íŠ¸ ì €ì¥

### í° ì˜¤ì°¨ ì´ˆê¸°í™”

```bash
sudo service ntp stop
sudo ntpd -gq   # step í—ˆìš©(-g), í•œ ë²ˆ ë™ê¸°í™” í›„ ì¢…ë£Œ(-q)
sudo service ntp start
```

---

## `chronyd` â€” ë¹ ë¥´ê³  VM ì¹œí™”ì ì¸ í˜„ëŒ€ NTP(ê°•ë ¥ ì¶”ì²œ)

**ì¥ì **:
- ë„¤íŠ¸ì›Œí¬ í’ˆì§ˆì´ ë‚˜ì˜ê±°ë‚˜ ê°„í—ì ì´ì–´ë„ **ë¹ ë¥¸ ìˆ˜ë ´**
- **ê°€ìƒë¨¸ì‹ /ë…¸íŠ¸ë¶** í™˜ê²½ì—ì„œ íƒì›”
- ì†Œìœ„ â€œslew-only ëª¨ë“œì—ì„œ í° ì˜¤ì°¨ë„ ì‹ ì†íˆ ì •ë ¬â€ ê°€ëŠ¥(`makestep` ì •ì±…)

### ì„¤ì¹˜ & ê¸°ë™

```bash
# Debian/Ubuntu

sudo apt update
sudo apt install -y chrony

# RHEL/CentOS/Rocky/Alma/Fedora

sudo dnf install -y chrony

sudo systemctl enable --now chronyd
```

### CLI(`chronyc`)

| ëª…ë ¹ | ì„¤ëª… |
|---|---|
| `chronyc tracking` | ì˜¤í”„ì…‹, ì£¼íŒŒìˆ˜ ë³´ì •(ppm), ì§€ì—°, ë¦¬í¼ëŸ°ìŠ¤ ë“± í•µì‹¬ ìš”ì•½ |
| `chronyc sources -v` | í”¼ì–´ë³„ ìƒíƒœ(+/*/# ë“±), ì˜¤í”„ì…‹/ì§€ì—°/ì§€í„° |
| `chronyc sourcestats -v` | í†µê³„(í‘œì¤€í¸ì°¨/ì˜¤í”„ì…‹ í‰ê· ) |
| `chronyc makestep` | í° ì˜¤ì°¨ **ì¦‰ì‹œ ë³´ì •** |

### `/etc/chrony/chrony.conf` í…œí”Œë¦¿

```conf
# ì‹ ë¢° ê°€ëŠ¥í•œ ì™¸ë¶€ NTP

pool 0.kr.pool.ntp.org iburst maxsources 4
pool 1.kr.pool.ntp.org iburst maxsources 4

# ì´ˆê¸° í° ì˜¤ì°¨ëŠ” step í—ˆìš© (ë¶€íŒ… ì´ˆê¸°ì—ë§Œ)

makestep 1.0 3
# â†’ ì˜¤ì°¨ê°€ 1ì´ˆ ì´ˆê³¼ì¼ ë•Œ, ì²˜ìŒ 3ë²ˆ ì—…ë°ì´íŠ¸ ë™ì•ˆì€ step ìˆ˜í–‰(ê·¸ í›„ëŠ” slew)

# ì˜¤í”„ë¼ì¸/ê°„í—ì  ë„¤íŠ¸ì›Œí¬ ìµœì í™” (ë…¸íŠ¸ë¶/VM)

rtcsync                    # RTC ë“œë¦¬í”„íŠ¸ ì¶”ì •/ì ìš©
driftfile /var/lib/chrony/chrony.drift

# ì„œë²„ë¡œ ìš´ì˜ ì‹œ, ë‚´ë¶€ë§ í—ˆìš©
# allow 192.168.0.0/16

# ë¡œê·¸

logdir /var/log/chrony
log measurements statistics tracking

# ë³´ì•ˆ(ê¸°ë³¸ì ìœ¼ë¡œ chronyëŠ” ì•ˆì „í•œ í¸)
# cmdallow 127.0.0.1

```

### ìš´ì˜ ì˜ˆ

```bash
chronyc tracking
chronyc sources -v
sudo chronyc makestep   # ë°°í¬ ì§í›„ í° ì˜¤ì°¨ ì¦‰ì‹œ ë³´ì •
```

---

## `systemd-timesyncd` + `timedatectl` â€” ê°€ë²¼ìš´ NTP í´ë¼ì´ì–¸íŠ¸

**ì¥ì **: ë‚´ì¥, ì„¤ì • ê°„ë‹¨. **ë‹¨ì¼ í´ë¼ì´ì–¸íŠ¸** ìš©ë„ì— ì í•©.
**ì œí•œ**: ê³ ê¸‰ í”¼ì–´ ì„ íƒÂ·ì„œë²„ ëª¨ë“œÂ·ì •êµí•œ í†µê³„/ì œì–´ëŠ” ë¶€ì¡±.

### ìƒíƒœ í™•ì¸

```bash
timedatectl status
timedatectl show-timesync
```

### ì„¤ì •/ì‚¬ìš©

```bash
sudo timedatectl set-ntp true
sudo timedatectl set-timezone Asia/Seoul
```
- `/etc/systemd/timesyncd.conf` ë¡œ ìƒìœ„ NTP ì§€ì • ê°€ëŠ¥:
```ini
[Time]
NTP=time.bora.net 1.kr.pool.ntp.org
FallbackNTP=2.kr.pool.ntp.org 3.kr.pool.ntp.org
```
```bash
sudo systemctl restart systemd-timesyncd
```

---

## ê³ ê¸‰ NTP ì´ë¡ (ì˜¤í”„ì…‹Â·ì§€ì—°Â·ì§€í„°Â·í´ë§), Slew vs Step

### ì˜¤í”„ì…‹Â·ì§€ì—° ê³„ì‚°(ë³µìŠµ)

$$
\delta = (t_4 - t_1) - (t_3 - t_2), \qquad
\theta = \frac{(t_2 - t_1) + (t_3 - t_4)}{2}
$$

- \( \delta \)ê°€ ì‘ì„ìˆ˜ë¡ ëŒ€ì¹­ ë„¤íŠ¸ì›Œí¬ â†’ **ì •í™•í•œ ì˜¤í”„ì…‹ ì¶”ì •**
- í•œ í”¼ì–´ë§Œ ë§¹ì‹ í•˜ì§€ ì•Šê³ , ì—¬ëŸ¬ í”¼ì–´ì˜ outlier ì œê±°/ê°€ì¤‘ í‰ê· (í´ëŸ­ í•„í„°/ì„ í˜• íšŒê·€ ë“±)ì„ ìˆ˜í–‰

### í´ë§ ì£¼ê¸°

- `minpoll`, `maxpoll`(2ì˜ ì§€ìˆ˜, ì´ˆ ë‹¨ìœ„): ë„¤íŠ¸ì›Œí¬Â·ì„œë²„ ìƒíƒœì— ë”°ë¼ ì ì‘
- ë„ˆë¬´ ì¦ìœ¼ë©´ ë¶€í•˜, ë„ˆë¬´ ë“œë¬¼ë©´ ìˆ˜ë ´ ëŠë¦¼ â†’ **ê¸°ë³¸ ìë™**ì„ ê¶Œì¥

### Slew vs Step

- Slew: ì´ˆë‹¹ ìµœëŒ€ 500ppm ì •ë„ë¡œ **ì†ë„ ë³´ì •**(chronyëŠ” ë” ìœ ì—°)
- ìš´ìš© ì§€ì¹¨: **ì´ˆê¸°ì—ëŠ” Step í—ˆìš©**(ë¶€íŒ… ì§í›„ `makestep`), ì´í›„ì—ëŠ” Slewë¡œ ì•ˆì • ìœ ì§€

---

## ë³´ì•ˆ: ë°©í™”ë²½/ACL, NTS(ì•”í˜¸í™”), DoS ì™„í™”

### ë°©í™”ë²½

- **í´ë¼ì´ì–¸íŠ¸**: UDP/123 **outbound** í—ˆìš©
- **ì„œë²„**: UDP/123 **inbound** í—ˆìš© + `restrict`/`allow`ë¡œ ì ‘ê·¼ ì œì–´
  - `ntpd`: `restrict`
  - `chronyd`: `allow`(ì„œë²„ ëª¨ë“œ ì‹œ)

### ì¦í­/ë°˜ì‚¬ ê³µê²© ì™„í™”

- ì¿¼ë¦¬ ì œí•œ(`noquery`), KoD, rate limit ì ìš©(ê¸°ë³¸ê°’ ìœ ì§€ ê¶Œì¥)
- ê³µìš©ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì‹œ **NTP Pool ì§€ì¹¨** ì¤€ìˆ˜

### NTS(Network Time Security, TLS ê¸°ë°˜ ì¸ì¦)

- `chrony 4.x` ì´ìƒì€ **NTS ì§€ì›**. ì˜ˆì‹œ(í´ë¼ì´ì–¸íŠ¸):
```conf
# chrony.conf

server nts.netnod.se nts iburst
server time.cloudflare.com nts iburst
```
- ì¥ì : **ì¤‘ê°„ì ê³µê²© ë°©ì§€**, ì„œë²„ ìŠ¤í‘¸í•‘ ì–µì œ
- ë‹¨ì : TLS í•¸ë“œì…°ì´í¬ ë¹„ìš©(ì´ˆê¸°), ì„œë²„/í´ë¼ ì–‘ì¸¡ ì§€ì› í•„ìš”

---

## ê°€ìƒí™”Â·ì»¨í…Œì´ë„ˆÂ·í´ëŸ¬ìŠ¤í„°ì—ì„œì˜ ì‹œê°„

### VM(í•˜ì´í¼ë°”ì´ì €/ê²ŒìŠ¤íŠ¸)

- ê²ŒìŠ¤íŠ¸ í´ëŸ­ ì†ŒìŠ¤: `tsc`, `kvm-clock`, `hyperv_clocksource`, `xen` ë“±
- **ê¶Œì¥**: ê²ŒìŠ¤íŠ¸ ë‚´ë¶€ `chronyd` ì‹¤í–‰ + í•˜ì´í¼ë°”ì´ì € ì¸¡ **NTP ì •í™•ë„** ë³´ì¥
- **ìŠ¤ëƒ…ìƒ·/ë™ê²°/ë¼ì´ë¸Œë§ˆì´ê·¸ë ˆì´ì…˜** í›„ í° ì˜¤ì°¨ ë°œìƒ ê°€ëŠ¥ â†’ `makestep` ì •ì±…ìœ¼ë¡œ ë¹ ë¥¸ ì¬ìˆ˜ë ´

### ì»¨í…Œì´ë„ˆ(Docker/Kubernetes)

- ì»¨í…Œì´ë„ˆëŠ” í˜¸ìŠ¤íŠ¸ ì»¤ë„ ì‹œê°„ì„ **ê³µìœ ** â†’ í˜¸ìŠ¤íŠ¸ì—ì„œ `chronyd` ë˜ëŠ” `systemd-timesyncd` ê´€ë¦¬
- NTP ë°ëª¬ì„ ì»¨í…Œì´ë„ˆë§ˆë‹¤ ë„ìš°ì§€ ë§ ê²ƒ(íŠ¹ìˆ˜ ëª©ì  ì œì™¸)
- K8s: **ëª¨ë“  ë…¸ë“œì˜ ì‹œê³„ ë™ê¸°í™”**ëŠ” etcd/RAFT, JWT, TLS ê²€ì¦ì— **ì¹˜ëª…ì **(ë…¸ë“œ ì‹œê°„ ë¶ˆì¼ì¹˜ â†’ ì¸ì¦ ì‹¤íŒ¨/ë¦¬ë” ì„ ì¶œ ì§€ì—°)

### ë¶„ì‚° ì‹œìŠ¤í…œ

- DB(ë¶„ì‚° íŠ¸ëœì­ì…˜), ë©”ì‹œì§€ í, ë¡œê·¸ ì§‘ê³„(ELK, Loki) ë“±ì€ **ì˜¤í”„ì…‹ ìˆ˜ë°± msë§Œ ë„˜ì–´ë„** ì¥ì• ì„± ì¦ìƒ
- ìš´ì˜ ê·œì¹™: **ë™ì¼ ì„œë¸Œë„·/ì§€ì—­**ì˜ NTP **ë‹¤ì¤‘ í”¼ì–´**ì— ë™ê¸°í™” + ëª¨ë‹ˆí„°ë§

---

## ë‚´ë¶€ NTP ì„œë²„(chrony) êµ¬ì„± ì˜ˆì‹œ

### ì¤‘ì•™ NTP ì„œë²„

```conf
# /etc/chrony/chrony.conf (ì„œë²„ì¸¡)

pool 0.pool.ntp.org iburst maxsources 4
pool 1.pool.ntp.org iburst maxsources 4

# ë‚´ë¶€ë§ í—ˆìš©

allow 10.0.0.0/8
allow 192.168.0.0/16

# ë¡œì»¬ ê¸°ì¤€(ì™¸ë¶€ ëŠê²¨ë„ ë‚´ë¶€ ì œê³µ) â€” stratum 10 ì •ë„ë¡œ ë‚®ê²Œ

local stratum 10

# ë¡œê¹…

logdir /var/log/chrony
```
```bash
sudo systemctl enable --now chronyd
chronyc sources -v
```

### í´ë¼ì´ì–¸íŠ¸(ì‚¬ë‚´ ì„œë²„ë“¤)

```conf
# /etc/chrony/chrony.conf (í´ë¼)

server ntp-core-1.iburst
server ntp-core-2.iburst
makestep 1.0 3
driftfile /var/lib/chrony/chrony.drift
```

---

## Refclock: GPS/PPSë¡œ Stratum-1 ë§Œë“¤ê¸°(ì„ íƒ)

- **GPS ìˆ˜ì‹ ê¸° + PPS(ì´ˆë‹¹ í„ìŠ¤)** ì…ë ¥ìœ¼ë¡œ **ë§ˆì´í¬ë¡œì´ˆ ë‹¨ìœ„** ì •ë°€ë„
- `gpsd` + `chrony` ì„¤ì • ì˜ˆ(ìš”ì•½):
```conf
# /etc/chrony/chrony.conf

refclock SHM 0 poll 4 refid GPS     # gpsd SHM(ê³µìœ ë©”ëª¨ë¦¬) ì±„ë„ 0
refclock PPS /dev/pps0 poll 4 prefer lock GPS refid PPS
```
- í•˜ë“œì›¨ì–´Â·ì»¤ë„ PPS ì„¤ì • í•„ìš”(ì „ìš© ê°€ì´ë“œ ì°¸ê³ )

---

## RTC(í•˜ë“œì›¨ì–´ ì‹œê³„)ì™€ tzdataÂ·DST

### RTC â†” ì‹œìŠ¤í…œ ì‹œê³„

```bash
# RTC ì½ê¸°

sudo hwclock --show

# ì‹œìŠ¤í…œ ì‹œê°„ì„ RTCì— ì €ì¥

sudo hwclock --systohc

# RTCë¥¼ ì‹œìŠ¤í…œ ì‹œê°„ìœ¼ë¡œ

sudo hwclock --hctosys
```
- `timedatectl status`ì—ì„œ `RTC in local TZ:`ëŠ” **ëŒ€ë¶€ë¶„ no(UTC)** ê¶Œì¥(ì´ì¤‘ ë³€í™˜ ë¬¸ì œ íšŒí”¼)

### íƒ€ì„ì¡´/ì„œë¨¸íƒ€ì„(tzdata)

```bash
timedatectl list-timezones | grep Asia
sudo timedatectl set-timezone Asia/Seoul
```
- OSì˜ `tzdata` ì—…ë°ì´íŠ¸(ì •ì±… ë³€ê²½ ì‹œ) í•„ìˆ˜
- ì• í”Œë¦¬ì¼€ì´ì…˜ì€ í•­ìƒ **UTC ì €ì¥ + í‘œì‹œ ì‹œ ë³€í™˜** ê¶Œì¥

---

## ëª¨ë‹ˆí„°ë§Â·ì•Œë¦¼

- **ì§€í‘œ**: offset, jitter, last sample, stratum, reach, frequency(ppm)
- ì˜ˆì‹œ: ê°„ë‹¨ í—¬ìŠ¤ì²´í¬(ì˜¤í”„ì…‹ ì ˆëŒ€ê°’ ì„ê³„)
```bash
#!/usr/bin/env bash
# chrony ì˜¤í”„ì…‹(ì´ˆ) ì ê²€(ëŒ€ì¶© íŒŒì‹±)

off=$(chronyc tracking | awk -F: '/Last offset/ {gsub(/s/,"",$2); print $2+0}')
thr=0.050   # 50ms
awk -v o="$off" -v t="$thr" 'BEGIN{ exit ( (o<0?-o:o) > t ) }'
```
- í”„ë¡œë©”í…Œìš°ìŠ¤/ë…¸ë“œ ìµìŠ¤í¬í„°ë¥¼ ì“°ëŠ” ê²½ìš°ì—” **chrony í…ìŠ¤íŠ¸ ìµìŠ¤í¬íŠ¸** ìŠ¤í¬ë¦½íŠ¸ë¡œ ì§€í‘œ ë…¸ì¶œ ê°€ëŠ¥(ìš´ì˜ í‘œì¤€ì— ë§ì¶° êµ¬í˜„)

---

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ì²´í¬ë¦¬ìŠ¤íŠ¸

1) **ë™ê¸°í™” ì‹¤íŒ¨/ëŠë¦¼**
   - ë°©í™”ë²½(UDP/123), í”„ë¡ì‹œ ìš°íšŒ?
   - `chronyc sources`, `reach` í•„ë“œ(0ì´ ì—°ì†ì´ë©´ íŒ¨í‚· ë¯¸ë„ë‹¬)
   - í”¼ì–´ ìˆ˜ ë¶€ì¡±/í’ˆì§ˆ ë‚˜ì¨ â†’ `pool` 2~4ê°œ ì¶”ê°€

2) **ì‹œê°„ì´ ì í”„(step)ë˜ì–´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì˜¤ë¥˜**
   - ë¶€íŒ… ì§í›„ë§Œ `makestep`, í‰ìƒì‹œëŠ” **slew-only**
   - JVMÂ·DBÂ·ë¶„ì‚°ì‹œìŠ¤í…œì´ stepì— ë¯¼ê° â†’ ì •ì±… ì¡°ì ˆ

3) **VMì—ì„œ ì§€ì† ì˜¤í”„ì…‹**
   - í•˜ì´í¼ë°”ì´ì € ì¸¡ ì‹œê°„ ì •í™•?
   - ê²ŒìŠ¤íŠ¸ clocksource í™•ì¸:
     ```bash
     cat /sys/devices/system/clocksource/clocksource0/current_clocksource
     ```
   - ìŠ¤ëƒ…ìƒ· ë³µì› í›„ `chronyc makestep`

4) **ë¡œê·¸ íƒ€ì„ìŠ¤íƒ¬í”„ ë¶ˆì¼ì¹˜**
   - TZ/Locale í˜¼ì¬? ì»¨í…Œì´ë„ˆ/í˜¸ìŠ¤íŠ¸ TZ ë™ê¸°í™”?
   - `journalctl --since/--until`ë¡œ ì ˆëŒ€ì‹œê°„ í™•ì¸

5) **ntpd/chronyd ë™ì‹œ êµ¬ë™**
   - í•œ ì‹œìŠ¤í…œì—” **í•˜ë‚˜ë§Œ**(ì¤‘ë³µ ê¸ˆì§€). `systemctl status`ë¡œ ì¶©ëŒ í™•ì¸

---

## ìš´ì˜ ìë™í™”(Ansible ì˜ˆì‹œ)

### chrony í´ë¼ì´ì–¸íŠ¸ ë°°í¬

```yaml
# chrony-client.yml

- hosts: linux_nodes
  become: yes
  tasks:
    - name: Install chrony
      package:
        name: chrony
        state: present

    - name: Deploy chrony.conf
      copy:
        dest: /etc/chrony/chrony.conf
        content: |
          pool 0.kr.pool.ntp.org iburst maxsources 4
          pool 1.kr.pool.ntp.org iburst maxsources 4
          makestep 1.0 3
          driftfile /var/lib/chrony/chrony.drift
          logdir /var/log/chrony

    - name: Enable & start chronyd
      systemd:
        name: chronyd
        enabled: yes
        state: started
```
```bash
ansible-playbook -i inventory chrony-client.yml
```

---

## ì‹¤ì „ ì˜ˆì‹œ ëª¨ìŒ

### ë¹ ë¥¸ ì´ˆê¸°í™”(chrony)

```bash
sudo systemctl stop chronyd
sudo chronyd -q 'server 0.kr.pool.ntp.org iburst'
sudo systemctl start chronyd
```

### ì„œë²„/í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ ì½ì–´ë‚´ê¸°

```bash
chronyc tracking
# Reference ID / Stratum / Last offset / RMS offset / Frequency(ppm) / Residual freq ë“±

chronyc sources -v
# ^* ì„ íƒëœ ì„œë²„, ^+ í›„ë³´, ^- ì œì™¸, ^? ë¯¸ë„ë‹¬ ë“± ìƒíƒœê¸°í˜¸

```

### timedatectlë¡œ ë¹ ë¥¸ ì ê²€/ìˆ˜ì •

```bash
timedatectl status
sudo timedatectl set-ntp true
sudo timedatectl set-timezone Asia/Seoul
```

### ntpd êµ¬ì„±ê³¼ ì ê²€

```bash
sudoedit /etc/ntp.conf
ntpq -p
ntpstat
```

---

## ì„ íƒ ê°€ì´ë“œ(ìš”ì•½ í‘œ)

| í•­ëª© | **chronyd** | **ntpd** | **systemd-timesyncd** |
|---|---|---|---|
| ìˆ˜ë ´ ì†ë„/VM ì í•© | â­â­â­â­ | â­â­â­ | â­â­ |
| ìš´ì˜ í¸ì˜(í˜„ëŒ€ ì˜µì…˜) | â­â­â­â­ | â­â­â­ | â­â­â­â­(ê°„ë‹¨) |
| ì„œë²„ ëª¨ë“œ(ì‚¬ë‚´ NTP) | â­â­â­â­ | â­â­â­ | âŒ |
| NTS(ë³´ì•ˆ) | â­â­â­â­(ì§€ì›) | ì¼ë¶€(íŒŒìƒ/ë²„ì „ ì˜ì¡´) | âŒ |
| í†µê³„/ì œì–´/ì •êµí•¨ | â­â­â­â­ | â­â­â­ | â­ |
| ê¶Œì¥ ê¸°ë³¸ê°’ | **ê¶Œì¥** | ëŒ€ì•ˆ | ë‹¨ì¼ í´ë¼/ê²½ëŸ‰ |

---

## ì‹¤ìŠµ ìŠ¤í¬ë¦½íŠ¸(í…ŒìŠ¤íŠ¸/ë°ëª¨)

### â€œì§€ê¸ˆ ë°”ë¡œ ë³´ì •â€ í…ŒìŠ¤íŠ¸(chrony)

```bash
#!/usr/bin/env bash

set -euo pipefail
echo "[Before] $(date -u) (UTC) | $(date) (local)"
sudo chronyc makestep
sleep 1
echo "[After ] $(date -u) (UTC) | $(date) (local)"
```

### ì˜¤í”„ì…‹ ì„ê³„ ê²½ë³´(ê°„ë‹¨)

```bash
#!/usr/bin/env bash

off=$(chronyc tracking | awk -F: '/Last offset/ {gsub(/s/,"",$2); print $2+0}')
abs_off=$(awk -v o="$off" 'BEGIN{print (o<0?-o:o)}')
echo "offset=${abs_off}s"
(( $(echo "$abs_off > 0.100" | bc -l) )) && {
  echo "WARN: offset > 100ms"
  exit 1
}
```

---

## âœ… ë§ˆë¬´ë¦¬

- **ì •í™•í•œ ì‹œê°„ì€ ì‹œìŠ¤í…œì˜ â€œìˆ¨ì€ ì¸í”„ë¼â€**: ì¸ì¦(SSL/TLS), ë¡œê·¸ ìƒê´€ ë¶„ì„, ë¶„ì‚° í•©ì˜, ìŠ¤ì¼€ì¤„ëŸ¬, ìºì‹œ ë§Œë£Œ ë“± **ëª¨ë“  ì¸µ**ì— ê´€ì—¬í•œë‹¤.
- ë²”ìš© ì„œë²„/VM/K8s ë…¸ë“œì—ëŠ” **`chronyd` + `makestep`(ë¶€íŒ… ì´ˆê¸°)** ë¥¼ ê¶Œì¥.
- ë‹¨ìˆœ ë°ìŠ¤í¬í†±ì€ `systemd-timesyncd`ë¡œ ì¶©ë¶„. ë ˆê±°ì‹œ/íŠ¹ìˆ˜ í™˜ê²½ì€ `ntpd` ê³ ë ¤.
- ë‚´ë¶€ë§ NTP ì„œë²„ë¥¼ **2ëŒ€ ì´ìƒ**(ì´ì¤‘í™”) ë‘ê³ , í´ë¼ì´ì–¸íŠ¸ëŠ” **ì—¬ëŸ¬ í”¼ì–´**ë¥¼ ë³´ë„ë¡ í•˜ë¼.
- ë³´ì•ˆ(ACLÂ·ë°©í™”ë²½Â·NTS), ëª¨ë‹ˆí„°ë§(ì˜¤í”„ì…‹/ì§€í„°/ë„ë‹¬ì„±), ìë™í™”(Ansible/CI)ê¹Œì§€ ê°–ì¶”ë©´ **ì•ˆì •ì ìœ¼ë¡œ â€œì •í™•í•œ ì‹œê°„â€ì„ ê³µê¸‰**í•  ìˆ˜ ìˆë‹¤.

---

## ë¶€ë¡ A. ë¹ ë¥¸ ë ˆí¼ëŸ°ìŠ¤

**chrony**
```bash
sudo apt install chrony
sudo systemctl enable --now chronyd
chronyc tracking
chronyc sources -v
sudo chronyc makestep
```

**ntpd**
```bash
sudo apt install ntp
ntpq -p
sudo ntpd -gq
```

**systemd-timesyncd**
```bash
timedatectl status
sudo timedatectl set-ntp true
sudo timedatectl set-timezone Asia/Seoul
```

**RTC**
```bash
sudo hwclock --systohc
sudo hwclock --hctosys
```
