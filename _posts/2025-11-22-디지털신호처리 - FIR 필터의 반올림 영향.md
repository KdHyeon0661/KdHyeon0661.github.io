---
layout: post
title: 디지털신호처리 - FIR 필터의 반올림 영향
date: 2025-11-22 14:25:23 +0900
category: 디지털신호처리
---
# FIR 필터의 반올림(라운딩) 영향 — 내부 연산 잡음 모델, 구조별 차이, 고정소수점 설계, GNU Octave 실험과 실무 체크리스트

FIR(Finite Impulse Response) 디지털 필터는 피드백이 없고 임펄스 응답 길이가 유한하기 때문에 **유한 정밀도(반올림/절단/오버플로우)에 상대적으로 강한 구조**로 여겨진다.
하지만 “강하다”는 말은 “문제가 없다”는 뜻이 아니다. FIR에서도 반올림은

- 출력 잡음 플로어 상승
- 통과대역/저지대역 리플 변화
- 주파수 응답의 미세 변형(특히 대칭 구조에서)
- 누산기 포화/오버플로우
- 구조/스케일링에 따른 잡음 이득 변화

같은 현실적인 성능 저하를 만든다.

---

## 0) FIR에서 유한 정밀도가 들어오는 위치

FIR의 이상적 차분방정식은

$$
y[n] = \sum_{k=0}^{M} b_k x[n-k]
$$

이다. 실제 고정소수점/부동소수점 구현에서는 이 식을 계산하는 매 단계에서 **반올림/절단**이 발생한다.

FIR에서 유한 정밀도 오차는 크게 두 층으로 나뉜다.

1. **입력(A/D) 양자화 잡음**
   - 아날로그 입력을 디지털로 만들 때 생기는 잡음.
   - 이는 FIR을 “통과한 뒤” 출력으로 나간다.
2. **필터 내부 연산 반올림 잡음**
   - 각 탭 곱셈 \(b_k x[n-k]\)의 결과
   - 탭들의 누산(accumulation)
   - 구조적 재배열(전치/폴리페이즈/대칭 합산)에서 발생하는 덧셈
   - 이들이 모두 **잡음 소스**가 된다.

FIR 분석의 핵심은
**“내부 반올림 잡음이 출력에 어떻게 합쳐지는가”** 를 정량화하는 것이다.

---

## 1) FIR 반올림 잡음의 기본 확률 모델

### Q-format과 LSB(단위 양자화 스텝)

고정소수점에서 소수부 비트 수가 \(F\)라면 LSB 크기는

$$
u = 2^{-F}.
$$

최근접 반올림(round-to-nearest)을 가정하면, 한 번의 반올림 오차 \(\epsilon\)는

$$
\epsilon \sim \mathcal{U}\!\left(-\frac{u}{2},\,\frac{u}{2}\right)
$$

$$
\mathbb{E}[\epsilon]=0,\qquad \sigma_\epsilon^2=\frac{u^2}{12}
$$

로 모델링한다.

### truncation(절단) vs rounding(최근접 반올림)

- **truncation**: 항상 아래쪽으로 잘라서 평균 오차가 0이 아니다.
  작은 오차가 **누적 바이어스**를 만들 수 있다.
- **rounding**: 평균 오차가 0에 가깝고, 잡음처럼 동작한다.

따라서 FIR 구현의 기본 정책은 **rounding 우선**이다.

---

## 2) FIR에서 반올림이 IIR보다 덜 위험한 이유

### 피드백 부재 → 잡음 재순환 없음

FIR은 피드백이 없다. 즉,

- 내부 반올림 잡음이 출력으로 나가면 끝
- 다음 샘플 계산에 다시 들어와 증폭되지 않는다

따라서 FIR에는 IIR에서 보았던

- limit cycle(무입력 진동)
- 라운딩 오차의 재귀 증폭
- 극점 이동에 따른 불안정

같은 구조적 위험이 없다.

### FIR의 잡음 이득(Noise gain)은 유한

내부 잡음을 “입력에 더해진 백색잡음”으로 보면, 출력 잡음 파워는

$$
\sigma_{y,\epsilon}^2
=
\sigma_\epsilon^2
\sum_{k=0}^{M} b_k^2
$$

가 된다.

여기서

$$
G_H = \sum_{k=0}^{M} b_k^2
$$

를 FIR의 **잡음 이득(noise gain)** 이라고 부른다.

- FIR은 \(M\)이 유한하므로 \(G_H\)도 유한
- 필터가 얼마나 “에너지 큰 계수”를 갖느냐에 따라 출력 반올림 잡음이 결정된다

이 관계는 FIR 유한 정밀도 분석의 가장 중요한 결론 중 하나다.

---

## 3) FIR 구조별 반올림 잡음 경로

FIR은 같은 계수라도 구조에 따라

- 반올림이 생기는 위치/횟수
- 누산 깊이
- 내부 상태의 크기

가 달라지므로 반올림 영향이 달라진다.

### Direct Form(Transversal) FIR

기본 탭 지연선 구조:

```text
x[n] ─▶ z^-1 ─▶ z^-1 ─▶ ... ─▶ z^-1
  │       │             │
 ×b0     ×b1           ×bM
  │       │             │
  └───(+)─┴──(+)─...─(+)┘ → y[n]
```

반올림 잡음은 주로

1. 각 곱셈기 출력에서 발생
2. 누산기에서 덧셈할 때 발생

한다.

- **곱셈기 수**가 많을수록 잡음 소스가 늘고
- **누산 길이(M)**가 길수록 누산기 반올림이 증가한다.

### Transposed FIR

전치 구조는 한 샘플에 대해 “곱 → 부분합 누산”을 연쇄적으로 수행한다.

특징:

- 하드웨어 파이프라인이 쉽고
- 내부 덧셈 깊이가 낮아질 수 있으며
- 특정 고정소수점 환경에서 오버플로우 제어가 쉬워진다.

하지만 반올림 잡음 관점에서 본질은 같다.

- 소스 위치가 달라질 뿐
- 출력 잡음은 결국 \(G_H\)에 의해 결정된다

다만, **덧셈 순서에 따라 중간 반올림 분산이 약간 달라질 수 있다.**

### 선형 위상(대칭) FIR의 “곱셈기 절반 구조”

대칭 계수:

$$
b_k = b_{M-k}
$$

이면

$$
y[n]
=
\sum_{k=0}^{M/2} b_k\left(x[n-k] + x[n-(M-k)]\right)
$$

로 바꿀 수 있고, 곱셈기가 절반으로 줄어든다.

반올림 영향 측면에서는

- 곱셈기 수 감소 → 곱셈 라운딩 잡음 감소
- 대신 “짝 더하기” 단계에서 덧셈 라운딩 잡음이 들어온다

보통은 **전체 잡음이 감소하는 쪽**이 더 흔하다.
특히 M이 큰 오디오/통신 FIR에서 이 구조 최적화는 매우 중요하다.

### Polyphase FIR(샘플링률 변환/멀티레이트)

Polyphase는 FIR의 계수를 분해하여 여러 개의 작은 FIR로 재배열한다.

- 각 branch의 길이가 줄어듦 → 누산 깊이 감소
- 각 branch를 낮은 속도로 돌리면 하드웨어 자원 절약
- 반올림 잡음 분산도 branch별로 분산되어 나타난다

즉, Polyphase는 연산량뿐 아니라 **유한 정밀도에도 유리한 구조적 효과**를 가진다.

---

## 4) 고정소수점 FIR에서의 동적 범위와 스케일링

FIR은 피드백이 없으므로 내부 상태 폭주는 없지만,
**누산기 한 번에 \(M+1\)개의 항이 더해진다.**
따라서 **오버플로우 위험은 FIR에서도 현실적 문제**다.

### 출력 최대값의 상한

입력의 최대 크기를 \(|x[n]|\le X_{\max}\)라 하면

$$
|y[n]|
\le
X_{\max}\sum_{k=0}^{M}|b_k|.
$$

따라서

- 계수 L1 노름(절댓값 합)
- 입력 피크

로 출력 피크를 예측할 수 있다.

### 스케일링 원칙

1. 계수 스케일링:
   - 계수를 Q-format으로 양자화하기 전에
     \(\sum|b_k|\)가 과도하게 크지 않도록 이득을 분배
2. 누산기 가드비트(guard bits):
   - 누산 중간값이 커질 것을 감안해
     누산기 비트 폭을 넉넉히 둔다.
3. 출력 리스케일:
   - 마지막에 전체 gain을 조정해 원래 스펙과 맞춘다.

---

## 5) FIR 반올림 잡음의 정량 분석

### 내부 반올림 잡음이 “출력에 더해지는 방식”

탭 곱셈의 반올림 오차들을 \(\epsilon_k[n]\)라 하자.

$$
\widehat{y}[n]
=
\sum_{k=0}^{M}
\left(
b_k x[n-k] + \epsilon_k[n]
\right).
$$

따라서 출력 오차는

$$
e[n]=\widehat{y}[n]-y[n]=\sum_{k=0}^{M}\epsilon_k[n].
$$

각 \(\epsilon_k\)가 서로 독립 백색잡음이고 분산이 \(\sigma_\epsilon^2\)라면

$$
\sigma_e^2
=
(M+1)\sigma_\epsilon^2.
$$

하지만 실제로는

- 곱셈기 반올림
- 누산 중간 반올림

이 섞여 있으므로, 더 보수적으로

$$
\sigma_{y,\epsilon}^2
\approx
\sigma_\epsilon^2 \sum_{k=0}^{M} b_k^2
$$

(잡음 이득 모델)로 보는 것이 실무적이다.

### SNR 관점

출력 신호 파워 \(P_y\)와 내부 반올림 잡음 파워 \(P_\epsilon\)의 비로 SNR을 잡으면

$$
\mathrm{SNR}_{\mathrm{round}}
=
10\log_{10}\frac{P_y}{P_\epsilon}.
$$

FIR이 같은 스펙을 내기 위해 계수 에너지 \(\sum b_k^2\)가 커지는 방향(예: 아주 좁은 transition band)으로 설계되면
반올림에 의한 SNR이 악화될 수 있다.

---

## 6) GNU Octave 실험 1 — FIR 라운딩 잡음 측정

### 고정소수점 라운딩 함수

```octave
function y = q_frac(x, F)
  scale = 2^F;
  y = round(x*scale)/scale;
end
```

### Direct Form FIR 고정소수점 구현

```octave
function y = fir_df_fixed(b, x, F)
  M = length(b)-1;
  xdel = zeros(1,M);
  y = zeros(size(x));

  for n=1:length(x)
    taps = [x(n), xdel];
    acc = 0;

    for k=0:M
      prod = q_frac(b(k+1)*taps(k+1), F);
      acc  = q_frac(acc + prod, F);   % 누산 반올림 포함
    end

    y(n) = acc;

    if M>0
      xdel(2:end)=xdel(1:end-1);
      xdel(1)=x(n);
    end
  end
end
```

### 실험: float vs fixed, F 변화

```octave
clear; close all; clc; pkg load signal

Fs=48000; N=Fs/2; n=0:N-1; t=n/Fs;

% 예: 63탭 저역통과 FIR (대칭)
M=62;
fc=4000/(Fs/2);
b = fir1(M, fc, hamming(M+1));  % 창함수 설계

x = 0.7*sin(2*pi*1000*t) + 0.2*sin(2*pi*12000*t);

y_float = filter(b,1,x);

for F=[8 10 12 14]
  y_fix = fir_df_fixed(b,x,F);
  e = y_fix - y_float;

  fprintf("F=%d -> var(e)=%.3e, SNR=%.2f dB\n", ...
    F, var(e), 10*log10(mean(y_float.^2)/mean(e.^2)));
end
```

관찰:

- \(F\)가 증가하면 오차 분산이 거의 \(u^2\propto 2^{-2F}\)로 줄어든다.
- FIR은 피드백이 없어 오차가 “점점 커지는” 현상이 없고 안정적으로 감소한다.

---

## 7) GNU Octave 실험 2 — 구조(대칭 최적 vs 일반 DF) 비교

대칭 구조는 곱셈 횟수를 줄여 곱셈 라운딩 잡음을 줄여준다.

### 대칭 FIR 고정소수점 구현

```octave
function y = fir_sym_fixed(b, x, F)
  L = length(b);
  M = L-1;

  if mod(L,2)~=0
    error("여기서는 짝수 길이(L)만 다룹니다.");
  end

  half = L/2;
  xdel = zeros(1,M);
  y = zeros(size(x));

  for n=1:length(x)
    taps = [x(n), xdel];
    acc = 0;

    for k=1:half
      pair_sum = q_frac(taps(k) + taps(L+1-k), F);
      prod = q_frac(b(k)*pair_sum, F);
      acc  = q_frac(acc + prod, F);
    end

    y(n)=acc;

    if M>0
      xdel(2:end)=xdel(1:end-1);
      xdel(1)=x(n);
    end
  end
end
```

### 비교 실험

```octave
clear; close all; clc; pkg load signal

Fs=48000; N=Fs/2; n=0:N-1; t=n/Fs;

M=62; fc=4000/(Fs/2);
b = fir1(M, fc, hamming(M+1));

x = randn(1,N)*0.3;
y_float = filter(b,1,x);

F=10;
y_df  = fir_df_fixed(b,x,F);
y_sym = fir_sym_fixed(b,x,F);

e_df = y_df - y_float;
e_sym = y_sym - y_float;

fprintf("DF var(e)=%.3e\n", var(e_df));
fprintf("SYM var(e)=%.3e\n", var(e_sym));
```

대부분의 경우

- 대칭 구조가 더 낮은 라운딩 잡음을 갖는 경향
- 특히 탭 수가 클수록 이득이 커진다.

---

## 8) GNU Octave 실험 3 — “잡음 이득”과 오차 분산의 관계 확인

잡음 이득

$$
G_H=\sum b_k^2
$$

이 커질수록 출력 라운딩 잡음 분산이 커져야 한다.

```octave
clear; close all; clc; pkg load signal

Fs=48000; N=Fs/2; n=0:N-1; t=n/Fs;
x = randn(1,N)*0.2;

F=10;

M_list = [30 60 120];  % 탭 수 변화
for M=M_list
  % 더 좁은 전이대역을 요구하는 FIR을 만들수록 계수 에너지가 커지는 경향
  fc = 5000/(Fs/2);
  b = fir1(M, fc, hamming(M+1));
  GH = sum(b.^2);

  y_float = filter(b,1,x);
  y_fix = fir_df_fixed(b,x,F);

  e = y_fix - y_float;

  fprintf("M=%d, G_H=%.3e -> var(roundoff)=%.3e\n", M, GH, var(e));
end
```

- \(G_H\)가 커질수록 var(e)가 커지는 경향을 확인할 수 있다.
- FIR 반올림 영향은 “계수 에너지”와 직결된다.

---

## 9) FIR 계수 양자화와 반올림의 결합 효과

FIR에서 유한 정밀도는

1. **계수 양자화**
2. **연산 반올림**

이 함께 존재한다.

### 계수 양자화가 만드는 주파수 특성 오차

계수 양자화:

$$
b_k \to \hat{b}_k = b_k + \delta b_k
$$

이면 전송함수 오차는

$$
\delta H(e^{j\omega})
=
\sum_{k=0}^{M} \delta b_k e^{-j\omega k}.
$$

즉,

- 오차는 모든 주파수에서 누적되어 리플을 만든다.
- 특히 **좁은 전이대역/큰 탭 수** 설계에서 민감해진다.

### 계수 양자화 실험

```octave
clear; close all; clc; pkg load signal

Fs=48000; M=80; fc=4000/(Fs/2);
b = fir1(M, fc, hamming(M+1));

[H,w]=freqz(b,1,4096);

F=10;
bq = q_frac(b, F);       % 계수 양자화
[Hq,~]=freqz(bq,1,4096);

diff = max(abs(abs(H)-abs(Hq)));
fprintf("Max magnitude error after coeff quant: %.3e\n", diff);

figure;
plot(w/pi, 20*log10(abs(H)), w/pi, 20*log10(abs(Hq)));
legend("float","quantized");
grid on; title("Coefficient quantization effect");
```

- FIR은 안정성 문제는 없지만
- 리플/전이구간이 미세하게 달라진다.

---

## 10) FIR 반올림 영향 완화 전략

1. **최근접 반올림(round-to-nearest)**
   - truncation은 바이어스가 쌓일 수 있다.
2. **대칭/반대칭 최적 구조 활용**
   - 곱셈기 수 감소 → 곱셈 라운딩 잡음 감소
3. **Polyphase/멀티레이트 재배열**
   - 누산 깊이와 연산량 감소
4. **가드비트 확보**
   - 누산기 폭이 부족하면 잡음보다 더 큰 오버플로우 왜곡이 생긴다.
5. **스케일링**
   - \(\sum|b_k|\)와 입력 피크로 출력 상한을 예측하고 스케일 조정
6. **필요 시 디더**
   - 특정 톤 입력에서 라운딩 에러가 상관되어 생기는 스퓨리어스를 완화할 수 있다.
7. **정밀도/탭 수 트레이드오프**
   - 탭 수 확대는 특성 개선과 동시에 \(G_H\) 증가로 라운딩 SNR을 악화시킬 수도 있다.

---

## 11) 실무 체크리스트

1. **사양 기반 탭 수 산정**
   - 전이대역을 과도하게 좁히지 말 것(계수 에너지↑, 라운딩 SNR↓).
2. **계수 L1/L2 노름 계산**
   - 출력 피크 상한: \(X_{\max}\sum|b_k|\)
   - 라운딩 잡음 이득: \(G_H=\sum b_k^2\)
3. **구조 선정**
   - 긴 대칭 FIR이면 반드시 대칭 최적 구조
   - 샘플링률 변환이면 polyphase
4. **반올림 정책**
   - round-to-nearest + (가능하면) stochastic rounding 고려
5. **누산 가드비트**
   - 최소 \( \lceil \log_2(\sum|b_k|) \rceil \)만큼 여유
6. **정밀도 스윕 시뮬레이션**
   - \(F\) 변화에 따른 SNR/리플/잡음 플로어 확인
7. **테스트 신호 다양화**
   - 톤, 멀티톤, 백색잡음, 스텝/임펄스
8. **스펙트럼 검사**
   - 라운딩 잡음이 대역 내에서 허용되는지 확인

---

## 12) 연습문제(문제 + 풀이)

### 문제 1

\(Fs=48\,kHz\), 컷오프 \(f_c=5\,kHz\), 탭 수 51의 FIR LPF를 Hamming 창으로 설계하라.
\(F=8,10,12\)에서 라운딩 오차 분산과 SNR을 비교하라.

**풀이**

```octave
clear; close all; clc; pkg load signal

Fs=48000; fc=5000/(Fs/2); M=50;
b = fir1(M, fc, hamming(M+1));

N=Fs/2; n=0:N-1; t=n/Fs;
x = 0.8*sin(2*pi*1000*t) + 0.2*sin(2*pi*14000*t);

y_float = filter(b,1,x);

for F=[8 10 12]
  y_fix = fir_df_fixed(b,x,F);
  e = y_fix - y_float;
  SNR = 10*log10(mean(y_float.^2)/mean(e.^2));
  fprintf("F=%d -> var(e)=%.3e, SNR=%.2f dB\n", F, var(e), SNR);
end
```

---

### 문제 2

문제 1의 필터를 “대칭 최적 구조”로 구현했을 때
\(F=10\)에서 Direct Form 대비 라운딩 오차 분산이 얼마나 감소하는지 측정하라.

**풀이**

```octave
clear; close all; clc; pkg load signal

Fs=48000; fc=5000/(Fs/2); M=50;
b = fir1(M, fc, hamming(M+1));

N=Fs/2; x=randn(1,N)*0.3;
y_float = filter(b,1,x);

F=10;
y_df  = fir_df_fixed(b,x,F);
y_sym = fir_sym_fixed(b,x,F);

fprintf("DF  var(e)=%.3e\n", var(y_df - y_float));
fprintf("SYM var(e)=%.3e\n", var(y_sym - y_float));
```

---

### 문제 3

탭 수를 31, 63, 127로 늘려가면서 동일한 컷오프의 FIR을 설계하고
\(G_H=\sum b_k^2\)와 라운딩 오차 분산이 어떻게 변하는지 확인하라.

**풀이**

§8 실험 코드 그대로 수행.

---

## 13) 결론

FIR에서 반올림 영향은 IIR과 달리

- 피드백 증폭이 없고
- 잡음 이득이 유한하며
- limit cycle 같은 구조적 위험이 없다

는 점에서 훨씬 “다루기 쉽다”.

그럼에도 FIR 반올림은

- 계수 에너지(\(G_H\))
- 누산 깊이
- 구조 최적화(대칭/폴리페이즈)
- 가드비트/스케일링
- 라운딩 정책

에 따라 출력 성능을 눈에 띄게 바꿀 수 있다.

따라서 정석은 간단하다.

1. **구조적으로 연산을 줄이고**
2. **스케일링과 가드비트로 오버플로우를 막고**
3. **정밀도 스윕 시뮬레이션으로 SNR/리플을 검증**

이 세 단계를 거치면 FIR은 유한 정밀도 환경에서도 매우 믿을 만한 필터가 된다.
