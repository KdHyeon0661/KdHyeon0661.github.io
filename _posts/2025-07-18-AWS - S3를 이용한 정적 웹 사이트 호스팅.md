---
layout: post
title: AWS - S3를 이용한 정적 웹 사이트 호스팅
date: 2025-07-18 17:20:23 +0900
category: AWS
---
# AWS S3를 이용한 정적 웹 사이트 호스팅

## 개요와 선택지 맵

S3 정적 웹 호스팅에는 **두 가지** 방식이 있다.

1. **S3 Website 엔드포인트 직접 사용**
   - 예: `http://your-bucket-name.s3-website-ap-northeast-2.amazonaws.com`
   - 장점: 간단
   - 단점: **HTTPS 미지원**, 보안/최신 권장사항과 맞지 않음

2. **CloudFront(+OAC)로 S3를 원본으로 사용 — 권장**
   - 예: `https://www.example.com`
   - 장점: **HTTPS**, 캐싱/압축/성능, 글로벌 엣지, **S3 퍼블릭 차단**(OAC)
   - 단점: 초기 설정이 조금 더 복잡

**권장 경로**: **S3(퍼블릭 차단, 정적 호스팅 끔) + CloudFront + OAC + Route 53(또는 외부 DNS)**

---

## 준비사항

| 항목 | 내용 |
|---|---|
| AWS 계정 | 필수 |
| 버킷 이름 | 글로벌 유니크 |
| 리전 | 예: `ap-northeast-2` (서울) |
| 정적 파일 | `index.html`, `style.css`, `app.js`, `error.html` 등 |
| (선택) 도메인 | Route 53 또는 외부 레지스트라 |

---

## S3 버킷 생성과 파일 업로드

### S3 버킷 생성 (퍼블릭 차단 유지 · 권장)

1) 콘솔 → S3 → **버킷 만들기**
2) 이름: `my-static-website-2025` (고유)
3) **모든 퍼블릭 액세스 차단**: **체크 유지(권장)**
4) 버전 관리/암호화: 기본값(원하면 버전 관리 ON)
5) 생성

> **CloudFront+OAC** 방식을 쓸 경우, **퍼블릭 차단을 해제하지 않는다.** (보안상 중요)

### 파일 업로드

콘솔 업로드 또는 CLI:
```bash
aws s3 cp ./dist/ s3://my-static-website-2025/ --recursive
```

---

## (단순 경로) S3 Website 엔드포인트를 직접 사용하려면

> **주의**: HTTPS 미지원. 학습/내부 테스트 외에는 권장하지 않음.

### 정적 웹 사이트 호스팅 켜기

- 버킷 → **속성(Properties)** → **정적 웹 사이트 호스팅** → **사용**
- 인덱스 문서: `index.html`
- 오류 문서: `error.html` (선택)

### 퍼블릭 읽기 권한 부여(Website 직결 시)

- **권한(Permissions)** → 버킷 정책
```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Sid": "PublicReadForWebsite",
    "Effect": "Allow",
    "Principal": "*",
    "Action": "s3:GetObject",
    "Resource": "arn:aws:s3:::your-bucket-name/*"
  }]
}
```

### 접속

```
http://your-bucket-name.s3-website-ap-northeast-2.amazonaws.com
```

### 사용자 정의 도메인(HTTP만)

- 외부 DNS에서 CNAME: `www.example.com` → `your-bucket-name.s3-website-ap-northeast-2.amazonaws.com`

> **HTTPS 필요 시 CloudFront로 전환**해야 한다.

---

## (권장 경로) CloudFront + OAC + HTTPS 구성

### 개념

- **OAC(Origin Access Control)**: CloudFront가 **서명된 요청**으로 S3 비공개 버킷에 접근.
- **S3 퍼블릭 차단 유지**: 외부 직접 접근 불가, **CloudFront 경유만 허용**.
- **ACM 인증서**: 사용자 도메인(`www.example.com`)에 HTTPS 적용.

### 단계별 개요

1) S3 버킷: **퍼블릭 차단 유지**, 웹 파일 업로드
2) ACM 인증서(예: `us-east-1`에 생성, CloudFront용)
3) CloudFront 배포 생성: 원본 S3, OAC 연결
4) S3 버킷 정책: **CloudFront OAC만 허용**
5) Route 53(or 외부 DNS): CNAME/ALIAS 레코드 설정
6) 브라우저로 `https://www.example.com` 접속

### S3 버킷 정책(OAC 연결 후 예시)

CloudFront 콘솔에서 OAC를 만들면, S3 버킷 정책 제안문이 제공된다. 형태 예시는 아래와 유사(ARN/조건은 실제 값으로 교체):

```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Sid": "AllowCloudFrontOACOnly",
    "Effect": "Allow",
    "Principal": {
      "Service": "cloudfront.amazonaws.com"
    },
    "Action": "s3:GetObject",
    "Resource": "arn:aws:s3:::my-static-website-2025/*",
    "Condition": {
      "StringEquals": {
        "AWS:SourceArn": "arn:aws:cloudfront::123456789012:distribution/E123ABC456789"
      }
    }
  }]
}
```

- **중요**: **퍼블릭 액세스 차단**은 **계속 ON**
- 외부에서 S3 객체 URL로 직접 접근 불가, CloudFront를 통해서만 가능

### CloudFront 동작 기본값 설정

- 기본 동작:
  - Viewer Protocol Policy: **Redirect HTTP to HTTPS**
  - Allowed HTTP Methods: `GET, HEAD` (정적이면 충분)
  - Caching: 기본(필요 시 헤더/쿠키 제외)
  - Compress objects automatically: **On**
- 오류 응답(오류 → index.html 리디렉트): SPA 라우팅 시 유용(아래 §6 참조)

### Route 53 (또는 외부 DNS)

- **Route 53 사용 시**: A 레코드(별칭/ALIAS) → CloudFront 도메인에 매핑
- **외부 DNS 사용 시**: CNAME → CloudFront 도메인

---

## SPA(싱글 페이지 앱) 라우팅 (React/Vue/Svelte 등)

SPA는 라우팅을 **클라이언트**가 처리하므로, **서버(CloudFront/S3)는 항상 `index.html`을 리턴**하도록 설정해야 한다.

### CloudFront 커스텀 오류 응답으로 SPA 라우팅

- CloudFront → **Error Pages**:
  - HTTP 404 (또는 403) → **Respond with**: 200, **Customize Error Response** → **Response Page Path**: `/index.html`
- 결과: 존재하지 않는 경로 요청도 `index.html` 반환 → SPA 라우터가 경로 해석

### S3 Website 엔드포인트를 쓰는 경우(HTTP만)

- 정적 웹 호스팅 설정에서 **오류 문서**를 `index.html`로 지정

---

## 캐싱/배포/무효화

### 캐시 고려

- 빌드 산출물 파일명에 **콘텐츠 해시** 포함(`app.4c1a7.js`) → 강력 캐시 가능
- HTML(`index.html`)은 짧은 TTL/널 캐시 또는 매 배포 시 무효화

### 무효화(CloudFront)

```bash
aws cloudfront create-invalidation \
  --distribution-id E123ABC456 \
  --paths "/*"
```
- 비용/무효화 한도 고려
- 해시 파일명 전략을 쓰면 무효화를 최소화할 수 있다.

---

## CI/CD 자동 배포(GitHub Actions 예시)

### 예시 워크플로우: 빌드 → S3 업로드 → CF 무효화

```yaml
name: Deploy static site

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install & Build
        run: |
          npm ci
          npm run build

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789012:role/github-oidc-deploy
          aws-region: ap-northeast-2

      - name: Sync to S3
        run: |
          aws s3 sync ./dist s3://my-static-website-2025/ --delete

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id E123ABC456 \
            --paths "/index.html" "/assets/*"
```

> IAM 역할 `github-oidc-deploy`는 S3 PutObject/List, CloudFront Invalidation 권한만 최소로 부여하자.

---

## 보안 설계(최소 권한 · 모던 권장 설정)

| 항목 | 권장 |
|---|---|
| 퍼블릭 액세스 | **차단 유지** (CloudFront+OAC로 접근) |
| S3 버킷 정책 | **CloudFront OAC SourceArn** 조건으로 최소화 |
| IAM 배포 역할 | S3 Put/List, CF Invalidate **최소 권한** |
| HTTPS | CloudFront + ACM |
| 헤더 보강 | CloudFront 응답 헤더 정책: 보안 헤더 추가(Content-Security-Policy 등) |
| 로깅 | CloudFront Access Logs, S3 Server Access Logs(필요 시) |
| 비용/성능 | 압축/브로틀리, 캐시정책 최적화, 오리진 보호(사설 버킷) |

**CloudFront 응답 헤더 정책 예시(보안 헤더)**:
```json
{
  "Content-Security-Policy": "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self';",
  "Strict-Transport-Security": "max-age=63072000; includeSubDomains; preload",
  "X-Content-Type-Options": "nosniff",
  "Referrer-Policy": "no-referrer-when-downgrade",
  "X-Frame-Options": "DENY"
}
```

---

## IaC 예시

### Terraform (요약 스니펫: S3 + CF + OAC)

```hcl
provider "aws" {
  region = "ap-northeast-2"
}

resource "aws_s3_bucket" "site" {
  bucket = "my-static-website-2025"
}

resource "aws_s3_bucket_public_access_block" "pab" {
  bucket                  = aws_s3_bucket.site.id
  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

# 원하면 버전 관리/암호화 추가

resource "aws_s3_bucket_versioning" "v" {
  bucket = aws_s3_bucket.site.id
  versioning_configuration { status = "Enabled" }
}

# ACM 인증서(us-east-1) 별도 준비 필요 (data 또는 resource)

resource "aws_cloudfront_origin_access_control" "oac" {
  name                              = "site-oac"
  description                       = "OAC for S3 origin"
  origin_access_control_origin_type = "s3"
  signing_behavior                  = "always"
  signing_protocol                  = "sigv4"
}

resource "aws_cloudfront_distribution" "cdn" {
  enabled             = true
  default_root_object = "index.html"

  origins {
    domain_name = "${aws_s3_bucket.site.bucket_regional_domain_name}"
    origin_id   = "s3-origin"
    origin_access_control_id = aws_cloudfront_origin_access_control.oac.id
  }

  default_cache_behavior {
    target_origin_id       = "s3-origin"
    viewer_protocol_policy = "redirect-to-https"
    allowed_methods        = ["GET", "HEAD"]
    cached_methods         = ["GET", "HEAD"]
    compress               = true
  }

  price_class = "PriceClass_200"

  # 인증서 연결(예: 이미 발급된 ACM)
  viewer_certificate {
    acm_certificate_arn      = var.acm_arn_us_east_1
    ssl_support_method       = "sni-only"
    minimum_protocol_version = "TLSv1.2_2021"
  }
}

# S3 버킷 정책: CF OAC만 허용

data "aws_caller_identity" "cur" {}

resource "aws_s3_bucket_policy" "site_policy" {
  bucket = aws_s3_bucket.site.id
  policy = jsonencode({
    Version = "2012-10-17",
    Statement = [{
      Sid = "AllowCloudFrontOACOnly",
      Effect = "Allow",
      Principal = { Service = "cloudfront.amazonaws.com" },
      Action = ["s3:GetObject"],
      Resource = "arn:aws:s3:::${aws_s3_bucket.site.id}/*",
      Condition = {
        StringEquals = {
          "AWS:SourceArn" = aws_cloudfront_distribution.cdn.arn
        }
      }
    }]
  })
}
```

### CloudFormation (요약 스니펫)

```yaml
Resources:
  SiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: my-static-website-2025
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # OAC, Distribution, Certificate 등은 별도 리소스 정의 필요
  # (분량상 요약 — 콘솔 마법사로 만든 뒤 내보내기/템플릿 역설계도 가능)
```

---

## 예제 정적 파일

### `index.html`

```html
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>My Static Site</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <main>
    <h1>배포 성공!</h1>
    <p>이 페이지는 S3 + CloudFront(OAC)로 서비스됩니다.</p>
    <a href="/about">/about 경로 테스트</a>
  </main>
  <script src="/app.js"></script>
</body>
</html>
```

### `style.css`

```css
body { font-family: system-ui, sans-serif; margin: 2rem; }
h1 { font-size: 2rem; }
```

### `app.js`

```js
console.log("Hello from CloudFront + S3!");
```

### `error.html` (S3 Website 모드용)

```html
<!doctype html>
<html lang="ko">
<head><meta charset="utf-8"/><title>오류</title></head>
<body><h1>페이지를 찾을 수 없습니다</h1></body>
</html>
```

---

## 성능/비용 최적화

| 주제 | 팁 |
|---|---|
| 캐시 | 해시 파일명으로 강력 캐시, HTML만 짧은 TTL |
| 압축 | CloudFront 압축 활성화(Gzip/Brotli) |
| 오브젝트 크기 | 이미지/폰트 최적화(WebP/AVIF, 서브셋 폰트) |
| 엣지 | PriceClass 조정, 필요 리전만 |
| 로깅 | 분석 필요 시에만 활성화(과도 로깅 비용 주의) |
| 무효화 | 패턴 최소화, 해시 전략으로 무효화 줄이기 |

---

## 트러블슈팅

| 증상 | 원인 | 해결 |
|---|---|---|
| 403 Forbidden (S3 URL) | 퍼블릭 차단 + 버킷 정책이 CloudFront만 허용 | CloudFront 도메인으로 접근 |
| 403/404 (CF) | OAC/S3 정책 불일치 | S3 정책의 `AWS:SourceArn`이 CF 배포 ARN과 일치하는지 확인 |
| HTTPS 에러 | ACM 리전/도메인 검증 미완료 | CloudFront는 **us-east-1** ACM 사용, 도메인 검증 완료 |
| SPA 라우팅 깨짐 | 404 시 index.html 미반환 | CF 커스텀 에러 응답 200/index.html 설정 |
| 파일이 안 바뀜 | 캐시 | 무효화 또는 해시 파일명 전략 |
| 업로드 실패 | IAM 권한 부족 | 배포 역할의 S3 Put/List 권한 확인 |

---

## 체크리스트 (운영용)

- [x] **S3 퍼블릭 차단 ON** (CloudFront+OAC 전제)
- [x] S3 버킷 정책: **OAC SourceArn 조건**
- [x] CloudFront: **Redirect to HTTPS**, 압축, 캐시정책
- [x] ACM: us-east-1, 도메인 검증 완료
- [x] Route 53/DNS: CF 도메인으로 ALIAS/CNAME
- [x] SPA: 404/403 → 200 + `/index.html` 반환
- [x] 배포 자동화: GitHub Actions(또는 CodePipeline)
- [x] 보안 헤더: 응답 헤더 정책
- [x] 로깅/분석: 필요 시만 활성/정기 점검

---

## 빠른 시작(명령 모음)

```bash
# 정적 파일 업로드(초기 배포)

aws s3 sync ./dist s3://my-static-website-2025/ --delete

# 캐시 무효화(중요 변경 이후)

aws cloudfront create-invalidation \
  --distribution-id E123ABC456 \
  --paths "/index.html" "/assets/*"

# S3 객체 메타 확인(문제 조사)

aws s3api head-object --bucket my-static-website-2025 --key index.html \
  --query '{StorageClass:StorageClass,LastModified:LastModified,ETag:ETag}'

# 권한/정책 재확인(오류 시)

aws s3api get-bucket-policy --bucket my-static-website-2025
```

---

## 마무리 요약(초안 보강)

| 선택 | 특징 | 권장도 |
|---|---|---|
| S3 Website 엔드포인트 | 설정 간단, **HTTPS 미지원** | 학습/내부 테스트용 |
| **CloudFront+OAC** | **HTTPS**, 캐시, 보안, 성능, 모던 표준 | **프로덕션 권장** |

- **SPA**: CloudFront 커스텀 오류 응답으로 `index.html` 반환
- **보안**: 퍼블릭 차단 + OAC + 최소 권한 + HTTPS + 보안 헤더
- **운영**: CI/CD 자동배포, 캐시전략/무효화, IaC 관리, 로깅/모니터링

이로써 초안의 **핵심 절차**를 유지하면서, **HTTPS/보안/SPA/자동화/최적화/운영** 포인트를 모두 채워 **즉시 실전에 투입 가능한 가이드**로 확장했다. 실제 환경에서는 **도메인/배포 역할/정책/OAC/캐시정책**만 당신의 값으로 치환하여 그대로 적용하면 된다.# AWS S3를 이용한 정적 웹 사이트 호스팅 완전 정복 (재작성 · 실전 확장판)

> 규칙: **모든 코드 블록은 ``` 로, 수식은 반드시 $$...$$ 로 감싼다.**
> 이 글은 당신의 초안을 **핵심을 보존**하면서, **HTTPS(CloudFront+OAC), SPA 라우팅, CI/CD, 보안(최소 권한/퍼블릭 차단), 캐시/무효화, 비용/성능 최적화, IaC(Terraform/CloudFormation), 트러블슈팅**까지 대폭 확장한 실전 가이드다.

---

## 개요와 선택지 맵

S3 정적 웹 호스팅에는 **두 가지** 방식이 있다.

1. **S3 Website 엔드포인트 직접 사용**
   - 예: `http://your-bucket-name.s3-website-ap-northeast-2.amazonaws.com`
   - 장점: 간단
   - 단점: **HTTPS 미지원**, 보안/최신 권장사항과 맞지 않음

2. **CloudFront(+OAC)로 S3를 원본으로 사용 — 권장**
   - 예: `https://www.example.com`
   - 장점: **HTTPS**, 캐싱/압축/성능, 글로벌 엣지, **S3 퍼블릭 차단**(OAC)
   - 단점: 초기 설정이 조금 더 복잡

**권장 경로**: **S3(퍼블릭 차단, 정적 호스팅 끔) + CloudFront + OAC + Route 53(또는 외부 DNS)**

---

## 준비사항

| 항목 | 내용 |
|---|---|
| AWS 계정 | 필수 |
| 버킷 이름 | 글로벌 유니크 |
| 리전 | 예: `ap-northeast-2` (서울) |
| 정적 파일 | `index.html`, `style.css`, `app.js`, `error.html` 등 |
| (선택) 도메인 | Route 53 또는 외부 레지스트라 |

---

## S3 버킷 생성과 파일 업로드

### S3 버킷 생성 (퍼블릭 차단 유지 · 권장)

1) 콘솔 → S3 → **버킷 만들기**
2) 이름: `my-static-website-2025` (고유)
3) **모든 퍼블릭 액세스 차단**: **체크 유지(권장)**
4) 버전 관리/암호화: 기본값(원하면 버전 관리 ON)
5) 생성

> **CloudFront+OAC** 방식을 쓸 경우, **퍼블릭 차단을 해제하지 않는다.** (보안상 중요)

### 파일 업로드

콘솔 업로드 또는 CLI:
```bash
aws s3 cp ./dist/ s3://my-static-website-2025/ --recursive
```

---

## (단순 경로) S3 Website 엔드포인트를 직접 사용하려면

> **주의**: HTTPS 미지원. 학습/내부 테스트 외에는 권장하지 않음.

### 정적 웹 사이트 호스팅 켜기

- 버킷 → **속성(Properties)** → **정적 웹 사이트 호스팅** → **사용**
- 인덱스 문서: `index.html`
- 오류 문서: `error.html` (선택)

### 퍼블릭 읽기 권한 부여(Website 직결 시)

- **권한(Permissions)** → 버킷 정책
```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Sid": "PublicReadForWebsite",
    "Effect": "Allow",
    "Principal": "*",
    "Action": "s3:GetObject",
    "Resource": "arn:aws:s3:::your-bucket-name/*"
  }]
}
```

### 접속

```
http://your-bucket-name.s3-website-ap-northeast-2.amazonaws.com
```

### 사용자 정의 도메인(HTTP만)

- 외부 DNS에서 CNAME: `www.example.com` → `your-bucket-name.s3-website-ap-northeast-2.amazonaws.com`

> **HTTPS 필요 시 CloudFront로 전환**해야 한다.

---

## (권장 경로) CloudFront + OAC + HTTPS 구성

### 개념

- **OAC(Origin Access Control)**: CloudFront가 **서명된 요청**으로 S3 비공개 버킷에 접근.
- **S3 퍼블릭 차단 유지**: 외부 직접 접근 불가, **CloudFront 경유만 허용**.
- **ACM 인증서**: 사용자 도메인(`www.example.com`)에 HTTPS 적용.

### 단계별 개요

1) S3 버킷: **퍼블릭 차단 유지**, 웹 파일 업로드
2) ACM 인증서(예: `us-east-1`에 생성, CloudFront용)
3) CloudFront 배포 생성: 원본 S3, OAC 연결
4) S3 버킷 정책: **CloudFront OAC만 허용**
5) Route 53(or 외부 DNS): CNAME/ALIAS 레코드 설정
6) 브라우저로 `https://www.example.com` 접속

### S3 버킷 정책(OAC 연결 후 예시)

CloudFront 콘솔에서 OAC를 만들면, S3 버킷 정책 제안문이 제공된다. 형태 예시는 아래와 유사(ARN/조건은 실제 값으로 교체):

```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Sid": "AllowCloudFrontOACOnly",
    "Effect": "Allow",
    "Principal": {
      "Service": "cloudfront.amazonaws.com"
    },
    "Action": "s3:GetObject",
    "Resource": "arn:aws:s3:::my-static-website-2025/*",
    "Condition": {
      "StringEquals": {
        "AWS:SourceArn": "arn:aws:cloudfront::123456789012:distribution/E123ABC456789"
      }
    }
  }]
}
```

- **중요**: **퍼블릭 액세스 차단**은 **계속 ON**
- 외부에서 S3 객체 URL로 직접 접근 불가, CloudFront를 통해서만 가능

### CloudFront 동작 기본값 설정

- 기본 동작:
  - Viewer Protocol Policy: **Redirect HTTP to HTTPS**
  - Allowed HTTP Methods: `GET, HEAD` (정적이면 충분)
  - Caching: 기본(필요 시 헤더/쿠키 제외)
  - Compress objects automatically: **On**
- 오류 응답(오류 → index.html 리디렉트): SPA 라우팅 시 유용(아래 §6 참조)

### Route 53 (또는 외부 DNS)

- **Route 53 사용 시**: A 레코드(별칭/ALIAS) → CloudFront 도메인에 매핑
- **외부 DNS 사용 시**: CNAME → CloudFront 도메인

---

## SPA(싱글 페이지 앱) 라우팅 (React/Vue/Svelte 등)

SPA는 라우팅을 **클라이언트**가 처리하므로, **서버(CloudFront/S3)는 항상 `index.html`을 리턴**하도록 설정해야 한다.

### CloudFront 커스텀 오류 응답으로 SPA 라우팅

- CloudFront → **Error Pages**:
  - HTTP 404 (또는 403) → **Respond with**: 200, **Customize Error Response** → **Response Page Path**: `/index.html`
- 결과: 존재하지 않는 경로 요청도 `index.html` 반환 → SPA 라우터가 경로 해석

### S3 Website 엔드포인트를 쓰는 경우(HTTP만)

- 정적 웹 호스팅 설정에서 **오류 문서**를 `index.html`로 지정

---

## 캐싱/배포/무효화

### 캐시 고려

- 빌드 산출물 파일명에 **콘텐츠 해시** 포함(`app.4c1a7.js`) → 강력 캐시 가능
- HTML(`index.html`)은 짧은 TTL/널 캐시 또는 매 배포 시 무효화

### 무효화(CloudFront)

```bash
aws cloudfront create-invalidation \
  --distribution-id E123ABC456 \
  --paths "/*"
```
- 비용/무효화 한도 고려
- 해시 파일명 전략을 쓰면 무효화를 최소화할 수 있다.

---

## CI/CD 자동 배포(GitHub Actions 예시)

### 예시 워크플로우: 빌드 → S3 업로드 → CF 무효화

```yaml
name: Deploy static site

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install & Build
        run: |
          npm ci
          npm run build

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789012:role/github-oidc-deploy
          aws-region: ap-northeast-2

      - name: Sync to S3
        run: |
          aws s3 sync ./dist s3://my-static-website-2025/ --delete

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id E123ABC456 \
            --paths "/index.html" "/assets/*"
```

> IAM 역할 `github-oidc-deploy`는 S3 PutObject/List, CloudFront Invalidation 권한만 최소로 부여하자.

---

## 보안 설계(최소 권한 · 모던 권장 설정)

| 항목 | 권장 |
|---|---|
| 퍼블릭 액세스 | **차단 유지** (CloudFront+OAC로 접근) |
| S3 버킷 정책 | **CloudFront OAC SourceArn** 조건으로 최소화 |
| IAM 배포 역할 | S3 Put/List, CF Invalidate **최소 권한** |
| HTTPS | CloudFront + ACM |
| 헤더 보강 | CloudFront 응답 헤더 정책: 보안 헤더 추가(Content-Security-Policy 등) |
| 로깅 | CloudFront Access Logs, S3 Server Access Logs(필요 시) |
| 비용/성능 | 압축/브로틀리, 캐시정책 최적화, 오리진 보호(사설 버킷) |

**CloudFront 응답 헤더 정책 예시(보안 헤더)**:
```json
{
  "Content-Security-Policy": "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self';",
  "Strict-Transport-Security": "max-age=63072000; includeSubDomains; preload",
  "X-Content-Type-Options": "nosniff",
  "Referrer-Policy": "no-referrer-when-downgrade",
  "X-Frame-Options": "DENY"
}
```

---

## IaC 예시

### Terraform (요약 스니펫: S3 + CF + OAC)

```hcl
provider "aws" {
  region = "ap-northeast-2"
}

resource "aws_s3_bucket" "site" {
  bucket = "my-static-website-2025"
}

resource "aws_s3_bucket_public_access_block" "pab" {
  bucket                  = aws_s3_bucket.site.id
  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

# 원하면 버전 관리/암호화 추가

resource "aws_s3_bucket_versioning" "v" {
  bucket = aws_s3_bucket.site.id
  versioning_configuration { status = "Enabled" }
}

# ACM 인증서(us-east-1) 별도 준비 필요 (data 또는 resource)

resource "aws_cloudfront_origin_access_control" "oac" {
  name                              = "site-oac"
  description                       = "OAC for S3 origin"
  origin_access_control_origin_type = "s3"
  signing_behavior                  = "always"
  signing_protocol                  = "sigv4"
}

resource "aws_cloudfront_distribution" "cdn" {
  enabled             = true
  default_root_object = "index.html"

  origins {
    domain_name = "${aws_s3_bucket.site.bucket_regional_domain_name}"
    origin_id   = "s3-origin"
    origin_access_control_id = aws_cloudfront_origin_access_control.oac.id
  }

  default_cache_behavior {
    target_origin_id       = "s3-origin"
    viewer_protocol_policy = "redirect-to-https"
    allowed_methods        = ["GET", "HEAD"]
    cached_methods         = ["GET", "HEAD"]
    compress               = true
  }

  price_class = "PriceClass_200"

  # 인증서 연결(예: 이미 발급된 ACM)
  viewer_certificate {
    acm_certificate_arn      = var.acm_arn_us_east_1
    ssl_support_method       = "sni-only"
    minimum_protocol_version = "TLSv1.2_2021"
  }
}

# S3 버킷 정책: CF OAC만 허용

data "aws_caller_identity" "cur" {}

resource "aws_s3_bucket_policy" "site_policy" {
  bucket = aws_s3_bucket.site.id
  policy = jsonencode({
    Version = "2012-10-17",
    Statement = [{
      Sid = "AllowCloudFrontOACOnly",
      Effect = "Allow",
      Principal = { Service = "cloudfront.amazonaws.com" },
      Action = ["s3:GetObject"],
      Resource = "arn:aws:s3:::${aws_s3_bucket.site.id}/*",
      Condition = {
        StringEquals = {
          "AWS:SourceArn" = aws_cloudfront_distribution.cdn.arn
        }
      }
    }]
  })
}
```

### CloudFormation (요약 스니펫)

```yaml
Resources:
  SiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: my-static-website-2025
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # OAC, Distribution, Certificate 등은 별도 리소스 정의 필요
  # (분량상 요약 — 콘솔 마법사로 만든 뒤 내보내기/템플릿 역설계도 가능)
```

---

## 예제 정적 파일

### `index.html`

```html
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>My Static Site</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <main>
    <h1>배포 성공!</h1>
    <p>이 페이지는 S3 + CloudFront(OAC)로 서비스됩니다.</p>
    <a href="/about">/about 경로 테스트</a>
  </main>
  <script src="/app.js"></script>
</body>
</html>
```

### `style.css`

```css
body { font-family: system-ui, sans-serif; margin: 2rem; }
h1 { font-size: 2rem; }
```

### `app.js`

```js
console.log("Hello from CloudFront + S3!");
```

### `error.html` (S3 Website 모드용)

```html
<!doctype html>
<html lang="ko">
<head><meta charset="utf-8"/><title>오류</title></head>
<body><h1>페이지를 찾을 수 없습니다</h1></body>
</html>
```

---

## 성능/비용 최적화

| 주제 | 팁 |
|---|---|
| 캐시 | 해시 파일명으로 강력 캐시, HTML만 짧은 TTL |
| 압축 | CloudFront 압축 활성화(Gzip/Brotli) |
| 오브젝트 크기 | 이미지/폰트 최적화(WebP/AVIF, 서브셋 폰트) |
| 엣지 | PriceClass 조정, 필요 리전만 |
| 로깅 | 분석 필요 시에만 활성화(과도 로깅 비용 주의) |
| 무효화 | 패턴 최소화, 해시 전략으로 무효화 줄이기 |

---

## 트러블슈팅

| 증상 | 원인 | 해결 |
|---|---|---|
| 403 Forbidden (S3 URL) | 퍼블릭 차단 + 버킷 정책이 CloudFront만 허용 | CloudFront 도메인으로 접근 |
| 403/404 (CF) | OAC/S3 정책 불일치 | S3 정책의 `AWS:SourceArn`이 CF 배포 ARN과 일치하는지 확인 |
| HTTPS 에러 | ACM 리전/도메인 검증 미완료 | CloudFront는 **us-east-1** ACM 사용, 도메인 검증 완료 |
| SPA 라우팅 깨짐 | 404 시 index.html 미반환 | CF 커스텀 에러 응답 200/index.html 설정 |
| 파일이 안 바뀜 | 캐시 | 무효화 또는 해시 파일명 전략 |
| 업로드 실패 | IAM 권한 부족 | 배포 역할의 S3 Put/List 권한 확인 |

---

## 체크리스트 (운영용)

- [x] **S3 퍼블릭 차단 ON** (CloudFront+OAC 전제)
- [x] S3 버킷 정책: **OAC SourceArn 조건**
- [x] CloudFront: **Redirect to HTTPS**, 압축, 캐시정책
- [x] ACM: us-east-1, 도메인 검증 완료
- [x] Route 53/DNS: CF 도메인으로 ALIAS/CNAME
- [x] SPA: 404/403 → 200 + `/index.html` 반환
- [x] 배포 자동화: GitHub Actions(또는 CodePipeline)
- [x] 보안 헤더: 응답 헤더 정책
- [x] 로깅/분석: 필요 시만 활성/정기 점검

---

## 빠른 시작(명령 모음)

```bash
# 정적 파일 업로드(초기 배포)

aws s3 sync ./dist s3://my-static-website-2025/ --delete

# 캐시 무효화(중요 변경 이후)

aws cloudfront create-invalidation \
  --distribution-id E123ABC456 \
  --paths "/index.html" "/assets/*"

# S3 객체 메타 확인(문제 조사)

aws s3api head-object --bucket my-static-website-2025 --key index.html \
  --query '{StorageClass:StorageClass,LastModified:LastModified,ETag:ETag}'

# 권한/정책 재확인(오류 시)

aws s3api get-bucket-policy --bucket my-static-website-2025
```

---

## 마무리 요약(초안 보강)

| 선택 | 특징 | 권장도 |
|---|---|---|
| S3 Website 엔드포인트 | 설정 간단, **HTTPS 미지원** | 학습/내부 테스트용 |
| **CloudFront+OAC** | **HTTPS**, 캐시, 보안, 성능, 모던 표준 | **프로덕션 권장** |

- **SPA**: CloudFront 커스텀 오류 응답으로 `index.html` 반환
- **보안**: 퍼블릭 차단 + OAC + 최소 권한 + HTTPS + 보안 헤더
- **운영**: CI/CD 자동배포, 캐시전략/무효화, IaC 관리, 로깅/모니터링

이로써 초안의 **핵심 절차**를 유지하면서, **HTTPS/보안/SPA/자동화/최적화/운영** 포인트를 모두 채워 **즉시 실전에 투입 가능한 가이드**로 확장했다. 실제 환경에서는 **도메인/배포 역할/정책/OAC/캐시정책**만 당신의 값으로 치환하여 그대로 적용하면 된다.
