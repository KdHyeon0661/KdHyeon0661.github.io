---
layout: post
title: 정보보안기사 - 이메일 시스템 구조, SMTP 메일 형식
date: 2025-11-13 16:25:23 +0900
category: 정보보안기사
---
# SECTION 10 이메일(E-Mail) 보안 — 01. 이메일 시스템 구조 · 02. SMTP 메일 형식

## 0. 개요
본 문서는 이메일의 **시스템 구조(구성요소·흐름·DNS·보안 통제)**와 **SMTP/ESMTP 메일 형식(프로토콜·헤더·MIME·인코딩·보안 확장)**을 실무 관점에서 정리한다. 실습용 **원시 SMTP 세션**, **DNS 레코드 예시**, **MTA(아파치/포스트픽스) 하드닝 스니펫**, **파이썬 전송/파싱 코드**를 포함한다.

---

## 01. 이메일 시스템 구조

### 1.1 구성요소와 역할

| 구성요소 | 약어 | 핵심 역할 | 예 |
|---|---|---|---|
| 메일 사용자 에이전트 | **MUA** | 작성/읽기(클라이언트) | Thunderbird, Outlook, iOS Mail |
| 메일 제출 에이전트 | **MSA** | 클라이언트에서 수신, 인증 후 송신 | smtp.submit.example.com:587 |
| 메일 전송 에이전트 | **MTA** | 도메인간 릴레이/큐잉/재시도 | Postfix, Exim, Exchange |
| 메일 전달 에이전트 | **MDA** | 최종 사서함으로 배달 | Dovecot LDA, procmail |
| 사서함/저장소 | — | Maildir/mbox, 보관/인덱싱 | Maildir, mbox |
| 접근 프로토콜 | — | IMAP/POP3(클/서 동기화) | imaps:993, pop3s:995 |
| 네임서비스 | **DNS** | MX, A/AAAA, SPF, DKIM, DMARC, MTA-STS, TLSRPT, DANE | 도메인 신뢰/라우팅 |

**요약 흐름**: MUA → (AUTH) → **MSA** → **MTA(송신)** → DNS(MX) 조회 → **MTA(수신)** → **MDA** → 사서함 → MUA(IMAP/POP)

### 1.2 메일 흐름(번호=검증/보안 포인트)

```
(1) 작성 MUA          (2) 제출 MSA            (3) 송신 MTA    (4) 수신 MTA/MX      (5) MDA → 사서함       (6) MUA(IMAP/POP)
    ┌─────────┐  AUTH ┌───────────┐  MX     ┌─────────┐     ┌──────────────┐     ┌───────────────┐       ┌──────────────┐
    │  User   │ ─────▶│smtp.submit│ ───────▶│  MTA    │ ───▶│ mail.example │ ───▶│  Maildir/mbox  │ ───▶  │  Reader MUA  │
    └─────────┘ START │  :587/465 │  (DNS)  └─────────┘     └──────────────┘     └───────────────┘       └──────────────┘
          ▲      (A)       (B)         (C)        (D)               (E)                 (F)                        (G)
```

- (A) 클라이언트 인증: **SMTP AUTH + STARTTLS/SMTPS** (비밀번호 유출·스푸핑 방지)
- (B) 발신 정책: **SPF/DKIM 서명**(MSA/경유 MTA에서)
- (C) 라우팅: **MX** 우선순위, **MTA-STS/DANE**로 TLS 요구
- (D) 전송: **ESMTP(PIPELINING/SIZE/8BITMIME/CHUNKING)**
- (E) 수신단 검증: **SPF·DKIM·DMARC·ARC**, 안티스팸/안티멀웨어, DKIM 키 회전
- (F) 저장: **암호화(At-Rest), 권한, 백업/보존**, 인덱스/쿼터
- (G) 접근: **IMAPS/POP3S**, OAuth2(가능 시), 기기 분실/토큰 폐기

### 1.3 DNS와 신뢰 경계
**MX 레코드** – 수신 MTA를 지정:
```
example.com.    3600  IN  MX 10 mx1.example.net.
example.com.    3600  IN  MX 20 mx2.example.net.
```

**SPF(TXT)** – 허용 발신 소스 선언:
```
example.com. IN TXT "v=spf1 ip4:203.0.113.10 include:_spf.mailhost.com -all"
```

**DKIM(선택자._domainkey.TXT)** – 공개키 배포:
```
selector1._domainkey.example.com. IN TXT "v=DKIM1; k=rsa; p=MIIBIjANBgkq..."
```

**DMARC(TXT)** – SPF/DKIM 정렬과 정책:
```
_dmarc.example.com. IN TXT "v=DMARC1; p=quarantine; rua=mailto:dmarc@ex.com; adkim=s; aspf=s"
```

**MTA-STS/TLSRPT** – MTA TLS 정책·보고:
```
_mta-sts.example.com. IN TXT "v=STSv1; id=2024110101"
_smtp._tls.example.com. IN TXT "v=TLSRPTv1; rua=mailto:tlsrpt@ex.com"
```

**DANE(TLSA)** – DNSSEC 기반 TLS 고정(선택):
```
_25._tcp.mail.example.com. IN TLSA 3 1 1 <SPKI SHA-256>
```

### 1.4 송신 경로 보안(Submission/AUTH/STARTTLS)
- 사용자 제출 포트: **587(STARTTLS)** 또는 **465(SMTPS)**
- 강제 TLS, **OAuth2/SPA** 가능 시 채택, IP·평판 제어(아웃바운드 릴레이)

**파이썬 SMTP 전송 예(제출 서버, HTML+텍스트)**:
```python
import smtplib, ssl
from email.message import EmailMessage

msg = EmailMessage()
msg["Subject"] = "보안 테스트: 텍스트/HTML"
msg["From"] = "no-reply@example.com"
msg["To"] = "user@receiver.net"
msg.set_content("텍스트 버전 본문")
msg.add_alternative("<h1>HTML 본문</h1><p>테스트</p>", subtype="html")

ctx = ssl.create_default_context()  # 시스템 CA 신뢰
with smtplib.SMTP("smtp.submit.example.com", 587) as s:
    s.ehlo()
    s.starttls(context=ctx)         # STARTTLS
    s.ehlo()
    s.login("no-reply@example.com", "app-password")
    s.send_message(msg)
```

**원시 세션(학습용)**:
```
$ openssl s_client -starttls smtp -connect smtp.submit.example.com:587
EHLO host.test
AUTH LOGIN
(base64 사용자/비밀번호)
MAIL FROM:<no-reply@example.com>
RCPT TO:<user@receiver.net>
DATA
From: no-reply@example.com
To: user@receiver.net
Subject: test
Date: Tue, 11 Nov 2025 10:00:00 +0900

hello
.
QUIT
```

### 1.5 수신 경로 보안(인바운드 파이프라인)
1) **연결 단계**: RBL/CBL/HELO 검증, **postscreen/fail2ban**
2) **TLS**: STARTTLS 강제(가능 시), **MTA-STS/DANE**로 업그레이드
3) **프로토콜**: **ESMTP SIZE/8BITMIME/PIPELINING** 제한값 협상
4) **콘텐츠**: AV/샌드박스, 스팸 스코어(헤더/본문/링크), 첨부 정책
5) **인증**: SPF/DKIM 판정 → **DMARC 정책** 적용, **ARC** 신뢰 계승
6) **정책**: 수신 거부/격리/태깅, 사용자 알림/보고

**Postfix 하드닝 예(main.cf 일부)**:
```
smtpd_tls_security_level = may
smtp_tls_security_level  = dane
smtpd_tls_loglevel = 1
smtpd_helo_required = yes
smtpd_helo_restrictions = permit_mynetworks, reject_invalid_helo_hostname
smtpd_client_restrictions = permit_mynetworks, reject_unknown_reverse_client_hostname
smtpd_sender_restrictions = reject_non_fqdn_sender, reject_unknown_sender_domain
smtpd_recipient_restrictions = permit_mynetworks, reject_unauth_pipelining, reject_unknown_recipient_domain, reject_rbl_client zen.spamhaus.org, permit
message_size_limit = 10485760
```

### 1.6 저장·접근(사서함·암호화)
- **형식**: Maildir(파일 per 메시지, 병렬/안전), mbox(단일 파일)
- **암호화**: 디스크 암호화(LUKS/BitLocker), 서버 측 KMS, 첨부/민감 헤더 마스킹
- **IMAP**: 검색/폴더/플래그, **IMAPS:993** 필수, OAuth2(증분 폐기 용이)
- **POP3**: 단순/다운로드형, **POP3S:995**

### 1.7 로깅·모니터링
- **MTA 로그**: 접속 IP, TLS 유무/암호군, 큐 ID, 지연/실패 사유(4xx/5xx), 릴레이 여부
- **분석 지표**: 수신/송신 성공률, 지연 분포, Bounce 코드별 비율, 스팸 태깅률, DMARC 실패율

간단 파서(큐 지연·상태 집계):
```python
import re, sys, collections
delay = []
status = collections.Counter()
for line in sys.stdin:
    if m := re.search(r'delay=([\d\.]+)', line): delay.append(float(m.group(1)))
    if m := re.search(r'status=(\w+)', line): status[m.group(1)] += 1
print("count:", len(delay), "avg_delay:", sum(delay)/len(delay) if delay else 0)
print(status)
```

### 1.8 큐잉/재시도·고가용성
- **MX 우선순위**: 다중 MX로 Failover
- **재시도**: 지수 백오프(최대 보유기간 내 재시도)

지수 백오프 근사:
$$
t_n = t_0 \cdot \alpha^{n},\quad T=\sum_{n=0}^{k} t_n \le T_{\max}
$$
- \(t_0\): 최초 지연, \(\alpha>1\): 배수, \(T_{\max}\): 큐 보유기간(예: 4~5일)

### 1.9 위협·대응 매핑(요약)

| 위협 | 방어 |
|---|---|
| 계정 탈취/스푸핑 | AUTH+TLS, MFA, 제출서버 제한, DMARC align |
| 중간자(MITM) | STARTTLS, MTA-STS/DANE, TLSRPT |
| 스팸/피싱 | SPF/DKIM/DMARC, 평판·콘텐츠 필터, URL 재작성 |
| 멀웨어 첨부 | AV/샌드박스, 파일 정책, 격리 |
| 포워더 경유 실패 | ARC 도입, DMARC 정책 조율 |

---

## 02. SMTP 메일 형식

### 2.1 SMTP/ESMTP 개요
- **RFC 5321(SMTP)**, **RFC 5322(메시지 포맷)**, **ESMTP 확장**(SIZE, STARTTLS, AUTH, 8BITMIME, PIPELINING, CHUNKING(BDAT), DSN 등)

핵심 명령/확장:

| 명령 | 의미 |
|---|---|
| HELO/EHLO | 세션 시작(ESMTP는 EHLO) |
| MAIL FROM | 송신자 경로(Envelope Sender) |
| RCPT TO | 수신자 경로(Envelope Recipient) |
| DATA | 메시지 본문 시작(“.” 단독 줄로 종료) |
| RSET/NOOP/QUIT | 세션 제어 |
| STARTTLS | TLS 업그레이드(ESMTP) |
| AUTH | 제출 인증(PLAIN/LOGIN/XOAUTH2 등) |
| BDAT | 바이너리 청크 전송(ESMTP CHUNKING) |

### 2.2 SMTP 세션 예시(텍스트)
```
S: 220 mx.receiver.net ESMTP
C: EHLO mx.sender.net
S: 250-mx.receiver.net Hello
S: 250-SIZE 15728640
S: 250-STARTTLS
S: 250-8BITMIME
S: 250-PIPELINING
S: 250-DSN
S: 250 OK
C: STARTTLS
S: 220 Ready to start TLS
  (TLS handshake)
C: EHLO mx.sender.net
S: 250-SIZE 15728640
S: 250-8BITMIME
S: 250-PIPELINING
S: 250 OK
C: MAIL FROM:<no-reply@example.com> SIZE=3456
S: 250 2.1.0 Ok
C: RCPT TO:<user@receiver.net>
S: 250 2.1.5 Ok
C: DATA
S: 354 End data with <CR><LF>.<CR><LF>
C: (RFC5322 메시지 본문...)
C: .
S: 250 2.0.0 Queued as ABC123
C: QUIT
S: 221 2.0.0 Bye
```

### 2.3 RFC 5322 헤더(논리/표시 구분)
- **Envelope(경로)**: MAIL FROM/RCPT TO
- **RFC5322 헤더(표시)**: `From:`, `To:`, `Date:`, `Subject:`, `Message-ID:`, `MIME-Version:`, `Content-Type`, `Content-Transfer-Encoding`, `Reply-To`, `In-Reply-To`, `References`, `List-*` 등
- **Received:** 헤더는 각 MTA가 상단에 누적(상단이 최신)

필수/권장 헤더 예:
```
Date: Tue, 11 Nov 2025 10:03:00 +0900
From: "공지" <no-reply@example.com>
To: user@receiver.net
Subject: 시스템 점검 안내
Message-ID: <20251111.100300.12345@example.com>
MIME-Version: 1.0
```

### 2.4 MIME 구조(멀티파트)
대표 타입:
- `multipart/alternative` : **텍스트**와 **HTML** 두 버전 (클라이언트가 선택 표시)
- `multipart/mixed` : 본문 + 첨부
- `multipart/related` : HTML + 인라인 이미지(CID)

**텍스트+HTML 대체 + 첨부 예**:
```
Content-Type: multipart/mixed; boundary="mix-123"

--mix-123
Content-Type: multipart/alternative; boundary="alt-456"

--alt-456
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

안내 문서 첨부합니다.

--alt-456
Content-Type: text/html; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

<html><body><p>안내 문서 첨부합니다.</p></body></html>
--alt-456--

--mix-123
Content-Type: application/pdf
Content-Disposition: attachment; filename="guide.pdf"
Content-Transfer-Encoding: base64

JVBERi0xLjQKJ...(생략)
--mix-123--
```

**인라인 이미지(CID) 예**:
```
Content-Type: multipart/related; boundary="rel-1"

--rel-1
Content-Type: text/html; charset="UTF-8"

<html><body>
<img src="cid:logo@ex" />
</body></html>

--rel-1
Content-Type: image/png
Content-ID: <logo@ex>
Content-Transfer-Encoding: base64

iVBORw0KGgo...(생략)
--rel-1--
```

### 2.5 인코딩(본문/헤더)
- 본문: `7bit`, `quoted-printable`(가독/텍스트), `base64`(바이너리/첨부), `8bit`(8BITMIME 환경)
- 헤더: **Encoded-Word**(RFC 2047) – `=?UTF-8?B?...?=` 또는 `=?UTF-8?Q?...?=`

**QP 예(한글 일부 이스케이프)**:
```
Content-Transfer-Encoding: quoted-printable
=EC=95=88=EB=85=95 (UTF-8)
```

**헤더 인코딩 예(Subject)**:
```
Subject: =?UTF-8?B?7JWI64WVIOyXhOydvA==?=
```

### 2.6 국제화(UTF-8 확장)
- **SMTPUTF8**(RFC 6531): 이메일 주소/헤더 UTF-8 허용(서버 지원 필요)
- 미지원 경로 대비: **Punycode**(도메인), 표시명/제목 Encoded-Word

### 2.7 인증 결과 헤더
수신 MTA는 검사 결과를 **Authentication-Results**로 표기:
```
Authentication-Results: mx.receiver.net;
 spf=pass smtp.mailfrom=no-reply@example.com;
 dkim=pass header.d=example.com header.s=selector1;
 dmarc=pass (p=quarantine dis=none) header.from=example.com
```
포워딩 환경 보존: **ARC-Seal**, **ARC-Message-Signature**, **ARC-Authentication-Results**

### 2.8 DSN/MDN·반송(바운스)
- **DSN(RFC 3464)**: 배달 상태 보고(multipart/report; report-type=delivery-status)
- **반송 메일 예(요지)**:
```
From: MAILER-DAEMON@mail.receiver.net
Subject: Undelivered Mail Returned to Sender
Content-Type: multipart/report; report-type=delivery-status; boundary="ds-1"

--ds-1
Delivery to the following recipient failed permanently: user@nonexistent.net
--ds-1
Final-Recipient: rfc822; user@nonexistent.net
Action: failed
Status: 5.1.1
Diagnostic-Code: smtp; 550 5.1.1 User unknown
--ds-1--
```

### 2.9 보안 확장 개요
- **STARTTLS**: 전송 구간 암호화(업그레이드)
- **MTA-STS/TLSRPT**: 정책·보고로 **TLS 강제 신뢰**도 향상
- **DANE**: DNSSEC 기반 서버 인증
- **S/MIME/PGP**(본문/첨부 암호·서명)는 **사용자 레벨**의 E2E 보안(제목/헤더는 평문 메타데이터임에 유의)

### 2.10 실습: 원시 MIME 작성/전송(파이썬)
```python
import smtplib, ssl
raw = """From: "공지" <no-reply@example.com>
To: user@receiver.net
Subject: =?UTF-8?B?7Iuc7IOdIOq3uOyXkQ==?=
Date: Tue, 11 Nov 2025 10:10:00 +0900
Message-ID: <20251111.101000.abc@example.com>
MIME-Version: 1.0
Content-Type: multipart/alternative; boundary="alt-1"

--alt-1
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

=EA=B3=B5=EC=A7=80=20=EB=AC=B8=EC=9D=98=EB=8A=94=20help@example.com=20

--alt-1
Content-Type: text/html; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

<html><body><p><b>공지</b> 문의는 <a href="mailto:help@example.com">help@example.com</a></p></body></html>
--alt-1--
"""
ctx = ssl.create_default_context()
with smtplib.SMTP_SSL("smtp.submit.example.com", 465, context=ctx) as s:
    s.login("no-reply@example.com", "app-password")
    s.sendmail("no-reply@example.com", ["user@receiver.net"], raw)
```

### 2.11 검사: 헤더 파싱/검증(파이썬)
```python
from email import policy
from email.parser import BytesParser
import sys
msg = BytesParser(policy=policy.default).parse(sys.stdin.buffer)
print("Subject:", msg["subject"])
for h in msg.get_all("received", []):
    print("Received:", h)
ctype = msg.get_content_type()
if msg.is_multipart():
    for part in msg.walk():
        if part.get_content_type() == "text/plain":
            print("TEXT:", part.get_content())
else:
    print(ctype, msg.get_content())
```

### 2.12 운영 체크리스트(형식·전송·신뢰)

**형식/헤더**
- [ ] `Date/From/To/Message-ID/Subject/MIME-Version` 적정
- [ ] `multipart/alternative` 우선순서(텍스트 먼저, HTML 다음)
- [ ] 첨부 `Content-Disposition: attachment; filename=...`
- [ ] 헤더 인코딩(Encoded-Word), 본문 인코딩(QP/Base64) 일관

**전송/보안**
- [ ] 제출 587/465, **AUTH+TLS** 강제
- [ ] STARTTLS, **MTA-STS/TLSRPT** 배포, 가능한 경우 **DANE**
- [ ] 최대 크기/파이프라이닝/청크 제한 설정

**신뢰/정책**
- [ ] **SPF**: 최솟값으로 허용 소스 선언, `-all`
- [ ] **DKIM**: 선택자 회전, 키 길이(RSA 2048+ 또는 Ed25519)
- [ ] **DMARC**: `p=quarantine`→운영 안정 후 `p=reject`, `rua` 보고 수집
- [ ] **ARC**: 포워딩 환경 고려, 게이트웨이에서 서명

---

## 부록 A) DKIM 서명 파이프라인(개념)
1) 애플리케이션 또는 경유 MTA가 **DKIM-Signature** 헤더 삽입
2) 수신 MTA가 `selector._domainkey.domain`의 공개키 조회
3) 헤더/본문 해시 검증 → 결과를 Authentication-Results에 기록

**opendkim 예(main.cf 연동 스니펫)**:
```
milter_default_action = accept
smtpd_milters = inet:localhost:8891
non_smtpd_milters = $smtpd_milters
```

---

## 부록 B) 표 — MIME 주요 타입/용도

| 타입 | 용도 | 비고 |
|---|---|---|
| text/plain | 기본 텍스트 | QP 권장 |
| text/html | HTML 본문 | XSS/트래킹 주의 |
| multipart/alternative | 텍스트+HTML | 순서 중요(텍스트 먼저) |
| multipart/mixed | 본문+첨부 | 첨부 다수 |
| multipart/related | HTML+인라인 리소스 | CID 참조 |
| application/pdf | 문서 첨부 | Base64 |
| image/* | 이미지 | Base64/CID |

---

## 요약
- **시스템 구조**는 **MUA→MSA→MTA→MDA→사서함** 파이프라인과 **DNS 기반 신뢰(SPF/DKIM/DMARC, MTA-STS/DANE)**가 핵심이다.
- **SMTP/ESMTP 형식**은 **RFC5321/5322 + MIME** 조합으로, **헤더·바디·인코딩**을 정확히 다루고 **STARTTLS/AUTH**로 보호한다.
- 운영에서는 **큐·재시도·로그·지표**와 **정책(발신/수신) 하드닝**이 품질과 신뢰도를 결정한다.
