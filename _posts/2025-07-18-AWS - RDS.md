---
layout: post
title: AWS - RDS
date: 2025-07-18 23:20:23 +0900
category: AWS
---
# AWS RDS: 관계형 데이터베이스 서비스

## RDS란?

RDS(Relational Database Service)는 **완전관리형** RDB 서비스다. 운영체제 패치, DB 패치, 백업, 장애조치 등 반복 작업을 **관리형**으로 제공한다.

### 핵심 특징

- 관리형 엔진: **Aurora(MySQL/PostgreSQL 호환), MySQL, PostgreSQL, MariaDB, Oracle, SQL Server**
- **자동 백업, 자동 패치, 모니터링, 자동 장애 조치**
- **Multi-AZ** 배포, **Read Replica** 확장
- **KMS 암호화**, **SSL/TLS**, **IAM 인증(엔진별)**
- **RDS Proxy, Performance Insights, Enhanced Monitoring**

---

## RDS가 필요한 이유

온프레미스 또는 EC2 자체 구축 대비:

| 항목 | EC2+자체구축 | RDS |
|---|---|---|
| OS/DB 패치 | 직접 스케줄/적용 | 자동화·예약 윈도우 |
| 백업 | 스크립트/툴 필요 | 자동 백업+PITR |
| 장애조치 | 수동 복구/복제 구성 | Multi-AZ 자동 Failover |
| 모니터링 | 에이전트 설치/수집 | CloudWatch/PI 연계 |
| 보안/암호화 | 직접 구성 | KMS/SSL/IAM 통합 |
| 마이그레이션 | 도구 필요 | DMS/SCT/RDS Blue/Green 사용 가능 |

---

## 지원 엔진과 선택 가이드

| 엔진 | 장점 | 고려 사항 | 대표 용도 |
|---|---|---|---|
| **Aurora MySQL/PG** | 고성능 스토리지(6중 복제), 빠른 복구, 글로벌 DB, Serverless v2 | 엔진 특화 기능, 일부 호환성 차이 | 대규모 SaaS, 고가용·고성능 |
| **MySQL** | 생태계·도구 풍부, 학습곡선 낮음 | 대형 트래픽 확장성 한계 | 중소형 서비스, CMS |
| **PostgreSQL** | 표준 준수, 풍부한 타입/확장, GIS | 튜닝 항목 다양 | 분석+OLTP, GIS |
| **MariaDB** | MySQL 포크, 라이선스 부담 적음 | 엔터프라이즈 생태계 상대적 약세 | 경량 서비스 |
| **Oracle** | 고급 기능, 기업 표준 | 라이선스 비용 | 대기업 코어 시스템 |
| **SQL Server** | 윈도우/.NET 친화 | 라이선스 비용 | 기업 업무, BI 연계 |

> 고성능·가용성이 핵심이면 **Aurora** 우선 검토. 표준/호환성·도구 중심이면 **PostgreSQL/MySQL**.

---

## RDS 인스턴스 생성: 핵심 설정

### 네트워크

- **DB 서브넷 그룹**: 서로 다른 AZ의 프라이빗 서브넷 2개 이상 포함
- **퍼블릭 접근**: 일반적으로 **비활성** (Bastion/EC2/Proxy 통해 접근)
- **보안 그룹(SG)**: 애플리케이션 계층의 SG만 허용(포트 예: 3306, 5432)

### 스토리지

- **GP3**(권장 일반 SSD), **PIOPS(io1/io2)**(고IOPS), **Throughput 옵션**(엔진/세대별)
- 자동 스토리지 스케일링(엔진/옵션에 따라 가능)

### 파라미터/옵션 그룹

- **DB 파라미터 그룹**: 엔진 설정(버퍼, 워크메모리 등)
- **옵션 그룹**: Oracle/SQL Server 특정 기능(Transparent Data Encryption 등)

### 유지관리/백업

- **자동 백업 보존기간**(1~35일), **백업 윈도우**, **유지관리 윈도우**
- **성능 인사이트(PI)**, **Enhanced Monitoring** 활성화 권장

---

## 고가용성(HA)과 재해복구(DR)

### Multi-AZ (RDS 전통형)

- **동기식** 스토리지 복제(엔진/옵션별 차이)
- 장애 시 **자동 Failover** → 새로운 프라이머리 엔드포인트로 전환(엔드포인트 주소는 동일)

### Multi-AZ DB Cluster (세대 업그레이드 유형)

- 일부 엔진에서 **쓰기/읽기 인스턴스 구분된 클러스터형 Multi-AZ** 제공(짧은 RTO)

### Read Replica / Cross-Region

- **비동기** 복제, **읽기 부하 분산**·**보고서/배치 분리**
- Cross-Region Replica는 DR 및 글로벌 읽기용

### Aurora Global Database

- 리전 간 **1초 미만 복제 지연** 목표(네트워크 여건 의존)
- 리전 장애 시 **세컨더리 승격**으로 빠른 DR

**이중화 가용성 근사**
$$
A_{\text{dual}} = 1 - (1-A)(1-B)
$$
예) 두 AZ 가용성이 각각 \(99.9\%\) 라면 \(A_{\text{dual}} \approx 99.9999\%\).

---

## 백업·복구 전략

### 자동 백업과 PITR

- 보존 기간 내任의 시점으로 **Point-in-Time Recovery**
- 백업은 S3에 저장(관리형)

CLI 예시(PITR 신규 인스턴스 생성):
```bash
aws rds restore-db-instance-to-point-in-time \
  --source-db-instance-identifier prod-db \
  --target-db-instance-identifier prod-db-restore-2025-11-10 \
  --use-latest-restorable-time \
  --db-subnet-group-name app-db-subnets \
  --no-publicly-accessible
```

### 수동 스냅샷

- 장기보관/마이그레이션/테스트 복원에 유용
- **스냅샷 공유/카피** 로 계정/리전 간 이동

스냅샷 복제:
```bash
aws rds copy-db-snapshot \
  --source-db-snapshot-identifier arn:aws:rds:ap-northeast-2:123456789012:snapshot:prod-snap \
  --target-db-snapshot-identifier prod-snap-copy-to-tokyo \
  --kms-key-id arn:aws:kms:ap-northeast-1:123456789012:key/xxxx \
  --source-region ap-northeast-2 \
  --region ap-northeast-1
```

---

## 읽기 확장과 연결 최적화

### Read Replica

- MySQL/PostgreSQL/MariaDB/Aurora 지원
- 애플리케이션에서 **읽기 전용 커넥션을 Replica 엔드포인트**로 분기

### Aurora Reader

- `cluster-ro-xxxxxxxx.ap-northeast-2.rds.amazonaws.com` 엔드포인트로 **자동 로드밸런싱**

### RDS Proxy

- **커넥션 풀링**으로 Lambda/서버리스/대규모 단명 커넥션 환경의 DB 연결 안정화
- IAM 인증·시크릿 연동, 장애 시 Failover 완화

---

## 보안 설계

### 네트워크

- **프라이빗 서브넷** 배치(권장), 퍼블릭 접근 비활성
- SG는 앱 계층만 허용(포트 3306/5432/1521/1433 등)

### 암호화

- **저장 시**: KMS 기반 암호화(인스턴스/스냅샷/복제본)
- **전송 시**: SSL/TLS 강제(파라미터/드라이버 설정)

### 인증/권한

- **IAM DB 인증**(MySQL/PostgreSQL): 토큰 기반 일시적 패스워드
- **Secrets Manager**: 자격증명 저장·로테이션

IAM DB 인증 예(토큰 발급, MySQL):
```bash
aws rds generate-db-auth-token \
  --hostname mydb.cluster-xxxx.ap-northeast-2.rds.amazonaws.com \
  --port 3306 \
  --region ap-northeast-2 \
  --username appuser
```
발급된 토큰을 패스워드로 사용(만료 전 접속).

### 감사/로그

- **CloudTrail Data Events**(RDS API)
- 엔진 로그를 **CloudWatch Logs** 로 내보내기(에러/슬로우/일반)

---

## 성능 최적화

### 쿼리/스키마

- 적절한 **인덱스**, 실행계획 점검
- 정규화/비정규화 균형, 파티셔닝(엔진 지원 범위 확인)

### 스토리지/IO

- **GP3**: IOPS/처리량(Throughput) 독립 튜닝
- **io1/io2**: 초고IOPS 워크로드
- **Aurora**: 분산 스토리지 레이어, 페일오버/리커버리 유리

### 캐시/풀링

- **RDS Proxy** 또는 애플리케이션 풀링
- **ElastiCache(Redis/Memcached)** 로 핫키/세션 캐시

### 관측성

- **Performance Insights(PI)**: SQL Top, Wait 분석
- **Enhanced Monitoring**: OS 레벨 지표
- **CloudWatch**: CPU/Memory(엔진별), Freeable Memory, Read/Write IOPS

PI 활성화(CloudFormation 스니펫):
```yaml
PerformanceInsightsEnabled: true
PerformanceInsightsKMSKeyId: arn:aws:kms:ap-northeast-2:123456789012:key/xxxx
PerformanceInsightsRetentionPeriod: 7
```

---

## 비용과 사이징

### 단순 월 비용 근사

$$
C_{\text{월}} \approx C_{\text{인스턴스}} + C_{\text{스토리지}} + C_{\text{IO}} + C_{\text{백업}} + C_{\text{데이터전송}}
$$

- 인스턴스 시간(또는 Aurora ACU), 스토리지(GB-월), I/O 요청, 백업 초과분, 리전 간 전송

### 절감 전략

- **예약 인스턴스/세이빙플랜**
- **Aurora Serverless v2**(부하 가변)
- Replica 수 최적화, GP3 파라미터 조정, 백업 보존 정책

---

## IaC: CloudFormation / Terraform

### CloudFormation (MySQL, Multi-AZ, GP3)

{% raw %}
```yaml
AWSTemplateFormatVersion: '2010-09-09'
Resources:
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: app-db-subnets
      DBSubnetGroupDescription: subnets for rds
      SubnetIds: [subnet-aaaa, subnet-bbbb]

  MyDB:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: app-mysql
      Engine: mysql
      EngineVersion: '8.0'
      DBInstanceClass: db.t3.medium
      AllocatedStorage: 100
      StorageType: gp3
      MultiAZ: true
      MasterUsername: admin
      MasterUserPassword: '{{resolve:secretsmanager:prod/mysql#password}}'
      DBSubnetGroupName: !Ref DBSubnetGroup
      PubliclyAccessible: false
      DeletionProtection: true
      BackupRetentionPeriod: 7
      EnablePerformanceInsights: true
      StorageEncrypted: true
      KmsKeyId: arn:aws:kms:ap-northeast-2:123456789012:key/xxxx
      VPCSecurityGroups: [sg-xxxx]
```
{% endraw %}

### Terraform (PostgreSQL, Read Replica)

```hcl
resource "aws_db_subnet_group" "db" {
  name       = "app-db-subnets"
  subnet_ids = [var.subnet_a, var.subnet_b]
}

resource "aws_db_instance" "pg" {
  identifier              = "app-pg"
  engine                  = "postgres"
  engine_version          = "15"
  instance_class          = "db.t3.medium"
  allocated_storage       = 100
  storage_type            = "gp3"
  multi_az                = true
  username                = "admin"
  password                = var.pg_password
  db_subnet_group_name    = aws_db_subnet_group.db.name
  publicly_accessible     = false
  backup_retention_period = 7
  performance_insights_enabled = true
  storage_encrypted       = true
  kms_key_id              = var.kms_key
  vpc_security_group_ids  = [var.sg_id]
}

resource "aws_db_instance" "pg_replica" {
  identifier             = "app-pg-replica"
  engine                 = "postgres"
  instance_class         = "db.t3.medium"
  replicate_source_db    = aws_db_instance.pg.identifier
  publicly_accessible    = false
  db_subnet_group_name   = aws_db_subnet_group.db.name
  vpc_security_group_ids = [var.sg_id]
}
```

---

## 운영 스크립트와 접속 예시

### 엔드포인트 확인

```bash
aws rds describe-db-instances \
  --db-instance-identifier app-mysql \
  --query 'DBInstances[0].Endpoint.Address'
```

### SSL 접속(MySQL)

```bash
mysql --host=mydb.xxxxx.ap-northeast-2.rds.amazonaws.com \
      --port=3306 \
      --user=admin -p \
      --ssl-mode=REQUIRED
```

### psql 접속(PostgreSQL)

```bash
PGSSLMODE=require psql "host=mydb.xxxxx.ap-northeast-2.rds.amazonaws.com port=5432 user=admin dbname=appdb"
```

### 간단 보강 쿼리 예시

```sql
-- PostgreSQL: 느린 쿼리 로깅(파라미터 그룹에서 설정 필요)
SHOW log_min_duration_statement;
-- MySQL: 슬로우 쿼리 확인(엔진 설정/로그 내보내기)
```

---

## 실전 예시

### WordPress + RDS(MySQL)

1) RDS MySQL 생성(프라이빗, Multi-AZ, 백업 7일)
2) EC2에 WordPress 설치 → `wp-config.php` 에 RDS 엔드포인트/계정 적용
3) SG: EC2 SG → RDS SG 3306 허용
4) 트래픽 증가 시: Read Replica 또는 인스턴스 스케일 업

### Django/Node 연결

- Django `DATABASES`/Node `knex`/`sequelize`에서 RDS 엔드포인트 설정
- 읽기쿼리 분리는 Replica 엔드포인트로 별도 풀 구성
- 커넥션 풀 사이즈/타임아웃 조정, RDS Proxy 검토

---

## 마이그레이션 경로

- **DMS(Database Migration Service)**: 최소 다운타임 마이그레이션
- **SCT(Schema Conversion Tool)**: 이기종 간 스키마 변환
- **스냅샷 → 카피 → 복원** 또는 **로지컬/물리 백업** 복원
- **RDS Blue/Green Deployment**(지원 엔진): 안전한 메이저 업그레이드/변경

---

## 유지보수/알람

### 유지보수

- **Preferred Maintenance Window** 설정
- 자동 마이너 버전 업데이트 정책 검토(호환성 테스트)

### 알람 예시

```bash
# CPU 고사용

aws cloudwatch put-metric-alarm \
  --alarm-name RDS-High-CPU \
  --metric-name CPUUtilization \
  --namespace AWS/RDS \
  --statistics Average --period 60 \
  --threshold 80 --comparison-operator GreaterThanThreshold \
  --evaluation-periods 3 \
  --dimensions Name=DBInstanceIdentifier,Value=app-mysql \
  --alarm-actions arn:aws:sns:ap-northeast-2:123456789012:ops
```

---

## 트러블슈팅

| 증상 | 원인 | 해결 |
|---|---|---|
| 연결 불가 | SG/NACL/라우팅, 퍼블릭 접근 오인 | 프라이빗 서브넷/SG 관계 재점검, Bastion/Proxy 사용 |
| 인증 실패 | 비밀번호, IAM 토큰 만료, SSL 모드 | Secrets Manager, IAM 토큰 재발급, SSL 강제 |
| 느린 쿼리 | 인덱스 부재/통계 불량/파라미터 | 실행계획 점검, 인덱스/통계, 워크메모리 조정 |
| 스토리지 포화 | IOPS/Throughput 부족 | GP3 조정, io1/io2 전환, 쿼리/배치 재설계 |
| 잦은 Failover | 과도한 헬스체크 오류/패치 윈도우 | 이벤트 로그 확인, 윈도우 조정, 애플리케이션 재시도 로직 |

재시도 지수백오프 근사:
$$
E[T_{\text{retry}}] \approx \sum_{k=0}^{n-1} b \cdot 2^k
$$
\(b\): 기본 지연, \(n\): 최대 시도 횟수.

---

## 체크리스트

**보안**
- [ ] 프라이빗 서브넷 배치, 퍼블릭 접근 비활성
- [ ] SG 최소화(앱 SG만 허용), SSL/TLS 강제
- [ ] KMS 암호화, Secrets Manager 사용
- [ ] IAM DB 인증(가능 시) 및 역할 최소 권한

**가용성/DR**
- [ ] Multi-AZ 활성화
- [ ] Read Replica 또는 Cross-Region Replica 설계
- [ ] 백업 보존기간/복구 연습(PITR·스냅샷 복원)

**성능/비용**
- [ ] 인덱스/쿼리 점검, PI/EM/CloudWatch 활용
- [ ] GP3 IOPS/Throughput 조정, 캐시/RDS Proxy
- [ ] 예약/서버리스/규모 재평가

**운영**
- [ ] 유지관리/패치 윈도우 설정
- [ ] 알람/SNS 구독, 로그 내보내기
- [ ] Blue/Green 또는 롤링 업그레이드 플랜

---

## 결론

RDS는 **운영 자동화·가용성·보안**을 기본값으로 제공하여 애플리케이션 팀이 **데이터 모델·비즈니스 로직·성능 최적화**에 집중하게 한다.
엔진 선택과 토폴로지(Multi-AZ, Replica, Global/Aurora), 보안(프라이빗·KMS·SSL·IAM), 성능(인덱스·IOPS·Proxy), 비용(예약·서버리스)을 **체계적으로 조합**하면, 안정성과 효율을 동시에 확보할 수 있다.
실 서비스에서는 **복구 연습(PITR/스냅샷), Failover 테스트, 알람·로그 일상화**가 품질을 좌우한다.
