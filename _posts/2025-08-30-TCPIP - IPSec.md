---
layout: post
title: TCPIP - IPSec
date: 2025-08-30 15:25:23 +0900
category: TCPIP
---
# IP 보안 (IPSec) 프로토콜

IPSec(IP Security)은 IP 계층에서 종단 간(end-to-end) 보안을 제공하는 프로토콜 모음입니다. 응용 프로그램이나 전송 계층을 수정하지 않고도 네트워크 트래픽의 인증, 무결성, 기밀성을 보장합니다.

## IPSec 개요, 역사 및 표준

### IPSec의 등장 배경과 발전
1990년대 초 인터넷의 상업화가 본격화되면서 IP 프로토콜의 근본적인 보안 취약점이 부각되었습니다. 기본 IP는 출발지 주소 스푸핑, 패킷 스니핑, 데이터 변조 등 다양한 공격에 취약했습니다.

**역사적 발전:**
- **1995년**: IPSec 초기 RFC 문서군 발표 (RFC 1825-1829)
- **1998년**: 현재의 IPSec 아키텍처 표준화 (RFC 2401-2412)
- **2005년**: IPSec v3 업데이트 (RFC 4301-4309)
- **현재**: IPv6의 필수 구성 요소, VPN의 핵심 기술로 자리매김

**표준화 기구:**
- **IETF IPSec WG**: 핵심 프로토콜 표준화
- **ISO/IEC**: 국제 표준 채택

## IPSec 일반 동작, 구성 요소 및 프로토콜

### IPSec의 기본 목표와 기능
IPSec은 다음과 같은 세 가지 핵심 보안 서비스를 제공합니다:

1. **데이터 기밀성(Confidentiality)**: 암호화를 통한 도청 방지
2. **데이터 무결성(Integrity)**: 해시 함수를 통한 데이터 변조 탐지
3. **데이터 출발지 인증(Authentication)**: 송신자 신원 확인

### IPSec의 주요 구성 요소
```
┌─────────────────────────────────────────┐
│          IPSec 구성 요소 체계             │
├─────────────────────────────────────────┤
│ 1. 보안 프로토콜                         │
│    - AH(Authentication Header)          │
│    - ESP(Encapsulating Security Payload)│
├─────────────────────────────────────────┤
│ 2. 보안 연관(Security Association)       │
│    - SAD(Security Association Database) │
├─────────────────────────────────────────┤
│ 3. 키 관리 프로토콜                      │
│    - IKE(Internet Key Exchange)         │
│    - ISAKMP(Internet Security Assoc.    │
│      and Key Management Protocol)       │
├─────────────────────────────────────────┤
│ 4. 암호화 알고리즘                       │
│    - 암호화: AES, 3DES, DES             │
│    - 무결성: SHA-2, SHA-1, MD5          │
└─────────────────────────────────────────┘
```

## IPSec 아키텍처 및 구현 방법

### IPSec 구현 아키텍처

**호스트 기반 구현:**
- 운영 체제 커널 또는 스택에 통합
- 개별 호스트 간 종단 간 보안 제공
- 예: Windows의 Windows Filtering Platform, Linux의 NETKEY/XFRM

**게이트웨이 기반 구현:**
- 네트워크 경계 장치(라우터, 방화벽, VPN 게이트웨이)에 구현
- 사이트 간(Site-to-Site) VPN 구성
- 내부 네트워크 투명성 제공

**하이브리드 구현:**
- 모바일 사용자를 위한 원격 액세스 VPN
- 호스트와 게이트웨이의 조합

### IPSec 구현 방법별 비교
```
방법           장점                         단점
호스트 구현    • 종단 간 보안                • 모든 호스트에 구성 필요
              • 세밀한 접근 제어            • 관리 오버헤드 큼

게이트웨이 구현• 중앙 집중식 관리            • 내부 트래픽 보호 안 됨
              • 네트워크 투명성             • 게이트웨이 병목 가능성

하이브리드     • 모바일 사용자 지원          • 구성 복잡성
              • 유연한 배포                 • 클라이언트 소프트웨어 필요
```

## IPSec 모드: 전송 모드와 터널 모드

IPSec은 두 가지 동작 모드를 제공하며, 각 모드는 특정 사용 사례에 최적화되어 있습니다.

### 전송 모드 (Transport Mode)
**설명**: 원본 IP 패킷의 페이로드(데이터)만 보호
**구조**:
```
[원본 IP 헤더] [IPSec 헤더(AH/ESP)] [전송 계층 세그먼트(TCP/UDP)] [ESP 트레일러]
```
**특징**:
- 종단 호스트 간 직접 통신에 사용
- IP 헤더는 보호되지 않음
- 주로 호스트 간 통신에 적합
- 오버헤드가 적음

**사용 사례**:
- 서버 간 보안 통신
- 클라이언트-서버 응용 프로그램
- IPv6의 필수 구성 요소

### 터널 모드 (Tunnel Mode)
**설명**: 전체 원본 IP 패킷을 보호하여 새로운 IP 헤더로 캡슐화
**구조**:
```
[새 IP 헤더] [IPSec 헤더(AH/ESP)] [원본 IP 패킷 전체] [ESP 트레일러]
```
**특징**:
- 네트워크 간 통신(게이트웨이 간)에 사용
- 전체 패킷 보호로 트래픽 분석 방지
- 원본 IP 주소 숨김
- VPN 구현에 적합

**사용 사례**:
- 사이트 간 VPN
- 원격 액세스 VPN
- 안전하지 않은 네트워크 통과 시

### 모드 선택 기준
```
요구사항                    권장 모드
종단 간 보안                전송 모드
네트워크 투명성 필요        터널 모드
NAT 환경                   터널 모드 (일반적으로)
성능 우선                  전송 모드
주소 숨기기 필요           터널 모드
```

## IPSec 보안 연관 및 정책 관리

### 보안 연관 (Security Association, SA)
SA는 두 개체 간의 보안 통신을 정의하는 단방향 논리적 연결입니다. 각 SA는 다음과 같은 매개변수 집합으로 정의됩니다:

**SA의 구성 요소:**
1. **보안 매개변수 인덱스(SPI)**: 32비트 식별자, 수신자가 SA 식별
2. **IP 목적지 주소**: SA의 수신자 주소
3. **보안 프로토콜 식별자**: AH 또는 ESP

**SA의 특성:**
- 단방향성: 각 방향마다 별도 SA 필요
- 프로토콜별: AH와 ESP는 별도 SA
- 모드별: 전송/터널 모드 별도 SA

### 보안 연관 데이터베이스 (SAD)
각 IPSec 구현은 활성 SA를 추적하는 SAD를 유지합니다.

**SAD 항목 내용:**
- 시퀀스 번호 카운터
- 시퀀스 번호 오버플로우 플래그
- 안티 재생 공격(Anti-Replay) 창
- AH/ESP 암호화/인증 알고리즘 및 키
- SA 수명
- IPSec 프로토콜 모드
- 경로 MTU 정보

### 보안 정책 데이터베이스 (SPD)
SPD는 트래픽에 적용할 보안 정책을 정의합니다. 모든 입출력 IP 트래픽은 SPD 쿼리를 거쳐야 합니다.

**SPD 정책 결정:**
1. **BYPASS**: IPSec 처리 없이 패킷 전달
2. **DISCARD**: 패킷 폐기
3. **PROTECT**: IPSec 적용 (적용할 SA 지정)

**셀렉터(Selectors)**: SPD 결정을 위한 패킷 특성
- 원본/목적지 IP 주소
- 전송 계층 프로토콜
- 원본/목적지 포트
- 사용자 ID (선택적)

### SA와 SPD의 상호작용
```
패킷 수신 → SPD 조회 → 정책 결정
                    ↓
              PROTECT인 경우 → SAD에서 해당 SA 조회
                    ↓
              SA 있음 → IPSec 처리
                    ↓
              SA 없음 → IKE를 통한 SA 협상
```

## IPSec 인증 헤더 (AH)

### AH의 목적과 기능
AH는 데이터 무결성과 인증을 제공하지만 기밀성은 제공하지 않습니다.

**제공 기능:**
- 데이터 무결성 보장
- 데이터 출발지 인증
- 선택적 재전송 공격 방지

**제공하지 않는 기능:**
- 데이터 암호화 (기밀성)
- 트래픽 흐름 기밀성

### AH 패킷 형식
```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| 다음 헤더      | 페이로드 길이   | 예약됨                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                 보안 매개변수 인덱스 (SPI)                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                 시퀀스 번호 필드                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                 인증 데이터 (가변 길이)                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

**필드 설명:**
- **다음 헤드(Next Header)**: AH 다음의 프로토콜 식별
- **페이로드 길이(Payload Length)**: AH 헤더 길이 (32비트 워드 단위)
- **SPI**: SA 식별자
- **시퀀스 번호**: 재전송 공격 방지
- **인증 데이터**: ICV(Integrity Check Value)

### AH의 인증 범위
**전송 모드**: 원본 IP 헤더의 불변 필드 + AH + 상위 계층 데이터
**터널 모드**: 외부 IP 헤더의 불변 필드 + AH + 내부 전체 IP 패킷

**주의사항**: NAT 환경에서 문제 발생 (IP 주소 변경으로 인증 실패)

## IPSec 캡슐화 보안 페이로드 (ESP)

### ESP의 목적과 기능
ESP는 AH의 모든 기능에 더해 데이터 기밀성을 추가로 제공합니다.

**제공 기능:**
- 데이터 기밀성 (암호화)
- 데이터 무결성 (선택적)
- 데이터 출발지 인증 (선택적)
- 재전송 공격 방지

### ESP 패킷 형식
```
┌─────────────────────────────────────────┐
│ ESP 헤더                                │
│  - SPI (4바이트)                       │
│  - 시퀀스 번호 (4바이트)                │
├─────────────────────────────────────────┤
│ 페이로드 데이터 (가변 길이)             │
│  - 암호화됨                            │
├─────────────────────────────────────────┤
│ 패딩 (0-255바이트)                     │
│  - 블록 암호 정렬용                    │
├─────────────────────────────────────────┤
│ 패딩 길이 | 다음 헤더 (각 1바이트)      │
├─────────────────────────────────────────┤
│ 인증 데이터 (가변 길이, 선택적)         │
│  - 무결성 검증값(ICV)                  │
└─────────────────────────────────────────┘
```

### ESP의 암호화와 인증
**암호화 범위**: 페이로드 데이터 + 패딩 + 패딩 길이 + 다음 헤더
**인증 범위**: ESP 헤더 + 암호화된 데이터 + ESP 트레일러(인증 데이터 제외)

### AH vs ESP 비교
```
기능                    AH          ESP
인증                    필수        선택적
무결성                  필수        선택적
암호화                  없음        필수
재전송 공격 방지        있음        있음
NAT 통과                문제        ESP-NAT-T 가능
성능 오버헤드           낮음        높음
```

## IPSec 키 교환 (IKE)

### IKE의 필요성
IPSec은 안전한 키 교환 메커니즘이 필요합니다:
- 대칭 키 암호화를 위한 세션 키 생성
- 피어 간 상호 인증
- SA 매개변수 협상

### IKE 버전
**IKEv1 (RFC 2409)**:
- 2단계 협상: 메인 모드/공격 모드 + 퀵 모드
- 복잡한 구현
- 점차 폐기되는 중

**IKEv2 (RFC 7296)**:
- 단순화된 4메시지 교환
- 향상된 보안성
- 모바일성 지원
- 현재 표준

### IKEv2 동작 과정
```
초기 교환 (IKE_SA_INIT):
  요청자                    응답자
     | --- HDR, SAi1, KEi, Ni ---> |
     | <-- HDR, SAr1, KEr, Nr ---  |
     |                             |
인증 교환 (IKE_AUTH):
     | --- HDR, SK{IDi, AUTH} ---> |
     | <-- HDR, SK{IDr, AUTH} ---  |
```
**단계별 설명:**
1. **IKE_SA_INIT**: 암호화 알고리즘 협상, 디피-헬만 키 교환
2. **IKE_AUTH**: 상호 인증, 첫 번째 CHILD_SA 생성

### IKE 인증 방법
1. **PSK(Pre-Shared Key)**: 사전 공유 비밀키
2. **디지털 서명**: RSA 또는 ECDSA
3. **공개 키 암호화**: RSA 암호화

---

## 결론

IPSec은 네트워크 계층에서의 종합적 보안 솔루션으로, 응용 프로그램 수정 없이도 통신의 기밀성, 무결성, 인증을 보장합니다. 그 모듈식 설계(AH, ESP, IKE)와 다양한 동작 모드(전송/터널)는 광범위한 네트워크 시나리오에 유연하게 적용할 수 있게 합니다.

IPSec의 가장 큰 강점은 **네트워크 투명성**에 있습니다. 기존 응용 프로그램과 네트워크 인프라를 변경하지 않고도 종단 간 보안을 구현할 수 있으며, 이는 기업 VPN, 원격 액세스, 사이트 간 보안 연결 등 다양한 환경에서 널리 채택되는 이유가 되었습니다. 특히 IPv6에서는 필수 구성 요소로 지정되어, 차세대 인터넷의 기본 보안 체계를 형성하고 있습니다.

그러나 IPSec도 도전 과제가 없지는 않습니다. NAT 환경에서의 호환성 문제, 복잡한 구성과 관리 오버헤드, 성능에 미치는 영향 등은 실제 배포 시 고려해야 할 요소들입니다. IKEv2의 등장은 이러한 문제들을 상당 부분 해결했으며, 특히 모바일 환경에서의 향상된 지원은 5G와 IoT 시대에 더욱 중요해지고 있습니다.

현대 네트워크 보안에서 IPSec의 역할은 계속 진화하고 있습니다. 클라우드 컴퓨팅, 소프트웨어 정의 경계(SDP), 제로 트러스트 네트워크 등 새로운 아키텍처와 통합되면서, IPSec은 물리적 경계가 희미해지는 디지털 세계에서 여전히 핵심적인 보안 메커니즘으로 자리매김하고 있습니다. 네트워크 엔지니어는 IPSec의 원리를 깊이 이해함으로써, 복잡한 보안 요구사항을 충족시키는 견고한 네트워크 인프라를 설계하고 운영할 수 있습니다.