---
layout: post
title: 정보보안기사 - DHCP
date: 2025-11-12 19:25:23 +0900
category: 정보보안기사
---
# SECTION 07 애플리케이션 기본 학습 — 05. DHCP(Dynamic Host Configuration Protocol) 완전 정리 (DORA/SARR·필드/옵션·DHCPv6·릴레이/옵션82·PXE/VoIP·보안(DHCP Snooping/DAI/ISG)·HA/Failover·Windows/리눅스/Kea/dnsmasq·모니터링/트러블슈팅·실습·체크리스트)

## 개요 — “주소 자동화 + 정책 배포의 표준”
DHCP는 단말(클라이언트)에 **IP·서브넷·게이트웨이·DNS·도메인·라우트** 등 네트워크 파라미터를 **자동** 배포한다.
핵심 포인트만 먼저 잡자.

- **전송**: UDP/67(서버), UDP/68(클라이언트) — v6는 UDP/546(클), 547(서버)
- **흐름(v4)**: **DORA** = Discover → Offer → Request → Acknowledgement
- **흐름(v6)**: **SARR** = Solicit → Advertise → Request → Reply (+ Confirm/Renew/Rebind/Release)
- **릴레이**: L3 경계에서 브로드캐스트를 **유니캐스트로 릴레이**(IPv4 `giaddr`, 옵션82; IPv6 릴레이 헤더)
- **옵션**: v4(3/6/15/51/53/54/121/150/66/67/82…) · v6(Option 23 DNS, 24 Domain Search, IA_NA/IA_PD…)
- **보안**: **DHCP Snooping, Dynamic ARP Inspection, IP Source Guard, 802.1X**, **rogue DHCP** 차단
- **운영**: **스코프 설계, 리스 시간, 예약/정책**, **HA(Windows/Kea/ISC Failover)**, **PXE/VoIP 특화 옵션**, **로그/모니터링**

---

## 1. 동작 모델 (DHCPv4: DORA) — 패킷 흐름과 상태

### 1.1 DORA 시퀀스(IPv4)
```
클라이언트(0.0.0.0:68, 브로드캐스트)        서버(UDP/67)
-----------------------------------------------------------------
1) DISCOVER   --------------------------->  (옵션55: 요청파라미터, 옵션61: Client-ID)
2)             <---------------------------  OFFER (yiaddr=할당제안)
3) REQUEST    --------------------------->  (서버선택/요청주소)
4)             <---------------------------  ACK (옵션:게이트웨이/DNS/라우트/리스)
```

- **Renew**: T1(보통 리스의 50%) 시점에 **유니캐스트 REQUEST** → **ACK**
- **Rebind**: T2(보통 리스의 87.5%) 이후 **브로드캐스트 REQUEST** → **ACK/NAK**
- **Release**: 클라이언트가 반환(선택적)
- **NAK**: 요청주소가 스코프 불일치/충돌/만료 등일 때

> 전형적인 기본값:
> $$ T_1 \approx 0.5 \cdot \text{lease}, \qquad T_2 \approx 0.875 \cdot \text{lease} $$

### 1.2 프레임/필드(요지)
- **L2**: 브로드캐스트(초기) — `ff:ff:ff:ff:ff:ff`
- **L3**: 소스 0.0.0.0 → 목적 255.255.255.255 (DISCOVER/REQUEST 초기)
- **L4**: UDP/68 → UDP/67
- **BOOTP 헤더 주요 필드**:
  - `op`(1=요청, 2=응답), `xid`(트랜잭션 ID), `flags`(Broadcast bit),
  - `ciaddr`(현재 IP), `yiaddr`(서버가 제안/승인한 IP), `siaddr`(TFTP/서버), `giaddr`(릴레이 IP),
  - `chaddr`(클라이언트 MAC), `options`(53 메시지 타입, 50 요청IP, 54 서버ID, 51 리스 등)

---

## 2. 메시지/옵션(DHCPv4)

### 2.1 메시지 타입(Option 53)
- 1 Discover, 2 Offer, 3 Request, 4 Decline, 5 Ack, 6 Nak, 7 Release, 8 Inform

### 2.2 자주 쓰는 옵션 표
| 코드 | 이름 | 의미/예 |
|---|---|---|
| **1** | Subnet Mask | `255.255.255.0` |
| **3** | Router (Default GW) | `192.0.2.1` |
| **6** | DNS Servers | `203.0.113.10, 203.0.113.11` |
| **15** | Domain Name | `corp.example.local` |
| **28** | Broadcast Address | `192.0.2.255` |
| **42** | NTP Servers | `192.0.2.20` |
| **51** | IP Address Lease Time | 초 단위 |
| **54** | Server Identifier | 서버의 IP |
| **55** | Parameter Request List | 클라가 받고 싶은 옵션 리스트 |
| **60** | Vendor Class Identifier | `MSFT 5.0`, `PXEClient` |
| **61** | Client Identifier | 일반적으로 MAC 또는 고유 값 |
| **66** | TFTP Server Name | PXE/VoIP 등 |
| **67** | Bootfile Name | PXE 부팅 파일 |
| **121** | **Classless Static Route** | 0.0.0.0/0 → GW 등(현대 권장) |
| **150** | TFTP Servers (Cisco) | IP 리스트 |
| **77** | User Class | 정책 분기 |

> **라우트 배포**는 **121(클래스리스 정적 라우트)** 권장. 옵션 33(Static Route)은 구식.

---

## 3. DHCPv6 — SLAAC와의 관계, SARR, DUID/IAID

### 3.1 주소부여 방식
- **SLAAC**: RA에서 프리픽스 광고, 단말이 **자율** 구성(+ RDNSS/Route 정보 확장 가능)
- **DHCPv6(상태ful)**: 서버가 주소/옵션을 **명시** 배포(IA_NA)
- **혼합**: RA의 **M(Managed) 플래그**(주소 DHCPv6), **O 플래그**(옵션만 DHCPv6)

### 3.2 메시지(SARR + 기타)
- Solicit → Advertise → Request → Reply
- Confirm(다른 링크 이동 검증), Renew/Rebind, Release, Decline
- Reconfigure(서버→클라 설정 재요청), Relay-Forward/Reply(중간자)

### 3.3 식별자
- **DUID**(서버/클라 식별자): DUID-LLT/LL/EN 등
- **IAID**: 인터페이스별 식별자
- **IA_NA**: Non-temporary Address, **IA_PD**: Prefix Delegation(라우터에 프리픽스 위임)

### 3.4 v6 주요 옵션
| 번호 | 이름 | 예 |
|---|---|---|
| 23 | DNS Recursive Name Server (RDNSS) | `2001:db8::53` |
| 24 | Domain Search List | `corp.example.local` |
| IA_NA/IA_PD | 주소/프리픽스 | `2001:db8:10::/56` 위임 |
| Client/Server FQDN | FQDN 업데이트 | `host.example.local` |

---

## 4. 릴레이 — L3 경계에서의 핵심

### 4.1 IPv4 릴레이(giaddr/옵션82)
```
Client --(브로드캐스트)--> Relay(L3 SVI/VLAN GW) --(유니캐스트)--> DHCP Server
        <-------------------------------------------------------------  (Reply)
```
- **giaddr**: 릴레이가 **서브넷을 표시**(서버가 어떤 스코프를 쓸지 결정)
- **옵션 82(릴레이 정보)**: Circuit-ID/Remote-ID 삽입 → 서버에서 **정책/스코프 분기** 가능
- **보안**: 스위치에서 **옵션82 강제/검증**, **DHCP Snooping** 연계

### 4.2 IPv6 릴레이
- **Relay-Forward/Relay-Reply** 캡슐화, **옵션 18 Interface-ID** 등으로 경로/포트 인지

---

## 5. 서버 구현과 설정

### 5.1 ISC DHCP (dhcpd) — IPv4 스코프/예약/옵션
```conf
# /etc/dhcp/dhcpd.conf
default-lease-time  3600;     # 1시간
max-lease-time      7200;     # 2시간
authoritative;

# 공통 옵션
option domain-name "corp.example.local";
option domain-name-servers 203.0.113.10, 203.0.113.11;

# VLAN10 스코프
subnet 192.0.2.0 netmask 255.255.255.0 {
  option routers 192.0.2.1;
  option broadcast-address 192.0.2.255;
  option ntp-servers 192.0.2.20;

  # Classless Static Route (옵션121): 10.10.0.0/16 -> 192.0.2.254
  option classless-static-routes 16, 10,10, 192,0,2,254;

  range 192.0.2.100 192.0.2.199;

  # 예약(고정 할당)
  host printer-hr {
    hardware ethernet 00:11:22:33:44:55;
    fixed-address 192.0.2.50;
    option host-name "printer-hr";
  }
}
```
서비스:
```bash
systemctl enable --now isc-dhcp-server
journalctl -u isc-dhcp-server -f
```

### 5.2 ISC DHCPv6 (간단 예)
```conf
# /etc/dhcp/dhcpd6.conf
default-lease-time 3600;
preferred-lifetime 1800;

subnet6 2001:db8:10::/64 {
  range6 2001:db8:10::1000 2001:db8:10::1fff;
  option dhcp6.name-servers 2001:db8::53;
  option dhcp6.domain-search "corp.example.local";
}
```

### 5.3 ISC DHCP Failover (v4)
```conf
# 서버A
failover peer "dhcp-failover" {
  primary;
  address 198.51.100.10;
  port 647;
  peer address 198.51.100.11;
  peer port 647;
  max-response-delay 60;
  mclt 3600;            # 최대 클라이언트 리스 시간 차
  split 128;            # 로드밸런스
}
subnet 192.0.2.0 netmask 255.255.255.0 {
  pool {
    failover peer "dhcp-failover";
    range 192.0.2.100 192.0.2.199;
  }
}
```
> 서버B는 `secondary;` 로 정의.

### 5.4 Kea DHCP (JSON, HA + 옵션82 정책)
```json
{
  "Dhcp4": {
    "interfaces-config": { "interfaces": [ "eth0" ] },
    "valid-lifetime": 3600,
    "renew-timer": 1800,
    "rebind-timer": 3150,
    "option-data": [
      { "name": "domain-name", "data": "corp.example.local" },
      { "name": "domain-name-servers", "data": "203.0.113.10, 203.0.113.11" }
    ],
    "subnet4": [{
      "subnet": "192.0.2.0/24",
      "pools": [{ "pool": "192.0.2.100-192.0.2.199" }],
      "option-data": [
        { "name": "routers", "data": "192.0.2.1" },
        { "name": "classless-static-routes", "data": "10.10.0.0/16,192.0.2.254" }
      ]
    }],
    "client-classes": [{
      "name": "from-vlan20",
      "test": "substring(relay4[0].circuit-id,0,4) == 'vlan20'",
      "option-data": [{ "name": "routers", "data": "192.0.2.65" }]
    }],
    "high-availability": {
      "this-server-name": "kea-a",
      "modes": [ "load-balancing" ],
      "peers": [{
        "name": "kea-b",
        "url": "http://198.51.100.11:8000/",
        "role": "partner"
      }]
    }
  }
}
```

### 5.5 dnsmasq (경량 DHCP/DNS, PXE에 유용)
```conf
# /etc/dnsmasq.d/dhcp.conf
interface=eth0
dhcp-range=192.0.2.100,192.0.2.199,12h
dhcp-option=option:router,192.0.2.1
dhcp-option=option:dns-server,203.0.113.10,203.0.113.11
# PXE
dhcp-boot=pxelinux.0,pxeserver,192.0.2.10
enable-tftp
tftp-root=/var/lib/tftpboot
```

### 5.6 Windows Server DHCP (요약)
- **스코프**: Address Pool(범위/제외), 옵션(서버/스코프/예약별)
- **정책**: MAC/OUI, Vendor/User Class 기반 옵션 분기
- **Failover**: **Load Balance** 또는 **Hot Standby**(Stateful 동기화)
- **PowerShell 예**:
```powershell
# 스코프 생성
Add-DhcpServerv4Scope -Name "VLAN10" -StartRange 192.0.2.100 -EndRange 192.0.2.199 -SubnetMask 255.255.255.0
Set-DhcpServerv4OptionValue -ScopeId 192.0.2.0 -Router 192.0.2.1 -DnsServer 203.0.113.10,203.0.113.11 -DnsDomain corp.example.local
# 예약
Add-DhcpServerv4Reservation -ScopeId 192.0.2.0 -IPAddress 192.0.2.50 -ClientId 00-11-22-33-44-55 -Description "HR Printer"
# Failover (상대 서버 198.51.100.11)
Add-DhcpServerv4Failover -Name "VLAN10-FO" -ScopeId 192.0.2.0 -PartnerServer 198.51.100.11 -LoadBalancePercent 50
```

### 5.7 라우터 내장 DHCP (Cisco IOS)
```cisco
ip dhcp excluded-address 192.0.2.1 192.0.2.99
ip dhcp pool VLAN10
  network 192.0.2.0 255.255.255.0
  default-router 192.0.2.1
  dns-server 203.0.113.10 203.0.113.11
  domain-name corp.example.local
!
# 릴레이 (SVI에 helper)
interface Vlan20
  ip address 192.0.2.65 255.255.255.192
  ip helper-address 198.51.100.10
```

---

## 6. PXE/VoIP/IoT — 특화 옵션과 주의

### 6.1 PXE(네트워크 부팅)
- **옵션66/67** 또는 **옵션43 + Vendor Class = PXEClient**
- **dnsmasq**/Kea에서 TFTP 경로/부트파일 지정
- **UEFI vs BIOS**: 부트파일/아키텍처 분기 필요

### 6.2 VoIP(IP Phone)
- **옵션150**(Cisco) 또는 **옵션66**(TFTP), **옵션176/242**(Avaya 등 벤더별)
- **LLDP-MED**와 병행하는 경우, 스위치 포트 음성 VLAN과 DHCP 스코프 분리

### 6.3 IoT/프린터
- 예약(IP/이름), 짧은 리스(빈번 교체), **옵션43**(벤더 구성) 문서 필수 확인

---

## 7. 보안 — Rogue DHCP·Starvation·스푸핑 방지

### 7.1 위협
- **Rogue DHCP**: 공격자가 가짜 서버로 **게이트웨이/DNS**를 조작(중간자/검열)
- **DHCP Starvation**: 다량 가짜 MAC로 풀 고갈 → 서비스 거부
- **옵션82 위조/우회**: 정책 분기 무력화
- **DHCPv6 RA 혼선**: RA 기반 SLAAC로 비정상 라우트 주입

### 7.2 스위치/네트워크 차단책(대표 Cisco-style)
```cisco
! DHCP Snooping (신뢰 포트만 서버/릴레이)
ip dhcp snooping
ip dhcp snooping vlan 10,20,30
interface Gig1/0/1
  ip dhcp snooping trust      ! 서버/릴레이/업링크에만
!
! DHCP Option 82 삽입/검증(기본 On인 플랫폼도 많음)
ip dhcp snooping information option
!
! Starvation-DoS 및 스푸핑 3종 세트
ip arp inspection vlan 10,20,30       ! DAI: ARP 스푸핑 방지
ip verify source vlan dhcp-snooping    ! IP Source Guard
switchport port-security               ! MAC 폭주 제어
```
- **Windows/Mac/Linux 서버 포트는 기본 untrusted** → DHCP 서버라면 해당 포트만 trust
- **802.1X**로 단말 인증 + **프리-접속 VLAN**, **게스트 VLAN** 활용

### 7.3 서버 측
- **인증된 릴레이만 허용**(방화벽/ACL), **옵션82 정책 매칭**
- **리스 할당 한도/속도 제한**, **로그/알림**
- **DNS/DHCP 통합(IPAM)**에서 **무결성 검사/중복 탐지**

---

## 8. HA/스케일링/클라우드

- **Windows DHCP Failover**: Load-balance/Hot-standby, 상태 동기화
- **ISC/Kea Failover**: **MCLT**, 리스 공유, **Kea Control Agent(REST)** 로 상태 조회
- **Anycast/VRRP**: DHCP 서버의 **서버 식별자(옵션54)** 충돌 주의(Anycast는 권장 X)
- **클라우드**:
  - AWS VPC/Azure VNet/GCP VPC는 **관리형 DHCP**(옵션셋만 구성)
  - BYO DHCP는 **IP 중복/라우팅 비권장**, VPC 경계 내 릴레이 제약 확인

---

## 9. IP 계획·리스 시간·풀 설계 (간단 수식)

### 9.1 주소 용량
서브넷 프리픽스 \(p\) 의 v4 주소 수:
$$ N = 2^{(32-p)} $$
ex) `/24` → \( N=256 \). **네트워크/브로드캐스트** 2개 제외 → **254** 사용
**예약/제외/고정**을 빼면 **DHCP 가용 풀**:
$$ N_{\text{pool}} = N - 2 - N_{\text{excluded}} - N_{\text{reserved}} $$

### 9.2 리스 시간 직관
- 사용자 이동/변동 많음 → 짧은 리스(1~4h)
- 서버/프린터/고정장비 → 예약/긴 리스(일/주)
- **갱신 트래픽**은 대략 풀 규모에 비례 → 너무 짧으면 **서버 부하↑**

---

## 10. 모니터링/로그/패킷

### 10.1 리눅스(ISC/Kea)
- **ISC**: `/var/log/syslog` 또는 `/var/log/dhcpd.log`
- **Kea**: `/var/log/kea-dhcp4.log`, Control Agent의 `/statistics` 엔드포인트(JSON)
```bash
# Kea 통계 예(HTTP)
curl -s http://127.0.0.1:8000/ | jq .
```

### 10.2 Windows
- DHCP 서버 이벤트 로그, **감사**(Audit), **Address Pool Usage** 대시보드
- `Get-DhcpServerv4Statistics`, `Get-DhcpServerv4Lease`

### 10.3 패킷 캡처(와이어샤크/tshark)
- **필터**: `bootp`(v4), `dhcpv6`(v6)
- 주요 필드: `dhcp.option.dhcp`, `dhcp.option.router`, `dhcpv6.msgtype`
```bash
# 특정 MAC에서의 DHCPv4 교환
tshark -i eth0 -f "udp port 67 or 68" -Y "bootp.chaddr==00:11:22:33:44:55"
```

---

## 11. 트러블슈팅 체크(현장용)

1) **L2/VLAN**: 단말 VLAN ↔ 릴레이 SVI ↔ 서버 경로 OK?
2) **릴레이**: `ip helper-address`(Cisco)/`dhcrelay`(리눅스) 설정, 방화벽 UDP/67/68 허용
3) **스코프 범위/제외/예약** 중복/오탈자 없음
4) **옵션54(Server-ID)**가 멀티 서버 충돌 없이 일관?
5) **옵션82** 삽입/검증, 서버 정책 매칭
6) **리스 풀 고갈**(Starvation/실수로 너무 짧은 리스)
7) **클라이언트**: `ipconfig /renew`, `dhclient -r/-v`, NetworkManager 상태
8) **v6**: RA의 **M/O 플래그** 기대대로? RDNSS 제공 경로 중복?
9) **PXE**: 아키텍처/UEFI 매칭(옵션43/66/67), TFTP 접근
10) **보안 기능**: Snooping/DAI/ISG로 합법 서버 트래픽 차단하지 않았는지

---

## 12. 실습 시나리오 (따라 하기)

### A. “하나의 DHCP, 여러 VLAN → 릴레이”
1. L3 스위치 SVI에 `ip helper-address <DHCP>` 설정
2. 서버에 VLAN별 **서브넷/옵션** 정의
3. **옵션82** 삽입 후 Kea에서 **client-classes**로 VLAN별 게이트웨이 분기

### B. “Windows DHCP Failover — Load Balance”
1. 두 서버에 DHCP 역할 설치, 동일 스코프 생성
2. `Add-DhcpServerv4Failover -Name lb -PartnerServer B -LoadBalancePercent 50`
3. 한 서버 다운 시 클라이언트 갱신/신규 할당 지속 확인

### C. “PXE 부팅(dnsmasq)”
1. `enable-tftp`, `tftp-root` 설정
2. `dhcp-boot=ipxe.efi,pxeserver,192.0.2.10`
3. VM/서버를 **PXE 우선** 부팅 → 파일 내려오는지 확인

### D. “DHCP Snooping/DAI”
1. 접근 스위치에서 VLAN에 Snooping/DAI 활성
2. **서버 포트만 trust** 설정
3. Rogue DHCP(노트북에서 ICS 켜기)를 차단되는지 실험

---

## 13. 예제 코드/툴 — 클라이언트 관점

### 13.1 리눅스 `dhclient` (v4)
```bash
# 즉시 재요청
sudo dhclient -r eth0 && sudo dhclient -v eth0
# 특정 옵션 요청(예: 도메인 검색)
echo 'request subnet-mask, routers, domain-name, domain-search, domain-name-servers;' | sudo tee /etc/dhcp/dhclient.conf
```

### 13.2 NetworkManager (nmcli)
```bash
nmcli con mod "Wired connection 1" ipv4.method auto
nmcli con up "Wired connection 1"
```

### 13.3 Python(Scapy) — **테스트용 랩에서만!**
```python
# pip install scapy
from scapy.all import *
discover = (Ether(dst="ff:ff:ff:ff:ff:ff")/
            IP(src="0.0.0.0",dst="255.255.255.255")/
            UDP(sport=68,dport=67)/
            BOOTP(chaddr=RandMAC().replace(':','').decode())/
            DHCP(options=[("message-type","discover"),"end"]))
sendp(discover, iface="eth0", verbose=0)
```
> 실제 운영망에서 무단 사용 금지(Starvation 유발 위험). **격리된 랩**에서만.

---

## 14. 운영 체크리스트

- [ ] **스코프 설계**: 여유 20~30%, **예외/예약/정책 문서화**
- [ ] **리스 시간**: 사용자/서버/IoT 용도별 차등
- [ ] **릴레이**: 모든 SVI/VRF에 helper 설정 + 서버 측 서브넷 등록
- [ ] **옵션121**로 라우트 배포, **DNS/NTP/도메인** 일관
- [ ] **보안**: DHCP Snooping + DAI + IP Source Guard + 802.1X
- [ ] **Rogue 감시**: 스위치 로그/SIEM 룰, 알람
- [ ] **HA**: Windows Failover 또는 Kea/ISC Failover, 정기 DR 테스트
- [ ] **PXE/VoIP**: 벤더별 옵션 검증/문서화
- [ ] **모니터링**: 풀 사용률, NAK/Decline, 중복/충돌, 재시도율
- [ ] **백업/형상관리**: `dhcpd.conf`/Kea JSON/Windows 백업 & 변경관리

---

## 15. 자주 하는 실수 & 빠른 해법

| 증상 | 원인 | 해결 |
|---|---|---|
| DISCOVER만 보이고 OFFER 없음 | 릴레이 미설정/방화벽 차단 | `ip helper-address`, UDP/67/68 허용 |
| REQUEST 후 NAK 반복 | 스코프 불일치/중복 | 스코프/예약/제외 재검토, 충돌 탐지 |
| PXE 부팅 실패 | 옵션67/66/아키텍처 불일치 | iPXE/UEFI 파일/경로 재확인 |
| v6 주소 안옴 | RA M/O 플래그/릴레이 누락 | RA 설정 수정, DHCPv6 릴레이 추가 |
| 주소 고갈 | Starvation/짧은 리스 | Snooping/리스 조정/풀 확장 |

---

## 16. 미니 계산 문제(실기 감각)

1) **/23**(두 개 /24 연속)에서 예약 20개, 제외 30개. DHCP 가용 수?
   \[
   N = 2^{(32-23)} = 512,\quad \text{사용가능} = 512 - 2 - 20 - 30 = 460
   \]

2) 리스 8시간. T1, T2는?
   \[
   T_1 = 0.5 \cdot 8h = 4h,\quad T_2 = 0.875 \cdot 8h = 7h
   \]

3) 1Gbps 링크, 30초 동안 `ΔOctets = 75,000,000`. 평균 사용률?
   \[
   \text{bps} = \frac{8 \cdot 75{,}000{,}000}{30} = 20\,\text{Mbps},\quad
   \text{Util} = \frac{20}{1000} \times 100 = 2\%
   \]

---

## 17. 결론 요약
- **DHCP는 주소·정책의 자동화 핵심**: v4 **DORA**, v6 **SARR**.
- 실전의 관건은 **릴레이/옵션 설계**, **보안(DHCP Snooping/DAI/ISG/802.1X)**, **HA/Failover**, **PXE/VoIP 특화**.
- 본 문서의 **구성 예시(ISC/Kea/Windows/dnsmasq/IOS)**, **옵션 표**, **스위치 보안 설정**, **트러블슈팅/체크리스트**를 그대로 적용하면 **운영 가능한 DHCP 인프라**를 구축할 수 있다.
