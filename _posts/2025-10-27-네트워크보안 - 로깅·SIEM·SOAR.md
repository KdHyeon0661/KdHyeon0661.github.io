---
layout: post
title: 네트워크보안 - 로깅·SIEM·SOAR
date: 2025-10-27 23:25:23 +0900
category: 네트워크보안
---
# 로깅·SIEM·SOAR

> 목표: **무엇을 수집할지(방화벽/프록시/DNS/NetFlow)**를 표준화(ECS/CEF/LEEF)하고,
> **상관규칙·UEBA**로 “행위”를 묶어 위협을 추려낸다.
> **SOAR 플레이북**으로 **격리·티켓·알림**을 자동화하고,
> 실습에서는 **“피싱 클릭 → 이상 트래픽”**을 **엔드투엔드**로 자동 처리한다.

---

## 수집 대상(방화벽/프록시/DNS/NetFlow)

### 수집 우선순위(Top 10)

1) **방화벽/NGFW**: 허용/차단/세션 로그, App-ID/URL 카테고리, Threat/IPS 이벤트
2) **프록시/게이트웨이/WAF/CDN**: HTTP/S 요청, UA, X-Forwarded-For, Bot/Rule 결과
3) **DNS(리졸버/포워더)**: 쿼리, 응답, RCODE, Client-IP, DoH/DoT 엔드포인트
4) **NetFlow/IPFIX/sFlow**: 5-튜플, 바이트/패킷, TCP 플래그, AS, 인터페이스
5) **인증(AD/IdP)**: 로그인 성공/실패, 위치/디바이스, MFA 결과
6) **엔드포인트(EDR)**: 프로세스 생성/네트워크, 자산 태그, 격리 이벤트
7) **클라우드 로그**: CloudTrail/Activity Log/Audit Log, VPC Flow Logs, WAF, CWL
8) **메일(SMTP/M365/Gmail Audit)**: 수신/발신, 스팸/피싱 태그, URL 재작성 기록
9) **취약점/자산**: 호스트 가중치, CVE/Severity, CMDB 소유자
10) **프라이빗 PKI/프록시 TLS**: SNI/JA3/Cert Fingerprint(법/정책 내 허용 시)

> **규모가 작으면** 1–5번만으로도 **탐지 커버리지 80%** 달성 가능.

---

### 공통 스키마(ECS)와 필드 맵핑

| 소스 | 원천 필드 | ECS 권장 |
|---|---|---|
| 방화벽 | `src_ip`, `dst_ip`, `app`, `action`, `rule` | `source.ip`, `destination.ip`, `network.application`, `event.action`, `rule.name` |
| 프록시 | `url`, `ua`, `bytes_sent/received`, `code` | `url.full`, `user_agent.original`, `source.bytes/destination.bytes`, `http.response.status_code` |
| DNS | `qname`, `qtype`, `rcode`, `client_ip` | `dns.question.name/type`, `dns.response_code`, `client.ip` |
| NetFlow | `l4proto`, `tcpflags`, `octets`, `packets` | `network.transport`, `network.iana_number/tcp.flags`, `network.bytes`, `network.packets` |

**Filebeat/Logstash** 단계에서 맵핑 템플릿을 강제해 **질의 표준화**를 확보한다.

---

### 수집 파이프라인 예(간단 Logstash)

```conf
input { udp { port => 5514 type => "syslog" } }
filter {
  if [type] == "syslog" and "PAN-THREAT" in [message] {
    # Palo Alto Threat 로그 예시 파서(간단)
    csv { separator => ","; columns => ["future_use","receive_time","serial","type","threat","src","dst","nat_src","nat_dst","rule","src_user","dst_user","app","vsys","from","to","misc","threatid","category","severity","direction","seqno","action","misc2"] }
    mutate {
      add_field => { "event.action" => "%{threat}" "source.ip" => "%{src}" "destination.ip" => "%{dst}" "rule.name" => "%{rule}" "network.application" => "%{app}" }
      remove_field => ["src","dst"]
    }
  }
}
output { elasticsearch { hosts => ["http://es:9200"] index => "sec-%{+YYYY.MM.dd}" } }
```

---

## 상관규칙·UEBA 기초

### 상관규칙의 레이어

- **단일 이벤트 규칙**: 시그니처/정책 위반(예: `geo=RU AND MFA=fail>5`)
- **다중 이벤트 상관**: 시간창(window) 내 **연쇄 조건**
- **행위(UEBA)**: 베이스라인 대비 **이상치**(시간대/빈도/목적지/기기/여정)

### 기본 패턴 6가지

1) **브루트포스 → 성공**: 짧은 시간 실패 다수 후 동일 주체의 성공
2) **피싱 클릭 → 신규 도메인 통신**: 메일 URL 클릭 후 NXDOMAIN↑ 또는 생소 도메인 egress
3) **권한 상승 후 외부 대량 전송**
4) **신규 JA3 → DoH로 DNS 은닉**
5) **VPN 로그인 지오불일치 → 내부 고가치 자원 접근**
6) **동시 세션(불가능한 이동)**: 짧은 시간 서로 다른 국가에서 로그인

### Elastic KQL 예(다중 이벤트 상관)

**[규칙] 피싱 클릭 10분 이내 비정상 DNS/NXDOMAIN 폭증**
```kql
/* Step A: 피싱으로 분류된 메일 URL 클릭 */
index: mail-*
event.action : "URLClicked" and labels.threat : "phish"
| keep user.email, url.full, event.start
| rename event.start as click_ts

/* Step B: 10분 윈도우 내 DNS NXDOMAIN 상위 */
index: dns-*
where client.user.email in {A.user.email}
and @timestamp between click_ts and click_ts + 10m
and dns.response_code : "NXDOMAIN"
| stats count() by client.user.email
| where count > 30
```
> 룰 엔진에선 두 검색을 **sequence**로 묶어 알림 생성.

### Splunk SPL 예(브루트포스→성공)

```spl
index=auth action=failure
| stats count as fails latest(_time) as last_fail by user src
| where fails>=10
| join user [ search index=auth action=success earliest=last_fail latest=+10m | stats earliest(_time) as succ_ts by user src ]
| table user src fails succ_ts
```

### UEBA(행위기반) 초석

- **정규화된 주체**: `user.id`, `host.id`, `asset.tier`
- **베이스라인**: 사용자별 정상 도메인/시간/지리/AS 목록
- **스코어링**: 이벤트별 가중치 → **세션/케이스 점수**
- **위험 합성**: (이상 트래픽 + 취약 자산 + 민감 데이터 접근) ≥ 임계치 → “케이스 승격”

**간단 UEBA 스코어(파이썬 의사코드)**
```python
score = 0
if login_geo_new: score += 20
if dga_entropy_high: score += 30
if ja3_rare: score += 25
if asset_tier == "critical": score *= 1.5
alert = score >= 60
```

---

## SOAR 플레이북(격리/티켓/알림)

### 플레이북 설계 원칙

- **Idempotent**: 같은 알림 재실행해도 **중복 격리/중복 티켓** 방지
- **승격 경로**: 자동 → 사람 승인 → 강제 조치(격리/차단)
- **롤백**: TTL/만료(예: 4시간 후 자동 해제)
- **감사**: 모든 액션에 **누가/언제/무엇을/왜(증거 링크)**

### 액션 카탈로그

- **격리**: EDR 네트워크 격리, NAC VLAN 이동, ZTNA 권한 박탈
- **네트워크 차단**: FW 주소그룹 추가, 프록시 도메인 차단, DNS 싱크홀
- **티켓**: JIRA/ServiceNow(소유자/자산/증거 링크 포함)
- **알림**: Slack/Teams(버튼: 승인/거부)
- **증거 수집**: 샌드박스, PCAP 캡처(윈도우 N초)

### SOAR 파이썬(개념) — Slack 승인 후 격리

```python
from datetime import datetime, timedelta
import requests, json

def isolate_host(host_id, ttl_minutes=240):
    # EDR API 호출(벤더별 상이)
    r = requests.post("https://edr/api/isolate", json={"host_id": host_id, "ttl": ttl_minutes})
    return r.status_code == 200

def add_fw_block(domain):
    return requests.post("https://fw/api/address-group/add", json={"group":"blocklist","domain":domain}).ok

def create_ticket(summary, desc, owner):
    return requests.post("https://jira/rest/api/2/issue", json={
        "fields":{"project":{"key":"SEC"}, "summary":summary, "description":desc, "assignee":{"name":owner}, "issuetype":{"name":"Task"}}
    }).json()["key"]

def slack_approve(channel, text):
    payload = {"channel": channel, "text": text, "attachments":[{"text":"Approve isolate?","fallback":"approve","callback_id":"isolate","actions":[{"name":"approve","text":"Approve","type":"button","value":"yes"},{"name":"deny","text":"Deny","type":"button","value":"no"}]}]}
    requests.post("https://slack/api/chat.postMessage", json=payload)

def handler(alert):
    host = alert["host.id"]; domain = alert.get("suspicious_domain"); owner = alert.get("owner","soc")
    slack_approve("#soc", f"[{alert['id']}] Beacon detected on {host} to {domain}. Approve isolate?")
    # ...Webhook 콜백에서 승인되면:
    if add_fw_block(domain) and isolate_host(host):
        ticket = create_ticket("Beacon + phishing", f"Host {host} isolated. Domain blocked: {domain}", owner)
        return {"status":"ok","ticket":ticket}
    return {"status":"partial"}
```

---

## 실습: “피싱 클릭 후 이상 트래픽” 자동화

> **시나리오**
> 1) 사용자가 **피싱 메일의 URL**을 클릭.
> 2) 10분 내 **DGA·NXDOMAIN** 다수 발생 및 **희귀 JA3**로 C2 접속 시도.
> 3) SIEM **상관규칙**이 케이스 생성 → **SOAR 플레이북**이 **승인형 격리** 수행.
> 4) **DNS 싱크홀 + FW 도메인 차단** + **EDR 격리** + **티켓** + **슬랙 알림**.

### 데이터 준비(샘플 인덱스)

- `mail-*` : `event.action=URLClicked`, `user.email`, `url.full`
- `dns-*` : `client.ip/user.email`, `dns.question.name`, `dns.response_code`
- `tls-*` : `source.ip`, `ja3`, `server.name(SNI)`
- `asset-*`: `client.ip → host.id/owner/asset.tier`

### SIEM 룰(Elastic Detection Rule YAML 예)

```yaml
name: Phish-click -> DGA/NXDOMAIN + Rare JA3 (10m)
type: eql
index: ["mail-*","dns-*","tls-*"]
severity: high
risk_score: 80
query: |
 sequence by user.email with maxspan=10m
  [ mail where event.action == "URLClicked" and labels.threat == "phish" ]
  [ dns where dns.response_code == "NXDOMAIN" ]
  [ tls where not ja3 in ("<기업정상JA3_1>","<2>","<3>") ]
rule_throttle: 5m
references: ["playbook://phish-beacon"]
tags: ["phishing","c2","dga","ja3"]
```
> **자산 조인**은 Enrichment(Transform/Lookup)로 `user.email → client.ip → host.id`.

### Sigma 규칙(벤더 중립)

```yaml
title: Phishing Click Followed by NXDOMAIN Burst and Rare JA3
id: 3f5b44c0-...-ndr-0001
status: experimental
logsource:
  product: network
  service: dns/tls/mail
detection:
  click:
    selection:
      event.action: "URLClicked"
      labels.threat: "phish"
  nxd:
    selection:
      dns.response_code: "NXDOMAIN"
  rareja3:
    condition: ja3 NOT IN (%COMMON_JA3%)
  timeframe: 10m
  condition: click and nxd and rareja3
fields:
  - user.email
  - client.ip
  - ja3
level: high
```

### 경보 → SOAR 컨텍스트(enrichment)

- **WHOIS/Passive DNS**: 도메인 신뢰도
- **Geo/IP reputation**: ASN/국가
- **자산 중요도**: `asset.tier`, 소유자(온콜), 업무군

**간단 Enrichment(HTTP API 호출 가정)**
```python
def enrich(domain, ip):
    r1 = requests.get(f"https://reputation/api/domain/{domain}").json()
    r2 = requests.get(f"https://whois/api/{domain}").json()
    r3 = requests.get(f"https://cmdb/api/host/{ip}").json()
    return {"rep": r1["score"], "whois": r2["registrar"], "asset": r3["tier"], "owner": r3["owner"]}
```

### 승인형 격리(슬랙 인터랙티브) 흐름

```
[SIEM Rule] -> [SOAR Webhook]
    -> Enrichment(도메인 평판<40 AND asset.tier in {"gold","plat"})
    -> Slack 알림: "격리 승인?" 버튼
        -> Approve: EDR 격리 + FW 도메인 차단 + DNS 싱크홀
        -> Deny: 케이스 모니터링 유지
    -> JIRA 티켓 생성(증거 링크/조치 로그 첨부)
```

**슬랙 메시지 템플릿(예)**
```json
{
 "text": "[ALERT] Phish→C2 의심 | host: WIN-123 | user: a@corp",
 "attachments": [{
   "fields":[
     {"title":"Domain","value":"dga-qz9s3.example","short":true},
     {"title":"JA3","value":"b2f3...","short":true},
     {"title":"NXDOMAIN/min","value":"45","short":true},
     {"title":"Asset Tier","value":"gold","short":true}
   ],
   "actions":[
     {"type":"button","text":"Isolate Host","name":"approve","value":"yes","style":"danger"},
     {"type":"button","text":"Ignore","name":"deny","value":"no"}
   ]
 }]
}
```

### 차단 액션(예시 명령)

- **DNS 싱크홀**: 내부 Bind/Unbound에 `RPZ` 추가 or 보안 DNS 정책 API
- **방화벽 도메인/주소 그룹**: `domain → fqdn-object` 등록
- **EDR 격리**: 벤더 REST API

**Bind RPZ(개념)**
```
zone "rpz.local" { type master; file "/etc/bind/db.rpz"; };
; db.rpz
$TTL 60
@   IN  SOA rpz.local. admin.rpz.local. 1 1h 15m 30d 2h
    IN  NS  localhost.
dga-qz9s3.example CNAME .
```

### 케이스/티켓 템플릿

- **요약**: “Phish click → NXDOMAIN burst(45/min) → rare JA3(b2f3…) → host WIN-123”
- **조치**: DNS RPZ 적용, FW 차단규칙, EDR 격리(4h TTL), 사용자 통보
- **증거**: Kibana Discover 링크(필터 포함), PCAP 스냅샷(필요 시), Zeek 로그
- **후속**: 사용자의 계정 비밀번호 재설정, 브라우저 확장점검, 교육

---

## 부록 A. 대시보드 핵심 위젯

- **Top NXDOMAIN by user/host (1m)**
- **Rare JA3 Heatmap(by host)**
- **Mail URL Clicked vs DNS/TLS Timeline**
- **Incident Funnel(Detection→Enrichment→Action)**

## 부록 B. 운영 체크리스트

- [ ] 모든 소스 **시간 동기화(NTP)**
- [ ] **ECS/스키마** 일관성(질의 재사용)
- [ ] 상관규칙은 **오탐 라벨링 루프** 포함(“Suppress for 24h”)
- [ ] **SOAR 테스트 모드**(Dry-run) → 운영 전 **카나리**
- [ ] 격리/차단은 **TTL/자동 해제** 내장
- [ ] **감사 로그/증거 보존 기한** 준수(법/규정)
- [ ] 정기 **골든 PCAP/로그 리플레이** CI

## 부록 C. 일반 함정

- **로그량 폭증**: 샘플링/필드 축소, 수명주기(Hot→Warm→Cold→S3)
- **데이터 품질**: NAT 뒤 식별 불가 → **X-Forwarded-For/EDR 태그/프록시 Auth**로 상호 보강
- **경보 과다**: 위험 스코어 합성 + **저위험 자동종결** 규칙

---

## 요약

- **수집 표준화(ECS)**와 **핵심 소스(방화벽/프록시/DNS/NetFlow)**만으로도 강력한 탐지 기반을 만든다.
- **상관규칙 + UEBA**로 “피싱 → C2” 같은 **행위 연쇄**를 잡는다.
- **SOAR 플레이북**은 **승인형 자동화**와 **롤백**을 내장해야 운영이 안전하다.
- 실습 시나리오처럼 **메일→DNS/TLS→SIEM→SOAR→격리/차단→티켓**까지 **코드로** 연결하면,
  적은 인력으로도 **지속 가능한 대응 체계**를 구축할 수 있다.
