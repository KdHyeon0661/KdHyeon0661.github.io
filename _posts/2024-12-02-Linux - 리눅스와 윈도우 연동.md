---
layout: post
title: Linux - 리눅스와 윈도우 연동
date: 2024-12-02 19:20:23 +0900
category: Linux
---
# 리눅스와 윈도우 연동

## Samba: 리눅스에서 Windows SMB/CIFS 파일 공유

Samba는 리눅스 시스템이 Windows와 파일 및 프린터를 공유할 수 있게 해주는 오픈소스 소프트웨어입니다. 이를 통해 윈도우 클라이언트가 네트워크를 통해 리눅스 서버의 파일에 접근할 수 있습니다.

### 설치 방법

**Debian/Ubuntu 계열**:
```bash
sudo apt update
sudo apt install samba samba-common-bin
```

**RHEL/CentOS/Fedora 계열**:
```bash
sudo dnf install samba samba-common samba-client
```

### 기본 구성 요소와 네트워크 포트

Samba는 여러 데몬으로 구성되어 있으며 각각 특정 기능을 담당합니다:

- **smbd**: 파일 공유와 인증을 처리합니다.
- **nmbd**: NetBIOS 이름 해석을 담당합니다 (현대 환경에서는 주로 mDNS나 AD로 대체됨).
- **winbind**: Active Directory와 Kerberos 통합 시 사용됩니다.

**필수 네트워크 포트**:
- TCP 445 (SMB 오버 TCP, 필수)
- TCP 139, UDP 137-138 (레거시 NetBIOS, 현대 환경에서는 선택적)

방화벽 설정 예시 (UFW 사용 시):
```bash
sudo ufw allow 445/tcp
sudo ufw allow 139/tcp
sudo ufw allow 137,138/udp
```

### Samba 구성 파일 구조 이해

Samba의 핵심 구성 파일인 `/etc/samba/smb.conf`는 두 가지 주요 섹션으로 나뉩니다:

1. **글로벌 섹션**: 서버 전체 설정 (인증, 로깅, 기본 정책 등)
2. **공유 섹션**: 각 공유 디렉터리별 설정

**기본 구성 예시**:
```ini
[global]
   workgroup = WORKGROUP
   server string = %h Samba Server
   disable netbios = yes
   smb ports = 445
   map to guest = Bad User
   security = user
   
   # 현대 Windows 호환성 설정
   server min protocol = SMB2_10
   server max protocol = SMB3
   
   # Windows ACL 지원
   vfs objects = acl_xattr
   map acl inherit = yes
   store dos attributes = yes

[share]
   path = /srv/samba/share
   browsable = yes
   read only = no
   guest ok = yes
   force create mode = 0644
   force directory mode = 0755
   inherit acls = yes
```

### 공유 디렉터리 준비 및 권한 설정

```bash
# 공유 디렉터리 생성
sudo mkdir -p /srv/samba/share

# 권한 설정 (게스트 접근 허용 시)
sudo chown -R nobody:nogroup /srv/samba/share
sudo chmod -R 0755 /srv/samba/share

# 또는 특정 사용자/그룹 소유로 설정
sudo chown -R filesvc:filesvc /srv/samba/share
sudo chmod -R 0755 /srv/samba/share
```

### 사용자 계정 관리 (게스트 접근 제한 환경)

```bash
# 리눅스 시스템 계정 생성
sudo useradd -m filesvc
sudo passwd filesvc

# Samba 전용 계정 생성 (별도 데이터베이스)
sudo smbpasswd -a filesvc

# 등록된 Samba 사용자 확인
sudo pdbedit -L
```

게스트 접근을 제한하려면 공유 섹션에 다음 설정을 추가합니다:
```ini
[share]
   guest ok = no
   valid users = filesvc
```

### 서비스 실행 및 검증

```bash
# 구성 파일 문법 검사
sudo testparm

# Samba 서비스 시작 및 활성화
sudo systemctl enable --now smbd
sudo systemctl status smbd

# 로컬에서 공유 목록 확인
smbclient -L localhost -U filesvc

# 특정 공유에 접속 테스트
smbclient //127.0.0.1/share -U filesvc
```

### 윈도우 클라이언트에서 접속

- **파일 탐색기**: 주소창에 `\\리눅스-서버-IP\share` 입력
- **명령 프롬프트**: `net use Z: \\server\share /user:filesvc`

---

## 권한과 ACL 매핑: Windows ↔ POSIX

Windows의 ACL(액세스 제어 목록) 모델과 리눅스의 POSIX 권한 모델 간의 매핑은 중요한 운영 포인트입니다. 효과적인 매핑을 위해 다음 세 가지 수준에서 조정이 필요합니다:

### 1. 파일 시스템 수준 설정

대부분의 현대 리눅스 파일시스템(ext4, XFS 등)은 POSIX ACL을 지원합니다. 마운트 옵션에 `acl`이 포함되어 있는지 확인하세요:

```bash
# 마운트 옵션 확인
mount | grep " / "

# ACL 설정 확인
getfacl /srv/samba/share
```

### 2. Samba 수준 설정

```ini
[global]
   vfs objects = acl_xattr
   map acl inherit = yes
   store dos attributes = yes

[team]
   path = /srv/samba/team
   read only = no
   browsable = yes
   inherit acls = yes
   vfs objects = acl_xattr recycle
   recycle:repository = /.recycle/%U
   recycle:versions = yes
   recycle:keeptree = yes
```

### 3. 권한 마스킹 설정

권한 마스킹을 통해 기본 파일 및 디렉터리 권한을 제어할 수 있습니다:

```ini
[share]
   create mask = 0644      # 새 파일 권한
   directory mask = 0755   # 새 디렉터리 권한
   force create mode = 0644   # 강제 적용 권한
   force directory mode = 0755
```

**권한 불일치 문제 해결**: 대부분의 권한 문제는 파일시스템 ACL, 사용자/그룹 설정, umask, Samba ACL/xattr 설정 간의 불일치에서 발생합니다. 상위 디렉터리부터 소유자, 그룹, ACL을 체계적으로 정리하고 `testparm` 및 `smbstatus`로 확인하는 것이 중요합니다.

---

## Active Directory 및 Kerberos 통합 (SSO)

도메인 환경에서 도메인 사용자가 Single Sign-On(SSO)으로 Samba 공유에 접근하도록 설정하려면 다음 단계를 따르세요:

### 1. 필요한 패키지 설치

```bash
sudo apt install krb5-user winbind libnss-winbind libpam-winbind samba
```

### 2. Kerberos 구성 (`/etc/krb5.conf`)

```ini
[libdefaults]
  default_realm = EXAMPLE.COM
  dns_lookup_realm = true
  dns_lookup_kdc = true
```

### 3. Samba 구성 (`/etc/samba/smb.conf`)

```ini
[global]
  workgroup = EXAMPLE
  security = ADS
  realm = EXAMPLE.COM
  winbind use default domain = yes
  
  # ID 매핑 설정
  idmap config * : backend = tdb
  idmap config * : range = 10000-19999
  idmap config EXAMPLE : backend = rid
  idmap config EXAMPLE : range = 20000-999999
  
  template shell = /bin/bash
  vfs objects = acl_xattr
  map acl inherit = yes
  store dos attributes = yes
```

### 4. 도메인 가입

```bash
# Kerberos 티켓 획득
sudo kinit Administrator

# Active Directory 도메인 가입
sudo net ads join -U Administrator

# 서비스 재시작
sudo systemctl restart smbd nmbd winbind

# 도메인 사용자 확인
wbinfo -u
getent passwd "EXAMPLE\\alice"
```

**중요 포인트**: 도메인 가입 시 Kerberos(포트 88), LDAP(포트 389/636), SMB(포트 445) 및 다양한 RPC 포트(135 및 1024-65535)에 대한 방화벽 접근이 필요합니다.

---

## 리눅스에서 Windows 공유 마운트 (CIFS)

리눅스 시스템에서 Windows 공유를 마운트하는 방법은 여러 가지가 있습니다.

### 수동 마운트

```bash
# 마운트 포인트 생성
sudo mkdir -p /mnt/wshare

# Windows 공유 마운트
sudo mount -t cifs //192.168.0.10/projects /mnt/wshare \
  -o username=winuser,password='winpass',uid=$(id -u),gid=$(id -g),vers=3.0,iocharset=utf8,sec=ntlmssp
```

**주요 마운트 옵션**:

| 옵션 | 설명 |
|---|---|
| `vers=3.0` | SMB 3.0 프로토콜 사용 (보안 및 성능 최적) |
| `sec=ntlmssp` | 현대 인증 방식 (AD 환경에서는 `sec=krb5`도 가능) |
| `uid/gid` | 마운트된 파일의 소유자/그룹 ID 설정 |
| `file_mode/dir_mode` | 로컬 권한 설정 (서버에서 권한 정보가 없는 경우) |
| `credentials=` | 인증 정보 파일 경로 |

### 보안 향상을 위한 인증 정보 파일 사용

인증 정보를 평문 명령줄에 노출하지 않으려면 별도 파일에 저장하는 것이 좋습니다:

**인증 정보 파일 생성** (`/etc/samba/creds-wshare`):
```ini
username=winuser
password=winpass
domain=EXAMPLE
```
파일 권한 설정: `sudo chmod 600 /etc/samba/creds-wshare`

**인증 정보 파일을 사용한 마운트**:
```bash
sudo mount -t cifs //192.168.0.10/projects /mnt/wshare \
  -o credentials=/etc/samba/creds-wshare,uid=1000,gid=1000,vers=3.0,iocharset=utf8
```

### 자동 마운트 설정 (`/etc/fstab`)

```fstab
# /etc/fstab 항목 추가
//192.168.0.10/projects  /mnt/wshare  cifs  credentials=/etc/samba/creds-wshare,uid=1000,gid=1000,vers=3.0,iocharset=utf8,_netdev  0  0
```
`_netdev` 옵션은 네트워크가 준비된 후에만 마운트를 시도하도록 하여 부팅 순서 문제를 방지합니다.

### systemd 마운트 유닛 사용

더 정교한 의존성 관리와 타이밍 제어를 위해 systemd 마운트 유닛을 사용할 수 있습니다:

**마운트 유닛 파일** (`/etc/systemd/system/mnt-wshare.mount`):
```ini
[Unit]
Description=Mount Windows Share
After=network-online.target
Wants=network-online.target

[Mount]
What=//192.168.0.10/projects
Where=/mnt/wshare
Type=cifs
Options=credentials=/etc/samba/creds-wshare,uid=1000,gid=1000,vers=3.0,iocharset=utf8

[Install]
WantedBy=multi-user.target
```

**유닛 활성화**:
```bash
sudo systemctl daemon-reload
sudo systemctl enable --now mnt-wshare.mount
```

---

## WSL (Windows Subsystem for Linux) 환경 통합

### WSL에서 Windows 드라이브 접근

WSL은 Windows 드라이브를 자동으로 `/mnt/c`, `/mnt/d` 등에 마운트합니다. 성능과 호환성을 최적화하려면 `/etc/wsl.conf`를 구성하세요:

**WSL 구성 파일** (`/etc/wsl.conf`):
```ini
[automount]
enabled = true
options = "metadata,uid=1000,gid=1000,umask=022,fmask=0111,case=off"
mountFsTab = true

[interop]
appendWindowsPath = false
```

**주요 옵션 설명**:
- `metadata`: NTFS 확장 속성에 POSIX 권한/소유권 메타데이터 저장 (chmod/chown 지원)
- `case=off`: 대소문자 구분 비활성화 (Windows 애플리케이션과의 호환성 향상)
- `fmask/umask`: 새 파일 및 디렉터리에 대한 기본 권한 설정
- `appendWindowsPath=false`: WSL의 PATH에 Windows 경로 자동 추가 방지

**변경사항 적용**:
```powershell
# WSL 재시작
wsl --shutdown
wsl
```

### Windows에서 WSL 파일 시스템 접근

Windows에서는 다음 경로를 통해 WSL 파일 시스템에 접근할 수 있습니다:
- **파일 탐색기**: `\\wsl.localhost\Ubuntu\home\사용자명`
- **네트워크 경로**: `\\wsl$\Ubuntu\home\사용자명`

**성능 고려사항**: 대용량 I/O 작업 시 WSL 루트 파일시스템 내에서 작업하는 것이 `/mnt/c`를 통해 Windows 파일 시스템에 접근하는 것보다 일반적으로 더 빠릅니다. 빌드 및 패키징 작업은 가능한 WSL 루트 내에서 수행하는 것이 좋습니다.

---

## 성능, 안정성 및 보안 튜닝

### Samba 서버 성능 최적화

```ini
[global]
  # SMB 멀티채널 지원 (다중 NIC/큐 활용)
  server multi channel support = yes
  
  # 비동기 I/O 활성화 (대용량 I/O에 유리)
  aio read size = 1
  aio write size = 1
  
  # 정적 파일 전송 최적화
  use sendfile = yes
```

추가 성능 개선을 위해 파일시스템 마운트 옵션(`noatime` 등), RAID 캐시 설정, NIC 오프로드 기능, MTU 최적화, CPU 핀닝 및 IRQ 밸런싱을 고려할 수 있습니다.

### 보안 강화 설정

```ini
[global]
  # 최소 SMB 프로토콜 버전 제한 (SMB1 비활성화)
  server min protocol = SMB2_10
  
  # 게스트 접근 제한
  map to guest = Never
```

**보안 모범 사례**:
1. **SMB1 비활성화**: 보안 취약점이 많으므로 모든 환경에서 비활성화
2. **게스트 접근 최소화**: 필요한 경우에만 제한적으로 허용
3. **인증 방식**: AD 환경에서는 Kerberos, 그 외에는 NTLMv2 사용
4. **SELinux/AppArmor**: 적절한 보안 컨텍스트 및 프로필 적용

**SELinux 예시**:
```bash
# Samba 공유에 적절한 SELinux 컨텍스트 설정
sudo semanage fcontext -a -t samba_share_t "/srv/samba(/.*)?"
sudo restorecon -Rv /srv/samba
```

### 가용성 및 데이터 보호

- **휴지통 기능**: `vfs recycle` 모듈을 사용한 파일 삭제 복구 기능 구현
- **스냅샷 통합**: Btrfs/ZFS/LVM 스냅샷과 결합하여 Windows 섀도우 카피 유사 기능 제공
- **자동화 백업**: 정기적인 백업 스크립트와 모니터링 구현

---

## 모니터링 및 운영 명령어

| 작업 | 명령어 | 설명 |
|---|---|---|
| 구성 검증 | `testparm` | Samba 구성 파일 문법 검사 |
| 세션 확인 | `smbstatus` | 현재 Samba 연결 및 세션 정보 |
| 공유 목록 | `smbclient -L server -U user` | 원격 서버의 공유 목록 확인 |
| 공유 접속 | `smbclient //server/share -U user` | 특정 공유에 대한 클라이언트 접속 |
| 로그 확인 | `journalctl -u smbd` | Samba 서비스 로그 확인 |
| CIFS 디버그 | `dmesg \| grep CIFS` | CIFS 마운트 관련 커널 메시지 |
| Windows 상태 | `net use` (Windows) | Windows 클라이언트의 네트워크 연결 상태 |

---

## 실전 시나리오 예제

### 시나리오 1: 읽기 전용 배포 공유

개발 팀이 소스 코드를 읽기만 할 수 있는 공유를 구성하는 경우:

```bash
# 읽기 전용 그룹 생성 및 디렉터리 설정
sudo groupadd readers
sudo mkdir -p /srv/samba/repo
sudo chgrp -R readers /srv/samba/repo
sudo chmod -R 0755 /srv/samba/repo
```

```ini
[repo]
  path = /srv/samba/repo
  read only = yes
  browsable = yes
  guest ok = no
  valid users = @readers
```

### 시나리오 2: 팀 협업 폴더 (상속형 권한)

개발 팀이 공동으로 작업할 수 있는 쓰기 가능 공유:

```bash
# 개발 팀 그룹 및 디렉터리 설정
sudo groupadd devteam
sudo mkdir -p /srv/samba/team
sudo chgrp -R devteam /srv/samba/team
sudo chmod -R 2770 /srv/samba/team  # setgid로 그룹 상속 활성화

# 기본 ACL 설정
sudo setfacl -R -m d:g:devteam:rwx /srv/samba/team
```

```ini
[team]
   path = /srv/samba/team
   read only = no
   browsable = yes
   vfs objects = acl_xattr
   map acl inherit = yes
   inherit acls = yes
   valid users = @devteam
   force group = devteam
```

### 시나리오 3: 자동화된 백업 공유 마운트

리눅스 서버에서 Windows 백업 공유를 자동으로 마운트하는 설정:

```fstab
//backup-svr/archives  /mnt/archives  cifs  credentials=/etc/samba/creds-archives,uid=1000,gid=1000,vers=3.0,iocharset=utf8,nofail,_netdev  0  0
```
`nofail` 옵션은 마운트 실패 시에도 부팅이 계속되도록 합니다.

---

## 문제 해결 가이드

| 증상 | 가능한 원인 | 해결 방법 |
|---|---|---|
| **접근 거부** (Windows에서) | 계정 미등록, 잘못된 비밀번호, 유효 사용자 미지정 | `smbpasswd -a`로 계정 등록, `valid users` 설정 확인, 로그 분석 |
| **느린 속도/연결 끊김** | SMB1 강제 사용, 네트워크 MTU 문제, 멀티채널 미지원 | `vers=3.0` 설정, AV 소프트웨어 제외 목록 추가, NIC 드라이버 업데이트 |
| **권한 불일치** | xattr/ACL 불일치, umask 충돌 | `vfs acl_xattr` 활성화, `map acl inherit` 설정, 상위 디렉터리 ACL 정리 |
| **마운트 실패** | 인증 실패, 프로토콜 버전 불일치, 암호화 정책 충돌 | `sec=ntlmssp`, `vers=3.0/3.1.1` 설정, `dmesg \| grep CIFS`로 오류 확인 |
| **AD 도메인 가입 실패** | DNS 문제, Kerberos 시간 불일치, 방화벽 차단 | NTP 동기화 확인, 필수 포트(88/389/445 등) 개방, `/etc/krb5.conf` 검증 |

---

## 성능 최적화 원리

네트워크 파일 공유의 성능은 여러 요소에 의해 결정됩니다. 주요 성능 지표를 단순화하면 다음과 같은 관계를 가집니다:

- 대역폭 \(B\) (바이트/초)
- 왕복 지연 시간 \(RTT\) (초)
- 파이프라인/윈도 크기 \(W\) (바이트)

**이론적 처리량 상한**:
\[
\text{처리량} \approx \min\left(B,\ \frac{W}{RTT}\right)
\]

멀티채널, NIC 본딩, 대형 I/O 크기, 비동기 I/O 등의 기술은 효과적으로 \(W\)를 증가시키거나 \(RTT\)의 영향을 감소시켜 고속 네트워크 및 저지연 환경에서 성능을 향상시킵니다.

---

## 유용한 구성 스니펫

### macOS 호환성 설정

```ini
[macshare]
  path = /srv/macshare
  vfs objects = catia fruit streams_xattr
  fruit:metadata = stream
  fruit:resource = file
  fruit:locking = netatalk
```

### 읽기 전용 스냅샷 공유 (Btrfs/ZFS 기반)

```ini
[snapshots]
  path = /srv/samba/.snapshots
  read only = yes
  browseable = yes
```

### systemd 자동 마운트 (온디맨드 마운트)

```ini
# /etc/systemd/system/mnt-wshare.automount
[Unit]
Description=Automount Windows Share

[Automount]
Where=/mnt/wshare

[Install]
WantedBy=multi-user.target
```

```bash
# 자동 마운트 활성화
sudo systemctl enable --now mnt-wshare.automount
```

---

## 결론

리눅스와 윈도우 시스템 간의 효과적인 연동은 여러 기술 계층의 조화로운 통합을 요구합니다. 이 가이드에서는 네 가지 핵심 영역을 다루었습니다:

1. **Samba 서버 구성**: 리눅스 시스템이 Windows 클라이언트에게 안정적으로 파일 서비스를 제공할 수 있도록 Samba를 구성하고 최적화하는 방법을 배웠습니다. 현대적인 SMB 2.x/3.x 프로토콜 사용, 적절한 권한 매핑, 성능 튜닝이 핵심입니다.

2. **CIFS 클라이언트 설정**: 리눅스 시스템이 Windows 공유를 안전하게 마운트하고 자동화하는 방법을 익혔습니다. 인증 정보 관리, 프로토콜 버전 지정, 시스템 시작 시 자동 마운트 구성이 중요합니다.

3. **WSL 통합**: Windows Subsystem for Linux 환경에서 두 운영체제 간의 원활한 파일 시스템 접근을 위한 최적의 설정을 배웠습니다. 메타데이터 지원, 대소문자 처리, 권한 관리가 WSL 구성의 핵심 요소입니다.

4. **고급 통합 기법**: Active Directory 및 Kerberos를 통한 Single Sign-On, 정교한 ACL 관리, 성능 최적화 기법 등 운영 환경 수준의 고급 기능을 살펴보았습니다.

성공적인 연동 구현을 위해서는 각 기술 계층(파일시스템, Samba, 네트워크, 클라이언트/WSL) 간의 설정 일관성이 필수적입니다. 문제가 발생할 때는 체계적인 접근법—`testparm`으로 구성 검증, `smbstatus`로 세션 확인, 서버 및 클라이언트 로그 분석, `dmesg`로 커널 수준 문제 진단—이 효과적입니다.

이러한 기술들을 숙지하고 나면, 다음 단계로 이러한 설정들을 Ansible, Salt, Puppet 같은 Infrastructure as Code 도구를 사용하여 템플릿화하고 여러 서버에 일관되게 배포하는 자동화를 구축할 수 있습니다. 이를 통해 대규모 환경에서도 효율적이고 안정적인 리눅스-윈도우 연동 인프라를 관리할 수 있게 될 것입니다.