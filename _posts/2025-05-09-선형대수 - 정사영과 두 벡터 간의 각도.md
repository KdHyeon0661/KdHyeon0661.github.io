---
layout: post
title: 선형대수 - 정사영과 두 벡터 간의 각도
date: 2025-05-09 19:20:23 +0900
category: 선형대수
---
# 벡터 정사영(Projection)과 두 벡터 간의 각도

## 0. 표기(Notation)

- 벡터: $$\mathbf{a},\mathbf{b}\in\mathbb{R}^n$$, 영벡터: $$\mathbf{0}$$  
- 내적: $$\mathbf{a}^\top\mathbf{b}$$, 노름: $$\lVert\mathbf{a}\rVert=\sqrt{\mathbf{a}^\top\mathbf{a}}$$  
- 단위벡터: $$\widehat{\mathbf{b}}=\dfrac{\mathbf{b}}{\lVert\mathbf{b}\rVert}$$ (단, $$\mathbf{b}\neq \mathbf{0}$$)  
- 열결합: $$\mathbf{A}=[\mathbf{b}_1\ \cdots\ \mathbf{b}_k]\in\mathbb{R}^{n\times k}$$

---

## 1. 한 벡터 위로의 정사영

### 1.1 정의
벡터 $$\mathbf{a}$$ 를 벡터 $$\mathbf{b}$$ 가 만드는 1차원 부분공간(직선) 위로 직교투영한 벡터를 **정사영**이라 하고
$$
\operatorname{proj}_{\mathbf{b}}(\mathbf{a})
=
\frac{\mathbf{a}^\top \mathbf{b}}{\lVert \mathbf{b}\rVert^2}\,\mathbf{b}
\quad(\mathbf{b}\neq \mathbf{0})
$$
로 정의합니다. 단위벡터를 쓰면
$$
\operatorname{proj}_{\mathbf{b}}(\mathbf{a})
=
(\mathbf{a}^\top \widehat{\mathbf{b}})\,\widehat{\mathbf{b}}.
$$

### 1.2 기하학적 의미와 직교 분해
각도 $$\theta$$ 를 $$\cos\theta=\dfrac{\mathbf{a}^\top\mathbf{b}}{\lVert\mathbf{a}\rVert\lVert\mathbf{b}\rVert}$$ 로 정의하면
$$
\lVert \operatorname{proj}_{\mathbf{b}}(\mathbf{a})\rVert
=
\lVert\mathbf{a}\rVert\,\lvert \cos\theta\rvert.
$$
또한 $$\mathbf{a}$$ 는
$$
\mathbf{a}
=
\operatorname{proj}_{\mathbf{b}}(\mathbf{a})
+
\underbrace{\bigl(\mathbf{a}-\operatorname{proj}_{\mathbf{b}}(\mathbf{a})\bigr)}_{\perp\,\mathbf{b}}
$$
로 **직교 분해**됩니다. 두 번째 항은 $$\mathbf{b}$$ 와 직교합니다.

### 1.3 성질(요점)
- $$\operatorname{proj}_{\mathbf{b}}(\cdot)$$ 는 **$$\mathbf{a}$$ 에 대해서는 선형**, $$\mathbf{b}$$ 에 대해서는 일반적으로 비선형.  
- $$\operatorname{proj}_{\mathbf{b}}(\operatorname{proj}_{\mathbf{b}}(\mathbf{a}))=\operatorname{proj}_{\mathbf{b}}(\mathbf{a})$$ (같은 직선으로 두 번 투영해도 변하지 않음).  
- $$\mathbf{b}=\mathbf{0}$$ 인 경우 정사영은 정의되지 않습니다(분모 0).

---

## 2. 두 벡터 사이의 각도

### 2.1 정의
$$
\cos\theta
=
\frac{\mathbf{a}^\top\mathbf{b}}{\lVert\mathbf{a}\rVert\,\lVert\mathbf{b}\rVert},
\qquad
\theta=\arccos\!\left(
\frac{\mathbf{a}^\top\mathbf{b}}{\lVert\mathbf{a}\rVert\,\lVert\mathbf{b}\rVert}
\right),
\quad
\theta\in[0,\pi].
$$

### 2.2 의미
- $$\cos\theta=1$$: 같은 방향, $$\cos\theta=0$$: 직교, $$\cos\theta=-1$$: 반대 방향.  
- 정사영 크기와의 연결: $$\lVert \operatorname{proj}_{\mathbf{b}}(\mathbf{a})\rVert=\lVert\mathbf{a}\rVert\,\lvert \cos\theta\rvert$$.

### 2.3 주의점
- $$\mathbf{a}=\mathbf{0}$$ 또는 $$\mathbf{b}=\mathbf{0}$$ 이면 각도 정의 불가.  
- 수치적으로 $$\cos\theta$$ 를 계산할 때는 반올림 오차로 $$[-1,1]$$ 범위를 벗어날 수 있으므로 클리핑이 필요합니다.

---

## 3. 부분공간(여러 벡터가 생성하는 공간)으로의 정사영

### 3.1 일반형(이론적 공식)
열공간 $$\mathcal{S}=\operatorname{Col}(\mathbf{A})$$ 로의 직교투영은, $$\mathbf{A}$$ 가 풀 컬럼 랭크일 때
$$
\mathbf{P}
=
\mathbf{A}\,(\mathbf{A}^\top\mathbf{A})^{-1}\mathbf{A}^\top,
\qquad
\operatorname{proj}_{\mathcal{S}}(\mathbf{x})=\mathbf{P}\mathbf{x}.
$$
이때 $$\mathbf{P}$$ 는 **대칭**이고 **아이델포턴트**($$\mathbf{P}^2=\mathbf{P}$$)입니다. 고유값은 0 또는 1이며, $$\operatorname{tr}(\mathbf{P})=\operatorname{rank}(\mathbf{A})=\dim\mathcal{S}$$ 입니다.

### 3.2 수치적으로 안정한 공식(QR/SVD)
실무에서는 QR 또는 SVD가 안정적입니다.
- QR: $$\mathbf{A}=\mathbf{Q}\mathbf{R}$$, 열이 정규직교인 $$\mathbf{Q}$$ 를 쓰면
  $$
  \mathbf{P}=\mathbf{Q}\mathbf{Q}^\top.
  $$
- SVD: $$\mathbf{A}=\mathbf{U}\mathbf{\Sigma}\mathbf{V}^\top$$, 0이 아닌 특이값에 해당하는 $$\mathbf{U}$$ 의 앞 열들로 $$\mathbf{Q}$$ 를 만들면 동일하게 $$\mathbf{P}=\mathbf{Q}\mathbf{Q}^\top$$.

---

## 4. 최소제곱(Least Squares)과 정사영의 연결

과정 $$\min_{\mathbf{x}}\lVert \mathbf{A}\mathbf{x}-\mathbf{b}\rVert$$ 의 해 $$\widehat{\mathbf{x}}$$ 는, **$$\mathbf{b}$$ 를 $$\operatorname{Col}(\mathbf{A})$$ 로 직교투영**한 벡터
$$
\widehat{\mathbf{b}}=\operatorname{proj}_{\operatorname{Col}(\mathbf{A})}(\mathbf{b})=\mathbf{P}\mathbf{b}
$$
를 만족하며, $$\mathbf{A}\widehat{\mathbf{x}}=\widehat{\mathbf{b}}$$ 입니다. 즉 최소제곱은 “목표를 설명 가능한 부분공간으로 투영”하는 과정입니다.

---

## 5. PyTorch 구현

아래 코드는 모두 독립 실행 가능하며, 기본적으로 float64를 사용합니다(수치 안정성).

### 5.1 벡터 → 벡터 정사영과 각도
```python
import torch
torch.set_printoptions(precision=6, sci_mode=False)

def project_onto_vector(a: torch.Tensor, b: torch.Tensor):
    """
    a,b: (n,) 1D tensors
    반환:
      proj: a를 b 방향으로 정사영한 (n,)
      orth: 잔차 a - proj (b와 직교)
    """
    a = a.to(torch.float64)
    b = b.to(torch.float64)
    denom = b @ b
    if denom == 0:
        raise ValueError("정사영 불가: 기준 벡터 b의 노름이 0입니다.")
    coeff = (a @ b) / denom
    proj = coeff * b
    orth = a - proj
    return proj, orth

def angle_between(a: torch.Tensor, b: torch.Tensor, in_degrees: bool = True):
    """
    a,b: (n,)
    반환: 각도(라디안 또는 도)
    """
    a = a.to(torch.float64)
    b = b.to(torch.float64)
    na = torch.linalg.norm(a)
    nb = torch.linalg.norm(b)
    if na == 0 or nb == 0:
        raise ValueError("각도 정의 불가: a 또는 b의 노름이 0입니다.")
    cosv = (a @ b) / (na * nb)
    # 수치 안정성: arccos 입력을 [-1,1]로 클리핑
    cosv = torch.clamp(cosv, -1.0, 1.0)
    rad = torch.arccos(cosv)
    return torch.rad2deg(rad) if in_degrees else rad

# 예시
a = torch.tensor([2.0, 3.0])
b = torch.tensor([1.0, 0.0])

proj, orth = project_onto_vector(a, b)
theta_deg = angle_between(a, b)

print("정사영 proj(a onto b) =", proj)    # [2., 0.]
print("직교 잔차 orth =", orth)           # [0., 3.]
print("각도(도) =", theta_deg)            # 56.3099... (atan2(3,2)와 일치)
print("정사영 크기 =", torch.linalg.norm(proj))  # |a|*|cosθ|
```

### 5.2 벡터 → 부분공간 정사영(QR/SVD 방식)
```python
import torch

def projector_Q_from_A(A: torch.Tensor, tol: float = 1e-12):
    """
    A: (n,k) 생성자 열벡터들의 행렬
    반환: P = Q Q^T (정사영 행렬), Q(정규직교 기저)
    QR 또는 SVD 중 택1. 여기서는 SVD 기반으로 랭크 감지 후 Q 구성.
    """
    A = A.to(torch.float64)
    U, S, Vh = torch.linalg.svd(A, full_matrices=False)
    if S.numel() == 0 or float(S.max()) == 0.0:
        # A가 영행렬
        n = A.size(0)
        return torch.zeros((n, n), dtype=A.dtype), torch.zeros((n, 0), dtype=A.dtype)
    # 유효 랭크 판단
    thresh = tol * max(A.size()) * float(S.max())
    r = int((S > thresh).sum().item())
    Q = U[:, :r] if r > 0 else torch.zeros((A.size(0), 0), dtype=A.dtype)
    P = Q @ Q.T if r > 0 else torch.zeros((A.size(0), A.size(0)), dtype=A.dtype)
    return P, Q

def project_onto_subspace(x: torch.Tensor, A: torch.Tensor, tol: float = 1e-12):
    """
    x: (n,)
    A: (n,k) — 부분공간 생성자(열)
    반환: proj, orth, rank
    """
    x = x.to(torch.float64)
    P, Q = projector_Q_from_A(A, tol=tol)
    proj = P @ x
    orth = x - proj
    rank = Q.size(1)
    return proj, orth, rank

# 예시1: 직선(span{[1,0,0]^T})로의 투영
x = torch.tensor([1.0, 2.0, 3.0])
v = torch.tensor([[1.0], [0.0], [0.0]])  # (3,1)
proj, orth, r = project_onto_subspace(x, v)
print("rank =", r, " proj =", proj, " orth =", orth)

# 예시2: 평면(span{e1, e3})로의 투영
A = torch.tensor([[1.0, 0.0],
                  [0.0, 0.0],
                  [0.0, 1.0]])  # e1,e3
proj2, orth2, r2 = project_onto_subspace(x, A)
print("rank =", r2, " proj =", proj2, " orth =", orth2)  # y성분만 제거
```

### 5.3 정사영 행렬의 성질(대칭·아이델포턴트) 확인
```python
import torch

def is_symmetric(M: torch.Tensor, tol: float = 1e-10):
    return torch.linalg.norm(M - M.T) <= tol

def is_idempotent(M: torch.Tensor, tol: float = 1e-10):
    return torch.linalg.norm(M @ M - M) <= tol

A = torch.tensor([[1., 2.],
                  [0., 1.],
                  [0., 0.]], dtype=torch.float64)
P, Q = projector_Q_from_A(A)  # P = Q Q^T
print("대칭?", is_symmetric(P))
print("아이델포턴트?", is_idempotent(P))
print("trace(P)와 rank(Q) =", torch.trace(P), Q.size(1))
```

### 5.4 최소제곱과의 연결: 투영으로 해 구하기
```python
import torch

def least_squares_via_projection(A: torch.Tensor, b: torch.Tensor, tol: float = 1e-12):
    """
    A: (m,n), b: (m,)
    Col(A)로 b를 투영한 후, A x_hat = P b 를 만족하는 최소제곱해 반환
    """
    A = A.to(torch.float64)
    b = b.to(torch.float64)
    P, Q = projector_Q_from_A(A, tol=tol)
    b_hat = P @ b
    # 최소제곱 해: x = A^+ b = V Σ^+ U^T b
    x_hat = torch.linalg.lstsq(A, b).solution
    return x_hat, b_hat

A = torch.tensor([[1., 1.],
                  [1., 2.],
                  [1., 3.]], dtype=torch.float64)
b = torch.tensor([2., 2., 4.], dtype=torch.float64)

x_hat, b_hat = least_squares_via_projection(A, b)
print("최소제곱해 x_hat =", x_hat)
print("투영된 b_hat =", b_hat)
print("잔차 ⟂ Col(A)?", torch.allclose(A.T @ (b - b_hat), torch.zeros(2, dtype=torch.float64)))
```

---

## 6. 직교 투영의 추가 성질과 증명 스케치

1) 최적성(최소 거리):  
모든 $$\mathbf{y}\in\mathcal{S}$$ 에 대해
$$
\lVert \mathbf{a}-\operatorname{proj}_{\mathcal{S}}(\mathbf{a})\rVert
\le
\lVert \mathbf{a}-\mathbf{y}\rVert.
$$
증명 스케치: 직교 분해와 피타고라스 정리 사용.

2) 사영 행렬의 고유구조:  
$$\mathbf{P}$$ 는 대칭·아이델포턴트이므로 고유값은 0 또는 1. 1의 중복도는 $$\dim\mathcal{S}$$.

3) 그람 행렬과의 연결:  
$$\mathbf{A}$$ 가 풀 컬럼 랭크면 $$\mathbf{A}^\top\mathbf{A}$$ 는 양정치이고,  
$$
\mathbf{P}=\mathbf{A}(\mathbf{A}^\top\mathbf{A})^{-1}\mathbf{A}^\top
$$
가 유일한 직교투영 행렬.

---

## 7. 수치 이슈와 실무 팁

- 분모 0 방지: $$\lVert\mathbf{b}\rVert=0$$ 또는 $$\mathbf{A}=\mathbf{0}$$ 인 경우 예외 처리.  
- 근종속 열: $$\mathbf{A}^\top\mathbf{A}$$ 역행렬 직접 계산은 불안정. **QR/SVD 권장**.  
- 반올림 오차: 각도 계산 시 $$\cos\theta$$ 를 $$[-1,1]$$ 로 클리핑.  
- dtype: **float64** 사용을 우선.  
- 대규모: 정사영 행렬 $$\mathbf{P}$$ 를 명시적으로 만들지 말고, **$$\mathbf{Q}\mathbf{Q}^\top \mathbf{x}$$ 형태로 곱만 수행**.

---

## 8. 실전 시나리오

- 코사인 유사도(정보 검색, 임베딩 비교):  
  $$\cos\theta=\dfrac{\mathbf{a}^\top\mathbf{b}}{\lVert\mathbf{a}\rVert\lVert\mathbf{b}\rVert}$$ 로 방향 유사도 판단.  
- 그래픽스/물리: 광원 방향으로의 투영, 충격량의 방향 성분 계산.  
- 신호 처리: 특정 서브스페이스(기저)로의 투영을 통한 잡음 제거.  
- 회귀/선형모형: 관측 벡터를 설계행렬 열공간으로 투영하여 잔차를 직교화.

---

## 9. 연습문제(힌트)

1) $$\mathbf{a}=(3,4)^\top,\ \mathbf{b}=(1,0)^\top$$ 에 대해 정사영과 각도를 구하라.  
힌트: 정사영은 $$(3,0)^\top$$, 각도는 $$\arccos(3/5)$$.

2) $$\mathbb{R}^3$$ 에서  
$$
\mathbf{A}=\begin{bmatrix}
1&0\\
0&1\\
0&0
\end{bmatrix},\quad
\mathbf{x}=(1,2,3)^\top
$$
에 대해 $$\operatorname{proj}_{\operatorname{Col}(\mathbf{A})}(\mathbf{x})$$ 를 구하라.  
힌트: $$y$$ 성분만 남지 않도록 투영.

3) 최소제곱 문제 $$\min_x\lVert\mathbf{A}x-\mathbf{b}\rVert$$ 에서 정상방정식($$\mathbf{A}^\top\mathbf{A}x=\mathbf{A}^\top\mathbf{b}$$)이 **직교조건** $$\mathbf{A}^\top(\mathbf{b}-\mathbf{A}x)=\mathbf{0}$$ 과 동치임을 보여라.  
힌트: $$\mathbf{b}-\mathbf{A}x$$ 가 좌영공간에 속함.

4) 정사영 행렬 $$\mathbf{P}$$ 가 대칭·아이델포턴트이면 고유값이 0 또는 1 뿐임을 보여라.  
힌트: $$\mathbf{P}\mathbf{v}=\lambda\mathbf{v}$$ 에 $$\mathbf{P}^2=\mathbf{P}$$ 대입.

---

## 10. 요약

- 벡터 정사영:  
  $$
  \operatorname{proj}_{\mathbf{b}}(\mathbf{a})=\frac{\mathbf{a}^\top \mathbf{b}}{\lVert \mathbf{b}\rVert^2}\mathbf{b},\quad
  \lVert \operatorname{proj}_{\mathbf{b}}(\mathbf{a})\rVert=\lVert\mathbf{a}\rVert\,\lvert \cos\theta\rvert.
  $$
- 각도:  
  $$
  \cos\theta=\dfrac{\mathbf{a}^\top\mathbf{b}}{\lVert\mathbf{a}\rVert\lVert\mathbf{b}\rVert},\ \theta=\arccos(\cdot).
  $$
- 부분공간 투영: $$\mathbf{P}=\mathbf{Q}\mathbf{Q}^\top$$ (QR/SVD) 가 실무 표준.  
- 최소제곱은 **목표를 열공간으로의 직교투영**으로 해석되며 잔차는 그 직교보완에 놓입니다.