---
layout: post
title: TCPIP - 링크 계층
date: 2025-08-29 16:25:23 +0900
category: TCPIP
---
# 링크 계층

## 1. 링크 계층 위치 다시 잡기

### 1.1 OSI와 TCP/IP 스택에서의 링크 계층

- **L1(물리)**: 전기/광 신호, 전압/파형, 케이블·커넥터.
- **L2(링크)**: **프레임 단위** 주소(MAC), 오류 검출(FCS), 브로드캐스트/유니캐스트 스코프, 스위칭.
- **L3(네트워크)**: **패킷 단위** 주소(IP), 라우팅, TTL, 단편화/재조립.
- **L4(전송)**: TCP/UDP 포트, 신뢰성·흐름·혼잡 제어.

현실 장비 기준:

- **스위치**: L2 중심 장비 (요즘은 L3 기능 내장인 Layer3 Switch가 많음).
- **라우터/방화벽**: L3 중심, 서브넷 경계에서 동작.

핵심:

- **L2는 “같은 브로드캐스트 도메인 안” 통신을 책임진다.**
- L3는 “서로 다른 IP 네트워크 사이”를 잇는다.
- L2가 꼬이면 L3/L7에서 **핑 타임아웃, HTTP 끊김**으로 보이므로, **문제를 볼 때 “아래층부터” 확인하는 습관**이 중요하다.

---

## 2. MAC 주소, 프레임, 스위칭, 브로드캐스트/유니캐스트

### 2.1 MAC 주소 한눈에

- 일반적인 형식: **EUI-48 (48비트)**  
  예: `aa:bb:cc:dd:ee:ff`
- 상위 24비트: **OUI(Organizationally Unique Identifier)**  
  → 제조사/벤더를 식별 (예: 특정 NIC 벤더).
- 하위 24비트: **디바이스 고유 번호**  
  → 같은 OUI라도 각 NIC마다 다른 값.

#### 2.1.1 특수 주소

- **브로드캐스트**: `ff:ff:ff:ff:ff:ff`  
  → **동일 VLAN(브로드캐스트 도메인)** 내 모든 호스트로 전달.
- **멀티캐스트(L2)**:
  - 상위 비트 중 **I/G bit=1** 인 MAC (Group 주소).
  - IPv4 멀티캐스트(224.0.0.0/4), IPv6 멀티캐스트(ff00::/8)는 규칙에 따라 L2 멀티캐스트 MAC으로 매핑.
- **유니캐스트**:
  - 특정 NIC를 가리키는 고유 MAC (I/G bit=0, 개별 주소).

#### 2.1.2 MAC 상위 비트 의미

MAC 첫 바이트(8비트)를 비트로 보면:

- **I/G bit (Individual/Group)**:  
  - 0 = 개별(유니캐스트)  
  - 1 = 그룹(멀티/브로드캐스트)
- **U/L bit (Universal/Local)**:  
  - 0 = 전역(공장 할당, OUI 기반)  
  - 1 = 로컬 관리(관리자가 임의 지정한 MAC)

예:

- 가상화 환경(하이퍼바이저, 컨테이너 브리지 등)에서는 U/L bit가 1인 **로컬 MAC**을 많이 사용한다.

---

### 2.2 이더넷 프레임 구조 요약

전형적인 Ethernet II 프레임 구조(단순화):

```text
Preamble(7) | SFD(1) | Dest MAC(6) | Src MAC(6) | 802.1Q Tag(optional, 4) | EtherType(2)
+--------------------------- Payload(46~1500 bytes) ---------------------------+ FCS(4)
```

- **Preamble(7B)**: 비트 동기화를 위한 패턴.
- **SFD(Start Frame Delimiter, 1B)**: 프레임 시작 지점 표시.
- **Destination MAC / Source MAC**: 목적지/출발지 L2 주소.
- **802.1Q Tag(4B, 선택)**: VLAN/우선순위 정보 (뒤에서 자세히).
- **EtherType(2B)**: 상위 프로토콜(IP, ARP, IPv6 등) 구분.
- **Payload**: L3 헤더 + L4 헤더 + 데이터.
- **FCS(4B)**: CRC 기반 오류 검출 (L2 수준).

프레임 길이 대략:

$$
\text{L2 Frame} \approx 14\ \text{(헤더)} + 4\ \text{(802.1Q, 선택)} + \text{L3 헤더} + \text{L4 헤더} + \text{Payload} + 4\ \text{(FCS)}
$$

→ 특히 VLAN 태그나 오버레이(예: VXLAN, GRE, MPLS 등)가 붙으면 **MSS(최대 세그먼트 크기)**와 **경로 MTU**에 영향을 준다.

---

### 2.3 스위치의 기본 동작: 학습·포워딩·플러딩

스위치는 들어오는 프레임에 대해 다음 세 가지를 한다:

1. **학습(Learning)**  
   - 수신 프레임의 **출발지 MAC**과 **들어온 포트**를 MAC 테이블(CAM)에 기록.
   - 예: `MAC A → Port1`, `MAC B → Port2`.
   - 일정 시간 통신이 없으면 **에이징**(삭제)된다.

2. **포워딩(Forwarding)**  
   - 목적지 MAC이 테이블에 있으면 → **그 포트로만** 전송.
   - 브리지/스위치의 핵심 동작.

3. **플러딩(Flooding)**  
   - 목적지 MAC이 테이블에 없으면 →  
     **Unknown Unicast Flood**: 해당 VLAN의 모든 포트(수신 포트 제외)에 브로드캐스트처럼 살포.
   - 브로드캐스트 MAC(`ff:ff:ff:ff:ff:ff`)인 경우에도 VLAN 내 모든 포트로 플러딩.

#### 예제 A — “스위치가 MAC을 어떻게 배우는가”

```text
PC-A(MAC A) —[Port1]— Switch —[Port2]— PC-B(MAC B)

1) A가 B에게 첫 프레임 송신
   - Switch는 src=A를 Port1에 학습
   - dst=B를 아직 모름 → Port2로 Flood

2) B가 응답 프레임 송신
   - Switch는 src=B를 Port2에 학습
   - dst=A는 이미 Port1으로 기록되어 있으므로 Port1으로만 포워딩

3) 이후 A↔B 통신
   - Flood 없이 A↔B 포인트 투 포인트 포워딩

4) 한동안 통신 없으면
   - MAC 테이블 에이징 타이머 만료 → A,B 엔트리 삭제
```

핵심 체감:

- **처음에는 Flood가 나가지만, 이후에는 “조용해진다”**  
  → MAC 학습이 정상적으로 이루어졌다는 신호.
- Unknown Unicast Flood가 많다는 것은:
  - CAM 용량 부족, 에이징 타이머/동적 호스트 과다,
  - 또는 **루프/구성 문제**일 가능성이 있다.

---

### 2.4 브로드캐스트, 멀티캐스트, 유니캐스트의 차이

#### 2.4.1 브로드캐스트

- MAC: `ff:ff:ff:ff:ff:ff`
- 예: **ARP Request**, 일부 DHCP, 초기 서비스 디스커버리.
- 같은 VLAN 안의 모든 호스트에 도달 → **모든 NIC 인터럽트** 발생.

과도한 브로드캐스트의 결과:

- 각 호스트 CPU에 부담 → 특히 저성능 장비는 네트워크가 “느려진다”로 체감.
- 스위치도 브로드캐스트를 각 포트로 복제해야 하므로 내부 리소스 사용 증가.
- 루프가 있으면 브로드캐스트가 **무한 증폭** → **브로드캐스트 스톰**.

#### 2.4.2 멀티캐스트

- 특정 그룹으로 전송.
- L2에서 **멤버십 정보를 몰라서** 브로드캐스트처럼 흘려보내면 비효율.
- 그래서 **IGMP 스누핑(IPv4), MLD 스누핑(IPv6)**을 통해 “어떤 포트가 어떤 그룹에 관심 있는지” 파악하여 **필요 포트에만 전달**하도록 최적화.

#### 2.4.3 유니캐스트

- 특정 목적지 MAC 하나를 위한 프레임.
- 최적 상태에서는 **정확히 한 포트**로만 포워딩.
- 일반적인 애플리케이션 트래픽(TCP/UDP)은 대부분 유니캐스트.

---

### 2.5 ARP/NDP와 브로드캐스트 도메인

L3 IP 통신을 위해 L2 MAC 주소가 필요하다.

#### 2.5.1 ARP (IPv4)

- 목적지 IPv4 주소에 대응하는 MAC을 찾기 위한 프로토콜.
- ARP Request: 브로드캐스트(`ff:ff:ff:ff:ff:ff`)로 전송.
- ARP Reply: 해당 호스트의 MAC을 포함한 유니캐스트 응답.

ARP 특성:

- 같은 VLAN(브로드캐스트 도메인) 안에서만 유효.
- **게이트웨이 MAC을 알아야** 외부 네트워크와 통신 가능.
- ARP 폭증은 L2/L3 모두에서 장애로 체감 (CPU, 링크 부하).

#### 2.5.2 NDP (IPv6 Neighbor Discovery)

- IPv6에서 ARP를 대체.
- ICMPv6 기반, 멀티캐스트를 활용.
- L2에서는 IPv6 멀티캐스트 MAC으로 매핑되어 동작.

---

### 2.6 현장에서 자주 보는 L2 이상 신호

- **MAC 플래핑(MAC Flapping)**  
  - 동일 MAC이 서로 다른 포트에서 번갈아 관측.
  - 원인:
    - L2 루프
    - 이중 연결(이중화 구성 오류)
    - 브리지/가상 스위치 구조가 꼬인 경우
  - 체감: 세션이 간헐적으로 끊기거나, 특정 서비스만 비정상.

- **Unknown Unicast Flood 증가**  
  - MAC 테이블 용량 부족, 에이징/학습 정책 문제, 루프, 과도한 동적 호스트.
  - 체감: 특정 구간 트래픽이 폭증, “무작위” 지연/타임아웃.

- **ARP 폭증**  
  - DHCP/게이트웨이/프록시 오동작, 네트워크 스캔, 루프 등.
  - 체감: 전체적으로 지연이 증가, CPU 사용률 상승.

---

## 3. VLAN(802.1Q), 트렁크/액세스 포트, MTU

### 3.1 VLAN: L2를 논리적인 네트워크로 분리

**VLAN(Virtual LAN)**의 핵심:

- **브로드캐스트 도메인 분리**  
  → VLAN이 다르면 L2에서 서로의 브로드캐스트를 받지 않는다.
- 같은 물리 스위치에 연결되어 있어도, VLAN이 다르면 **서로 다른 네트워크처럼 보인다**.
- L3 관점에서는 VLAN마다 다른 **서브넷**을 매핑하는 것이 일반적:
  - VLAN 10 → 192.168.10.0/24
  - VLAN 20 → 192.168.20.0/24
- VLAN 간 통신은 반드시 L3 장비(라우터, L3 스위치)에 의해 이루어진다.

---

### 3.2 Access 포트 vs Trunk 포트

#### 3.2.1 Access 포트

- **단일 VLAN**에 소속.
- 호스트는 **VLAN 태그를 전혀 의식하지 않는다**.
- 스위치는 포트에 들어온 프레임을 **특정 VLAN에 매핑**하고, 나갈 때도 그 VLAN의 언태그 프레임으로 보낸다.

예:

```text
Switch Port Fa0/1
- mode: access
- access vlan 10

PC는 그냥 이더넷 프레임을 보낸다.
Switch는 이 포트를 VLAN 10 브로드캐스트 도메인에 귀속시킨다.
```

#### 3.2.2 Trunk 포트

- **여러 VLAN**을 하나의 물리 링크로 동시에 전달.
- VLAN을 구분하기 위해 **802.1Q 태그**를 사용.
- 스위치↔스위치, 스위치↔서버(서버 NIC가 VLAN을 인지/태깅하는 경우)에 주로 사용.

예:

```text
Switch-1 Gi1/0/1 --- Gi1/0/1 Switch-2
- mode: trunk
- allowed vlan: 10,20,30
```

이 링크로 VLAN 10,20,30 트래픽이 모두 태그된 상태로 흐른다.

---

### 3.3 802.1Q 태그 구조

802.1Q VLAN 태그는 **4바이트**가 프레임에 삽입된다.

- **TPID(2B)**: Tag Protocol Identifier  
  - 보통 `0x8100`
- **TCI(Tag Control Information, 2B)**:
  - **PCP(3bit)**: 802.1p 우선순위(0~7, QoS용)
  - **DEI(1bit)**: Drop Eligible Indicator(혼잡 시 드롭 후보 표시)
  - **VID(12bit)**: VLAN ID(1~4094, 0=언태그, 4095 예약)

이로 인해 프레임 크기가 커져:

- **이더넷 프레임**은 원래 최대길이(64~1518B)가 있는데,
- VLAN 태그를 넣으면 4B 증가 → 1522B까지 허용(스위치들은 보통 이를 **baby giant**로 수용).

---

### 3.4 Native VLAN과 주의점

- **Native VLAN**(벤더 용어): Trunk 포트에서 **태그 없이(untagged)** 흐르는 VLAN.
- 이유:
  - 초기 표준/호환성 요구 탓에 만들어진 개념.
  - 서로 다른 벤더 장비간 Trunk 연결 시 기본 VLAN을 태그 없이 보내기도 했다.

주의해야 할 점:

- 양단 Trunk의 Native VLAN이 다르면:
  - 한쪽에서 VLAN 10 언태그, 다른 쪽에서는 이를 VLAN 1로 해석 → **VLAN 혼선/이중화**.
  - 보안 측면에서 VLAN hopping과 같은 취약점과도 연관.

**베스트 프랙티스**:

- 가능하면 Native VLAN을 명시적으로 **일치**시키거나,
- Native VLAN에 **실제 사용자 트래픽을 두지 않음**(관리용/비사용 VLAN).

---

### 3.5 VLAN과 MTU

#### 3.5.1 기본 이더넷 MTU와 VLAN 태그

- 전통적인 **L3 MTU = 1500B**.
- VLAN 태그(4B)가 들어가면 프레임 자체는 커지지만,
  - 대부분의 스위치는 1522B 정도의 **baby giant** 프레임을 수용.
  - L3 MTU 1500을 그대로 사용해도 보통 문제는 없다.

#### 3.5.2 오버레이/다중 태깅 시 MTU 감소

문제는 VLAN 태그가 아니라, **여러 계층의 헤더**가 쌓일 때 발생한다.

예:

- VLAN(4B) + QinQ(4B 추가) + MPLS(각 라벨 4B) + GRE/VXLAN(20~50B 이상) 등.
- 이 경우, L3에서 1500B를 그대로 쓰면 **중간 어느 구간의 MTU를 초과**할 수 있다.

그래서 필요한 것이:

- **경로 MTU(End-to-End Path MTU)를 고려한 설계**.
- TCP의 경우, 아래와 같이 **MSS를 조절**해야 한다.

---

### 3.6 MTU, MSS, PMTUD 직관

- MTU: 한 링크에서 전송 가능한 **최대 L3 패킷 크기**(IP 헤더 + 페이로드).
- MSS(Maximum Segment Size): TCP가 한 세그먼트에 실을 수 있는 **데이터 크기**.
- 기본적으로:

$$
\text{MSS} \approx \text{MTU} - (\text{IP 헤더} + \text{TCP 헤더})
$$

예:

- MTU=1500, IPv4 20B, TCP 20B라면:
  - MSS ≈ 1460B.

오버레이/태그가 많을수록 MTU를 줄여야 하므로:

- MTU=1400이라면:
  - MSS ≈ 1360B.

이런 설정은 보통 **경로 중 가장 작은 MTU에 맞춰야** 한다.  
그렇지 않으면 **PMTUD(경로 MTU 디스커버리)**가 실패하고, “큰 응답만” 끊기는 현상이 발생한다.

---

### 3.7 예제 C — “태그/오버레이로 MTU 블랙홀”

```text
환경:
- 테넌트 네트워크 위에 VXLAN 오버레이 + QinQ 사용
- 경로 중 일부 장비는 1500B MTU를 그대로 사용, 오버레이 오버헤드를 고려하지 않음
- 클라이언트와 서버는 MTU=1500, MSS=1460으로 동작

증상:
- 작은 HTTP 요청/응답은 정상 (예: 1KB 이하 JSON)
- 큰 응답(파일 다운로드, 대량 JSON)은 일정 크기 이상에서 타임아웃/끊김
- ping 1000B는 되는데, 1472B(DF 설정) ping은 실패

원인:
- VXLAN+QinQ+기타 헤더로 인해 중간 링크에서 실제 허용 MTU는 1400B 근처
- DF(Don’t Fragment)가 설정된 큰 패킷이 중간에서 Drop
- ICMP Frag Needed/Too Big가 방화벽/ACL로 막혀 PMTUD 실패

조치:
- 경로 MTU를 1400B로 표준화
- 테넌트 서브넷에서 MSS 클램핑 적용 (예: MSS=1360)
- 방화벽/라우터에서 ICMP Too Big 허용 또는 PMTUD 대안 메커니즘 고려
```

---

## 4. LAG(링크 어그리게이션)과 트래픽 분산

### 4.1 LAG 개념

**Link Aggregation Group(LAG)**:

- 여러 물리 링크를 **하나의 논리적 링크**처럼 묶는 기술.
- 표준: **IEEE 802.1AX** (옛 802.3ad).
- 목적:
  - **대역폭 확장**: 2×10G LAG → 논리적으로 20G.
  - **이중화**: 한 링크 장애 시 나머지로 자동 전환.

### 4.2 Static LAG vs LACP

- **Static LAG**:
  - 양단 라우터/스위치에서 “여기 2개 포트는 묶음”으로 수동 설정.
  - 링크 상태만으로는 “구성 오류”를 잘 인지하기 어려움.
- **LACP(Link Aggregation Control Protocol)**:
  - 양단이 active/passive로 협상하여 LAG를 구성.
  - 멤버 링크 상태 변화, 일관성 체크, 파라미터 불일치를 감지 가능.

LACP 동작 개념:

```text
- Actor(본인)와 Partner(상대)의 시스템 ID, 포트 ID, 키 등을 교환
- 파라미터가 일치하는 링크들을 "같은 LAG" 멤버로 묶음
- 비대칭/오류 링크는 LAG에서 제외
```

---

### 4.3 해싱 기반 분산과 한계

LAG는 보통 **해시 기반 분산**을 사용한다.

- 해시 입력:
  - Src/Dst MAC
  - Src/Dst IP
  - Src/Dst Port
  - 또는 이들의 조합(5-튜플)
- 해시 결과에 따라 어느 물리 링크를 사용할지 결정.

결과적으로:

- **흐름 단위(per-flow) 분산**이 일반적.
  - 특정 TCP 세션은 **항상 같은 링크**를 사용.
  - 순서가 중요한 프로토콜(TCP)이 재정렬 없이 동작하도록 하기 위함.
- 단일 TCP 흐름의 처리량은 해당 링크 속도에 제한.
  - 2×10G LAG라도 단일 흐름은 보통 10G 근처가 **상한**.

---

### 4.4 예제 D — “절반의 연결만 느린 LAG”

```text
환경:
- 서버 팜 ↔ 스파인 스위치 사이에 2링크 LAG(각 10G)
- 해시 입력: Src/Dst IP+Port (5-튜플 기반)

현상:
- 같은 서비스인데 일부 사용자만 "매우 느리다" 신고
- 모니터링 결과, LAG 멤버 #1은 거의 포화(9.5~10G), 멤버 #2는 한가함(2~3G)

원인:
- 해시 키 분포가 좋지 않아 특정 백엔드/서비스 조합이 멤버 #1로만 집중
- 일부 사용자(특정 백엔드에 매칭)는 혼잡 링크를 타느라 느림
- 나머지 사용자는 멤버 #2를 타서 정상

조치:
- 해시 기준 변경 (예: 3-튜플에서 5-튜플, 혹은 포트 포함/제외 조합 조정)
- LAG 멤버 증설(3~4링크로 분산 세분화)
- 서버 측에서도 연결 분산(멀티 세션, 멀티 스트림) 전략 적용
- 경우에 따라 ECMP(L3)와의 조합 설계
```

---

## 5. STP/RSTP/MSTP: 루프 방지 메커니즘

### 5.1 왜 L2 루프가 위험한가

- IP(L3)는 **TTL** 필드가 있어 루프를 몇 홉 내에 끊는다.
- 이더넷(L2)에는 TTL 개념이 없다.
- L2에서 루프가 생기면:
  - 브로드캐스트, Unknown Unicast, 멀티캐스트 프레임이 **무한히 순환**.
  - 프레임이 복제되며 **기하급수적으로 증가**.
  - 스위치/링크/호스트 모두 **스톰**에 휩싸인다.

그래서 등장한 것이:

- **STP(Spanning Tree Protocol, IEEE 802.1D)**: 최초 표준.
- **RSTP(Rapid STP, IEEE 802.1w)**: 빠른 수렴.
- **MSTP(Multiple Spanning Tree, IEEE 802.1s)**: 여러 VLAN을 그룹으로 묶어 다중 스패닝 트리.

---

### 5.2 STP 기본 개념

#### 5.2.1 루트 브리지 선출

- 모든 스위치는 **Bridge ID**를 가진다.
  - Bridge Priority(16bit) + MAC 주소.
- STP는 이 중 가장 “작은” 값을 가진 스위치를 **루트 브리지**로 선택.
- 운영자는 코어/중심 스위치가 루트가 되도록 **우선순위를 낮게 설정**하는 것이 일반적.

#### 5.2.2 포트 역할

- **Root Port**: 루트 브리지로 가는 최단 경로를 가진 포트(각 스위치 1개).
- **Designated Port**: 특정 세그먼트에서 “주도” 역할을 하는 포트.
- **Non-designated Port(또는 Alternate/Backup)**: 루프 방지를 위해 **Blocking/Discarding** 상태로 두는 포트.

#### 5.2.3 포트 상태 변화(STP vs RSTP)

- 전통 STP(802.1D):
  - Blocking → Listening → Learning → Forwarding
  - 수렴에 **수십 초**가 걸릴 수 있음.
- RSTP(802.1w):
  - Discarding → Learning → Forwarding
  - **Handshake 기반 빠른 전환**으로 보통 1~3초대.

---

### 5.3 BPDU와 보호 기능

- **BPDU(Bridge Protocol Data Unit)**: STP/RSTP 정보가 담긴 L2 프레임.
- 스위치는 주기적으로 BPDU를 교환해:
  - 루트 브리지,
  - 경로 비용,
  - 포트 역할/상태를 결정.

보안/안정 기능:

- **BPDU Guard**:
  - Edge/Access 포트에서 BPDU를 받으면 포트를 에러로 down 시킴.
  - 사용자 장비에 스위치/허브를 임의로 연결하여 **STP 토폴로지에 끼어드는 것**을 방지.
- **Root Guard**:
  - 루트 브리지 후보가 되면 안 되는 포트에서 “내가 루트야”라는 BPDU가 오면 해당 포트를 제한.
- **Loop Guard**:
  - STP 메시지(BPDU)가 끊긴 상황에서 포트가 잘못 Forwarding으로 전환되는 것을 막음.
- **PortFast**:
  - Edge/Access 포트에서 **즉시 Forwarding** 상태로 올리는 기능.
  - PC/서버가 부팅할 때 긴 STP 지연 때문에 DHCP 실패/로그인 지연이 발생하는 것을 줄여줌.
  - PortFast는 **사용자 장비 포트에만 적용**해야 하며, BPDU Guard와 함께 사용하면 안전성이 높다.

---

### 5.4 예제 E — “현장에서 흔한 루프”

```text
상황:
- 사용자가 책상 아래에 4포트 미니 허브를 설치
- 허브에 들어가는 2개의 UTP 케이블을 실수로 서로 연결(Loop)
- 엣지 포트가 PortFast 상태이지만 BPDU Guard 미사용
- 허브는 BPDU를 차단하거나 그냥 통과시키지 않음

결과:
1) 루프 형성 → 브로드캐스트/Unknown Unicast 프레임이 허브-스위치 사이를 무한 순환
2) 스위치 내부 포트/CPU가 스톰에 휩싸여 테이블 갱신/제어 기능 수행 불가
3) 같은 VLAN의 모든 호스트가 "인터넷이 끊겼다"를 체감
4) L3/L7 관점에서는 DNS 타임아웃, HTTP 타임아웃, RDP 끊김 등으로 보임

대응:
- 스위치 로그에서 STP/브로드캐스트 스톰/포트 에러를 확인
- 문제 포트를 찾은 뒤 해당 포트 shutdown
- 재발 방지를 위해:
  - 엣지 포트에 PortFast + BPDU Guard + Storm Control 적용
  - 사용자 장비에 추가 허브/스위치 설치를 제한하거나 가이드 강화
```

---

### 5.5 톱올로지 변경 후유증

STP/RSTP 토폴로지 변경(TC, Topology Change)이 발생하면:

- 스위치는 일정 시간 동안 **CAM(MAC) 테이블 에이징 타이머를 매우 짧게** 줄인다(예: 15초 등).
- 기존 MAC→포트 매핑이 빠르게 지워지고, 다시 학습되는 동안:

  - 세션이 일시 끊기거나,
  - TCP 연결이 RST 또는 타임아웃으로 끊길 수 있다.

체감:

- “잠깐(수 초~수십 초) 동안만 네트워크가 이상했다.”
- “그 시간대에만 접속이 끊겼다가 자동으로 복구되었다.”

관찰 포인트:

- 스위치 로그에서 **STP TCN/TC 이벤트** 시간과  
  사용자 불만/장애 티켓 시간대를 매칭해 보는 것이 중요하다.

---

## 6. L2 문제의 L3/L7 체감 — 진짜 원인은 아래층

아래 표는 **L2 원인 → L3/L7에서 보이는 증상 → 1차 체크 방향**을 한 번에 보도록 정리한 것이다.

| L2 원인 | 겉 증상(L3/L7) | 현장 설명 | 1차 체크 |
|---|---|---|---|
| VLAN 트렁크 허용 목록/Native VLAN 불일치 | 같은 서브넷 일부만 핑/접속 실패 | 중간 스위치 간 VLAN 전파 단절, 일부 구간만 단절 | 트렁크 설정 양단 비교, VLAN 맵, Native VLAN 일치 여부 |
| MTU/오버레이/태그로 인한 PMTUD 블랙홀 | 작은 응답 OK, 큰 응답 타임아웃 | DF+큰 세그먼트가 중간에서 Drop | 경로 MTU·MSS, ICMP Too Big 허용 여부 |
| 브로드캐스트 스톰/루프 | 사무실 전체 인터넷 다운, 핑 폭증 | L2 스톰으로 CPU/링크 포화 | STP/RSTP 상태, Storm Control, MAC 플래핑, 비정상 트래픽 |
| MAC 플래핑 | 세션이 간헐적 끊김 | 동일 MAC이 포트를 번갈아 출현 | 스위치 MAC Move 로그, 이중 연결/루프 여부 |
| LAG 해시 불균형/멤버 다운 | 일부 사용자/서비스만 느림 | 특정 흐름만 과부하 링크로 집중 | LACP 상태, 멤버별 트래픽·큐, 해시 기준 |
| ARP/NDP 이상(폭증/스캔) | 간헐적 타임아웃·지연 | 브로드캐스트 증가로 인터럽트 폭증 | ARP/NDP 통계, 스캔/오류 장비 여부 |
| IGMP 스누핑 미구성 | 멀티캐스트가 전 포트로 흘러감 | 사실상 브로드캐스트처럼 확산 | IGMP Snooping/Querier 설정 |
| 포트 보안·Storm Control 오동작 | 특정 장비만 자꾸 끊김 | MAC 제한 초과, 브로드캐스트/유니캐스트 한도 초과 | Port-Security/Storm Control 로그·정책 확인 |

이 표를 실제 장애 분석 시 “체크리스트”로 사용하면, **L2/L3 어디부터 의심할지 방향을 빠르게 잡을 수 있다.**

---

## 7. 운영·디버깅 체크리스트 (스위치/서버 관점)

### 7.1 스위치 공통 명령·관찰 포인트(개념)

벤더별 명령어 이름은 다르지만, 보는 내용은 비슷하다.

```text
[MAC/CAM]
- show mac address-table / show mac (learned MAC, VLAN, Port)
- MAC 플래핑/Move 이벤트, Aging 통계

[VLAN/트렁크]
- show vlan brief (VLAN 리스트·포트 매핑)
- show interfaces trunk (Trunk 여부, Allowed VLAN, Native VLAN)
- Access 포트의 VLAN 설정 일관성 점검

[STP/RSTP]
- show spanning-tree (Root Bridge, Port Role/State, Path Cost)
- STP Topology Change(TC) 이벤트 로그, BPDU Guard/Root Guard 동작

[LAG/LACP]
- show etherchannel / show port-channel / show lacp (멤버 상태, 해시 모드)
- 각 멤버의 에러/드롭/속도/듀플렉스/사용률

[Storm Control/보안]
- storm-control 설정 및 카운터
- port-security(허용 MAC 수, 위반 로그)
```

예시(Cisco 계열 느낌의 의사 코드):

```text
Switch# show mac address-table dynamic vlan 10
Switch# show spanning-tree vlan 10
Switch# show interfaces trunk
Switch# show etherchannel summary
Switch# show storm-control
```

---

### 7.2 호스트/서버 측 체크

서버 또는 클라이언트에서 확인해야 할 것:

```text
- NIC 속도/듀플렉스: auto-negotiate, 또는 고정 속도/듀플렉스 불일치 여부
- NIC MTU: 1500/9000(Jumbo) 등, 스위치와 일관성 여부
- VLAN 태깅: 
  - bare-metal 서버: NIC의 VLAN ID 설정 / LACP 참여 여부
  - 가상화: vSwitch/Port-Group의 VLAN ID, Trunk vs Access 모드
- 경로 MTU:
  - DF 설정한 ping으로 큰 패킷 테스트
  - ICMP Too Big 수신 여부
- ARP 캐시 상태:
  - Gateway MAC, 이웃 MAC이 자주 바뀌는지, incomplete 항목이 많은지
```

리눅스 예시:

```bash
ip link show
ip -d link show dev eth0          # VLAN/오프로드 상세
ip addr show dev eth0
ip neigh                          # ARP/NDP 캐시
ping -M do -s 1400 <peer-ip>      # DF 설정, 특정 크기 테스트
```

---

### 7.3 “먼저 L2인지부터 가른다” 루틴

장애 분석 시, 다음 순서를 권장한다:

```text
1) 같은 VLAN 내에서의 통신 테스트
   - 같은 VLAN, 같은 스위치 혹은 인접 스위치에 있는 두 호스트 간 ping
   - 기본 게이트웨이를 지나지 않는 순수 L2 테스트

2) 다른 VLAN(=L3 경유) 간 통신 테스트
   - VLAN 간 통신 / 외부 네트워크 통신에서만 문제라면 L3/L4/L7 영역 우선 의심

3) 트렁크/네이티브 VLAN/허용 VLAN 체크
   - 문제 구간에 있는 모든 스위치/링크에서 VLAN 설정이 일관적인지 확인

4) STP/RSTP 이벤트
   - 최근 Topology Change(TC), 포트 Blocking/Forwarding 전환, 루트 브리지 교체 여부 확인

5) MTU/MSS/오버레이 경로 차이 점검
   - 작은 패킷은 정상, 큰 패킷만 실패하면 경로 MTU/PMTUD 문제 가능성↑

6) LAG 멤버 상태/해시 불균형
   - 일부 사용자·서비스만 느리다면, LAG 해시·멤버별 부하를 확인

7) ARP/NDP/브로드캐스트·멀티캐스트 통계
   - 비정상 폭증, 스캔, 오동작 장비 유무
```

---

## 8. 미니 실습 과제

현장에서 직접 랩을 구성해 볼 때, 다음 네 가지 시나리오를 해 보는 것을 추천한다.

### 8.1 실습 1 — “VLAN 미스매치 찾기”

**의도**: L3처럼 보이는 단절을 L2 원인으로 식별하는 감각.

```text
구성:
- Switch-1, Switch-2 사이 Trunk 링크 1개
- VLAN 10, 20 구성
- 일부 포트는 Access VLAN 10, 일부는 Access VLAN 20

실수:
- Switch-1 Trunk: allow VLAN 10,20
- Switch-2 Trunk: allow VLAN 10 only (20 누락)

증상:
- 같은 10.10.20.0/24 대역인데, 다른 층/구역의 호스트끼리만 ping 실패
- 게이트웨이, 라우팅 구성은 문제 없음

진단:
- Switch-1/2의 'show interfaces trunk' 비교
- VLAN 20이 한쪽에서만 허용된 것을 발견

조치:
- 두 스위치 모두 Trunk allowed VLAN에 10,20 추가
- 문제 즉시 해결
```

---

### 8.2 실습 2 — “MTU 블랙홀 재현”

**의도**: “작은 요청은 되고 큰 응답만 실패” 현상 이해.

```text
구성:
- 중간 라우터/스위치에 GRE/VXLAN 같은 오버레이 구성
- 일부 구간 링크 MTU가 1500, 일부는 1400

실험:
- 경로 MTU를 고려하지 않고 양단 호스트 MTU=1500 유지
- ping:
  - ping -M do -s 1000 → 성공
  - ping -M do -s 1472 → 실패

관찰:
- 중간 장비에서 'show ip mtu', 'show interfaces' 등으로 MTU 확인
- 방화벽/라우터에서 ICMP Frag Needed/Too Big 로그 및 카운터 확인

조치:
- 전체 경로 MTU를 1400으로 맞추고,
- TCP 세션이 지나가는 구간에 MSS 클램핑 설정
- 다시 ping -M do -s 1360 → 성공, 큰 HTTP 응답도 정상
```

---

### 8.3 실습 3 — “LAG 해시 편향 관찰”

**의도**: “일부 사용자만 느린 이유”를 LAG 관점에서 이해.

```text
구성:
- 2×10G LAG 기반 서버 팜 ↔ 코어 스위치
- 해시 키 = Src/Dst IP

실험:
- 동일 목적지 서버에 여러 클라이언트에서 동시 접속
- 트래픽 모양:
  - 특정 소스/목적지 조합이 한 LAG 멤버로만 몰리는 상황 만들기
- 스위치:
  - show etherchannel load-balance
  - 각 멤버 인터페이스의 사용률/큐/드롭 확인

관찰:
- 멤버 #1 포화, 멤버 #2 여유 → 일부 클라이언트 요청 지연 증가
- 해시 기준을 5-튜플로 바꾸거나 멤버 수를 늘리면 분산이 개선되는 것 확인
```

---

### 8.4 실습 4 — “STP 토폴로지 변경 감지”

**의도**: 사용자 “순간 끊김”과 STP 토폴로지 변경의 상관관계.

```text
구성:
- RSTP 활성화된 액세스/코어 스위치
- 특정 링크를 수동으로 다운/업 하며 토폴로지 변경 유도

실험:
- 링크 down/up 시각을 기록
- 동일한 시각대에 사용자의 ping/HTTP 요청을 계속 수행
- 스위치 로그:
  - STP Topology Change(TC) 발생 시각 확인

관찰:
- TC 직후 수 초 동안 ping 지연 급증 또는 일부 패킷 손실
- 브라우저/애플리케이션에서는 잠깐 끊겼다가 자동 복구로 보임
- CAM 테이블 에이징/재학습으로 인한 영향 체감
```

---

## 9. 숫자 감각 & 수식 메모

### 9.1 프레임 길이와 오버헤드

이더넷 환경에서 실제 L2 프레임 길이는 대략:

$$
\begin{aligned}
\text{Frame Size}
&\approx \text{L2 헤더}(14\ \text{B}) \\
&\quad + \text{802.1Q 태그}(4\ \text{B, 선택}) \\
&\quad + \text{L3 헤더}(20\ \text{B IPv4} \text{ 또는 } 40\ \text{B IPv6}) \\
&\quad + \text{L4 헤더}(20\ \text{B TCP, 옵션 제외}) \\
&\quad + \text{Payload} \\
&\quad + \text{FCS}(4\ \text{B})
\end{aligned}
$$

VLAN 태그, MPLS, VXLAN 등 오버헤드가 많을수록:

- **유효 Payload**(애플리케이션 데이터)의 비율이 줄어들고,
- 동일한 데이터량을 보내려면 **더 많은 프레임**이 필요하며,
- MTU/MSS 설계 문제를 일으킬 가능성이 커진다.

---

### 9.2 BDP와 L2/L3 상호 영향

전송 계층(L4)에서 흔히 쓰는 **BDP(Bandwidth-Delay Product)**:

$$
\text{BDP} = \text{Bandwidth} \times \text{RTT}
$$

- 단위: 보통 바이트 또는 비트.
- 의미: RTT 동안 파이프에 쌓일 수 있는 데이터량.

TCP 처리량은 대략:

$$
\text{Throughput} \lesssim \frac{\text{MSS}}{\text{RTT}} \times \text{동시 스트림 수}
$$

- 여기서 **MSS가 MTU에 의해 제한**되므로,
- L2의 **MTU/태그/오버레이/큐잉**이 L4 처리량에 직접적인 영향을 준다.

---

## 10. 현장 베스트 프랙티스(요약 카드)

마지막으로, 현장에서 그대로 가져다 쓸 수 있는 요약형 가이드를 정리한다.

### 10.1 VLAN

- Trunk 포트의 **Allowed VLAN/Natural VLAN 양단 일치** 필수.
- VLAN 설계/포트 매핑을 도면/문서로 관리.
- 사용자/업무망, 서버망, 관리망 등을 **VLAN으로 분리**하고 방화벽/ACL로 L3 제어.

### 10.2 STP/RSTP

- 명확한 **루트 브리지** 지정(코어/중앙 장비).
- 엣지 포트는 **PortFast + BPDU Guard** 조합 사용.
- 루프 위험이 있는 구간에 **Root Guard/Loop Guard** 활용.
- STP 이벤트(TC, 루트 변경)를 모니터링 시스템에 연동.

### 10.3 LAG

- 가능하면 **LACP 기반 LAG** 사용(정적 LAG보다 가시성/안정성↑).
- 멤버 링크의 속도/듀플렉스/에러 상태를 일치시키고 정기 점검.
- 해시 기준을 애플리케이션 패턴에 맞게 조정(5-튜플, IP 기반 등).
- LAG 위에 또 다른 ECMP/L3 분산이 있다면 전체 구조를 문서화.

### 10.4 MTU

- 경로별 **표준 MTU**를 정의(예: DC 내부 9000, 외부 1500).
- VLAN 태그·오버레이를 고려해 **실효 MTU**를 계산.
- TCP 서비스 구간에 **MSS 클램핑** 적용.
- ICMP Frag Needed/Too Big 트래픽을 막지 않도록 방화벽 정책 점검.

### 10.5 Storm/보안

- 브로드캐스트/멀티캐스트/유니캐스트 각각에 **Storm Control** 임계값 설정.
- Port-Security로 MAC 수 제한, 허용 범위 밖 MAC에 대해 알람/차단.
- 사용자 단에서 임의 허브/스위치 설치를 정책적으로 관리.

### 10.6 가시성·운영

- MAC/ARP/IGMP/Spanning-Tree/LACP 로그와 카운터를 주기적으로 수집.
- STP Topology Change, MAC 플래핑, Storm Control 이벤트에 알람 설정.
- 네트워크 변경(Trunk VLAN 수정, 펌웨어 업그레이드 등)은 **변경창(change window)** 내에 수행하고 롤백 플랜을 준비.

---

## 11. 한 장 요약(포스터 버전)

- **MAC 학습 & 스위칭**:  
  - 출발지 MAC을 포트에 학습, 목적지 MAC에 따라 포워딩.  
  - Unknown Unicast는 Flood → CAM 안정성이 중요.

- **VLAN**:  
  - 브로드캐스트 도메인 분리.  
  - Trunk/Access/Native VLAN 일관성은 필수.

- **MTU**:  
  - 태그/오버레이로 실효 MTU 감소.  
  - PMTUD/MSS 조정 없으면 “큰 응답만 실패”하는 블랙홀이 생긴다.

- **LAG**:  
  - 합산 대역폭과 이중화를 제공하지만, 보통 **흐름 단위 분산**이므로  
    **1 flow ≈ 1 link 속도**다. 해시 편향에 주의.

- **STP/RSTP/MSTP**:  
  - L2 루프 방지의 생명선.  
  - 토폴로지 변경 시 CAM 재학습으로 인한 **순간 끊김**을 이해하고, 로그/알람을 관리.

- **L2 문제는 L3/L7에서 나타난다**:  
  - VLAN/MTU/루프/LAG 편향 문제는 최종적으로 **핑/HTTP 타임아웃, 일부 사용자만 느림, 전체 다운** 같은 형태로 드러난다.  
  - 항상 **L2부터 확인하는 습관**을 갖는 것이 장애 대응 시간을 크게 줄인다.

---

## 부록 A — 자주 쓰는 용어 요약

- **CAM/MAC 테이블**: MAC→포트 매핑을 저장하는 테이블.
- **Unknown Unicast Flood**: 목적지 MAC을 모를 때 VLAN 전체로 살포.
- **PCP/DEI/VID**: 802.1Q 태그 필드(우선순위/Drop 가능/ID).
- **Native VLAN**: Trunk에서 언태그 프레임이 속하는 VLAN(벤더 용어).
- **QinQ**: 2중 태깅(802.1ad, S-TAG + C-TAG).
- **LACP**: 링크 어그리게이션 제어 프로토콜.
- **TCN/TC**: STP 토폴로지 변경 알림(Topology Change Notification/Flag).
- **Storm Control**: 브로드/멀티/유니캐스트 트래픽 임계치 기반 제어.

---

## 부록 B — 운영 관찰 템플릿

```text
[장소/날짜] 2025-xx-xx, DC-1 리프스위치 장애

[변경/이벤트] 
- 전날 야간: 리프-스파인 Trunk VLAN 허용 목록 수정
- 오늘 오전: 일부 사무동 사용자 인터넷 끊김 신고

[증상] 
- 특정 구역에서만 외부 접속 안 됨
- 같은 서브넷 일부 호스트는 정상, 일부는 실패
- 큰 파일 다운로드 타임아웃

[L2 가설] 
- VLAN 미스매치 (Trunk 허용 VLAN 불일치)
- MTU 불일치(오버레이/태그로 인한 PMTUD 문제)
- LAG 해시 편향 또는 멤버 다운

[근거] 
- show interfaces trunk: 리프-스파인 링크의 allowed VLAN 차이 발견
- ping -M do -s 1400 테스트: 특정 경로에서만 실패
- show etherchannel: 멤버 #2가 down 상태, #1만 과부하

[조치] 
- Trunk allowed VLAN 일치시키고, Native VLAN 통일
- 경로 MTU 재정의 및 MSS 클램핑 적용
- LAG 멤버 링크 복구 후 상태 모니터링

[결과] 
- 즉시 통신 정상화
- 재발 방지: VLAN/MTU/LAG 설계 문서 업데이트, 모니터링 룰 추가
- 변경 작업 시 사전/사후 체크리스트 강화
```