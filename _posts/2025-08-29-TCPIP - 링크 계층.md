---
layout: post
title: TCPIP - 링크 계층
date: 2025-08-29 16:25:23 +0900
category: TCPIP
---
# 2. 링크 계층 제대로 이해하기
**(🔰 MAC·스위칭·브로드캐스트/유니캐스트, ⚙️ VLAN·트렁크/액세스·MTU, 🚀 LAG·STP/RSTP·L2→L3 영향)**

> 이 글은 L2(링크 계층)를 **현업 감각**으로 정리합니다.
> “MAC 학습 → 스위칭 → 브로드캐스트 도메인 → VLAN 분할 → MTU → LAG → STP/RSTP(루프 방지)”의 흐름으로, **예제·관찰 포인트**를 중심으로 설명합니다.
> 코드 대신 **텍스트 다이어그램/명령 개념/수치**를 씁니다. 수식은 MathJax로 표기합니다.

---

## 2.1 MAC 주소, 스위칭, 브로드캐스트/유니캐스트 (🔰)

### 2.1.1 MAC 주소 한눈에
- **EUI-48**(일반적): `aa:bb:cc:dd:ee:ff` (48비트)
- 앞 24비트 **OUI**(제조사 식별), 뒤 24비트 **디바이스 고유**
- **특수 주소**
  - **브로드캐스트**: `ff:ff:ff:ff:ff:ff` (LAN 내 모든 호스트)
  - **멀티캐스트**(L2): 최상위 비트(IG bit=1)인 MAC (예: IPv4 멀티캐스트 매핑)
  - **유니캐스트**: 특정 NIC의 고유 MAC
- **비트 의미(상위 바이트)**
  - **I/G bit**: 0=개별(유니캐스트), 1=그룹(멀티/브로드캐스트)
  - **U/L bit**: 0=전역(공장 할당), 1=로컬 관리(수동 설정 MAC)

### 2.1.2 스위칭의 핵심: **MAC 학습(Learning) → 포워딩(Forward) → 필터(Filter) → 플러딩(Flood)**
- 스위치는 **수신 프레임의 출발지 MAC**을 `입력포트→MAC`으로 **CAM 테이블**에 학습(에이징 타이머 존재).
- **목적지 MAC이 테이블에 있으면 지정 포트로 포워딩**, 없으면 **Unknown Unicast Flood**(모든 포트로 브로드캐스트처럼 살포).
- **브로드캐스트/ARP** 등은 **VLAN(브로드캐스트 도메인)** 내 **모든 포트**로 전달.

#### 예제 A — “스위치가 MAC을 어떻게 배우는가”
```text
PC-A(MAC A) —[Port1]— Switch —[Port2]— PC-B(MAC B)

1) A→B 첫 프레임: Switch는 src=A를 Port1에 학습. dst=B를 모름 → Port2로 Flood.
2) B가 응답: Switch는 src=B를 Port2에 학습. 이제 A↔B는 단일 포워딩.
3) 시간이 지나 통신이 없으면 A,B 엔트리는 Aging으로 사라진다.
```

### 2.1.3 브로드캐스트·유니캐스트의 체감
- **브로드캐스트**(예: ARP 요청)는 **도메인 전체**로 전파 → **모든 호스트 CPU 인터럽트** 유발 → 과도하면 **브로드캐스트 스톰**.
- **유니캐스트**는 대상 포트로만 전달 → 불필요한 부하 없음.
- **멀티캐스트**는 스위치가 IGMP 스누핑 등으로 **필요 포트만** 전달하도록 최적화 가능(미구성 시 브로드캐스트에 준해 퍼질 수 있음).

### 2.1.4 자주 보는 L2 이상 신호
- **MAC 플래핑**: 동일 MAC이 서로 다른 포트에서 번갈아 관측 → **루프** 또는 **이중 연결 오배선** 의심.
- **Unknown Unicast Flood 증가**: CAM 용량/에이징 미스매치, 루프, 과도한 동적 호스트.
- **ARP 폭증**: 게이트웨이/핫스팟/프록시 오동작, 스캔, 루프. L3 체감은 **핑 지연·타임아웃**.

---

## 2.2 VLAN(802.1Q), 트렁크/액세스 포트, MTU 개념 (⚙️)

### 2.2.1 VLAN: L2를 **논리적 네트워크**로 분리
- **VLAN = 브로드캐스트 도메인 분리**. 같은 VLAN끼리만 브로드캐스트가 도달.
- **Access 포트**: 단일 VLAN에 **언태그(untagged)** 프레임로 연결(끝단 호스트용).
- **Trunk 포트**: 다수 VLAN을 **태그(tagged)**로 동시에 전송(스위치↔스위치/스위치↔서버).

#### 802.1Q 태그 구조(4바이트가 프레임에 삽입)
- **TPID**: `0x8100` (VLAN 태그 식별자)
- **TCI**: 16비트
  - **PCP(3b)**: 802.1p 우선순위(0~7)
  - **DEI(1b)**: Congestion/Drop Eligible
  - **VID(12b)**: VLAN ID(1~4094, 0=언태그, 4095 예약)

> **주의**: VLAN 태그 **4바이트**가 들어가므로, **이더넷 프레임 길이**가 커지고 **유효 MTU**에 간섭.

### 2.2.2 트렁크/액세스 포트 운영 포인트
- **Access**: 포트는 하나의 VLAN만. 호스트는 태그를 인지하지 못함(언태그 프레임 수수).
- **Trunk**: 포트는 **여러 VLAN 허용 목록(Allowed VLANs)**을 가짐.
  - **Native VLAN**(벤더 용어): 트렁크에서 **태그 없이** 전송되는 VLAN. 혼용/불일치 시 **VLAN 이중화/혼선** 발생.
- **QinQ(802.1ad)**: **S-TAG(서비스)** + **C-TAG(고객)** 2중 태깅으로 L2VPN/사업자 네트워크에서 사용.

#### 예제 B — “트렁크 허용 VLAN 불일치”
```text
Switch-1 Trunk Gi1/0/1: allow VLANs 10,20
Switch-2 Trunk Gi1/0/1: allow VLANs 10      (20 빠짐)

VLAN 10: 정상 통신
VLAN 20: S1↔S2 간 프레임이 차단 → 서로 다른 층/건물 호스트끼리 통신 불가
체감: "같은 서브넷인데 어떤 구역만 핑이 안됨" (L3 증상처럼 보이지만 원인은 L2)
```

### 2.2.3 VLAN과 MTU
- 표준 이더넷 **L3 MTU 1500바이트**. VLAN 태그(4B)로 프레임이 커져도 보통 스위치는 **Baby Giant**를 허용.
- **다중 태그(QinQ/MPLS)**, **GRE/VXLAN** 등 오버레이 시 **헤더 누적**로 실효 MTU 감소.
  - **MSS 클램핑**(TCP 옵션 조절)으로 응용단 끊김 방지.
  - 경로 중 일부 장비가 **태그/오버헤드**를 고려하지 않으면 **PMTUD 블랙홀**.

#### 예제 C — “태그/오버레이로 MTU 블랙홀”
```text
App는 1460B MSS에 맞춰 전송하지만,
중간에 QinQ(+4B) + VXLAN(+50B 내외) → 실효 MTU가 1400B 미만 필요
→ DF(분할금지) 상태로 큰 세그먼트가 지나가다 Drop
증상: "작은 API는 되고 큰 응답은 뚝 끊김" (L3/HTTP 문제처럼 보임)
조치: 경로 MTU 정합, MSS 클램핑, 테넌트 네트워크 MTU 표준화
```

---

## 2.3 LAG(링크 집성), STP/RSTP(루프 방지) 개요 (🚀)

### 2.3.1 LAG(IEEE 802.1AX/옛 802.3ad): **여러 물리 링크를 하나의 논리 링크로**
- **목적**: 대역폭 확장, 이중화(한 링크 장애 시 지속), 트래픽 분산.
- **Static LAG** vs **LACP**(Link Aggregation Control Protocol)
  - LACP: `active/passive` 조합으로 **자동 협상**, 구성·장애 감지 유리.
- **해싱 분산**: 일반적으로 **흐름 단위**(Src/Dst MAC/IP/Port 조합)로 링크 선택
  - **단일 TCP 흐름은 보통 한 물리 링크만 사용** → “1 flow = 1 link 속도”
  - 다수 흐름이면 링크들에 분산되어 **총합 처리량** 향상

#### 예제 D — “절반의 연결만 느린 LAG”
```text
2링크 LAG(각 10G). 해싱키: src/dst IP+포트.
- 특정 백엔드로 가는 트래픽의 '딱 절반'만 1번 링크에 집중 → 혼잡
- 나머지 절반은 2번 링크로 가서 정상
체감: "같은 서비스, 같은 시간대인데 사용자 절반만 느림" (L7 이슈처럼 보임)
해결: 해시 기준 다양화(5-튜플), LAG 멤버 증설, ECMP 조합, 서버 측 연결 샤딩 조정
```

### 2.3.2 STP(802.1D)/RSTP(802.1w)/MSTP(802.1s): **루프 방지**
- **왜 필요한가?** L2는 TTL 개념이 없어 **루프가 생기면 브로드캐스트/Unknown Unicast가 무한 증폭** → **스톰**.
- **루트 브리지 선출**: **Bridge ID(우선순위 + MAC)**가 가장 작은 스위치가 루트.
- **포트 역할/상태**
  - STP: **Root/Designated/Non-designated**, 상태 **Blocking → Listening → Learning → Forwarding**
  - RSTP: 상태 단순화(**Discarding → Learning → Forwarding**), **빠른 수렴**(전형적으로 1~3초대)
- **경로 비용(Path Cost)**: 링크 속도에 따라 가중치 → 총 비용이 가장 낮은 경로만 **Forwarding**, 나머지는 **Blocking**
- **BPDUs**: STP/RSTP 제어 프레임. **BPDU Guard**, **Root Guard**, **Loop Guard**, **PortFast** 등 보조 기능 중요.

#### 예제 E — “현장에서 흔한 루프”
```text
1) 책상 밑 미니 허브를 사용자가 설치 → 허브 두 포트를 서로 패치
2) STP 미동작/엣지 포트에서 BPDU 차단 → 루프 형성
3) 수 초 내 스톰 → 브로드캐스트/Unknown Unicast 급증 → CPU/링크 포화
체감: "사무실 전체 인터넷 멈춤" (L3/DNS 장애처럼 보이지만 원인은 L2)
대응: 포트 보안, BPDU Guard/PortFast, Edge 포트 정책, 스톰 컨트롤, 사용자 장비 가이드
```

#### 예제 F — “STP 토폴로지 변경(Topology Change) 후유증”
```text
STP TC(Topology Change) 발생 → 스위치가 CAM 에이징 타임을 순간적으로 낮춤(예: 15초)
→ 기존 MAC 경로가 사라졌다가 재학습
체감: "갑자기 수 초~수십 초간 끊김/세션 재수립" (TCP 세션 리셋, 애플리케이션 오류)
관찰: 스위치 로그의 TCN/TC Flag, CAM 테이블 변동 패턴
```

---

## 2.4 L2 문제의 L3 체감 효과 — “진짜 원인은 아래층” (🚀)

| **L2 원인** | **겉 증상(L3/L7)** | **현장 설명** | **1차 체크** |
|---|---|---|---|
| VLAN 트렁크 허용 목록/Native VLAN 불일치 | “같은 서브넷 일부만 핑/접속 실패” | 중간 스위치 간 VLAN 전파 단절 | 트렁크 설정 양단 비교, VLAN 맵 |
| MTU/오버레이/태그로 인한 PMTUD 블랙홀 | “작은 응답 OK, 큰 응답 끊김/타임아웃” | DF+큰 세그먼트가 중간에서 Drop | 경로 MTU·MSS, ICMP Too Big 유무 |
| 브로드캐스트 스톰/루프 | “사무실 전체 인터넷 다운/핑 폭증” | L2 스톰으로 CPU/링크 포화 | STP/RSTP 상태, 스톰 컨트롤, MAC 플래핑 |
| MAC 플래핑 | “세션이 간헐적으로 끊김” | 동일 MAC이 포트를 번갈아 출현 | 스위치 로그/`MAC Move` 이벤트 |
| LAG 해시 불균형/멤버 다운 | “일부 사용자만 느림” | 특정 흐름 집적 → 멤버 과부하 | LACP 상태, 멤버 사용률, 해시 기준 |
| ARP/NDP 이상(폭증/스캔) | “간헐적 타임아웃, 지연” | 브로드캐스트 증가로 인터럽트 폭증 | ARP/NDP 통계, 보안·스캔 여부 |
| IGMP 스누핑 미구성 | “멀티캐스트 트래픽이 전부에 흘러감” | 사실상 브로드캐스트화 | IGMP Snooping/Querier 설정 |

---

## 2.5 운영·디버깅 체크리스트

### 2.5.1 스위치 공통
```text
[MAC/CAM]
- show mac address-table (또는 이와 유사) : 학습된 MAC, VLAN, 포트
- MAC 플래핑/Move 로그 확인

[VLAN/트렁크]
- show vlan brief : VLAN 존재/포트 매핑
- show interfaces trunk : 트렁크 여부/허용 VLAN/네이티브 VLAN
- 구간별 VLAN 일관성 (Access/Trunk, Allowed, Native) 비교

[STP/RSTP]
- show spanning-tree : 루트 브리지, 포트 역할/상태, 비용
- TCN/TC 이벤트, BPDU Guard/Root Guard 동작 확인

[LAG/LACP]
- show etherchannel / show lacp : 멤버 상태, 해시, 불균형 트래픽
- 각 멤버 링크 에러/드롭/속도/듀플렉스 확인

[Storm/보안]
- storm-control 정책/카운터
- port-security(허용 MAC, 위반 로그)
```

### 2.5.2 호스트/서버 측(개념)
```text
- NIC 설정: 속도/듀플렉스/MTU
- VLAN 태깅: 서버 NIC/하이퍼바이저의 VLAN ID/Trunk 프로파일
- 경로 MTU: 큰 패킷 + DF로 테스트, ICMP Too Big 수신 여부
- 연결수/에페메럴 포트(대량 연결 서비스), ARP 캐시 안정성
```

### 2.5.3 “문제가 L2인지부터 가른다” 루틴
```text
1) 같은 VLAN 내 핑/브로드캐스트 동작 확인 (기본 게이트웨이 불필요 테스트)
2) 다른 VLAN(=L3 경유)과 비교 — 같은 증상? 아니면 L3에서만 발생?
3) 트렁크/네이티브 VLAN/허용 VLAN 일치 여부 확인
4) STP/RSTP 이벤트 기록(최근 TC/차단/루프 여부)
5) MTU/MSS/오버레이 경로 차이 점검 (작은 vs 큰 패킷)
6) LAG 멤버/해시 분산/한 멤버 과부하 여부
```

---

## 2.6 미니 실습 과제(의도 중심)

### 2.6.1 “VLAN 미스매치 찾기”
```text
의도: L3처럼 보이는 단절의 L2 원인 식별
방법: 양단 트렁크의 allowed/native VLAN 비교, Access 포트 VLAN 매핑 점검
성공: 허용 목록/Native 일치 후 즉시 통신 정상화
```

### 2.6.2 “MTU 블랙홀 재현”
```text
의도: 작은 요청 OK, 큰 응답 Fail 현상 이해
방법: 큰 패킷(DF 설정) 전송 → ICMP Too Big 관찰, MSS 클램핑 전후 비교
결과: 경로 MTU 불일치가 HTTP 타임아웃으로 보이는 매커니즘 체득
```

### 2.6.3 “LAG 해시 편향 관찰”
```text
의도: 일부 사용자만 느린 이유 파악
방법: 동일 목적지에 다수 흐름 생성, 각 멤버 링크 트래픽/큐 상태 비교
결과: 해시 편향/멤버 장애/속도 불일치 등 원인 도출
```

### 2.6.4 “STP 토폴로지 변경 감지”
```text
의도: 사용자 '순간 끊김'과 STP의 상관 파악
방법: 스위치 로그에서 TCN 발생 시각과 사용자 장애 시각 매칭
결과: CAM 에이징·재학습으로 인한 세션 영향 이해
```

---

## 2.7 숫자 감각 & 수식 메모

- **프레임 길이**(대략):
  \[
  \text{L2 Frame} \approx \text{L2 Header}(14\text{B}) + \text{802.1Q}(4\text{B,옵션}) + \text{L3}(20\text{B IPv4/40B IPv6}) + \text{L4}(20\text{B TCP}) + \text{Payload} + \text{FCS}(4\text{B})
  \]
  → 태그/오버레이가 붙을수록 **유효 Payload** 감소 → **MSS↓**, **PMTUD** 의존↑.

- **BDP**(대역폭×RTT)와 **윈도우/큐**는 L4에서 중요하지만, L2의 **MTU/오버레이/큐잉**이 L4 처리량에 직접 간섭:
  \[
  \text{Throughput} \lesssim \frac{\text{MSS}}{\text{RTT}} \times \text{동시 스트림 수} \quad (\text{혼잡·손실·큐 영향 포함})
  \]

---

## 2.8 현장 베스트 프랙티스(요약 카드)

- **VLAN**: Allowed/Native **양단 일치**. 문서화(도면·포트맵). 접속·업무망 분리.
- **STP/RSTP**: **PortFast**(엣지), **BPDU Guard/Root Guard/Loop Guard**. 루트 브리지 명확화.
- **LAG**: **LACP** 권장, 멤버 균형·링크 품질 일치, 해시 기준 적절화(5-튜플 등).
- **MTU**: 경로 단위 표준화, **오버레이/태그 고려 MTU**, **MSS 클램핑**.
- **Storm/보안**: 브로드캐스트/멀티캐스트/유니캐스트 스톰 컨트롤, **port-security**.
- **가시성**: MAC/ARP/IGMP/Spanning-Tree/LACP **로그·지표** 상시 수집, **TC/플래핑** 알람.
- **변경관리**: 트렁크 허용 VLAN 수정·펌웨어 업그레이드 시 **변경창** 운영, 롤백 플랜.

---

## 2.9 한 장 요약(포스터 버전)

- **MAC 학습 & 스위칭**: Unknown Unicast는 Flood → CAM 안정성 중요.
- **VLAN**: 브로드캐스트 도메인 분리. Trunk/Access/Native 일관성 필수.
- **MTU**: 태그·오버레이로 실효 MTU 감소 → PMTUD/MSS 조정 없으면 **큰 응답만 실패**.
- **LAG**: 합산 대역폭/이중화. **흐름 단위 분산**이라 1 flow=1 link 속도.
- **STP/RSTP**: 루프 방지의 생명선. TC 후 CAM 재학습에 의한 **순간 끊김** 주의.
- **L2 문제는 L3처럼 보인다**: VLAN/MTU/루프/해시 편향이 **핑/HTTP 타임아웃**으로 체감.

---

### 부록 A — 자주 쓰는 용어

- **CAM/MAC 테이블**: MAC→포트 매핑
- **Unknown Unicast Flood**: 목적지 MAC 미학습 시 살포
- **PCP/DEI/VID**: 802.1Q 태그 필드
- **Native VLAN**: 트렁크에서 언태그로 흐르는 VLAN(벤더 용어)
- **QinQ**: 2중 태깅(802.1ad)
- **LACP**: LAG 제어 프로토콜
- **TCN/TC**: STP 토폴로지 변경 알림
- **Storm Control**: 브로드/멀티/유니캐스트 트래픽 임계치 제어

### 부록 B — 관찰 템플릿

[장소/날짜] [변경 여부/장애 발생 시각]
[증상] 일부 구역 통신불가 / 큰 응답만 타임아웃 / 절반만 느림 / 전사 다운
[L2 가설] VLAN 미스매치 / MTU 불일치 / 루프 / LAG 편향
[근거] STP 로그(TC/BLK), MAC 플래핑, trunk allowed diff, ICMP Too Big, LACP 상태
[조치] 허용 VLAN 조정, MSS 클램핑, PortFast+BPDU Guard, LAG 멤버/해시 조정
[결과] 복구 시간, 후속 예방(문서화·모니터링 룰)
