---
layout: post
title: 정보보안기사 - 네트워크 가시성/로깅
date: 2025-11-09 14:25:23 +0900
category: 정보보안기사
---
# 네트워크 가시성/로깅(NetFlow/IPFIX, SPAN/TAP)

## 0) 한눈 개요

- **Flow(흐름)**: 5-tuple(Proto, Src/Dst IP, Src/Dst Port) + 바이트/패킷/시간/플래그 등 **요약 메타데이터**  
- **NetFlow**: v5(고정) / v9(템플릿). **IPFIX**: IETF 표준(템플릿 기반, 필드 확장성↑)  
- **SPAN/TAP**: **패킷 원본** 미러링(디코딩/포렌식/IDS 입력에 적합). 성능/저장 비용↑  
- **현실 배치**: **L3/경계·코어 = Flow**, **문제 구간/앱 디버깅 = SPAN/TAP** 로 **계층화**  
- **지속 운영 핵심**: **타임싱크(NTP)**, **샘플링/타임아웃 튜닝**, **저장 용량 계산**, **대시보드/경보**

---

# 1) Flow(흐름) 기본: NetFlow vs IPFIX vs sFlow

## 1.1 Flow가 담는 것
- **키**: L3/L4 5-tuple, Ingress/Egress ifIndex  
- **수치**: bytes, packets, duration(start/end), TCP flags, ToS/DSCP  
- **부가**: NAT 변환 전/후, BGP AS/path, next-hop, VLAN, App-ID(벤더 확장)

## 1.2 버전/프로토콜
| 항목 | NetFlow v5 | NetFlow v9 | **IPFIX** |
|---|---|---|---|
| 구조 | 고정 필드 | 템플릿 | **표준 템플릿**(IANA 기업/엔터프라이즈 필드) |
| 확장 | 제한적 | 높음 | **최고**(동적/커스텀) |
| 전송 | UDP:2055 등 | UDP | UDP(기본)/SCTP/TCP 가능 |
| 상태 | 구형·단순 | 현행 | **권장** |

> **권장**: 새 배포는 **IPFIX** 또는 **Flexible NetFlow(v9 기반)**.

## 1.3 sFlow 한 줄 비교
- 패킷 **샘플 + 카운터**(L2~L4). **고속 포트**에 가벼움.  
- 하지만 “플로우” 자체가 아니라 샘플 패킷 → **용도/해석이 다름**. (본 문서는 NetFlow/IPFIX 중심)

---

# 2) 흐름 생성 로직(타임아웃/샘플링/카운팅)

## 2.1 Active/Inactive 타임아웃
- **Inactive**: 동일 플로우에 **새 패킷이 없으면** 이 시간 뒤 **닫음**(예: 15s)  
- **Active**: 장기 플로우라도 **주기적으로 쪼개어 내보냄**(예: 60s) → 실시간성/메모리 관리

## 2.2 샘플링(1:N)
- 고속 환경에서 **1:N 패킷 샘플링**. 보고값으로 **실측 추정**:  
  $$ \text{추정 바이트} \approx \text{보고 바이트} \times N \quad,\quad \text{추정 패킷} \approx \text{보고 패킷} \times N $$
- 샘플링은 **탑토커/용량 경향**엔 유효, **짧은 플로우/희귀 이벤트**엔 불리 → **혼합 전략** 필요.

## 2.3 레코드 크기·저장량 근사
- 대략 **40~120B/레코드**(필드 구성/템플릿 차이)  
- 10k flows/s, 80B/flow → **~800 kB/s ≈ 2.9 GB/h ≈ 70 GB/day**(압축 전)  
- 저장·인덱스·보관 주기(예: 30/90/365일) **미리 계산** → 저비용 스토리지/압축 조합

---

# 3) Cisco IOS/IOS-XE — NetFlow/IPFIX/Flexible NetFlow

## 3.1 Classic NetFlow v5(간단/구형, 여전히 유효)
```cisco
ip flow-export destination 192.0.2.50 2055
ip flow-export version 5
ip flow-cache timeout active 60
ip flow-cache timeout inactive 15
!
interface GigabitEthernet0/0
 ip flow ingress
 ip flow egress
```
- **장점**: 빠른 도입. **단점**: 필드 확장성↓, NAT/BGP 심화 필드 제한.

## 3.2 Flexible NetFlow(v9/IPFIX 유사, 권장)
```cisco
! 1) Flow Record 정의
flow record REC_L3L4
 match ipv4 source address
 match ipv4 destination address
 match transport source-port
 match transport destination-port
 match ip protocol
 match interface input
 collect counter bytes long
 collect counter packets long
 collect transport tcp flags
 collect timestamp absolute first
 collect timestamp absolute last
 collect ip dscp

! 2) Exporter (IPFIX 예)
flow exporter EXP_IPFIX
 destination 192.0.2.50
 transport udp 4739
 export-protocol ipfix
 template data timeout 60
 option interface-table timeout 600

! 3) Monitor 묶기
flow monitor MON_L3L4
 exporter EXP_IPFIX
 record REC_L3L4
 cache timeout active 60
 cache timeout inactive 15

! 4) 인터페이스 적용
interface TenGigabitEthernet1/0/1
 ip flow monitor MON_L3L4 input
 ip flow monitor MON_L3L4 output
```

## 3.3 NAT/BGP/샘플링(가능한 장비)
```cisco
flow record REC_PLUS
 match ipv4 source address
 match ipv4 destination address
 match transport source-port
 match transport destination-port
 match ip next-hop
 match bgp next-hop
 collect nat event
 collect ipv4 source address post-nat
 collect ipv4 destination address post-nat
 collect transport source-port post-nat
 collect transport destination-port post-nat
 collect routing next-hop address
```

---

# 4) Juniper Junos — J-Flow(=NetFlow) / IPFIX

## 4.1 기본 샘플링 + Export
```junos
set forwarding-options sampling input rate 1000                 # 1:1000 패킷
set forwarding-options sampling family inet output flow-server 192.0.2.50 port 2055
set forwarding-options sampling family inet output version-ipfix
set forwarding-options sampling family inet output inline-jflow source-address 198.51.100.1
set forwarding-options sampling family inet output flow-server 192.0.2.50 template refresh-rate 30
set forwarding-options sampling family inet output flow-server 192.0.2.50 option-refresh-rate 30
```

## 4.2 인터페이스/패밀리 지정
```junos
set interfaces xe-0/0/0 unit 0 family inet sampling input
set interfaces xe-0/0/1 unit 0 family inet sampling output
```

> **팁**: 고속 포트는 **하드웨어 오프로드** 활용(지원 모델 확인). 템플릿/옵션 리프레시 주기를 짧게 → 수집기 템플릿 미스 방지.

---

# 5) Linux Exporter — softflowd / fprobe / ipfixprobe

## 5.1 softflowd(간단한 테스트에 좋음)
```bash
# 설치
sudo apt-get install -y softflowd
# eth0 트래픽을 NetFlow v9로 192.0.2.50:9995에 전송
sudo softflowd -i eth0 -n 192.0.2.50:9995 -v 9 -t maxlife=60,expiry=15
```

## 5.2 fprobe(경량 NetFlow v5)
```bash
sudo apt-get install -y fprobe
sudo fprobe -i eth0 192.0.2.50:2055
```

## 5.3 ipfixprobe(고급 IPFIX, 필드 풍부)
- 다양한 파서(TCP 옵션, HTTP 일부 헤더) 지원. (배포/빌드는 프로젝트 가이드에 따름)
- 고성능 수집·전송 파이프라인에서 **주력**.

---

# 6) Collector — nfdump/nfcapd, pmacct, (참고) YAF/SiLK

## 6.1 nfcapd + nfdump(가장 많이 쓰는 FLOWS 툴킷)

### Collector 기동
```bash
# 포트 4739(IPFIX)로 수신, 5분 롤 파일, 저장 디렉터리 /var/flows/ipfix
sudo mkdir -p /var/flows/ipfix
sudo nfcapd -w -l /var/flows/ipfix -p 4739 -T all -S 1
# -w: 포크 모드, -T: 모든 통계, -S: BPP(바이트/패킷) 스케일
```

### 조회 예제
```bash
# 최근 파일 자동 선택
nfdump -r /var/flows/ipfix/nfcapd.current -o long | head
# 상위 송신자(바이트 기준)
nfdump -R /var/flows/ipfix -s srcip/bytes -n 10
# 포트 443 트래픽만
nfdump -R /var/flows/ipfix 'dst port 443 and proto tcp' -s dstip/bytes -n 20
# 시간 범위
nfdump -R /var/flows/ipfix -t 2025/11/03.00:00-2025/11/03.23:59 -s dstip/bytes -n 20
# CSV로 내보내서 다른 툴로
nfdump -R /var/flows/ipfix -o csv 'proto tcp and (dst port 80 or dst port 443)' > web.csv
```

### Python 간이 분석(Top N 앱 포트)
```python
# flow_analyze.py
import csv, collections
c=collections.Counter()
with open("web.csv") as f:
    r=csv.DictReader(f)
    for row in r:
        c[row['dstport']] += int(row['bytes'])
for port, b in c.most_common(10):
    print(port, b)
```

## 6.2 pmacct — 수집→카프카/SQL/엘라스틱
```ini
# /etc/pmacct/pmacctd.conf (IPFIX 수집→Kafka로)
daemonize: true
plugins: kafka
kafka_output: json
kafka_broker: 127.0.0.1:9092
kafka_topic: ipfix.flows
aggregate: proto,src_host,dst_host,src_port,dst_port,tos,in_iface,out_iface
imt_path: /var/run/pmacctd.sock
```

## 6.3 (참고) YAF/SiLK
- **DPI 수준** 필드/보강, 대규모 배치. 학술/국방 커뮤니티에서 심도 있게 사용.  
- 러닝커브 있으나 **정밀 탐지/분석 파이프라인** 구축에 유리.

---

# 7) SPAN/TAP — 패킷 미러링

## 7.1 SPAN의 개념과 한계
- **스위치가 소프트웨어로 복제**해 미러 포트로 내보냄(로컬/RSPAN/ERSPAN)  
- 과부하/우선순위에 따라 드랍/타이밍 왜곡 가능, **FCS에러/물리 결함 프레임**은 대개 제외

## 7.2 Cisco SPAN 설정 예

### 로컬 SPAN
```cisco
monitor session 1 source interface Gi1/0/1 - 8 both
monitor session 1 destination interface Gi1/0/48
```

### VLAN 기반 SPAN(트렁크 필터링)
```cisco
monitor session 2 source vlan 10 , 20 both
monitor session 2 destination interface Gi1/0/47
```

### RSPAN(스팬 VLAN으로 원격 전송)
```cisco
vlan 999
 remote-span
!
monitor session 3 source interface Gi1/0/1
monitor session 3 destination remote vlan 999
! 원격 스위치
monitor session 3 source remote vlan 999
monitor session 3 destination interface Gi2/0/48
```

### ERSPAN(Nexus/IOS-XE 일부, GRE로 터널링)
```cisco
monitor session 4 type erspan-source
 source interface Ethernet1/1 both
 destination
  erspan-id 100
  ip address 198.51.100.30
  origin ip address 198.51.100.10
```

## 7.3 Juniper Port-Mirroring(예)
```junos
set ethernet-switching-options analyzer MON src-port ge-0/0/1
set ethernet-switching-options analyzer MON input rate 100
set ethernet-switching-options analyzer MON output interface ge-0/0/24
```

## 7.4 TAP(하드웨어)
- **패시브**(광 분기/전기 신호 분배): **손실 거의 없음**, FCS/에러 프레임 포함  
- **Aggregation TAP**: 다수 링크 → 1/2 링크로 병합(오버섭스크립션 주의)  
- **권장**: 포렌식/규제 준수/정확 측정 필요시 **TAP** 우선

---

# 8) SPAN/TAP 캡처·분석

## 8.1 tcpdump/Wireshark
```bash
# 10G 미러 NIC에서 http 헤더만
sudo tcpdump -i ens9 -s 256 -w /pcap/web_$(date +%F).pcap 'tcp port 80 or 443'
# 양 많으면 ring buffer
sudo tcpdump -i ens9 -C 500 -W 10 -w /pcap/roll.pcap
```
- Wireshark **Decode As**: “NetFlow(IPFIX)” 포트 지정(2055/4739)으로 템플릿/레코드 검증

## 8.2 IDS/IPS 연계
- **SPAN/TAP** → Suricata/Zeek 입력 → L7 메타/알림  
- 플로우에서는 **탐지한 이벤트만** 상관분석(Flow+Alert Join)로 대역폭 절감

---

# 9) 설계·용량·정확도 계산

## 9.1 샘플링이 미치는 영향
- **탑토커/용량 계획**: 충분히 정확(표본 크기↑)  
- **짧은 공격/스캔**: 누락 가능 → **핫스팟 구간만 무샘플**(정책적 혼합)

## 9.2 저장량 근사(수식)
$$
\text{일일 저장량(GB)} \approx \frac{\text{flows/s} \times \text{record size(byte)} \times 86400}{10^9}
$$
- 예: 20k flows/s, 90B → $20{,}000 \times 90 \times 86400 \approx 155\,GB/day$ (압축前)

## 9.3 활성/비활성 타임아웃 가이드
- **Inactive=15s**, **Active=60s**(일반)  
- 장수 커넥션(DB/터널)은 **Active 300s** 등으로 조정 → 레코드 수 급증 예방

---

# 10) 보안/신뢰성 — 전송·무결성·프라이버시

- **수집기까지 경로 보호**: ERSPAN+IPsec, **IPFIX over DTLS/TLS**(지원 시)  
- **화이트리스트 수집기 IP**(ACL/방화벽), **QoS**로 템플릿/컨트롤 보전  
- **PII 최소화**: 내부 IP/도메인 해시·비식별, 보존 기간 정책(예: 30/90/365일 계층화)  
- **NTP** 필수: 라우터/스위치/수집기 시각 일치 → 상관관계/경보 정확도↑

---

# 11) 엔드투엔드 랩 — “코어 Flow + 문제구간 SPAN”

## 토폴로지
```
[Edge Router] -- [Core L3] -- [Access SW] -- Clients/Servers
         \           |
          \--(ERSPAN)--> [Capture VM]
                 \
                (IPFIX)--> [nfcapd/nfdump on Collector]
```

## 단계
1) **Core**에 **Flexible NetFlow(IPFIX)** 적용(ingress/egress, DSCP·VLAN 포함)  
2) **Collector(nfcapd)** 4739 수신, **nfdump**로 대시보드/스크립트  
3) 돌발 **지연↑** 구간(예: VLAN 20)만 **SPAN**으로 캡처 → HTTP 재시도/MTU 이슈 확인  
4) 결과: **Flow**로 “누가/얼마나/어디로”, **SPAN**으로 “왜” 확인

---

# 12) 운영 대시보드/경보 아이디어

- **Top Talkers/Receivers/AS/IF** (1m/5m/1h)  
- **DSCP 별 사용률**(VoIP, 미션크리티컬)  
- **새로운 Dst/Port 출현 알림**(화이트리스트 외)  
- **국가/ASN 분포 급변**(외부향)  
- **TCP 실패율**(SYN→RST/FIN 비율, ReTX 근사)  
- **템플릿 미스/로스율**(수집기 메트릭)

**nfdump 예: 새 목적지 포트 모니터**
```bash
# 최근 5분, 미리 정의한 안전 포트 외의 Dst Port TOP 10
SAFE="80,443,22,53,123,587,993,995"
nfdump -R /var/flows/ipfix -t now-5m-now 'not dst port in ['$SAFE']' -s dstport/flows -n 10
```

---

# 13) 트러블슈팅 런북

- **Flow가 안 들어옴**:  
  - 라우터 → 수집기 **UDP 포트**(2055/4739) **방화벽**?  
  - **템플릿 타임아웃** 너무 큼? 수집기 리셋 후 템플릿 미스? → 템플릿 주기 30~60s  
  - **샘플링/타임아웃** 과도 → 레코드 드문드문  
  - **CPU/ASIC 리소스** 과부하 시 Export Drop → 폴링/로그 확인
- **SPAN 드랍/왜곡**:  
  - 소스 대역폭 > 데스티네이션 포트 대역폭 → **오버섭스크립션**  
  - 필터 조건/VLAN 태깅 누락, **LAG** 구성 링크 전부 지정 필요
- **타임스탬프 오류**:  
  - **NTP** 확인(오차±1s 이내)  
- **수집 저장 부족**:  
  - 압축 저장( gzip/zstd ), 일일 롤오버, **보관주기 다단계**(Hot/Warm/Cold)

---

# 14) 보강: Logstash/Elasticsearch 파이프라인(간이)

## 14.1 Logstash IPFIX 입력(예)
```conf
input {
  udp {
    port => 4739
    codec => netflow {
      versions => [10]   # IPFIX
    }
    type => "ipfix"
  }
}
filter {
  mutate { convert => { "bytes" => "integer" "packets" => "integer" } }
}
output {
  elasticsearch { hosts => ["http://127.0.0.1:9200"] index => "ipfix-%{+YYYY.MM.dd}" }
  stdout { codec => rubydebug }
}
```

## 14.2 Kibana 시각화 아이디어
- Top dst.ip, Top src.as, bytes over time(1m)  
- 이상치 규칙: 특정 내부 호스트의 **야간 외부 전송 급증** 알림

---

# 15) 체크리스트(현장용)

- [ ] **IPFIX(또는 FNF)**, **Inactive=15/Active=60** 시작  
- [ ] **수집기 이중화**(Anycast/ECMP or 장애 시 보조)  
- [ ] **템플릿 주기 30~60s**, **옵션 템플릿** 포함  
- [ ] **샘플링**: 1:1(핵심) + 1:1000(백본) 혼용  
- [ ] **NTP 동기화**(모든 장비/수집기)  
- [ ] **보안**: 수집기 ACL, 전송 암호화(ERSPAN+IPsec/DTLS)  
- [ ] **보관 정책**: 30/90/365일 + 압축/요약 인덱스  
- [ ] **대시보드/경보** 출고(TopN, New Port, RTT Proxy, 템플릿 드랍)

---

# 16) 미니 과제(실습)

### A. Flexible NetFlow(IPFIX) + nfdump(20점)
- (8) 레코드: 5-tuple + DSCP + TCP flags + first/last  
- (6) nfdump로 Top Talkers/Port 출력  
- (6) Active/Inactive 변경 전/후 레코드 수 비교

### B. RSPAN/ERSPAN로 원격 캡처(20점)
- (8) RSPAN VLAN 구성/원격 수신  
- (6) ERSPAN로 GRE 수신(리눅스 `ip link add erspan` 또는 장비)  
- (6) 오버섭스크립션 발생 시 손실/시계열 스크린샷

---

# 17) 부록 스니펫 모음

## 17.1 Wireshark로 템플릿 확인 팁
- Display Filter: `cflow`(NetFlow v9) / `ipfix`  
- 템플릿 ID/필드 맵 확인 → 수집기 스키마 매핑 점검

## 17.2 Linux ERSPAN 수신(참고)
```bash
# erspan 수신 터널 인터페이스 생성(커널 지원 필요)
sudo ip link add erspan0 type erspan seq key 100 local 198.51.100.30 remote 198.51.100.10 erspan_ver 2
sudo ip link set erspan0 up
sudo tcpdump -i erspan0 -w erspan.pcap
```

## 17.3 nfdump 필터 치트시트
```bash
# 내부→외부만
nfdump -R /var/flows/ipfix 'src net 10.0.0.0/8 and not dst net 10.0.0.0/8'
# 특정 DSCP
nfdump -R /var/flows/ipfix 'tos 46'
# TCP 실패 비율 근사(예: SYN→RST)
nfdump -R /var/flows/ipfix 'flags S and not flags A'
```

---

## 마무리

- **Flow(IPFIX)** 는 **가벼운 가시성**의 뼈대, **SPAN/TAP**은 **정밀 포렌식/탐지**의 확대경입니다.  
- **템플릿/타임아웃/샘플링**만 잘 잡아도 대규모 네트워크에서 **지속 가능한 관측**이 가능합니다.  
- 시작은 **코어·경계에 IPFIX**, **문제 지점만 SPAN/TAP**, 그리고 **대시보드/경보**를 빠르게 운영하세요.