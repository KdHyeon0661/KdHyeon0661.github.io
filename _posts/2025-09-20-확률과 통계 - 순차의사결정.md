---
layout: post
title: 확률과 통계 - 순차의사결정
date: 2025-09-20 20:25:23 +0900
category: 확률과 통계
---
# 16) 순차의사결정 ― mSPRT·베이지안 밴딧 운영

> **목표**
> - **연속 모니터링**에서의 오류 통제: **SPRT/mSPRT**, **그룹 순차(Group Sequential)**, **α-spending**.  
> - **베이지안 밴딧**: **Thompson Sampling**, **UCB/KL-UCB**, **컨텍스트 밴딧**의 운영·가드레일·보고.  
> - **실무**: 지표 지연(딜레이), 비정상성(드리프트), 가드레일 KPI, 다중팔(M>2), 베스트암 식별 vs 후회(regret) 최소화.  
> - **함정**: “엿보기(peeking)”, **랜덤화 단위** 불일치, **지표 정의/오프셋** 누락, **다중검정**(팔/세그먼트/시간) 관리.

---

## 0) Hook — “매일 볼 건데, p-hacking 없이 멈출 수 없을까?”
전통 A/B의 고정 표본 설계는 **끝까지 모은 뒤 한 번**만 분석한다.  
하지만 제품 운영은 **매일(혹은 실시간)** 지표를 보며 **이득이 분명해지면 즉시 롤아웃**하고, **손해가 확실하면 즉시 중단**하고 싶다.  
이를 **형식적으로 허용**하는 것이 **순차분석**(sequential analysis)이며, 대표가 **SPRT/mSPRT**와 **그룹 순차·α-spending**이다.  
반면, **탐색–활용** 균형으로 집행 자체를 최적화하는 **멀티암 밴딧**은 다른 축의 해결책이다.

---

## 1) 순차검정 기본기: SPRT → mSPRT

### 1.1 Wald의 SPRT (단일 표본 아이디어)
두 가설 $$H_0:\theta=\theta_0$$ vs $$H_1:\theta=\theta_1$$ 에 대해, 관측이 올 때마다 **우도비**를 누적:
$$
\Lambda_t=\prod_{i=1}^t \frac{f_{\theta_1}(X_i)}{f_{\theta_0}(X_i)},\quad \text{또는}\quad \log \Lambda_t=\sum_{i=1}^t \log\frac{f_{\theta_1}(X_i)}{f_{\theta_0}(X_i)}.
$$
경계 $$A=\frac{1-\beta}{\alpha},\ B=\frac{\beta}{1-\alpha}$$ 를 두고
- $$\Lambda_t \ge A$$ → **H₁ 채택**(조기 성공)  
- $$\Lambda_t \le B$$ → **H₀ 채택**(조기 실패)  
- 그 외 → **계속 관측**

여기서 **α**=I형 오류, **β**=II형 오류 목표.

### 1.2 혼합(mixture) SPRT = **mSPRT**
실전에서는 **대립값 $$\theta_1$$을 하나로 고정**하기 어렵다. **mSPRT**는 **사전분포**(믹스처)로 **H₁의 우도**를 적분:
$$
\Lambda_t^{\text{mix}}\equiv \frac{\int \prod_{i=1}^t f_{\theta}(X_i)\,d\Pi(\theta)}{\prod_{i=1}^t f_{\theta_0}(X_i)}.
$$
경계는 보통 **단측**이면
$$
\log \Lambda_t^{\text{mix}} \ge \log(1/\alpha) \ \Rightarrow\ \text{H₁ 신호(종료)}.
$$
이 방식은 **한 번의 경계**로 **연속 모니터링** 중에도 **전가시 오류(α) 제어**를 보장한다.

> **직관**: mSPRT의 분자는 “**H₁ 전체(사전으로 가중)**가 데이터를 얼마나 잘 설명하는가”, 분모는 “**H₀**가 데이터를 얼마나 잘 설명하는가”. 이 **비율**이 충분히 크면 **H₁**로 멈춘다.

---

## 2) 이항(전환) A/B에서의 mSPRT

### 2.1 설정
- A/B 두 변형, 사용자 단위 베르누이:  
  $$X_{iA}\sim \text{Bern}(p_A),\quad X_{iB}\sim \text{Bern}(p_B).$$
- **관심**: $$\Delta=p_B-p_A \ge 0?$$ (**우월성** 단측)

### 2.2 우도와 혼합 우도비
- **귀무**: $$H_0:\Delta=0 \ \Rightarrow p_B=p_A=p.$$
- **대립**: $$H_1:\Delta>0$$.  
  실무적으로 **사전** $$\Pi(\Delta)$$ 또는 **베타–이항** 사전 $$p_A,p_B \sim \text{Beta}(\alpha,\beta)$$ 를 쓴다.

#### (a) **베타-이항 혼합**의 폐형식
일·배치 시점까지 누적 성공–시도 \((x_A,n_A),(x_B,n_B)\).  
베타–이항 마지널 우도:
$$
m(x\mid n,\alpha,\beta)=\frac{\mathrm{B}(\alpha+x,\ \beta+n-x)}{\mathrm{B}(\alpha,\beta)}.
$$
- 분자(혼합 H₁): **독립 사전** 하에  
  $$\int f(p_A)f(p_B)\,dp_A\,dp_B \ \leadsto\ m(x_A\mid n_A,\alpha,\beta)\cdot m(x_B\mid n_B,\alpha,\beta).$$
- 분모(H₀): **공유 확률 \(p\)** 하 베타–이항 한 번  
  $$m(x_A+x_B\mid n_A+n_B,\alpha,\beta).$$

**따라서**
$$
\Lambda^{\text{mix}}=\frac{m(x_A\mid n_A,\alpha,\beta)\cdot m(x_B\mid n_B,\alpha,\beta)}{m(x_A+x_B\mid n_A+n_B,\alpha,\beta)}.
$$

> **운영 규칙(단측 우월성)**  
> $$\log \Lambda^{\text{mix}} \ge \log(1/\alpha)\ \Rightarrow\ \text{성공 종료}.$$

> **주의**: 상기 독립 사전은 “\(p_A,p_B\) 서로 독립”으로 가정한다.  
> **보수적 mSPRT**가 필요하면 “\(p_B\ge p_A\)” 제약 사전을 쓰거나 **MLE 혼합**(GSPRT)을 고려한다.

### 2.3 배치/스트리밍 업데이트
매 배치(예: 하루)마다 **누적 카운트**만 갱신하면 된다:
- \(x_A \leftarrow x_A+\Delta x_A,\ n_A\leftarrow n_A+\Delta n_A\) (B도 동일)  
- 위 식으로 \(\Lambda^{\text{mix}}\) 갱신 → **경계** 검사

### 2.4 비율 지표의 **오프셋**과 클러스터
- 무작위화 **단위=사용자**를 유지(세션·노출 기준으로 섞지 않기).  
- **집계형**(일×버전) 입력 시 `success x / trials n` 그대로 쓰면 된다(전환률).  
- **클러스터**(지역·서버) 무작위화면 **클러스터 카운트**로 mSPRT를 돌리고 **클러스터 부트스트랩**으로 민감도 점검.

---

## 3) 연속형 지표(정규 근사)의 mSPRT

### 3.1 설정
- A/B 평균 차이: \( \mu_B-\mu_A \). 표준편차 \(\sigma\)가 알려졌거나 충분히 크면 **정규 근사**.
- 시점 \(t\)에서 누적 평균·분산 \((\bar y_g(t), s_g^2(t))\), 표본수 \(n_g(t)\).

### 3.2 LLR 근사(단측)
- **H₀**: \(\Delta=0\), **H₁**: \(\Delta>0\)에 대해  
  $$Z_t=\frac{\bar y_B(t)-\bar y_A(t)}{\hat\sigma_t}\quad (\text{pooled }\hat\sigma_t)$$
- **혼합** 대신 **설계 대립 \(\Delta^\star\)**로 Wald **GSPRT** 근사:
$$
\log\Lambda_t \approx \frac{n_{\text{eff}}(t)}{2\sigma^2}\Big(2\Delta^\star(\bar y_B-\bar y_A)-(\Delta^\star)^2\Big).
$$
여기서 \(n_{\text{eff}}= \frac{n_A n_B}{n_A+n_B}\).  
실전에서는 **정규–정규 사전**을 써 **혼합 LLR**을 쓰기도 한다.

### 3.3 경계
- 단측 우월성: \( \log \Lambda_t \ge \log(1/\alpha) \) → 성공 종료.  
- **비열등/비우월**은 **양방향 경계**나 **역가설**로 설계.

---

## 4) 그룹 순차 & α-spending (빈도주의 대안)

### 4.1 그룹 순차(중간분석 K회)
“연속” 대신 **K개의 분석 시점**을 정해, 각 시점의 **임계치**를 조정해 **전체 α**를 지킨다.  
대표 경계:
- **Pocock**: 모든 중간에서 **완만한** 경계  
- **O’Brien–Fleming**: 초기에 **매우 엄격**, 말기에 완화

### 4.2 α-spending 함수
정보시간 \(t\in[0,1]\) (누적 분산 비율)에서 **쓰인 α**: \(\alpha(t)\).  
- **OBF spending**: $$\alpha(t)=2-2\Phi\Big(\frac{z_{\alpha/2}}{\sqrt{t}}\Big)$$  
- **Pocock 유사**: $$\alpha(t)=\alpha \log(1+(e-1)t)$$  
각 중간분석에서 **z-경계**를 역산.

### 4.3 mSPRT vs α-spending
- **mSPRT**: **아무 때나** 봐도 α-제어. **설계·설명**이 간단.  
- **α-spending**: **사전 지정된 시점**(일·주 단위)에 적합, 기존 분석 조직에馴染む.  
- **권장**: **대시보드 실시간** → **mSPRT**, **정기 리뷰** → **α-spending**.

---

## 5) 베이지안 밴딧: 탐색–활용 최적화

### 5.1 목표와 지표
- **후회(regret) 최소화**: 실험기간 동안 **성과**(전환·수익)를 **최대한** 얻는다.  
- **베스트암 식별**(중간 목표)과 다름. 운영상은 **후회 최소화**가 중요.

### 5.2 Thompson Sampling (TS) ― 확률 매칭
- 이항 전환률: 각 팔 \(k\)에 대해  
  $$p_k \sim \text{Beta}(\alpha_k,\beta_k)\xrightarrow{\text{업데이트}} \text{Beta}(\alpha_k+x_k,\beta_k+n_k-x_k).$$
- 라운드마다 **샘플** \( \tilde p_k\sim \text{posterior} \), **가장 큰** \( \tilde p_k \) 가진 팔을 선택.

**장점**: 간단·강력, 컨텍스트/가드레일 확장 쉬움.  
**주의**: 보고의 **빈도주의 오류 통제**가 목표라면 TS는 별개(사후 기준으로 판단).

### 5.3 UCB / KL-UCB
- UCB1(이항 근사):
  $$\text{UCB}_k(t)=\hat p_k + \sqrt{\frac{2\ln t}{n_k}}.$$
- **KL-UCB**:
  $$\text{UCB}_k(t)=\max\{q:\ n_k\cdot \mathrm{KL}(\hat p_k\Vert q)\le \ln t + c\ln\ln t\}.$$
보수적 상계로 **탐색을 보장**.

### 5.4 컨텍스트 밴딧 (개인화)
- 상태 \(x\)에 따라 처리를 선택: **LinUCB**, **BayesLinTS**, **신경선형/신경밴딧** 등.  
- **가드레일**: 예상 리스크가 크면 **안전 제약**(Safe bandit) 도입.

---

## 6) mSPRT와 밴딧의 **결합 운영 패턴**

- **밴딧**으로 **트래픽 할당**(탐색–활용), 동시에 **mSPRT**로  
  - **“명백한 열세 팔 조기 중단”**,  
  - **“우월 팔 확정 시 전체 롤아웃”**  
- 이때 **α 예산**을 팔·가설들에 **분할**하거나 **가로채기**(우월 신호 시 실험 종료) 규칙을 명시.

---

## 7) 지연·검열·드리프트 처리

### 7.1 지연 전환(구매 지연 등)
- **관측 대기**: 윈도 내 미도착 전환을 0으로 치지 말 것.  
- **생존/검열 모델**: **mSPRT** 대신 **사후예측** 기반 베이지안 정지 규칙(예: 미래 관측 기대치)이 유용할 수 있다.  
- 실무 팁: **지표를 분해**(즉시 클릭·장바구니·구매)하고 **가드레일**은 즉시형으로.

### 7.2 비정상성/계절성
- **슬라이딩 윈도우** mSPRT: 최근 W일 누적만으로 \(\Lambda\) 계산(엄밀 α-제어는 깨짐 → 운영 규정으로 보조).  
- **가중 업데이트**(사후에 discount 인자)로 **망각** 구현.  
- **체인지포인트** 감지 시 재시작(새 실험 ID).

---

## 8) 가드레일 KPI & 다중검정

### 8.1 가드레일
- 주효과 지표 외 **이탈률·충돌·지연** 등 **안전 지표**에 **역 mSPRT**(악화 신호) 경계를 둔다.  
- 운영 규칙: “가드레일 mSPRT가 **악화 경계** 통과 시 **즉시 중단**.”

### 8.2 다중팔/세그먼트/시간
- **팔 M개**: 각 비교에 **α 분할**(Bonferroni/Šidák) 또는 **게이팅**(우승 후보에게만 이어붙이기).  
- **세그먼트** 실시간 모니터링은 **탐색 보고**로 분리하고, **확증**은 별도 α로 검정.  
- **시간 다중성**은 mSPRT가 해결(전가시 α-제어), 단 **여러 가설** 동시 모니터링의 α는 설계로 관리.

---

## 9) 설계 파라미터 선택

### 9.1 mSPRT 사전(베타) & 초기값
- \(\text{Beta}(1,1)\) 중립이 무난.  
- 과거 유사 실험 기반 **약한 정보**(ESS 10~50)를 권장(오버컨피던스 금지).  
- “**최소 의미 효과**(MDE\*)” 주변에 질량을 배치하면 **감지 속도**가 좋아짐.

### 9.2 경계(α)와 파워
- 단측 우월성: \(\log \Lambda \ge \log(1/\alpha)\).  
- **평균 의사결정 시간**은 시뮬레이션으로 설계(아래 코드).  
- **불이익 규칙**(열세 경계)도 병행 가능: \(\log \Lambda \le \log(\beta/(1-\alpha))\).

---

## 10) 리포팅 템플릿

> **설계**: mSPRT(베타–이항, α=0.05, ESS=2), 단측 우월. 매일 09:00 업데이트.  
> **정지규칙**: \(\log \Lambda \ge \log 20\) (≈α=0.05) → 성공 종료. 가드레일(이탈률) 역 mSPRT 병행.  
> **결과**: D+9에 **성공 신호** 발생(누적 노출 A 1.2M, B 1.2M, CVR A 3.08%, B 3.31%). **Bayes factor**=25.3(>\(1/α\)=20).  
> **검증**: 그룹 순차(3회 중간, Pocock)로도 유의.  
> **가드레일**: 이탈률 악화 신호 없음.  
> **결정**: B 전면 롤아웃, 다음 2주 드리프트 모니터링 지속.

---

## 11) Python 개념 코드 — 이항 mSPRT & Thompson 밴딧

```python
# 개념 스니펫: 베타-이항 mSPRT (단측 우월) + Thompson Sampling 밴딧
import math, random

def log_beta(a,b):  # log Beta(a,b)
    import math
    return math.lgamma(a) + math.lgamma(b) - math.lgamma(a+b)

def log_marginal_beta_binom(x, n, a, b):
    # log B(a+x, b+n-x) - log B(a,b)
    return log_beta(a+x, b+n-x) - log_beta(a, b)

class MSPRTBetaBinom:
    def __init__(self, alpha=0.05, a0=1.0, b0=1.0):
        self.alpha = alpha
        self.a0, self.b0 = a0, b0
        self.xA = self.nA = self.xB = self.nB = 0
        self.threshold = math.log(1.0/alpha)  # 단측 우월 경계

    def update(self, xA, nA, xB, nB):
        self.xA += xA; self.nA += nA
        self.xB += xB; self.nB += nB

    def log_lambda(self):
        num = log_marginal_beta_binom(self.xA, self.nA, self.a0, self.b0) \
            + log_marginal_beta_binom(self.xB, self.nB, self.a0, self.b0)
        den = log_marginal_beta_binom(self.xA + self.xB, self.nA + self.nB, self.a0, self.b0)
        return num - den

    def should_stop_success(self):
        return self.log_lambda() >= self.threshold

# --- Thompson Sampling (2-armed, Bernoulli)
class TSBandit:
    def __init__(self, aA=1, bA=1, aB=1, bB=1):
        self.aA, self.bA, self.aB, self.bB = aA, bA, aB, bB
    def choose(self):
        sA = random.betavariate(self.aA, self.bA)
        sB = random.betavariate(self.aB, self.bB)
        return 'A' if sA >= sB else 'B'
    def update(self, arm, reward):
        if arm=='A':
            self.aA += reward; self.bA += 1-reward
        else:
            self.aB += reward; self.bB += 1-reward

# --- Simulation skeleton
def simulate(pA=0.030, pB=0.033, alpha=0.05, batch=20000, max_days=30):
    sprt = MSPRTBetaBinom(alpha=alpha, a0=1, b0=1)
    xA=xB=nA=nB=0
    for day in range(1, max_days+1):
        # balanced traffic
        nA_day = nB_day = batch//2
        import random
        xA_day = sum(1 for _ in range(nA_day) if random.random()<pA)
        xB_day = sum(1 for _ in range(nB_day) if random.random()<pB)
        sprt.update(xA_day, nA_day, xB_day, nB_day)
        if sprt.should_stop_success():
            return {"day": day, "logBF": sprt.log_lambda(), "xA": sprt.xA, "nA": sprt.nA, "xB": sprt.xB, "nB": sprt.nB}
    return {"day": None, "logBF": sprt.log_lambda(), "xA": sprt.xA, "nA": sprt.nA, "xB": sprt.xB, "nB": sprt.nB}
```

> **확장**:  
> - **열세 경계**(fail-fast) 추가, **가드레일**에 독립 mSPRT 병렬.  
> - **다중팔**: 우승 후보–대조 **쌍별** mSPRT 또는 **이원화**(톱-1 vs 나머지).  
> - **컨텍스트**: TS를 **컨텍스트 TS**로 바꾸고, 정책 평가는 **오프폴리시 DR**로 리포트.

---

## 12) mSPRT와 베이지안 정지 규칙의 차이

| 관점 | mSPRT(빈도주의) | 베이지안 정지(사후확률/베이즈팩터) |
|---|---|---|
| **오류 제어** | 전가시 **Type I α** 보장 | **빈도 오류 보장 아님**(사후 기준) |
| **설명** | 우도비/경계 | \(P(H_1\mid D)\), Bayes Factor |
| **설계** | α·β·사전(혼합) | 사전·임계(예: \(P>0.95\)) |
| **모니터링** | 언제든 가능 | 언제든 가능 |
| **실무** | 규제/가드레일 친화 | 직관적 커뮤니케이션 |

> **혼합 운영**: **mSPRT**로 **정식 오류 통제** + **베이지안**으로 **효용·손실** 판단을 병기.

---

## 13) 베스트암 식별(BAI) vs 후회 최소화

- **BAI**: 최적 팔을 **최대한 정확히** 찾기(샘플 복원). **가정**: 롤아웃 전 **충분히 오래 탐색**. mSPRT/Top-two Thompson 등.  
- **후회 최소화**: 당장 **성과 극대화**. **TS/UCB**가 주역.  
- **운영 판단**: 출시 타임라인·리스크·가드레일에 따라 선택/혼합.

---

## 14) 체크리스트(운영)

- [ ] **무작위화 단위=분석 단위**(사용자) 일치  
- [ ] **주지표**에 **mSPRT**(α=0.05), **가드레일** 역 mSPRT 병행  
- [ ] **사전**(ESS, 형태)와 **정지 경계** 문서화(프리레지)  
- [ ] **딜레이 지표**는 분해·보조지표로, 필요 시 베이지안 예측 기반  
- [ ] **다중팔** α 분할/게이팅, 세그먼트는 탐색 vs 확증 분리  
- [ ] **드리프트/리셋** 규칙: 체인지포인트 시 새 실험으로 재시작  
- [ ] **밴딧** 도입 시 정책 가치/후회·가드레일 보고 체계 준비  
- [ ] **대시보드**: \(\log \Lambda\)/경계, 우도비 궤적, 예상 의사결정일, 가드레일 상태

---

## 15) 자주 묻는 질문(FAQ)

**Q1. 매일 보면 α가 새지 않나요?**  
A. **mSPRT**는 **전가시** α-제어가 설계 기초다. **스냅샷 공유**는 자유지만 **정지 규칙**은 사전 고정.

**Q2. 베이지안 TS만 쓰면 되지 않나요?**  
A. TS는 **할당 최적화**에 강력하지만 **빈도 오류 통제**를 보장하지 않는다. **정책 결정/보고**에는 mSPRT나 α-spending을 병기하라.

**Q3. 사전은 어떻게 정하죠?**  
A. **중립** Beta(1,1) 또는 Jeffreys(0.5,0.5)로 시작, 과거 효과 크기(MDE\*) 근처에 약한 질량을 둔다. **민감도 분석**을 리포트.

**Q4. 딜레이가 길면?**  
A. **예측 가능한 보조 지표**(클릭·장바구니)에 mSPRT를 걸고, 구매는 **사후예측+손실** 기준으로 보조 판단.

**Q5. 다중팔은?**  
A. **쌍별 mSPRT** 또는 **토너먼트**. α는 **분할**하거나 **게이팅**으로 관리.

---

## 16) TL;DR
- **mSPRT**: **혼합 우도비 ≥ 1/α** 경계로 **연속 모니터링**에서도 **I형 오류** 제어. 베타–이항/정규 근사로 **쉽게 구현**.  
- **α-spending/그룹 순차**: 지정 시점에 **임계치 조정**으로 α 유지.  
- **밴딧(TS/UCB)**: **탐색–활용**을 최적화. mSPRT와 **병행**해 **조기 종료/전면 롤아웃**을 결정.  
- **실무 핵심**: 딜레이·드리프트·가드레일·다중성·문서화(프리레지) — 이 다섯 가지를 **항상** 지킬 것.

---

## 수학 박스 D — mSPRT의 $\alpha$ 제어: 마팅게일·Ville 부등식
> **붙이는 위치 권장**: 16) 순차의사결정(mSPRT) 끝부분

**혼합 우도비(mixture likelihood ratio)**  
$H_0:\theta=\theta_0$, $H_1$에 사전 $\Pi$를 둘 때
$$
\Lambda_t=\frac{\int \prod_{i=1}^t f_\theta(X_i)\,d\Pi(\theta)}{\prod_{i=1}^t f_{\theta_0}(X_i)}.
$$

**핵심 사실(Doob 마팅게일)**  
$H_0$ 하에서 $(\Lambda_t)_{t\ge 1}$는 **비음수 마팅게일**이고 $\mathbb E_{H_0}[\Lambda_t]=1$.

**Ville의 부등식(최대형 불등식)**  
비음수 마팅게일 $M_t$에 대해 임의의 $a>0$,
$$
\mathbb P\big(\sup_{t\ge 1} M_t \ge a\big)\ \le\ \frac{\mathbb E[M_0]}{a}.
$$
따라서 $M_t=\Lambda_t$, $a=1/\alpha$를 대입하면
$$
\mathbb P_{H_0}\!\left(\sup_{t\ge 1} \Lambda_t \ge \tfrac{1}{\alpha}\right)\le \alpha.
$$

**정지 규칙의 정당화**  
단측 우월성에서 “**$\log \Lambda_t \ge \log (1/\alpha)$이면 종료·$H_1$ 채택**”은  
**전가시(global)** Type-I 오류 $\le \alpha$를 보장한다(아무 때나 봐도 안전).

**베타–이항 폐형식(실무용)**  
누적 $(x_A,n_A),(x_B,n_B)$와 사전 $\mathrm{Beta}(a,b)$이면
$$
\Lambda_t
=\frac{\mathrm B(a+x_A,\, b+n_A-x_A)\ \mathrm B(a+x_B,\, b+n_B-x_B)}
{\mathrm B(a+x_A+x_B,\, b+n_A+n_B-x_A-x_B)}.
$$
이를 매 시점 갱신해 경계를 확인하면 된다.