---
layout: post
title: TCPIP - 주소 할당 & 이름 해석
date: 2025-08-29 20:25:23 +0900
category: TCPIP
---
# 주소 할당 & 이름 해석

## 1. 왜 ‘주소 할당 & 이름 해석’인가

- **IP 주소가 없으면 통신 자체가 불가**하고,  
  **DNS가 없으면 서비스 접근이 극도로 불편**하다.
- 현장에서 가장 자주 보는 장애 유형:
  - **DHCP 리스 실패/지연/충돌**
  - **DNS TTL·캐시·권한/재귀 역할 구분 실수**
  - **브라우저 DoH와 조직 DNS 정책 충돌**
- 실제 플로우는 다음과 같이 이어진다.

```text
[전원 ON / NIC UP]
  → DHCP로 IP·게이트웨이·DNS 등 주소 정보 획득
  → DNS로 도메인 이름을 IP로 해석
  → TCP/UDP 세션 수립 후 애플리케이션 통신
```

이 글은 이 흐름을 단계별로 쪼개서 본다.

---

## 2. DHCP: 주소 할당의 전체 흐름

### 2.1 DORA 흐름(Discover → Offer → Request → ACK)

IPv4 DHCP 기본 사이클:

```text
[클라이언트]             [L2/L3망]               [DHCP 서버]
     |-- DHCPDISCOVER --> (브로드캐스트/릴레이) --> |
     |<-- DHCPOFFER ----- (유니/브로드캐스트) ---  |
     |-- DHCPREQUEST -->  (브로드/유니캐스트) --> |
     |<-- DHCPACK ------- (유니/브로드캐스트) --- |
```

- **DISCOVER**
  - 출발지 IP: 0.0.0.0, 목적지 IP: 255.255.255.255 (또는 릴레이로 유니캐스트)
  - 메시지 타입 옵션 53 = 1
  - “이 서브넷에 나에게 IP 줄 서버 있나요?”
- **OFFER**
  - 서버에서 제안하는 IP(yiaddr), 서브넷 마스크, 게이트웨이, DNS 등 포함
  - 메시지 타입 옵션 53 = 2
- **REQUEST**
  - 클라이언트가 “이 IP 쓰겠습니다”라고 특정 OFFER를 선택
  - 초기 요청뿐 아니라 갱신(T1/T2)에도 사용
- **ACK**
  - 서버가 최종 승인.  
    이 시점에 클라이언트는 주소를 인터페이스에 바인딩하고 ARP로 중복 여부를 확인.

DHCP 메시지 구조와 T1/T2 값 정의는 RFC 2131에 상세히 기술되어 있다.   

#### 예제 1 – 가장 단순한 부트 플로우

```text
1) 노트북 전원 ON
2) NIC up → DHCPDISCOVER (브로드캐스트)
3) 건물 내 DHCP 서버 1대가 DHCPOFFER(192.0.2.123, /24, GW=192.0.2.1, DNS=192.0.2.53)
4) 노트북 → DHCPREQUEST(해당 IP 선택)
5) 서버 → DHCPACK(Lease=86400s, T1=43200s, T2=75600s)
6) 노트북: 192.0.2.123/24, GW 192.0.2.1 설정 후 ARP, 곧바로 통신 시작
```

### 2.2 DHCP 메시지 필드 개요(IPv4)

부록에 이미 요약이 있지만, 여기서 한 번 더 정리해 두면 디버깅할 때 도움이 된다.

```text
op      : 1=request, 2=reply
htype   : 1=Ethernet
hlen    : MAC 길이(보통 6)
hops    : 릴레이 홉 수
xid     : 트랜잭션 ID (DISCOVER~ACK 전체를 식별)
secs    : 부팅 후 경과 시간
flags   : Broadcast 플래그(최상위 비트)
ciaddr  : 현재 클라 IP(갱신 시 사용)
yiaddr  : "당신에게 줄 IP"
siaddr  : 부트 서버 주소(PXE와 연관)
giaddr  : 릴레이 주소(서브넷 경계 라우터)
chaddr  : 클라이언트 MAC
sname   : 옵션 부트 서버 이름
file    : 부트 파일 이름
options : 타입·리스시간·라우터·DNS 등 다양한 옵션
```

실제 분석은 `tcpdump 'port 67 or port 68'` 패킷 덤프에서 이 필드들이 어떻게 채워지는지 보는 것으로 시작하는 경우가 많다.

---

## 3. DHCP 리스, T1/T2, 갱신·재바인딩 타이머

### 3.1 리스와 타이머의 수식

서버가 리스 시간 \(L\)을 24시간(= 86400초)으로 준다고 하자. RFC 2131에 따르면 보통 다음처럼 설정한다.   

\[
T_1 \approx 0.5 \cdot L, \quad
T_2 \approx 0.875 \cdot L
\]

예:

- \(L = 86400\)s → \(T_1 ≈ 43200\)s, \(T_2 ≈ 75600\)s

시간 경과에 따른 상태 변화 개념은 다음과 같다.

```text
0            T1                    T2                    L
|------------|---------------------|---------------------|
INIT-REBOOT  RENEWING              REBINDING             EXPIRED
             (서버에게 유니캐스트)  (브로드캐스트 요청)
```

### 3.2 상태 전이 개념

- **BOUND**
  - IP 사용 중, 아직 T1 전.  
  - 별다른 DHCP 트래픽 없음.
- **RENEWING (T1 ~ T2)**
  - 클라이언트 → 현재 서버 IP로 유니캐스트 DHCPREQUEST.
  - 응답 ACK 받으면 리스와 T1/T2를 갱신.
- **REBINDING (T2 ~ L)**
  - 서버가 응답하지 않을 때, 브로드캐스트로 DHCPREQUEST를 보내 다른 서버에게서라도 연장 시도.
- **EXPIRED (L 이후)**
  - 해당 IP 사용 중단. 새로운 DISCOVER로 다시 시작.

#### 예제 2 – 서버가 잠시 다운됐다 살아나는 경우

```text
리스: 24시간, T1=12h, T2=21h

1) 오전 9시 리스 획득 → BOUND
2) 밤 9시(T1) → 서버에 유니캐스트 갱신 요청
   - 만약 이때 서버가 점검 중이라 무응답이면?
3) T2까지 유니캐스트 재시도, 여전히 실패하면 REBINDING으로 넘어가 브로드캐스트 요청
4) 새 서버 또는 기존 서버가 복구되면 그 ACK를 받고 리스 갱신
```

이 타이밍이 미묘하게 꼬이면, “부팅 직후 몇십 초만 통신이 안 되고 다시 된다”와 같은 현장이 만들어진다. (이 패턴은 뒤쪽의 시나리오에서 다시 다룬다.)

---

## 4. DHCP 풀 설계, 예약, 주요 옵션

### 4.1 주소 풀과 고정/예약 구분

- **풀(Pool)**: 자동으로 배포할 주소 범위
  - 예) `192.0.2.100–192.0.2.200`
- **고정(Static)**: 장비에 수동으로 직접 IP 설정
- **예약(Reservation)**: MAC 기준으로 DHCP가 **항상 같은 IP를 주도록** 설정

운영 편의상 다음과 같이 명확히 나누는 것이 좋다.

```text
192.0.2.1    : 게이트웨이(고정)
192.0.2.2-49 : 서버/프린터/AP(고정 또는 예약)
192.0.2.50-99: 기타 고정 또는 향후 사용
192.0.2.100-200 : DHCP 풀
나머지      : 비사용 또는 향후 용도 예약
```

### 4.2 IPv4 DHCP 주요 옵션(확장 버전)

| 옵션 | 이름 | 의미/활용 |
|---|---|---|
| 1 | Subnet Mask | 서브넷 마스크 |
| 3 | Router | 기본 게이트웨이 IP |
| 6 | DNS Servers | 재귀 DNS 서버 목록 |
| 12 | Host Name | 호스트 이름 제안 |
| 15 | Domain Name | 로컬 도메인 (`corp.example.com`) |
| 42 | NTP Servers | 시간 동기화 서버 |
| 51 | IP Address Lease Time | 리스 시간(초) |
| 53 | DHCP Message Type | DORA 타입 식별 |
| 54 | Server Identifier | 서버 IP |
| 55 | Parameter Request List | 클라이언트가 원하는 옵션 목록 |
| 57 | Maximum DHCP Message Size | DHCP 메시지 최대 크기 |
| 58/59 | Renewal/Rebinding Time | T1/T2 |
| 60/61 | Vendor/Client Identifier | 장비/OS 식별 |
| 66/67 | TFTP Server Name / Bootfile | PXE/네트워크 부팅 |
| 82 | Relay Agent Information | 릴레이 정보(포트/서브넷 식별) |
| 119 | Domain Search | 검색 도메인 리스트 |
| 121 | Classless Static Route | CIDR 정적 경로 제공 |
| 150 | TFTP 서버(벤더 확장) | 일부 VoIP/장비용 |

- **Option 121(Classless Static Route)**는 강력하지만, AS/라우팅 구조와 중복되면 운영이 매우 복잡해진다.  
  보통 작은 지사망에 특정 라우트를 넣어야 할 때 사용하고, 코어 라우팅은 IGP/BGP로 처리하는 편이 낫다.

### 4.3 DHCPv4 설정 예제(서버 측)

단순한 isc-dhcp-server 예제:

```conf
# /etc/dhcp/dhcpd.conf

default-lease-time 86400;   # 1 day
max-lease-time     604800;  # 7 days

subnet 192.0.2.0 netmask 255.255.255.0 {
  option routers             192.0.2.1;
  option subnet-mask         255.255.255.0;
  option domain-name         "corp.example.com";
  option domain-name-servers 192.0.2.53, 192.0.2.54;
  range 192.0.2.100 192.0.2.200;

  # MAC 기반 예약
  host printer-1 {
    hardware ethernet 00:11:22:33:44:55;
    fixed-address 192.0.2.10;
  }

  # 클래스리스 정적 경로 예시
  option classless-static-routes 24, 198,51,100, 192,0,2,1;
}
```

---

## 5. DHCP 트러블슈팅 패턴과 보안

### 5.1 흔한 장애 패턴

1. **DISCOVER만 있고 OFFER가 없다**
   - 릴레이 미설정(giaddr=0.0.0.0)
   - Access VLAN과 서버 VLAN이 다르지만 릴레이가 없음
   - ACL/방화벽이 UDP 67/68을 막고 있음
   - 서버 다운 또는 풀 고갈

2. **ACK까지 받았는데 통신이 안 된다**
   - 다른 장비가 같은 IP를 고정으로 사용(중복 IP)
   - 게이트웨이 VLAN/라우팅이 잘못 연결
   - ARP 테이블이 꼬여 있는 경우
   - L2 문제(링크, STP, VLAN 미스매치 등)로 실제 트래픽이 통과하지 못함

3. **간헐적으로 일부 단말만 주소를 못 받는다**
   - 풀 거의 고갈 상태(리스 회수 지연)
   - 릴레이 장비의 CPU/메모리 이슈로 간헐 드롭
   - Option 82 정책으로 특정 포트/회선만 거부

4. **PXE 부팅이 안 된다**
   - 66/67 옵션 누락 또는 잘못된 값
   - TFTP 서버로의 경로 차단
   - MTU/방화벽 문제로 큰 부트 이미지 전송 중단

### 5.2 DHCP Snooping, IP Source Guard

- **DHCP Snooping**
  - 스위치에 “**신뢰 포트**(DHCP 서버/업링크)”와 “**비신뢰 포트**(일반 사용자 포트)”를 구분
  - 비신뢰 포트에서 나오는 DHCP 서버 응답을 차단 → 악성/오배치 서버 방지
  - Snooping 테이블을 기반으로 “어느 포트에서 어떤 IP·MAC가 허용되는지” 기록

- **IP Source Guard**
  - Snooping 테이블 기반으로 **해당 포트에서 허용된 IP·MAC만 통신 허용**
  - IP 스푸핑 방지에 유용

이러한 기능들은 미국/유럽의 엔터프라이즈 스위치 벤더들이 공통적으로 권장하는 베스트 프랙티스에 포함되어 있다.   

---

## 6. DHCPv6: IPv6 환경의 주소 할당

### 6.1 기본 메시지 흐름(SOLICIT–ADVERTISE–REQUEST–REPLY)

IPv6 DHCPv6는 다음과 같은 흐름을 가진다.   

```text
[클라이언트]          [L2/L3망]           [DHCPv6 서버]
   |-- SOLICIT -------> (멀티캐스트) ---> |
   |<-- ADVERTISE ----- (유니/멀티캐스트) |
   |-- REQUEST -------> (유니/멀티캐스트) |
   |<-- REPLY --------- (유니/멀티캐스트) |
```

- 메시지 타입만 다를 뿐 개념은 DORA와 매우 유사하다.
- 갱신 시에는 RENEW/REPLY, 재바인딩에는 REBIND/REPLY 사용.

### 6.2 주소/프리픽스 유형

- **IA_NA (Non-temporary Address)**  
  일반적인 고정 IPv6 주소(전통적인 “호스트 주소”에 대응).
- **IA_TA (Temporary Address)**  
  프라이버시 확장용 임시 주소.
- **IA_PD (Prefix Delegation)**  
  홈/지사 라우터(CPE)가 상위 ISP로부터 `/56`, `/60` 등 **프리픽스를 할당받는 기능**.  
  이 프리픽스를 내부 여러 링크에 나눠줄 수 있다.

### 6.3 SLAAC와의 혼용

- IPv6에서는 **라우터 광고(RA)**를 통한 **SLAAC**와 DHCPv6를 함께 쓸 수 있다.
- RA의 M/O 플래그로 “주소는 SLAAC, 기타 정보(DNS 등)는 DHCPv6” 같은 정책을 만들 수 있다.

---

## 7. DNS 기본: 구조, 레코드, TTL과 캐싱

### 7.1 DNS 구성 요소

- **스텁 리졸버**
  - OS/앱에 내장된 매우 단순한 클라이언트
  - `/etc/resolv.conf` 또는 DHCP Option 6/23으로 받은 재귀 리졸버를 참조
- **재귀(Recursive) 리졸버**
  - 사용자의 질의를 받아 **루트 → TLD → 권한 서버**를 순차적으로 질의
  - 결과를 일정 기간 **캐싱**
- **권한(Authoritative) 서버**
  - 특정 존(zone)에 대한 **최종 권위**를 가진 서버
  - 해당 존 데이터(SOA, NS, A, AAAA 등)를 직접 제공

### 7.2 재귀 질의 흐름 예시

`www.example.com`의 A 레코드를 질의하는 일반적인 흐름:

```text
클라이언트 → 재귀: www.example.com A?

재귀 → 루트(.) : com.의 NS는?
루트 → 재귀   : com. TLD 서버 목록(NS + glue A/AAAA)

재귀 → com NS : example.com.의 NS는?
com NS → 재귀 : example.com. NS = ns1.example.com, ns2.example.com

재귀 → ns1.example.com NS : www.example.com A?
ns1 → 재귀 : www.example.com A = 203.0.113.10 (TTL=300)

재귀 → 클라이언트 : A=203.0.113.10 (캐시에 저장)
```

여기서 클라이언트는 오직 “www.example.com A?”만 재귀에게 묻고, 나머지 루트/TLD/권한 질의는 모두 재귀 내부에서 처리된다.

### 7.3 주요 레코드 타입(확장)

| 타입 | 의미 | 예/비고 |
|---|---|---|
| A | IPv4 주소 | `www → 203.0.113.10` |
| AAAA | IPv6 주소 | `www → 2001:db8::10` |
| CNAME | 별칭 → 정규 이름 | `www → web-123.cdn.example.net.` |
| MX | 메일 교환 | `example.com → mail1.example.com (prio=10)` |
| TXT | 텍스트 | SPF, DKIM, 도메인 검증 등 |
| NS | 하위 존의 권한 서버 | 위임(Delegation) |
| SOA | 존 개시부 | 시리얼, 리프레시·리트라이·네거티브 TTL |
| SRV | 서비스 위치 | `_sip._tcp → host:port, priority/weight` |
| PTR | 역방향 | `10.113.0.203.in-addr.arpa → host` |
| CAA | 인증서 발급 허용 CA | `CAA 0 issue "letsencrypt.org"` |

- **CNAME 주의**:
  - **동일 이름에 CNAME과 A/MX 등 다른 타입을 함께 둘 수 없다.**
  - 특히 존 정점(apex, 예: `example.com.`)에는 CNAME을 둘 수 없으므로, 많은 제공사가 **ALIAS/ANAME** 같은 “보이는 CNAME”을 에뮬레이션한다.

### 7.4 TTL과 캐싱 수식

권한 서버에서 레코드에 TTL \(\text{TTL}_0\)를 부여하면, 재귀 리졸버는 해당 시간을 기준으로 캐싱한다. 캐시에 들어온 시각을 \(t_0\), 현재 시각을 \(t\)라 할 때 남은 TTL은

\[
\text{TTL}_{\text{remain}}(t)
= \max\left(0,\ \text{TTL}_0 - (t - t_0)\right)
\]

- TTL이 300초라면, 캐시에 들어온 지 100초 후에는 200초가 남아 있고,  
  300초가 지나면 캐시에서 제거된다.
- **짧은 TTL**: 장애/전환 대응에 유리하지만, 권한 서버로 향하는 쿼리 부하 증가.
- **긴 TTL**: 부하는 줄지만, IP 변경/전환 시 긴 꼬리 현상이 발생.

미국·유럽의 대형 CDN과 운영자들은 보통 **애플리케이션 프런트 도메인**에 60~300초 정도의 TTL을,  
MX/NS와 같이 자주 변하지 않는 레코드에는 3600초 이상을 사용하는 것이 일반적이다.   

### 7.5 네거티브 캐싱

존의 SOA 레코드에는 “네거티브 TTL”이 포함되며, 이는 **존 내에 존재하지 않는 이름/타입에 대한 부정 응답을 얼마나 캐시할지**를 의미한다.

- 예: `nosuch.example.com`을 질의했을 때 NXDOMAIN 응답을 300초 동안 캐싱한다면,  
  같은 오타를 300초 안에 여러 번 쳐도 재귀는 권한 서버까지 가지 않고 바로 NXDOMAIN을 반환한다.

### 7.6 존 파일 예시

```zone
$ORIGIN example.com.
$TTL 300

@    IN  SOA ns1.example.com. dns-admin.example.com. (
         20250901 ; serial (YYYYMMDDnn)
         3600     ; refresh
         900      ; retry
         1209600  ; expire
         300)     ; negative caching TTL

     IN  NS   ns1.example.com.
     IN  NS   ns2.example.com.

; Apex
@    IN  A    203.0.113.5
@    IN  AAAA 2001:db8::5

; www는 CDN 별칭
www  IN  CNAME web-123.cdn.example.net.

; 메일
@     IN  MX   10 mail1.example.com.
mail1 IN  A    203.0.113.25

; SPF (TXT)
@     IN  TXT  "v=spf1 ip4:203.0.113.25 include:_spf.mail.example -all"

; 서비스 위치
_sip._tcp IN SRV 10 50 5060 sip-gw.example.com.
```

---

## 8. 진단 도구로 보는 DNS

### 8.1 `dig`로 재귀/권한 구분

- 재귀 리졸버에 질의:

```bash
dig www.example.com @192.0.2.53
```

- 전체 경로 추적(루트→TLD→권한):

```bash
dig +trace www.example.com
```

- 권한 서버 직접 확인:

```bash
dig www.example.com @ns1.example.com
```

### 8.2 TTL과 네거티브 캐시 관찰

- TTL 남은 값만 확인:

```bash
dig www.example.com +nocmd +noall +answer
```

- 존재하지 않는 이름 질의:

```bash
dig nosuch.example.com
```

응답에서 SOA와 함께 네거티브 TTL을 확인할 수 있다.

### 8.3 부하 분산 패턴

- 라운드 로빈:

```bash
dig www.cdn-example.net +short
# 여러 IP가 번갈아 나오는지 관찰
```

- 지역별 응답 차이 비교(여러 리졸버를 사용):

```bash
dig www.example.com @8.8.8.8   # 미국 기반 퍼블릭 리졸버
dig www.example.com @1.1.1.1   # 글로벌 Anycast 리졸버
```

---

## 9. 고급 주제: DNSSEC, DoH/DoT, 스플릿 DNS, Anycast

### 9.1 DNSSEC: 무결성과 출처 인증

#### 9.1.1 목표와 구성 요소

DNSSEC의 목표는 “**이 응답이 정말 권한 서버가 서명한 데이터인가?**”를 검증하는 것이다.

- 주요 레코드
  - **DNSKEY**: 공개키
  - **RRSIG**: 레코드 집합(RRset)에 대한 서명
  - **DS**: 상위 존이 하위 존의 키 지문을 저장
  - **NSEC/NSEC3**: 존 내 “존재하지 않음”을 증명하는 레코드

키는 보통 **KSK/ZSK 분리** 구조로 운용한다.

- KSK(Key Signing Key): DNSKEY RRset를 서명, 상위 존의 DS와 연결
- ZSK(Zone Signing Key): A/AAAA/MX 등 데이터 RRset 서명에 사용

#### 9.1.2 체인 오브 트러스트

루트 존이 신뢰 앵커로 동작하고, 그 아래 TLD(.com, .eu 등)와 개별 도메인이 차례로 연결된다.

1. 리졸버는 루트 DNSKEY를 신뢰(사전 탑재).
2. 루트에서 `.com`의 DS/DNSKEY를 검증.
3. `.com`에서 `example.com`의 DS/DNSKEY를 검증.
4. `example.com` 존의 RRSIG를 검증.

유럽에서는 2025년 기준으로 재귀 리졸버의 DNSSEC 검증 비율이 약 50% 내외,  
전 세계 평균은 약 35% 수준으로 보고된다.   

#### 9.1.3 운영 관점

- 키 롤오버 시
  - KSK/ZSK를 교체할 때 **이중 서명 기간**을 충분히 주어야 한다.
  - DS 교체 전후 TTL·전파 시간까지 고려해야 한다.
- DNSSEC은 **데이터 무결성·출처 인증**만 제공하고,  
  **기밀성(암호화)**는 제공하지 않으므로 DoH/DoT와 역할이 서로 다르다.

### 9.2 DoH/DoT: 전송 계층에서의 암호화

| 항목 | DoH (DNS over HTTPS) | DoT (DNS over TLS) |
|---|---|---|
| 포트 | TCP 443 | TCP 853 |
| 프로토콜 | HTTP/2 또는 HTTP/3 상의 DNS | TLS 위의 DNS (전용) |
| 장점 | 웹 트래픽처럼 보여 방화벽 통과 용이, 브라우저와 통합 쉬움 | 전용 포트로 정책/계측 용이, 프로토콜 단순 |
| 단점 | 네트워크 장비에서 식별/정책 적용 어려움 | 853 포트 차단 환경 존재 |

- **기능**: 재귀 리졸버와 클라이언트 구간 사이의 DNS 트래픽을 **암호화**해  
  패킷 스니핑/변조를 어렵게 만든다.   
- 주요 브라우저(Chrome, Firefox, Edge 등)는 2020년대 초부터 DoH를,  
  여러 OS와 리졸버(Windows, Android, 주요 퍼블릭 리졸버)는 DoT/DoH를 지원하고 있다.   

운영자는 다음을 고려해야 한다.

- 기업망에서 자체 재귀 리졸버 정책이 있을 때, 브라우저의 DoH가 **외부 퍼블릭 리졸버**를 사용하면
  - 스플릿 DNS 구조가 깨질 수 있다.
  - 감사/로깅 경로가 바뀐다.
- 해결책
  - 브라우저 정책에서 조직 리졸버를 DoH 엔드포인트로 등록
  - DoH를 무조건 차단하는 대신, 허용/차단/리다이렉트 정책을 명확히 문서화

### 9.3 스플릿 DNS(Split-Horizon)

- 내부 사용자에게는 내부 전용 도메인 및 사설 IP를 응답하고,
- 외부 사용자에게는 공개 IP만 응답하는 구조.

```text
내부 뷰: portal.corp.example.com → 10.0.10.5
외부 뷰: portal.corp.example.com → 203.0.113.50
```

- 구현 방식
  - BIND의 `view` 기능
  - 재귀/권한 서버 분리 + 방화벽/ACL 기반 접근 제어
- 주의점
  - 캐시 서버/포워딩 설정이 꼬이면 **내부 사용자가 외부 뷰를 보거나**,  
    내부용 레코드가 외부로 “샌다”.
  - 브라우저 DoH가 외부 퍼블릭 리졸버를 직접 참조하면 내부 뷰를 전혀 보지 못한다.

### 9.4 Anycast DNS

Anycast는 **여러 지역에 동일한 IP 주소를 가진 서버를 배치**하고,  
BGP로 “가까운 곳”의 인스턴스를 광고하는 방식이다.   

- 장점
  - 사용자와 가까운 리졸버/권한 서버에 연결 → **지연 감소**
  - 여러 노드에 트래픽 분산 → **DDoS 내성** 향상
- 고려 사항
  - BGP 정책에 따라 “가까움”이 항상 물리적 거리와 일치하지 않을 수 있다.
  - TCP 기반(DoT, AXFR 등)에서는 라우팅 변화 시 세션이 끊어질 수 있으므로  
    헬스 체크와 세션 유지 전략이 필요하다.

---

## 10. 엔드투엔드 시나리오(현장 패턴)

### 10.1 “부팅 후 30초 동안만 인터넷이 안 된다”

```text
증상
- 노트북 전원을 켜면 처음 수십 초 동안 웹 접속이 안 되다가, 그 뒤에는 멀쩡하다.

가설
- DHCP 갱신/재바인딩 시점에 서버 응답 지연 또는 릴레이/스위치 문제.
- 초기 ARP/NDP 실패로 게이트웨이 MAC 학습이 늦어짐.

관찰
- 부팅 직후 패킷 캡처: DISCOVER→OFFER→REQUEST→ACK 중 어떤 단계가 지연되는지 시간 측정.
- ACK 이후 곧바로 ARP 요청이 나가는지, ARP 응답이 제때 오는지 확인.

조치
- 릴레이 경로 최적화(Option 82 설정 재점검).
- 스위치 PortFast 활성화로 링크 업 직후 STP 지연 최소화.
- ARP/NDP 캐시 설정 점검 및 불필요한 보안 기능(Gratuitous ARP 차단 등) 조정.
```

### 10.2 “DNS 레코드 전환 직후 일부 지역이 계속 옛 IP로 접속”

```text
증상
- CDN CNAME을 새 목적지로 바꿨는데, 북미/유럽 일부 지역에서 몇 시간 동안 옛 IP로 접속 시도.

가설
- 일부 재귀 리졸버가 긴 TTL을 캐싱 중.
- 네거티브 캐시나 옛 NS 설정과 얽힌 경우.

관찰
- dig +trace로 권한 서버는 올바른 새 IP를 제공하는지 확인.
- 주요 퍼블릭 리졸버(8.8.8.8, 1.1.1.1 등)와 ISP 리졸버에서 응답 TTL과 IP 비교.

조치
- 전환 며칠 전부터 TTL을 충분히 낮추는 전략 적용(예: 3600 → 300 → 60).
- 전환 후 일정 시간 동안 주요 리졸버 사업자와 협력해 캐시 플러시 또는 점검.
```

### 10.3 “사내에서만 내부 서비스가 간헐 404/502”

```text
증상
- 회사 내부에서 사내 포털 접속이 간헐적으로 404/502.
- 외부(집, 모바일 네트워크)에서는 항상 정상.

가설
- 스플릿 DNS에서 내부 뷰와 외부 뷰가 섞여 보임.
- 일부 단말/브라우저가 DoH로 외부 퍼블릭 리졸버를 참조.

관찰
- 문제가 발생한 단말에서 nslookup/dig로 “어떤 리졸버를 향해 질의하는지” 확인.
- 해당 도메인의 응답 IP가 내부 사설/외부 공인 중 어느 것인지 비교.

조치
- DHCP Option 6/119를 통해 사내 재귀 리졸버 주소와 검색 도메인을 정확히 배포.
- 브라우저/OS의 DoH/DoT 정책을 조직 정책에 맞게 설정(내부 DoH 엔드포인트 제공 또는 DoH 비활성).
- 내부/외부 존 파일 및 뷰 구성이 일관적인지 점검.
```

---

## 11. 운영·트러블슈팅 체크리스트

### 11.1 DHCP 체크리스트

```text
[릴레이/경로]
- giaddr, Option 82(서브넷/포트 정보) 설정이 일관적인가?
- 중복 릴레이로 인해 브로드캐스트가 여러 번 전달되지 않는가?

[풀/임대]
- 풀 여유 주소, 사용률, 만료/해제 패턴은 어떤가?
- 예약 대역과 풀 대역이 겹치지 않는가?
- 긴 리스 시간으로 인해 주소 회전이 너무 느리지는 않은가?

[로그/보안]
- DHCPDISCOVER에 대해 DHCPOFFER가 없는 경우 원인 로그(BLOCK, ACL, 서버 다운)를 확인했는가?
- DHCP Snooping/Source Guard 설정이 모든 엣지 스위치에 동일하게 적용되어 있는가?
```

### 11.2 DNS 체크리스트

```text
[역할 분리]
- 재귀 DNS와 권한 DNS의 역할이 명확히 분리되어 있는가?
- 캐시 서버를 권한 서버처럼 사용하고 있지는 않은가?

[TTL/전환]
- 레코드 유형별 TTL 정책(프런트, MX, NS, TXT 등)이 문서화되어 있는가?
- 레코드 변경 전 TTL을 낮추는 절차가 존재하는가?

[레코드/정합]
- apex CNAME을 사용하지 않고, ALIAS/ANAME 등 제공사 메커니즘을 올바르게 사용하고 있는가?
- SPF(TXT), DKIM, DMARC 레코드가 메일 인프라와 일관적인가?

[보안/전송]
- DNSSEC 서명 상태, 리졸버 검증 여부, 키 롤오버 일정이 관리되고 있는가?
- DoH/DoT 사용 정책과 로그 경로가 정의되어 있는가?

[스플릿/Anycast]
- 내부/외부 DNS 뷰, 포워딩 경로, Anycast 노드 상태를 모니터링하고 있는가?
```

---

## 12. 미니 실습 과제

### 12.1 “DORA 캡처로 병목 찾기”

```text
의도
- 주소 임대 지연이 어디서 발생하는지 이해한다.

절차
1) 문제 단말에서 부팅 직후 tcpdump(또는 Wireshark)로 UDP 67/68만 캡처.
2) DISCOVER~OFFER, REQUEST~ACK 사이의 시간 간격을 측정.
3) 지연이 OFFER 전이라면 서버/릴레이를, ACK 전이라면 정책/DB/옵션 충돌을 의심.

결과
- 타임라인을 시각화하면 어느 구간에서 지연이 발생하는지 한눈에 파악할 수 있다.
```

### 12.2 “TTL 변경 전략 실습”

```text
의도
- 무중단 DNS 레코드 전환 절차를 체득한다.

절차
1) 테스트 존의 A 레코드 TTL을 3600 → 300 → 60 순으로 단계적으로 줄인다.
2) 각 단계에서 dig로 TTL 남은 값을 확인해 갱신 주기를 체감한다.
3) IP 전환 후 다시 TTL을 3600으로 복원한다.

결과
- TTL이 짧아질수록 전환이 빨라지지만, 권한 서버 QPS가 증가한다는 점을 인지한다.
```

### 12.3 “DNSSEC 검증 맛보기”

```text
의도
- 체인 오브 트러스트 개념을 실감한다.

절차
1) DNSSEC가 활성화된 도메인(예: 일부 .gov, .se 등)을 선택.
2) DNSSEC 검증 기능이 있는 재귀 리졸버를 이용해 DO 비트 설정 질의를 한다.
3) 응답에서 RRSIG, DNSKEY, DS 레코드를 관찰하고, AD 비트가 세트 되는지 확인한다.

결과
- 각 단계의 서명/검증이 실패할 경우 SERVFAIL이 발생하는 것을 확인할 수 있다.
```

### 12.4 “DoH/DoT 동작 비교”

```text
의도
- 브라우저/OS/네트워크 정책 상호작용을 이해한다.

절차
1) OS 리졸버는 DoT를 사용하는 상태(예: systemd-resolved 설정)로 두고, 브라우저 DoH는 OFF.
2) 브라우저 DoH를 ON으로 바꾸고 같은 도메인을 반복 질의한다.
3) 재귀 리졸버 로그에서 어떤 IP/프로토콜(DoH/DoT/UDP/TCP)로 쿼리가 들어오는지 관찰한다.

결과
- 브라우저가 OS 설정을 우회해 외부 퍼블릭 리졸버를 사용할 수 있음을 체감한다.
```

### 12.5 “스플릿 DNS 정합성 테스트”

```text
의도
- 내부/외부 DNS 뷰가 기대대로 동작하는지 검증한다.

절차
1) 사내 재귀 @10.0.0.53, 외부 재귀 @8.8.8.8에 각각 dig 수행.
2) 내부용 FQDN은 사설 IP, 외부용 FQDN은 공인 IP로 응답하는지 확인.
3) BYOD 단말에서 브라우저 DoH를 켠 상태로 같은 질의를 수행해 응답 변화를 본다.

결과
- 스플릿 DNS의 취약 지점(DoH, 캐시, 포워딩)을 이해하게 된다.
```

---

## 13. 수식/숫자 감각 메모

### 13.1 DHCP 타이머

\[
T_1 \approx 0.5 \cdot L,\quad
T_2 \approx 0.875 \cdot L
\]

- \(L\): 리스 시간(초)
- \(T_1\): 갱신(renew) 시작 시점
- \(T_2\): 재바인딩(rebind) 시작 시점

짧은 \(L\)은 주소 회전성과 모바일성에는 유리하지만, 갱신 트래픽과 서버 부하를 증가시킨다.

### 13.2 DNS 캐시 히트율

총 쿼리 수를 \(Q_t\), 권한 서버로 전달되는 쿼리 수를 \(Q_b\)라고 하면 캐시 히트율 \(H\)는

\[
H = 1 - \frac{Q_b}{Q_t}
\]

TTL을 줄이면 전환은 쉬워지지만 \(Q_b\)가 증가해 캐시 히트율이 떨어지고, 권한 서버와 네트워크 부하가 올라간다.

---

## 14. 베스트 프랙티스 요약 카드

- **DHCP**
  - 릴레이/Option 82/서브넷 설계를 표준화하고, 예약·고정 대역을 문서화.
  - Snooping/Source Guard로 악성/오배치 DHCP 서버와 IP 스푸핑 방지.
  - 리스 시간과 T1/T2를 단말/이동성/운영 편의에 맞게 조정.

- **DNS**
  - 재귀와 권한 역할을 분리하고, TTL 정책을 유형별로 구분.
  - apex CNAME을 사용하지 않고, 제공사별 ALIAS/플래트닝 메커니즘을 올바르게 이해.
  - DNSSEC 서명/검증, DoH/DoT 사용 정책, 스플릿 DNS 구조를 문서화.

- **운영**
  - 레코드 변경 전 TTL 낮추기, 전환 창 운영, 주요 리졸버와의 협력 채널 확보.
  - Anycast, GeoDNS, CDN 등을 사용할 때 지역별 응답 차이를 모니터링.
  - 장애 시 패킷 캡처와 dig/tcpdump를 통한 “실제 플로우” 확인을 습관화.

---

## 15. 한 장 요약(포스터)

- **DHCP**
  - DORA로 주소·옵션·리스 시간 할당, T1/T2로 안정적인 갱신.
  - 릴레이/Option 82와 Snooping/Source Guard로 안정성과 보안을 동시에 확보.

- **DNS**
  - 재귀와 권한 서버가 역할을 나눠 루트→TLD→권한 경로를 따라 이름을 IP로 해석.
  - A/AAAA/CNAME/MX/TXT 등 레코드 타입과 TTL/네거티브 캐시를 이해하면 장애 분석이 쉬워진다.

- **고급 기능**
  - DNSSEC는 무결성과 출처 인증, DoH/DoT는 전송 구간 암호화를 책임진다.
  - 스플릿 DNS와 Anycast는 대규모/엔터프라이즈 환경에서 지연, 가용성, 보안 요구를 만족시키는 핵심 도구다.

- **운영 철학**
  - “주소 할당(DHCP)과 이름 해석(DNS)”은 거의 모든 네트워크 문제의 출발점이다.
  - 변경 전 TTL 조정, 키 롤오버, 브라우저 DoH/DoT와 조직 정책의 정렬까지 **전 과정을 설계·문서화**하는 것이 안정적인 운영의 기반이다.

---

### 부록 A — DHCP 메시지 필드(요약, v4)

```text
op(1=req/2=reply), htype(1=Ethernet), hlen(6), hops,
xid(트랜잭션ID), secs, flags(Broadcast),
ciaddr(현재 IP), yiaddr(클라에게 줄 IP), siaddr(서버), giaddr(릴레이),
chaddr(클라 MAC), sname, file,
options(옵션53=메시지 타입, 54=서버 ID, 51=리스 시간 등)
```

### 부록 B — DNS 헤더 필드(요약)

```text
ID, QR(질의/응답), OPCODE, AA(권한 응답), TC(트렁케이트),
RD(재귀 요구), RA(재귀 가능), AD(Authenticated Data), CD(Checking Disabled),
QDCOUNT(질의 수), ANCOUNT(응답 수), NSCOUNT(권한 수), ARCOUNT(추가 수)
```

### 부록 C — 스니퍼 관찰 템플릿

```text
[시간/클라이언트MAC] 부팅 시점
[DHCP] DISCOVER→OFFER(ms), REQUEST→ACK(ms), 풀 여유, 예약 히트 여부
[ARP/NDP] 게이트웨이 MAC 학습 시간, Gratuitous ARP/Neighbor Advertisement 이벤트
[DNS] 재귀/권한 구분, TTL 남은 값, 네거티브 캐시, Geo/Anycast 차이
[보안] DHCP Snooping/SourceGuard, DNSSEC AD 비트, DoH/DoT 로그
[조치/결과] 옵션/뷰/TTL 수정, 전환 창, 후속 문서화
```