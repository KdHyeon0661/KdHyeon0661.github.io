---
layout: post
title: TCPIP - 주소 할당 & 이름 해석
date: 2025-08-29 20:25:23 +0900
category: TCPIP
---
# 6. 주소 할당 & 이름 해석
**(🔰 DHCP: DORA·예약·리스·옵션, 🔰 DNS: 재귀/권한·A/AAAA/CNAME/MX/TXT·TTL/캐싱, 🚀 DNSSEC·DoH/DoT·스플릿 DNS·Anycast)**

> 이 글은 “호스트가 **주소를 받는 과정(DHCP)**”과 “이름을 **IP로 푸는 과정(DNS)**”을 **실무 관점**으로 연결합니다.  
> 패킷 흐름·타이머·옵션·TTL·캐싱·보안(DNSSEC)·전달 방식(DoH/DoT)·운영 패턴(스플릿 DNS/Anycast)**까지 예제 중심으로 풀어냅니다.  
> 수식은 MathJax를 사용합니다.

---

## 6.1 왜 ‘주소 할당 & 이름 해석’인가
- **IP 주소가 없으면 통신 자체가 불가**, **DNS가 없으면 서비스 접근이 극도로 불편**합니다.  
- 현장에서 빈번한 장애: **DHCP 리스 실패/충돌**, **DNS TTL/캐시/권한 구분 실수**, **서버/브라우저의 DoH 사용 차이** 등.  
- 본 글은 “**호스트 부팅 → DHCP로 주소·옵션 획득 → DNS로 이름 해석 → 서비스 접속**”의 흐름을 **엔드투엔드**로 정리합니다.

---

## 6.2 DHCP 기본 (IPv4 위주, v6도 개요)  🔰

### 6.2.1 DORA 흐름(Discover → Offer → Request → Acknowledgment)
```text
[클라이언트]             [L2/L3망]               [DHCP 서버]
     |-- DHCPDISCOVER --> (브로드캐스트/릴레이) --> |
     |<-- DHCPOFFER ----- (유니/브로드캐스트) ---  |
     |-- DHCPREQUEST -->  (브로드/유니캐스트) --> |
     |<-- DHCPACK ------- (유니/브로드캐스트) --- |
```
- **DISCOVER**: “주소 줄 사람?”(브로드캐스트 `255.255.255.255` 또는 릴레이 통해 유니캐스트)  
- **OFFER**: 서버가 **임대 제안**(IP·옵션·임대시간)  
- **REQUEST**: 클라이언트가 **특정 제안 수락**(또는 재인증/갱신 요청)  
- **ACK**: 서버가 **최종 승인**(리스 확정, 옵션 포함)

> **DHCP 릴레이(Option 82)**: L3 경계에서 **브로드캐스트를 서버로 전달**. 서버 입장에선 **포트/스위치/서브넷 정보**를 보고 정책적 할당 가능.

### 6.2.2 리스(Lease), 타이머(T1/T2), 갱신/재바인딩
- **임대시간(Lease Time, Option 51)**: 예) 24시간.  
- **T1(갱신)**, **T2(재바인딩)**: 일반적으로  
  \[
  T_1 \approx 0.5 \cdot \text{Lease}, \quad T_2 \approx 0.875 \cdot \text{Lease}
  \]
  - **T1**(서버에게 유니캐스트로 연장 요청), **T2**(서버 응답 없을 때 브로드캐스트로 재바인딩).

### 6.2.3 예약(Reservation)과 풀(Pool) 설계
- **풀(Pool)**: `192.0.2.100–192.0.2.200`처럼 범위를 정의.  
- **예약**: **MAC 기반**으로 특정 장치에 **고정 IP**를 항상 할당.  
- **베스트프랙티스**:
  - 게이트웨이·프린터·AP·서버 등은 **고정/예약**으로 관리.  
  - **풀과 고정 대역 분리**(문서화: “.1~.50 고정, .100~.200 풀”).  
  - **충돌 방지**: 관리자가 수동으로 넣은 고정 IP가 **풀 범위와 겹치지 않도록**.

### 6.2.4 주요 DHCP 옵션(IPv4)
| 옵션 | 이름 | 의미/활용 |
|---|---|---|
| 1 | Subnet Mask | 서브넷 마스크 |
| 3 | Router(게이트웨이) | 기본 게이트웨이 IP |
| 6 | DNS Servers | 재귀 DNS 서버 목록 |
| 12 | Host Name | 호스트 이름 제안 |
| 15 | Domain Name | 로컬 도메인(검색 도메인과 함께 사용) |
| 42 | NTP Servers | 시간 동기화 서버 |
| 51 | IP Address Lease Time | 임대 시간(초) |
| 53 | DHCP Message Type | DORA 타입 식별 |
| 54 | Server Identifier | 서버 식별자(서버 IP) |
| 55 | Parameter Request List | 클라이언트가 원하는 옵션 목록 |
| 57 | Maximum DHCP Message Size | DHCP 메시지 최대 크기 |
| 58/59 | Renewal/Rebinding Time Value | T1/T2 |
| 60/61 | Vendor/Client Identifier | 장비/OS 식별 |
| 66/67 | TFTP Server Name / Bootfile | **PXE/부트** 환경 |
| 119 | Domain Search | 검색 도메인 리스트 |
| 121 | Classless Static Route | CIDR 정적 경로 제공 |
| 82 | Relay Agent Information | 릴레이 정보(회선/포트 식별) |

> **주의**: **Option 121(Classless Static Route)**는 **복수 서브넷의 라우팅**을 호스트에 직접 주입할 수 있어 강력하지만, 관리 난이도↑. 문서화·버전 관리 필수.

### 6.2.5 DHCP 트러블슈팅 “패턴”
- **DISCOVER만 보이고 OFFER 없음**: 릴레이 미설정/ACL/브로드캐스트 차단/서버 다운.  
- **ACK까지 받았는데 통신 불가**: **VLAN/게이트웨이** 오배치, **중복 IP**, 또는 **ARP/NDP 이슈**.  
- **간헐 실패**: 풀 고갈, 릴레이 플랩, Option 82 값 불일치로 **정책 거부**.  
- **PXE 부팅 실패**: 66/67 미설정, TFTP 방화벽, 옵션 충돌.

> **보안/위생**: **DHCP Snooping**(스위치 기능)으로 **허용 포트 외 DHCP 트래픽 차단**(악의적/오배치 서버 예방), **IP Source Guard**와 연계.

### 6.2.6 DHCPv6(개요)
- 메시지: **SOLICIT → ADVERTISE → REQUEST → REPLY**(SARR).  
- 주소 형식: **IA_NA**(Non-temporary), **IA_TA**(Temporary), **IA_PD**(Prefix Delegation; CPE가 서브넷을 할당받을 때).  
- 옵션: **DNS Recursive NS(Option 23)**, **Domain Search(Option 24)** 등.  
- SLAAC(6장 전반 참고)와 **혼용** 가능(M/O 플래그).

---

## 6.3 DNS 기본: 재귀/권한 · 레코드 · TTL/캐싱  🔰

### 6.3.1 구성 요소
- **재귀(Recursive) 리졸버**: 사용자를 대신해 **루트 → TLD → 권한** 서버를 순차 질의, 결과 **캐싱**.  
- **권한(Authoritative) 서버**: **해당 존(zone)** 데이터에 대한 **최종 권위**.  
- **스텁 리졸버**: OS/앱 내부의 경량 리졸버(대개 127.0.0.1 혹은 DHCP로 받은 재귀 DNS를 참조).

### 6.3.2 질의 흐름(예: `www.example.com` A 레코드)
```text
클라이언트 → 재귀: www.example.com A?
재귀 → 루트: com.의 권한 서버는?
재귀 → .com 권한: example.com.의 권한은?
재귀 → example.com 권한: www.example.com A?
권한 → 재귀: A=203.0.113.10 (TTL=300)
재귀 → 클라이언트: A=203.0.113.10 (캐시 저장)
```

### 6.3.3 주요 레코드 타입
| 타입 | 의미 | 예/비고 |
|---|---|---|
| **A** | IPv4 주소 | `www → 203.0.113.10` |
| **AAAA** | IPv6 주소 | `www → 2001:db8::10` |
| **CNAME** | 별칭 → 정규 이름 | `www → web-123.cdn.example.net.` (**Apex에 CNAME 불가**) |
| **MX** | 메일 교환 | `example.com → mail1.example.com (prio=10)` |
| **TXT** | 텍스트 | SPF/도메인 검증 등 (`v=spf1 include:_spf.example -all`) |
| NS | 하위 존의 권한 서버 | 위임(Delegation) |
| SOA | 존 개시부 | 시리얼·리프레시/리트라이·네거티브 TTL |
| SRV | 서비스 위치 | `_sip._tcp → host:port, priority/weight` |
| PTR | 역방향 | `10.113.0.203.in-addr.arpa → host` |
| CAA | 인증서 발급 허용 CA | `CAA 0 issue "letsencrypt.org"` |

> **CNAME 주의**: **동일 이름**에 **다른 RR(A/MX 등)와 공존 불가**. 특히 **도메인 정점(apex)**에 CNAME을 둘 수 없어, 제공사들은 **ALIAS/ANAME(플래트닝)**로 대체 구현.

### 6.3.4 TTL과 캐싱
- 권한 서버가 응답에 **TTL** 부여 → 재귀가 **해당 기간 캐시**.  
- 클라이언트는 재귀의 **남은 TTL**만큼 결과를 쓴다.  
- **남은 TTL**은 갱신과 함께 감소:
  \[
  \text{TTL}_{\text{remain}}(t) = \max\left(0, \ \text{TTL}_0 - (t - t_0)\right)
  \]
  - \(t_0\): 캐시에 들어온 시각, \(\text{TTL}_0\): 원래 TTL.

**TTL 설계 팁**  
- 자주 바뀌는 CDN/동적 IP: **짧게(60~300s)**.  
- 잘 안 바뀌는 MX/NS: **길게(3600~86400s)**.  
- 변경 직전 **TTL을 미리 낮춘 뒤** 레코드를 바꾸면 다운타임 최소화.

### 6.3.5 네거티브 캐싱(RFC 2308)
- 없는 이름/타입에 대한 부정 응답도 **SOA의 Min/TTL**에 따라 **캐시**됩니다.  
- 예: 오타 도메인 반복 질의 → 일정 시간 자동 차단.

### 6.3.6 존 파일(예시 스니펫)
```zone
$ORIGIN example.com.
$TTL 300
@    IN  SOA ns1.example.com. dns-admin.example.com. (
         20250901 ; serial (YYYYMMDDnn)
         3600     ; refresh
         900      ; retry
         1209600  ; expire
         300)     ; negative caching TTL
     IN  NS   ns1.example.com.
     IN  NS   ns2.example.com.

; Apex
@    IN  A    203.0.113.5
@    IN  AAAA 2001:db8::5
; www는 CDN 별칭
www  IN  CNAME web-123.cdn.example.net.
; 메일
@    IN  MX   10 mail1.example.com.
mail1 IN  A    203.0.113.25
; SPF (TXT)
@    IN  TXT  "v=spf1 ip4:203.0.113.25 include:_spf.mail.example -all"
; 서비스 위치
_sip._tcp IN SRV 10 50 5060 sip-gw.example.com.
```

---

## 6.4 진단 도구로 보는 DNS (관찰 포인트)

### 6.4.1 재귀 vs 권한 구분
- 재귀에 질의: `dig www.example.com @8.8.8.8`  
- 전체 경로 추적: `dig +trace www.example.com`(루트→TLD→권한 순차 출력)  
- 권한 서버 직접 확인: `dig www.example.com @ns1.example.com`

### 6.4.2 레코드·TTL·네거티브 캐시 확인
- TTL 남은 값: `dig www.example.com +nocmd +noall +answer`  
- 없는 레코드 질의: `dig nosuch.example.com` → SOA 기반 네거티브 TTL 관찰.

### 6.4.3 부하 분산 패턴
- **라운드로빈 A**: 응답 섞임 확인(여러 IP가 교대로).  
- **지리 기반**: anycast/GeoDNS 응답 차이(지역별 재귀 서버로 시도).

---

## 6.5 고급: DNSSEC, DoH/DoT, 스플릿 DNS, Anycast  🚀

### 6.5.1 DNSSEC(무결성/출처 인증)
- **목표**: “응답이 **권한 서버가 서명한 진짜 데이터**인가?”를 **암호학적으로 검증**.  
- 구성 요소:
  - **DNSKEY**(공개키), **RRSIG**(레코드 서명), **DS**(부모 존이 자식의 키 지문 저장), **NSEC/NSEC3**(존 내 **존재하지 않음** 증명).  
  - **KSK/ZSK 분리**: KSK(키 서명 키)로 ZSK의 DNSKEY RRset 서명, ZSK(존 서명 키)로 데이터 RRset 서명.  
- **체인 오브 트러스트**:
  - `.`(루트)가 **신뢰 앵커**. 루트 DNSKEY는 리졸버에 사전 탑재.  
  - 각 단계에서 **DS → DNSKEY → RRSIG 검증**으로 하위로 내려감.

**검증 관찰 포인트(개념)**  
- DO(“DNSSEC OK”) 비트 설정 질의 → 권한이 **RRSIG/DNSKEY/DS** 제공.  
- 리졸버는 서명 타임스탬프(유효기간), 키 유효성, 체인을 확인.  
- 실패 시 **SERVFAIL/AD 비트 미세팅** 등으로 식별 가능.

**운영 팁**  
- **키 롤오버**(KSK/ZSK)는 **이중 서명/DS 교체** 절차 필요(서명 공백 금지).  
- TTL·전파 시간 고려해 **충분한 겹침 기간** 확보.  
- DNSSEC만으로 **암호화(기밀성) 제공 X** → **DoT/DoH**와 역할이 다름.

### 6.5.2 DoH(HTTPS) / DoT(TLS) — 전송 계층 보안
| 항목 | DoH (DNS over HTTPS) | DoT (DNS over TLS) |
|---|---|---|
| 포트/프로토콜 | TCP 443(HTTP/2/3) | TCP 853(순수 TLS) |
| 장점 | 방화벽 회피 용이(웹 트래픽처럼 보임), 브라우저 내 통합 | 트래픽 식별·분리 용이(전용 포트), 단순 |
| 단점 | 네트워크/보안 장비에서 식별 어려움 | 포트 차단 환경 존재 |
| 사용처 | 브라우저(Chrome/Firefox), OS 일부 | OS/중앙 리졸버·게이트웨이 |

- **기밀성/무결성**: 재귀↔클라이언트 구간에서 **암호화**. (DNSSEC과 **보완 관계**)  
- **운영 고려**: 브라우저가 **OS보다 우선**해 DoH를 쓸 수 있음(기업망에서 **스플릿 DNS**와 충돌 가능) → 정책/프록시/DoH 캔디데이트 설정으로 정렬.

### 6.5.3 스플릿 DNS(Split-Horizon)
- **내부**와 **외부**에 **서로 다른 응답**을 주는 구조.  
  - 내부: `db.example.local` 같은 내부 전용 FQDN, 사설 IP 응답.  
  - 외부: 공개 FQDN만, 공인 IP 응답.  
- 구현: BIND의 `view`, 인가된 리졸버 구분, 사내 재귀 전용.  
- **주의**: 잘못된 캐시/포워딩/DoH 우회로 내부 레코드가 **외부로 누출**되거나, 내부 클라이언트가 **외부 뷰**를 보게 되는 경우.

**운영 팁**  
- 내부 클라이언트는 **사내 재귀**만 사용하도록 DHCP 옵션(6/119)·프록시 정책 정합.  
- BYOD/브라우저 DoH는 **조직 정책**에 맞게 안내/차단/허용을 결정.

### 6.5.4 Anycast — 가까운 리졸버/권한으로 라우팅
- **여러 지역**에 **같은 IP**(리졸버/권한 서버)를 배치하고 **BGP로 광고** → 사용자/재귀는 **가까운 노드**로 연결.  
- 장점: **지연↓, 가용성↑, DDoS 분산**.  
- 고려:
  - BGP 정책/피어링에 따라 “가까움”이 항상 물리적 거리와 일치하진 않음.  
  - TCP 기반(DoT/AXFR)에서는 **세션 지속성**을 위해 노드 실패/라우팅 플랩 시 유의.

---

## 6.6 엔드투엔드 시나리오 3종(현장 감각)

### 6.6.1 “부팅 후 30초간만 인터넷이 안된다”
```text
증상: 전원 켠 직후 웹이 멈칫, 30초 후 정상
가설: DHCP T1/T2/갱신 미스 → 임시 주소로 통신 실패, 또는 초기 ARP/NDP 실패
관찰: 패킷 캡처에 DISCOVER/OFFER/REQUEST/ACK 지연, ARP/NDP 재시도
조치: 릴레이/옵션 재점검(Option 82), 스위치 PortFast, ARP/NDP 안정화
```

### 6.6.2 “도메인 전환 직후 일부 지역 접속 오류”
```text
증상: 새 CDN CNAME으로 전환 후 특정 지역 접속 실패
가설: TTL이 길어 구 리졸버 캐시에 옛 IP 유지, 네거티브 캐시와 얽힘
관찰: +trace로 권한은 정상이나, 특정 재귀가 옛 응답 제공(남은 TTL 큼)
조치: 전환 전 TTL 낮추기, 전환 창 지정, 주요 리졸버 캐시 점검/플러시 협력
```

### 6.6.3 “사내에서만 내부 서비스가 간헐 404/502”
```text
증상: 회사 내부에서 사내 포털 접속 불안정(외부는 정상)
가설: 스플릿 DNS 뷰 일부가 외부로 유출/클라가 브라우저 DoH로 외부 리졸버 참조
관찰: 클라의 리졸버 IP가 사내가 아님, 외부 DNS가 공인 IP 응답 → 방화벽/리버스 프록시 경유로 정책 충돌
조치: DHCP Option 6/119 재확인, DoH 정책/프록시 정렬, 내부·외부 존 분리 검증
```

---

## 6.7 운영·트러블슈팅 체크리스트

### 6.7.1 DHCP
```text
- 릴레이(giaddr/Option 82) 설정 일치, 중복 릴레이 방지
- 풀 여유/임대 현황, 충돌(duplicate) 경고 여부
- 예약 목록과 풀 범위 겹침 금지
- DORA 타이밍/재시도, ACK 이후 L2/L3 경로(게이트웨이/VLAN) 확인
- DHCP Snooping/Source Guard 활성화(오배치 서버·스푸핑 방지)
```

### 6.7.2 DNS
```text
- 재귀/권한 역할 분리? 캐시 서버를 권한처럼 운영하지 않기
- TTL/네거티브 TTL 설계 문서(변경 전 낮춤 전략)
- apex CNAME 금지, ALIAS/ANAME 사용 여부 확인
- MX·SPF(TXT)·DKIM·DMARC 일관성
- Geo/Anycast 환경에서 지역 응답 차이 모니터링
```

### 6.7.3 보안/전송
```text
- DNSSEC 서명/검증 상태(키 롤오버 캘린더/런북)
- DoH/DoT 정책(허용/차단/미러링)과 로그 경로
- 내부 스플릿 DNS 뷰/포워딩 경로 점검(누출/우회 방지)
```

---

## 6.8 미니 실습(의도 중심)

### 6.8.1 “DORA 캡처로 병목 찾기”
```text
의도: 주소 임대 지연의 원인 파악
절차: 부팅 직후 인터페이스 캡처 → DISCOVER~ACK 타임스탬프 계산
관찰: OFFER 지연=서버/릴레이 문제, REQUEST→ACK 지연=정책/DB 접근·옵션 충돌 의심
```

### 6.8.2 “TTL 변경 전 전략”
```text
의도: 무중단 레코드 전환
절차: D-2일에 TTL 300→60으로 낮춤 → 전환 → D+1일 TTL 복원
관찰: 전환 순간의 캐시 꼬임 최소화
```

### 6.8.3 “DNSSEC 검증 맛보기(개념)”
```text
의도: 체인 오브 트러스트 이해
절차: DO 비트 세팅 질의(리졸버 설정) → RRSIG/DS/DNSKEY 확인 → AD 비트로 검증 성공여부 확인
```

### 6.8.4 “DoH/DoT 동작 비교”
```text
의도: 네트워크/브라우저 정책 상호작용 이해
절차: 브라우저 DoH On/Off, OS 리졸버 DoT On/Off 조합 → 재귀 로그에서 쿼리 출처/프로토콜 확인
```

### 6.8.5 “스플릿 DNS 정합성 테스트”
```text
의도: 내부/외부 서로 다른 응답 검증
절차: 사내 재귀 @10.0.0.53 / 외부 재귀 @8.8.8.8 각각 dig → 응답 비교(내부=사설, 외부=공인)
```

---

## 6.9 수식/숫자 감각 메모

### 6.9.1 DHCP 타이머
\[
T_1 \approx 0.5 \cdot L, \quad T_2 \approx 0.875 \cdot L
\]
- \(L\): 임대시간(초). 짧은 L은 빈번한 갱신 → 서버 부하↑, 지나치게 긴 L은 재배치/이동성 저해.

### 6.9.2 DNS TTL/캐시 히트 비율
- 캐시 히트율을 \(H\), 백엔드 쿼리를 \(Q_b\), 총 쿼리를 \(Q_t\)라 하면  
  \[
  H = 1 - \frac{Q_b}{Q_t}
  \]
- TTL을 짧게 하면 **전환은 쉬우나** \(Q_b\) 증가 → 권한/재귀/네트워크 부하↑.

---

## 6.10 베스트 프랙티스(요약 카드)
- **DHCP**: 릴레이/옵션(3/6/119/121/66/67) 표준화, 예약·고정 분리, Snooping/Source Guard.  
- **DNS**: 재귀·권한 역할 분리, TTL 차등 전략, apex CNAME 금지·ALIAS 활용, 네거티브 캐싱 고려.  
- **DNSSEC**: 서명·검증 파이프 정착, 롤오버 캘린더/런북.  
- **DoH/DoT**: 조직·브라우저·OS 정책 합의, 로깅/프라이버시 균형.  
- **스플릿 DNS**: 내부·외부 뷰 엄격 분리(포워딩·캐시·DoH 우회 대비).  
- **Anycast**: 다지역 배치·헬스·BGP 정책 정렬, TCP(DoT) 세션 지속성 고려.

---

## 6.11 한 장 요약(포스터)
- **DHCP**: DORA로 주소·옵션·임대. T1/T2로 안정 갱신. 릴레이/Option 82와 Snooping으로 안정·보안.  
- **DNS**: 재귀↔권한 분업, A/AAAA/CNAME/MX/TXT, TTL/네거티브 캐시. apex CNAME 금지.  
- **고급**: DNSSEC(무결성), DoH/DoT(전송 암호화), 스플릿 DNS(내/외부 분리), Anycast(근접/가용성).  
- **운영**: 변경 전 TTL 낮춤, 캐시/정책/로그 단일화, 전환·롤오버 런북.

---

### 부록 A — DHCP 메시지 필드(요약, v4)
```text
op(1=req/2=reply), htype(1=Ethernet), hlen(6), hops,
xid(트랜잭션ID), secs, flags(Broadcast),
ciaddr(현재 IP), yiaddr(클라에게 줄 IP), siaddr(서버), giaddr(릴레이),
chaddr(클라 MAC), sname, file, options(옵션53=Type, 54=Server ID, 51=Lease 등)
```

### 부록 B — DNS 헤더 필드(요약)
```text
ID, QR(질의/응답), OPCODE, AA(권한), TC(트렁케이트), RD(재귀요청),
RA(재귀가능), AD(Authenticated Data), CD(Checking Disabled),
QDCOUNT/ANCOUNT/NSCOUNT/ARCOUNT
```

### 부록 C — 스니퍼 관찰 템플릿
```text
[시간/클라이언트MAC] 부팅 시점
[DHCP] DISCOVER→OFFER(ms), REQUEST→ACK(ms), 풀 여유, 예약 히트 여부
[ARP/NDP] 게이트웨이 MAC 학습 시간, GARP/NA Override 이벤트
[DNS] 재귀/권한 구분, TTL 남은 값, 네거티브 캐시, Geo/Anycast 차이
[보안] Snooping/SourceGuard, DNSSEC AD 비트, DoH/DoT 로그
[조치/결과] 옵션/뷰/TTL 수정, 전환 창, 후속 문서화
```