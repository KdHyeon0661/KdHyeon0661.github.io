---
layout: post
title: Linux - 패키지 설치와 관리
date: 2024-11-06 19:20:23 +0900
category: Linux
---
# 패키지 설치와 관리

## 리눅스에서 소프트웨어를 설치하는 방법 (개요)

리눅스에서 소프트웨어를 설치하는 가장 기본적인 방법은 배포판의 패키지 관리자를 사용하는 것입니다. 이 방식은 의존성 자동 해결, 패키지 서명 검증, 설치 히스토리 관리 등의 장점을 제공합니다.

주요 배포판 체계는 다음과 같습니다:
- **Debian 계열 (Ubuntu, Debian 등)**: `APT`(고수준) + `dpkg`(저수준)
- **RHEL/Fedora 계열**: `DNF`(현행), `YUM`(구버전 호환) + `rpm`

또한 다양한 보완적/대안적 설치 방법이 존재합니다:
- **Flatpak, Snap, AppImage**: 사용자 공간 격리 배포 방식
- **언어별 패키저**: `pipx`, `npm`, `cargo` 등
- **Nix/Guix**: 선언적/함수형 패키징 시스템
- **소스 빌드**: `./configure && make && sudo make install` (관리 비용이 높음)

---

## APT (Debian/Ubuntu 계열)

### 패키지 검색

```bash
apt search htop
apt search --names-only '^nginx$'
apt-cache policy nginx          # 후보 버전과 우선순위(핀)을 함께 확인
```

### 설치/업데이트/제거

```bash
sudo apt update
sudo apt install -y htop
sudo apt upgrade                # 보수적 업그레이드
sudo apt full-upgrade           # 의존성 변화(제거/치환)까지 허용
sudo apt remove htop            # 설정파일 유지
sudo apt purge htop             # 설정 포함 완전 제거
```

### 캐시/정리

```bash
sudo apt autoremove             # 더 이상 필요 없는 의존성 제거
sudo apt clean                  # 모든 .deb 캐시 삭제
sudo apt autoclean              # 오래된 캐시만 제거
```

### 실전 팁

```bash
# 재설치
sudo apt install --reinstall curl

# 추천 패키지 생략(미니멀 설치)
sudo apt install --no-install-recommends nginx

# 배포판 메타 정보 및 릴리스 업그레이드(서버는 신중히 진행)
lsb_release -a
sudo do-release-upgrade
```

---

## dpkg (저수준 조작)

### 설치된 목록/파일 확인

```bash
dpkg -l | grep curl
dpkg -L curl                   # curl 패키지가 배치한 파일 목록
dpkg -S /usr/bin/curl          # 특정 파일이 속한 패키지 찾기
```

### 수동 .deb 설치/제거 (주의: apt 사용 권장)

```bash
sudo dpkg -i package.deb
sudo apt -f install            # 깨진 의존성 복구
sudo dpkg -r package           # 제거(설정 유지)
sudo dpkg -P package           # 완전 제거(purge)
```

---

## APT 리포지토리·서명 관리 (현대식 방식)

### 소스 정의 (sources.list.d)

```bash
sudo tee /etc/apt/sources.list.d/example.list >/dev/null <<'SRC'
deb [signed-by=/usr/share/keyrings/example.gpg arch=amd64] https://repo.example.com/ubuntu noble main
SRC
```

### GPG 키 등록 (apt-key 폐기 → 키링 파일 권장)

```bash
curl -fsSL https://repo.example.com/pubkey.gpg \
  | sudo gpg --dearmor -o /usr/share/keyrings/example.gpg
sudo apt update
```

> 참고: `apt-key add`는 더 이상 권장되지 않습니다. **키링 파일 + `signed-by=`** 방식을 사용하세요.

### PPA 추가 (Launchpad)

```bash
sudo add-apt-repository ppa:neovim-ppa/stable
sudo apt update
```

### 멀티아키텍처 추가

```bash
sudo dpkg --add-architecture i386
sudo apt update
sudo apt install libssl1.1:i386
```

---

## APT 버전 고정·핀(Pinning)·다운그레이드

### 특정 버전 설치

```bash
apt-cache policy nginx
sudo apt install nginx=1.18.0-0ubuntu1
```

### 버전 고정(hold)

```bash
sudo apt-mark hold nginx
sudo apt-mark unhold nginx
```

### 우선순위 핀 (preferences)

```bash
sudo tee /etc/apt/preferences.d/nginx-pin >/dev/null <<'PIN'
Package: nginx
Pin: version 1.18.*
Pin-Priority: 1001
PIN
sudo apt update
sudo apt install nginx
```

**APT Pin-Priority 요약**

| 우선순위 | 효과 |
|---|---|
| `>1000` | 다운그레이드라도 강제로 설치 |
| `990~1000` | 배포판 기본보다 우선 |
| `500~989` | 후보 중 우선순위 높을수록 선호 |
| `<0` | 설치 금지 |

### 다운그레이드

```bash
sudo apt install nginx=1.18.0-0ubuntu1
```

---

## DNF (RHEL/Fedora 계열)

### 설치/업데이트/제거

```bash
sudo dnf install -y nginx
sudo dnf upgrade
sudo dnf remove nginx
```

### 검색/정보/파일목록

```bash
dnf search nginx
dnf info nginx
rpm -qi nginx
rpm -ql nginx
rpm -qf /usr/sbin/nginx       # 파일→패키지 역추적
```

### 히스토리/롤백/다운그레이드

```bash
sudo dnf history
sudo dnf history info 25
sudo dnf downgrade nginx
sudo dnf history undo 25      # 트랜잭션 단위 롤백(상황에 따라 충돌 가능)
```

### 메타데이터/캐시/클린

```bash
sudo dnf clean all
sudo dnf makecache
```

---

## DNF 리포지토리 관리

### 리포 파일 생성

```bash
sudo tee /etc/yum.repos.d/example.repo >/dev/null <<'REPO'
[example]
name=Example Repo
baseurl=https://repo.example.com/rpm/$releasever/$basearch
enabled=1
gpgcheck=1
gpgkey=https://repo.example.com/keys/RPM-GPG-KEY-example
priority=90
REPO
sudo dnf makecache
```

### EPEL/COPR/Config Manager

```bash
# EPEL 설치
sudo dnf install -y epel-release

# dnf-plugins-core 설치
sudo dnf install -y dnf-plugins-core
sudo dnf config-manager --add-repo https://download.example/repo.repo
sudo dnf copr enable owner/project
```

### 버전 고정 (Versionlock 플러그인)

```bash
sudo dnf install -y 'dnf-command(versionlock)'
sudo dnf versionlock add nginx-1.24.0-*
sudo dnf versionlock list
sudo dnf versionlock delete nginx
```

### 동기화(distro-sync)와 모듈 스트림

```bash
sudo dnf distro-sync               # 배포판 기준과 동기화
dnf module list nodejs
sudo dnf module enable nodejs:18
sudo dnf install nodejs
```

---

## RPM 로우레벨 조작 (필요 시)

```bash
sudo rpm -Uvh package.rpm          # 설치/업그레이드
sudo rpm -e package                # 제거
rpm -Va                            # 검증(해시/퍼미션 변경 탐지)
rpm --rebuilddb                    # 데이터베이스 재구성
```

> 실무에서는 **dnf**를 기본으로 사용하되, 진단/복구 상황에서만 `rpm` 저수준 명령을 활용하세요.

---

## 패키지 서명·무결성 확인

### APT

```bash
apt-cache policy nginx             # 리포 우선순위/서명 상태 간접 확인
sudo apt update                    # GPG 서명 에러 발생 시 키/소스 확인
```

### DNF/RPM

```bash
rpm -K package.rpm                 # 서명 검증
rpm -qi gpg-pubkey                 # 등록된 GPG 키 확인
```

---

## 소스에서 설치 (운용 패턴 포함)

### 표준 빌드 절차

```bash
tar -xvzf somepackage.tar.gz
cd somepackage
./configure --prefix=/usr/local
make -j"$(nproc)"
sudo make install
```

### 관리 편의 도구

- **checkinstall**: `make install` 대신 `.deb/.rpm` 생성하여 패키지 DB에 등록
```bash
sudo checkinstall --pkgname=somepackage --pkgversion=1.2.3
```
- **GNU Stow**: `/usr/local/stow/<pkg>`에 버전 디렉터리로 설치 후 심링크로 관리
```bash
sudo stow -d /usr/local/stow -t /usr/local somepackage-1.2.3
sudo stow -D -d /usr/local/stow -t /usr/local somepackage-1.2.3   # 제거
```

### 주의사항

- 시스템 파일을 덮어쓰지 않도록 **prefix**를 `/usr/local`로 고정하세요.
- 배포판 패키지와 **충돌**을 피하고, **PATH** 우선순위를 의식적으로 관리하세요.

---

## 대안 패키징: Flatpak/Snap/AppImage/Nix

### Flatpak

```bash
sudo apt install -y flatpak
flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
flatpak install flathub org.mozilla.Firefox
flatpak list
flatpak update
```

### Snap

```bash
sudo snap install --classic code
snap list
sudo snap refresh
sudo snap remove code
```

### AppImage

```bash
chmod +x AppName-x86_64.AppImage
./AppName-x86_64.AppImage
```

### Nix (사용자 공간, 선언적)

```bash
# 설치
sh <(curl -L https://nixos.org/nix/install) --daemon

# 임시 실행(쉘)
nix-shell -p hello

# 영구 설치(멀티 버전 공존 가능)
nix-env -iA nixpkgs.nodejs_20
```

---

## 리포지토리 미러/프록시/속도 개선

### APT 미러 변경 (예: 한국 KAIST/카카오 등)

```bash
sudo sed -i 's|archive.ubuntu.com|mirror.kakao.com|g' /etc/apt/sources.list
sudo apt update
```

### DNF fastestmirror 설정

```bash
sudo dnf install -y dnf-plugins-core
sudo tee /etc/dnf/dnf.conf >/dev/null <<'CONF'
[main]
fastestmirror=True
max_parallel_downloads=10
defaultyes=True
CONF
```

### 프록시 사용 설정

```bash
# APT 프록시 설정
sudo tee /etc/apt/apt.conf.d/01proxy >/dev/null <<'APT'
Acquire::http::Proxy "http://proxy.local:3128";
Acquire::https::Proxy "http://proxy.local:3128";
APT

# DNF 프록시 설정
sudo tee -a /etc/dnf/dnf.conf >/dev/null <<'DNF'
proxy=http://proxy.local:3128
DNF
```

---

## 자동 업데이트·보안 패치

### APT (Unattended Upgrades)

```bash
sudo apt install -y unattended-upgrades
sudo dpkg-reconfigure unattended-upgrades
sudo systemctl status unattended-upgrades
```

### DNF 자동화

```bash
sudo dnf install -y dnf-automatic
sudo sed -i 's/apply_updates = no/apply_updates = yes/' /etc/dnf/automatic.conf
sudo systemctl enable --now dnf-automatic.timer
systemctl list-timers | grep dnf-automatic
```

---

## 충돌/고장 진단과 복구 루틴

### APT 고장 (의존성 깨짐)

```bash
sudo apt -f install                  # 의존성 자동 복구
sudo dpkg --configure -a             # 설정 단계 재시도
sudo apt install -y --fix-broken
```

### 잠금/캐시/키 문제 해결

```bash
sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock
sudo apt clean
sudo apt update
# GPG 오류 발생 시 → 키링/소스 signed-by 재확인
```

### 패키지 파일 손상/누락 (RPM)

```bash
rpm -Va                                # 검증
sudo dnf reinstall <pkg>               # 재설치
```

### 어떤 패키지가 파일을 제공하는지 확인

```bash
# Debian/Ubuntu
apt-file update
apt-file search bin/psql

# RHEL/Fedora
sudo dnf provides */psql
```

---

## 실전 시나리오 모음

### 시나리오 1: 특정 버전 고정 + 팀 표준화

```bash
# 후보 버전 확인
apt-cache policy nginx

# 특정 버전 설치
sudo apt install nginx=1.24.0-2ubuntu1

# 핀/홀드로 고정
sudo tee /etc/apt/preferences.d/nginx-pin >/dev/null <<'PIN'
Package: nginx
Pin: version 1.24.0-2ubuntu1
Pin-Priority: 1001
PIN
sudo apt-mark hold nginx
```

### 시나리오 2: RHEL 서버에서 EPEL + COPR 활용

```bash
sudo dnf install -y epel-release dnf-plugins-core
sudo dnf copr enable atim/starship -y
sudo dnf install -y starship
```

### 시나리오 3: 배포형 앱은 Flatpak로 고립 설치

```bash
flatpak install -y flathub com.visualstudio.code
flatpak update
```

### 시나리오 4: 소스 빌드와 배포판 패키지 공존

```bash
# /usr/local 아래에만 설치 + Stow로 버전 관리
./configure --prefix=/usr/local
make -j"$(nproc)"
sudo make install
sudo stow -d /usr/local/stow -t /usr/local app-2.1.0
```

### 시나리오 5: DNF 히스토리 기반 롤백

```bash
sudo dnf history
sudo dnf history undo 35
```

---

## 명령어 요약 표

| 작업 | Debian/Ubuntu (APT) | RHEL/Fedora (DNF/YUM) |
|---|---|---|
| 검색 | `apt search`, `apt-cache policy` | `dnf search`, `dnf info` |
| 설치 | `apt install` | `dnf install`, `yum install` |
| 업데이트 | `apt update && apt upgrade` | `dnf upgrade`, `yum update` |
| 전체 업그레이드 | `apt full-upgrade` | `dnf distro-sync`(동기화) |
| 제거/완전제거 | `apt remove` / `apt purge` | `dnf remove` |
| 파일소속/목록 | `dpkg -S`, `dpkg -L` | `rpm -qf`, `rpm -ql` |
| 히스토리/롤백 | (기본 제공 X, 스냅샷 권장) | `dnf history`, `history undo` |
| 버전 고정 | `apt-mark hold`, Pin | `dnf versionlock` |
| 리포 추가 | `add-apt-repository`, sources.list.d | `.repo` 파일, `dnf config-manager` |
| 키 등록 | `gpg --dearmor` + `signed-by=` | `gpgkey=` + `gpgcheck=1` |
| 자동 업데이트 | `unattended-upgrades` | `dnf-automatic` |

---

## 결론

리눅스 패키지 관리는 배포판별로 다른 도구 체계를 가지고 있지만, 기본 원리는 유사합니다. APT와 DNF 모두 의존성 해결, 버전 관리, 보안 검증을 위한 강력한 기능을 제공합니다.

효율적인 패키지 관리를 위해 다음 원칙을 기억하세요:
1. **신뢰할 수 있는 저장소만 사용** - 무분별한 리포지토리 추가는 시스템 불안정을 초래할 수 있습니다.
2. **버전 통제의 중요성** - 프로덕션 환경에서는 핵심 패키지의 버전을 고정하여 예기치 않은 변경을 방지하세요.
3. **적절한 도구 선택** - 시스템 패키지는 배포판 관리자를, 사용자 애플리케이션은 Flatpak/Snap 등을 상황에 맞게 활용하세요.
4. **자동화와 모니터링** - 보안 패치 자동화를 설정하고 정기적으로 업데이트 상태를 확인하세요.
5. **문제 해결 체계** - 의존성 문제 발생 시 체계적인 진단과 복구 절차를 따라가세요.

패키지 관리 시스템을 효과적으로 활용하면 소프트웨어 설치, 업데이트, 유지보수가 훨씬 간편해지고 안정적인 시스템 운영이 가능해집니다.