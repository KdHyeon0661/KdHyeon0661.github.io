---
layout: post
title: AWS - S3 버전 관리와 복원
date: 2025-07-18 19:20:23 +0900
category: AWS
---
# 🔄 AWS S3 버전 관리와 복원 완벽 가이드

---

## 🧭 개요

S3 버킷은 기본적으로 객체에 **버전을 유지하지 않지만**,  
**버전 관리(Versioning)**를 활성화하면 같은 이름의 파일이 덮어쓰여도 **이전 버전이 유지**됩니다.

또한 실수로 삭제된 객체도 복원할 수 있어, **데이터 보호 및 백업** 관점에서 매우 유용합니다.

---

## 🧩 S3 버전 관리란?

S3에서 버전 관리를 활성화하면:

- 같은 키(Key)의 파일을 업로드해도 **기존 파일이 지워지지 않고**, 새 버전이 추가됩니다.
- `delete` 작업은 **객체를 실제 삭제하는 것이 아닌 "삭제 마커(Delete Marker)"를 추가**함
- 언제든 이전 버전으로 **복원 가능**

---

## 📦 기본 동작 흐름

| 작업 | 결과 |
|------|------|
| 버전 관리 ON | 객체마다 version ID 생성됨 |
| 파일 덮어쓰기 | 새 버전 추가됨 (이전 버전은 보존) |
| 삭제 시 | 삭제 마커 추가됨 (객체는 숨겨질 뿐 실제 삭제 X) |
| 복원 | 이전 버전 선택 후 복사로 복원 |

---

## 🛠️ 실습: 버전 관리 설정 및 테스트

### 1️⃣ 버킷 생성 및 버전 관리 활성화

1. S3 콘솔 → **버킷 생성**
2. 버킷 이름: `my-versioned-bucket`
3. **기본 설정**으로 생성
4. 버킷 → **“버전 관리” 탭 → 활성화**

---

### 2️⃣ 파일 업로드 및 수정

```bash
# 초기 파일 업로드
echo "Hello Version 1" > test.txt
aws s3 cp test.txt s3://my-versioned-bucket/

# 수정 후 재업로드
echo "Hello Version 2" > test.txt
aws s3 cp test.txt s3://my-versioned-bucket/

# 삭제
aws s3 rm s3://my-versioned-bucket/test.txt
```

---

### 3️⃣ 객체 버전 목록 확인

```bash
aws s3api list-object-versions --bucket my-versioned-bucket
```

출력 예시:

```json
{
  "Versions": [
    {
      "Key": "test.txt",
      "VersionId": "null",
      "IsLatest": false
    },
    {
      "Key": "test.txt",
      "VersionId": "u6dC7...N78",
      "IsLatest": true
    }
  ],
  "DeleteMarkers": [
    {
      "Key": "test.txt",
      "VersionId": "Abc123...",
      "IsLatest": true
    }
  ]
}
```

---

## ♻️ S3 복원 방법 (버전 되돌리기)

### ✅ 방법 1: 이전 버전을 복사하여 덮어쓰기

```bash
aws s3api copy-object \
  --bucket my-versioned-bucket \
  --copy-source my-versioned-bucket/test.txt?versionId=u6dC7...N78 \
  --key test.txt
```

- 위 명령어는 특정 버전의 객체를 현재 버전으로 복사하여 복원합니다.

---

### ✅ 방법 2: 삭제 마커 제거 (삭제 복구)

```bash
aws s3api delete-object \
  --bucket my-versioned-bucket \
  --key test.txt \
  --version-id Abc123...
```

- `Abc123...`은 삭제 마커의 버전 ID입니다.
- 삭제 마커 제거 후 최신 버전이 다시 표시됩니다.

---

## 🧯 S3 버전 관리가 중요한 이유

| 사용 사례 | 설명 |
|-----------|------|
| 실수 방지 | 덮어쓴 파일 복구 가능 |
| 삭제 복원 | 삭제된 파일도 복구 가능 |
| 감사 추적 | 변경 이력 기록 가능 |
| 보안 & 백업 | 데이터 유실 위험 감소 |

---

## 📁 버전 관리된 객체 구조

예를 들어 `myfile.txt`를 여러 번 업로드하면 다음과 같은 상태가 됩니다:

| 버전 ID | 상태 | 내용 |
|---------|------|------|
| `v3` | 삭제 마커 | 삭제 처리됨 |
| `v2` | 과거 버전 | 수정본 |
| `v1` | 최초 버전 | 초기 내용 |

---

## 🧹 오래된 버전 자동 정리 (수명 주기 정책)

### 예시: 180일 지난 이전 버전 자동 삭제

```json
{
  "Rules": [
    {
      "ID": "DeleteOldVersions",
      "Status": "Enabled",
      "NoncurrentVersionExpiration": {
        "NoncurrentDays": 180
      }
    }
  ]
}
```

> 이 설정은 최신 버전이 아닌 모든 이전 버전을 **180일 후 자동 삭제**합니다.

---

## ⚠️ 주의사항

| 항목 | 설명 |
|------|------|
| 비용 증가 | 모든 버전을 저장하므로 요금 증가 가능 |
| 복원은 수동 | 자동 복원이 아닌, 수동 복사로 수행해야 함 |
| 삭제 마커 제거 주의 | 잘못하면 실제로 파일 삭제될 수 있음 |
| 기본 상태는 "비활성화" | 버전 관리는 기본적으로 꺼져 있음 |

---

## 🔐 보안 및 감사 기능과의 연계

| 기능 | 설명 |
|------|------|
| CloudTrail | 객체 변경 이력 기록 |
| S3 Object Lock | 객체 잠금으로 버전 보호 |
| MFA Delete | 삭제 시 MFA 필요 설정 가능 (CLI만 지원) |

---

## ✅ 요약

| 기능 | 설명 |
|------|------|
| 버전 관리 | 같은 키의 객체도 이전 버전 유지 |
| 복원 | 특정 버전 복사 또는 삭제 마커 제거 |
| 삭제 보호 | 삭제 마커로 인해 실수 방지 가능 |
| 비용 최적화 | 수명 주기 정책과 함께 사용 권장 |

---

## 🧪 실전 팁

- 실무에서는 **버전 관리 + 수명 주기 정책 + 객체 잠금**을 함께 구성합니다.
- 특히 로그, 데이터 백업, 문서 관리 시스템에서 강력한 보호 기능을 제공합니다.