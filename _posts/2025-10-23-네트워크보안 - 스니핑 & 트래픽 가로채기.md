---
layout: post
title: 네트워크보안 - 스니핑 & 트래픽 가로채기
date: 2025-10-23 18:25:23 +0900
category: 네트워크보안
---
# 스니핑 & 트래픽 가로채기 (공격 관점의 이해, 방어 중심 실습)

> 핵심: “어떻게 훔쳐보는가”를 알아야 “어디서 막고 어떻게 잡는가”를 설계할 수 있다.
> 아래는 **원리 이해 + 합법적 방어 실습**에 초점을 맞춘다.

---

## 패시브 vs 액티브 스니핑, Promiscuous / Monitor Mode

### 스니핑 분류

- **패시브 스니핑(Passive)**: 네트워크에 **추가 트래픽을 만들지 않고** 흘러오는 프레임/패킷을 관찰.
  - 예: 허브/미러 포트에서 프레임을 그대로 캡처, Read-only TAP 등.
- **액티브 스니핑(Active)**: **네트워크 동작을 교란**하거나 **경로를 바꾸는** 트래픽을 의도적으로 발생시켜 가시성을 확보.
  - 예: ARP 캐시 변조, DHCP 위장, 라우터 광고(RA) 오염, 무선 Deauth 유도 등.

> 방어 관점에서 **패시브는 탐지가 어렵고**, 액티브는 **이상 이벤트(빈도/패턴)**로 흔적이 남는다.

### NIC 모드

- **Promiscuous Mode (유선/L2)**: 목적 MAC이 아니어도 **수신 가능한 프레임을 상위로 올림**. 스위치 포트 미러링이나 TAP에서 주로 사용.
- **Monitor Mode (무선/802.11)**: AP에 연결하지 않고 **무선 매체의 관리/제어/데이터 프레임**을 원시 상태로 캡처.

> 운영 팁(합법 환경): 수집 인터페이스는 **Read-only** 장비(TAP)나 **스위치 미러 포트**를 사용하고, 캡처 파일은 **암호화/보존기간 제한**을 준수.

### 안전 실습: “패시브 캡처만으로도 얻는 인사이트”

- **목표**: 패시브 캡처에서만도 재전송, 3-way/4-way 이상, MTU/PMTUD 실패 신호, DNS 오류 등을 찾는다.
- **도구**: tcpdump/Wireshark/TShark(2장에서 다룬 필터/Expert Info 재사용).
- **성과**: 액티브 공격 없이도, **취약 평문 프로토콜/오류 패턴**을 조기에 발견해 제거할 수 있다.

---

## 스위치 환경 스니핑: ARP 포이즈닝, MAC 플러딩, DHCP 스푸핑 (원리 이해 & 방어 실습)

> 아래 3가지는 모두 **액티브 스니핑**의 대표 격. **실전 악용 절차는 제공하지 않으며**,
> 대신 **원리**, **탐지 신호**, **방어 설정**, **안전한 시뮬레이션(모의/재현 데이터 생성)**을 제시한다.

### ARP 포이즈닝(IPv4) — 원리

- **목표**: 피해자의 ARP 캐시에 “게이트웨이 IP → 공격자 MAC”을 **거짓 매핑**으로 채워 넣어,
  피해자↔게이트웨이 트래픽이 공격자를 **경유**하도록 만든다(중간자).
- **부작용**: ARP Reply 폭증, 동일 IP에 대한 MAC 변경 빈발, 비정상 RTT/재전송.

#### 탐지 신호 (Zeek/Suricata·스위치)

- **ARP Reply 레이트 이상**(짧은 시간 같은 송신자에서 다량 응답)
- **IP↔MAC 매핑 변동**(짧은 시간 내 게이트웨이 MAC이 바뀜)
- **스위치**: 동일 포트에서 **다중 MAC 흔들림**(MAC move/flip), ARP insp. 로그
- **호스트**: `ip neigh` 기록 변화(자동 수집/베이스라인 비교)

#### 방어 (L2 장비·호스트)

- 스위치: **DAI(Dynamic ARP Inspection)**, **DHCP Snooping**(DAI가 신뢰할 DHCP 바인딩 활용), **Port Security**, **Private VLAN**
- 서버/게이트웨이: **Gratuitous ARP 모니터링**, 중요 노드에 **정적 ARP**(운영 영향 고려해 제한적으로)

#### 안전 시뮬레이션(탐지 룰 검증용 “합법적 변동 데이터” 만들기)

아래 코드는 **ARP 포이즈닝을 수행하지 않고**, 폐쇄 랩에서 **의도적 ARP 변동(자기 자신에 대한 GARP 반복)**을 만들어
탐지 시스템이 **“ARP 변동”을 경보**하는지 시험하는 **무해한 데이터 생성기**이다.

```python
# safe_arp_churn_generator.py
# 목적: 공격 없이도 "ARP 매핑 변동" 시그널을 발생시키는 안전 실습.
#       자신의 NIC로 GARP(Gratuitous ARP)를 주기적으로 보내 베이스라인 탐지를 테스트.
# 주의: 폐쇄 랩에서만 사용. 운영망 금지.

from scapy.all import ARP, Ether, sendp
import time, os

iface = os.environ.get("IFACE", "eth0")
# 본인 IP/MAC을 환경에 맞게 가져오거나, 인터페이스에서 자동 탐지하도록 확장 가능.

my_ip  = os.environ.get("MYIP",  "10.10.0.99")
my_mac = os.environ.get("MYMAC", "02:00:00:00:00:99")

frame = Ether(dst="ff:ff:ff:ff:ff:ff", src=my_mac)/ARP(op=2, psrc=my_ip, pdst=my_ip, hwsrc=my_mac, hwdst="00:00:00:00:00:00")
print(f"[i] Sending harmless GARP as baseline: {my_ip} is-at {my_mac} on {iface}")
for i in range(10):   # 10회만, 테스트 완료 후 종료
    sendp(frame, iface=iface, verbose=False)
    time.sleep(2)
print("[i] Done. Check ARP churn alerts in your NDR/SIEM.")
```

> 이 코드로 **탐지 파이프라인**(Zeek 로그 → SIEM 룰)이 **잔변동에도 경보를 내는지/적절히 튜닝되는지** 검증할 수 있다.

---

### MAC 플러딩 — 원리

- **목표**: 스위치의 MAC 주소 테이블을 **과도하게 채워**(혹은 오버플로우 유도),
  일부 트래픽이 브로드캐스트/플러딩처럼 **모두에게 흘러가도록** 만들어 스니핑 기회를 만든다.
- **현대 장비**: 보호 메커니즘(테이블 보호, 레이트 리미트)이 잘 되어 있고, 로그/알람이 남는다.

#### 탐지·방어

- 스위치: **MAC move rate**, **unknown unicast flood** 알림, **storm control**, **port security(max MAC 수 제한)**, **QoS/폴리싱**
- NDR: 인터페이스 단위 **unknown unicast 비중 급증**, **MAC 학습 이벤트 폭증** 시 경보

#### 안전 시뮬레이션(무해한 트래픽 패턴)

MAC 플러딩 자체는 **의도적으로 수행하지 말 것**. 대신, **테스트 VLAN**에 제한된 속도/기간의
**랜덤 소스 MAC** 패턴을 **스위치 내부 트래픽 제너레이터(벤더 기능)**나 시뮬레이터로 만들고,
스위치가 **적절히 rate-limit/경보**하는지만 확인한다(실제 데이터/명령은 벤더 가이드 사용).

---

### DHCP 스푸핑 — 원리

- **목표**: 피해자가 **거짓 DHCP 서버**에게서 IP/GW/DNS를 받아 **공격자 경유**로 트래픽이 흐르도록 만든다.
- **신호**: 단일 브로드캐스트 도메인 내 **복수의 DHCP Offer/ACK**,
  클라이언트의 **게이트웨이/DNS 설정**이 순간적으로 바뀜 → 접속 오류·피싱.

#### 탐지·방어

- **스위치**: **DHCP Snooping**(trusted/untrusted 포트 지정, 바인딩 테이블 유지)
- **NDR**: 동일 VLAN에서 **다중 DHCP 서버 IP** 활동 감지, DHCP 옵션(라우터/DNS) 변경 추세
- **호스트**: 의심 시 `ipconfig /all`(Win), `nmcli dev show`(Linux)로 DHCP 서버/라우터/DNS 확인

#### 안전 시뮬레이션(탐지 검증)

공격성 DHCP 서버 운영은 금지. 대신, **샌드박스/시뮬레이터**가 **DHCP Offer 기록만 생성**하도록 구성한 뒤
콜렉터에서 **“둘 이상의 서버가 Broadcast에 응답했다”**는 **메타 지표**를 합성하여 탐지 규칙을 시험한다.

---

## 무선 스니핑: 802.11 프레임, Evil Twin, Deauth/재연결 유도 (원리 이해 & 방어 실습)

> 무선은 **공유 매체**라서, 연결하지 않고도 **관리/제어 프레임**을 볼 수 있다(모니터 모드).
> 다만, **Deauth/재연결 유도** 등은 실제 공격을 재현하지 말고, **탐지/방어 로직**을 시뮬레이션으로 검증한다.

### 프레임 훑어보기

- **관리(Management)**: Beacon(SSID/RSN IE), Probe, Authentication, Association, **Deauthentication**, Disassociation 등
- **제어(Control)**: RTS/CTS/ACK, PS-Poll 등
- **데이터(Data)**: 실제 상위 계층 데이터(암호화 여부는 보안 모드에 따라 다름)

#### 패시브 관찰 포인트

- Beacon의 **RSN 정보요소**(WPA2/WPA3, Cipher Suite, AKM) → **취약 구성(AP) 식별**
- 동일 BSSID/다중 SSID(멀티-SSID) 정책 확인
- 채널 사용률, 재시도율, 데이터/관리 프레임 비율

### Evil Twin(사칭 AP) — 원리

- **목표**: 합법 AP와 동일/유사 SSID-BSSID(혹은 동일 SSID 다른 BSSID)를 광고하여
  피해 클라이언트가 **사칭 AP에 접속**하도록 유도(캡티브 포털/자격 증명 갈취 등).
- **신호**: 동일 SSID에 대해 **BSSID가 비정상적으로 많음**, RSSI/채널 이동 이상, 인증 실패/포털 리다이렉트 증가.

#### 방어·탐지

- **WPA3/SAE, 802.1X(EAP-TLS 권장)**: 암호/서버 인증 강화를 통해 사칭 난이도↑
- **WIPS/WIDS**: 동일/유사 SSID에 대한 **BSSID 화이트리스트/블랙리스트**, 채널/전파 시그니처 기반 탐지
- **사용자 단**: 기업 단말은 **프로파일 고정**(인증서 기반), 오픈/PSK SSID 자동연결 금지

#### 안전 시뮬레이션

- **사칭 AP를 실제로 띄우지 않고**, 무선 센서(모니터 모드)에서 **합성 로그**(“동일 SSID 다수 BSSID 출현”, “이동 채널”)를 주입하여
  **WIDS 룰/알람**이 정상 동작하는지 확인(도구/방법은 환경별 무선 관리 시스템 가이드 준수).

### Deauth/재연결 유도 — 원리

- **목표**: 클라이언트를 일시적으로 떼어내고(**Deauthentication/Disassociation**),
  재연결 과정에서 사칭 AP로 유도하거나, **핸드셰이크 캡처**를 노림(구버전에서).
- **신호**: **Deauth/Disassoc 프레임 빈발**, 특정 BSSID 타겟팅, 재연결/재시도 급증, RSSI 급격한 변화

#### 방어·탐지

- **802.11w(Protected Management Frames, PMF)**: 관리 프레임 보호(WPA2-Enterprise/WPA3에서 권장)
- **WIDS 룰**: 단기간 **Deauth/Disassoc 카운트** 임계치 초과, 특정 STA/BSSID 집중도
- **AP 정책**: 로밍/핸드오버 이벤트 로깅, 클라이언트 재시도율 모니터링

#### 안전 시뮬레이션(Deauth 자체 금지)

다음 코드는 **Deauth 프레임을 보내지 않고**, **탐지기가 기대하는 카운트·패턴만 합성**하는 예시(파일 생성)이다.
WIDS/SIEM에 **테스트 이벤트**로 주입해 알람/대응 파이프라인을 검증한다.

```python
# synth_deauth_events.py
# 목적: 무선 Deauth 공격을 재현하지 않고, 탐지 시스템 검증용 이벤트(로그 줄)만 합성

import time, random, json, sys

ssid   = "CorpWiFi"
bssid  = "AA:BB:CC:DD:EE:FF"
target = "11:22:33:44:55:66"  # 테스트 클라이언트 MAC (가상)
events = []
t0 = int(time.time())

for i in range(30):  # 30건의 합성 이벤트
    events.append({
        "ts": t0 + i,
        "event": "DEAUTH_OBSERVED_SYNTH",
        "ssid": ssid,
        "bssid": bssid,
        "dst_sta": target,
        "rssi": -40 - random.randint(0,10),
        "count_in_window": i+1
    })

print("\n".join(json.dumps(e) for e in events))
print("\n[i] feed this NDJSON to your WIDS/SIEM test endpoint.")
```

---

## 암호화 시대의 스니핑: 평문 프로토콜 위험, SNI·JA3/JA4 메타데이터

### “평문은 즉시 제거” — 왜?

- HTTP, FTP, Telnet, POP3/IMAP(비TLS), LDAP(389), SNMPv1/2c 등은 **크리덴셜이 평문**이거나 쉽게 노출.
- 스니핑·MITM 없이도, **패시브 캡처만으로** 민감 정보가 드러날 수 있음.
- **정책**: 전송 암호화 **Mandatory**(HTTPS, SMTPS/IMAPS/LDAPS, SNMPv3), 리다이렉트/HSTS/mTLS 등.

#### 탐지 예시(TShark)

```bash
# 평문 자격증명 패턴만 카운트(테스트망/샘플 PCAP에 한함)

tshark -r cap.pcap -Y 'http.request.method == "POST" && http contains "password="' \
  -T fields -e frame.number | wc -l
```
> 운영망에서는 **페이로드 저장을 기본 금지**하고, 필요한 경우에도 **마스킹/암호화·보존기간 엄수**.

### TLS 메타데이터: SNI, JA3/JA4

- **SNI (Server Name Indication)**: TLS 클라이언트헬로에 호스트명이 평문으로 들어감(ESNI/Encrypted ClientHello는 일부 환경).
  → **도메인 기반 정책/탐지** 가능(도메인 평판, 차단 목록, DGA 탐지 등).
- **JA3/JA3S (TLS 핸드셰이크 지문)**: 클라이언트/서버의 Cipher Suites, Extensions, Versions 등을 해시한 지문.
  → **멀웨어/툴킷 고유 조합** 식별에 유용(오탐 주의).
- **JA4 (차세대 지문)**: TLS 뿐 아니라 **HTTP 등 L7** 지문 확장으로 **내성/안정성**을 개선한 접근.

#### 안전 실습: JA3 해시 추출(PCAP→TShark)

```bash
# 필드 지원 빌드 기준(배포판에 따라 다름). 일반적 대안: Zeek 스크립트/Suricata EVE 로그 사용.
# TLS Client Hello만 추출

tshark -r cap.pcap -Y "ssl.handshake.type == 1" -T fields -e ip.src -e tcp.dstport -e _ws.col.Info | head

# JA3는 보통 Zeek/Suricata 로그에서 추출해 SIEM으로 보낸다.
# 예: Suricata EVE(JSON)에서 tls.ja3_hash 필드 집계

jq -r 'select(.event_type=="tls") | .tls.ja3_hash' eve.json | sort | uniq -c | sort -nr | head
```

#### 정책 적용 아이디어

- **허용 지문 화이트리스트**: 업무 표준 브라우저/SDK의 JA3/JA4 지문을 베이스라인.
- **블록/관찰 목록**: 알려진 악성 툴킷 지문은 차단/격리 정책(오탐 최소화 위해 관찰부터).

### TLS 가시성 vs 프라이버시/컴플라이언스

- **SSL Inspection(프록시 복호)**는 강력하나 **법/규정/프라이버시** 고려가 우선.
- 대안: **메타데이터 기반**(SNI/JA3/JA4/증분 통계), **mTLS(내부)**로 제어 강화, 서버/클라이언트 **하드닝**.

---

## 부록 A — Suricata/Zeek 탐지 룰 예시(개념용)

> 실제 배포 전 반드시 **테스트망**에서 조정/검증하고, **오탐/성능 영향**을 점검하세요.

### A.1 ARP 이상 (Suricata)

```conf
# ARP Reply 폭증 (간단 개념 예시)

alert ether any any -> any any (msg:"ARP storm suspected";
  ether type 0x806;
  detection_filter:track by_src, count 60, seconds 10;
  sid:4201001; rev:1;)
```

### A.2 DHCP 다중 서버 감지 (Zeek 스크립트 개념)

```zeek
# dhcp_multi_server.zeek (개요)

@load protocols/dhcp

event dhcp_ack(c: connection, msg: dhcp_msg, yiaddr: addr, siaddr: addr, subnet_mask: addr, router: dhcp_option_list, lease: interval) {
  # ack가 서로 다른 siaddr에서 일정 시간 창에 반복되면 경고
  # 실제 구현에선 테이블/타이머로 누적 후 임계치 비교
}
```

### A.3 TLS JA3 블랙리스트(개념)

```json
// SIEM 룰 개념: eve.json에서 tls.ja3_hash ∈ {악성 지문 목록}이면 알림
// {"when": "event_type==tls && tls.ja3_hash IN BADSET", "then": "alert tag=ja3_blacklist"}
```

---

## 부록 B — 운영 체크리스트

- [ ] **평문 프로토콜 제거** 정책 및 스캐너/감시(자격증명 평문 전송 차단).
- [ ] **L2 보안**: DHCP Snooping(+DAI), Port Security, Private VLAN, uRPF(라우팅).
- [ ] **WPA3/802.1X(EAP-TLS), 802.11w(PMF)**: 무선 관리 프레임 보호.
- [ ] **WIDS/WIPS 룰**: Deauth/Disassoc 빈도, Evil-Twin 신호(동일 SSID 다중 BSSID, 채널 급변).
- [ ] **NDR 가시성**: ARP/DHCP 이상, TLS SNI/JA3/JA4, DNS 이상행위.
- [ ] **로그 파이프라인**: Zeek/Suricata→SIEM, 보관·마스킹·암호화 준수.
- [ ] **정기 드릴**: 합법 시뮬레이션(합성 이벤트/무해한 패턴)으로 룰 회귀 테스트.

---

## 마무리

- 스니핑/가로채기 기법은 **원리 이해**만으로도 **방어·탐지 설계**에 큰 가치를 준다.
- 본 가이드는 **공격 재현 없이도** 탐지/완화 체계를 검증할 수 있도록 **무해한 시뮬레이션·합성 데이터**를 제공했다.
- 실제 운영 적용 전, **테스트망에서 룰 튜닝 → 오탐/성능 평가 → 점진 적용** 순서를 지켜라.
