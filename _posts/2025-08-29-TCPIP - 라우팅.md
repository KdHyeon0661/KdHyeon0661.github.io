---
layout: post
title: TCPIP - 라우팅
date: 2025-08-29 19:25:23 +0900
category: TCPIP
---
# 라우팅

**(🔰 정적 vs 동적 라우팅, ⚙️ IGP(RIP/OSPF/IS-IS) vs EGP(BGP), 🚀 BGP 피어링·경로 선택·ECMP·PBR 개요)**

> 이 글은 L3 라우팅을 **설계·운영·트러블슈팅** 관점으로 정리합니다.
> “정적 ↔ 동적”의 본질부터 IGP/EGP 역할 분담, 그리고 **BGP 피어링/경로선택/ECMP/정책라우팅(PBR)**까지 **현장 예제**와 함께 설명합니다.
> 코드 대신 **텍스트 다이어그램/명령 개념/표**를 사용하고, 수식은 MathJax로 표기합니다.

---

## 왜 라우팅인가

- IP 네트워크의 본질은 “**목적지까지의 다음 홉 결정**”입니다. 이 결정이 느리거나 틀리면 L7의 **지연·타임아웃·경로 불안정**으로 체감됩니다.
- 라우팅은 **정책(Policy)**의 산물입니다. 최단 경로가 아닌 “**사업/운영 정책에 맞는 경로**”가 선택되는 것이 일반적입니다.

---

## 정적 라우팅 vs 동적 라우팅 (🔰)

### 개념 요약

| 구분 | 정적 라우팅 | 동적 라우팅 |
|---|---|---|
| 경로 학습 | **수동**(관리자 설정) | **프로토콜**로 자동 교환 |
| 수렴/복구 | 변경 시 수동 반영 | 링크 이벤트 기반 **자동 수렴** |
| 오버헤드 | 낮음(프로토콜 트래픽 없음) | 존재(헬로/LSA/업데이트) |
| 확장성 | 제한적(규모↑ → 관리난) | 대규모에 적합 |
| 예시 | 소형지사, 단순 디폴트 경로 | 캠퍼스/데이터센터/ISP 백본 |

### 언제 정적, 언제 동적?

- **정적 추천**:
  - **엣지 디폴트** 한 줄로 인터넷 탈출(`0.0.0.0/0`, `::/0`).
  - **소규모 지사**(경로 수 적고 토폴로지 고정).
  - **블랙홀 라우트**(특정 프리픽스 흡수, DDoS 완화·RPKI Invalid 처리를 위한 null0 등).
- **동적 추천**:
  - **링크가 여러 개**이고 장애/용량 변화가 잦은 환경.
  - **경로 수 많은** 캠퍼스/데이터센터/ISP.
  - **정책/요금/피어링**에 따라 경로가 수시로 바뀌는 환경.

### 예제 A — “지사망 디폴트 + 특정 본사망만 정적”

```text
지사 R1
- 0.0.0.0/0 → ISP (인터넷)
- 10.10.0.0/16 → 본사 터널(혹은 전용선)로 정적
- 나머지는 디폴트로 인터넷 탈출, 본사 대역만 전용 경로
장점: 간단/예측 가능, 장애면 관리자가 바꿔야 함
```

---

## IGP vs EGP (⚙️)

### 역할 구분

- **IGP(Interior Gateway Protocol)**: **하나의 AS 내부**에서 경로를 주고받는 프로토콜. 예: **RIP(거리벡터), OSPF/IS-IS(링크상태)**
- **EGP(Exterior Gateway Protocol)**: **AS 간** 경로 교환. 사실상 **BGP**(경로벡터)가 표준.

> **디자인 원칙**: **IGP는 빠르고 가볍게** 내부 리치빌리티(도달성)만, **BGP는 정책**(금액·사업·피어링) 중심으로 외부 경로를.

### IGP 비교: RIP vs OSPF vs IS-IS

| 항목 | RIP | OSPF | IS-IS |
|---|---|---|---|
| 유형 | 거리벡터 | 링크상태 | 링크상태 |
| 메트릭 | 홉 수(최대 15) | 비용(대역폭 기반 가중치) | 비용(디폴트 10, 가변) |
| 수렴 속도 | 느림 | 빠름 | 빠름 |
| 스케일 | 소규모 | 중~대규모 | 대규모(서비스 제공자 선호) |
| 영역/레벨 | 없음 | Area(백본 Area 0) | Level-1/Level-2(2계층) |
| 인증/보안 | 단순 | 강력(MD5 등) | 강력(MD5 등) |
| 멀티링크/ECMP | 제한 | 가능 | 가능 |

- **RIP**: 단순하지만 **수렴 느림/루프 방지 기법**(Split Horizon, Poison Reverse, Holddown) 의존.
- **OSPF**: **SPF(Dijkstra)**로 최단 경로, **Area**로 LSDB 범위 분리, 다양한 **LSA 타입**, **DR/BDR** 개념(브로드캐스트망).
- **IS-IS**: **OSI 프로토콜** 기반, IP를 TLV로 운반. **Level-1/2** 구조로 대규모에 강함. 서비스 제공자/데이터센터에서 선호.

#### 예제 B — “OSPF Area 설계”

```text
Area 0(백본): 코어/집선
Area 10: R&D 빌딩
Area 20: 생산동
- LSA 범위를 지역화(변화 소음 감소)
- 요약(Summarization)으로 라우팅 테이블 축소
- 단, 모든 Area는 Area 0에 논리적으로 연결되어야 함
```

### EGP: BGP의 역할

- **BGP**는 홉 수가 아닌 **정책 속성**으로 경로를 고릅니다(LOCAL_PREF, AS_PATH, MED, 등).
- **인터넷 전체 경로**(수십만 프리픽스)를 다루기에 확장성·정책성에 초점.

---

## BGP 기본 (🚀)

### iBGP vs eBGP

- **eBGP**: 서로 다른 AS 간 피어링(보통 TTL=1, **GTSM**으로 보호, **멀티홉** 구성도 가능).
- **iBGP**: 같은 AS 내부 피어링(**풀메시** 필요 → 규모 시 **Route Reflector(RR)**, **Confederation**으로 확장).

> **iBGP 규칙**: iBGP는 기본적으로 **학습한 경로를 다른 iBGP 피어에 재전달하지 않음**(Full-mesh 필요). RR가 이를 완화.

### BGP 세션 상태와 메시지

- **세션 상태**: Idle → Connect → Active → OpenSent → OpenConfirm → **Established**
- **메시지 타입**: **OPEN**, **UPDATE**, **KEEPALIVE**, **NOTIFICATION**
- **보안/안정**: **TCP MD5/TCP-AO**, **TTL 보안(GTSM)**, **Max-Prefix**(폭주 방지), **Graceful Restart/Shutdown**.

### 경로 속성(선택 순서의 핵심)

일반적(벤더마다 약간 차이)인 **선택 우선순위** 개요:
1) **최고 LOCAL_PREF** (내부 선호도)
2) **최단 AS_PATH**
3) **ORIGIN** 타입(IGP < EGP < Incomplete)
4) **최저 MED** (같은 인접 AS 비교 시)
5) **eBGP** 경로 우선 (iBGP보다)
6) **IGP 비용(Next-hop까지)** 최저
7) **가장 오래된 경로** 또는 **최소 라우터-ID** 등 타이브레이커

> **정책의 핵심**: **LOCAL_PREF**(내부 유출/유입 선호), **AS-PATH Prepend**(외부에서 덜 선호되게), **MED**(이웃에게 “이쪽으로 들어와” 힌트), **Communities**(NO_EXPORT 등).

### 커뮤니티와 라지 커뮤니티

- **Community**: 32비트(두 필드로 표기 `X:Y`), 정책 태깅(예: 지역별, 보안별, 블랙홀).
- **Well-known**: `no-export`, `no-advertise`, `internet`.
- **Large Community**: 96비트( `Global:Local1:Local2` )로 영역을 넓힘.

### Next-Hop, Next-Hop-Self

- iBGP에서 **다른 AS에서 배운 경로**는 next-hop가 **원래 eBGP 이웃**으로 남습니다.
- 중간 RR/경계 라우터는 **`next-hop self`**로 자신을 다음 홉으로 바꿔 **내부 경로 가시성/수송성**을 확보.

---

## 경로 선택·정책 예제 (🚀)

### 예제 C — “두 ISP, 업링크 우선순위”

```text
AS 65001 (우리) — eBGP — ISP-A(AS 64500)
AS 65001 (우리) — eBGP — ISP-B(AS 64501)

목표: 유출(아웃바운드) 트래픽은 기본적으로 ISP-A로, 장애 시 ISP-B로
방법: iBGP/내부 라우터에 **LOCAL_PREF** 높게(예: A=200, B=100)
효과: BGP 선택 1순위에서 A 경로 우선 → 장애 시 B 경로로 수렴
```

### 예제 D — “특정 프리픽스만 우회”

```text
목표: 203.0.113.0/24 목적지는 ISP-B로 보내고, 나머지는 ISP-A
방법: route-map으로 203.0.113.0/24 매칭 → **LOCAL_PREF**를 B 경로에만 높임
주의: 역방향(리턴 트래픽)은 타 AS의 정책에 좌우 → **대칭성 보장 X**
```

### 조정: AS-PATH Prepend”

```text
목표: 외부(인터넷)에서 우리 AS로 들어오는 유입은 ISP-A로 몰고, ISP-B는 백업
방법: ISP-B로 광고하는 우리 프리픽스에 **AS-PATH Prepend** 3회 등 → '길게' 보이게 하여 선호도↓
주의: 완전한 보장 X(상대 AS 정책·로컬프리퍼런스가 더 강력)
```

### 예제 F — “MED로 이웃에게 ‘이쪽으로 들어와’ 힌트”

```text
조건: 같은 이웃 AS와 여러 경계(POI)가 연결되어 있을 때
방법: 특정 경계의 **MED을 낮게**(선호↑) 설정
주의: “같은 인접 AS”에만 비교 유효. 로컬프리퍼런스에 비해 우선순위 낮음
```

---

## (🚀)

### 개념

- **IGP/OSPF/IS-IS**: 목적지까지 **동일 비용** 경로가 여러 개면 **분산**(일반적으로 **흐름 기반 해시**)
- **BGP Multipath**: 동일 속성의 경로 여러 개를 **활성**으로 두어 분산(플래그/정책 필요)

### 해시와 재정렬

- **Per-flow 해시**(5-튜플 등): **패킷 순서 보장**(흐름 단위 고정).
- **Per-packet**: 경로별 지연 차이로 **패킷 재정렬** → TCP 성능 악화. 일반적으로 **권장 X**.

### 예제 G — “리프-스파인 데이터센터”

```text
스파인2대, 리프N대(각 리프↔스파인 2링크)
- 모든 리프에서 스파인으로의 IGP 비용이 동일 → 대규모 **ECMP**
- 서버↔서버 트래픽이 스파인-리프 레벨에서 자연 분산
- 대체로 IS-IS/OSPF 또는 eBGP underlay + iBGP/EVPN overlay 설계
```

---

## (🚀)

### 개념

- **FIB 조회(목적지 기반)** 대신 **정책(소스/포트/DSCP/어플리케이션 등)**으로 다음 홉을 지정.
- 상태: 라우팅 테이블과 별개로 **route-map** 평가 → **다음 홉 강제**.

### 활용

- **인터넷 브레이크아웃 분리**: 개발망은 ISP-A, 사무망은 ISP-B.
- **특정 앱/포트 우선 경로**: VoIP/미디어를 지연 낮은 경로로.
- **캡티브 포털/프록시**: 특정 서브넷만 인증망·프록시로 보냄.

### 주의사항

- **비대칭 경로** 유발 위험(리턴 트래픽은 상대 정책).
- 복잡한 **트러블슈팅 난이도** 상승.
- PBR 실패 시(다음 홉 불가) **폴백** 정책 필요.
- 대규모 환경에서는 PBR 남발 대신 **BGP 정책**으로 푸는 것이 유지보수에 유리.

### 예제 H — “개발망만 로컬브레이크아웃”

```text
조건: 사무망/개발망 VLAN 분리
정책: 소스=개발망(10.20.0.0/16) → 다음 홉=로컬 ISP-A
나머지: 기본 경로(본사 DC 방화벽) 유지
주의: 클라우드/SaaS 리턴 경로 비대칭 가능성 검토, 모니터링 필수
```

---

## 라우트 재분배, 요약, 기본경로, 백업

### 라우트 재분배(Redistribution)

- IGP↔IGP, IGP↔BGP 사이에 경로를 **주입**.
- **루프/폭주 위험**: **태그/메트릭/필터**로 제어.
- 예: OSPF ↔ BGP 간 DC 게이트웨이에서 서버 프리픽스를 외부에 광고.

### 요약(Summarization)

- 여러 프리픽스를 **상위 프리픽스**로 묶어 테이블 축소/경계 안정화.
- OSPF **Area 경계**, BGP **에지**에서 활용.

### 기본경로(Default)

- **디폴트만** 내부로 주입해 단말/지사 복잡도 감소.
- 이중 업링크 시 **디폴트 2개+LOCAL_PREF/백업**으로 단순 제어.

### 예제 I — “BGP로 기본경로만 주입”

```text
엣지 라우터(인터넷 전체 테이블 O) → 코어(테이블 없음)
- 코어로는 0.0.0.0/0, ::/0만 iBGP로 주입
- 내부 라우팅은 IGP로 단순 유지
```

---

## 안정성·신속성: 타이머, BFD, FRR

### 타이머

- IGP **Hello/Dead** 타이머, BGP **Keepalive/Hold** 타이머.
- 지나친 단축은 **CPU/플랩** 유발. 도메인 특성에 맞춰 설정.

### BFD(Bidirectional Forwarding Detection)

- **하위 계층과 무관하게** 매우 짧은 간격(수 ms)으로 상호 소식 → **빠른 다운 탐지**.
- OSPF/IS-IS/BGP와 연동해 수렴 가속.

### FRR(Fast Reroute)

- **LFA/TI-LFA**(IGP)로 사전 계산된 백업 경로로 즉시 전환.
- BGP도 **PIC Core/Edge** 등 벤더 메커니즘으로 빠른 컨버전스.

---

## 보안·위생

- **프리픽스 필터링**: 고객/피어 입구에서 허용 목록(단, 합의된 대역만).
- **Max-Prefix**: 비정상 업데이트 폭주 차단.
- **MD5/TCP-AO**: BGP 세션 보호.
- **GTSM**: TTL 확인으로 원격 스푸핑 방지.
- **RPKI(ROA 검증)**: 경로 유효성 검증(Invalid → 드롭/로컬 정책).
- **보안 경계**: iBGP 경계에 ACL/RTBH(원격 블랙홀) 연계.

> *RPKI/ROA/IRR 운영은 조직 정책·벤더 가이드에 맞춰 점진 도입을 권장합니다.*

---

## 트러블슈팅 체크리스트

### 공통

```text
- 목적지 프리픽스가 라우팅 테이블에 있는가? (Longest-Prefix)
- 다음 홉에 대한 IGP 리치빌리티가 있는가?
- 대칭성: 리턴 경로가 다른가? (방화벽/ACL 영향)
```

### IGP

```text
- OSPF: Area-0 연결성, DR/BDR 상태, LSA 플러딩/Neighbor State(Full?) 확인
- IS-IS: Level-1/2, Adjacency 상태, LSP 수명/서명
- 요약/재분배 지점에서 누락/루프?
```

### BGP

```text
- 세션 상태 Established? (Idle/Active 반복은 TCP/필터/ASN/패스워드/멀티홉 의심)
- 경로 속성: LOCAL_PREF/AS_PATH/MED/COMMUNITY에 정책이 맞게 들어왔는가
- Next-hop reachable? (iBGP에서 next-hop self 누락 흔함)
- Max-Prefix 초과/프리픽스 필터로 Drop?
- RPKI Invalid 정책으로 차단?
```

### ECMP/PBR

```text
- 해시 편향: 특정 멤버만 포화?
- Per-packet 로드밸런싱으로 재정렬?
- PBR로 다른 경로 강제 → 리턴 비대칭/방화벽 세션 테이블과 충돌?
```

---

## 미니 랩(개념 중심)

### 랩 1 — 정적 + 디폴트

```text
R1(지사) — R2(본사)
- R1: 0.0.0.0/0 → R2
- R2: 10.10.10.0/24 → R1
테스트: 본사 서비스만 전용 경로, 나머지 인터넷은 R2 방화벽 경유
장애: R2 다운 → R1 인터넷 단절(정적의 한계 체감)
```

### 랩 2 — OSPF 두 영역 + 요약

```text
Area 0: 코어
Area 10: 사무동 (10.10.0.0/16)
Area 20: 생산동 (10.20.0.0/16)
- ABR에서 각 /16을 Area 0에 요약 광고
효과: 코어 라우터의 라우팅 테이블 간결, 변화 소음 감소
```

### 랩 3 — eBGP 듀얼 ISP + LOCAL_PREF

```text
AS 65001 ↔ AS 64500(ISP-A), AS 64501(ISP-B)
- 내부 iBGP RR 구성
- A 경로 LOCAL_PREF=200, B=100
테스트: 기본은 A, A 다운 시 B로 수렴
추가: 특정 프리픽스만 B 선호로 라우트맵 매칭
```

### 랩 4 — AS-PATH Prepend로 유입 조정

```text
우리 프리픽스 203.0.113.0/24
- ISP-A: 그대로 광고
- ISP-B: AS-PATH Prepend 3회
관찰: 외부 Looking Glass로 각지에서 어느 ISP로 들어오는지 확인
```

### 랩 5 — BFD + OSPF 수렴 체감

```text
링크 다운 감지에 BFD 적용(50ms/3회 등)
- OSPF Hello/Dead 유지 시에도 빠른 다운 인지 → SPF 재계산
관찰: 장애→수렴까지 지연 감소
```

---

## 수식·개념 메모

### 최장일치(Longest-Prefix Match)

\[
\text{선택 경로} = \arg\max_{r \in \mathcal{R}} \bigl(\text{prefix\_len}(r)\bigr) \quad \text{s.t. 목적지} \in r
\]

### 비용 합산(링크상태·SPF 직관)

\[
\text{최단 경로} = \arg\min_{p \in \mathcal{P}} \sum_{e \in p} w(e)
\]
- \(w(e)\): 링크 비용(OSPF: 참조대역폭/링크속도 기반 등).

### BGP 정책 체인(개념)

\[
\text{LOCAL\_PREF} \; \triangleright \; |\text{AS\_PATH}| \; \triangleright \; \text{ORIGIN} \; \triangleright \; \text{MED} \; \triangleright \; \text{eBGP/iBGP} \; \triangleright \; \text{IGP 비용} \; \triangleright \; \text{타이브레이커}
\]

---

## 운영 베스트 프랙티스

- **IGP는 가볍게**: 내부 도달성만, **요약/에어리어/레벨**로 스케일.
- **BGP는 정책**: LOCAL_PREF(유출), AS-PATH Prepend/MED(유입 유도), 커뮤니티로 **표준화된 정책 태깅**.
- **ECMP**: **Per-flow** 해시, 멤버 속도/지연 일치, 모니터링으로 편향 감시.
- **PBR는 최소화**: 필요 구간에 한정, 비대칭·장애 시 폴백 정책 필수.
- **재분배/요약**: 루프·폭주 방지(태그/필터), 테이블 축소로 안정성↑.
- **BFD/FRR**로 **탐지·수렴 가속**, 그러나 과도한 타이머 단축은 **불안정**.
- **보안**: 프리픽스/AS-PATH 필터, Max-Prefix, MD5/TCP-AO, GTSM, RPKI.
- **문서화/가시성**: 토폴로지, 정책(로컬프리퍼런스·커뮤니티), 타이머, 알람 기준(세션 다운/플랩/Max-Prefix).

---

## 한 장 요약(포스터)

- **정적 vs 동적**: 단순/예측 vs 자동/확장. 엣지는 정적, 코어/ISP는 동적.
- **IGP**: 내부 빠른 수렴(OSPF/IS-IS), 영역/레벨/요약로 스케일.
- **BGP**: AS 간 **정책 라우팅**. LOCAL_PREF/AS_PATH/MED/Community로 유출·유입 제어.
- **ECMP**: 동일 비용 다중 경로로 분산(Per-flow 해시).
- **PBR**: 목적지 이외 기준으로 경로 강제(비대칭 주의).
- **안정성**: BFD/FRR로 빠른 복구, 타이머 과도 단축은 금물.
- **보안/위생**: 필터·Max-Prefix·RPKI·MD5/GTSM.

---

### 부록 A — 프로토콜 속성 요약표

| 프로토콜 | 유형 | 장점 | 단점 | 쓰임 |
|---|---|---|---|---|
| RIP | 거리벡터 | 단순 | 수렴 느림, 15홉 | 소규모/레거시 |
| OSPF | 링크상태 | 빠른 수렴, 에어리어 | 설계 복잡도 | 엔터프라이즈/캠퍼스 |
| IS-IS | 링크상태 | 대규모, 안정 | 학습 곡선 | 서비스 제공자/DC |
| BGP | 경로벡터 | 정책/스케일 | 설계 난이도 | 인터넷/멀티-도메인 |

### 부록 B — BGP 세션 상태(요약)

```text
Idle → Connect → Active → OpenSent → OpenConfirm → Established
- Idle/Active 반복: TCP/ACL/ASN/패스워드/GTSM/멀티홉 점검
```

### 부록 C — 관찰 템플릿

```text
[토폴로지] 듀얼 ISP / 리프-스파인 / 지사-본사
[증상] 특정 지역 느림 / 절반만 느림 / 경로 출렁임 / 세션 플랩
[가설] 해시 편향 / LOCAL_PREF 오정책 / MED 충돌 / 요약 누락 / 재분배 루프
[근거] BGP path attr, next-hop reachability, IGP SPF/邻接 상태, Max-Prefix 로그
[조치] 정책 정정, next-hop self, ECMP 멤버 정렬, 요약/필터, BFD/타이머 조정
[후속] 문서/모니터링 룰 업데이트, 커뮤니티 표준화, 변경창 운영
```
