---
layout: post
title: TCPIP - 라우팅
date: 2025-08-29 19:25:23 +0900
category: TCPIP
---
# 라우팅

## 왜 라우팅인가

### 1) “다음 홉”이 전부다

IP 네트워크의 본질은 놀라울 만큼 단순하다.

- 패킷이 들어오면, **목적지 주소**를 보고
- **라우팅 테이블**에서 “가장 구체적인(프리픽스 길이가 긴) 엔트리”를 찾고
- 그 엔트리의 **다음 홉(Next Hop)** 혹은 **출력 인터페이스**로 보낸다.

이 한 줄이 라우터의 데이터 플레인에서 일어나는 일이다.

수식으로 쓰면:

$$
\text{선택 경로} = \arg\max_{r \in \mathcal{R}} \bigl(\text{prefix\_len}(r)\bigr)
\quad \text{s.t. 목적지 주소} \in r
$$

여기서  
- \(\mathcal{R}\) = 라우터가 가진 모든 라우트(프리픽스 집합)  
- \(\text{prefix\_len}(r)\) = 해당 라우트의 프리픽스 길이(e.g. /24 → 24)

**Longest-Prefix Match(최장일치)**가 라우팅의 제1 원리다.

### 2) 라우팅은 “정책(Policy)”의 산물

- 교과서에서는 “**최단 경로**”를 찾는다고 말하지만,
- 실제 운영망(특히 ISP/대형 엔터프라이즈)에서는
  - 비용(요금),
  - SLA,
  - 사업 관계(피어링/트랜짓),
  - 보안·규제
  같은 **정책**이 경로 선택을 지배한다.

결론적으로:

- **IGP**(OSPF/IS-IS)는 “**내부에서 목적지까지 어떻게든 도달 가능하게**” 만드는 역할
- **BGP**는 “**외부·다른 AS와의 관계 속에서 어떤 경로를 쓸지**”를 정하는 정책 엔진

---

## 정적 라우팅 vs 동적 라우팅

### 1) 개념 요약

| 구분 | 정적 라우팅 | 동적 라우팅 |
|---|---|---|
| 경로 학습 | **수동**(관리자 설정) | **프로토콜**로 자동 교환 |
| 수렴/복구 | 변경 시 수동 반영 | 링크 이벤트 기반 **자동 수렴** |
| 오버헤드 | 낮음(프로토콜 트래픽 없음) | 헬로/LSA/업데이트 오버헤드 |
| 확장성 | 제한적(규모↑ → 관리 난이도↑) | 중~대규모에 적합 |
| 예시 | 소형지사, 단순 디폴트 라우트 | 캠퍼스/데이터센터/ISP 백본 |

### 2) 언제 정적, 언제 동적?

**정적 라우팅이 적합한 경우**

- **소규모 지사**:
  - 인터넷으로 나가는 경로는 하나뿐이고,
  - 본사/데이터센터로 가는 경로도 하나뿐인 경우.
- **엣지 디폴트**:
  - 내부 라우터에 “인터넷은 전부 이쪽으로(0.0.0.0/0)”만 알려주고 싶은 경우.
- **블랙홀 라우트(Null Route)**:
  - 특정 프리픽스를 **의도적으로 버리는 용도** (예: DDoS 완화, RPKI Invalid 프리픽스 처리).

**동적 라우팅이 필수인 경우**

- 링크가 **여러 개** 있고, 장애/부하 변화가 잦은 환경
- 라우트 개수가 **수백~수십만** 이상으로 커지는 환경
- 장애 시 **자동 우회·수렴**이 요구되는 환경
- 여러 AS/ISP와 피어링하며 정책에 따라 경로가 바뀌는 환경

### 3) 예제 A — “지사망: 디폴트 + 특정 본사망 정적”

```text
지사 라우터 R1
- 0.0.0.0/0 → ISP1 (인터넷)
- 10.10.0.0/16 → 본사 DC와의 VPN/전용선 터널

의미:
- 사내 업무망 10.10.0.0/16은 반드시 본사 터널로
- 그 외 목적지는 모두 인터넷으로 디폴트 전송
장점:
- 구성 단순, 예측 가능
단점:
- 터널 장애시 관리자 개입 없이는 우회 불가
```

### 4) 정적 라우트 설정 예시

#### Cisco IOS 스타일

```text
! 지사 R1: 모든 인터넷 트래픽을 ISP로
ip route 0.0.0.0 0.0.0.0 192.0.2.1

! 본사망(10.10.0.0/16)은 IPsec 터널 끝점으로
ip route 10.10.0.0 255.255.0.0 198.51.100.1
```

#### Linux

```bash
# 디폴트 게이트웨이 설정
ip route add default via 192.0.2.1

# 본사망 정적 경로
ip route add 10.10.0.0/16 via 198.51.100.1
```

---

## IGP vs EGP

### 1) 역할 구분

- **IGP(Interior Gateway Protocol)**  
  - 하나의 자율 시스템(AS) **내부**에서 라우팅
  - 예: **RIP, OSPF, IS-IS, (EIGRP)**  
  - 목표: **빠른 수렴, 안정적인 내부 도달성**

- **EGP(Exterior Gateway Protocol)**  
  - **AS 간** 경로를 교환  
  - 사실상 **BGP**(Border Gateway Protocol)가 표준  
  - 목표: **정책 기반 경로 선택, 인터넷 스케일**

**디자인 원칙**

- IGP: “**내부 토폴로지를 빠르고 가볍게 반영**”.  
- BGP: “**내·외부 사업 정책을 반영해, 어느 경계에서 무엇을 광고할지 결정**”.

---

## IGP 비교: RIP / OSPF / IS-IS

### 1) 요약 비교표

| 항목 | RIP | OSPF | IS-IS |
|---|---|---|---|
| 유형 | 거리벡터 | 링크상태 | 링크상태 |
| 메트릭 | 홉 수(최대 15) | 비용(대역폭 기반) | 비용(기본 10) |
| 수렴 속도 | 느림 | 빠름 | 빠름 |
| 스케일 | 소규모 | 중~대규모 | 대규모(서비스 제공자/DC 선호) |
| 영역/레벨 | 없음 | Area(Backbone Area 0) | Level-1 / Level-2 |
| 동작 계층 | IP 위 | IP 위 | L2(CLN) 위, IP를 TLV로 운반 |
| 주 사용처 | 레거시/소규모 | 캠퍼스/엔터프라이즈 | SP/DC 백본 |

---

### 2) RIP — 거리벡터의 원형

#### 기본 아이디어

- 라우터는 **“목적지까지의 거리(홉 수)”**를 이웃에게 주기적으로 광고.
- 알고리즘은 **거리벡터**:
  - 이웃이 알려준 “목적지까지 거리 + 1”을 계산하여 최단인지 확인.
- 메트릭이 16 이상이면 **도달 불가능**.

#### 루프 방지 기법

- **Split Horizon**:  
  - 어떤 인터페이스로 들어온 라우트를 **그 인터페이스로 다시 광고하지 않음**.
- **Poison Reverse**:  
  - 루프 형성을 막기 위해, 더 이상 유효하지 않은 경로에 **메트릭 16(무한대)**을 광고.
- **Hold-down**:  
  - 경로가 불안정할 때 일정 시간 새로운 업데이트를 신뢰하지 않고 대기.

#### 장점/단점

- 장점: 구현 단순, 구식 장비에서도 동작.
- 단점:
  - 수렴 매우 느림.
  - 대규모/복잡한 토폴로지에 부적합.
  - 오늘날 새 설계에서는 거의 사용되지 않고, 레거시 환경 보수 용도에 가깝다.

---

### 3) OSPF — 링크상태 IGP의 표준

#### 개념

- 각 라우터가 **자신과 직접 연결된 링크 상태**를 LSA(Link State Advertisement)로 광고.
- 모든 라우터는 **동일한 링크상태 데이터베이스(LSDB)**를 가지며,
- 그 위에서 **SPF(Dijkstra)**를 수행해 각 목적지까지 최단 경로를 구한다.

SPF의 기본 수식은:

$$
\text{최단 경로} = \arg\min_{p \in \mathcal{P}} \sum_{e \in p} w(e)
$$

- \(\mathcal{P}\): 가능한 모든 경로 집합  
- \(w(e)\): 각 링크의 비용(OSPF에서 **참조 대역폭 / 실제 대역폭** 기반)

#### Area 구조

- OSPF는 **Area**라는 논리 구역으로 나뉜다.
  - **Area 0**: Backbone Area (필수)
  - 나머지 Area들은 **Area 0과 연결**되어야 전체 망이 연결된다.
- Area 경계 라우터(ABR)는 **요약(summarization)**를 수행해
  - 라우팅 테이블 규모를 줄이고,
  - 불필요한 LSA 플러딩을 막는다.

#### DR/BDR 개념 (브로드캐스트/멀티액세스 네트워크)

- 하나의 브로드캐스트 세그먼트(Ethernet)에 라우터가 여러 대 연결된 경우:
  - **DR(Designated Router)**, **BDR(Backup DR)**를 선출
  - 모든 라우터가 서로 풀메시로 교환하는 대신, **DR 중심으로 LSDB 동기화**

#### OSPF 구성 예제 (Cisco)

```text
router ospf 1
 router-id 1.1.1.1
 network 10.0.0.0 0.0.0.255 area 0
 network 10.0.1.0 0.0.0.255 area 10

! 링크 대역폭에 따라 cost를 명시적으로 지정
interface GigabitEthernet0/0
 ip ospf cost 10
```

---

### 4) IS-IS — 서비스 제공자/대형 DC의 친구

#### 개념

- 원래 OSI 프로토콜(클라우드 이전 시대의 클리앙트-서버) 기반.
- IP는 **TLV(Type-Length-Value)**로 IS-IS PDU 안에 실려 전달된다.
- 두 계층 구조:
  - **Level-1**: 내부 영역
  - **Level-2**: 영역 간 백본 역할

#### 특성

- IANA 포트 대신 **L2(프레임 타입)** 레벨에서 작동 → IP 버전(IPv4/IPv6)에 덜 종속적.
- 링크상태 방식으로 **대규모 망에 강함**.
- ISP나 현대 데이터센터 언더레이(underlay)에서 선호.

---

## EGP: BGP의 역할과 구조

### 1) BGP의 존재 이유

- 인터넷에서 각 AS는 서로의 **프리픽스 도달성**을 광고해야 한다.
- 단순히 “최단 경로”가 아니라 **정책(돈/사업/보안)**이 중요하다.
- BGP는 **경로벡터(path-vector)** 프로토콜:
  - 각 경로에는 **AS_PATH**가 붙어, 어느 AS들을 거쳐 왔는지 확인 가능.
  - 라우팅 루프를 자연스럽게 회피.

---

## BGP 기본

### 1) iBGP vs eBGP

- **eBGP(External BGP)**  
  - 서로 다른 AS 사이의 세션  
  - 기본 TTL=1 (직접 연결), 필요시 멀티홉(eBGP multihop)
- **iBGP(Internal BGP)**  
  - 같은 AS 내의 라우터들 사이의 세션  
  - 기본 TTL=255  
  - **규칙**: iBGP는 기본적으로 **iBGP에서 배운 경로를 다른 iBGP에 재전달하지 않음**  
    → 전통적인 요구사항: **풀 메쉬 iBGP**  
    → 규모가 커지면 **Route Reflector(RR)**나 **Confederation**으로 풀 메쉬 부담 완화

### 2) BGP 세션 상태 머신

```text
Idle → Connect → Active → OpenSent → OpenConfirm → Established
```

- Idle/Active 사이를 왔다갔다 하면:
  - TCP 레벨 문제(포트, ACL, 패스워드 불일치, 멀티홉/TTL 문제) 가능성.

### 3) BGP 메시지 타입

- **OPEN**: 세션 협상(ASN, Hold Time, BGP ID, Capability 등)
- **UPDATE**: 경로 광고/철회
- **KEEPALIVE**: 세션 유지
- **NOTIFICATION**: 에러/세션 종료 알림

---

### 4) BGP 경로 선택 (우선순위 개념)

벤더마다 세부 순서는 다를 수 있지만, 일반적인 경로 선택 우선순위는 다음과 비슷하다.

1. **최고 LOCAL_PREF** (내부 선호도)
2. **가장 짧은 AS_PATH**
3. **ORIGIN 타입** (IGP < EGP < Incomplete)
4. **최저 MED**
5. **eBGP** 경로가 iBGP보다 우선
6. **Next-hop까지의 IGP 비용** 최소
7. **가장 오래된 경로** 또는 **최소 라우터 ID** 등 타이브레이커

수식으로 개념만 쓰면:

$$
\text{BestPath} = f(\text{LOCAL\_PREF}, |\text{AS\_PATH}|, \text{ORIGIN}, \text{MED},
\text{eBGP/iBGP}, \text{IGP\_Cost}, \ldots)
$$

여기서 \(f\)는 “우선순위에 따른 정렬 함수”라고 생각하면 된다.

---

### 5) Community / Large Community

#### Community (32비트, X:Y 형식으로 표기)

- 정책을 태깅하는 라벨.
- 예:
  - `65001:100` → “서울 POP에서 들어온 경로”
  - `65001:200` → “미국 POP에서 들어온 경로”
- **Well-known Community**
  - `no-export`: eBGP 이웃에게 광고하지 않음
  - `no-advertise`: 어느 이웃에게도 재광고 금지
  - `internet`: 제한 없이 일반 인터넷으로 광고 가능

#### Large Community (96비트)

- 형식: `Global:Local1:Local2`
- 여러 지역·조직을 넘는 정책을 표현하기 좋다.

---

### 6) Next-Hop, next-hop self

- eBGP에서 배운 라우트는, iBGP로 전파할 때 **Next-hop이 그대로 유지**된다.
- 내부 라우터가 그 Next-hop까지 IGP로 도달할 수 없다면 **라우트가 죽은 것이나 마찬가지**.
- 따라서 중간 경계 라우터/RR는 보통:

```text
neighbor X.X.X.X next-hop-self
```

를 설정해, **자기 자신을 Next-hop으로 변경**하여 내부에 광고한다.

---

## BGP 정책 예제

### 예제 C — “두 ISP, 업링크 우선순위 설정”

```text
AS 65001 (우리) — eBGP — ISP-A (AS 64500)
AS 65001 (우리) — eBGP — ISP-B (AS 64501)

목표:
- 아웃바운드 트래픽은 기본적으로 ISP-A를 사용
- ISP-A 장애 시 자동으로 ISP-B로 우회
방법:
- 내부 iBGP RR에서 ISP-A 경로에 LOCAL_PREF=200
- ISP-B 경로에는 LOCAL_PREF=100
```

Cisco 스타일 예시:

```text
route-map SET-LP-ISP-A permit 10
 set local-preference 200

route-map SET-LP-ISP-B permit 10
 set local-preference 100

router bgp 65001
 neighbor 192.0.2.1 remote-as 64500
 neighbor 192.0.2.1 route-map SET-LP-ISP-A in

 neighbor 198.51.100.1 remote-as 64501
 neighbor 198.51.100.1 route-map SET-LP-ISP-B in
```

### 예제 D — “특정 프리픽스만 다른 ISP로 보내기”

```text
목표:
- 203.0.113.0/24 목적지는 ISP-B로 보내고 싶다
- 나머지는 여전히 ISP-A를 선호
방법:
- 203.0.113.0/24에 대해서만 ISP-B 경로의 LOCAL_PREF를 더 높게 설정
주의:
- 리턴 트래픽(인터넷 → 우리 AS)은 상대 AS 정책에 좌우되므로
  완전한 대칭 경로를 보장할 수 없다.
```

---

### AS-PATH Prepend — “덜 선호되게 보이기”

```text
목표:
- 외부에서 들어오는 유입 트래픽은 기본적으로 ISP-A로,
- ISP-B는 백업 느낌으로만 사용하고 싶다.
방법:
- ISP-B로 나가는 광고에 AS-PATH를 일부러 길게 만든다(Prepend)
예:
- 평소 AS_PATH: "65001"
- ISP-B로는 "65001 65001 65001"로 광고
→ 외부에서 볼 때 더 긴 경로로 인식되어 선호도가 떨어진다.
주의:
- 상대방이 LOCAL_PREF 등 더 강력한 정책을 쓰면 이 효과가 무시될 수 있다.
```

---

### MED — “이쪽으로 들어와 달라는 힌트”

```text
조건:
- 같은 이웃 AS와 두 개 이상의 연결 지점(POI)이 있을 때
목표:
- 특정 프리픽스로 들어오는 트래픽은 A 경계로, 다른 것은 B 경계로
방법:
- 그 프리픽스에 대해 A 경계의 MED를 낮게(선호↑), B 경계는 높게(선호↓)
주의:
- MED는 "같은 인접 AS" 사이에서만 비교되는 것이 일반적
- LOCAL_PREF보다 우선순위가 낮다
```

---

## ECMP(동일 비용 다중 경로)

### 1) 개념

- IGP/OSPF/IS-IS/BGP 모두 **“동일 비용” 경로가 여러 개** 있을 수 있다.
- 이때 여러 경로를 **동시에 활성화**하고, 트래픽을 분산시키는 것이 **ECMP(Equal-Cost Multi-Path)**.

### 2) 해시 기반 분산

- **Per-flow 해시**:
  - 보통 5-튜플(소스 IP/목적지 IP/소스 포트/목적지 포트/프로토콜) 기반
  - 동일한 흐름의 패킷은 항상 같은 경로를 사용 → **순서 유지**
- **Per-packet**:
  - 패킷 단위로 라운드로빈 분배
  - 경로별 지연 차이로 인해 **패킷 재정렬 발생** → TCP 성능 악화
  - 현대 설계에서는 거의 사용하지 않는다.

### 3) 예제 G — 리프-스파인 데이터센터

```text
스파인 2대, 리프 N대
각 리프 ↔ 각 스파인 1~2 링크

- 모든 리프에서 스파인까지의 IGP 비용이 동일:
  → 리프-스파인 계층에서 ECMP 활성화
- 서버 간 트래픽은 리프-스파인을 통과하면서 자연스럽게 분산
- Underlay는 OSPF/IS-IS 또는 eBGP로 설계
- Overlay는 iBGP/EVPN, VXLAN 등을 사용
```

---

## PBR(Policy-Based Routing)

### 1) 개념

- 일반 라우팅은 **목적지 IP**만 보고 경로 결정.
- **PBR**은 **소스 IP, 포트, DSCP, 어플리케이션** 등 추가 조건으로 **다음 홉을 강제**.

### 2) 활용 예

- 개발망 트래픽만 로컬 인터넷으로 직접 브레이크아웃
- 특정 서버군 트래픽만 전용선/고급 회선 사용
- 보안/감사 요구에 따라 특정 세그먼트를 프록시/캡티브 포털로

### 3) 주의사항

- 비대칭 경로 유발 가능:
  - 보내는 쪽(아웃바운드)은 PBR로 ISP-A,
  - 들어오는 쪽(인바운드)은 ISP-B로 올 수도 있다.
- 방화벽/세션 기반 장비는 **비대칭 경로**에서 예상치 못한 드롭을 일으키기 쉽다.
- 대규모 환경에서 PBR를 남발하면:
  - 트러블슈팅 난이도 급상승
  - 재사용/확장이 어려운 “특수 케이스 집합”이 되어버린다.

### 4) 예제 H — “개발망만 로컬 브레이크아웃”

```text
조건:
- 사무망(10.10.0.0/16) / 개발망(10.20.0.0/16) VLAN 분리
정책:
- 소스가 10.20.0.0/16(개발망)이면, 로컬 ISP-A로 바로 인터넷
- 그 외는 본사 DC 방화벽을 통해 인터넷
주의:
- SaaS/클라우드 서비스의 리턴 경로가 어디로 가는지 반드시 모니터링
- SSL 프록시/보안 장비와의 상호작용도 확인
```

Cisco IOS 예:

```text
ip access-list extended DEV_NET
 permit ip 10.20.0.0 0.0.255.255 any

route-map DEV-BREAKOUT permit 10
 match ip address DEV_NET
 set ip next-hop 192.0.2.1

route-map DEV-BREAKOUT permit 20
 ! 나머지는 기본 라우팅 사용

interface GigabitEthernet0/0
 ip policy route-map DEV-BREAKOUT
```

---

## 재분배(Redistribution), 요약(Summarization), 기본경로(Default)

### 1) 재분배

- 서로 다른 라우팅 프로토콜(예: OSPF ↔ BGP) 사이에 경로를 **주입**하는 것.
- 예:
  - 데이터센터 게이트웨이에서 서버 프리픽스를 OSPF에서 배우고,
  - 이를 BGP로 외부 ISP에게 광고.

#### 위험

- **루프**:
  - OSPF → BGP → 다시 OSPF로 들어와 원래의 OSPF 경로와 섞이는 경우 등
- **폭주**:
  - 너무 많은 경로가 재분배되면, IGP가 **인터넷 전체 테이블**을 떠안게 되는 상황도 발생 가능.

→ 일반적으로 재분배 시:

- **Route Tag**를 활용(한 번 외부로 나간 경로 다시 내부로 넣지 않기)
- **Prefix 리스트·정책**으로 재분배 범위를 엄격하게 제한

---

### 2) 요약(Summarization)

- 여러 개의 프리픽스를 상위 프리픽스 하나로 묶어 광고하는 것.
- 예:
  - 내부에 10.10.1.0/24 ~ 10.10.255.0/24가 있다면,
  - 외부에는 10.10.0.0/16 만 광고.

장점:

- 라우팅 테이블 규모 축소
- 프리픽스 하나가 잠깐 사라져도 상위 요약 프리픽스가 남아있으면
  **경계 바깥에서는 안정적으로 보이는 효과**

---

### 3) 기본경로(Default Route)

- “모든 곳으로 가는 길을 몰라도, **모르는 건 이쪽으로**”라는 규칙.
- 외곽 라우터/단말에 인터넷 전체 라우팅 테이블을 줄 필요 없이,
  단순히 `0.0.0.0/0`(IPv4) / `::/0`(IPv6)만 받게 하는 패턴.

### 예제 I — “BGP 엣지에서 내부로는 기본경로만”

```text
엣지 라우터:
- ISP로부터 전체 인터넷 라우팅 테이블(수십만~수백만 프리픽스) 수신
- 내부 코어 라우터에는 0.0.0.0/0, ::/0만 iBGP로 전달

효과:
- 내부 라우터 라우팅 테이블이 단순해짐
- 엣지가 장애 복구/정책 조정을 책임지고, 내부는 단순한 기본경로 기반
```

---

## 안정성·신속성: 타이머, BFD, FRR

### 1) 타이머

- IGP:
  - Hello/Dead 타이머
  - 너무 짧게 하면: CPU·링크·장비가 바쁘고, **플랩**(자주 끊겼다 붙었다)을 유발
- BGP:
  - Keepalive/Hold 타이머
  - 전통적으로 60/180초였으나, 내부 환경에서는 더 짧게 설정하기도 함

### 2) BFD(Bidirectional Forwarding Detection)

- 하위 계층(L1/L2) 상태와 무관하게, **양방향 가용성**을 수 밀리초 단위로 감시.
- OSPF/IS-IS/BGP와 연동해, 링크 장애 인지를 **수십~수백 ms 수준**으로 줄일 수 있다.

### 3) FRR(Fast Reroute)

- IGP:
  - **LFA(Loop-Free Alternate)**, **TI-LFA** 등의 메커니즘으로
  - SPF 재계산 전에 미리 계산된 백업 경로로 전환
- BGP:
  - 벤더별 메커니즘(PIC Core/Edge 등)으로 대규모 BGP 테이블에서도 빠르게 전환

---

## 보안·위생(BGP/라우팅 보안)

### 1) 프리픽스 필터링

- 고객/피어로부터 들어오는 라우트에 대해:
  - **허용된 프리픽스만 받아들이도록** 필터를 구성.
- 예:
  - 고객 AS 65010이 203.0.113.0/24 하나만 가져야 한다면,
  - 그 외 프리픽스를 광고하면 드롭.

### 2) Max-Prefix

- 피어/고객이 갑자기 수십만 개의 프리픽스를 광고해도
  - 설정된 상한을 넘으면 세션을 끊어버리도록 보호.

### 3) MD5/TCP-AO, GTSM

- BGP는 TCP 179 위에서 동작하므로,
  - 세션 보호를 위해 TCP MD5/TCP-AO를 사용하는 경우가 많다.
- **GTSM(Generic TTL Security Mechanism)**:
  - eBGP 세션에서 TTL=1로 두고,
  - 멀리서 스푸핑한 패킷이 들어오지 못하게 막는다.

### 4) RPKI(ROA 검증)

- 각 프리픽스에 대해 “**어떤 AS가 이 프리픽스를 광고해도 되는지**”를 선언한 것이 ROA(Route Origin Authorization).
- 라우터는 수신한 BGP 업데이트를 RPKI 검증기로 검증하여:
  - Valid / Invalid / NotFound로 분류
- 정책:
  - Valid만 허용하거나,
  - Invalid는 드롭/Local-Pref 낮추기 등.

---

## 트러블슈팅 체크리스트

### 1) 공통

```text
[1] 목적지 프리픽스가 라우팅 테이블에 있는가?
    - 없다면: 상위/디폴트 라우트는 있는가?

[2] 선택된 라우트의 Next-hop에 IGP 도달성이 있는가?

[3] 방화벽/ACL이 트래픽을 차단하지는 않는가?

[4] 대칭성:
    - 요청은 A 경로로 나가는데, 응답은 B 경로로 들어오고 있는가?
    - 상태 기반 장비에서 비대칭은 드롭 원인이 된다.
```

### 2) IGP 관련

```text
[OSPF]
- Area 0과의 연결이 끊어진 곳은 없는가?
- Neighbor 상태가 Full까지 올라갔는가?
- DR/BDR 선출이 의도대로 되었는가?
- LSA 플러딩이 과도하거나, 특정 Area에서 막히지는 않았는가?

[IS-IS]
- Level-1 / Level-2 관계가 설계대로인가?
- 인접 상태가 Up인가?
- LSP 수명/Checksum 경고는 없는가?
```

### 3) BGP 관련

```text
- 세션 상태: Established인가?
  - Idle/Active 반복이면:
    - TCP 연결 실패(Port, ACL, Password, TTL/GTSM, 멀티홉 설정)를 의심

- 수신 경로:
  - LOCAL_PREF, AS_PATH, MED, COMMUNITY가 기대대로 세팅되어 있는가?

- Next-hop:
  - Next-hop에 IGP로 도달 가능한가?
  - iBGP에서 next-hop self를 빼먹은 것은 아닌가?

- 필터/정책:
  - prefix-list/route-map/RPKI 정책으로 Drop된 것은 아닌가?

- Max-Prefix:
  - 상한 초과로 세션이 차단되었는가?
```

### 4) ECMP/PBR 관련

```text
- 해시: 특정 ECMP 멤버가 과도하게 사용되지는 않는가?
- Per-packet 분산으로 패킷 재정렬이 발생하지 않는가?
- PBR로 인해 비대칭 경로가 만들어져, 방화벽/세션 장비와 충돌하지는 않는가?
```

---

## 미니 랩(개념 중심 실습 시나리오)

### 랩 1 — 정적 + 디폴트

```text
Topology:
R1(지사) — R2(본사/인터넷 게이트웨이)

구성:
- R1: 0.0.0.0/0 → R2
- R2: 10.10.10.0/24 → R1

실습:
- R1에서 인터넷으로 핑: R2를 통해 나가야 함
- R2 장애 시: R1 인터넷/본사 모두 단절
→ 정적 라우팅의 단순함과 한계를 체감
```

### 랩 2 — OSPF 두 영역 + 요약

```text
Area 0: 코어
Area 10: 사무동 (10.10.0.0/16)
Area 20: 생산동 (10.20.0.0/16)

- 각 Area 내부에서는 세부 서브넷 /24를 사용
- ABR에서:
  - Area 10 → 10.10.0.0/16으로 요약
  - Area 20 → 10.20.0.0/16으로 요약

관찰:
- 코어 라우터에는 /24 대신 /16만 보임
- Area 내부의 서브넷이 하나 다운되어도,
  Area 밖에서는 전체 /16이 여전히 reachable로 보임
```

### 랩 3 — eBGP 듀얼 ISP + LOCAL_PREF

```text
AS 65001 ↔ AS 64500(ISP-A), AS 64501(ISP-B)

- 내부에는 RR를 두고 iBGP 풀메시 대신 RR 구조 사용
- ISP-A 경로에 LOCAL_PREF=200
- ISP-B 경로에 LOCAL_PREF=100

실습:
- 외부로 나가는 Traceroute를 찍어 어느 ISP를 사용하는지 확인
- ISP-A 세션 다운:
  - 경로가 ISP-B로 자동 수렴하는지 확인
- 특정 프리픽스만 ISP-B를 선호하도록 정책 추가 후
  - 해당 목적지 방향 traceroute로 정책 반영 여부 확인
```

### 랩 4 — AS-PATH Prepend로 유입 조정

```text
프리픽스: 203.0.113.0/24

구성:
- ISP-A로는 AS_PATH: "65001"
- ISP-B로는 AS_PATH: "65001 65001 65001"

실습:
- 다양한 위치(북미/유럽)의 Looking Glass에서
  - 203.0.113.0/24가 어느 ISP를 통해 들어오는지 관찰
- 트래픽 패턴 변화와 장애 시 동작 확인
```

### 랩 5 — BFD + OSPF 수렴

```text
- 두 라우터 사이에 OSPF 링크
- OSPF Hello/Dead는 비교적 길게(예: 10/40초)
- BFD 세션을 50ms/3회로 구성

실습:
- 링크 다운 시:
  - BFD 미적용 환경: OSPF Dead 타이머까지 기다렸다가 다운 감지
  - BFD 적용 환경: 수십~수백 ms 이내에 다운 감지, SPF 재계산
→ 수렴 시간 차이를 측정해본다.
```

---

## 수식·개념 메모

### 1) 최장일치(Longest-Prefix Match)

앞서 본 것처럼:

$$
\text{선택 경로} = \arg\max_{r \in \mathcal{R}} \bigl(\text{prefix\_len}(r)\bigr)
\quad \text{s.t. 목적지 주소} \in r
$$

- 라우터는 목적지 IP를 보고,
- 라우팅 테이블에서 **해당 IP를 포함하는 모든 프리픽스 중 프리픽스 길이가 가장 긴 것**을 선택.

### 2) 링크상태·SPF 직관

링크상태 프로토콜(OSPF/IS-IS)에서 SPF는 다음과 같은 최적화 문제를 푸는 것으로 생각할 수 있다.

$$
\text{최단 경로} = \arg\min_{p \in \mathcal{P}} \sum_{e \in p} w(e)
$$

- \(\mathcal{P}\): 가능한 모든 경로
- \(w(e)\): 각 링크 e의 비용(대역폭/지연/관리자가 지정한 weight)

### 3) BGP 정책 체인(개념 수식)

BGP의 BestPath는 여러 속성을 순차적으로 비교하는 함수:

$$
\text{BestPath} =
\operatorname*{arg\,max}_{p \in \mathcal{P}}
\bigl[
(\text{LOCAL\_PREF}_p),
(-|\text{AS\_PATH}_p|),
(-\text{MED}_p),
(\text{eBGP/iBGP}_p),
(-\text{IGP\_Cost}_p),
\ldots
\bigr]
$$

- 단, 여기서 `argmax`는 실제 구현과 정확히 일치하는 것은 아니고,
- “우선순위 체인”을 표현한 개념적 수식이다.

---

## 운영 베스트 프랙티스

1. **IGP는 단순하고 가볍게**
   - 내부 도달성만, 외부 정책/인터넷 전체 테이블을 싣지 말 것
   - Area/레벨/요약을 적극적으로 사용해 스케일 확보

2. **BGP는 정책 엔진**
   - LOCAL_PREF로 **유출(아웃바운드)** 트래픽 제어
   - AS-PATH Prepend/MED로 **유입(인바운드)** 트래픽에 힌트 제공
   - Community/Large Community로 태깅 표준화

3. **ECMP는 Per-flow 해시**
   - Per-packet 분산은 재정렬 악화 → 특별한 경우 외에는 피할 것
   - 멤버 링크들의 속도/지연이 크게 다르지 않도록 설계

4. **PBR는 최소한으로**
   - 복잡한 정책은 가급적 BGP/IGP 설계로 흡수
   - 불가피하게 PBR를 쓰는 구간은 철저한 문서화·모니터링

5. **재분배/요약은 보수적으로**
   - Loop Tag, Prefix Filter를 반드시 활용
   - IGP에 인터넷 전체 테이블이 들어오지 않도록 주의

6. **BFD/FRR로 탐지·수렴 가속**
   - 단, 타이머를 너무 공격적으로 줄이면 불안정
   - 장비 성능·망 규모·운영상 제약에 맞춰 튜닝

7. **보안·위생**
   - 프리픽스/AS-PATH 필터, Max-Prefix, MD5/TCP-AO, GTSM, RPKI
   - 고객/피어와의 필터 정책을 문서로 명확히 합의

8. **문서화/가시성**
   - 토폴로지 다이어그램, 정책(LOCAL_PREF/Community), 타이머, 알람 기준
   - NMS/Telemetry로 경로 변화·세션 플랩·RPKI 상태를 지속 관찰

---

## 한 장 요약(포스터)

- **정적 vs 동적**
  - 정적: 단순·예측 가능, 그러나 장애 시 수동 개입 필요
  - 동적: 자동 수렴·확장성, 그러나 설계와 운용 난이도↑

- **IGP**
  - OSPF/IS-IS: 내부 도달성·빠른 수렴 담당
  - Area/Level/요약으로 스케일링

- **BGP**
  - 인터넷/멀티-AS 환경의 **정책 라우팅 엔진**
  - LOCAL_PREF·AS_PATH·MED·Community로 유출/유입 제어

- **ECMP**
  - 동일 비용 다중 경로를 Per-flow 해시로 분산
  - 대규모 리프-스파인 DC에서 필수

- **PBR**
  - 목적지 외 속성으로 경로 강제
  - 비대칭·트러블슈팅 난이도 증가 → 최소한으로 사용

- **안정성**
  - BFD/FRR으로 장애 탐지·수렴 시간 단축
  - 과도한 타이머 단축은 오히려 불안정

- **보안**
  - 프리픽스 필터링, Max-Prefix, MD5/TCP-AO, GTSM, RPKI
  - 라우팅은 “신뢰” 위에 서 있으므로, 기본 위생이 중요

---

### 부록 A — 프로토콜 속성 요약표

| 프로토콜 | 유형 | 장점 | 단점 | 주 사용처 |
|---|---|---|---|---|
| RIP | 거리벡터 | 구현 단순, 레거시 호환 | 수렴 느림, 15홉 제한 | 소규모/레거시 |
| OSPF | 링크상태 | 빠른 수렴, Area 설계로 스케일링 | 설계·운영 복잡 | 엔터프라이즈/캠퍼스 |
| IS-IS | 링크상태 | 대규모·안정, 멀티 프로토콜 친화 | 학습 곡선 | 서비스 제공자/DC |
| BGP | 경로벡터 | 정책 표현력·인터넷 스케일 | 설계·튜닝 난이도 | 인터넷/멀티 도메인 |

---

### 부록 B — BGP 세션 상태(요약)

```text
Idle → Connect → Active → OpenSent → OpenConfirm → Established

Idle/Active 반복 원인:
- TCP 세션 성립 실패(포트, ACL, 패스워드, TTL, 멀티홉 설정)
- 잘못된 ASN(로컬/리모트)
- GTSM 설정 불일치
- 피어가 우리를 필터/차단
```

---

### 부록 C — 운영 관찰 템플릿

```text
[토폴로지]
- 듀얼 ISP / 리프-스파인 / 지사-본사 / MPLS 코어 등

[증상]
- 특정 지역만 느림
- 절반의 트래픽만 우회
- 경로가 자주 바뀜(플랩)
- BGP/IGP 세션이 반복 다운/업

[가설]
- ECMP 해시 편향
- LOCAL_PREF/AS_PATH/MED 오정책
- 요약 누락/중복
- 재분배 루프
- RPKI Invalid 처리

[근거 수집]
- BGP path attribute(AS_PATH/LOCAL_PREF/MED/Community)
- IGP SPF/인접 상태
- Next-hop reachability
- Max-Prefix/RPKI 로그
- NMS/Telemetry(지연, 패킷 손실, 경로 변화 이벤트)

[조치]
- 정책 수정(LOCAL_PREF/Community/Prepend/MED)
- next-hop self 적용
- ECMP 멤버 정렬(속도·지연)
- 요약/필터 튜닝, 재분배 제한
- BFD/타이머 재조정

[후속]
- 문서/Runbook 업데이트
- Community/정책 표준화
- 변경 관리(Change Management) 프로세스 강화
```