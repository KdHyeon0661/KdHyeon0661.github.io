---
layout: post
title: 미적분 - 편도함수의 연쇄법칙
date: 2025-07-27 23:20:23 +0900
category: 미적분
---
# 편도함수의 연쇄법칙 (Chain Rule for Partial Derivatives)

## 왜 “편도함수의 연쇄법칙”인가?

- 다변수 실제 문제는 대부분 합성 구조다:
  데이터 전처리 \(x\mapsto u(x)\) → 비선형 활성 \(u\mapsto v(u)\) → 손실 \(L(v)\).
  **각 단계의 미분을 곱으로 연결**해야 전체 변화율을 얻는다.
- **전미분(총미분)**과 **방향미분**은 편도 연쇄법칙의 벡터화 버전이다.
  즉, 스칼라 편도 연쇄법칙 ↔ 야코비안의 곱(행렬미분).
- 공학/과학: 재료미분(material derivative), 좌표변환(극·구면), 민감도 분석, 역전파(backprop) 모두 연쇄법칙에 선다.

---

## 편도 연쇄법칙

### 스칼라 출력, 중간이 스칼라 1개

함수
- \( y = y(u) \) (단변수, \(C^1\))
- \( u = u(x_1, x_2, \dots, x_n) \) (다변수, \(C^1\))

합성 \( y(x) = y(u(x)) \).
**연쇄법칙(편도형)**:
$$
\frac{\partial y}{\partial x_i}
= \frac{dy}{du}\,\frac{\partial u}{\partial x_i}.
$$

**예제 1.1**
\( y = e^{u},\ u = x^2y^2 \) 라고 쓰면 혼동되므로 변수명 구분: \( y\equiv f \).
정정: \( f = e^{u},\ u = x^2 z^2 \) (여기서 \(z\)는 다른 독립변수).
그러면
$$
\frac{\partial f}{\partial x}
= \frac{df}{du}\frac{\partial u}{\partial x}
= e^{u}\cdot (2x z^2).
$$

### 스칼라 출력, 중간이 벡터 (다중 입력이 한 출력으로 모임)

함수
- \( \phi = \phi(u_1,\dots,u_m) \) (스칼라 출력)
- \( u_j = u_j(x_1,\dots,x_n) \)

합성 \( \phi(x) = \phi(u_1(x),\dots, u_m(x)) \).
**연쇄법칙(편도형)**:
$$
\frac{\partial \phi}{\partial x_i}
= \sum_{j=1}^{m} \frac{\partial \phi}{\partial u_j}\frac{\partial u_j}{\partial x_i}.
$$

**예제 1.2**
\( \phi(u,v) = \ln(u^2+v^2) \), \(u(x,y)=x^2-y\), \(v(x,y)=xy\).
$$
\frac{\partial \phi}{\partial x}
= \frac{\partial \phi}{\partial u}\frac{\partial u}{\partial x}
 + \frac{\partial \phi}{\partial v}\frac{\partial v}{\partial x}.
$$
먼저
$$
\frac{\partial \phi}{\partial u}
= \frac{2u}{u^2+v^2},\quad
\frac{\partial \phi}{\partial v}
= \frac{2v}{u^2+v^2}.
$$
또
$$
\frac{\partial u}{\partial x}=2x,\quad
\frac{\partial v}{\partial x}=y.
$$
따라서
$$
\frac{\partial \phi}{\partial x}
= \frac{2u}{u^2+v^2}\cdot 2x + \frac{2v}{u^2+v^2}\cdot y
= \frac{4xu + 2yv}{u^2+v^2}.
$$
여기서 \(u=x^2-y\), \(v=xy\)를 대입하면 끝.

---

## 연쇄법칙

중간 노드가 복수의 하위 노드에 **가지치기**되어 있을 때, 특정 입력 \(x_i\)에서 출력 \(f\)로 가는 **모든 경로**의 **기여 합**이 편도 파생값이다.

### 일반형 공식

노드 \(x_i\xrightarrow{\text{경로}} f\) 를 잇는 모든 경로 \(\mathcal{P}\)에 대해,
각 경로의 “국소 미분들의 곱”을 모두 더한다:
$$
\frac{\partial f}{\partial x_i}
= \sum_{\text{path}\ \mathcal{P}: x_i\rightsquigarrow f}
\ \prod_{(a\to b)\in \mathcal{P}}\ \frac{\partial b}{\partial a}.
$$

**예제 2.1 (네트워크형)**
\[
x\to u_1=\sigma(x),\quad x\to u_2=x^2,\quad f = \tanh(u_1+u_2).
\]
경로는 두 개:
- \(x\to u_1\to f\): 기여는 \(\frac{\partial f}{\partial u_1} \frac{\partial u_1}{\partial x}\).
- \(x\to u_2\to f\): 기여는 \(\frac{\partial f}{\partial u_2} \frac{\partial u_2}{\partial x}\).

여기서 \(\frac{\partial f}{\partial u_1}=\text{sech}^2(u_1+u_2)\), \(\frac{\partial f}{\partial u_2}\)도 동일,
\(\frac{\partial u_1}{\partial x}=\sigma(x)(1-\sigma(x))\), \(\frac{\partial u_2}{\partial x}=2x\).
따라서
$$
\frac{\partial f}{\partial x}
= \text{sech}^2(u_1+u_2)\left(\sigma(x)(1-\sigma(x)) + 2x\right).
$$

---

## 야코비안/전미분 관점 (행렬 형태의 연쇄법칙)

연쇄법칙은 야코비안의 행렬곱으로 가장 깔끔하게 표현된다.

### 표기

- \( \mathbf{u} = \mathbf{u}(\mathbf{x}) \in \mathbb{R}^m\), \( \mathbf{x}\in\mathbb{R}^n\)
  야코비안 \( J_{\mathbf{u}}(\mathbf{x}) \in \mathbb{R}^{m\times n} \),
  \([J_{\mathbf{u}}]_{ij} = \frac{\partial u_i}{\partial x_j}\).
- \( \mathbf{y} = \mathbf{y}(\mathbf{u}) \in \mathbb{R}^p\)
  야코비안 \( J_{\mathbf{y}}(\mathbf{u}) \in \mathbb{R}^{p\times m}\).

합성 \( \mathbf{y}(\mathbf{x}) = \mathbf{y}(\mathbf{u}(\mathbf{x})) \)의 연쇄:
$$
J_{\mathbf{y}}(\mathbf{x})
= J_{\mathbf{y}}(\mathbf{u})\Big|_{\mathbf{u}=\mathbf{u}(\mathbf{x})}\ \cdot\ J_{\mathbf{u}}(\mathbf{x}).
$$

스칼라 출력 \(y\), 즉 \(p=1\)이면 \(J_{\mathbf{y}}\)는 **행벡터**이고, 위 곱은 그라디언트의 전치 관계와 연결된다:
$$
\nabla_{\mathbf{x}}\, y
= J_{\mathbf{u}}(\mathbf{x})^\top \ \nabla_{\mathbf{u}}\, y.
$$

**예제 3.1**
\( \mathbf{u}(x,y) = \begin{bmatrix} x^2-y \\ xy \end{bmatrix}\in\mathbb{R}^2\),
\( \mathbf{z}(\mathbf{u}) = \begin{bmatrix} \sin(u_1) \\ u_1u_2 \end{bmatrix}\in\mathbb{R}^2\).

- \(J_{\mathbf{u}} =
\begin{bmatrix}
\frac{\partial u_1}{\partial x} & \frac{\partial u_1}{\partial y}\\
\frac{\partial u_2}{\partial x} & \frac{\partial u_2}{\partial y}
\end{bmatrix}
=
\begin{bmatrix}
2x & -1\\
y & x
\end{bmatrix}\).
- \(J_{\mathbf{z}} =
\begin{bmatrix}
\cos u_1 & 0\\
u_2 & u_1
\end{bmatrix}\).

합성 \( J_{\mathbf{z}}(\mathbf{x}) = J_{\mathbf{z}}(\mathbf{u})\, J_{\mathbf{u}}(\mathbf{x}) \).

---

## 편도 연쇄법칙과 전미분/방향미분

### 전미분(총미분)

스칼라 \(f(\mathbf{x})\)의 **총미분**:
$$
df = \sum_{i=1}^n \frac{\partial f}{\partial x_i}\,dx_i = \nabla f(\mathbf{x})^\top d\mathbf{x}.
$$
합성 \(f(\mathbf{x})=g(\mathbf{u}(\mathbf{x}))\)이면
$$
df = \nabla_{\mathbf{u}} g^\top \, d\mathbf{u}
   = \nabla_{\mathbf{u}} g^\top \, J_{\mathbf{u}}(\mathbf{x})\, d\mathbf{x}
   = \big(J_{\mathbf{u}}(\mathbf{x})^\top \nabla_{\mathbf{u}} g \big)^\top d\mathbf{x}.
$$
따라서 \(\nabla_{\mathbf{x}} f = J_{\mathbf{u}}^\top \nabla_{\mathbf{u}} g\) — 위 3.1 결과와 일치.

### 방향미분

단위벡터 \(\mathbf{v}\) 방향의 방향미분:
$$
D_{\mathbf{v}} f(\mathbf{x}) = \nabla f(\mathbf{x})^\top \mathbf{v}.
$$
합성형
$$
D_{\mathbf{v}} f(\mathbf{x}) = \nabla_{\mathbf{x}} f^\top \mathbf{v}
= \big(J_{\mathbf{u}}^\top \nabla_{\mathbf{u}} g\big)^\top \mathbf{v}
= \nabla_{\mathbf{u}} g^\top \, (J_{\mathbf{u}}\mathbf{v}).
$$
즉 **먼저 입력의 방향을 중간공간으로 보낸 뒤**, 해당 공간에서의 그라디언트와 내적.

---

## 다중 합성의 2계 버전: 합성의 헤시안

스칼라 \(f(\mathbf{x})=g(\mathbf{u}(\mathbf{x}))\)에서
- 1계: \(\nabla_{\mathbf{x}} f = J_{\mathbf{u}}^\top \nabla_{\mathbf{u}} g\).
- 2계(헤시안):
  $$
  H_{\mathbf{x}} f
  = J_{\mathbf{u}}^\top H_{\mathbf{u}} g \, J_{\mathbf{u}}
    + \sum_{k=1}^m \frac{\partial g}{\partial u_k} \, H_{\mathbf{x}} u_k.
  $$
여기서 \(H_{\mathbf{u}} g\)는 \(g\)의 헤시안, \(H_{\mathbf{x}} u_k\)는 중간 성분 \(u_k\)의 헤시안.

**예제 5.1**
\(g(u_1,u_2)=\tfrac12(u_1^2+u_2^2)\) (즉 \(\nabla g = (u_1,u_2)^\top,\ H_{\mathbf{u}}g=I\)),
\(u_1=x^2+y,\ u_2=xy\).
- \(J_{\mathbf{u}}=\begin{bmatrix}2x & 1\\ y & x\end{bmatrix}\).
- \(H_{\mathbf{x}}u_1 = \begin{bmatrix}2&0\\0&0\end{bmatrix}\), \(H_{\mathbf{x}}u_2=\begin{bmatrix}0&1\\1&0\end{bmatrix}\).
- \(\partial g/\partial u_1 = u_1,\ \partial g/\partial u_2 = u_2\).
따라서
$$
H_{\mathbf{x}} f
= J_{\mathbf{u}}^\top I J_{\mathbf{u}}
 + u_1\,H_{\mathbf{x}}u_1 + u_2\,H_{\mathbf{x}}u_2.
$$

---

## 좌표변환에서의 연쇄법칙 (극·구면·일반 변환)

### 극좌표 \((r,\theta)\)에서 \(f(x,y)\)

\(x=r\cos\theta,\ y=r\sin\theta\).
연쇄법칙:
$$
\frac{\partial f}{\partial r}
= \frac{\partial f}{\partial x}\frac{\partial x}{\partial r}
+ \frac{\partial f}{\partial y}\frac{\partial y}{\partial r}
= f_x \cos\theta + f_y \sin\theta,
$$
$$
\frac{\partial f}{\partial \theta}
= f_x\frac{\partial x}{\partial \theta}
+ f_y\frac{\partial y}{\partial \theta}
= f_x(-r\sin\theta) + f_y(r\cos\theta).
$$

**예제 6.1**
\(f(x,y)=\ln(x^2+y^2)=\ln r^2=2\ln r\).
- 직접: \(f_r=2/r,\ f_\theta=0\).
- 연쇄로도 동일: \(f_x=2x/(x^2+y^2)=\cos\theta/r,\ f_y=2y/(x^2+y^2)=\sin\theta/r\).
  따라서 \(f_r=(\cos\theta/r)\cos\theta + (\sin\theta/r)\sin\theta=1/r\) 이 아니라? 주의: \(f=\ln(x^2+y^2)\)이면 \(f_x=2x/(x^2+y^2)\), \(x=r\cos\theta\) 대입 →
  \(f_r = f_x \cos\theta + f_y \sin\theta = \frac{2r\cos^2\theta}{r^2} + \frac{2r\sin^2\theta}{r^2} = \frac{2}{r}\).
  일치 확인.

### 구면좌표 \((\rho,\phi,\theta)\)에서 \(f(x,y,z)\)

\(x=\rho\sin\phi\cos\theta\), \(y=\rho\sin\phi\sin\theta\), \(z=\rho\cos\phi\).
연쇄법칙으로 \(f_\rho, f_\phi, f_\theta\)를 \(f_x,f_y,f_z\)와 변환.

---

## 암시적 함수에서의 연쇄법칙

### 하나의 제약: \(F(x,y)=0\)가 \(y=y(x)\)를 규정

양변 미분(편도형):
$$
\frac{\partial F}{\partial x} + \frac{\partial F}{\partial y}\frac{dy}{dx} = 0
\ \Rightarrow\
\frac{dy}{dx} = - \frac{F_x}{F_y},\quad (F_y\ne 0).
$$

**예제 7.1**
\(F(x,y)=x^2+y^2-1=0\) (단위원).
\(\frac{dy}{dx} = -\frac{2x}{2y}=-\frac{x}{y}\).

### 다변수 암시적 함수: \(F(x,y,z)=0\)에서 \(z=z(x,y)\)

양변 편미분:
$$
\frac{\partial z}{\partial x} = -\frac{F_x}{F_z},\quad
\frac{\partial z}{\partial y} = -\frac{F_y}{F_z},\quad (F_z\ne 0).
$$

**예제 7.2**
\(F(x,y,z)=x e^{z}+y^2 - 3=0\).
\(F_x=e^z\), \(F_y=2y\), \(F_z = x e^z\).
따라서
$$
z_x = -\frac{e^z}{x e^z} = -\frac{1}{x},\qquad
z_y = -\frac{2y}{x e^z}.
$$

---

## 재료미분(Material derivative): 이동하는 관찰자

벡터장 \(\mathbf{r}(t)\)를 따라가는 관찰자가 스칼라장 \(f(\mathbf{x},t)\)의 시간 변화율을 느낀다면
$$
\frac{Df}{Dt}
= \frac{\partial f}{\partial t}
 + \nabla f(\mathbf{x},t) \cdot \frac{d\mathbf{x}}{dt}.
$$
이는 시간과 공간 합성의 연쇄법칙이다.

---

## 확률·최적화의 전형적 합성: 로스/링크/정규화

### 로지스틱 회귀의 \(\partial L/\partial w\)

\(z = w^\top x\), \(p=\sigma(z)=1/(1+e^{-z})\), \(L=-[y\ln p + (1-y)\ln(1-p)]\).
$$
\frac{\partial L}{\partial w}
= \frac{\partial L}{\partial p}\frac{\partial p}{\partial z}\frac{\partial z}{\partial w}
= \left(-\frac{y}{p}+\frac{1-y}{1-p}\right)\cdot p(1-p)\cdot x
= (p-y)\,x.
$$

### 소프트맥스+크로스엔트로피

\(\mathbf{z}\in\mathbb{R}^K\), \(p_i = \frac{e^{z_i}}{\sum_j e^{z_j}}\), \(L=-\sum_i y_i\ln p_i\).
연쇄 결과 (표준):
$$
\frac{\partial L}{\partial z_i} = p_i - y_i.
$$
이는 경로합 관점의 전형적 예.

---

## 편도 연쇄법칙의 증명 스케치

### \(\phi(u_1,\dots,u_m)\)와 \(u_j(x)\)의 경우

정의에 근거한 미분 증명(극한과 선형성):
$$
\phi(\mathbf{u}+\Delta\mathbf{u}) - \phi(\mathbf{u})
= \sum_{j=1}^m \frac{\partial \phi}{\partial u_j}\Delta u_j + o(\|\Delta\mathbf{u}\|).
$$
또
$$
\Delta u_j = \sum_{i=1}^n \frac{\partial u_j}{\partial x_i} \Delta x_i + o(\|\Delta \mathbf{x}\|).
$$
조합하면
$$
\phi(\mathbf{u}(\mathbf{x}+\Delta\mathbf{x})) - \phi(\mathbf{u}(\mathbf{x}))
= \sum_{i=1}^n\left(\sum_{j=1}^m \frac{\partial \phi}{\partial u_j}\frac{\partial u_j}{\partial x_i}\right)\Delta x_i
+ o(\|\Delta\mathbf{x}\|).
$$
계수 동일성으로 연쇄법칙 성립.

---

## 지수·로그·삼각 함수의 편도 연쇄 예제

### \(f(x,y)=\exp(x\sin y)\)

- \(u=x\sin y\).
- \(f_x = e^u \cdot \sin y\).
- \(f_y = e^u \cdot x\cos y\).

### \(f(x,y,z)=\ln(x^2+y^2+z^2)\)

- \(u=x^2+y^2+z^2\).
- \(f_{x} = \dfrac{2x}{u}\), \(f_{y}=\dfrac{2y}{u}\), \(f_{z}=\dfrac{2z}{u}\).

### \(f(r,\theta)=\cos(r^2\theta)\), \(x=r\cos\theta,\ y=r\sin\theta\)와의 결합

극좌표 변화까지 겹치면 (6.1)과 합성:

- \(u=r^2\theta\), \(f=\cos u\).
- \(f_r = -\sin u \cdot 2r\theta\), \(f_\theta = -\sin u \cdot r^2\).

---

## 실전: 편도 연쇄를 파이썬으로 확인 (심볼릭/수치)

### SymPy로 편도 연쇄 확인

```python
import sympy as sp

x, y = sp.symbols('x y', real=True)
u = x*sp.sin(y)
f = sp.exp(u)

# 직접 편미분

fx_direct = sp.diff(f, x)
fy_direct = sp.diff(f, y)

# 연쇄로 구성: df/du * du/dx 등

df_du = sp.diff(sp.exp(sp.Symbol('u')), sp.Symbol('u'))  # symbolic template
df_du = sp.exp(u)  # substitute u back
du_dx = sp.diff(u, x)
du_dy = sp.diff(u, y)

fx_chain = df_du * du_dx
fy_chain = df_du * du_dy

print(sp.simplify(fx_direct - fx_chain))  # 0
print(sp.simplify(fy_direct - fy_chain))  # 0
```

### NumPy로 수치 검증 (전방 차분)

```python
import numpy as np

def f(x, y):
    return np.exp(x*np.sin(y))

def fx_num(x, y, h=1e-6):
    return (f(x+h, y) - f(x-h, y)) / (2*h)

def fy_num(x, y, h=1e-6):
    return (f(x, y+h) - f(x, y-h)) / (2*h)

def fx_chain(x, y):
    return np.exp(x*np.sin(y)) * np.sin(y)  # df/du * du/dx

def fy_chain(x, y):
    return np.exp(x*np.sin(y)) * x*np.cos(y)  # df/du * du/dy

x0, y0 = 0.7, 1.2
print(fx_num(x0, y0), fx_chain(x0, y0))
print(fy_num(x0, y0), fy_chain(x0, y0))
```

---

## 역전파/자동미분에서의 편도 연쇄

### 스칼라 로스 \(L\)에 대한 파라미터 \(\theta\)

계산 그래프에서
$$
\frac{\partial L}{\partial \theta}
= \sum_{\text{children } u}\frac{\partial L}{\partial u}\frac{\partial u}{\partial \theta}.
$$
즉 위상정렬의 **역순**으로 그라디언트를 전파.

### PyTorch 예시(자동미분 검증)

```python
import torch

x = torch.tensor([0.7], requires_grad=True)
y = torch.tensor([1.2], requires_grad=True)

u = x*torch.sin(y)
f = torch.exp(u)         # f = e^{x sin y}

f.backward()             # df/dx, df/dy 자동 계산
print(x.grad.item(), y.grad.item())

# 수학 해석: df/dx = e^{x sin y} * sin y, df/dy = e^{x sin y} * x cos y

```

---

## 조심해야 할 점들 (함정 체크리스트)

- **변수명 충돌**: 종종 \(y\)를 출력으로도, 독립변수로도 쓰는 실수를 한다. 합성 구조에서는 각 기호를 명확히.
- **은밀한 의존성**: \(u=u(x,y)\)인데 \(u=u(x)\)로 착각하면 편도 누락.
- **절댓값/정의역**: \(\ln(\cdot)\), \(\sqrt{\cdot}\)는 정의역 제약이 있어 역치환/연쇄시 주의.
- **벡터/행렬 차원**: 야코비안 곱의 **치수 일관성**을 반드시 확인.
- **2계 미분**: 합성 헤시안에는 \(J^\top H J\) 항뿐 아니라 **중간 성분 헤시안**이 추가되는 것을 잊지 말 것.

---

## 확장: 다단 합성(깊은 합성)의 편도 연쇄

\( f = f^{(L)}\circ f^{(L-1)}\circ \cdots \circ f^{(1)}(\mathbf{x}) \).
그라디언트:
$$
\nabla_{\mathbf{x}} f
= \left(\prod_{\ell=1}^{L-1} J_{f^{(L-\ell)}}\right)^\top \nabla_{\mathbf{z}^{(L-1)}} f^{(L)}.
$$
여기서 곱은 **정확한 순서**로, 일반적으로 오른쪽에서 왼쪽으로 곱해진다.

---

## 지오메트리: 곡선 재매개화의 편도 연쇄

곡선 \(\mathbf{r}(s)\), 길이 매개 \(s\)에 대한 어떤 스칼라장 \(f(\mathbf{r}(s))\)의 \(s\)-미분:
$$
\frac{df}{ds}
= \nabla f(\mathbf{r}(s))\cdot \frac{d\mathbf{r}}{ds}.
$$
**편도 연쇄의 벡터형**이다.

---

## 실전 문제 풀이 세트

### 문제 17.1

\( \phi(u,v)=\sqrt{u^2+v^2} \), \(u(x,y)=e^x\cos y\), \(v(x,y)=e^x\sin y\).
1) \(\partial \phi/\partial x\)와 \(\partial \phi/\partial y\)를 구하라.
2) 결과를 단순화하라.

**해설 스케치**
\(\phi=\sqrt{u^2+v^2}=e^x\). 따라서 \(\phi_x=e^x\), \(\phi_y=0\).
연쇄로 계산해도 같은 값이 나와야 한다.
\(\phi_u=u/\phi,\ \phi_v=v/\phi\), \(u_x=e^x\cos y,\ v_x=e^x\sin y\), \(u_y=-e^x\sin y,\ v_y=e^x\cos y\).
대입하면 \(\phi_x=(u u_x + v v_x)/\phi = e^x\), \(\phi_y=(u u_y + v v_y)/\phi=0\).

### 문제 17.2

극좌표 \(x=r\cos\theta,\ y=r\sin\theta\)에서 \(f(x,y)=x^3-3xy^2\).
\(f_r,\ f_\theta\)를 편도 연쇄로 구하라.

**풀이 힌트**
\(f_x=3x^2-3y^2,\ f_y=-6xy\).
\(f_r=f_x\cos\theta + f_y\sin\theta\), \(f_\theta=f_x(-r\sin\theta)+f_y(r\cos\theta)\).
최종 정리는 직접 전개.

### 문제 17.3

\(g(u,v,w)=\ln(u+v+w)\), \(u=x^2,\ v=y^2,\ w=z^2\).
\(\partial g/\partial x\), \(\partial g/\partial y\), \(\partial g/\partial z\)를 구하라.
**정답**
\(\frac{2x}{x^2+y^2+z^2}\), \(\frac{2y}{x^2+y^2+z^2}\), \(\frac{2z}{x^2+y^2+z^2}\).

### 문제 17.4 (암시적)

\(F(x,y,z)=x^2+y^2+z^2-1=0\)에서 \(z=z(x,y)\).
\(z_x, z_y\)를 구하라.
**정답**
\(z_x = -x/z\), \(z_y=-y/z\) (단, \(z\ne 0\)).

---

## 계산 그래프 코드 예제: 수작업 역전파(교육용)

```python
# 단순 계산 그래프에서 편도 연쇄의 경로합 구현

import math

def forward(x):
    # x -> u1 = sigmoid(x), u2 = x*x, f = tanh(u1 + u2)
    u1 = 1.0/(1.0 + math.exp(-x))
    u2 = x*x
    f = math.tanh(u1 + u2)
    cache = (x, u1, u2, f)
    return f, cache

def backward(cache):
    x, u1, u2, f = cache
    # df/du = sech^2(u), where u = u1+u2
    sech2 = 1.0/(math.cosh(u1 + u2)**2)
    # chain to x via two paths
    du1_dx = u1*(1.0 - u1)
    du2_dx = 2.0*x
    df_dx = sech2 * du1_dx + sech2 * du2_dx
    return df_dx

x0 = 0.7
f, cache = forward(x0)
g = backward(cache)
print(f, g)
```

---

## 실무 체크리스트 요약

- 합성 구조를 **노드 단위**로 분해하라.
- 각 노드의 **국소 편도**를 먼저 확실히 써라.
- 최종 편도는 **모든 경로의 곱의 합**이다 (스칼라 출력 시).
- 벡터/행렬형이면 **야코비안 곱**으로 정리하라.
- 2계가 필요하면 \(J^\top H J\)와 **중간 헤시안 항**을 빠뜨리지 말라.
- 좌표변환/암시적 정의는 연쇄법칙의 **변형된 응용**이다.
- 자동미분 프레임워크(Pytorch 등)는 **이 원리로** 돌아간다.

---

## 한 페이지 공식 요약

1) 한 경로:
$$
\frac{\partial y}{\partial x_i}
= \frac{dy}{du}\frac{\partial u}{\partial x_i}.
$$

2) 다중 경로(스칼라 출력 \(\phi\)):
$$
\frac{\partial \phi}{\partial x_i}
= \sum_{j=1}^{m} \frac{\partial \phi}{\partial u_j}\frac{\partial u_j}{\partial x_i}.
$$

3) 야코비안 형식(벡터 출력):
$$
J_{\mathbf{y}}(\mathbf{x})
= J_{\mathbf{y}}(\mathbf{u})\, J_{\mathbf{u}}(\mathbf{x}),\qquad
\nabla_{\mathbf{x}} y = J_{\mathbf{u}}^\top \nabla_{\mathbf{u}} y.
$$

4) 합성 헤시안:
$$
H_{\mathbf{x}} f
= J_{\mathbf{u}}^\top H_{\mathbf{u}} g\, J_{\mathbf{u}}
 + \sum_k \frac{\partial g}{\partial u_k}\, H_{\mathbf{x}}u_k.
$$

5) 암시적 함수:
$$
\frac{dy}{dx} = -\frac{F_x}{F_y},\quad
z_x=-\frac{F_x}{F_z},\ z_y=-\frac{F_y}{F_z}.
$$

6) 극좌표:
$$
f_r = f_x\cos\theta + f_y\sin\theta,\quad
f_\theta = -r f_x\sin\theta + r f_y\cos\theta.
$$

---

## 추가 연습문제 (해답 스케치)

1) \(h(u,v,w)=\exp(u v) + \sin w\), \(u=x+y,\ v=xy,\ w=x^2-y\).
   \(\partial h/\partial x\)를 구하라.
   **스케치**: \(h_u=v e^{uv}\), \(h_v=u e^{uv}\), \(h_w=\cos w\),
   \(u_x=1,\ v_x=y,\ w_x=2x\).
   \(h_x = h_u u_x + h_v v_x + h_w w_x\).

2) \(f(x,y)=g(u(x,y))\)에서 \(g(t)=\ln(1+e^t)\), \(u(x,y)=x\cos y\).
   \(\nabla f\)를 구하라.
   **스케치**: \(g'(t)=\frac{e^t}{1+e^t}=\sigma(t)\),
   \(u_x=\cos y,\ u_y=-x\sin y\).
   \(f_x=\sigma(u)\cos y,\ f_y=\sigma(u)(-x\sin y)\).

---

## 결론

편도함수의 연쇄법칙은 **모든 다변수 미분의 심장**이다.
스칼라/벡터/행렬 표기 사이를 자유롭게 오가고, 계산 그래프에서 **경로별 곱의 합**으로 보는 관점까지 익히면,
좌표변환·암시적 미분·2계 민감도·역전파·자동미분 전 영역이 하나의 틀에서 자연스럽게 연결된다.

이제 실제 문제(최적화, 물리, 기하, 통계)에서 **합성 구조를 도식화**하고, 국소 편도를 쌓아 **연쇄법칙으로 전체 편도**를 조직적으로 구하라.
그것이 해석과 구현을 동시에 단단하게 해준다.
