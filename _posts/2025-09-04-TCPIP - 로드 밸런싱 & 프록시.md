---
layout: post
title: TCPIP - 로드 밸런싱 & 프록시
date: 2025-09-04 20:25:23 +0900
category: TCPIP
---
# 16. 로드 밸런싱 & 프록시
**(🔰 L4 vs L7 LB 차이·헬스체크, ⚙️ 리버스 프록시·Keep-Alive·커넥션 풀, 🚀 Anycast LB·글로벌 트래픽 분산 패턴)**

> 이 장은 **서비스 입구(Edge)**에서부터 **백엔드(Origin/Microservices)**까지 트래픽을 **어떻게 고르게·안전하게·빠르게** 흘려보낼지에 대한 **설계·운영·디버깅 가이드**입니다.  
> 명령/설정은 ``` 코드 블록으로, 수식은 *MathJax*로 적습니다.

---

## 16.1 L4 vs L7 로드밸런서 (🔰)

### 16.1.1 정의와 비교

| 구분 | L4 LB(전송계층) | L7 LB(응용계층) |
|---|---|---|
| 처리 단위 | TCP/UDP 5-튜플, 바이트 스트림 | HTTP/1.1·2·3, gRPC 등 메시지/헤더 |
| 기능 | NAT/SNAT/DNAT, 포트 포워딩, DSR, PROXY protocol | 호스트/경로 라우팅, 헤더/쿠키 기반 라우팅, 압축, WAF, TLS 종료, gRPC 라우팅 |
| 성능 | 단순·고성능·저 CPU | 기능 풍부·CPU↑, 지연 overhead |
| 관측 | 연결 지표 중심 | 요청 단위 지표(메서드/코드/경로) |
| 대표 | Linux VIP+IPVS/NFT, NLB, LVS/HAProxy(TCP) | Envoy/NGINX/HAProxy(HTTP), ALB/GLB/Cloud proxy |

> **일반 패턴**: 외부 → **L4(DoS 흡수/연결 분산)** → **L7(정책/캐시/압축)** → 서비스.

### 16.1.2 데이터 경로 개요
```
Client
  └─(DNS)→ VIP
       L4: TCP/UDP 분산(DSR/SNAT/PROXY)
          └─ L7: TLS 종료/라우팅/정책
                 └─ App Pod/VM
```

### 16.1.3 선택 기준(요약)
- **초저지연·고RPS·UDP(QUIC/DNS/게임)**: L4.  
- **도메인/경로/헤더 기반 라우팅, gRPC, Auth/WAF/캐시**: L7.  
- **혼합**: L4 앞단(흡수/Anycast) + L7 뒷단(정책).

---

## 16.2 헬스체크(Health Check) & 상태 모델 (🔰)

### 16.2.1 종류
- **L3/L4**: ICMP/TCP SYN 성공 여부(빠름, 단순).  
- **HTTP/HTTPS**: `GET /healthz` 200 & 바디 검사(의미적).  
- **gRPC Health**: `grpc.health.v1/Check` 상태 코드.  
- **수동/수집형**: 실패율·지연 기반 **Outlier Detection**(패시브).

### 16.2.2 파라미터
- **interval / timeout / healthy_threshold / unhealthy_threshold**  
- **jitters**(체크 시간 랜덤화)로 **동시 스파이크** 방지.  
- **탐지→격리→재시도**의 루프를 **느슨하게**(flap 방지).

### 16.2.3 Outlier Detection(개념)
- **연속 5xx** 혹은 **P95 지연>임계** → **일시 격리**(ejection).  
- **반복 플랩** 방지: 유예 시간, **EWMA**로 점수화.

---

## 16.3 분산 알고리즘 (공통)

- **Round Robin**: 단순·균등.  
- **Least Connections/Requests**: 현재 처리 중인 연결/요청 수가 적은 서버 선택.  
- **Weighted**: 가중치 기반.  
- **Power of Two Choices(P2C)**: 임의 2개 중 더 가벼운 곳 → **저비용·효율적**.
- **Consistent Hash / Ring / Maglev**: 키(세션/고객/파티션) 기반 **스티키/샤딩**.  
- **EWMA(지연 가중)**: 최근 지연·오류 반영하여 자연스러운 트래픽 이동.

**P2C 의사코드**
```
pick a = rand(server_set); pick b = rand(server_set)
return (load(a) <= load(b)) ? a : b
```

---

## 16.4 리버스 프록시, Keep-Alive, 커넥션 풀 (⚙️)

### 16.4.1 리버스 프록시 역할
- **TLS 종료**(mTLS/OCSP), **가상호스트**(SNI/Host), **정책**(Auth/WAF), **캐시/압축/Brotli**, **헤더 가공**(`X-Forwarded-For`, `Forwarded`).  
- **gRPC/HTTP2 멀티플렉싱**, **WebSocket 업그레이드**, **HTTP/3(QUIC)**.

### 16.4.2 Keep-Alive & 커넥션 풀
- **클라→프록시**: HTTP/2/3로 **소수 연결**에 다중 스트림.  
- **프록시→백엔드**: **커넥션 풀**(미리 연결/재사용)로 **핸드셰이크/Slow start** 비용 절감.
- **주의**: HTTP/2 단일 연결에 과도한 스트림 → **서버 한 코어 핫스팟**. **풀 내 다수 연결**로 분산.

**큐·대기 시간 감각** (리틀의 법칙):
\[
L = \lambda W \;\Rightarrow\; \text{동시 연결수}(L) = \text{도착률}(\lambda)\times\text{응답시간}(W)
\]
- 목표 동시성에 맞춰 **풀 크기**와 **서버 수** 산정.

### 16.4.3 타임아웃/한도
- **idle timeout / headers timeout / read timeout / write timeout**  
- **max concurrent streams**(H2), **max requests per connection**, **request body size**, **header size** 등 **폭주 흡수**.

### 16.4.4 프로토콜 힌트
- **PROXY protocol v1/v2**: L4 LB 뒤에서도 **원 클라이언트 IP**를 백엔드로 전달.  
- **X-Forwarded-For / X-Forwarded-Proto / Forwarded**: L7에서 클라이언트 체인 보존.

---

## 16.5 설정 예시(핵심 스니펫)

### 16.5.1 HAProxy — L4(TCP) + PROXY
```haproxy
global
  nbthread 4
  maxconn 200000

defaults
  mode tcp
  timeout client  60s
  timeout server  60s
  timeout connect 5s

frontend ft_https
  bind :443 accept-proxy
  default_backend bk_https

backend bk_https
  balance leastconn
  server s1 10.0.1.10:443 send-proxy check
  server s2 10.0.1.11:443 send-proxy check
```

### 16.5.2 HAProxy — L7(HTTP) + H2 + 헬스/Outlier
```haproxy
frontend ft_http
  bind :443 ssl alpn h2,http/1.1 crt /etc/ssl/cert.pem
  http-request set-header X-Forwarded-Proto https
  default_backend bk_app

backend bk_app
  mode http
  balance hdr(Host) use_domain_only
  option httpchk GET /healthz
  http-check expect status 200
  server-template app 3 app%.svc:8080 check fall 3 rise 2
  # simple outlier: on-error mark down for 30s (lua/agent 기반 심화 가능)
```

### 16.5.3 NGINX — 리버스 프록시 + 풀
```nginx
http {
  upstream app {
    zone app 64k;
    keepalive 256;
    server 10.0.2.10:8080 max_fails=3 fail_timeout=10s;
    server 10.0.2.11:8080;
  }
  server {
    listen 443 ssl http2;
    ssl_certificate /etc/ssl/fullchain.pem;
    ssl_certificate_key /etc/ssl/privkey.pem;

    location / {
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_read_timeout 60s;
      proxy_pass http://app;
    }
    location = /healthz { return 200 "ok\n"; }
  }
}
```

### 16.5.4 Envoy — L7 라우팅 + Outlier + Circuit Breaker
```yaml
static_resources:
  listeners:
  - name: https
    address: {socket_address: {address: 0.0.0.0, port_value: 443}}
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress
          http2_protocol_options: {max_concurrent_streams: 200}
          route_config:
            virtual_hosts:
            - name: app
              domains: ["example.com"]
              routes:
              - match: {prefix: "/api"}
                route: {cluster: app}
          http_filters: [{name: envoy.filters.http.router}]
  clusters:
  - name: app
    connect_timeout: 0.5s
    type: STRICT_DNS
    lb_policy: LEAST_REQUEST
    circuit_breakers:
      thresholds:
      - priority: DEFAULT
        max_connections: 10000
        max_requests: 20000
        max_pending_requests: 5000
    outlier_detection:
      consecutive_5xx: 5
      interval: 10s
      base_ejection_time: 30s
    load_assignment:
      cluster_name: app
      endpoints:
      - lb_endpoints:
        - endpoint: {address: {socket_address: {address: 10.0.3.10, port_value: 8080}}}
        - endpoint: {address: {socket_address: {address: 10.0.3.11, port_value: 8080}}}
```

---

## 16.6 세션 스티키(고정) 전략

- **쿠키 기반(L7)**: LB가 **Set-Cookie**(`route=backend1`)로 고정.  
- **소스 IP 해시(L4)**: 클라이언트 IP를 해시하여 백엔드 선택.  
- **일관 해시/링**: **키**(사용자ID/파티션)로 특정 백엔드에 묶음.  
- **주의**: 고정은 **불균형/Hot shard**를 유발. **P2C+스티키** 혼합이나 **상태 외부화(세션 저장소)**가 장기적 해법.

---

## 16.7 L4 기술 포인트

### 16.7.1 DSR(Direct Server Return)
- 요청: **VIP→서버**, 응답: **서버→클라(직접)**. LB 응답면의 병목 제거.  
- 서버에 **VIP Secondary** 바인딩, **ARP 억제**, **루프백 응답** 설정 필요.
```
# 개념: 서버에서 VIP를 lo에 바인딩 (announce off)
ip addr add 203.0.113.10/32 dev lo
```

### 16.7.2 SNAT/DNAT
- **SNAT**: 내부→외부 주소 변환(소스 IP LB/NAT IP로).  
- **DNAT**: VIP:PORT → Backend:PORT.  
- **PROXY protocol**로 **원 IP 전달** 보완.

### 16.7.3 UDP LB (DNS/QUIC)
- 연결 상태가 약한 UDP는 **5-튜플 해시**로 분산.  
- QUIC(H3) 지원 시 **0-RTT/핸드셰이크** 고려, **토큰/Retry**로 증폭 방지.

---

## 16.8 L7 기술 포인트

### 16.8.1 라우팅 규칙
- **Host 기반**: `api.example.com` → API 클러스터.  
- **Path 기반**: `/v1/`와 `/static/` 분리.  
- **헤더/쿠키**: A/B 테스트, 카나리(10%).  
- **메서드/콘텐츠 타입**: `GET` 캐시, `POST` 라이브 라우팅.

### 16.8.2 HTTP/2·3·gRPC
- **H2**: 멀티플렉싱, 서버 푸시(사실상 퇴조), 우선순위 신호.  
- **H3(QUIC)**: 손실 내성/연결 이식성. LB는 **UDP 443** 필요, 불가 시 **H2 폴백**.  
- **gRPC**: 스트리밍·메서드명 기반 라우팅, **max stream** 관리.

### 16.8.3 캐시/압축
- **Brotli** 텍스트, **ETag/Cache-Control** 준수.  
- **stale-while-revalidate/if-error**로 가용성↑.

---

## 16.9 관측·보호: 골든 시그널 & 회로차단기

### 16.9.1 골든 시그널
- **레이턴시(P50/P95/P99)**, **오류율(4xx/5xx)**, **트래픽(RPS/대역)**, **포화(큐/CPU/FD)**.  
- **큐 대기시간**(Upstream connect/TTFB 분해), **리트라이율**, **Outlier ejection** 횟수.

### 16.9.2 회로차단(Circuit Breaker)
- **반개방(Open→Half→Closed)**, **에러·타임아웃** 임계 초과 시 **즉시 거절/폴백**.  
- **Bulkhead**: 클러스터·풀 별 **격벽**(폭주 전파 차단).

### 16.9.3 레이트리밋/도스 방어
- **L4**: SYN rate limit, connlimit.  
- **L7**: IP/토큰·엔드포인트별 토큰버킷.  
- **봉쇄 vs 흡수**: **Anycast + 분산**이 구조적으로 유리.

---

## 16.10 글로벌 트래픽 분산(🚀)

### 16.10.1 Anycast LB
- **여러 엣지**가 **같은 VIP**를 **BGP**로 광고 → 클라가 **네트워크 정책상 가까운** 곳으로.  
- 장점: **지연↓/DDoS 분산/장애 도시·대륙 국소화**.  
- 과제: **BGP 수렴/플랩**, **지역 불균형**, **상태 공유** 어려움.

**구성 개요**
```
[Edge POP1]--\
[Edge POP2]---\  (모두 203.0.113.10/32 Anycast)  --> 백엔드 리전/오리진
[Edge POP3]---/
```
- **RHI(Route Health Injection)**: 헬스 실패 시 **경로 철회**.  
- **BGP Community**로 트래픽 유도/차단(사업자별 정책).

### 16.10.2 DNS 기반 GSLB
- Authoritative DNS가 **헬스/지연/지리**를 보고 **레코드 응답**.  
- 정책: **지연 기반(Latency)**, **지리 기반(Geo)**, **가중치(Weighted)**, **근접성(ASN/도시)**.  
- 한계: **DNS TTL·캐시**, **EDNS Client Subnet** 한계, **재시도 시 흩어짐**.

### 16.10.3 하이브리드
- **Anycast 엣지**로 1차 **흡수** → 내부에서 **GSLB/정책**으로 **오리진 선택**.  
- **지역 세션 고정**: 쿠키/Region Affinity, **쓰기 경로**는 **리더 리전**(데이터 정합성 고려).

### 16.10.4 멀티 리전 배치 패턴
- **Active-Active**: 모든 리전 서빙. **데이터 정합성**과 **분산락/샤딩**이 핵심.  
- **Active-Standby**: 장애 시 스위치. 단순하지만 **릴로드/캐시 워밍** 필요.  
- **트래픽 분할**: 90/10 카나리, 지역별 세율 조정(스텝 업).

---

## 16.11 릴리스 전략 & 트래픽 제어

- **카나리**: L7에서 **헤더/쿠키/비율** 기반 라우팅. 메트릭 감시 후 승격.  
- **블루/그린**: 두 세트 중 하나만 활성. 스위치 순간에 **커넥션 드레인** 필요.  
- **섀도(미러)**: 요청 복제(응답은 무시)로 **부작용 없이** 관측.

**NGINX 드레인 예**
```nginx
upstream app {
  server 10.0.3.10:8080;
  server 10.0.3.11:8080 backup;  # 새 버전
}
# 점차 가중치 이동 또는 'down' 플래그로 드레인
```

---

## 16.12 성능·커널·시스템 튜닝(요지)

### 16.12.1 커널 네트워크
```bash
sysctl -w net.core.somaxconn=4096
sysctl -w net.ipv4.ip_local_port_range="1024 65000"
sysctl -w net.netfilter.nf_conntrack_max=524288
sysctl -w net.core.rmem_max=134217728
sysctl -w net.core.wmem_max=134217728
sysctl -w net.ipv4.tcp_congestion_control=cubic   # 또는 bbr
sysctl -w net.core.default_qdisc=fq               # pacing
```

### 16.12.2 FD/스레드/바인딩
- **ulimit -n**(FD 수), **SO_REUSEPORT**(다중 워커 균등), **IRQ/NUMA 핀닝**.  
- **TSO/GSO/GRO** 검토(지연 민감 서비스는 조정).

### 16.12.3 TLS
- **TLS 1.3** 기본, **세션 재개/티켓 키 롤링**, **ECDSA** 인증서(작은 키/빠른 핸드셰이크).  
- **AIO/Sendfile/Zerocopy**로 CPU↓.

---

## 16.13 장애 시나리오 & 디버깅

### 16.13.1 “헬스는 초록, 실제는 느림(브라운아웃)”
```text
원인: /healthz는 OK지만 DB/캐시 의존성은 병목
조치: 심층 헬스(의존성 체크), 합성 모니터링(Synthetic), 패시브 Outlier
```

### 16.13.2 “일부 지역만 5xx 급증”
```text
원인: Anycast 경로 변경/리전 고립/엣지 과부하
조치: BGP 커뮤니티로 우회, GSLB 가중 조정, 엣지 자동 스케일
관측: 지역별 P95, RPS, LB ejection, BGP 모니터
```

### 16.13.3 “WebSocket 대량 연결 후 지연↑”
```text
원인: 풀 크기/FD 부족, 스레드 핫스팟
조치: keepalive timeout/수, SO_REUSEPORT, 백엔드 브로커링(채널), 노드 수 확장
```

### 16.13.4 “H3 연결 실패, H2로 폴백”
```text
원인: 443/UDP 차단, MTU/ICMP PTB 차단, QUIC 토큰 검증 실패
조치: 443/UDP 개방, ICMP PTB 허용, Retry/토큰 로직 점검
```

---

## 16.14 체크리스트(요약 카드)

**설계**
- [ ] L4(흡수) + L7(정책) 계층화, Anycast/지역 분산 고려  
- [ ] 라우팅 규칙: Host/Path/헤더/메서드, 카나리/블루그린  
- [ ] 헬스: 액티브+패시브, Outlier, 드레인/복귀 정책

**성능**
- [ ] Keep-Alive, 커넥션 풀, H2/H3 멀티플렉싱, 풀 크기 한도  
- [ ] 큐·대기/연결 시도·리트라이율 모니터  
- [ ] TLS1.3, ECDSA, 세션 티켓 롤링

**안정성**
- [ ] Circuit breaker, Rate limit, WAF/ACL  
- [ ] Anycast RHI, GSLB 동작·TTL, 리전 장애 플랜  
- [ ] 로그·지표·트레이싱(분산 트레이스) 일관

**운영**
- [ ] 변경은 카나리→확대, 롤백/폴백 스크립트  
- [ ] SLO/P95/P99 정의, 에러 버짓 기반 조정  
- [ ] 재해 복구 리허설, 게임데이(장애 훈련)

---

## 16.15 한 장 요약(포스터)
- **L4**는 빠르고 튼튼한 기초(DSR/SNAT/UDP), **L7**은 똑똑한 두뇌(라우팅/정책/캐시).  
- **헬스체크/Outlier**로 **불량 노드 격리**, **커넥션 풀+H2/H3**로 **RTT/초기비용** 절감.  
- **Anycast + GSLB**로 **글로벌 지연↓/장애 국소화**, **카나리/회로차단**으로 **안전**.  
- **관측**(지연·오류·트래픽·포화)과 **자동화**(드레인·가중치 조정)가 곧 품질.

---

### 부록 A — 빠른 진단 명령
```bash
# 연결/큐/지연
ss -tin | head
ss -s
# IPVS/iptables
ipvsadm -Ln
iptables -t nat -S | egrep 'DNAT|SNAT|MASQUERADE'
# BGP/Anycast(장비/호스트 의존)
birdc show protocols
# HTTP/H2/H3 테스트
curl -I -w 'proto=%{http_version} ttfb=%{time_starttransfer}\n' https://host
curl --http2 -I https://host
curl --http3 -I https://host
```

### 부록 B — 헤더/원 IP 보존
```
X-Forwarded-For: <client ip>, <proxy ip>
X-Forwarded-Proto: https
Forwarded: for=<ip>; proto=https; host=<host>
PROXY protocol v1: "PROXY TCP4 198.51.100.10 10.0.0.10 54321 443\r\n"
```

### 부록 C — 지표 필드 제안
```text
[프런트] conn_active, conn_new/s, accept_err/s, tls_handshake_ms
[요청] req/s, 2xx/3xx/4xx/5xx, ttfb_p50/p95/p99
[백엔드] upstream_connect_ms, queue_wait_ms, upstream_ttfb_ms
[안정] retry_rate, outlier_ejections, circuit_open, rate_limit_blocks
[글로벌] region_share%, fallback_rate%, anycast_flaps, dns_ttl_effective
```