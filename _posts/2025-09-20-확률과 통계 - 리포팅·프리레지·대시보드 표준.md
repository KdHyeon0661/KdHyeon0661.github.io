---
layout: post
title: 확률과 통계 - 리포팅·프리레지·대시보드 표준
date: 2025-09-20 22:25:23 +0900
category: 확률과 통계
---
# 리포팅·프리레지·대시보드 표준

> **목표**
> - **프리레지(사전등록) 템플릿**을 표준화해 가설·설계·분석·정지 규칙을 명확히 남긴다.
> - **리포팅 문구/표·그림 표준**을 정해, OR/IRR/AME와 강건표준오차(CRVE)·HAC·무작위화 추론(RI) 결과를 일관되게 전달한다.
> - **품질 대시보드**(SRM/노출/지연/봇)와 **사건 타임라인**을 자동화해, 운영 리스크를 상시 감시한다.

---

## 철학 — “결정 가능한 리포트, 재현 가능한 실험”

- 프리레지는 **가정을 고정**하고 **엿보기/후조정** 위험을 차단한다.
- 리포팅은 **의사결정 중심 문장**과 **효과크기+불확실성**을 간결하게 제공한다.
- 대시보드는 **품질과 위험**을 자동 감시하며, **사건 타임라인**으로 분석 해석에 필요한 **맥락**을 보존한다.

---

## 프리레지(사전등록) 템플릿

아래는 **실무용 표준 템플릿**입니다. 그대로 복사해 프로젝트 문서에 붙여 쓰세요.

### 메타정보

- **Experiment ID**: `exp_push_evening_2025Q1_v2`
- **Owner / Reviewer**: 데이터팀 / PM / SRE
- **Start / Planned End**: 2025-03-01 ~ 2025-03-21 (최대 3주 or 정지 규칙 충족 시 조기 종료)
- **Repo & Dashboard**: 분석 노트북/SQL 링크, 대시보드 URL

### 가설·목표

- **Primary Hypothesis (단측/양측)**: 저녁 푸시(변형 B)는 **전환율(CVR)** 을 **상승(단측)** 시킨다.
- **Primary KPI**: `CVR = conversions / eligible_exposures` (사용자 단위)
- **MDE\***: **+0.30pp** (사용자 기준), **가드레일**: D1 이탈률 악화 ≤ +0.10pp
- **Secondary**: `ARPU(14d)`, `CTR`, `세션당 페이지뷰`
- **Exploratory**: 신규/복귀, 디바이스, 국가 상호작용(CATE 스크리닝)

### 대상·자격(Eligibility)

- **Population**: 지난 28일 내 1회 이상 활동 사용자
- **Exclusions**: 봇·사내 트래픽·미성년 보호국가 옵트아웃
- **Window / TZ**: 노출/전환 집계는 **UTC**, 리포트는 **Asia/Seoul** 표기

### 배정·설계

- **Randomization Unit**: 사용자 ID (해시 솔트: `salt_2025_03`)
- **Ratio**: A:B = 50:50
- **Stratification**: 플랫폼(iOS/Android) × 최근활동(신규/복귀) × 국가(Top5/기타)
- **재랜덤화 채택 기준(옵션)**: 각 스트라텀의 과거 CVR 차이 **Mahalanobis 거리** < 임계

### 간섭·설계유형

- **SUTVA 가정**: 개인 간 간섭 미미. 피드 재랭킹/캐시 간섭 의심 시 **스위치백** 설계로 강등
- **클러스터 설계 필요성**: 없음(이번 실험은 개인화 푸시)

### 표본·파워

- **샘플 추정**: 기존 분산 기준, **MDE 0.30pp**, 파워 0.8, α=0.05 → **N_user ≈ 2.4M**
- **CUPED/ANCOVA**: 사전 28일 CTR·세션으로 **\(R^2≈0.30\)** 기대 → **MDE × √(1−R²) ≈ 0.84배**
- **최대 기간**: 3주 (딜레이 지표 고려)

### 측정·정의

- **CVR**: `unique_converters / unique_exposed_users` (사용자 레벨 0/1)
- **ARPU(14d)**: 전환 이후 14일 내 수익 합(원) — **윈저 99.5%**
- **CTR**: 클릭 카운트 / 노출 카운트 (오프셋=log 노출)
- **딜레이**: 구매 지연 분포 p50/p95 추정, 리포트는 **완료 지표**만

### 분석 계획

- **Primary**: 로지스틱(사용자 단위) → **OR & AME(∆p, pp)** + **CRVE(클러스터=사용자)**
  $$\operatorname{logit}\Pr(\text{convert}=1)=\alpha+\tau T+\gamma^\top Z+\delta^\top(T\cdot Z)$$
- **카운트**: 포아송/NB(오프셋 log 노출) → **IRR**
- **CUPED/ANCOVA**: 사전 지표 포함(§14편 규칙), HC3
- **다중비교**: 2차·탐색 지표는 **BH-FDR 10%**
- **세그먼트**: 탐색으로만 표기, 확증 재실험 권고

### 정지 규칙

- **연속 모니터링**: **mSPRT(베타–이항, α=0.05)** 단측 우월성
  $$\log \Lambda^{\text{mix}}\ge \log(1/\alpha) \Rightarrow \text{성공 종료}$$
- **가드레일**: 이탈률 역 mSPRT 경계 통과 시 **즉시 중단**
- **Group Sequential 보조**: 주 2회 Pocock 경계로 교차검증

### 품질·SRM

- **SRM 알람**: 전체/스트라텀 **p < 10^{-4}** 중단
- **노출율 차**: |A−B| > 0.5pp 알람
- **지연/중복/봇**: 대시보드 위젯으로 상시 모니터링

### 결정 기준 & 롤아웃

- **성공**: CVR uplift AME ≥ +0.30pp **및** 가드레일 통과
- **롤아웃**: 100% 단계적(24h), 가드레일 1주 추가 모니터링
- **실패**: 종료 및 원인 분석(지표/세그먼트/품질)

### 변경 이력 (중요)

- 규칙 변경 시점·사유·승인자 기록(후조정 방지)

---

## 프리레지 **YAML 템플릿** (복사해서 채우기)

```yaml
exp_id: exp_push_evening_2025Q1_v2
owners: [ "data_analyst@company.com", "pm@company.com" ]
reviewers: [ "stat_lead@company.com", "sre@company.com" ]
timeline:
  start: "2025-03-01"
  planned_end: "2025-03-21"
hypotheses:
  primary:
    type: "one-sided"
    text: "Evening push (B) increases user-level conversion probability vs A."
    kpi: "CVR_user"
    mde_pp: 0.30
  secondary:
    - { name: "ARPU_14d", direction: "increase" }
    - { name: "CTR", direction: "increase" }
population:
  include: "Active users in last 28d"
  exclude: [ "bots", "employees", "age_restricted_countries" ]
randomization:
  unit: "user_id"
  ratio: [0.5, 0.5]
  stratification: ["platform", "recency", "country_top5_other"]
  salt: "salt_2025_03"
interference:
  sutva: true
  design: "individual"
power:
  alpha: 0.05
  power: 0.8
  mde_pp: 0.30
  cuped_R2: 0.30
metrics:
  CVR_user:
    type: "binary_user"
    window: "D0"
    tz: "UTC"
    definition: "unique_converters / unique_exposed_users"
  ARPU_14d:
    type: "continuous"
    transform: "winsor_99_5"
  CTR:
    type: "rate"
    offset: "log(impressions)"
analysis:
  primary_model: "logit + ANCOVA + HC3"
  counts_model: "NB with offset"
  multiple_testing: "BH-FDR 10%"
sequential:
  method: "mSPRT Beta-Binomial"
  alpha: 0.05
  guardrails:
    churn_increase_pp: 0.10
    rule: "reverse mSPRT stop if crossed"
quality:
  srm_threshold_p: 1e-4
  exposure_gap_pp: 0.5
  delay_monitor: true
decision:
  success: "AME >= 0.30pp & guardrail ok"
  rollout: "phase to 100% within 24h"
change_log: []
```

---

## 리포팅 표준 — 문장·표·그림

### **요약 카드(Executive Summary)** — 7줄 규칙

1. **문장 1–2 (효과)**: “B는 CVR을 **+0.34pp**(95% CI +0.18, +0.50) 개선했다.”
2. **문장 3 (효과크기 해석)**: “상대 상승 **+10.9%**, OR=**1.110 [1.060, 1.162]**.”
3. **문장 4 (가드레일)**: “D1 이탈률 변화 **+0.02pp(무의)** — 가드레일 통과.”
4. **문장 5 (품질)**: “SRM 없음(p=0.42), 노출율 차 0.1pp, 지연·봇 정상.”
5. **문장 6 (기간/샘플)**: “N=2.51M 사용자, 2025-03-01~2025-03-12.”
6. **문장 7 (결정)**: “**롤아웃 권고**, 1주 드리프트 모니터링 지속.”

### **핵심 표 (Metrics Table)**

| Metric | Arm A | Arm B | Diff (B−A) | 95% CI | Effect size | Method |
|---|---:|---:|---:|---:|---:|---|
| CVR (pp) | 3.118% | 3.458% | **+0.340** | [+0.180, +0.500] | OR=1.110 | Logit + HC3, AME |
| CTR (IR) | 0.084 | 0.089 | +0.005 | [+0.003, +0.007] | IRR=1.06 | NB (offset=log impr) |
| ARPU (₩) | 267 | 285 | +18 | [+7, +29] | d=0.05 | OLS + winsor + HC3 |
| D1 Churn (pp) | 12.44% | 12.46% | +0.02 | [−0.06, +0.10] | OR=1.002 | Logit + HC3 |

> **표준 주석**
> - **pp**=percentage point, **IR**=rate, **IRR**=Incidence Rate Ratio.
> - HC3/CRVE(사용자 클러스터), NB는 과산포 확인 후 선택.
> - 시간창·TZ·윈저 기준은 메서드 섹션에 재기술.

### **그림 표준**

- **G1**: **추정치 포레스트 플롯** — 각 KPI `Diff ± CI`, 가드레일 빨간선.
- **G2**: **시계열** — 일별 AME 추정 및 mSPRT **\(\log \Lambda\)** 궤적(경계선 표시).
- **G3**: **세그먼트 업리프트 바** — 신규/복귀·플랫폼·국가 분위별 ATE (탐색임을 주석).
- **G4**: **SRM 히트맵** — 세그먼트×팔 기대 vs 관측 비율 카이제곱 p-value.

> **그래픽 규칙**
> - 세로축 단위 명시(%, pp, IR).
> - 범례에 **모형/SE종류**를 표기(“Logit+HC3”, “NB+offset”, “HAC(lag=4)”).
> - 캡션에 **기간/N/설계**(개인/클러스터/스위치백)를 반드시 명시.

### **문장 템플릿**

- **효과**: “변형 B는 **CVR을 +0.34pp**(95% CI +0.18, +0.50) 개선했다. 이는 상대적으로 **+10.9%** 상승이며, 로지스틱 추정의 **OR=1.11 [1.06, 1.16]**에 해당한다.”
- **카운트**: “클릭율은 **IRR=1.06 [1.03, 1.09]**으로 유의하게 증가.”
- **가드레일**: “D1 이탈률 변화는 **+0.02pp [−0.06, +0.10]**로 유의 아님.”
- **품질**: “SRM 미발생(p=0.42), 노출율 차 0.1pp, 봇/지연 정상.”
- **한계**: “국가 C 하위표본이 적어 CI가 넓음(탐색 해석).”
- **결정**: “성공 기준 충족 → **롤아웃 권고**.”

---

## 방법(Method) 섹션 **표준 목차**

1. **설계**: 개인/클러스터/스위치백, 무작위화·층화·재랜덤화 기준, 기간·윈도
2. **지표**: 정의·분모·TZ·변환(윈저/로그)·오프셋
3. **모형**: 로지스틱(OR/AME)·NB(IRR)·ANCOVA(CUPED)·CRVE/HAC/RI
4. **다중성**: 2차·탐색에 BH-FDR 10%
5. **연속 모니터링**: mSPRT(사전, 경계), 그룹 순차 경계
6. **품질**: SRM 테이블, 노출율, 지연·봇, 사건 타임라인

---

## 수식 & 계산 치트시트

### 윌슨 신뢰구간(비율)

성공 x/시도 n, 비율 $$\hat p=\frac{x}{n}$$, 신뢰수준 $$1-\alpha$$, $$z=z_{1-\alpha/2}$$:
$$
\mathrm{CI}_{\text{Wilson}}=
\frac{\hat p + \frac{z^2}{2n} \pm z\sqrt{\frac{\hat p(1-\hat p)}{n}+\frac{z^2}{4n^2}}}{1+\frac{z^2}{n}}.
$$

### 로지스틱 AME

로짓 계수 $$\beta_T$$, 예측확률 $$p_i$$ 일 때
$$
\text{AME}_T=\frac{1}{n}\sum_i p_i(1-p_i)\,\beta_T.
$$

### 포아송/NB IRR CI

회귀계수 $$\hat\beta$$, 표준오차 $$\mathrm{SE}(\hat\beta)$$:
$$
\text{IRR}=\exp(\hat\beta),\quad \mathrm{CI}=\exp\left(\hat\beta \pm z\cdot \mathrm{SE}(\hat\beta)\right).
$$

### 클러스터 설계효과

클러스터 평균 크기 m, ICC ρ:
$$
\text{DE}=1+(m-1)\rho,\quad n_{\text{eff}}=\frac{n}{\text{DE}}.
$$

---

## 코드 스니펫(리포팅 계산 핵심)

### Python — 비율 CI, SRM, 로지스틱/포아송 요약

```python
import numpy as np
from math import sqrt
from scipy.stats import chi2
import statsmodels.api as sm
import statsmodels.formula.api as smf

def wilson_ci(x, n, alpha=0.05):
    z = 1.96 if abs(alpha-0.05)<1e-9 else sm.stats.zconfint(None, alpha=alpha)[1]  # 간단 대체
    phat = x/n
    den = 1 + z**2/n
    center = phat + z**2/(2*n)
    rad = z*sqrt(phat*(1-phat)/n + z**2/(4*n*n))
    return ( (center-rad)/den, (center+rad)/den )

def srm_chi2(counts, expected_props=None):
    counts = np.asarray(counts, float)
    n = counts.sum()
    K = len(counts)
    if expected_props is None:
        expected = np.ones(K)/K * n
    else:
        expected = np.asarray(expected_props)*n
    chi2_stat = ((counts-expected)**2/expected).sum()
    p = 1 - chi2.cdf(chi2_stat, df=K-1)
    return chi2_stat, p

# user-level dataframe df: ['converted','variant','user_id', 'device','new_user','sessions_pre','impr','clicks']

df = df.dropna().copy()
df['sessions_c'] = df['sessions_pre'] - df['sessions_pre'].mean()

# Logit (CRVE: cluster=user_id)

logit = smf.glm('converted ~ C(variant) + C(device) + new_user + sessions_c + C(variant):new_user',
                data=df, family=sm.families.Binomial()).fit(
                cov_type='cluster', cov_kwds={'groups': df['user_id']})
or_variant = np.exp(logit.params['C(variant)[T.B]'])
ci_low, ci_high = np.exp(logit.conf_int().loc['C(variant)[T.B]'])

# AME

marg = logit.get_margeff(at='overall', method='dydx')
ame = float(marg.margeff[ list(marg.params.index).index('C(variant)[T.B]') ])

# Poisson with offset(log impr)

df['log_impr'] = np.log(np.clip(df['impr'], 1, None))
pois = smf.glm('clicks ~ C(variant) + C(device)', data=df,
               family=sm.families.Poisson(), offset=df['log_impr']).fit(cov_type='HC3')
irr = np.exp(pois.params['C(variant)[T.B]'])
irr_ci = np.exp(pois.conf_int().loc['C(variant)[T.B]'])
```

### SQL — KPI 집계(예시)

```sql
-- 사용자 단위 전환
WITH assign AS (
  SELECT DISTINCT user_id, variant
  FROM assignment
  WHERE exp_id = :exp AND assign_ts BETWEEN :start AND :end
),
expo AS (
  SELECT DISTINCT user_id
  FROM exposure
  WHERE exp_id = :exp AND exposed_ts BETWEEN :start AND :end
),
conv AS (
  SELECT DISTINCT user_id
  FROM conversions
  WHERE event_ts BETWEEN :start AND :end
)
SELECT a.variant,
       COUNT(DISTINCT e.user_id) AS users_exposed,
       COUNT(DISTINCT c.user_id) AS users_converted
FROM assign a
JOIN expo e USING(user_id)
LEFT JOIN conv c USING(user_id)
GROUP BY 1;
```

---

## 품질 대시보드 표준

### 레이아웃(한 화면)

- **Q1. SRM 카드**: 전체·스트라텀 p-value, 기대:관측 바/히트맵
- **Q2. 배정↔노출 흐름**: Sankey(배정→노출→지표), 팔별 누락율
- **Q3. 지연 도착**: KPI 이벤트 도착 지연 p50/p95(라인), 당일 vs 과거 비교
- **Q4. 봇/중복**: 봇 비율(규칙/모델), 중복 이벤트율
- **Q5. mSPRT 궤적**: \(\log \Lambda\) vs 일자, 경계선(성공/열세)
- **Q6. 주지표 타임시리즈**: 일별 AME/IRR 추정(오차대), guardrail 함께
- **Q7. 사건 타임라인**: 배포/롤백/DB마이그/알람 — 클릭 시 상세

### 알람 규칙

- **SRM p < 1e-4**: Critical (중단 조사)
- **노출율 차 > 0.5pp**: Warning
- **지연 p95 > 기준×1.5**: Warning
- **봇 > 기준+3σ**: Warning
- **mSPRT 경계 통과**: Success/Fail 알람

### 지표 정의(대시보드용)

- **SRM**: 배정 사용자 카운트 기준(중복 제거)
- **노출율 차**: 팔별 `exposed / assigned`
- **지연**: `event_ts - exposed_ts`의 분포
- **봇**: 헤더/UA/속도 규칙 + 최소 세션 길이 규칙

---

## 사건 타임라인 자동화

### 스키마

- `ts`, `type`(deploy/rollback/schema/incident/param), `title`, `detail`, `owner`, `links[]`
- **예**: “2025-03-05 10:15 — iOS 핫픽스 배포 — 푸시 모듈 재시작”

### 소스

- CI/CD 웹훅, 데이터 파이프라인 알람, 실험 설정 변경 이력, 온콜 티켓

### 리포트 반영

- “**사건/알람 타임라인**” 섹션에 자동 삽입 → 분석 해석시 **외생 요인** 확인

---

## 리포트 본문 **샘플(완성형)**

> **제목**: *저녁 푸시 A/B — CVR 개선 및 가드레일 검증 (2025-03-01~12)*
> **요약**: 변형 B는 CVR을 **+0.34pp**(95% CI +0.18, +0.50) 개선(상대 +10.9%, OR=1.11). D1 이탈률 변화 **+0.02pp**(무의). SRM 없음(p=0.42), 품질 양호. **롤아웃 권고**.

**설계** — 사용자 단위 무작위화(50:50), iOS/Android × 신규/복귀 × 국가 층화. 프리레지에 따른 **mSPRT(α=0.05)** 연속 모니터링.
**지표** — CVR(사용자 0/1), CTR(NB 오프셋 log 노출), ARPU(14d, 윈저 99.5%).
**분석** — 로지스틱+ANCOVA(CUPED), HC3/CRVE. CTR은 NB, ARPU는 OLS+HC3. 세그먼트는 탐색.

**결과** — 표 1·그림 1 참조.
- CVR: **+0.34pp** [ +0.18, +0.50 ], OR=1.11 [1.06, 1.16], AME 기준.
- CTR: IRR=1.06 [1.03, 1.09]. ARPU: +18원 [ +7, +29 ].
- 가드레일: D1 이탈률 +0.02pp [−0.06, +0.10] (무의).
- mSPRT: D+9에서 \(\log \Lambda=3.22\) (경계 \(\log 20=2.996\)) → 성공 신호.

**품질** — SRM 없음(p=0.42), 노출율 차 0.1pp, 지연 p95=3.1h(평시 3.0h±0.5), 봇 0.8% (평시 0.9%±0.4). 사건타임라인: 3/5 iOS 핫픽스(푸시 모듈 재시작) — 영향 없음 확인.

**한계/감도** — 국가 C 소표본으로 CI 넓음. 컵헤드(CUPED) 제외/포함 동일 결론. 스위치백 대안 분석(HAC) 동일 추정치.

**결정** — **롤아웃 권고**(24h 단계적), 1주 가드레일 모니터링.

---

## 흔한 실수와 금지문장

- **금지**: “B가 A보다 유의함(p<0.05).” → **대체**: “B는 **+0.34pp [ +0.18, +0.50 ]** 개선.”
- **금지**: “OR=1.11 ⇒ +11%p 상승” → **수정**: “상대 +10.9%, **+0.34pp**(절대).”
- **금지**: “SRM 무시하고 분석 지속” → **원칙**: **중단 후 원인 규명**.
- **금지**: “세그먼트 결과를 확증 결론처럼 서술” → “탐색 결과, 재실험 필요”로 표기.

---

## 운영 자동화 — 메타→리포트/대시보드

### JSON 메타→리포트 생성

```json
{
  "exp_id": "exp_push_evening_2025Q1_v2",
  "kpi_primary": "CVR_user",
  "alpha": 0.05,
  "power": 0.8,
  "mde_pp": 0.30,
  "sequential": "mSPRT_beta_binom",
  "guardrails": {"d1_churn_pp_max": 0.10},
  "models": {"binary": "logit+HC3", "count": "NB+offset"}
}
```
파이프라인은 위 메타를 읽어 **표/그림/문장 템플릿**을 자동 채운다.

### 배치 작업(예시)

1) 매일 08:30 **지표 집계** → 08:45 **mSPRT 업데이트**
2) 09:00 **품질 대시보드 스냅샷** 저장 + **사건타임라인** 동기화
3) 09:05 **요약 카드** 슬랙 전송(효과·CI·품질·경계여부)

---

## 체크리스트(최종)

**프리레지**
- [ ] 가설·KPI·MDE·가드레일 명시
- [ ] 설계(단위/층화/재랜덤화)·간섭 가정
- [ ] 파워·기간·딜레이 고려
- [ ] 분석(모형/SE/다중성)·정지 규칙(mSPRT/경계)

**리포팅**
- [ ] 요약 7줄 규칙 준수
- [ ] 표 1(핵심 KPI), 그림(포레스트/시계열/mSPRT/세그먼트)
- [ ] OR/IRR/AME + 절대/상대 표기, 단위 명확
- [ ] 품질(SRM/노출/지연/봇)·사건 타임라인

**대시보드**
- [ ] SRM/노출/지연/봇 위젯
- [ ] mSPRT 궤적·경계
- [ ] 알람 임계/채널 동작
- [ ] 스냅샷 보관·재현 링크

---

## 부록 — 공식/예시 더미

### AME를 pp로 변환 예시

기준 확률 \(p_0=0.031\), OR=1.11 → 오즈 \(=p_0/(1-p_0)=0.0320\), ×1.11=0.0355 →
새 확률 \(p_1=\frac{0.0355}{1+0.0355}=0.0343\) ⇒ **∆p ≈ +0.33pp**.

### mSPRT 베타-이항 혼합 우도비

누적 \((x_A,n_A),(x_B,n_B)\), 사전 \(\text{Beta}(\alpha,\beta)\) 일 때
$$
\Lambda^{\text{mix}}=
\frac{\mathrm{B}(\alpha+x_A,\beta+n_A-x_A)\cdot \mathrm{B}(\alpha+x_B,\beta+n_B-x_B)}
{\mathrm{B}(\alpha+x_A+x_B,\ \beta+n_A+n_B-x_A-x_B)}\cdot \frac{\mathrm{B}(\alpha,\beta)}{\mathrm{B}(\alpha,\beta)}.
$$

### HAC(Newey–West) 요지

시계열 잔차 자기상관 \(\gamma_k\)를 고려한 분산추정:
$$
\widehat{\mathrm{Var}}(\hat\beta)=
(X'X)^{-1}\left(\sum_{k=-L}^L w_k \sum_{t} \hat u_t \hat u_{t-k} X_t'X_{t-k}\right)(X'X)^{-1}.
$$

---

## TL;DR

- **프리레지**로 가설·설계·정지 규칙을 고정하고, **후조정**을 막는다.
- **리포팅 표준**(요약7줄·표1·그림·문장 템플릿)으로 **결정 가능한** 결과를 일관되게 제시한다.
- **품질 대시보드**와 **사건 타임라인**을 자동화해 **SRM/노출/지연/봇**과 **운영 변화**를 상시 감시한다.
- 항상 **효과크기+불확실성**, **절대(pp)와 상대(%)**를 함께 보고하고, **SE 종류(HC3/CRVE/HAC/RI)** 를 명시한다.
