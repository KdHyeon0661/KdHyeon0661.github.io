---
layout: post
title: TCPIP - DHCP 메시징
date: 2025-12-02 21:25:23 +0900
category: TCPIP
---
# DHCP 메시징, 메시지 유형 및 형식

## DHCP 메시지 생성, 주소 지정, 전송 및 재전송

DHCP(Dynamic Host Configuration Protocol)는 BOOTP를 확장한 프로토콜로, 동적 IP 주소 할당과 임대 관리 개념을 도입했습니다. DHCP 메시징은 BOOTP와 호환성을 유지하면서도 더 복잡한 상호작용을 지원합니다.

### DHCP 메시지 생성 프로세스

DHCP 클라이언트와 서버 간의 통신은 상태 기반(stateful) 프로토콜로, 여러 단계를 거쳐 완료됩니다.

**DHCP 메시지 생성 흐름:**

```
클라이언트 측:
1. 네트워크 인터페이스 초기화
2. DHCP 클라이언트 소프트웨어 시작
3. DHCPDISCOVER 메시지 생성
   - 클라이언트 하드웨어 주소(MAC) 포함
   - 트랜잭션 ID 생성 (랜덤 32비트 값)
   - 요청 옵션 목록 지정 (옵션 55)

서버 측:
1. DHCPDISCOVER 수신
2. 클라이언트 식별 (MAC 주소 또는 클라이언트 ID)
3. 정책 및 가용성 확인
4. DHCPOFFER 메시지 생성
   - 제안된 IP 주소
   - 임대 시간
   - 서버 식별자
   - 기타 구성 매개변수
```

### 주소 지정과 전송 특성

DHCP는 특수한 주소 지정 방식을 사용합니다. 클라이언트는 초기에는 IP 주소가 없으므로 특별한 주소를 사용해야 합니다.

#### 초기 주소 지정:
```
송신자(클라이언트): 0.0.0.0:68
수신자(서버): 255.255.255.255:67 (브로드캐스트)
또는: 255.255.255.255:67 (제한된 브로드캐스트)
```

#### DHCP 전송 특이사항:
1. **브로드캐스트 사용**: 클라이언트가 자신의 IP를 모르기 때문에
2. **UDP 사용**: 신뢰성은 애플리케이션 계층에서 처리
3. **포트 67/68**: BOOTP와 동일 포트 사용 (호환성)
4. **릴레이 에이전트**: 서브넷 경계 초월 통신 지원

### 재전송 및 타임아웃 메커니즘

DHCP는 네트워크 불안정성을 극복하기 위해 정교한 재전송 전략을 사용합니다.

#### 지수 백오프 알고리즘:
```
초기 타임아웃: 1초 (초기 임대 과정)
이후 타임아웃: 이전 값 × 2 ± 랜덤화
최대 타임아웃: 64초

예시 시퀀스:
시도 1: 0-1초 랜덤 대기 후 전송
시도 2: 0-2초 대기 (실패 시)
시도 3: 0-4초 대기
시도 4: 0-8초 대기
...
최대: 0-64초 대기
```

#### 재전송 시나리오:
```
DHCPDISCOVER:
- 최대 4회 재전송
- 총 대기 시간: 약 60초
- 모두 실패 시: 5분 대기 후 재시도

DHCPREQUEST (갱신):
- T1(50% 지점)에서 시도
- T2(87.5% 지점)에서 브로드캐스트 시도
- 임대 만료 시: DHCPDISCOVER 재시작
```

## DHCP 메시지 형식

DHCP 메시지 형식은 BOOTP와 완벽한 호환성을 유지하며, BOOTP의 300바이트 고정 구조를 그대로 사용합니다. 주요 차이는 옵션 필드의 활용에 있습니다.

### DHCP 메시지 기본 구조

```
DHCP 메시지 구조 (BOOTP와 호환):
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    OP (1)     |   HTYPE (1)   |   HLEN (1)    |   HOPS (1)    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                 트랜잭션 ID (4)                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    초과 시간 (2)              |    플래그 (2)                 |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      클라이언트 IP 주소 (4)                   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      '당신의' IP 주소 (4)                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      서버 IP 주소 (4)                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      게이트웨이 IP 주소 (4)                   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      클라이언트 하드웨어 주소 (16)            |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      서버 호스트 이름 (64)                    |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      부팅 파일 이름 (128)                     |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      옵션 (가변, 최소 312)                    |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### DHCP 전용 필드 상세

#### 플래그 필드 확장
원래 BOOTP의 플래그 필드는 단일 비트만 사용했지만, DHCP는 이를 더 활용합니다:

```
플래그 필드 (16비트):
비트 15: 브로드캐스트 플래그 (1 = 클라이언트 브로드캐스트 응답 요청)
비트 14-0: 예약됨 (0으로 설정)

사용 예시:
클라이언트가 TCP/IP 스택을 완전히 초기화하지 못한 경우
브로드캐스트 플래그를 설정하여 브로드캐스트 응답 요청
```

#### 초과 시간 필드의 새로운 의미
DHCP에서 초과 시간은 더 정교한 의미를 가집니다:

```
초과 시간 사용 패턴:
1. 임대 갱신 과정에서의 경과 시간 추적
2. 여러 DHCP 서버 간의 응답 시간 조정
3. 클라이언트 상태 기계(state machine)의 진행도 표시
```

### DHCP 메시지 유형별 필드 활용

다양한 DHCP 메시지 유형에 따라 필드들이 다르게 사용됩니다:

#### 1. DHCPDISCOVER
```
클라이언트 IP: 0.0.0.0
'당신의' IP: 0.0.0.0
서버 IP: 0.0.0.0
게이트웨이 IP: 릴레이 에이전트 주소 (있는 경우)
옵션: 메시지 유형(53)=1, 매개변수 요청 목록(55)
```

#### 2. DHCPOFFER
```
클라이언트 IP: 0.0.0.0
'당신의' IP: 제안된 IP 주소
서버 IP: 서버 자신의 IP
게이트웨이 IP: 릴레이 에이전트 주소
옵션: 메시지 유형(53)=2, IP 임대 시간(51), 서버 식별자(54)
```

#### 3. DHCPREQUEST
```
클라이언트 IP: 0.0.0.0 (초기) 또는 현재 IP (갱신)
'당신의' IP: 0.0.0.0
서버 IP: 선택한 서버의 IP (서버 식별자 옵션과 일치)
옵션: 메시지 유형(53)=3, 요청된 IP 주소(50), 서버 식별자(54)
```

#### 4. DHCPACK
```
클라이언트 IP: 서버가 할당한 IP
'당신의' IP: 할당된 IP
서버 IP: 서버 자신의 IP
옵션: 메시지 유형(53)=5, IP 임대 시간(51), 모든 구성 매개변수
```

## DHCP 옵션, 옵션 형식 및 "옵션 오버로딩"

### DHCP 옵션 구조

DHCP 옵션은 TLV(Type-Length-Value) 형식을 사용하여 유연한 확장성을 제공합니다.

#### 기본 옵션 형식
```
표준 옵션:
+--------+--------+--------+--------+
|  코드  |  길이  |   값 (길이 바이트) |
+--------+--------+--------+--------+

특수 옵션:
패딩 옵션:    코드 0 (길이 없음)
옵션 끝:      코드 255 (길이 없음)
```

#### 옵션 코드 공간
```
1-127:    표준 옵션 (IETF 정의)
128-254:  사이트별 옵션 (로컬 사용)
255:      옵션 끝 마커
```

### 주요 DHCP 옵션 카테고리

#### 1. 기본 구성 옵션
```
옵션 1:   서브넷 마스크
옵션 3:   라우터(기본 게이트웨이) 목록
옵션 6:   DNS 서버 목록
옵션 15:  도메인 이름
옵션 44:  NetBIOS over TCP/IP 이름 서버
옵션 46:  NetBIOS over TCP/IP 노드 유형
```

#### 2. DHCP 프로토콜 옵션
```
옵션 50:  요청된 IP 주소 (클라이언트가 선호하는 IP)
옵션 51:  IP 주소 임대 시간
옵션 53:  DHCP 메시지 유형 (가장 중요)
옵션 54:  서버 식별자
옵션 55:  매개변수 요청 목록 (클라이언트가 요청하는 옵션들)
옵션 56:  오류 메시지
옵션 57:  최대 DHCP 메시지 크기
```

#### 3. 확장 구성 옵션
```
옵션 42:  NTP 서버 목록
옵션 43:  벤더 특정 정보
옵션 60:  벤더 클래스 식별자
옵션 66:  TFTP 서버 이름
옵션 67:  부팅 파일 이름
옵션 82:  릴레이 에이전트 정보 (중계 에이전트 정보)
옵션 119: 도메인 검색 목록
```

### 옵션 53: DHCP 메시지 유형

이 옵션은 모든 DHCP 메시지에 필수적으로 포함되며, 메시지의 목적을 정의합니다.

```
값   메시지 유형        설명
1    DHCPDISCOVER     클라이언트 → 서버: 서버 탐색
2    DHCPOFFER        서버 → 클라이언트: IP 주소 제안
3    DHCPREQUEST      클라이언트 → 서버: IP 주소 요청/갱신
4    DHCPDECLINE      클라이언트 → 서버: IP 주소 거부 (충돌 감지)
5    DHCPACK          서버 → 클라이언트: IP 주소 확인
6    DHCPNAK          서버 → 클라이언트: IP 주소 거부
7    DHCPRELEASE      클라이언트 → 서버: IP 주소 반납
8    DHCPINFORM       클라이언트 → 서버: 정보만 요청 (이미 IP 있음)
9    DHCPFORCERENEW   서버 → 클라이언트: 강제 갱신 요청
10   DHCPLEASEQUERY   클라이언트 → 서버: 임대 정보 질의
11   DHCPLEASEUNASSIGNED 서버 → 클라이언트: 임대 없음 응답
12   DHCPLEASEUNKNOWN 서버 → 클라이언트: 임대 알 수 없음
13   DHCPLEASEACTIVE  서버 → 클라이언트: 임대 활성 상태
```

### 옵션 오버로딩

DHCP 메시지의 고정 영역(부팅 파일 이름과 서버 호스트 이름)을 옵션 저장 공간으로 재사용하는 기술입니다.

#### 오버로딩 메커니즘
```
옵션 오버로딩 옵션 (코드 52):
값 1: '파일' 필드를 옵션 저장소로 사용
값 2: 'sname' 필드를 옵션 저장소로 사용
값 3: 둘 다 사용

사용법:
1. 옵션 52를 통해 오버로딩 선언
2. 해당 필드를 표준 옵션 형식으로 재해석
3. 옵션 끝(255)으로 종료 표시
```

#### 오버로딩 사용 예시
```
상황: 많은 옵션을 포함해야 하지만 312바이트 옵션 공간 부족
해결: 
1. 옵션 52 = 1 (파일 필드 오버로딩)
2. 파일 필드(128바이트)를 추가 옵션 공간으로 사용
3. 첫 옵션 공간이 꽉 차면 파일 필드로 확장
```

### 옵션 형식의 다양성

옵션 값은 다양한 데이터 형식을 지원합니다:

#### 1. 단일 값 옵션
```
옵션 51 (IP 주소 임대 시간):
코드: 51
길이: 4
값: 0x00015180 (86400초 = 24시간)
```

#### 2. 목록 옵션
```
옵션 6 (DNS 서버):
코드: 6
길이: 8 (2개의 IP 주소)
값: [8.8.8.8][8.8.4.4]
```

#### 3. 문자열 옵션
```
옵션 15 (도메인 이름):
코드: 15
길이: 11
값: "example.com" (널 종료 없음)
```

#### 4. 구조화된 옵션
```
옵션 82 (릴레이 에이전트 정보):
서브옵션 1: 에이전트 서킷 ID
서브옵션 2: 에이전트 원격 ID
서브옵션 5: 라우팅 도메인
각 서브옵션은 자신의 TLV 구조를 가짐
```

## DHCP 옵션 / BOOTP 벤더 정보 필드 요약

### 표준 옵션 참조표

| 코드 | 이름 | 길이 | 설명 |
|------|------|------|------|
| 0 | 패딩 | 0 | 옵션 정렬을 위한 패딩 |
| 1 | 서브넷 마스크 | 4 | 클라이언트 서브넷 마스크 |
| 3 | 라우터 | 가변 | 기본 게이트웨이 목록 |
| 6 | DNS 서버 | 가변 | DNS 서버 IP 목록 |
| 12 | 호스트 이름 | 가변 | 클라이언트 호스트 이름 |
| 15 | 도메인 이름 | 가변 | DNS 도메인 이름 |
| 28 | 브로드캐스트 주소 | 4 | 브로드캐스트 주소 |
| 42 | NTP 서버 | 가변 | NTP 서버 목록 |
| 50 | 요청된 IP 주소 | 4 | 클라이언트가 요청하는 IP |
| 51 | IP 주소 임대 시간 | 4 | 임대 유효 기간(초) |
| 53 | DHCP 메시지 유형 | 1 | 메시지 유형 식별 |
| 54 | 서버 식별자 | 4 | DHCP 서버 IP 주소 |
| 55 | 매개변수 요청 목록 | 가변 | 클라이언트가 요청하는 옵션들 |
| 57 | 최대 메시지 크기 | 2 | 클라이언트가 처리할 수 있는 최대 크기 |
| 58 | 갱신 시간 | 4 | T1 시간(초) |
| 59 | 재결정 시간 | 4 | T2 시간(초) |
| 60 | 벤더 클래스 식별자 | 가변 | 벤더/장치 클래스 식별 |
| 61 | 클라이언트 식별자 | 가변 | 클라이언트 고유 식별자 |
| 66 | TFTP 서버 이름 | 가변 | TFTP 서버 이름 |
| 67 | 부팅 파일 이름 | 가변 | 부팅 파일 경로 |
| 82 | 릴레이 에이전트 정보 | 가변 | 중계 에이전트 정보 |
| 119 | 도메인 검색 목록 | 가변 | DNS 검색 도메인 목록 |
| 121 | 클래스리스 정적 경로 | 가변 | 클래스리스 정적 경로 |
| 150 | TFTP 서버 주소 | 가변 | TFTP 서버 IP 주소 |
| 255 | 끝 | 0 | 옵션 목록 종료 |

### BOOTP 벤더 정보 필드와의 호환성

DHCP는 BOOTP의 벤더 정보 필드를 완전히 호환되는 방식으로 확장했습니다.

#### 호환성 메커니즘:
```
BOOTP 메시지: 64바이트 벤더 특정 영역
DHCP 메시지: 64바이트 + 추가 312바이트 옵션 공간

호환성 유지:
1. DHCP 메시지는 BOOTP 메시지 형식 준수
2. BOOTP 서버는 DHCP 옵션을 무시하고 처리
3. DHCP 클라이언트는 BOOTP 응답도 처리 가능
4. 마법 쿠키(99.130.83.99)로 DHCP 옵션 식별
```

#### BOOTP 확장 필드 매핑:
```
BOOTP 필드           DHCP 옵션
서브넷 마스크        옵션 1
게이트웨이           옵션 3
시간 서버           옵션 4
IEN-116 서버        옵션 5
DNS 서버            옵션 6
```

### 현대 네트워크의 DHCP 옵션 활용

#### 클라우드 및 가상화 환경
```
옵션 43: 벤더 특정 정보 (가상화 플랫폼 설정)
옵션 60: 벤더 클래스 (VMware, Hyper-V, KVM 등 식별)
옵션 125: 벤더 식별 결합 옵션
옵션 77: 사용자 클래스 (테넌트 또는 역할 식별)
```

#### IPv6 전환 지원
```
옵션 108: IPv6만 의무화 타임아웃
옵션 94: 클라이언트 시스템 아키텍처
옵션 93: 클라이언트 네트워크 인터페이스 식별자
```

#### 보안 강화 옵션
```
옵션 90: 인증 옵션
옵션 91: 클라이언트 마지막 트랜잭션 시간
옵션 92: 관련된 IP 주소
옵션 116: 자동 구성 설정
```

#### 네트워크 진단 및 모니터링
```
옵션 93: 클라이언트 시스템
옵션 94: 클라이언트 NDI
옵션 97: UUID/GUID 기반 클라이언트 ID
옵션 125: 벤더 식별 정보
```

### DHCP 옵션 처리 알고리즘

서버와 클라이언트는 정교한 옵션 처리 로직을 구현합니다:

#### 서버 옵션 처리:
```
1. 글로벌 옵션 로드 (기본값)
2. 서브넷별 옵션 적용 (서브넷 범위)
3. 범위별 옵션 적용 (IP 범위)
4. 클라이언트별 옵션 적용 (예약)
5. 클래스별 옵션 적용 (사용자/벤더 클래스)
6. 충돌 해결: 구체적인 설정이 일반적 설정을 덮어씀
```

#### 클라이언트 옵션 처리:
```
1. 필수 옵션 확인 (서브넷 마스크, 라우터 등)
2. 요청한 옵션과 수신한 옵션 비교
3. 옵션 값 검증 (예: DNS 서버 유효성)
4. 옵션 적용 순서 결정 (종속성 고려)
5. 구성 적용 및 상태 보고
```

## 결론

DHCP 메시징 시스템은 단순함과 복잡성 사이에서 놀라운 균형을 이루고 있습니다. BOOTP의 300바이트 고정 구조를 유지하면서도, TLV 기반 옵션 메커니즘을 통해 사실상 무제한의 확장성을 제공합니다. 이 설계 선택은 하위 호환성을 보장하는 동시에 30년이 넘는 시간 동안 진화할 수 있는 기반을 마련했습니다.

DHCP 옵션 시스템의 진정한 힘은 그 계층적이고 정책 기반의 적용 모델에 있습니다. 글로벌, 서브넷, 범위, 클라이언트, 클래스별 옵션의 다단계 적용은 현대 네트워크의 복잡한 요구사항을 정교하게 충족시킵니다. 옵션 오버로딩 같은 기술적 해결책은 제한된 프로토콜 공간 안에서의 실용적 창의력을 보여줍니다.

DHCP의 메시지 형식과 옵션 시스템은 단순한 IP 주소 할당을 넘어, 네트워크 정책 전달, 장치 관리, 서비스 발견의 포괄적 플랫폼으로 발전했습니다. 옵션 82(릴레이 에이전트 정보)는 네트워크 토폴로지 인식 구성을 가능하게 하며, 다양한 벤더 확장 옵션들은 클라우드, 가상화, IoT와 같은 현대 기술 환경에의 적응을 지원합니다.

그러나 이 풍부한 기능성은 관리의 복잡성을 동반합니다. 250개가 넘는 옵션 코드들, 다양한 데이터 형식, 계층적 적용 규칙들은 올바른 DHCP 구성과 트러블슈팅을 어렵게 만듭니다. 옵션 53(DHCP 메시지 유형)의 단순함과 옵션 125(벤더 식별 결합 옵션)의 복잡함 사이의 대비는 프로토콜의 광범위한 적용 범위를 잘 보여줍니다.

미래의 DHCP는 계속해서 진화할 것입니다. IPv6의 DHCPv6은 별도의 프로토콜로 발전했지만, IPv4 DHCP의 설계 철학과 교훈은 계속 반영되고 있습니다. 자동화, 보안, 가시성의 요구는 새로운 옵션과 메커니즘을 낳을 것이며, IoT와 5G 시대의 대규모 장치 관리는 DHCP 시스템에 새로운 도전을 제시할 것입니다.

네트워크 엔지니어에게 DHCP 옵션 시스템의 깊은 이해는 이제 필수 역량입니다. 이는 단순한 구성 작업을 넘어, 네트워크 정책 구현, 보안 강화, 서비스 품질 보장의 핵심 도구입니다. DHCP의 메시지 형식은 단순한 데이터 구조가 아니라, 네트워크의 지능과 정책을 전달하는 언어로서 계속해서 그 중요성을 유지할 것입니다.