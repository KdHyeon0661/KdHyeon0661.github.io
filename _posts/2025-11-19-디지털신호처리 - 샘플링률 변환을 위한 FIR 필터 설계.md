---
layout: post
title: 디지털신호처리 - 샘플링률 변환을 위한 FIR 필터 설계
date: 2025-11-19 19:25:23 +0900
category: 디지털신호처리
---
# 샘플링률 변환을 위한 FIR 필터 설계 — 데시메이션/보간/유리수 변환까지 한 번에, GNU Octave 실습

> 목표
> - 샘플링률 변환(multi-rate processing)에서 **반드시 필요한 FIR 저역통과 필터**를
>   **왜/어떻게/어떤 사양으로/어떤 구조로 설계하는지**를
>   개념 → 수식 → 설계 공식 → 구조 최적화 → 실전 예제(Octave) 순으로 **생략 없이** 정리한다.
> - 대상 변환: **D배 데시메이션(↓D)**, **I배 보간(↑I)**, **유리수 I/D 변환**
> - 모든 코드는 **GNU Octave**에서 바로 실행 가능하게 쓴다.
> - 참고링크/각주/외부 인용은 넣지 않는다.

---

## 샘플링률 변환에서 “필터 설계”가 본질인 이유

샘플링률 변환은 겉보기에는
- 샘플을 버리거나(↓D)
- 0을 끼우거나(↑I)
- 그 둘을 조합하는(↑I → LPF → ↓D)
단순한 재배열로 보인다.

하지만 **주파수 영역**에서 보면 이 재배열은 반드시
- 스펙트럼의 반복/접힘을 만들고
- 그 결과로 **정보 손실/왜곡**이 생길 수 있다.

따라서 샘플링률 변환의 핵심은 항상 다음 3단계다.

```text
(1) 스펙트럼이 깨지지 않도록
(2) 필요한 대역만 남기고
(3) 버리거나 끼운다
```

즉,

```text
샘플링률 변환 = (Rate change) + (FIR LPF)
```

여기서 FIR LPF 설계가 실패하면
변환 전체가 실패한다.

---

## 복습: DTFT 관점에서 보간/데시메이션이 만드는 문제

### D배 데시메이션(↓D)의 스펙트럼 접힘(aliasing)

다운샘플링:

$$
y[n]=x[nD]
$$

DTFT 관계:

$$
Y(e^{j\omega})=\frac{1}{D}\sum_{k=0}^{D-1}
X\!\left(e^{j(\omega+2\pi k)/D}\right)
$$

의미:

- 원래 스펙트럼이 **D배 압축**되며
- 동시에 **D개의 복제본이 겹쳐서 합쳐짐**
- 겹치는 대역이 있으면 aliasing 발생

**따라서 다운샘플 전에 반드시 저역통과 필터로 대역을 제한해야 한다.**

---

### I배 보간(↑I)의 이미지(imaging)

업샘플링(0 삽입):

$$
v[n]=
\begin{cases}
x[n/I], & n=mI \\
0,&\text{else}
\end{cases}
$$

DTFT:

$$
V(e^{j\omega})=X(e^{j\omega I})
$$

의미:

- 스펙트럼이 I배 **확장**되면서
- **기존 베이스밴드가 I개의 이미지로 반복**됨

**따라서 0삽입 뒤에는 이미지를 제거하는 FIR LPF가 필요하다.**

---

### 유리수 I/D 변환의 “동시 문제”

표준 구조:

```text
x[n] ──▶ (↑I) ──▶ H(z) ──▶ (↓D) ──▶ y[n]
```

H(z) 하나가
- 보간 이미지 제거(anti-imaging)
- 데시메이션 접힘 방지(anti-aliasing)
둘 다 만족해야 한다.

즉 샘플링률 변환 FIR 설계는
**“한 필터로 두 문제를 동시에 해결”**하는 설계다.

---

## 샘플링률 변환 FIR의 필수 컷오프 조건

변환비가 (↑I, ↓D)일 때
H(z)가 통과시켜야 할 최대 대역은:

1) 보간 직후 baseband:

$$
|\omega| \le \frac{\pi}{I}
$$

2) 데시메이션 직전 aliasing 방지:

$$
|\omega| \le \frac{\pi}{D}
$$

따라서 FIR LPF의 컷오프는

$$
\omega_c \le \min\!\left(\frac{\pi}{I},\frac{\pi}{D}\right)
$$

원래 샘플링률 기준의 **정규화 주파수**(Nyquist=1)로 쓰면

$$
W_c \le \min\!\left(\frac{1}{I},\frac{1}{D}\right)
$$

이 식이 **샘플링률 변환 필터 설계의 1번 원칙**이다.

---

## FIR 설계 사양을 잡는 “실전 절차”

샘플링률 변환의 FIR은 **항상 저역통과(LPF)**다.
따라서 사양은 다음 4개로 결정된다.

| 항목 | 기호 | 의미 |
|---|---|---|
| 통과대역 끝 | \(W_p\) | 신호가 보존되어야 하는 최대 대역 |
| 저지대역 시작 | \(W_s\) | 이미지/접힘이 반드시 억제돼야 하는 대역 시작 |
| 통과대역 리플 | \(\delta_p\) | passband 허용 진폭 오차 |
| 저지대역 감쇠 | \(\delta_s\) | stopband 허용 누설(감쇠) |

### 통과/저지 대역 경계 선택

가장 먼저 안전한 컷오프 후보

$$
W_c^{\max} = \min(1/I,1/D)
$$

를 계산한다.

그 다음 실무적 여유를 두고:

- 통과대역:
  $$
  W_p = \alpha\, W_c^{\max}\quad (0.8\sim0.95)
  $$

- 저지대역:
  $$
  W_s = W_c^{\max}
  $$

처럼 잡는 것이 일반적이다.
(전이대역 폭은 $$\Delta W = W_s-W_p$$)

### 리플/감쇠 수준

멀티레이트에서 stopband는 매우 중요하다.

- 영상/방송/오디오 표준 변환:
  - \(\delta_p\) ≈ 0.01 dB 이하
  - \(\delta_s\) ≈ 80~100 dB 이상
- 통신 수신단:
  - \(\delta_s\)가 더 중요(alias 누설이 BER로 직결)

**stopband 감쇠 목표가 높을수록 필터 차수는 증가한다.**

---

## FIR 차수(길이) 추정 공식

### Kaiser window 기반 근사

Kaiser 윈도우 FIR에서
stopband 감쇠 \(A=-20\log_{10}\delta_s\) (dB),
전이대역 폭 \(\Delta W\) (정규화 Nyquist=1)라면

$$
M \approx \frac{A-8}{2.285\, (2\pi \Delta W)}
$$

여기서 M은 필터 차수(탭 수-1).
Octave의 `kaiserord`가 이 추정을 자동으로 한다.

### Parks–McClellan(최적 등리플) 기반 경향

최적 등리플 FIR(remez)은
같은 \(\delta_s\), \(\Delta W\)에서
대체로 window 방법보다 **더 짧은 M**을 준다.

즉,

- **간단/안정/빠른 설계**: window(kaiser, blackman, …)
- **최단 길이/최고 효율**: equiripple(remez)

샘플링률 변환에서 흔히

- 1단 소규모 변환: remez
- 다단/폴리페이즈 뱅크: kaiser
- 반대칭/하프밴드 구조: 구조적 설계

를 많이 쓴다.

---

## 구조적 최적화: Polyphase 필터를 고려한 설계

샘플링률 변환 필터는 대부분 **폴리페이즈로 구현**된다.
따라서 설계할 때부터
- 위상별 길이
- I개의 위상 수
- 다단 분해
를 의식해야 한다.

### 폴리페이즈 분해

I배 보간을 포함하면 h[n]을 I개의 위상으로 분해:

$$
h[n] = \sum_{m=0}^{I-1} e_m[nI-m]
$$

이때 한 위상 길이는 대략

$$
L_{phase} \approx \left\lceil \frac{M+1}{I} \right\rceil
$$

즉, I가 클수록
한 위상당 곱셈량이 줄어들지만
위상 수가 많아진다.

### gcd 축약

유리수 변환에서는

$$
g=\gcd(I,D),\quad I'=I/g,\ D'=D/g
$$

로 축약한 I',D'로 설계해야
폴리페이즈 뱅크 크기가 줄어든다.

---

## 특수 저역통과 FIR: Half-band 필터

### 언제 쓰나?

**2배 보간/2배 데시메이션**은 매우 흔하다.
이때 컷오프는 근본적으로 Nyquist의 절반 근처.

그 결과

- 통과대역과 저지대역이 대칭
- 필터 계수도 구조적 대칭

이므로 **Half-band FIR**라는 특수 구조를 쓸 수 있다.

### 특징

- 선형 위상 FIR
- odd length
- **거의 모든 짝수 인덱스 계수가 0** (중앙 제외)

즉 곱셈기 수가 절반 이하로 감소.

### Half-band 설계(Octave)

```octave
pkg load signal; clear; close all; clc;

M  = 63;                   % odd order
Wp = 0.45;                 % passband edge (Nyquist=1)
h  = fir1(M, Wp, "low", hamming(M+1));
% halfband 조건에 맞게 강제로 짝수 계수를 0으로 만들 수도 있음(교육용)

[H,w] = freqz(h,1,4096);
figure; plot(w/pi, 20*log10(abs(H)+eps)); grid on;
title("Half-band-like LPF magnitude");
xlabel("Normalized freq (×π)"); ylabel("dB");
```

Half-band는
2단/3단 변환에서 자주 등장한다.

---

## 다단(multistage) 샘플링률 변환을 위한 FIR 설계

### 왜 다단?

I 또는 D가 큰 경우
단일 FIR은 차수가 너무 커진다.

예: 160/147 변환을 한 번에 하면
- I=160 위상
- 매우 긴 FIR 필요

따라서 비율을 소인수로 분해하여
여러 단으로 나누면 총 연산량이 감소한다.

### 다단 설계 규칙

1) 비율 분해:

$$
\frac{I}{D} = \frac{I_1}{D_1} \cdot \frac{I_2}{D_2}\cdots
$$

2) 각 단에서의 최대 컷오프는
그 단의 I_k, D_k 기준으로 다시 계산

$$
W_{c,k}^{\max}=\min(1/I_k,1/D_k)
$$

3) 단계별로 필요한 stopband 감쇠를 분산
(첫 단계에서 큰 감쇠, 뒤 단계에서 작게 하거나 반대로)

---

## 실습 A: D배 데시메이션용 FIR 설계

### 상황

- 원 샘플링률: Fs = 48 kHz
- 4배 데시메이션: D=4 → Fs' = 12 kHz
- 원 신호 유효 대역: 0~4 kHz
- 목표 stopband 감쇠: 80 dB

### 사양 산정

데시메이션 필터 컷오프 최대:

$$
W_c^{\max} = 1/D = 0.25
$$

원 신호 유효 대역이 4 kHz이므로
Nyquist(24 kHz) 기준 정규화:

$$
W_p = \frac{4}{24} \approx 0.1667
$$

안전하게

$$
W_p = 0.17,\quad W_s = 0.25
$$

전이대역:

$$
\Delta W = 0.08
$$

---

### Kaiser 설계(Octave)

```octave
pkg load signal; clear; close all; clc;

Fs = 48000; D = 4;

Wp = 0.17;       % passband edge (Nyquist=1)
Ws = 0.25;       % stopband start
Rp = 0.01;       % passband ripple (linear)
As = 80;         % stopband attenuation (dB)

% kaiser order estimate
[M, Wn, beta, ftype] = kaiserord([Wp Ws], [1 0], [Rp 10^(-As/20)]);
M = M + rem(M,2);               % make even order for linear phase
h = fir1(M, Wn, kaiser(M+1,beta));

fprintf("Order M = %d taps=%d\n", M, M+1);

[H,w] = freqz(h,1,8192);
figure;
plot(w/pi, 20*log10(abs(H)+eps)); grid on;
title("Anti-alias LPF for decimation D=4");
xlabel("Normalized freq (×π)"); ylabel("dB");

% test signal: 2k, 6k, 10k
t = 0:1/Fs:0.05-1/Fs;
x = sin(2*pi*2000*t) + 0.6*sin(2*pi*6000*t) + 0.4*sin(2*pi*10000*t);

% filter then decimate
u = filter(h,1,x);
y = u(1:D:end);

Fs2 = Fs/D;
Nfft = 4096;
X = fft(x.*hann(length(x))'); X = X(1:Nfft);
Y = fft(y.*hann(length(y))'); Y = Y(1:Nfft);
fX = (0:Nfft-1)*Fs/Nfft;
fY = (0:Nfft-1)*Fs2/Nfft;

figure;
plot(fX, 20*log10(abs(X)+eps)); hold on;
plot(fY, 20*log10(abs(Y)+eps));
grid on; xlim([0 Fs2/2]);
legend("Original", "After decimation");
title("Spectrum check: aliasing suppressed");
```

### 해석

- 6 kHz, 10 kHz 성분은 데시메이션 전 필터에 의해 충분히 억제
- (↓4) 후에도 baseband(2 kHz)만 살아남음
- alias 스퓨리어스가 보이면 As 또는 ΔW를 늘려야 한다.

---

## 실습 B: I배 보간용 FIR 설계

### 상황

- Fs = 12 kHz
- 3배 보간: I=3 → Fs' = 36 kHz
- 원 신호 유효 대역: 0~4 kHz
- stopband 감쇠: 70 dB

### 사양 산정

보간 이미지 제거 컷오프 최대:

$$
W_c^{\max} = 1/I = 0.3333
$$

원 유효 대역 4 kHz, Nyquist=6 kHz → 정규화:

$$
W_p = 4/6 = 0.6667
$$

하지만 보간 후 기준은 “원 Fs의 Nyquist=1”이므로
**보간 필터는 원래 스케일에서 계산해야 한다.**

즉 보간 후 새로운 Nyquist는 18 kHz이지만
H(z)는 **원 Fs=12 kHz 기준의 디지털 필터**로 설계한다.

원 유효대역 4 kHz가 유지되어야 하므로

$$
W_p = \frac{4}{6} \approx 0.6667
$$

이 값은 1/I보다 크다.
따라서 보간 필터는 cutoff 조건이 지배한다.

결국

$$
W_p \le 1/I = 0.3333
$$

로 “재정규화”해야 한다.

즉 보간 필터 통과대역은
**원 스펙트럼을 1/I로 압축한 영역만 유지**하면 된다.

그래서

$$
W_p = 0.30,\quad W_s=0.3333
$$

쯤이 일반적이다.

---

### Kaiser 설계 + 보간(Octave)

```octave
pkg load signal; clear; close all; clc;

Fs = 12000; I = 3;

Wp = 0.30;
Ws = 1/I;          % 0.3333
Rp = 0.01;
As = 70;

[M,Wn,beta,ftype] = kaiserord([Wp Ws],[1 0],[Rp 10^(-As/20)]);
M = M + rem(M,2);
h = fir1(M, Wn, kaiser(M+1,beta));

fprintf("Order M = %d\n", M);

% test signal
t = 0:1/Fs:0.05-1/Fs;
x = sin(2*pi*1000*t) + 0.5*sin(2*pi*3500*t);

% upsample by I (zero insertion)
v = zeros(1, length(x)*I);
v(1:I:end) = x;

% filter
u = filter(h,1,v);

% gain compensation by I
y = I*u;

Fs2 = Fs*I;

% spectrum
Nfft=8192;
X=fft(x.*hann(length(x))'); X=X(1:Nfft);
Y=fft(y.*hann(length(y))'); Y=Y(1:Nfft);
fX=(0:Nfft-1)*Fs/Nfft;
fY=(0:Nfft-1)*Fs2/Nfft;

figure;
plot(fX,20*log10(abs(X)+eps)); hold on;
plot(fY,20*log10(abs(Y)+eps));
grid on; xlim([0 Fs/2]);
legend("Original", "Interpolated");
title("Spectrum check: images removed");
```

### 해석

- (↑3) 직후 이미지가 생기지만
- FIR LPF가 이를 제거
- I 이득 보상까지 하면 레벨 보존

실전에서는 이 FIR을 3-polyphase로 분해하여
0삽입 자체를 생략한다.

---

## 실습 C: 유리수 I/D 변환 FIR 설계 (예: 160/147)

### 상황

- 44.1 kHz → 48 kHz
- I/D = 160/147
- 원 유효 대역: 0~20 kHz(오디오)
- 목표 stopband 감쇠: 90 dB
- passband ripple: 0.01 dB

### 사양 산정

최대 컷오프:

$$
W_c^{\max}=\min(1/160,1/147)=1/160=0.00625
$$

이는 **원 Nyquist 기준**(=1) 매우 좁다.
따라서 단일 단계 FIR은 아주 길어질 수밖에 없다.

실무는 다단을 쓰지만,
여기서는 1단 설계의 원리를 보여준다.

전이대역 여유:

$$
W_p = 0.9 W_c^{\max} \approx 0.005625,\quad
W_s=W_c^{\max}=0.00625
$$

---

### Kaiser 단일단 설계 + resample(Octave)

```octave
pkg load signal; clear; close all; clc;

Fs  = 44100;
I   = 160;
D   = 147;

g = gcd(I,D); I=I/g; D=D/g;     % reduce if possible

Wcmax = min(1/I, 1/D);
Wp = 0.9*Wcmax;
Ws = Wcmax;

Rp = 10^(-0.01/20)-1;    % 0.01 dB approx
As = 90;

[M,Wn,beta,ftype] = kaiserord([Wp Ws],[1 0],[Rp 10^(-As/20)]);
M = M + rem(M,2);
h = fir1(M, Wn, kaiser(M+1,beta));

fprintf("Single-stage order M=%d taps=%d\n", M, M+1);

% test signal
t = 0:1/Fs:1-1/Fs;
x = 0.8*sin(2*pi*1000*t) + 0.4*sin(2*pi*15000*t);

% rational SRC using designed h in polyphase via resample()
y = resample(x, I, D, h);   % use custom FIR

Fs2 = Fs*I/D;

% spectrum check
Nfft=16384;
X=fft(x.*hann(length(x))'); X=X(1:Nfft);
Y=fft(y.*hann(length(y))'); Y=Y(1:Nfft);

fX=(0:Nfft-1)*Fs/Nfft;
fY=(0:Nfft-1)*Fs2/Nfft;

figure;
plot(fX,20*log10(abs(X)+eps)); hold on;
plot(fY,20*log10(abs(Y)+eps));
grid on; xlim([0 Fs2/2]);
legend("Original 44.1k","Resampled 48k");
title("Rational SRC with custom FIR");
```

### 해석

- 컷오프가 극단적으로 좁아 차수가 크게 나옴
- 이 때문에 실전은 다단 설계로 분해해 총 비용을 줄인다.

---

## 다단 유리수 FIR 설계 예(160/147을 2단으로)

### 분해 예

한 가지 분해:

$$
\frac{160}{147} = \frac{5}{3}\cdot\frac{32}{49}
$$

- 1단: ↑5, ↓3
- 2단: ↑32, ↓49 (여기서도 2×2×2×2×2 / 7×7)

이렇게 하면
각 단계의 컷오프가 덜 극단적이 되어
단계별 FIR이 더 짧아질 수 있다.

### 단계별 컷오프

1단:

$$
W_{c,1}^{\max}=\min(1/5,1/3)=1/5=0.2
$$

2단:

$$
W_{c,2}^{\max}=\min(1/32,1/49)=1/49\approx 0.0204
$$

단일단의 0.00625보다 훨씬 완화된다.

### Octave 스케치

```octave
pkg load signal; clear; close all; clc;

Fs = 44100;

% stage 1: 5/3
I1=5; D1=3; Wc1=min(1/I1,1/D1);
Wp1=0.9*Wc1; Ws1=Wc1; As1=80; Rp1=0.001;
[M1,Wn1,b1,ft1] = kaiserord([Wp1 Ws1],[1 0],[Rp1 10^(-As1/20)]);
M1=M1+rem(M1,2); h1=fir1(M1,Wn1,kaiser(M1+1,b1));

% stage 2: 32/49
I2=32; D2=49; Wc2=min(1/I2,1/D2);
Wp2=0.9*Wc2; Ws2=Wc2; As2=90; Rp2=0.001;
[M2,Wn2,b2,ft2] = kaiserord([Wp2 Ws2],[1 0],[Rp2 10^(-As2/20)]);
M2=M2+rem(M2,2); h2=fir1(M2,Wn2,kaiser(M2+1,b2));

fprintf("Stage1 taps=%d, Stage2 taps=%d\n", M1+1, M2+1);

% test
t=0:1/Fs:1-1/Fs;
x=0.8*sin(2*pi*1000*t)+0.4*sin(2*pi*15000*t);

% stage 1 SRC
y1 = resample(x, I1, D1, h1);
Fs1 = Fs*I1/D1;

% stage 2 SRC
y2 = resample(y1, I2, D2, h2);
Fs2 = Fs1*I2/D2;

fprintf("Fs2=%.2f Hz\n", Fs2);
```

다단은 설계의 자유도가 커서
각 단계의 As, Rp, ΔW를 조절하여
최적 비용점을 찾는다.

---

## 샘플링률 변환 FIR 설계의 정리된 체크리스트

1. **변환비 결정**
   - 정수배: I 또는 D
   - 유리수: I/D, gcd로 축약

2. **최대 컷오프 계산**
   $$
   W_c^{\max}=\min(1/I,1/D)
   $$

3. **통과대역 요구로 Wp 결정**
   - 신호 유효대역이 더 좁으면 그게 Wp를 지배
   - 아니면 0.8~0.95 Wcmax

4. **저지대역 Ws 설정**
   - 보통 Ws = Wcmax

5. **리플/감쇠 결정**
   - alias/이미지 누설 요구에 맞춰 As 결정

6. **차수 추정**
   - kaiserord / remez 추정으로 탭 수 확보

7. **FIR 설계**
   - Kaiser window or equiripple
   - 선형 위상 유지 권장

8. **폴리페이즈/다단 구현 고려**
   - I 위상 분해
   - 다단 분해 가능성 탐색
   - half-band, 구조적 FIR 활용

9. **검증**
   - 스펙트럼(이미지/접힘 잔류)
   - 레벨 보존(I 이득 보상)
   - 그룹 지연/위상
   - 정밀도(고정소수점 시)

---

## 결론

샘플링률 변환을 위한 FIR 필터 설계는
단순한 “저역통과 필터 하나 고르는 문제”가 아니다.

핵심은:

1. **보간 이미지 제거 + 데시메이션 접힘 방지**를
   **하나의 컷오프 조건**으로 동시에 만족시키는 것:
   $$
   W_c \le \min(1/I,1/D)
   $$

2. 이 조건이 좁아질수록 FIR은 길어지므로
   **폴리페이즈, gcd 축약, 다단 분해, half-band 같은 구조적 최적화**가 필수라는 것.

3. 최종 품질은 “FIR 사양(ΔW, As, Rp)”이 지배하며,
   샘플링률 변환 자체는 그 FIR을 **어떻게 효율적으로 계산하느냐**의 문제다.

이 글의 절차와 Octave 예제를 그대로 따라가면
어떤 비율의 샘플링률 변환에서도
필터 사양 → 차수 → 구조 → 검증이 일관되게 연결될 것이다.
