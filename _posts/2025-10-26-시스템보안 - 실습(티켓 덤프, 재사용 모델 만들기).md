---
layout: post
title: 시스템보안 - 실습(티켓 덤프/재사용 모델 만들기)
date: 2025-10-26 17:30:23 +0900
category: 시스템보안
---
# 실습: 랩 환경에서 “티켓 덤프/재사용” **모델** 만들기 → 탐지 로그 분석

> 목표:
> 1) **정상 Kerberos/TGT/TGS 흐름**을 의도적으로 발생시켜 보안 로그의 “기준선(baseline)”을 구축
> 2) **의심 패턴**을 “안전하게 모의”(대량 TGS 요청, 비업무 시간 접근 등 **행동 시그널만**)하여 탐지 규칙을 검증
> 3) Windows(AD/KDC/도메인 멤버), Linux(KDC), SIEM(Splunk/Elastic/Sentinel) 관점에서 **엔드투엔드 관측**

> 주의: 아래 랩은 **티켓을 탈취/재사용하지 않습니다.** 정상 로그온/서비스 접근으로만 **유사 패턴**을 조성합니다.

---

## 랩 토폴로지 & 체크리스트

### A) 최소 구성

- **DC/KDC**: Windows Server(AD DS) 또는 Linux MIT KDC(둘 중 하나 혹은 둘 다)
- **클라이언트**: Windows 11(도메인 조인), Ubuntu(SSSD+Kerberos)
- **서비스 SPN**: 테스트 웹/파일 서비스 1~2개 (IIS/SMB 또는 Apache)
- **수집**:
  - Windows: 보안 이벤트(4624/4768/4769/4771/4776), Sysmon(선택)
  - Linux: `/var/log/krb5kdc.log`, `/var/log/auth.log`
  - 네트워크: pcap(선택, tcpdump/Zeek)
  - SIEM: Splunk/Elastic/Sentinel 중 택1

### B) 계정/암호화 정책(권장)

- Kerberos **AES-256/AES-128 only**, **RC4 불가**
- TGT/TGS **수명 단축**(예: TGT 4h/갱신 1d)
- **Protected Users** 테스트 그룹(Windows)
- 서비스 계정은 **gMSA**(자동 강한 키, 회전) 사용

---

## “정상” Kerberos 흐름 발생 → 기준선 수집

### Windows 측 (도메인 환경)

1) **도메인 사용자 로그인** → DC에서 **4768(TGT 발급)**
2) 서비스 접근(예: `\\filesrv\share`, `https://websrv`) → **4769(TGS)**
3) 로그 위치
   - DC: **Security** 로그 4768/4769
   - 멤버서버: 4624(Logon Type 3), `AuthenticationPackage=Kerberos`

**PowerShell–요약 리포트(읽기 전용)**
```powershell
# ① DC에서 Kerberos 이벤트 빈도 집계(기준선)

$start=(Get-Date).AddHours(-8)
Get-WinEvent -FilterHashtable @{LogName='Security'; StartTime=$start; Id=4768,4769} |
  Group-Object Id | Select Count, Name
# ② 서비스별 TGS 수요(상위 10)

Get-WinEvent -FilterHashtable @{LogName='Security'; StartTime=$start; Id=4769} |
  ForEach-Object {
    $rec = $_.Properties
    [pscustomobject]@{
      When=$_.TimeCreated
      ServiceName=$rec[0].Value   # Service Name / SPN
      Client=$rec[1].Value        # Account Name
      ClientAddr=$rec[8].Value    # Client Address
      TicketEncType=$rec[10].Value
    }
  } | Group-Object ServiceName | Sort-Object Count -desc | Select -First 10
```

### Linux KDC(MIT) 측

- `/var/log/krb5kdc.log`에서 AS/TGS 요청 확인
- **정상 근무 시간대** 기준선 수립(분당 요청량, 사용자·SPN 분포)

```bash
# 최근 8시간 간단 집계

awk -v since="$(date -d '8 hours ago' '+%b %_d %H')" '
$0 ~ since,0 {print}
' /var/log/krb5kdc.log | \
grep -E "AS_REQ|TGS_REQ" | awk '{print $6}' | sort | uniq -c | sort -nr | head
```

---

## “의심 패턴”을 **안전하게** 모의하여 탐지 규칙 검증

> 원칙: **티켓 탈취/재사용은 하지 않고**, 정상 API/클라이언트를 이용한 **행동 패턴**만 유도

### 패턴 A — “짧은 시간 대량 TGS 요청”(Kerberoasting 유사 시그널)

- 테스트 사용자가 **다수의 SPN**에 빠르게 접근(웹/파일/프린트 등)
- **DC에서 4769 이벤트 급증**이 보이는지 확인

**Windows KQL(Microsoft Sentinel)**
```kusto
SecurityEvent
| where TimeGenerated > ago(30m) and EventID == 4769
| summarize Count=count() by bin(TimeGenerated, 5m), TargetUserName=Account, ServiceName
| summarize TotalTGS=sum(Count) by bin(TimeGenerated, 5m)
| where TotalTGS > 100  // 환경 기준선에 맞게 조정
```

**Sigma 룰(스케치)**
```yaml
title: High Volume TGS Requests in Short Window
logsource: { product: windows, service: security }
detection:
  sel: { EventID: 4769 }
  condition: sel | count() by AccountName > 100 within 5m
level: high
```

### 패턴 B — 비업무 시간대의 다중 서비스 접근

- 야간/주말 시간대에 테스트 사용자로 여러 서버를 순회
- SIEM에서 **시간 창 기반** 이상치 탐지

**Splunk SPL**
```spl
index=security sourcetype=WinEventLog:Security EventCode=4769
| eval hour=strftime(_time,"%H")
| search hour>= "00" AND hour < "06"
| stats count dc(Service_Name) as distinct_services by Account_Name, src_ip
| where distinct_services >= 10
```

### 패턴 C — NTLM 급증(환경에 따라 PtH 우려)

- 특정 파일서버에 **4624 Type 3 + NTLM**이 치우쳐 증가
- Kerberos만 기대되는 구간에서 NTLM 증가를 탐지

**KQL**
```kusto
SecurityEvent
| where TimeGenerated > ago(1h) and EventID == 4624
| where LogonType == 3 and AuthenticationPackageName == "NTLM"
| summarize by TargetLogonId, IpAddress, Account
| summarize cnt=count() by IpAddress
| where cnt > 50
```

---

## 네트워크 관측(선택) — pcap/Zeek로 KRB5 트랜잭션만 보기

- `tcpdump 'port 88'` 또는 Zeek `kerberos` 로그
- 정상 vs 의심 패턴의 **요청량/분포** 비교(개인정보·크리덴셜은 수집·저장 금지)

```bash
sudo tcpdump -i eth0 port 88 -nn -w krb.cap -c 2000
```

---

## 결과 해석 & 운영 Runbook

1) **기준선**: 시간대별 4768/4769/4624 분당 평균 + 표준편차
2) **의심 시그널**: 임계치 초과, 야간 급증, 비정상 클라이언트/네트워크 구간
3) **조치**: 계정/단말 헬스체크 → 서비스 계정은 gMSA/키 회전 확인 → NTLM 차단 정책 재확인
4) **지속 개선**: 룰의 임계치/제외 목록(배치 잡 등) 튜닝

---

# 방어: PAM/SSO 하드닝, 2FA/U2F, Secret Rotation, LAPS/SCM

> 요점: “재사용 가능한 비밀(해시/티켓/토큰)”의 **가치와 수명**을 줄이고, **발급·사용·보관**의 모든 지점에 **강제 제약**을 둡니다.

---

## PAM/SSO 하드닝 (Linux 중심 + SSO 일반 원칙)

### A) PAM(예시 스니펫) — 실패 지연/락·품질·MFA

> 배포마다 모듈/파일 경로가 조금씩 다릅니다. 아래는 **개념 예시**이며 운영 표준에 맞춰 조정하세요.

**/etc/security/pwquality.conf**
```
minlen = 14
dcredit = -1
ucredit = -1
lcredit = -1
ocredit = -1
```

**/etc/pam.d/system-auth (개념)**
```
# 품질 검사

password  requisite   pam_pwquality.so retry=3 local_users_only
# 실패 누적(신규는 faillock)

auth      required    pam_faillock.so preauth audit deny=5 unlock_time=900
auth      [success=1 default=bad] pam_unix.so
auth      required    pam_faillock.so authfail audit deny=5 unlock_time=900
# 2FA(U2F/TOTP 중 택1; 둘 다 쓰면 sufficient/required 조합)

auth      sufficient  pam_u2f.so cue
# or: auth sufficient pam_google_authenticator.so nullok

```

**/etc/ssh/sshd_config (요지)**
```
PasswordAuthentication no        # 가능하면 Password 금지, Pubkey/MFA 사용
KbdInteractiveAuthentication yes # MFA (PAM) 허용
GSSAPIAuthentication yes         # Kerberos/SSO 사용 시
UsePAM yes
```

**원칙**
- **비밀번호 단독 금지**, Pubkey + MFA(또는 SSO)
- **SSO 토큰 수명 단축**, refresh token rotation/바인딩
- 애플리케이션은 **OIDC/OAuth2 / PKCE / mTLS(내부)**로 보호

### B) SSO·IdP 일반 하드닝

- **조건부 접근**(디바이스 컴플라이언스, 위치/리스크)
- **FIDO2/WebAuthn 기본값**(피싱 내성), OTP는 보조
- **세션 단축**: Access 15–60m, Refresh 짧게 + 회전/일회용
- **Token 보호**: SameSite/HttpOnly/Secure, Token Binding(가능 시), 클라이언트 저장 금지
- **SCIM/Just-in-time 프로비저닝**: 계정/그룹 자동 회수(오프보딩 지연 제거)

---

## 2FA/U2F(피싱 내성) 배치 패턴

### A) 서버(SSH) + YubiKey(U2F) 개념

1) 각 사용자 **U2F 등록**(공개키 매핑)
2) `pam_u2f.so` 적용 후, **키 터치** 없으면 로그인 실패
3) Break-glass(비상 계정)는 **물리적 분리 + 만료 시간**

**/etc/pam.d/sshd (핵심 라인)**
```
auth  required   pam_u2f.so origin=pam://ssh appid=pam://ssh cue
```

### B) 웹/내부 콘솔 — WebAuthn 우선

- IdP에서 **FIDO2 기본** 강제 정책
- 휴대폰 Passkey + 보안키 병행(2채널)

---

## Secret Rotation (Vault/Cloud KMS/SM) — 설계 & 예시

### A) 설계 원칙

- **사람이 아는 장기 비밀 금지** → **단기 세션/STS**
- DB/브로커 암호는 **자동 회전**(애플리케이션은 “비밀 이름”으로 조회, 값 변경은 SM이 처리)
- **Dual control**(승인 워크플로) + **Audit trail**
- **버전·수명** 메타데이터 필수, **만료 전 교체 알림**

### B) AWS Secrets Manager 예시(개념)

- RDS 비밀에 **로테이션 Lambda** 연결 → 주기 회전
- 애플리케이션은 **ARN/이름**으로 조회하므로 **무중단 교체** 가능

**애플리케이션(Python) — 조회 예시**
```python
import boto3, json
sm=boto3.client('secretsmanager')
val=sm.get_secret_value(SecretId="prod/db/app").get("SecretString")
cfg=json.loads(val)  # {"username":"...","password":"...","host":"..."}
# 이후 DB 연결에 사용

```

### C) HashiCorp Vault — DB 동적 크리덴셜

- 앱이 Vault에 **짧은 TTL의 계정**을 요청 → 만료 시 자동 폐기
- 장점: **유출돼도 금방 무력화**

**정책 요지**
- AppRole/JWT/OIDC로 앱 인증
- **방화벽/네트워크**로 Vault 접근 경로 최소화
- 감사 로그 원격 전송(무결성)

---

## LAPS / “SCM(Services)” 하드닝 — Windows 운영 핵심

### A) Windows LAPS(현대)

- 로컬 관리자 암호를 **랜덤·주기 회전** + **AD 속성에 안전 저장**
- 헬프데스크/자동화만 **세분 권한**으로 열람, **만료** 강제

**상태 점검(개요)**
```powershell
# 설치/상태 확인

Get-LapsADPassword -Identity "PC-001" -AsPlainText:$false  # 권한 가진 계정에서
# GPO/Intune 정책: RotationPeriodDays, PasswordLength, PostAuthActions 등 점검

```

### B) Service Control Manager(SCM) 하드닝

> 영속화·권한 상승의 단골 경로인 “서비스”를 표준화

- **경로 따옴표**(Unquoted Path) 강제
- **바이너리/디렉터리 DACL**에서 `Users/Everyone` 쓰기 제거
- 서비스 계정은 **gMSA** 사용(비밀번호 자동 관리)
- 설치/업데이트 파이프라인에 **서명·경로 고정·무결성 검사**

**점검·수정 예시**
```powershell
# Unquoted Path 탐지 & 보정 (개요)

$svc="VendorSvc"
$k="HKLM:\SYSTEM\CurrentControlSet\Services\$svc"
$img=(Get-ItemProperty $k).ImagePath
if($img -notmatch '^".*"$'){ Set-ItemProperty $k ImagePath ('"'+$img+'"') }

# 디렉터리 권한 경직

$exe=($img -replace '^"','' -replace '"$','').Split(' ')[0]
$dir=Split-Path $exe -Parent
icacls $dir /inheritance:r
icacls $dir /grant:r "SYSTEM:(OI)(CI)(F)" "Administrators:(OI)(CI)(M)"
icacls $dir /remove:g "Users" "Authenticated Users" "Everyone"
```

---

## 운영 탐지·대응 Runbook (압축)

1) **수집**
   - Windows: 4624/4625, 4768/4769/4771/4776, Sysmon(1/7/10/12~14), LAPS 이벤트
   - Linux: krb5kdc, auth.log, sudo/auditd
2) **탐지**
   - **TGS 폭증**(Kerberoasting 유사), 야간 대량 접근, NTLM 급증
   - 서비스 경로/권한 Drift, 비인가 WMI 구독
3) **격리·완화**
   - 계정 잠금 대신 **MFA 강제/기기검증** 우선
   - 서비스 계정 **gMSA 전환**·키 회전, NTLM 사용 제한
4) **예외**
   - 만료일·사유·소유자 필수, 격월 재검토
5) **테이블탑/드릴**
   - 티켓 유출 **가정 시나리오**로 탐지→대응→교훈 기록(실제 탈취 금지)

---

## 자주 묻는 질문

- **“야간 작업 때문에 TGS가 많아요. 오탐?”**
  → 배치/백업 SPN 화이트리스트, 단 **클라이언트 IP/사용자 에이전트**를 함께 조건에 넣어 오탐 축소.
- **“NTLM을 완전히 끄기 어렵습니다.”**
  → 서버·세그먼트별 단계적 비활성, **채널 바인딩/서명** 필수화, 최종 마이그레이션 계획.
- **“Vault/Secrets Manager 도입 시 장애 우려.”**
  → **Dual read**(환경변수→Vault) 전환 기간 운영, 회전 주기 늘여 점진적 축소.
- **“LAPS 도입했는데 Helpdesk 남용?”**
  → RBAC로 조회권 최소화, **모든 열람 이벤트**를 SIEM 경고로 전송, 티켓(작업번호) 연계.

---

# 핵심 요약

- **티켓 “덤프/재사용”의 실현**이 아니라, **그로 인한 행동 시그널**(TGS 폭증, 시간·분포 이상)을 랩에서 **안전하게 모의**해 **탐지 규칙**을 검증하세요.
- **PAM/SSO 하드닝 + FIDO2/U2F + 단기 세션/회전**은 재사용 가능한 비밀을 구조적으로 무력화합니다.
- **LAPS + 서비스(SCM) 하드닝 + gMSA**로 윈도우 측 상시 노출면을 줄이십시오.
- 이 문서의 스크립트/쿼리/정책 조각을 **CI/MDM/SIEM 파이프라인**에 묶으면 “배포 전 차단 → 배포 후 가시성 → 주기적 회전” 루프가 완성됩니다.
