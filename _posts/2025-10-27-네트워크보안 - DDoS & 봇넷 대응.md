---
layout: post
title: 네트워크보안 - DDoS & 봇넷 대응
date: 2025-10-27 21:25:23 +0900
category: 네트워크보안
---
# 16. DDoS & 봇넷 대응

> 목표: **공격 유형(Volumetric/Protocol/Application)**을 계층별로 분해하고, **Anycast·스크러빙·대역외(Out-of-Band) 보호**의 트레이드오프를 정리한다.  
> **C2(Command & Control) 트래픽**의 공통 패턴(비콘 주기, DGA, JA3/HTTP 지문)을 이해하고 차단·헌팅 룰을 만든다.  
> 끝으로 **레이트 리미트/conntrack/WAF**를 실제 튜닝하여 “**흡수 → 완화 → 유지 → 포렌식**” 루프를 완성한다.  

---

## 16.1 공격 유형과 **계층별 방어**

### 16.1.1 분류 개요

| 계층 | 예시 공격 | 목적/효과 | 1차 지표 | 1차 방어 |
|---|---|---|---|---|
| **L3 Volumetric** | UDP Flood(SSDP, CLDAP), NTP/CharGEN 증폭, IP Fragment Flood | 회선·라우터 포화 | bps/pps 급증, Drops | Anycast CDN, 스크러빙센터, RTBH/FlowSpec |
| **L4 Protocol** | SYN Flood, ACK/RST Flood, QUIC Initial Flood | 커널/연결 테이블 고갈 | SYN backlog, conntrack 사용률 | SYN Cookie, conntrack 튜닝, L4 LB/NLB |
| **L7 Application** | HTTP GET/POST Flood, Slowloris, GraphQL/N+1 | 앱/DB 자원 소모 | RPS, CPU, DB QPS | L7 Rate, WAF 규칙, 캐시/Edge Compute |
| **State Exhaustion** | TLS Handshake Flood, WebSocket 오픈락 | 핸드셰이크/세션 고갈 | TLS handshakes/s | TLS 터미네이션 오프로딩, H/2 Priorities |

> 핵심: **경계-에지(Anycast/CDN) → 스크러빙 → 내부 경계(L4/L7)** 순서로 **거칠고 싼 필터 → 점점 정밀**한 정책.

---

### 16.1.2 L3/L4 즉응(엣지·네트워크)

**(A) 유입 차단: RTBH/FlowSpec(개념)**  
- **RTBH**: 공격 타깃 IP를 **/32**로 블랙홀(최후수단).  
- **BGP FlowSpec**: 헤더 매칭(예: UDP/CLDAP 389/1900)으로 **유입 전 필터**.

**(B) 커널/스택: conntrack·SYN**  
- **SYN Cookies 활성화**, `net.ipv4.tcp_syncookies=1`
- **conntrack** 최대값/해시 버킷 증가, `nf_conntrack_max`, `hashsize`  
- **반열림(SYN-RECV)** 타임아웃 단축

**리눅스 sysctl(보수적 기본)**
```bash
cat <<'SYS' | sudo tee /etc/sysctl.d/60-ddos.conf
# SYN & TIME-WAIT/FIN 관리
net.ipv4.tcp_syncookies=1
net.ipv4.tcp_max_syn_backlog=8192
net.ipv4.tcp_synack_retries=5
net.ipv4.tcp_fin_timeout=15
net.ipv4.tcp_tw_reuse=1

# conntrack (nftables/iptables 사용 시)
net.netfilter.nf_conntrack_max=1048576
net.netfilter.nf_conntrack_tcp_timeout_established=7200
net.netfilter.nf_conntrack_tcp_timeout_syn_recv=20
net.netfilter.nf_conntrack_tcp_timeout_time_wait=30

# ICMP & src validation (uRPF-light)
net.ipv4.conf.all.rp_filter=1
net.ipv4.icmp_echo_ignore_broadcasts=1
SYS
sudo sysctl --system
```

**nftables: L4 속도 제한/드롭(예시)**  
(공격성 높은 UDP/빈번 포트에 **버킷형** 레이트)
```bash
sudo nft -f - <<'NFT'
table inet ddos {
 set allow_subnets { type ipv4_addr; flags interval; elements = { 10.0.0.0/8, 192.168.0.0/16 } }

 chain input {
   type filter hook input priority 0;
   ct state established,related accept
   ip saddr @allow_subnets accept

   # SYN flood 완화
   tcp flags & (syn|ack) == syn limit rate 1000/second accept
   tcp flags & (syn|ack) == syn drop

   # UDP flood 레이트(소스 IP별)
   ip protocol udp limit rate over 5000/second drop

   # 기본
   iifname "lo" accept
   ct state invalid drop
   counter drop
 }

 chain forward { type filter hook forward priority 0; policy drop; }
}
NFT
```

> 운영 팁: **정책은 최소 허용**으로, “**관측 → 허용**” 루프로 다듬는다. 무차별 드롭은 정상 트래픽도 같이 죽일 수 있다.

---

### 16.1.3 L7(HTTP/HTTPS) 완화

**Nginx: 속도·동시 연결 제한**
```nginx
# /etc/nginx/conf.d/limits.conf
limit_req_zone $binary_remote_addr zone=req_rps:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=perip:10m;

server {
  listen 443 ssl http2;
  server_name app.example.com;

  # 요청/연결 제한 (버스트는 20, 429 반환)
  location /api/ {
    limit_conn perip 20;
    limit_req zone=req_rps burst=20 nodelay;
    proxy_pass http://app_backend;
  }

  # 큰 바디 제한(파일 업로드 남용 완화)
  client_max_body_size 8m;
  client_body_timeout 10s;
}
```

**Envoy: L7 RateLimit 서비스 연동(개념)**
```yaml
http_filters:
- name: envoy.filters.http.ratelimit
  typed_config:
    "@type": type.googleapis.com/envoy.extensions.filters.http.ratelimit.v3.RateLimit
    domain: "api"
    timeout: 0.1s
route_config:
  virtual_hosts:
  - name: app
    routes:
    - match: { prefix: "/api" }
      route:
        cluster: app_backend
        rate_limits:
        - actions:
          - remote_address: {}
```

**WAF(OWASP CRS) 추가 팁**
- **Slowloris/slow POST**: `request_body_no_files_limit`, `reqtimeout` 조정  
- **GraphQL/JSON**: **쿼리 깊이/필드 개수** 헤더 기반 선제 차단(Upstream 로직과 병행)

---

## 16.2 **Anycast·스크러빙·대역외 보호**

### 16.2.1 Anycast(글로벌 에지 분산)
- **장점**: 가까운 POP으로 흡수, **RTT↓, 분산처리**.  
- **과제**: 세션 고정 요구 시(게임/TCP 상태) 라우팅 변화에 **세션 끊김** 위험.

**권장**: **Anycast + L7 캐시/정적 컴포넌트** → 동적은 지역 고정 또는 스테이트리스 설계.

---

### 16.2.2 스크러빙 센터(Outsourced/자사)
- **유입 전 필터링**: 용량 수 Tbps, **증폭 벡터 시그니처**(SSDP/CLDAP/NTP) 실시간 룰.  
- **BGP 리다이렉션**: 공격 시 **BGP 커뮤니티**로 트래픽을 스크러빙 경유.  
- **정리 후** 전용 GRE/IPsec 터널로 원천 전달.

**BGP 트리거(개념)**
```
[우리 AS] --(BGP 커뮤니티)--> [스크러빙센터 AS]
   \___________________________/  (공격 중에만 경로 광고 전환)
```

---

### 16.2.3 대역외(Out-of-Band) 보호 · OOB 관리면
- **관리면 분리**: 백도어/장비 조작 방지.  
- **Out-of-Path DDoS**: 미러링/NetFlow/BGP-Flowspec 컨트롤로 **유입경로 외부에서 룰 푸시**.

**자동화 아이디어**  
- 지표(pps/bps/RPS) 임계 초과 → **Lambda/Function**로 WAF·FlowSpec·RTBH 룰 푸시  
- 종료 감지 → **롤백/감사 로그** 저장

---

## 16.3 **C2 트래픽 특성과 차단**

### 16.3.1 공통 패턴
- **비콘(Beaconing)**: 고정/지터 간격(예: 60±10초)로 **소량 HTTP/S·DNS** 요청.
- **DGA(Domain Generation Algorithm)**: 난수형 도메인 대량 질의, **NXDOMAIN 비율↑**.
- **JA3/JA4 TLS 지문**: 특정 패밀리 고유 cipher/order → **시그니처 매칭** 가능.
- **HTTP 헤더/URI**: 비정상 User-Agent, 고정형 Cookie/패딩, `/api/checkin?id=...`
- **DoH/DoT 은닉**: DNS over HTTPS/TLS로 피벗 (도메인 화이트리스트 전략 필요).

### 16.3.2 DNS 레이어 탐지/차단

**Suricata(의사 룰)**
```text
alert dns any any -> any any (msg:"DGA high entropy domain"; dns.query; pcre:"/^[A-Za-z0-9]{16,}\.[A-Za-z]{2,}$/"; sid:100001; rev:1;)
alert dns any any -> any any (msg:"Excessive NXDOMAIN"; detection_filter:track by_src, count 30, seconds 60; dns.rcode NXDOMAIN; sid:100002; rev:1;)
```

**엔트로피 기반 간이 탐지(파이썬)**  
> 허위양성 존재. **감지 → 샌드박스/EDR 교차검증** 권장.
```python
import math, re
def shannon_entropy(s):
    from collections import Counter
    c = Counter(s)
    l = len(s)
    return -sum((n/l)*math.log2(n/l) for n in c.values())

def is_suspicious_domain(d):
    name = d.split('.')[0]
    if len(name) < 12: return False
    ent = shannon_entropy(re.sub(r'[^a-z0-9]', '', name.lower()))
    return ent > 3.6  # 경험적 임계

test = ["google.com","as9dkq02mdpw3z.net","update-cdn.example"]
for d in test:
    print(d, is_suspicious_domain(d))
```

**정책 포인트**
- **DoH/DoT**: 기업망은 **승인된 DoH 엔드포인트만 허용**, 브라우저 정책/MDM 강제.  
- **DNS 싱크홀**: C2 도메인 블랙리스트 싱크홀 → 요청·클라이언트 로깅.

### 16.3.3 TLS 지문(JA3/JA4)

**Zeek 스크립트(개념)**  
- `ssl.log`에서 `ja3` 필드 → **패밀리 블랙리스트**와 대조.  
- 새 지문 발견 시 **샘플링/격리**.

**차단 전략**
- L7 프록시/방화벽에서 **SNI 허용목록**(업무 필수 도메인) + **JA3 차단** 병행.  
- **mTLS 내부화**로 외부 프록시 우회 접속 축소.

### 16.3.4 HTTP 비콘 식별(규칙·행동)
- 고정간격(±지터) POST/GET에 **상수 크기** 페이로드.  
- User-Agent/Referer **정적 문자열** 반복.  
- 대책: **Request signature**(헤더/경로) 차단, **동적 토큰/CSRF**.

---

## 16.4 **실습: 레이트 리미트 / conntrack / WAF 튜닝**

> **시나리오**  
> - 도메인 `app.example.com`, 리버스 프록시 Nginx, 뒤에 앱 2대.  
> - 공격: (1) L4 SYN flood, (2) L7 HTTP GET flood, (3) 저속 슬로우 POST.  
> - 목표: **네트워크/커널 → L7 프록시 → 애플리케이션** 순으로 튜닝하고 지표로 검증.

---

### 16.4.1 커널/conntrack 튜닝 + iptables SYN Cookie 보정

**SYN backlog/conntrack 확인**
```bash
ss -s | grep -i syn
cat /proc/sys/net/netfilter/nf_conntrack_count
cat /proc/sys/net/netfilter/nf_conntrack_max
```

**iptables: SYN-RECV 비율 모니터/드롭(옵션)**
```bash
# connlimit으로 소스별 동시 연결 제한 (L4 남용 완화)
iptables -I INPUT -p tcp --syn --dport 443 -m connlimit --connlimit-above 50 -j REJECT --reject-with tcp-reset

# 최근 접속 급증 드롭(실험적)
iptables -I INPUT -p tcp --dport 443 -m state --state NEW -m recent --set
iptables -I INPUT -p tcp --dport 443 -m state --state NEW -m recent --update --seconds 1 --hitcount 200 -j DROP
```

> nftables 환경이면 앞 절의 nft 예시 권장. iptables는 커널/배포판에 따라 성능 차이.

---

### 16.4.2 Nginx L7 Rate/WAF/타임아웃

**요청 속도/동시성 + 타임아웃**
```nginx
# zones
limit_req_zone $binary_remote_addr zone=req_rps:20m rate=15r/s;
limit_conn_zone $binary_remote_addr zone=perip:20m;

# timeouts (slowloris 완화)
proxy_read_timeout 30s;
proxy_send_timeout 30s;
client_body_timeout 10s;
send_timeout 30s;
keepalive_timeout 15s;

server {
  listen 443 ssl http2;
  server_name app.example.com;

  # 접속/요청 제한
  location / {
    limit_conn perip 30;
    limit_req zone=req_rps burst=30 nodelay;
    proxy_pass http://app_backend;
  }

  # 대용량 업로드 경로는 별도 스레들(버킷 크기 상향)로 분리
  location /upload/ {
    client_max_body_size 32m;
    limit_req zone=req_rps burst=10 nodelay;
    proxy_pass http://app_backend;
  }
}
```

**ModSecurity CRS (탐지→차단 단계적)**
```nginx
modsecurity on;
modsecurity_rules '
  SecRuleEngine On
  SecRequestBodyAccess On
  SecDefaultAction "phase:2,pass,log,tag:ddos-l7"
  # Slow HTTP 탐지(간단)
  SecRule TIME:REQUEST_BODY_PROCESSOR_ERROR "@gt 0" "id:900100,phase:2,deny,status:408,msg:'Slow body'"
';
```

> 운영은 **DetectionOnly → 튜닝 → 차단** 순. 오탐/미탐 리뷰 루프 필수.

---

### 16.4.3 애플리케이션 측 캐시/쿼타(보조선)
- 읽기 API: **캐시 TTL**(Edge Cache/Response Cache) & **E-Tag/Last-Modified**.  
- 쓰기 API: **사용자별/토큰별 쿼타**(리밋 도달 시 429/Retry-After).  
- GraphQL/검색: **쿼리 복잡도 제한**(Depth/Cost), 페이지네이션 강제.

**간단 토큰 버킷(파이썬 WSGI·개념)**
```python
import time
from collections import defaultdict, deque

WINDOW=1.0; LIMIT=15
buckets = defaultdict(deque)

def allowed(key):
    now=time.time()
    q=buckets[key]
    while q and now-q[0] > WINDOW:
        q.popleft()
    if len(q) < LIMIT:
        q.append(now); return True
    return False

def app(environ, start_response):
    key = environ.get('HTTP_X_REAL_IP') or environ['REMOTE_ADDR']
    if not allowed(key):
        start_response('429 Too Many Requests',[('Retry-After','1')]); return [b'limit']
    start_response('200 OK',[('Content-Type','text/plain')]); return [b'ok']
```

---

### 16.4.4 관측: “버티고 있나?”를 수치로

**엣지/프록시 메트릭**
- **2xx/3xx/4xx/5xx 비율**, **429 비율**, **p50/p90/p99**, **upstream_5xx**  
- **Requests/s**, **Active connections**, **limit_req 드롭 수**  
- **JA3/UA 상위 N**, **경로 상위 N**, **소스 ASN 상위 N**

**리눅스/커널**
- `netstat -s` (TCP Retransmits), `ss -s` (SYN-RECV), `conntrack -S`

**예: PromQL(개념)**
```promql
sum(rate(nginx_ingress_controller_requests{status=~"4.."}[1m])) 
/ sum(rate(nginx_ingress_controller_requests[1m])) > 0.5
```

---

### 16.4.5 **플레이북** (발생 → 수습)

1) **탐지**: RPS/pps 급증 알람 → 대시보드 열람(상위 경로/UA/ASN).  
2) **에지 조치**:  
   - CDN/WAF 규칙: “비정상 UA 차단”, “경로 `/login` burst 제한”.  
   - 레이어7 **챌린지/토큰** 적용(봇/브라우저 구분).  
3) **네트워크 조치**:  
   - L3/L4 flood → **스크러빙** 활성, 필요 시 **FlowSpec**.  
   - 내부 LB 앞단 **nftables limit** 강화.  
4) **앱 보호**:  
   - 쓰기 API **일시적 제한**(정상 사용자 안내), 캐시 TTL 상향.  
5) **사후**:  
   - 소스 ASN/JA3/도메인 블록리스트 업데이트, 룰을 **코드화**(GitOps).  
   - 로그/샘플 보존·포렌식, **IR 보고서**.

---

## 부록 A. Kubernetes Ingress (NGINX) 레이트+Bot 힌트
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app
  annotations:
    nginx.ingress.kubernetes.io/limit-rps: "15"
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "2"
    nginx.ingress.kubernetes.io/limit-whitelist: "10.0.0.0/8,192.168.0.0/16"
    nginx.ingress.kubernetes.io/server-snippet: |
      if ($http_user_agent ~* "(python-requests|curl|wget)") { return 403; }
spec:
  ingressClassName: nginx
  rules:
  - host: app.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service: { name: web, port: { number: 80 } }
```

## 부록 B. QUIC/HTTP-3 주의
- **초기 패킷 무상태** 특성 → **초기 핸드셰이크 flood**에 취약해질 수 있음.  
- **대책**: **Retry** 토큰 사용, **초기 윈도 제한**, **IP 평판/ASN 차단**.

## 부록 C. 증폭(Amplification) 포착 쿼리 아이디어
- **SSDP 1900/UDP**, **CLDAP 389/UDP**, **NTP 123/UDP** 목적지 비율 급증.  
- **NetFlow**: “응답/요청 바이트 비율”이 비정상적으로 큰 플로우 상위 N.

---

## 체크리스트(요점 정리)

- [ ] **Anycast/CDN + 스크러빙 + 내부 L4/L7** 3중 구조  
- [ ] **SYN Cookie**, **conntrack** 최대/타임아웃 튜닝  
- [ ] **nftables/iptables**로 **소스별 레이트**와 **burst** 제한  
- [ ] **Nginx/Envoy**: **limit_req/limit_conn/timeout** + **대용량 경로 분리**  
- [ ] **WAF**: 탐지→튜닝→차단, GraphQL/Slow HTTP 전용 룰  
- [ ] **DNS 보안**: DoH 허용목록, 싱크홀, NXDOMAIN/DGA/JA3 헌팅  
- [ ] **지표**: 429/5xx, SYN-RECV, conntrack, Top ASN/JA3/UA/경로  
- [ ] **자동화**: 임계 → FlowSpec/WAF/RTBH 푸시 → 종료 시 롤백  
- [ ] **IR 문서화**: 타임라인, 룰 변경 diff, 소스 증거 보존

---

## 요약

- DDoS는 **계층별(3→4→7)**로 **싼 필터부터 고도 정책**으로 막는다.  
- **Anycast/스크러빙**으로 흡수하고, 내부에서는 **커널/conntrack 튜닝**과 **L7 레이트·WAF**로 세밀히 조절한다.  
- 봇넷 C2는 **비콘/JA3/DGA/DoH** 패턴으로 드러난다. DNS·TLS·HTTP 단에서 **감지와 차단**을 병행하라.  
- 모든 조치는 **관측과 롤백**을 포함한 **플레이북**으로 자동화하고, **사후 포렌식**까지 이어질 때 비로소 “운영 가능한 방어”가 된다.
