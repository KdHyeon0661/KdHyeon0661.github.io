---
layout: post
title: 네트워크보안 - IoT/OT/ICS 보안
date: 2025-10-31 17:25:23 +0900
category: 네트워크보안
---
# 22. IoT/OT/ICS 보안

> 목표
> - **Modbus/DNP3/PROFINET** 등 대표 OT 프로토콜의 **특성·제약**을 이해해 “왜 IT 방식이 그대로 통하지 않는가”를 파악한다.
> - **패시브 디스커버리**(가용성 훼손 없이 자산 파악)와 **변경 불가 장비 보호** 전략(세그먼트·프록시·안전 가드)을 정립한다.
> - **세이프티 vs 시큐리티**의 균형 원칙(**ALARP**, 변경 영향 분석, MOC)을 실제 운영 관점에서 정리한다.
> - 실습에서는 **OT 세그먼트 모니터링 대시보드**(Zeek/Suricata/NetFlow → SIEM)를 구성하여 **이상 트래픽**을 식별한다.
> ⚠️ 모든 예제는 **승인된 랩/테스트베드**에서만 수행. 실제 설비(PLC/변전소/현장망)에 **능동 스캔 금지**.

---

## 22.1 Modbus/DNP3/PROFINET 특성·제약

### 22.1.1 공통 배경
- **Deterministic/Real-time**: 짧은 주기(10–250ms)로 폴링/제어. **지터/지연**이 안전에 직결.
- **레거시/장수 장비**: 펌웨어/OS 업데이트 불가, **암호화/인증 미지원** 다수.
- **평면 신뢰(Flat trust)**: 동일 브로드캐스트 도메인, **L2 침해** 여파가 큼(ARP 스푸핑, 포트 미보안).
- **가용성 최우선**: 보안 조치보다 **운전 지속**이 상위 목표. 재부팅/다운타임 불가.
- **네트워크**: L2 스위칭/필드버스 혼재, 라우팅 제한, 멀티캐스트/브로드캐스트 의존.

### 22.1.2 Modbus/TCP
- **용도**: PLC/RTU 레지스터 읽기/쓰기(Function Codes).
- **특징**: TCP/502, **인증·암호화 없음**, 단순 프레임(ADU→PDU).
- **위험**: 쓰기 기능(0x05/0x06/0x0F/0x10) 오·악용 시 **프로세스 교란**.
- **수비 포인트**:
  - **읽기 전용 샌드박스**(프록시/게이트웨이)로 외부 접근 제한.
  - Function Code **화이트리스트**(예: 0x03/0x04만 허용).
  - **리플레이/스푸핑** 탐지(트랜잭션 ID/세션 상관).
- **예: Suricata 룰(쓰기 시도 알림)**
```suricata
alert tcp any any -> $OT_NET any (msg:"Modbus write (FC=5/6/15/16)"; flow:to_server,established;
  content:"|00|"; offset:7; depth:1; # Function Code 위치(간소화)
  byte_test:1,=,0x05,7; sid:920001; rev:1; classtype:attempted-admin; priority:1;)
alert tcp any any -> $OT_NET any (msg:"Modbus write (FC=15)"; flow:to_server,established;
  byte_test:1,=,0x0F,7; sid:920002; rev:1;)
alert tcp any any -> $OT_NET any (msg:"Modbus write (FC=16)"; flow:to_server,established;
  byte_test:1,=,0x10,7; sid:920003; rev:1;)
```

### 22.1.3 DNP3 (IEEE 1815)
- **용도**: 전력 SCADA(변전소/RTU). 이벤트 지향, 시간 동기·오프셋 포함.
- **전송**: TCP/20000(또는 직렬), **보안 확장(DNP3-SA)** 있음(현장 보급 제한).
- **위험**: Unsolicited Response 남용, 누적 이벤트 플러드, 시퀀스/타임스탬프 조작.
- **수비 포인트**:
  - **마스터↔아웃스테이션 역할 고정**(단방향 흐름 유지).
  - **객체 그룹/변수 화이트리스트**(읽기 빈도/수량 제한).
  - **시간 도약/역행** 이상 탐지(OT 타임 소중).
- **예: Zeek 스크립트(간단 – 마스터/아웃스테이션 역전 알림)**
```zeek
# dnp3_master_check.zeek (개념)
@load policy/frameworks/notice/main
module DNP3;
export { redef enum Notice::Type += { DNP3::RoleAnomaly }; }
event new_connection(c: connection) {
  if ( c$id$resp_p == 20000/tcp ) {
    # 관례: 마스터(클라) -> 아웃스테이션(서버)
    # 반대 트래픽 비율이 높으면 이상
  }
}
# 실제 DNP3 파서/로그는 커뮤니티 패키지 사용 권장
```

### 22.1.4 PROFINET (Industrial Ethernet)
- **용도**: 제어 주기적 I/O 교환(Real-Time, IRT), 기기 디스커버리(DCP), 장치명/주소 설정.
- **특징**: **멀티캐스트/브로드캐스트** 많이 사용, **DCP(Discovery and Configuration Protocol)**로 장치 파라미터 변경 가능.
- **위험**: **DCP Identify/Set** 남용 → 장치명/IPv4 변경 → 통신 중단.
- **수비 포인트**:
  - OT 스위치에서 **DCP 차단/제어**(운전 중 변경 금지).
  - **미러 포트**로만 관찰, L2 보호(DAI, Port Security).
  - **PN-GR/PNIO** 특화 어낼라이저로 이상 패턴 감시.

---

## 22.2 패시브 디스커버리·변경 불가 장비 보호

### 22.2.1 원칙
- **패시브 우선**: 스캔/폴링 **금지**. 트래픽 미러(TAP/SPAN), NetFlow/sFlow, OT-IDS(Deep L7).
- **데이터 융합**: OT 엔지니어의 **P&ID/루프도**, 자산 명세(벤더/모델/펌웨어), 스위치 MAC 테이블, DHCP/ARP 캐시, DNS/CMMS.
- **식별키**: MAC-OUI(벤더), L7 배너(Function Code/Device ID), 통신 주기, 포트 조합.

### 22.2.2 패시브 자산 인벤토리 (Zeek+정규화)
**Zeek → 자산 CSV(간략)**
```bash
# 미러 인터페이스에서 Zeek 실행(패킷 드롭 최소화 주의)
sudo zeek -i eth1 local
# 결과(예): known_hosts.log, conn.log, modbus.log(패키지), dnp3.log(패키지), profinet.log(도구)
```
**정규화 스크립트(파이썬) — 주기/포트/배너 요약**
```python
# ot_asset_build.py
import csv, collections, statistics as st
assets = collections.defaultdict(lambda: {"ports": set(), "peers": set(), "intv": []})
with open("conn.log") as f:
    for row in csv.DictReader((l for l in f if not l.startswith("#")), delimiter="\t"):
        s,d = row["id.orig_h"], row["id.resp_h"]
        p = f'{row["id.resp_p"]}/{row["proto"]}'
        assets[s]["ports"].add(p); assets[s]["peers"].add(d)
# (간략) 주기 추정은 프로토콜 로그 기반으로 추가…
for k,v in assets.items():
    v["ports"] = ",".join(sorted(v["ports"]))
with open("ot_assets.csv","w") as o:
    w=csv.DictWriter(o, fieldnames=["host","ports","peers_cnt"])
    w.writeheader()
    for h,a in assets.items():
        w.writerow({"host":h,"ports":a["ports"],"peers_cnt":len(a["peers"])})
```

### 22.2.3 변경 불가 장비 보호(“Wrapper/Shielding”)
- **L3 격리 + L2 통제**: OT 세그먼트 별 **전용 파이어월/라우터**.
- **다이오드/단방향 게이트웨이**: 외부→내부 **쓰기 불가**.
- **프로토콜 프록시**: Modbus/DNP3 명령 **밸리데이션 프록시**(허용 FC/주소 범위).
- **DNS/시간/로깅 게이트웨이**: 외부 인프라 의존 최소화(오프라인/캐시).
- **변경 관리(MOC)**: 펌웨어/구성 변경은 **정지 계획**·리스크 분석·롤백 포함.

**예: Modbus “읽기 전용 프록시”(개념 Go 코드)**
```go
// read_only_modbus_proxy.go (개념용: 실운영은 검증 라이브러리 사용)
switch functionCode {
case 0x03, 0x04: forward()
default:
  deny("write FC blocked")
}
```

### 22.2.4 최소 신뢰 통신 경로
- **점대점(Operator ↔ HMI/SCADA ↔ PLC)** 경로를 그래프로 모델링 후
  **허용목록(Allow-list)** 으로만 통과.
- **중계/Bastion**: 원격점검/정비는 점프박스(레코딩, mTLS, 시간제한, 승인).
- **벤더 통신**: **메인터넌스 창구**만 개방(변경 승인서/비상 차단).

---

## 22.3 세이프티 vs 시큐리티 균형

### 22.3.1 공통 언어 만들기
- **세이프티(안전)**: 인명/설비 보호(IEC 61508, 61511).
- **시큐리티(보안)**: 악의적 행위/오작동 **예방·탐지·대응**(IEC 62443).
- **충돌 지점**: 패치/재부팅/인증 도입이 **운전 안정성**과 충돌.
- **해법**: **ALARP**(As Low As Reasonably Practicable) — 위험을 합리적으로 달성 가능한 한 낮춘다.

### 22.3.2 변경 영향 분석(MOC)
- 변경 요청 → **HAZOP**/What-If 체크 → **테스트베드 검증** → 창구 승인 → **윈도우 작업** → 롤백 시험.
- **Fail-Safe** 설계: 인증 실패/네트워크 분리 시 **안전 정지/수동 운전**으로 전이.
- **중요 KPI**: 지연/지터 변화, 패킷 손실률, 주기 준수율(폴링 주기 ±허용치).

### 22.3.3 사고 대응(IR) in OT
- **차단의 비용이 더 큼**: 즉각 차단 대신 **관찰/안전 모드**.
- **네트워크 레벨 가드**: 쓰기 명령 차단, 세그먼트 제어, 우회 경로 차단.
- **증거 보존**: PCAP/로그 무결성, 운전 데이터(SOH) 스냅샷.
- **재가동 절차**: OT 운영팀 리드, 단계적 정상화.

---

## 22.4 실습: OT 세그먼트 모니터링 대시보드

> **목표**: 패시브로 **Modbus/DNP3/PROFINET 트래픽**을 수집해
> - **허용되지 않은 쓰기/설정 변경**
> - **주기 이탈/지연 증가**
> - **새로운 기기/통신쌍 등장**
> 을 대시보드로 즉시 보여준다.

### 22.4.1 랩 토폴로지
```
[PLC/RTU/Field] --(OT Switch SPAN/TAP)--> [Sensor (Zeek+Suricata)]
                                        \-> NetFlow(IPFIX)
Sensor --> Filebeat --> Logstash --> Elasticsearch/Kibana
```
- **SPAN/TAP** 전용 포트 사용(프로덕션 트래픽 간섭 금지).
- 센서는 **읽기 전용** NIC. 커널 튜닝(멀티큐, 대용량 버퍼)로 드롭 최소화.

### 22.4.2 Suricata/Zeek 구성(요지)
**Suricata(eve.json: flow/dns/http/tls + modbus 룰 추가)**
```yaml
outputs:
  - eve-log:
      enabled: yes
      filetype: regular
      filename: /var/log/suricata/eve.json
      types: [ alert, flow, stats, modbus ]
```
**Zeek(local.zeek)**
```zeek
@load policy/protocols/modbus    # 패키지 필요
@load policy/protocols/dnp3      # 패키지/플러그인
redef LogAscii::use_json = T;    # JSON 로그 권장
```

### 22.4.3 대시보드 위젯 설계
1) **Modbus Function Code 분포(탑 N)**
   - 예상: 0x03/0x04(읽기) 위주. 0x05/0x06/0x0F/0x10 등장 시 **경고**.
2) **새 통신쌍(5-tuple) 등장 알림(24h)**
   - 정상 베이스라인 대비 신규 통신쌍 **증가** 표시.
3) **주기/지연 히트맵**
   - 폴링 주기(평균/표준편차). 임계 초과 시 색상 경고.
4) **PROFINET DCP Set 이벤트**
   - 운전 중 발생 시 **크리티컬**.
5) **세션 실패/재전송 비율**
   - 링크 문제/스톰/스푸핑 징후.

**Kibana KQL 예 — Modbus 쓰기 이벤트**
```kql
index:suricata-*
event.module:"suricata" and modbus.function_code : (5 or 6 or 15 or 16)
| stats count() by source.ip, destination.ip, modbus.function_code
| sort by count desc
```

**KQL — 신규 통신쌍**
```kql
index:zeek-conn-*
@timestamp > now()-24h
| stats count() by id.orig_h, id.resp_h
| where not in_baseline(id.orig_h, id.resp_h)  // (준비된 Enrichment 함수)
```

### 22.4.4 간단 이상탐지(주기 편차 체크; 파이썬)
```python
# modbus_interval_check.py
import json, collections, statistics as st, sys
pairs=collections.defaultdict(list)
for line in sys.stdin:  # eve.json 스트림 입력 가정
    ev=json.loads(line)
    if ev.get("modbus") and ev["event_type"]=="modbus":
        key=(ev["src_ip"], ev["dest_ip"], ev["modbus"].get("function_code"))
        t=ev.get("timestamp")
        if t: pairs[key].append(t)

def to_epoch(ts):
    from datetime import datetime
    return datetime.fromisoformat(ts.replace("Z","+00:00")).timestamp()

for k,arr in pairs.items():
    if len(arr)<10: continue
    arr=sorted(map(to_epoch, arr))
    gaps=[arr[i+1]-arr[i] for i in range(len(arr)-1)]
    if len(gaps)>3:
        mean,cv=st.mean(gaps), st.pstdev(gaps)/(st.mean(gaps)+1e-9)
        if cv>0.5:  # 편차 큼: 스톰/장애/악의적 간섭 가능
            print("INTERVAL_ANOMALY",k,"mean",round(mean,3),"cv",round(cv,2),"n",len(arr))
```

### 22.4.5 경보/자동화(보수적)
- **등급 분류**
  - **Critical**: Modbus 쓰기(운전 중), PROFINET DCP-Set, DNP3 비정상 Role/대량 이벤트.
  - **High**: 신규 통신쌍(High-Value Asset 관련), 주기 편차↑, 지연 급증.
  - **Info**: 신규 자산 등장, 링크 flap 빈발.
- **액션**
  - **즉시 차단 지양**. 우선 **OT팀 페이지** + **운전 상황 확인** → **프록시/게이트웨이에서 쓰기 기능만 임시 차단**(읽기 유지).
  - **증거 보존**: 해당 흐름 PCAP 스냅샷(30–60s), eve.json/zeek 로그 링크.

**Elasticsearch Watcher(개념) — PROFINET DCP Set**
{% raw %}
```json
{
 "trigger":{"schedule":{"interval":"1m"}},
 "input":{"search":{"request":{"indices":["zeek-profinet-*"],"body":{
   "query":{"match":{"profinet.op":"DCP_SET"}},
   "aggs":{"by_dst":{"terms":{"field":"id.resp_h","size":10}}}
 }}}},
 "condition":{"compare":{"ctx.payload.aggregations.by_dst.buckets.0.doc_count":{"gt":0}}},
 "actions":{"notify":{"slack":{"message":{"to":["#ot-soc"],"text":"[CRIT] PROFINET DCP-SET on host {{ctx.payload.aggregations.by_dst.buckets.0.key}}"}}}}
}
```
{% endraw %}

### 22.4.6 운영 체크리스트
- [ ] **TAP/SPAN 문서화**(포트/스팬 소스/부하 영향 검토)
- [ ] **시간 동기(UTC/NTP)** — 설비/센서/수집기 **±1s**
- [ ] **룰/임계**는 **Site별** 튜닝(라인/벤더/주기 다름)
- [ ] **라벨링**: 설비 중요도(안전계/SIS/기능계/감시계), OT 구역/존(IEC 62443) 메타데이터
- [ ] **정기 리플레이**: 골든 PCAP로 대시보드/경보 회귀 테스트
- [ ] **비상 절차**: 쓰기 차단 프록시 룰 템플릿, 롤백 스크립트

---

## 부록 A. IEC 62443 맵핑(요약)
| 주제 | 62443 요구 | 본 장 대응 |
|---|---|---|
| 자산 식별 | 2-1, 3-2 | 패시브 인벤토리(Zeek/NetFlow), 라벨링 |
| 존/경로 | 3-2, 3-3 | 세그먼테이션, 허용목록 |
| 보안 수준 | SL-T | 쓰기 명령 차단, 프록시, 단방향 |
| 모니터링 | 3-3 SR 2.8 | OT-IDS, 대시보드, 경보 |
| 변경 관리 | 2-3 | MOC, 테스트베드, 롤백 |
| 대응/복구 | 2-4 | 보수적 IR, 증거 보존, 재가동 절차 |

## 부록 B. 현장 함정 & 팁
- **능동 스캔 유혹**: 짧은 Ping/Nmap도 **장비 리부트/고착** 사례 다수 → 금지.
- **포트 미러 오버서브스크립션**: 트래픽 폭주 시 **드롭** → 핵심 구간만 미러, 샘플링 병행.
- **멀티캐스트**: 모니터 미러에 멀티캐스트가 안 실리는 구성 주의.
- **네트워크 루프/스톰**: OT 스위치 STP/RSTP 설정 검증.
- **시간/단위**: ms/Hz 혼동으로 오탐. OT팀과 **주기 정의** 합의.

---

## 요약
- OT/ICS는 **가용성·실시간성**이 지배하는 환경으로, IT 보안의 상식을 **그대로** 적용하면 **안전 리스크**가 커진다.
- **패시브 디스커버리**와 **프록시/화이트리스트/세그먼트**가 핵심.
- **Modbus 쓰기/PROFINET DCP/DNP3 역할 역전** 같은 **행위 기반** 이상에 집중하라.
- 대시보드는 **주기·기능코드·신규 통신쌍**을 한눈에 보여줘야 하며, **차단은 보수적**으로—**운전팀과 합동**으로 처리한다.
- 모든 변경은 **MOC/테스트베드/롤백**을 동반해야 한다.
