---
layout: post
title: 네트워크보안 - 네트워크 탐지·NDR
date: 2025-10-27 22:25:23 +0900
category: 네트워크보안
---
# 네트워크 탐지·NDR

> 목표: **NIDS/NIPS/NDR** 개념과 **시그니처 vs 이상탐지**를 명확히 구분하고,
> **Suricata/Zeek**로 **L7 가시성**(HTTP/TLS/DNS/FTP/SMB 등)을 확보한다.
> **TLS 핑거프린트(JA3/JA4)·DNS 이상(DGA/NXDOMAIN 비율)·C2 행위(비콘/지터/URI 패턴)**를 탐지 규칙으로 구현하고,
> 마지막으로 **Zeek 로그→(Kafka/Logstash)→SIEM(Elastic/OpenSearch/Splunk)** 파이프라인을 **실습**으로 완성한다.

---

## NIDS/NIPS/NDR, 시그니처 vs 이상탐지

### 정의와 역할

- **NIDS (Network Intrusion Detection System)**
  패킷/플로우를 **미러(TAP/SPAN)**로 받아 **탐지만** 수행. 차단은 안 함.
- **NIPS (Network Intrusion Prevention System)**
  **인라인(브리지/L3)**로 배치되어 탐지 후 **차단/리셋**까지 수행.
- **NDR (Network Detection & Response)**
  NIDS/NIPS의 탐지 + **행위 분석/위협 헌팅/사후 대응(자동화 연계)**.
  보통 **풀 패킷(선택)** + **L7 메타데이터(Zeek/Suricata)** + **플로우(NetFlow/IPFIX)** + **위협 인텔**을 결합.

### 배치 토폴로지

- **SPAN/TAP 기반 NDR 센서**: 네트워크 스위치 미러 → **Suricata+Zeek** 동시 구동(멀티큐).
- **게이트웨이 앞단/내부 분리 경계**: **북-남**(인터넷 경계) + **동-서**(서브넷/세그먼트 간).
- **클라우드**: VPC 트래픽 미러링(AWS VPC Traffic Mirroring, GCP Packet Mirroring, Azure VTAP) → 센서 ENI로 수신.

### 시그니처 vs 이상탐지

| 구분 | 장점 | 단점 | 적용 포인트 |
|---|---|---|---|
| **시그니처**(룰/정규식) | 정밀·설명 가능·오탐 낮음 | **제로데이 약함**, 룰 관리 비용 | 알려진 IOC/패밀리/프로토콜 위반 |
| **이상탐지**(통계/ML) | **미지 위협** 조기 탐지 | **튜닝 난이도**, 해석 어려움 | 비콘/지터·DGA·JA3 outlier |

> 운영 현실: **시그니처(저비용·저오탐)로 1차 필터**, **이상탐지로 헌팅** + **히트→시그니처화** 루프.

### 데이터 소스 계층

- **패킷(PCAP)**: 진단·포렌식(선택 보존).
- **L7 메타**: **Zeek 로그(http.log, ssl.log, dns.log, files.log …)** → SIEM 질의의 **주력**.
- **플로우**: NetFlow/IPFIX/sFlow → **트래픽 베이스라인/탐지**.
- **엔드포인트/프록시/WAF/IDS**: 상호 보강·교차 확인.

---

## Suricata/Zeek로 L7 가시성 확보

### 센서 준비(리눅스, 멀티큐 NIC)

```bash
# Suricata 설치(예: Ubuntu)

sudo add-apt-repository ppa:oisf/suricata-stable -y
sudo apt update && sudo apt install -y suricata jq

# Zeek 설치(패키지 or 소스)

sudo apt install -y zeek  # 배포판에 따라 'bro'/'zeek' 패키지명 상이
zeek -v

# PF_RING/AF_PACKET 멀티큐 사용 권장(고속)
# /etc/suricata/suricata.yaml의 af-packet: cluster-type: cluster_flow, cluster-id: 98, tpacket-v3: yes

```

**Suricata 포인트**
- **IDS 모드**: `-i <iface>`(미러 인터페이스), **IPS 모드**: NFQUEUE/IPS 인라인(랩에서는 IDS 권장).
- **룰셋**: ET Open/Pro, 자체 룰.
- **출력**: `eve.json`(HTTP/TLS/DNS/Alert/Flow …) → Logstash/Filebeat 전송.

**Zeek 포인트**
- **패키지 관리자**: `zkg`로 스크립트 설치(ja3, intel, notice-policy 등).
- **출력**: 각 .log(탭 구분/NDJSON 설정 가능) → Kafka/Filebeat.

### Suricata 최소 설정 (eve.json)

```yaml
# /etc/suricata/suricata.yaml (요지)

af-packet:
  - interface: eth1
    cluster-type: cluster_flow
    cluster-id: 98
    defrag: yes
outputs:
  - eve-log:
      enabled: yes
      filetype: regular
      filename: /var/log/suricata/eve.json
      types:
        - alert
        - http
        - dns
        - tls
        - flow
        - files
        - stats
```

### Zeek 최소 설정 + JA3

```bash
# JA3 스크립트 설치

sudo zkg refresh
sudo zkg install zeek/ja3
# 로드 설정: site/local.zeek

echo '@load ja3' | sudo tee -a /opt/zeek/share/zeek/site/local.zeek

# 실행(단일 인터페이스)

sudo zeek -i eth1 local
# 로그 위치 기본: /opt/zeek/logs/current/{http.log, ssl.log, dns.log, ja3.log ...}

```

### 예시 룰/스크립트 (HTTP/TLS/DNS)

**Suricata – HTTP User-Agent/URI 시그니처**
```suricata
alert http any any -> any any (
  msg:"HTTP suspicious UA (python-requests/wget/curl)"; http.user_agent;
  content:"python-requests"; nocase;
  content:"wget"; nocase; distance:0; within:128;
  content:"curl"; nocase; distance:0; within:128;
  classtype:bad-unknown; sid:700001; rev:1;
)

alert http any any -> any any (
  msg:"C2 checkin URI pattern (/api/checkin)"; http.uri; content:"/api/checkin"; nocase;
  classtype:trojan-activity; sid:700002; rev:1;
)
```

**Suricata – DNS NXDOMAIN 과다 (소스별 웜업 규칙 예)**
```suricata
alert dns any any -> any any (
  msg:"DNS NXDOMAIN burst (possible DGA)";
  dns.query; content:".";
  dns.opcode:QUERY;
  dns.rcode: NXDOMAIN;
  detection_filter: track by_src, count 30, seconds 60;
  classtype:bad-unknown; sid:700003; rev:1;
)
```

**Zeek – HTTP 단순 비콘 탐지(시간·크기 패턴)**
```zeek
# site/beacon.zeek

@load base/protocols/http

module Beacon;
export {
  redef enum Notice::Type += { Beacon::Suspected };
}

const window = 60 secs;
const min_hits = 12;   # 60초에 12회 ~ 5초 주기
const max_var = 0.3;   # 크기·간격 분산 허용치(개념치)

type Hit: record {
  ts: time;
  size: count;
};

global by_host: table[string] of vector of Hit = table();

event http_entity_data(c: connection, is_orig: bool, length: count) {
  if (!is_orig) return; # 클라→서버만
  local k = fmt("%s->%s", c$id$orig_h, c$id$resp_h);
  local v = by_host[k];
  if (v == nil) v = vector() &create_expire=window { |v| clear_table(by_host); };
  v += [$ts=network_time(), $size=length];
  by_host[k]=v;

  if (|v| >= min_hits) {
    # 아주 러프한 분산 검사(실운영은 더 정교하게)
    local mean = 0.0;
    for (i in v) mean += double(v[i]$size);
    mean /= double(|v|);
    local var = 0.0;
    for (i in v) var += (double(v[i]$size) - mean)^2;
    var /= double(|v|);
    if (var < max_var) {
      NOTICE([$note=Beacon::Suspected,
              $msg=fmt("HTTP beacon? %s count=%d", k, |v|),
              $conn=c]);
    }
  }
}
```
적용:
```bash
echo '@load site/beacon.zeek' | sudo tee -a /opt/zeek/share/zeek/site/local.zeek
sudo zeek -i eth1 local
```

---

## TLS 핑거프린트·DNS 이상·C2 행위

### TLS 지문 (JA3/JA4)

- **JA3**: TLS ClientHello의 `version,ciphers,extensions,elliptic_curves,ec_point_formats`를 해시.
- **JA4/JA4S**: TCP/TLS 핸드셰이크에 더 많은 신호를 포함한 최신 지문 체계.
- **활용**:
  - **블랙리스트 매칭**: 알려진 악성 패밀리 JA3 해시를 **차단/알림**.
  - **허용목록**: 기업 표준 클라이언트(브라우저/에이전트)의 JA3 세트를 **화이트리스트**로.
  - **이상치**: 정상군(브라우저/OS) 대비 드문 지문 → **헌팅 후보**.

**Zeek ja3.log 예(필드)**
`ts, uid, id.orig_h, id.resp_h, ja3, ja3s, ssl.version, server_name(SNI) ...`

**SIEM KQL 예(Elastic) — 드문 JA3 Top N**
```kql
index:zeek-ja3-*
NOT ja3.keyword : ("<정상_리스트_1>","<정상_리스트_2>", ...)
| stats count() by ja3, id.orig_h, id.resp_h
| sort by count desc
```

### DNS 이상 (DGA/NXDOMAIN/TTL/엔트로피)

- **지표**:
  - **NXDOMAIN 비율 급증**(src 또는 host 기준)
  - **엔트로피 높은 2LD/3LD**(영숫자 장문)
  - **짧은 TTL** 반복(플럭싱)
  - **DoH/DoT 무단 사용**(비허용 엔드포인트로 TLS 443/853)

**Zeek dns.log로 DGA 의심 추출(간단 Python)**
```python
import math, re, sys, csv

def H(s):
    from collections import Counter
    c=Counter(s); n=len(s)
    return -sum((k/n)*math.log2(k/n) for k in c.values())

sus=[]
with open('dns.log','r',encoding='utf-8',errors='ignore') as f:
    rd=csv.DictReader((line for line in f if not line.startswith('#')), delimiter='\t')
    for r in rd:
        q=r.get('query','')
        name=q.split('.')[0].lower()
        if len(name)>=15:
            ent=H(re.sub(r'[^a-z0-9]','',name))
            if ent>3.6:
                sus.append((r['ts'], r['id.orig_h'], q, f"{ent:.2f}"))

for t,src,q,e in sus[:50]:
    print(t, src, q, e)
```

### C2 행위 (비콘/지터/URI/헤더)

- **비콘**: 일정/지터 간격(예: 60±10s)로 작은 HTTP/TLS 요청.
- **HTTP 패턴**: 고정 `User-Agent`, `/checkin`, `/tasks`, Base64 파라미터.
- **TLS/SNI**: 난수형 서브도메인 + 고정 JA3.
- **차단/헌팅 전략**:
  - **NDR 알림 → 프록시/WAF 룰 바로 반영**(헤더/경로 필터, JA3 차단).
  - **Egress 제어**: **FQDN 허용목록**, 승인된 DoH/DoT만 허용.

**Suricata — JA3 매칭(ips답변용 예)**
```suricata
alert tls any any -> any any (
  msg:"JA3 blacklist match";
  tls.ja3_hash; content:"769be..." ;   # 예시 해시
  priority:1; classtype:trojan-activity; sid:700010; rev:1;
)
```

---

## 실습: Zeek 로그 → SIEM 파이프라인

> **목표**: 테스트 PCAP을 **tcpreplay**로 흘려 **Zeek/Suricata**가 L7 로그를 생성 →
> **Filebeat or Kafka→Logstash**로 **Elastic/OpenSearch**에 적재 → **대시보드·경보**까지.

### 랩 토폴로지 (단일 호스트)

```
[tcpreplay] -> [mirror NIC eth1]
                 ├─ Suricata (eve.json)
                 └─ Zeek (dns/http/ssl/ja3 logs)
                     \
                      -> Filebeat → Logstash → Elasticsearch/Kibana
```

### PCAP 재생

```bash
sudo apt install -y tcpreplay
sudo tcpreplay -i eth1 --mbps=50 sample.pcap
```
> `sample.pcap`에는 HTTP/TLS/DNS 트래픽이 포함된 합법 샘플을 사용(자체 생성 또는 공개 PCAP).

### Filebeat로 Zeek/Suricata 수집

```yaml
# filebeat.yml (요지)

filebeat.inputs:
- type: filestream
  id: zeek-logs
  enabled: true
  paths:
    - /opt/zeek/logs/current/*.log
  parsers:
    - ndjson:
        overwrite_keys: true
        add_error_key: true
        # Zeek는 탭 구분이 기본 → 필요 시 'zeek-json' 출력 사용 권장
output.logstash:
  hosts: ["127.0.0.1:5044"]
```

> 권장: Zeek를 **JSON 출력**으로 바꾸면 파싱이 용이(zeek-json 패키지 또는 `-W` 옵션/`LogAscii::use_json`).

### Logstash 파이프라인

```conf
# /etc/logstash/conf.d/ndr.conf

input {
  beats { port => 5044 }
}

filter {
  # 메시지 유형에 따라 분기(예: Zeek dns/http/ssl, Suricata eve.json)
  if "suricata" in [log][file][path] or "eve.json" in [log][file][path] {
    json { source => "message" target => "suricata" }
    mutate { add_field => { "event.module" => "suricata" } }
  } else if "zeek" in [log][file][path] {
    # 탭구분 처리(필요시 csv 필터 사용)
    # 또는 이미 JSON이면 json 필터
  }
  date { match => ["ts","UNIX","ISO8601"] target => "@timestamp" }
}

output {
  elasticsearch {
    hosts => ["http://127.0.0.1:9200"]
    index => "ndr-%{+YYYY.MM.dd}"
  }
  stdout { codec => rubydebug }
}
```

### Elasticsearch 인덱스·탐지(예시 KQL/SPL)

**Kibana KQL – NXDOMAIN 급증**
```kql
index:ndr-*
event.module : "suricata" and suricata.dns.rcode : "NXDOMAIN"
| stats count() by suricata.src_ip, window=1m
| where count > 30
```

**Kibana KQL – 드문 JA3**
```kql
index:ndr-* and event.module:"zeek" and ja3.keyword: *
| stats count() by ja3
| sort by count asc
| limit 50
```

**Splunk SPL – 비콘 후보(고정 주기)**
```spl
index=ndr sourcetype=zeek_http
| bin _time span=5s
| stats count by src_ip, dest_ip, _time
| stats stdev(count) as sdev, avg(count) as avg by src_ip, dest_ip
| where sdev < 0.5 AND avg > 5
| sort - avg
```

### 알림/자동화(Watcher or ElastAlert/Rule Engine)

- 조건:
  - `NXDOMAIN` 비율 초과(소스 IP 기준)
  - 블랙리스트 JA3 매칭
  - Zeek NOTICE: `Beacon::Suspected` 발생
- 액션: Slack/Teams Webhook, JIRA 티켓, SOAR 플레이북(프록시 블록·FW Address-Group 갱신)

**Elasticsearch Watcher(개념)**
{% raw %}
```json
{
 "trigger": {"schedule":{"interval":"1m"}},
 "input":   {"search":{"request":{"indices":["ndr-*"],"body":{
   "query":{"bool":{"must":[{"match":{"suricata.dns.rcode":"NXDOMAIN"}}]}},
   "aggs":{"by_src":{"terms":{"field":"suricata.src_ip","size":100}}}
 }}}},
 "condition":{"compare":{"ctx.payload.aggregations.by_src.buckets.0.doc_count":{"gt":30}}},
 "actions":{"notify":{"slack":{"message":{"to":["#soc"],"text":"DNS NXDOMAIN burst: {{ctx.payload.aggregations.by_src.buckets.0.key}}"}}}}
}
```
{% endraw %}

---

## 부록 A. 성능·스케일링 팁

- **멀티큐 NIC + RSS**: Suricata `cluster_flow`, Zeek **PF_RING/DPDK**(필요 시).
- **압축 로테이션**: PCAP/로그 압축 + S3/오브젝트로 아카이브.
- **Kafka 중간 버스**: Zeek → Kafka → (ksqlDB/Logstash) → SIEM(대규모에 유리).
- **필드 표준화**: ECS(Elastic Common Schema) or 고객 스키마 문서화.

## 부록 B. 위협 인텔/IOC 연동

- **Zeek intel** 프레임워크: 도메인/IP/JA3 IOC → `intel.log` 히트 기록.
- Suricata **reputation**: `reputation-categories`, `reputation-files`로 IP 평판.
- **자동 IOC 동기화**: MISP/OTX → Job으로 주기 반영.

```zeek
# site/intel.zeek

@load policy/frameworks/intel/seen
redef Intel::read_files += { "/opt/zeek/etc/intel.dat" };
```

`intel.dat` 예:
```
#type,indicator,comment

Intel::ADDR,185.199.111.153,otx_mal_c2
Intel::DOMAIN,bad-dga.example,custom_list
Intel::JA3,769be...,"famX JA3"
```

## 부록 C. 품질/오탐 관리

- **튜닝 루프**: 알람 → 티켓 → 라벨(진짜/오탐) → 규칙 수정 → 회귀테스트.
- **골든 PCAP 세트**: 정상/공격 시나리오 10~20개, CI에서 `tcpreplay`하여 파이프라인 검증.
- **설명가능성**: 헌팅 결과에 **근거(로그 필드/규칙 ID/지문)**를 첨부.

## 부록 D. 흔한 문제와 빠른 점검

| 증상 | 원인 | 대처 |
|---|---|---|
| eve.json/zeek 로그가 비어있음 | 인터페이스/미러 연결 오류 | `tcpdump -i eth1 -c 10`으로 패킷 유무 확인 |
| Dropped Packets 증가 | CPU/디스크 병목 | 멀티큐/핵심 바인딩, 로그 버퍼·압축, 빠른 디스크 |
| JA3가 안 찍힘 | TLS 검사 비활성/스クリפט 미적용 | `@load ja3` 확인, `ssl.log`와 연동 |
| NXDOMAIN 알람 과다 | 개발/테스트 도메인 | 화이트리스트(빌드 서버/테스트 영역) 적용 |

---

## 요약

- **NDR**은 **패킷/메타/플로우**를 결합해 **가시성→탐지→대응**을 잇는다.
- **Suricata**는 **시그니처/프로토콜 위반**에 강하고, **Zeek**는 **풍부한 L7 메타**로 **행위 기반 헌팅**에 최적.
- **TLS JA3/JA4·DNS DGA/NXDOMAIN·HTTP 비콘**은 현대 C2의 핵심 단서다.
- **Zeek/Suricata → SIEM** 파이프라인을 코드로 관리하고(파일비트/로그스태시/KQL/SPL),
  **알람→튜닝→시그니처화**의 피드백 루프를 돌리면 **운영 가능한 NDR**이 완성된다.
