---
layout: post
title: 시스템보안 - 실습(랜섬웨어 TTP 타임라인 복원 & 탐지 룰 작성)
date: 2025-10-30 23:30:23 +0900
category: 시스템보안
---
# 16.3 실습: 랜섬웨어 TTP 타임라인 복원 & 탐지 룰 작성

## 16.3.1 목표 & 시나리오

**목표**
1) 감염 전후/중간 단계별 **TTP 타임라인**을 복원 (Windows 중심 + Linux 보조).  
2) 그 타임라인을 기반으로 **탐지 규칙**(Sigma → KQL/SPL/ES DSL)과 **상관 규칙**을 작성.  
3) **오탐/미탐** 튜닝 포인트를 문서화.

**모의 시나리오(교육용)**
- 초기 실행: `sim-ransom.exe` (우리가 만든 benign 시뮬레이터, 파일명만 해당)  
- 방어 회피 시도: **볼륨 섀도우 삭제 명령**(실행은 mock), **복구/부팅 설정 변경 시도(log only)**  
- 대량 파일 처리: 폴더 내 파일을 **사본 생성 + 가짜 확장자 부여**(암호화 미수행)  
- 메모 남김: `README_RECOVER_FILES.txt` 생성(실제 악성 본문 X)

---

## 16.3.2 데이터 수집 준비(Windows)

### (1) Windows 보안 이벤트 & 고해상도 텔레메트리
- **Security**: 4688(프로세스), 4624/4625(로그온), 4697 & System 7045(서비스 등록)  
- **Sysmon**: 1(프로세스), 11(파일 생성), 13(레지스트리 Set), 22(DNS), 3(네트워크)  
- **ETW**(선택): Kernel-Process, Kernel-File, PowerShell Operational

**권장 Sysmon 스니펫**(요지)
```xml
<Sysmon schemaversion="4.90">
  <HashAlgorithms>sha256</HashAlgorithms>
  <EventFiltering>
    <ProcessCreate onmatch="include">
      <CommandLine condition="contains">vssadmin</CommandLine>
      <CommandLine condition="contains">wbadmin</CommandLine>
      <CommandLine condition="contains">bcdedit</CommandLine>
      <CommandLine condition="contains">wmic shadowcopy</CommandLine>
      <CommandLine condition="contains">-enc</CommandLine>
      <Image condition="end with">powershell.exe</Image>
    </ProcessCreate>
    <FileCreate onmatch="include">
      <TargetFilename condition="end with">README*.txt</TargetFilename>
      <TargetFilename condition="end with">*.locked</TargetFilename>
      <TargetFilename condition="end with">*.encrypted</TargetFilename>
    </FileCreate>
    <NetworkConnect onmatch="include">
      <DestinationPort condition="is">4444</DestinationPort>
      <DestinationIp condition="ends with">.onion</DestinationIp>
    </NetworkConnect>
  </EventFiltering>
</Sysmon>
```

---

## 16.3.3 모의 시뮬레이터(무해)

### (A) Windows PowerShell — **파일 처리/노트 생성**(무해)
```powershell
# sim-ransom.ps1 (무해: 암호화 안 함, 사본 + 확장자만 바꿈)
param(
  [string]$Root = "$env:USERPROFILE\Documents\demo",
  [string]$Ext  = ".locked",
  [int]$MaxFiles = 500
)

$ErrorActionPreference = "SilentlyContinue"
New-Item -ItemType Directory -Force -Path $Root | Out-Null

# (1) 방어 회피 시그널(실행은 echo만; 실제 실행 금지)
"vssadmin delete shadows /all /quiet" | Out-File "$Root\__sim_cmd.txt" -Encoding ascii
"wbadmin delete catalog -quiet" | Out-File "$Root\__sim_cmd2.txt" -Encoding ascii
"bcdedit /set {default} recoveryenabled No" | Out-File "$Root\__sim_cmd3.txt" -Encoding ascii

# (2) 더미 파일 생성
1..50 | ForEach-Object {
  "hello $_" | Out-File "$Root\file$_.txt" -Encoding utf8
  "dummy $_" | Out-File "$Root\report$_.docx" -Encoding utf8
  "image $_" | Out-File "$Root\photo$_.jpg" -Encoding utf8
}

# (3) '암호화' 시뮬: 사본 + 확장자 부여
$all = Get-ChildItem $Root -File | Select-Object -First $MaxFiles
foreach($f in $all){
  Copy-Item $f.FullName "$($f.FullName)$Ext" -Force
}

# (4) 랜섬노트 생성
@"
All your files have been copied & renamed (SIMULATION).
This is benign. Use this dataset to test detections.
"@ | Out-File "$Root\README_RECOVER_FILES.txt" -Encoding utf8

Write-Host "Simulation completed at $Root"
```

### (B) Linux — **inotify/auditd용 더미 활동**
```bash
# sim-ransom.sh (무해)
ROOT="$HOME/demo"
mkdir -p "$ROOT"
for i in $(seq 1 50); do
  echo "hello $i" > "$ROOT/file$i.txt"
  cp "$ROOT/file$i.txt" "$ROOT/file$i.txt.locked"
done
echo "SIM note" > "$ROOT/README_RECOVER_FILES.txt"
```

---

## 16.3.4 타임라인 복원(Windows 예시)

### (A) KQL(센티넬) — **단일 호스트 타임라인**
```kusto
let hostName = "WS-001";
let timeSpan = 2h;
let startTime = ago(timeSpan);
let suspiciousImages = dynamic(["powershell.exe","cmd.exe","wscript.exe","cscript.exe"]);
let ransomExt = dynamic([".locked",".encrypted",".crypt"]);
let noteNames = dynamic(["readme","recover","how_to","decrypt","help"]);

let proc = (
  union isfuzzy=true
  (SecurityEvent | where EventID == 4688 | project TimeGenerated, Computer, User=tostring(SubjectUserName), Image=tostring(TargetFileName), CommandLine, ParentProcessName, EventID),
  (Sysmon | where EventID == 1 | project TimeGenerated, Computer, User, Image, CommandLine, ParentImage=ParentImage, EventID)
)
| where Computer == hostName and TimeGenerated > startTime
| extend ImageName = tolower(split(Image,"\\")[-1]);

let fileOps = (
  Sysmon
  | where EventID == 11 and Computer == hostName and TimeGenerated > startTime
  | extend fn = tostring(TargetFilename), lowerfn = tolower(fn)
  | extend is_note = iif(lowerfn has_any (noteNames) and lowerfn endswith ".txt", 1, 0)
  | extend is_locked = iif(lowerfn matches regex @".*\.(locked|encrypted|crypt)$", 1, 0)
  | project TimeGenerated, Computer, EventID, TargetFilename=fn, is_note, is_locked
);

let delShadows = (
  proc
  | where ImageName in (suspiciousImages) and CommandLine has_any ("vssadmin","wbadmin","bcdedit")
  | project TimeGenerated, Computer, Event="ShadowCopy/BootCfg Attempt", Actor=ImageName, CommandLine
);

let massRename = (
  fileOps
  | summarize locked=countif(is_locked==1), notes=countif(is_note==1) by bin(TimeGenerated, 1m), Computer
  | where locked > 20 or notes > 0
  | project TimeGenerated, Computer, Event=strcat("Mass rename: ", tostring(locked), " locked; notes=", tostring(notes))
);

union delShadows, massRename
| sort by TimeGenerated asc
```

### (B) SPL(스플렁크) — **5분 단위 대량 파일 변조 감지**
```spl
index=sysmon EventCode=11 host=WS-001 earliest=-2h
| eval lower=lower(TargetFilename)
| eval is_note=if(match(lower,"(readme|recover|decrypt|how_to|help).*\.txt$"),1,0)
| eval is_locked=if(match(lower,"\.locked$|\.encrypted$|\.crypt$"),1,0)
| bin _time span=1m
| stats sum(is_locked) as locked sum(is_note) as notes by _time host
| where locked>20 OR notes>0
| sort _time
```

### (C) “섀도우 삭제/부팅설정 변경 시도” 탐지(명령행 기반)

**Sigma**
```yaml
title: Ransomware Pre-Encryption Recovery Removal Attempts
id: 7b9620d6-4e6c-4b3d-9f5a-ransom-vss
status: test
logsource:
  product: windows
  category: process_creation
detection:
  selection:
    CommandLine|contains:
      - 'vssadmin'
      - 'wbadmin'
      - 'bcdedit /set {default} recoveryenabled'
      - 'wmic shadowcopy'
  condition: selection
level: high
fields: [Image, CommandLine, ParentImage, User]
tags: [attack.defense-evasion, attack.impact]
```

**KQL**
```kusto
SecurityEvent
| where EventID == 4688
| where CommandLine has_any ("vssadmin","wbadmin","wmic shadowcopy","bcdedit /set {default} recoveryenabled")
| project TimeGenerated, Computer, User=tostring(SubjectUserName), Image=tostring(TargetFileName), CommandLine, ParentProcessName
```

**SPL**
```spl
index=winsec EventCode=4688
| search CommandLine="*vssadmin*" OR CommandLine="*wbadmin*" OR CommandLine="*wmic shadowcopy*" OR CommandLine="*bcdedit /set {default} recoveryenabled*"
| table _time host SubjectUserName TargetFileName CommandLine ParentProcessName
```

---

## 16.3.5 “대량 확장자 변경 + 랜섬노트” 상관 규칙

**KQL (상관: 1분 내 ‘locked 확장자 50개 이상’ AND ‘노트 1개 이상’ AND ‘선행 vssadmin 시도’ )**
```kusto
let win = 5m;
let mass = (
  Sysmon
  | where EventID==11
  | extend lf=tolower(tostring(TargetFilename))
  | summarize locked=countif(lf matches regex @".*\.(locked|encrypted|crypt)$"),
              notes=countif(lf has_any ("readme","decrypt","recover","help") and lf endswith ".txt")
              by Computer, bin(TimeGenerated, 1m)
  | where locked >= 50 and notes >= 1
);
let pre = (
  SecurityEvent
  | where EventID==4688 and CommandLine has_any ("vssadmin","wbadmin","bcdedit","wmic shadowcopy")
  | summarize preAttempt=min(TimeGenerated) by Computer, bin(TimeGenerated, 5m)
);
mass
| join kind=innerunique (pre) on Computer
| where mass.TimeGenerated between (pre.TimeGenerated - 1m .. pre.TimeGenerated + win)
| project Computer, mass.TimeGenerated, locked, notes, preTime=pre.TimeGenerated
```

**SPL**
```spl
# mass
index=sysmon EventCode=11 earliest=-1h
| eval fn=lower(TargetFilename)
| bin _time span=1m
| stats sum(eval(match(fn,"\.locked$|\.encrypted$|\.crypt$"))) as locked,
        sum(eval(match(fn,"(readme|decrypt|recover|help).*\.txt$"))) as notes by host _time
| where locked>=50 AND notes>=1
| rename _time as mass_time
| join type=inner host [ search index=winsec EventCode=4688 earliest=-1h
                         | search CommandLine="*vssadmin*" OR CommandLine="*wbadmin*" OR CommandLine="*bcdedit*" OR CommandLine="*wmic shadowcopy*"
                         | bin _time span=5m
                         | stats earliest(_time) as pre_time by host ]
| where mass_time>=pre_time-60 AND mass_time<=pre_time+300
| table mass_time host locked notes pre_time
```

---

## 16.3.6 Linux 보조 헌팅

**auditd — ‘.locked’ 파일 급증**
```bash
# 규칙 (execve + 특정 디렉토리 감시)
-a always,exit -F arch=b64 -S execve -k exec
-w /home -p wa -k filechg
```

**SPL**
```spl
index=linux-audit (key=filechg OR type=PATH)
| eval is_locked=if(match(lower(file_path),"\.locked$|\.encrypted$|\.crypt$"),1,0)
| bin _time span=1m
| stats sum(is_locked) as locked by host _time
| where locked>50
| sort _time
```

---

## 16.3.7 결과물: 타임라인 표(예)

| 시각(UTC) | 호스트 | 이벤트 | 근거(로그) |
|---|---|---|---|
| 10:01:05 | WS-001 | 프로세스 시작 `powershell.exe` | Sysmon1 (Image, Cmd: sim-ransom.ps1) |
| 10:01:07 | WS-001 | 섀도우 삭제 명령 시도 | Sec 4688 (Cmd: vssadmin …) |
| 10:02:10 | WS-001 | 대량 파일 사본 `.locked` 생성 | Sysmon11 (count/min>50) |
| 10:02:12 | WS-001 | `README_RECOVER_FILES.txt` 생성 | Sysmon11 (TargetFilename) |
| 10:03:00 | WS-001 | (옵션) 외부 통신 | Sysmon3 (C2 포트/도메인) |

---

## 16.3.8 오탐/미탐 튜닝

- **오탐**: 대량 변환/백업/미디어 인덱싱 → 확장자 단어/경로 화이트리스트(백업 SW 경로, 포토/비디오 인덱서).  
- **미탐**: 랜섬노트 이름 변형(랜덤), 확장자 미변경형 랜섬(원본 삭제 후 암호화 파일만 생성) → **쓰기 속도/삭제 패턴**도 함께 사용.  
- **명령행 우회**: `vssadmin` 문자열 분절(`v s s a d m i n`) → **토큰화 아닌 정규식/유사도** 병행, **Sysmon 1 + DNS/Net** 상관.

---

# 16.4 방어: 경보 피로 관리, 공통 스키마, 테스트 데이터 생성

## 16.4.1 경보 피로(Alert Fatigue) 관리 프레임워크

### (A) 4단 구조
1) **집계(Aggregation)**: 동일 규칙/호스트/사용자/분 단위 이벤트 **버스팅** → 1건으로 묶음  
2) **디듀프(Dedup)**: 동일 해시/명령행 반복은 **카운트 증가 필드**만 업데이트  
3) **억제(Suppression)**: **유지보수/백업 시간대**의 예상 패턴은 **저위험/무경보**  
4) **우선순위(Scoring)**: **선행 신호**(섀도우 삭제) + **결정적 신호**(대량 확장자 변경) 조합시 **High**

**KQL — 집계 & 디듀프**
```kusto
let base =
Sysmon
| where EventID==11
| extend fn=tolower(tostring(TargetFilename))
| where fn matches regex @".*\.(locked|encrypted|crypt)$";
base
| summarize cnt=count(), any_fn=any(fn) by Computer, bin(TimeGenerated, 1m)
| extend severity = iif(cnt>200, "High", iif(cnt>50, "Medium", "Low"))
```

**SPL — 억제(시간대)**
```spl
... | where date_wday!="saturday" AND date_wday!="sunday"
    | where NOT (date_hour>=2 AND date_hour<4)  # 백업시간 억제
```

### (B) 티켓/플레이북 연결
- **Medium 이상**: IR 티켓 자동 생성 → 자산 분류(서버/워크스테이션), 사용자 연락, EDR 격리 옵션.  
- **High**: 네트워크 격리/컨테이먼트 플레이북 자동 실행(승인 기반).

---

## 16.4.2 공통 스키마 설계(정규화)

### (A) 핵심 필드 매핑
- `@timestamp`(UTC), `host.name`, `user.name`, `event.provider`, `event.id`, `event.action`  
- 프로세스: `process.name`, `process.executable`, `process.pid`, `process.parent.*`, `process.command_line`, `process.hash.sha256`, `process.integrity_level`  
- 파일: `file.path`, `file.name`, `file.extension`, `file.hash.sha256`, `file.action`(create/write/delete/rename)  
- 네트워크: `source.ip/port`, `destination.ip/port`, `protocol`, `dns.question.name`  
- 윈도우 보안 이벤트 → `SecurityEvent.*` 필드에서 **공통으로 치환** (예: `TargetFileName` → `process.executable`)

**Logstash/Vector/Fluent Bit 파서 예시(개념)**
```ini
[FILTER]
  Name          modify
  Match         win.security
  Rename        winlog.event_id event.id
  Rename        winlog.channel  event.provider
  Add           event.category  process
  # ...
```

### (B) 상관을 위한 보강(Enrichment)
- **자산 DB**(CMDB/Intune) 조인: 중요도/부서/소유자  
- **서명 정보**(Trusted/Unsigned) → 오탐 필터  
- **위협 인텔**(도메인/IP) → 가중치 부여

---

## 16.4.3 테스트 데이터 생성

### (A) **합성 로그 생성기**(Windows Sysmon 스타일)
```python
# gen_fake_ransom_logs.py (ELK로 보낼 JSON 라인 생성)
import json, random, time, hashlib, os
from datetime import datetime, timedelta

HOST="WS-001"
START=datetime.utcnow()

def sysmon11_event(ts, path):
    return {
      "@timestamp": ts.isoformat()+"Z",
      "event": {"id": 11, "provider":"Microsoft-Windows-Sysmon"},
      "host":{"name":HOST},
      "TargetFilename": path
    }

def sysmon1_event(ts, img, cmd, parent):
    return {
      "@timestamp": ts.isoformat()+"Z",
      "event":{"id":1,"provider":"Microsoft-Windows-Sysmon"},
      "host":{"name":HOST},
      "Image": img, "CommandLine": cmd, "ParentImage": parent
    }

out=[]
t=START
# 선행 신호
out.append(sysmon1_event(t, r"C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe",
                         "powershell.exe -nop -w hidden -c vssadmin delete shadows /all /quiet","explorer.exe"))
t+=timedelta(seconds=5)
# 대량 파일
for i in range(120):
    p = fr"C:\Users\User\Documents\demo\file{i}.txt.locked"
    out.append(sysmon11_event(t, p))
    t+=timedelta(seconds=random.uniform(0.1,0.5))
# 노트
out.append(sysmon11_event(t, r"C:\Users\User\Documents\demo\README_RECOVER_FILES.txt"))

with open("fake_sysmon.jsonl","w",encoding="utf8") as f:
    for e in out: f.write(json.dumps(e)+"\n")
print("Wrote fake_sysmon.jsonl")
```

> 이 파일을 **Filebeat/Fluent Bit**의 파일 입력으로 넣어 **파이프라인/탐지**를 회귀 테스트.

### (B) **pcap 재생 + DNS**(선택)
- benign 도메인으로 길이 큰 서브도메인 요청을 생성하여 DNS 터널 탐지 룰 테스트.

---

## 16.4.4 품질관리: 규칙 테스트 & 회귀 자동화

### (A) Sigma CI 파이프라인
- `sigma/` 폴더에 규칙 저장 → `sigma-cli`로 KQL/SPL 변환 → **테스트 로그**(위 jsonl) 투입 → **결과 ≥ 1** 확인.

**의사 Bash**
```bash
sigma-cli convert -t sentinel -o build/kql ./sigma/**/*.yml
sigma-cli convert -t splunk  -o build/spl ./sigma/**/*.yml
# 테스트: Sentinel/Splunk API 또는 로컬 엔진/샘플 검증 스크립트
python test_rules_against_logs.py --logs fake_sysmon.jsonl --kql build/kql
```

### (B) KQL 유닛 비슷한 테스트(개념)
- Log Analytics **테이블에 테스트 인덱스**로 주입 → KQL 쿼리 실행 → 행수 검증.

---

## 16.4.5 운영 플레이북(핵심)

1) **탐지 히트** → 자동 상관: (섀도우 삭제 시도) + (대량 확장자 변경) + (랜섬노트)  
2) **자산 중요도 평가** → 중요 서버/PAW면 **즉시 격리** 후보  
3) **EDR 액션**: 프로세스 킬/네트워크 격리/샘플 원본 보존  
4) **복구**: 백업 무결성 확인, 영향 범위 도출(폴더/사용자), 사용자 커뮤니케이션 템플릿  
5) **사후**: IOC 피드 업데이트, 룰/화이트리스트 조정, 훈련 피드백 반영

---

## 16.4.6 실전 튜닝 체크리스트

- [ ] **대량 파일 임계값**: 조직 규모/사용 패턴에 맞게 조정(예: 1분 50→200)  
- [ ] **예외 경로**: 백업/미디어 인덱서/AV 캐시 경로 화이트리스트  
- [ ] **언어/로캘 변형 랜섬노트** 키워드 확장  
- [ ] **우회 토큰화**: 공백/문자 분산, unicode 동형 이의 처리(정규화)  
- [ ] **경보 억제**: 주간 스케줄/점검 창구에 맞는 억제 룰  
- [ ] **조인 윈도우**: 선행-결정 신호 간 시간창 튜닝(3~10분)

---

# 부록 A. 추가 Sigma 룰(발췌)

**대량 확장자 변경(엔드포인트 에이전트 이벤트 맵 가정)**
```yaml
title: Mass Extension Change - Potential Ransom Activity
id: 8b3e6a12-e2f7-44b2-8a22-mass-ext
status: test
logsource:
  product: windows
  service: sysmon
detection:
  sel:
    EventID: 11
    TargetFilename|endswith:
      - '.locked'
      - '.encrypted'
      - '.crypt'
  timeframe: 1m
  condition: sel | count() by Computer > 50
level: high
```

**랜섬노트 드롭**
```yaml
title: Ransom Note Dropped
id: 4fdc12a1-2a11-4d25-9c2e-note
status: test
logsource:
  product: windows
  service: sysmon
detection:
  sel:
    EventID: 11
    TargetFilename|contains:
      - 'readme'
      - 'recover'
      - 'decrypt'
      - 'how_to'
      - 'help'
  cond: sel and TargetFilename|endswith: '.txt'
level: medium
```

---

# 결론

- **타임라인 복원**은 “선행 방어 회피 신호(섀도우 삭제 등)” + “대량 파일 변조/노트 드롭”의 **연속성**을 포착하는 것으로 시작합니다.  
- **Sigma → KQL/SPL** 자동 변환과 **합성 로그/시뮬레이터**를 이용한 **회귀 테스트**로 탐지 품질을 지속 개선하십시오.  
- **경보 피로**는 집계/디듀프/억제/스코어링의 4단 구조, **공통 스키마**는 상관의 전제, **테스트 데이터 생성**은 운영 안정성의 핵심입니다.
