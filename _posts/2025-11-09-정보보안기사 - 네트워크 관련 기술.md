---
layout: post
title: 정보보안기사 - 네트워크 관련 기술
date: 2025-11-09 16:25:23 +0900
category: 정보보안기사
---
# SECTION 04 네트워크 기본 학습 — 08. 네트워크 관련 기술

## NAT/PAT — 주소 보전·경계 제어의 사실상 표준

### NAT 개요와 유형

| 유형 | 방향 | 설명 | 예 |
|---|---|---|---|
| **SNAT** | 내부 → 외부 | **소스 IP/포트** 변환. 내부 사설 IP를 공인 IP로 변환 | 다수 호스트의 인터넷 접속 |
| **DNAT(포트포워딩)** | 외부 → 내부 | **목적지 IP/포트** 변환. 외부에서 내부 서비스 접근 | 203.0.113.10:80 → 192.168.10.100:80 |
| **PAT(NAPT)** | 내부 → 외부 | 포트 기반 다중화(1:N) | 공인 1개로 다수 세션 동시 사용 |
| **풀/1:1** | 내부 ↔ 외부 | 주소 풀 매핑 | DMZ 서버 다수 공인 IP 매핑 |

> 보안 메모: NAT는 **보안 기술이 아니라 주소 변환**이다. 인입 제어는 **방화벽 정책**이 담당.

### Linux nftables/iptables 예시

```bash
# 포워딩 활성화

sysctl -w net.ipv4.ip_forward=1
```

**nftables**
```bash
nft add table ip nat
nft add chain ip nat prerouting  { type nat hook prerouting  priority -100; }
nft add chain ip nat postrouting { type nat hook postrouting priority  100; }

# SNAT (고정 공인 IP)

nft add rule ip nat postrouting oifname "wan0" snat to 203.0.113.10

# MASQUERADE (동적 IP)

nft add rule ip nat postrouting oifname "ppp0" masquerade

# DNAT 80 → 내부 웹

nft add rule ip nat prerouting iifname "wan0" tcp dport 80 dnat to 192.168.10.100
```

**iptables**
```bash
iptables -t nat -A POSTROUTING -o wan0 -j SNAT --to-source 203.0.113.10
iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE
iptables -t nat -A PREROUTING  -i wan0 -p tcp --dport 80 \
         -j DNAT --to-destination 192.168.10.100
```

### NAT와 ICMP/PMTUD·알고 있어야 할 문제들

- **PMTUD**: DF=1 경로에서 **ICMP Frag Needed(Type 3/4)**가 **NAT/방화벽에 의해 드롭**되면 대용량 전송이 멈춘다(“블랙홀”). → **RELATED ICMP 허용** 필수.
- **세션/포트 고갈**: 대규모 동시접속 서비스(프록시·LB 뒤)에서 PAT 포트 고갈 가능 → **포트 범위 증설, 다중 공인 IP 풀, ECMP** 등 설계.
- **ALG/미들박스**: 일부 장비가 FTP/SIP 등 애플리케이션 페이로드를 수정. 호환성 문제 발생 가능.

---

## 프록시/로드밸런서 — L4 vs L7, 알고리즘·보건검사·TLS 처리

### L4 vs L7

| 구분 | L4(전송계층) | L7(애플리케이션) |
|---|---|---|
| 기준 | IP/Port(5-튜플) | URL/헤더/쿠키/콘텐츠 |
| 장점 | 고성능, 단순, 작은 지연 | 세밀한 라우팅, A/B, WAF 연계 |
| 단점 | 애플리케이션 인식 없음 | 처리비용↑, 튜닝 필요 |
| 예 | IPVS/Envoy-L4, AWS NLB | Nginx/Envoy/HAProxy, AWS ALB |

### 부하분산 알고리즘

| 알고리즘 | 설명 | 쓰임새 |
|---|---|---|
| Round Robin | 순환 분배 | 균등 CPU/세션 |
| Least Connections | 연결 수가 가장 적은 서버 | 세션 길이 상이 |
| Source/IP Hash | 클라이언트 식별자 해시 | 세션 고정 |
| Weighted RR/LC | 가중치 기반 | 이기종 서버 혼합 |
| Consistent Hash | 키 기반 맵핑 안정성 | 캐시/샤딩 |

### HAProxy 예제(L7)

```bash
# /etc/haproxy/haproxy.cfg

global
  maxconn 10000
defaults
  mode http
  option http-keep-alive
  timeout connect 5s
  timeout client  60s
  timeout server  60s

frontend fe_web
  bind :80
  default_backend be_web

backend be_web
  balance leastconn
  option httpchk GET /healthz
  server s1 10.0.1.10:8080 check
  server s2 10.0.1.11:8080 check
```

### Nginx 리버스 프록시 + 헬스체크(간단)

```nginx
http {
  upstream app {
    least_conn;
    server 10.0.1.10:8080 max_fails=3 fail_timeout=10s;
    server 10.0.1.11:8080 max_fails=3 fail_timeout=10s;
  }
  server {
    listen 80;
    location / { proxy_pass http://app; }
    location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }
  }
}
```

### TLS 오프로딩과 보안

- **오프로딩**: LB/프록시에서 TLS 종료 → 백엔드 평문. **내부 구간 암호화**·**mTLS** 필요 여부 검토.
- **HSTS/ALPN/OCSP Stapling**, TLS 정책(최소 버전/TLS_AES_xxx/EECDH 커브) 관리.

---

## QoS/트래픽 제어 — DSCP·큐잉·토큰 버킷·AQM

### DSCP 마킹(복습)

```bash
# SIP/VoIP 예: EF(46)

iptables -t mangle -A OUTPUT -p udp --dport 5060 -j DSCP --set-dscp 46
# nftables

nft add rule inet mangle output udp dport 5060 ip dscp set 46
```

### 큐잉/스케줄링(AQM 포함)

| 기법 | 설명 | 비고 |
|---|---|---|
| FIFO/PRIO | 단순/우선순위 | 소규모 |
| HTB/CBQ | 계층형 대역폭 보장 | 트래픽 쉐이핑 |
| WFQ/DRR | 가중 공정 | 공정 분배 |
| **AQM**: RED/FQ-CoDel | 큐 지연 완화/혼잡 완화 | FQ-CoDel 현대 기본 |

**토큰 버킷 모델(평균률 r, 버킷 B)**
- 시간 \(t\) 동안 보낼 수 있는 총량 \( \le r\cdot t + B\).
- 평균률은 \(r\)에 수렴, **버스트**는 최대 \(B\) 바이트.
$$
\text{allowed}(t) \le r\cdot t + B
$$

### Linux `tc` 예제(HTB + fq_codel)

```bash
# egress 100Mbps, Web/VoIP 우대

DEV=eth0
tc qdisc add dev $DEV root handle 1: htb default 30
tc class add dev $DEV parent 1: classid 1:1 htb rate 100mbit ceil 100mbit

# VoIP: 5Mbps 보장

tc class add dev $DEV parent 1:1 classid 1:10 htb rate 5mbit ceil 100mbit prio 0
tc qdisc add dev $DEV parent 1:10 handle 10: fq_codel

# Web: 50Mbps 보장

tc class add dev $DEV parent 1:1 classid 1:20 htb rate 50mbit ceil 100mbit prio 1
tc qdisc add dev $DEV parent 1:20 handle 20: fq_codel

# 기타: 기본

tc class add dev $DEV parent 1:1 classid 1:30 htb rate 10mbit ceil 100mbit prio 2
tc qdisc add dev $DEV parent 1:30 handle 30: fq_codel

# 분류(DSCP 또는 포트 기반)

tc filter add dev $DEV protocol ip parent 1: prio 1 u32 match ip dscp 46 0xfc flowid 1:10
tc filter add dev $DEV protocol ip parent 1: prio 2 u32 match ip sport 80 0xffff flowid 1:20
```

---

## — 주소·NDP·RA/RS·프라이버시

### IPv6 주소 유형 요약

| 유형 | 프리픽스 | 예 | 비고 |
|---|---|---|---|
| 유니캐스트(글로벌) | 2000::/3 | 2001:db8::/32 | 전세계 라우팅 |
| 링크로컬 | fe80::/10 | fe80::1 | 인터페이스 자동, 라우팅 X |
| ULA | fc00::/7 | fd00::/8 | 사설 유사(조직 내부) |
| 멀티캐스트 | ff00::/8 | ff02::1 | 스코프별 |

### NDP(Neighbor Discovery Protocol)

- **ICMPv6** 기반: **NS/NA(ARP 대체)**, **RA/RS(DHCPv6 없이도 프리픽스·게이트웨이 광고)**.
- **SLAAC**: 프리픽스 + 인터페이스 식별자(EUI-64/프라이버시 확장)로 주소 자동 구성.
- **프라이버시 확장**: 임시 주소로 추적 회피(클라이언트).

**Linux 기본 확인**
```bash
ip -6 addr
ip -6 neigh
rdisc6 eth0      # Router Advertisement 보기(도구에 따라 제공)
```

**보안 메모**
- **RA 가짜 광고**(스푸핑) → **RA Guard**, 인증된 L2, DHCPv6+ND 보안 정책 병행 검토.

---

## 터널링/오버레이 — GRE/IP-in-IP/VXLAN(개요)와 오버헤드

### 개념

- **L3-over-L3**: IP-in-IP, GRE.
- **L2-over-L3**: VXLAN(UDP 4789), Geneve, GRETAP.
- **용도**: 멀티테넌시, 클라우드 오버레이, 분리/가상 네트워크.

### 오버헤드(대략)

| 캡슐화 | 추가 헤더 | 대략 오버헤드 |
|---|---|---|
| IP-in-IP | +20(IPv4) | 20B |
| GRE | +24 | 24B |
| VXLAN(IPv4) | +20(IP)+8(UDP)+8(VXLAN)+14(내부 L2) | ≈50B+ |
| VXLAN(IPv6) | +40(IP6)+8+8+14 | ≈70B+ |

> MTU 감소에 유의. **MSS Clamp** 또는 **PMTUD** 정상화가 필수.

### Linux GRE/VXLAN 예

```bash
# GRE 터널

ip tunnel add gre1 mode gre local 198.51.100.10 remote 203.0.113.10 ttl 64
ip link set gre1 up
ip addr add 10.10.10.1/30 dev gre1

# VXLAN (VNI 100, 멀티캐스트 없이 피어링)

ip link add vxlan100 type vxlan id 100 dev eth0 remote 198.51.100.20 dstport 4789
ip link set vxlan100 up
bridge fdb add 00:00:00:00:00:00 dev vxlan100 dst 198.51.100.20
```

---

## 게이트웨이 고가용성 — HSRP/VRRP & keepalived

### 개념과 차이

- **HSRP**: Cisco 독자(유사 표준 존재), 가상 IP(보통 .1)를 공유, Active/Standby.
- **VRRP**: IETF 표준, Master/Backup, 우선순위 기반 선출.

### keepalived + VRRP 실습 예

```bash
# /etc/keepalived/keepalived.conf

vrrp_instance VI_1 {
  state MASTER
  interface eth0
  virtual_router_id 51
  priority 150
  advert_int 1
  virtual_ipaddress {
    192.168.10.1/24 dev eth0
  }
  track_script {
    chk_web
  }
}

vrrp_script chk_web {
  script "/usr/bin/curl -sf http://127.0.0.1:80/healthz || exit 1"
  interval 2
  weight -50
}
```
- **헬스체크 실패 시 가중치↓**, 백업 노드로 자동 페일오버.

---

## 정책 기반 라우팅(PBR)·다중 경로(ECMP)

### `ip rule`/`ip route` (Linux)

```bash
# fwmark=10 트래픽을 다른 테이블로 보냄

ip rule add fwmark 10 table 100
ip route add default via 192.0.2.1 table 100

# 마킹(예: 특정 사용자/포트)

iptables -t mangle -A PREROUTING -p tcp --dport 443 -j MARK --set-mark 10
```

### ECMP

```bash
ip route add default \
  nexthop via 192.0.2.1 weight 1 \
  nexthop via 198.51.100.1 weight 1
```
- **해시 기반 분산**. 상태 공유 필요 시 L4 프록시/SD-WAN 고려.

---

## Anycast/CDN — 글로벌 가용성·근접성

### Anycast

- **여러 지역**에서 **동일 IP**를 광고(BGP) → **가까운 노드**로 라우팅. DNS 루트, CDN, DDoS 흡수에 널리 사용.
- **설계 포인트**: 스테이트리스(L4 이하) 서비스 적합. 상태가 필요한 서비스는 **세션 고정/동기화** 필요.

### CDN 요소

- **에지 캐시**, **오리진 페일오버**, **TLS 오프로딩**, **HTTP/2/3**, **전송 압축**.
- 보안: **WAF/봇 차단**, **DDoS 보호**, **TLS 정책 통일**.

---

## 가시성/운영 — SPAN/TAP·NetFlow/IPFIX·패킷 캡처

### SPAN/TAP

- **SPAN(포트 미러)**: 스위치 포트 트래픽을 미러 포트로 복제.
- **TAP**: 인라인 하드웨어 분기. 지연/드롭 영향 최소.

### NetFlow/IPFIX

- **플로우 레코드**(5-튜플, 바이트/패킷/지속시간/DSCP/바이트 등). 트렌드·탐지(Ping sweep/포트스캔/증폭 징후).

### tcpdump/Wireshark

```bash
# 캡처

sudo tcpdump -nni any -w audit.pcap
# 필터 예

sudo tcpdump -nni eth0 "tcp[tcpflags] & tcp-syn != 0"   # SYN 관측
sudo tcpdump -nni eth0 "udp and port 53"                # DNS
```

---

## 실습 시나리오

### 실습 A — NAT + DNAT + PMTUD 검증

1) **SNAT + DNAT** 구성.
2) 클라이언트에서 대용량 다운로드 테스트, **ICMP Frag Needed**가 **RELATED**로 허용되는지 확인.
```bash
# 방화벽(RELATED 허용)과 tcpdump로 icmp.type==3 && code==4 관찰

sudo tcpdump -nni wan0 "icmp and icmp[0]==3 and icmp[1]==4"
```

### 실습 B — HAProxy L7 헬스체크

1) 백엔드 2대 중 하나에서 `/healthz`를 503로 응답하도록 스크립트.
2) HAProxy에서 **자동 제외/복귀**되는지 관찰(`show stat`, 로그).

### 실습 C — HTB + fq_codel로 QoS 체감

1) `iperf3 -u`로 UDP 스트림 생성(백그라운드 대역폭 점유).
2) VoIP 트래픽(모의 UDP 64kbps)을 DSCP=EF로 송신.
3) **HTB/FQ-CoDel** 적용 전/후 **지터/손실** 비교.

### 게이트웨이 페일오버

1) MASTER에서 서비스 헬스체크 실패 유도.
2) **ARP 테이블 변화/게이트웨이 MAC** 전환, **다운타임** 측정.

### 실습 E — PBR로 HTTPS만 전용 회선 사용

1) `--dport 443`에 fwmark=10.
2) table 100의 default via 회선#2.
3) `mtr`로 경로 차이 확인.

---

## 점검 체크리스트

- [ ] NAT 경계에서 **PMTUD 관련 ICMP(Type 3/4)** 허용/정상화 확인.
- [ ] **DNAT 서비스**는 L4/L7 방화벽 룰, WAF/Rate-Limit, 헬스체크, 로깅 구성.
- [ ] LB는 **헬스체크/세션고정/타임아웃**을 애플리케이션과 맞춤.
- [ ] QoS는 **DSCP 정책**·**큐잉(fq_codel/HTB)**·**측정(지터/손실)**을 세트로 운영.
- [ ] IPv6는 **NDP/RA 보안(RA Guard)**, 프라이버시 주소 정책, 방화벽 듀얼스택 동등 적용.
- [ ] 터널/오버레이는 **오버헤드→MTU/MSS 조정**과 **경로 MTU 검증**.
- [ ] 게이트웨이 HA는 **선출/헬스체크**와 **ARP/그라튜이셔스 ARP** 동작 검증.
- [ ] PBR/ECMP는 **해시/대칭성**과 **상태 공유** 이슈 점검.
- [ ] Anycast/CDN는 **스테이트리스 설계**와 **모니터링(지역별 가용성)** 확보.
- [ ] 가시성: **SPAN/TAP + 패킷 + 플로우** 3종 세트 운영.

---

## 예상문제(필기/실무)

1) **NAT vs PAT vs DNAT** 차이를 설명하고, 각 예시 규칙을 제시하라.
2) LB **L4 vs L7** 차이점과, **Least Connections**가 유리한 상황을 기술하라.
3) **토큰 버킷**의 평균률 \(r\)·버킷 크기 \(B\) 의미와, 버스트 허용량을 식으로 쓰라.
4) **IPv6 NDP**의 역할(NS/NA, RA/RS)과 **RA 스푸핑** 방지책을 쓰라.
5) **GRE vs VXLAN**의 차이(레이어/오버헤드/용도)를 표로 비교하라.
6) **VRRP/HSRP**의 목적과 페일오버 시 MAC/IP 동작을 설명하라.
7) **PBR**로 HTTPS만 전용 회선 사용하는 구성을 `ip rule`·`ip route` 기반으로 작성하라.
8) **Anycast**가 DNS/CDN에서 유용한 이유와, 상태 유지 서비스에서의 제약을 서술하라.

---

## 부록 — 운영 스니펫 모음

```bash
# nftables: 기본 L3/L4 정책

nft add table inet filter
nft add chain inet filter input { type filter hook input priority 0; policy drop; }
nft add rule  inet filter input ct state established,related accept
nft add rule  inet filter input iifname "lo" accept
nft add rule  inet filter input tcp dport {22,80,443} ct state new accept
nft add rule  inet filter input icmp type { time-exceeded, destination-unreachable } accept
```

```bash
# iptables: PMTUD 핵심 ICMP 허용

iptables -A INPUT -p icmp --icmp-type fragmentation-needed -j ACCEPT
iptables -A INPUT -p icmp --icmp-type time-exceeded -j ACCEPT
```

```bash
# Anycast 개요 스니펫(개념 예시)

router bgp 65001
  neighbor 203.0.113.1 remote-as 65000
  address-family ipv4 unicast
    network 198.51.100.53/32    # Anycast IP
    neighbor 203.0.113.1 activate
```

```bash
# mtr/iperf3: 경로/품질 측정

mtr -rwzbc100 1.1.1.1
iperf3 -c <server> -p 5201 -t 30
```

---

## 결론

- **NAT/PAT·프록시/LB·QoS·IPv6·터널·게이트웨이HA·PBR·Anycast/CDN**은 현대 네트워크의 운영·보안·성능을 결정짓는 **핵심 레버**다.
- 성공적인 적용의 조건은 **정확한 모델(옵션/오버헤드/상태 관리) 이해**, **가시성 확보**(패킷·플로우·로그), **점진적 배포와 검증**이다.
- 본 장의 표·수식·스니펫·실습을 표준 템플릿으로 삼아, 환경별 제약(장비/클라우드/보안정책)에 맞춰 **설계→파일럿→관측→튜닝**을 반복하라.
