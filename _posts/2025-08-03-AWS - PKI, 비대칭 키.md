---
layout: post
title: AWS - PKI, ë¹„ëŒ€ì¹­ í‚¤
date: 2025-08-03 22:20:23 +0900
category: AWS
---
# ğŸ” PKI / ë¹„ëŒ€ì¹­ í‚¤ ì‚¬ìš© ì˜ˆì œ (AWS KMSë¡œ Sign / Verify) â€” ì™„ì „ ê°€ì´ë“œ

ì´ ë¬¸ì„œëŠ” AWS KMSì˜ **ë¹„ëŒ€ì¹­ í‚¤(Asymmetric keys)** ë¥¼ ì‚¬ìš©í•´ ë””ì§€í„¸ ì„œëª…ì„ ìƒì„±í•˜ê³  ê²€ì¦í•˜ëŠ” ì „ì²´ ì›Œí¬í”Œë¡œìš°ë¥¼ **ê°œë… + ì„¤ì • + CLI / SDK / ë¡œì»¬ ê²€ì¦ ì˜ˆì œ**ê¹Œì§€ ìì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤.  
ì£¼ìš” í¬ì¸íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- KMSì—ì„œ **ë¹„ëŒ€ì¹­ ì„œëª… ì „ìš© í‚¤**(SIGN_VERIFY) ìƒì„±  
- KMS `Sign` APIë¡œ **ì„œëª…(ì„œëª…ì€ í”„ë¼ì´ë¹— í‚¤ì—ì„œ ìˆ˜í–‰)**  
- KMS `Verify` APIë¡œ **ê²€ì¦(ì„œëª… ê²€ì¦ì„ KMSì—ì„œ ìˆ˜í–‰)**  
- ë˜ëŠ” `GetPublicKey`ë¡œ ê³µê°œí‚¤ë¥¼ ë°›ì•„ **ë¡œì»¬(OpenSSL / cryptography ë“±)ì—ì„œ ê²€ì¦**  
- `MessageType` (RAW / DIGEST), ì„œëª… ì•Œê³ ë¦¬ì¦˜, ì„œëª… í˜•ì‹(RSA vs ECDSA) ì°¨ì´ ì£¼ì˜

---

## 1) í•µì‹¬ ê°œë… ìš”ì•½

- **ë¹„ëŒ€ì¹­ í‚¤ ì¢…ë¥˜**: RSA (RSA_2048 / 3072 / 4096), ECC (ECC_NIST_P256/384/521) ë“±.  
- **KeyUsage**: `SIGN_VERIFY` ë¡œ ìƒì„±í•´ì•¼ Sign/Verify ì—°ì‚° ê°€ëŠ¥.  
- **ì„œëª… ì•Œê³ ë¦¬ì¦˜(ì˜ˆ)**:
  - RSA ê³„ì—´: `RSASSA_PKCS1_V1_5_SHA_256`, `RSASSA_PSS_SHA_256` ë“±
  - ECDSA ê³„ì—´: `ECDSA_SHA_256`, `ECDSA_SHA_384` ë“±
- **MessageType**:
  - `RAW`: KMSê°€ ë‚´ë¶€ì—ì„œ ë¨¼ì € í•´ì‹œ(ì˜ˆ: SHA-256) â†’ ì„œëª…
  - `DIGEST`: í˜¸ì¶œìê°€ ë¯¸ë¦¬ í•´ì‹œí•œ ë°”ì´íŠ¸(ì˜ˆ: SHA-256 ë‹¤ì´ì œìŠ¤íŠ¸)ë¥¼ ì „ë‹¬ (KMSëŠ” í•´ì‹œí•˜ì§€ ì•ŠìŒ)
- **ì„œëª… ì¶œë ¥**:
  - RSA ê³„ì—´: ì„œëª… ë°”ì´íŠ¸(ì›ì‹œ ë°”ì´íŠ¸)  
  - ECDSA ê³„ì—´: ASN.1/DER í˜•ì‹ì˜ (r,s) ì‹œí€€ìŠ¤ ë°”ì´íŠ¸

> **ì¤‘ìš”**: KMSëŠ” **ì‚¬ì„¤í‚¤(private key)ë¥¼ ë…¸ì¶œí•˜ì§€ ì•ŠìŒ**. ê³µê°œí‚¤(public key)ë§Œ `GetPublicKey`ë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ.

---

## 2) í‚¤ ìƒì„± (ì˜ˆ â€” AWS CLI)

ë¹„ëŒ€ì¹­ ì„œëª…í‚¤ë¥¼ ìƒì„±í•˜ë ¤ë©´ `KeySpec`ê³¼ `KeyUsage`ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.

```bash
aws kms create-key \
  --description "My signing key for app" \
  --key-usage SIGN_VERIFY \
  --key-spec RSA_2048
```

- `--key-spec` ì˜ˆ: `RSA_2048`, `RSA_3072`, `RSA_4096`, `ECC_NIST_P256`, `ECC_NIST_P384`, `ECC_NIST_P521`  
- ì¶œë ¥ì˜ `KeyMetadata.KeyId` ë˜ëŠ” `Arn`ì„ ê¸°ë¡í•´ ë‘¡ë‹ˆë‹¤.

---

## 3) KMS í‚¤ ì •ì±… / IAM ê¶Œí•œ (ì˜ˆ)

KMS í‚¤ ì •ì±…ì€ **ëˆ„ê°€ í‚¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ì§€**ë¥¼ ì œì–´í•©ë‹ˆë‹¤. ì„œëª…/ê²€ì¦/ê³µê°œí‚¤ ì¡°íšŒë¥¼ í—ˆìš©í•˜ëŠ” ê°„ë‹¨í•œ ì˜ˆ:

```json
{
  "Version": "2012-10-17",
  "Id": "key-policy-sign-verify",
  "Statement": [
    {
      "Sid": "AllowAdministrators",
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::123456789012:root"},
      "Action": "kms:*",
      "Resource": "*"
    },
    {
      "Sid": "AllowAppRoleToSign",
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::123456789012:role/MySigningRole"},
      "Action": [
        "kms:Sign",
        "kms:Verify",
        "kms:GetPublicKey",
        "kms:DescribeKey"
      ],
      "Resource": "*"
    }
  ]
}
```

- ì¶”ê°€ë¡œ `kms:Grant*` ê¶Œí•œì´ë‚˜ ì¡°ê±´(`aws:SourceIp`, `aws:PrincipalTag`)ì„ ë„£ì–´ ì„¸ë¶„í™”í•˜ì„¸ìš”.
- **IAM ì •ì±…**ì—ë„ `kms:Sign`, `kms:Verify`, `kms:GetPublicKey` ê¶Œí•œì„ ë¶€ì—¬í•´ì•¼ ì •ìƒ ë™ì‘í•©ë‹ˆë‹¤.

---

## 4) ì„œëª…(Sign) â€” AWS CLI & boto3 ì˜ˆì œ

### (A) CLI â€” RAW ë©”ì‹œì§€ ì„œëª…

```bash
# data.txtì— ì„œëª…í•  ë©”ì‹œì§€(ì›ë¬¸)ë¥¼ ë‘”ë‹¤ê³  ê°€ì •
aws kms sign \
  --key-id arn:aws:kms:ap-northeast-2:123456789012:key/EXAMPLE \
  --message fileb://data.txt \
  --signing-algorithm RSASSA_PKCS1_V1_5_SHA_256 \
  --message-type RAW \
  --output json > sign-output.json
```

`sign-output.json`ì— `Signature` ê°€ base64ë¡œ ë‹´ê²¨ ìˆìŠµë‹ˆë‹¤.

### (B) Python (boto3) â€” RAW ë©”ì‹œì§€ ì„œëª…

```python
import boto3
import base64

kms = boto3.client('kms', region_name='ap-northeast-2')

with open('data.txt','rb') as f:
    message = f.read()

resp = kms.sign(
    KeyId='arn:aws:kms:ap-northeast-2:123456789012:key/EXAMPLE',
    Message=message,
    MessageType='RAW',  # or 'DIGEST' if you pass a precomputed hash
    SigningAlgorithm='RSASSA_PKCS1_V1_5_SHA_256'
)

signature = resp['Signature']  # bytes
with open('signature.bin','wb') as fh:
    fh.write(signature)
print("Signature written to signature.bin")
```

- `SigningAlgorithm` ê°’ì€ í‚¤ íƒ€ì…ì— ë§ê²Œ ì„ íƒí•˜ì„¸ìš”. (RSAì— PSS, PKCS1; ECCì— ECDSA_SHA_*)

---

## 5) KMSì—ì„œ ê²€ì¦(Verify) â€” ê¶Œì¥ ë°©ë²•

KMS `Verify` APIë¡œ ì„œëª… ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì„œë²„ì‚¬ì´ë“œ ê²€ì¦)

### (A) CLI

```bash
aws kms verify \
  --key-id arn:aws:kms:ap-northeast-2:123456789012:key/EXAMPLE \
  --message fileb://data.txt \
  --signature fileb://signature.bin \
  --signing-algorithm RSASSA_PKCS1_V1_5_SHA_256 \
  --message-type RAW
```

ê²°ê³¼ì˜ `SignatureValid` í•„ë“œê°€ `true`ì´ë©´ ê²€ì¦ ì„±ê³µì…ë‹ˆë‹¤.

### (B) boto3

```python
resp = kms.verify(
    KeyId='arn:aws:kms:ap-northeast-2:123456789012:key/EXAMPLE',
    Message=message,
    Signature=signature,
    SigningAlgorithm='RSASSA_PKCS1_V1_5_SHA_256',
    MessageType='RAW'
)
print(resp['SignatureValid'])  # True / False
```

---

## 6) ê³µê°œí‚¤ ê°€ì ¸ì˜¤ê¸°(GetPublicKey) + ë¡œì»¬ ê²€ì¦ (OpenSSL / Python)

KMS `GetPublicKey` APIë¡œ ê³µê°œí‚¤ë¥¼ ë°›ì•„ì„œ **ì˜¤í”„ë¼ì¸(ë¡œì»¬)**ì—ì„œ ê²€ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
ì´ëŠ” ë¶„ì‚° ì•„í‚¤í…ì²˜ì—ì„œ "KMSì— ë§¤ë²ˆ Verify ìš”ì²­ì„ ë³´ë‚´ì§€ ì•Šë„ë¡" public keyë¥¼ ë°°í¬í•´ ê²€ì¦ ì„±ëŠ¥ì„ ë†’ì¼ ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.

### ê³µê°œí‚¤ ë‹¤ìš´ë¡œë“œ & PEM ë³€í™˜ (CLI)

```bash
aws kms get-public-key --key-id arn:aws:kms:ap-northeast-2:123456789012:key/EXAMPLE \
  --output text --query PublicKey | base64 --decode > pubkey.der

# DER -> PEM (OpenSSL)
openssl pkey -inform DER -pubin -in pubkey.der -out pubkey.pem
```

### OpenSSLìœ¼ë¡œ ê²€ì¦ (RSA - PSS ì˜ˆì‹œ)

RSA-PSS ì„œëª… ê²€ì¦(ì˜ˆ: RSASSA_PSS_SHA_256)ì˜ ê²½ìš° OpenSSL ì˜µì…˜ í•„ìš”:

```bash
# RSA-PSS (saltlen = same as hash = -1 for maximal)
openssl dgst -sha256 -verify pubkey.pem \
  -sigopt rsa_padding_mode:pss \
  -sigopt rsa_pss_saltlen:-1 \
  -signature signature.bin data.txt
```

ê²°ê³¼ê°€ `Verified OK` ì´ë©´ ì„±ê³µ.

### OpenSSLìœ¼ë¡œ ECDSA ê²€ì¦ (DER ì„œëª…)

```bash
openssl dgst -sha256 -verify pubkey.pem -signature signature.bin data.txt
```

ECDSA ì„œëª…ì€ KMSê°€ DER(ASN.1) í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•˜ë¯€ë¡œ OpenSSLì—ì„œ ë°”ë¡œ ê²€ì¦ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### Python(cryptography) ë¡œì»¬ ê²€ì¦ ì˜ˆ (RSA PKCS1 v1.5 & ECDSA)

```python
from cryptography.hazmat.primitives import hashes, serialization
from cryptography.hazmat.primitives.asymmetric import padding, ec
from cryptography.hazmat.primitives.serialization import load_pem_public_key

# load public key
with open('pubkey.pem','rb') as f:
    pubkey = load_pem_public_key(f.read())

# RSA PKCS1 v1.5 verify
pubkey.verify(
    signature,                      # signature bytes from KMS
    message,                        # original message bytes
    padding.PKCS1v15(),
    hashes.SHA256()
)

# RSA-PSS verify
pubkey.verify(
    signature,
    message,
    padding.PSS(
        mgf=padding.MGF1(hashes.SHA256()),
        salt_length=padding.PSS.MAX_LENGTH
    ),
    hashes.SHA256()
)

# ECDSA verify (DER signature)
pubkey.verify(
    signature,
    message,
    ec.ECDSA(hashes.SHA256())
)
```

- ECDSAì˜ ê²½ìš° KMSê°€ ë°˜í™˜í•œ ì„œëª…(ASN.1/DER)ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

---

## 7) MessageType: RAW vs DIGEST â€” ì–¸ì œ ë¬´ì—‡ì„ ì“¸ê¹Œ?

- **RAW**: ì‘ì€ ë©”ì‹œì§€(ë¡œê·¸, í† í° ë“±)ë¥¼ ë°”ë¡œ ë³´ë‚´ë©´ KMSê°€ ë‚´ë¶€ì—ì„œ í•´ì‹œí›„ ì„œëª…. ë³´í†µ ì‚¬ìš©í•˜ê¸° ê°„ë‹¨.  
- **DIGEST**: ì „ì†¡ ë©”ì‹œì§€ê°€ í¬ê±°ë‚˜, ë™ì¼í•œ ë©”ì‹œì§€ì— ëŒ€í•´ ì—¬ëŸ¬ ë²ˆ ì„œëª…/ê²€ì¦í•˜ë ¤ë©´ í˜¸ì¶œìê°€ ë¯¸ë¦¬ í•´ì‹œí•œ ë‹¤ì´ì œìŠ¤íŠ¸(ì˜ˆ: SHA-256)ë¥¼ `Message`ë¡œ ì „ë‹¬í•˜ê³  `MessageType='DIGEST'`ë¡œ ì§€ì •.  
  - ì´ ê²½ìš° KMSëŠ” í•´ì‹œë¥¼ ë‹¤ì‹œí•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, í˜¸ì¶œìëŠ” ì •í™•í•œ ë‹¤ì´ì œìŠ¤íŠ¸(ë°”ì´íŠ¸)ê°’ì„ ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.

**ì£¼ì˜**: `DIGEST`ë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” ë°˜ë“œì‹œ ì •í™•í•œ ë°”ì´íŠ¸(ì˜ˆ: raw 32ë°”ì´íŠ¸ SHA-256)ê°€ ì „ë‹¬ë˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

---

## 8) ì„œëª… í˜•ì‹ ì°¨ì´(RSA vs ECDSA) â€” ê²€ì¦ ì‹œ ì£¼ì˜ì 

- **RSA**: ì„œëª…ì€ ê³ ì • ê¸¸ì´ ë°”ì´íŠ¸(í‚¤ ê¸¸ì´). ê²€ì¦í•  ë•Œ íŒ¨ë”©(PS S / PKCS#1 v1.5) ì˜µì…˜ì„ ì •í™•íˆ ë§¤ì¹­í•´ì•¼ í•¨.  
- **ECDSA**: KMSê°€ ë°˜í™˜í•˜ëŠ” ì„œëª…ì€ **ASN.1/DER** í¬ë§·ì˜ (r,s). ë¡œì»¬ ë¼ì´ë¸ŒëŸ¬ë¦¬(OpenSSL, cryptography)ëŠ” ì´ í˜•ì‹ì„ ì´í•´í•¨.  
- ê²€ì¦ì„ ë¡œì»¬ì—ì„œ í•  ê²½ìš°, KMS `SigningAlgorithm` ì„ íƒì´ public-key ê²€ì¦ ìª½ êµ¬í˜„ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.

---

## 9) ìš´ì˜ íŒ & ë³´ì•ˆ ëª¨ë²” ì‚¬ë¡€

- **ì‚¬ì„¤í‚¤ëŠ” KMS ë‚´ë¶€ì—ë§Œ**: private keyëŠ” ì ˆëŒ€ ë…¸ì¶œ ë¶ˆê°€. ê³µê°œí‚¤ë§Œ ë°°í¬í•˜ì„¸ìš”.  
- **í‚¤ ì •ì±… ìµœì†Œí™”**: `Sign/Verify/GetPublicKey`ë§Œ í•„ìš”í•œ ì£¼ì²´ì—ë§Œ í—ˆìš©í•˜ì„¸ìš”.  
- **CloudTrail ë¡œê¹… í™œì„±í™”**: KMS `Sign` / `Decrypt` í˜¸ì¶œ ê¸°ë¡ì„ ê°ì‚¬í•˜ì„¸ìš”.  
- **public key ìœ íš¨ê¸°ê°„/ë°°í¬ ë°©ì‹ ì„¤ê³„**: ì˜¤í”„ë¼ì¸ ê²€ì¦ì„ ìœ„í•´ ê³µê°œí‚¤ë¥¼ ë°°í¬í•  ë•ŒëŠ” êµì²´/ë§Œë£Œ ì „ëµì„ ì„¸ìš°ì„¸ìš” (ì˜ˆ: key versioning).  
- **Verify vs GetPublicKey ì‚¬ìš©**:
  - KMS `Verify`ëŠ” ì•ˆì „í•˜ì§€ë§Œ ë ˆì´í„´ì‹œì™€ ë¹„ìš© ë°œìƒ.  
  - ëŒ€ëŸ‰ íŠ¸ë˜í”½/ì €ì§€ì—° ê²€ì¦ì´ í•„ìš”í•˜ë©´ ê³µê°œí‚¤ë¥¼ ìºì‹œí•´ ë¡œì»¬ ê²€ì¦(ì˜¤í”„ë¼ì¸)ì„ ì‚¬ìš©.  
- **ì•Œê³ ë¦¬ì¦˜ ì¼ê´€ì„±**: ìƒì„±â†’ì„œëª…â†’ê²€ì¦ì˜ ì•Œê³ ë¦¬ì¦˜(SHA, padding) ì„¤ì •ì„ ë¬¸ì„œí™”í•˜ì—¬ ë¶ˆì¼ì¹˜ë¡œ ì¸í•œ ì‹¤íŒ¨ ë°©ì§€.  
- **ë©”ì‹œì§€ í¬ë§· í‘œì¤€í™”**: canonicalization í•„ìš” ì‹œ(ì˜ˆ: JSON ì„œëª…) ë°”ì´íŠ¸ í¬ë§·ì„ ì„œë¹„ìŠ¤ ì „ì²´ì—ì„œ ë™ì¼í•˜ê²Œ ìœ ì§€í•˜ì„¸ìš”.

---

## 10) ì „ì²´ ì˜ˆì œ ì›Œí¬í”Œë¡œìš° (ìš”ì•½)

1. `aws kms create-key --key-usage SIGN_VERIFY --key-spec ECC_NIST_P256` (ë˜ëŠ” RSA)  
2. í‚¤ ì •ì±…ì— ì• í”Œë¦¬ì¼€ì´ì…˜ ì—­í• ì— `kms:Sign`, `kms:GetPublicKey`, `kms:Verify` ê¶Œí•œ ì¶”ê°€  
3. ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ `Sign` í˜¸ì¶œ â†’ KMSê°€ private keyë¡œ ì„œëª… â†’ ì„œëª… ë°”ì´íŠ¸ ë°˜í™˜  
4. ìˆ˜ì‹ ì(ë˜ëŠ” ê²€ì¦ì)ëŠ”:
   - (ì˜µì…˜ A) KMS `Verify` API í˜¸ì¶œë¡œ ì›ê²© ê²€ì¦  
   - (ì˜µì…˜ B) `GetPublicKey` â†’ ê³µê°œí‚¤ PEMìœ¼ë¡œ ë³€í™˜ â†’ ë¡œì»¬(OpenSSL / cryptography)ìœ¼ë¡œ ê²€ì¦  
5. ê²€ì¦ ì„±ê³µ ì‹œ ë©”ì‹œì§€ ë¬´ê²°ì„± ë° ì†¡ì‹ ì ì¸ì¦ í™•ë³´

---

### ì°¸ê³ (ë¹ ë¥¸ ì»¤ë§¨ë“œ ëª¨ìŒ)
```bash
# 1. Create asymmetric signing key
aws kms create-key --description "signing key" --key-usage SIGN_VERIFY --key-spec ECC_NIST_P256

# 2. Sign (CLI)
aws kms sign --key-id <keyid> --message fileb://data.txt --signing-algorithm ECDSA_SHA_256 --message-type RAW --output json

# 3. Get public key & convert
aws kms get-public-key --key-id <keyid> --output text --query PublicKey | base64 --decode > pub.der
openssl pkey -inform DER -pubin -in pub.der -out pub.pem

# 4. Verify with OpenSSL
openssl dgst -sha256 -verify pub.pem -signature signature.bin data.txt
```

---

### ê²°ë¡ 

AWS KMSì˜ ë¹„ëŒ€ì¹­(Sign/Verify) ê¸°ëŠ¥ì€ **ì‚¬ì„¤í‚¤ì˜ ì•ˆì „í•œ ë³´ê´€**, **í‘œì¤€ ì•Œê³ ë¦¬ì¦˜( RSA / ECDSA ) ì§€ì›**, ê·¸ë¦¬ê³  **ê³µê°œí‚¤ ë°°í¬ë¥¼ í†µí•œ ì˜¤í”„ë¼ì¸ ê²€ì¦** ë“± PKIë¥¼ í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ ì•ˆì „í•˜ê³  í¸ë¦¬í•˜ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.  
ìš´ì˜ ì‹œì—ëŠ” **í‚¤ ì •ì±…ê³¼ IAM ê¶Œí•œ**, **MessageType / ì„œëª… ì•Œê³ ë¦¬ì¦˜ ì¼ì¹˜**, **ê³µê°œí‚¤ ë°°í¬ ë° êµì²´ ì „ëµ**, **CloudTrail ê°ì‚¬**ì— íŠ¹íˆ ì£¼ì˜í•˜ì„¸ìš”.
