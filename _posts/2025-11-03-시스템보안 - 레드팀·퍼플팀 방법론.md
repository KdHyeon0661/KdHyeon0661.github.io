---
layout: post
title: 시스템보안 - 레드팀·퍼플팀 방법론
date: 2025-11-03 16:30:23 +0900
category: 시스템보안
---
# 18. 레드팀·퍼플팀 방법론

## 18.1 목표 가설, 질의 기반 침투(Objective-Driven)

### 18.1.1 왜 ‘목표 가설’인가?
레드팀은 “도구”가 아니라 “질문”에서 시작합니다.

- **비즈니스 목표**: “매출 정산 DB에 무결성 영향 없이 **읽기 접근** 가능?”  
- **보안 가설**: “경영진 노트북이 분리된 PAW 정책으로 **도메인 관리자 자격**이 없을 것이다.”  
- **검증 질의**: “만약 O365 OAuth 앱 승인 경로에서 조건부 접근이 허술하다면, 토큰 재사용으로 **메일 읽기**가 가능한가?”

> ✅ 산출물은 **측정 가능한 결과지표(KPI)** 로 치환되어야 합니다.  
> 예: _“임의 엔드포인트에서 DA까지 필요한 크리덴셜 접점 수 ≤ 2이면 고위험”_

### 18.1.2 목표 트리 & 측정지표
```
[Business Objective] 고객 데이터 유출 가능성 평가
 ├─ O1. VIP 메일/채팅 가로채기 (Confidentiality)
 │   ├─ KPI: VIP 계정에 대한 access token 취득 여부(랩) ✔/✖
 │   └─ KPI: 탐지까지 평균 시간(MTTD) < 5분?
 └─ O2. 결제 시스템 변경 저항성(Integrity)
     ├─ KPI: 승인 없는 서비스 계정 권한 상승 불가? (권한 경로 길이)
     └─ KPI: 변경 탐지 정확도(Precision/Recall)
```

### 18.1.3 범위·규칙(ROE)·윤리
- **허용 범위**: 지정된 랩·테스트 테넌트만, 실제 고객/PII 접촉 금지  
- **측정 중심**: “취약점 스캐닝”이 아니라 “목표 달성에 필요한 **경로 요건**” 측정  
- **안전 제동**: `Kill-Switch`(마커 파일/도메인)에 접근 시 **즉시 중단** 로직

---

## 18.2 MITRE ATT&CK 매핑, Atomic Test로 TTP 검증

### 18.2.1 ATT&CK 기반 ‘경로 설계’(예시)
- **초기 접근**(TA0001): 피싱 시뮬레이터 → **토큰 로그 생성만** (실제 인증 실패/성공 미발생)
- **실행**(TA0002): Office→Script 로깅(ETW/PowerShell Operational)만 생성
- **권한 상승/자격증명 접근**(TA0004/TA0006): **샘플 LSA dump 문자열**만 파일에 기록 → 탐지 룰 트리거
- **내부 이동**(TA0008): SMB 연결 시도 **시뮬레이터** (패킷 생성, 실제 명령 미실행)
- **수집/유출**(TA0009/TA0010): “압축/전송” 키워드 포함 더미 파일/HTTP 요청만 생성

> 핵심은 **실제 피해 없이 ‘탐지 신호’를 정교하게 재현**하는 것입니다.

### 18.2.2 Atomic Test(무해 버전) 빌딩 블록

#### (A) Windows: 이벤트 생성 PowerShell (Dry-Run)
```powershell
# New-TtpSignal.ps1 — 공격 대신 "탐지 신호"만 남기는 안전 스크립트
param([string]$Marker="SAFE-LAB", [string]$WorkDir="$env:TEMP\ttplab")

New-Item -ItemType Directory -Force -Path $WorkDir | Out-Null

# 1. 실행(Execution) 신호: PowerShell EncodedCommand 문자열만 로그에 남김
$enc = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes("Write-Host $Marker"))
Write-EventLog -LogName "Application" -Source "ttplab" -EntryType Information -EventId 9001 `
  -Message "Simulated EncodedCommand: -enc $enc"

# 2. 자격증명 접근(Cred Access) 신호: LSA/크리덴셜 단어 포함 더미 파일
"sekurlsa::logonpasswords (SIMULATED) $Marker" | Out-File "$WorkDir\lsa_sim.txt" -Encoding utf8

# 3. 내부 이동(Lateral) 신호: SMB 공유 경로 문자열만 기록
"\\\\HOST01\\IPC$ (SIMULATED Probe) $Marker" | Out-File "$WorkDir\lm_sim.txt" -Encoding utf8 -Append

# 4. 랜섬 TTP 신호: README/확장자 유사 패턴의 더미 파일
"SIM ONLY" | Out-File "$WorkDir\README_RECOVER_FILES.txt"
"hello"     | Out-File "$WorkDir\doc1.txt.safe"  # .locked 아님(무해)
```

#### (B) Linux: inotify/auditd 트리거용 더미
```bash
#!/usr/bin/env bash
set -euo pipefail
WD="${TMPDIR:-/tmp}/ttplab"; mkdir -p "$WD"
echo "SIM ENC"   > "$WD/enc_sim.txt"
echo "SIM LSA"   > "$WD/lsa_sim.txt"
echo "SIM SMB"   > "$WD/smb_sim.txt"
touch "$WD/README_RECOVER_FILES.txt"
```

### 18.2.3 탐지 룰(예시) — Sigma → KQL/SPL

**(1) EncodedCommand 시그널(안전 문자열 기반)**
```yaml
title: Simulated EncodedCommand Signal
id: 9a6c3c62-ttplab-enc
status: test
logsource:
  product: windows
  category: application
detection:
  sel:
    EventID: 9001
    Provider_Name: "ttplab"
    Message|contains: "-enc "
  condition: sel
level: low
tags: [simulation, attack.t1059.001]
```

**KQL**
```kusto
Event
| where EventLog == "Application" and EventID == 9001 and Source == "ttplab"
| where RenderedDescription has "-enc "
```

**SPL**
```spl
index=windows EventCode=9001 SourceName="ttplab" Message="*-enc *"
```

**(2) “자격증명 접근” 더미 파일 생성 탐지(Sysmon 11)**
```yaml
title: Simulated LSA Keyword File Drop
id: 1b1f-ttplab-lsa
logsource: { product: windows, service: sysmon }
detection:
  sel:
    EventID: 11
    TargetFilename|endswith: '\lsa_sim.txt'
  condition: sel
level: medium
tags: [simulation, attack.t1003]
```

---

## 18.3 실습: 한 달짜리 미니 레드팀 캠페인 시나리오 설계

> 목적: **탐지 품질 측정 & 공백 규정**. 실제 침해가 아닌 **시뮬레이션 기반 로그/행동**으로 진행.  
> 팀 구성: RT(2) + BT(2, Blue Team) + PT(1, Purple conductor)

### 18.3.1 타임라인(4주)

| 주 | 스프린트 목표 | TTP 페이즈(시뮬) | 산출물 |
|---|---|---|---|
| 1주 | 목표/가설/ROE 확정, 랩 인프라 | 초기접근/실행 신호 | 목표 트리, KPI, 베이스라인 대시보드 |
| 2주 | 권한 상승·크레덴셜 | LSA/토큰 시뮬 로그, 서비스/작업 스케줄러 더미 | Sigma/KQL 초안, 오탐 노트 |
| 3주 | 내부 이동·수집 | SMB/DNS/아카이빙 더미, 랜섬노트 유사 파일 | 상관 규칙, 알림 플레이북(초안) |
| 4주 | 유출 시뮬·보고 | HTTP Post 더미/압축 키워드 로그 | 성과 리포트, 공백/개선안 우선순위 |

### 18.3.2 주별 플레이북(발췌)

#### (A) 1주차 — 목표·지표 확정 및 “실행 신호” 생성
- **질의**: “PowerShell -enc 사용 시, 평균 탐지 지연(MTTD)은 5분 내인가?”  
- **Action**: `New-TtpSignal.ps1` 수행(WS-LAB1, WS-LAB2)  
- **측정**: SIEM 경보 시간, 규칙 매칭 여부  
- **성공 기준**: PRD 룰 매칭 + 경보 생성 + Jira 티켓 오픈 자동화

#### (B) 2주차 — 권한 상승·자격증명 접근(시뮬)
- **질의**: “LSA 키워드/파일 드롭에 대한 EDR 룰이 존재하고, 오탐 없이 동작하는가?”  
- **Action**: `lsa_sim.txt` 드롭 + 작업 스케줄러에 `ttplab` 키워드 태스크 등록(실행 없음)  
- **탐지 룰**: Sysmon 11(파일) + 1(프로세스) 조합, 이벤트ID 4698(작업 생성) 필터(키워드 `ttplab`)  
- **성공 기준**: 10분 내 삼중탐지(EDR/OSQuery/SIEM 중 2개 이상)

**KQL 예시**
```kusto
let k = "ttplab";
union
  (Sysmon | where EventID==11 and TargetFilename has "lsa_sim.txt"),
  (SecurityEvent | where EventID==4698 and tostring(EventData) has k)
| summarize hits=count() by Computer, bin(TimeGenerated, 10m)
| where hits >= 2
```

#### (C) 3주차 — 내부 이동·수집(시뮬)
- **질의**: “SMB/WinRM 시도와 아카이빙 키워드가 5분 창에서 상관탐지 되는가?”  
- **Action**: `\\HOST01\IPC$` 문자열 기록, `Archive`/`7z` 키워드 포함 더미 로그  
- **탐지 룰**: Sysmon 3(네트워크) 대신 **애플리케이션 로그**에 문자열 기록하여 안전히 재현

**Sigma(더미 아카이빙 키워드)**
```yaml
title: Simulated Archive Keyword
id: ttplab-arch
logsource: { product: windows, category: application }
detection:
  sel:
    EventID: 9002
    Message|contains:
      - "7z a -mx=9 (SIM)"
      - "tar -czf (SIM)"
  condition: sel
level: low
```

#### (D) 4주차 — 유출 단계·보고
- **질의**: “HTTP POST로 보이는 외부 전송 패턴(시뮬)이 차단/탐지되는가?”  
- **Action**: `curl https://lab-sink.invalid/sim?marker=ttplab` **요청 문자열만** 이벤트로 기록  
- **성공 기준**: DLP/Proxy 룰 드라이런 매칭 + SIEM 경보

---

### 18.3.3 KPI·메트릭

- **탐지 지연(MTTD)**: 시그널 발생→경보 생성까지 평균/백분위  
- **정확도(Precision/Recall)**: 시뮬 이벤트 대비 경보 매칭률, 오탐률  
- **커버리지**: ATT&CK 전술×기술 매핑 표에서 녹색(충족)/황색(부분)/적색(없음)

**예시 커버리지 표(발췌)**

| 전술 | 기술 | 시뮬 신호 | 탐지 룰 | 상태 |
|---|---|---|---|---|
| Execution | T1059.001 PS Encoded | 9001 앱 로그 | KQL:S-1 | 🟢 |
| Cred Access | T1003 LSA | Sysmon 11 파일 | Sigma:L-1 | 🟡 |
| Collection | T1560 Archive | 9002 앱 로그 | Sigma:C-1 | 🔴 |

---

## 18.4 퍼플팀: 탐지 공백 채우기, “가설→실험→피드백” 루프

### 18.4.1 루프 구조
1) **가설**: “작업 스케줄러 기반 지속성은 10분 내 탐지된다.”  
2) **실험**: 4698(작업 생성) + 키워드 `ttplab` 더미 이벤트 생성  
3) **관찰**: SIEM 경보 부재 → 로그 파이프라인 누락  
4) **수정**: Winlogbeat 채널 구독에 `Microsoft-Windows-TaskScheduler/Operational` 추가  
5) **재실험**: 동일 시뮬 반복 → 경보 생성 성공  
6) **규제화**: Sigma/KQL 룰 PR, 대시보드 카드 추가, 회귀 테스트에 편입

### 18.4.2 탐지 룰/대시보드 템플릿

**Sigma — 스케줄러 더미 탐지**
```yaml
title: Simulated Scheduled Task Creation (ttplab)
id: 4698-ttplab
logsource:
  product: windows
  service: "Microsoft-Windows-TaskScheduler/Operational"
detection:
  sel:
    EventID: 4698
    TaskName|contains: "ttplab"
  condition: sel
level: medium
```

**KQL 대시보드 쿼리(카드)**
```kusto
let k = "ttplab";
union
 (Event | where EventLog has "TaskScheduler" and EventID==4698 and RenderedDescription has k),
 (Event | where EventLog == "Application" and EventID in (9001,9002) and RenderedDescription has k)
| summarize cnt=count() by EventID, bin(TimeGenerated, 1h)
```

### 18.4.3 경보 피로 관리(퍼플 협업)
- **집계**: 동일 호스트·분 단위 버스팅  
- **억제**: 랩 네임스페이스/호스트 태그(`asset.tier: lab`)는 우선순위 하향  
- **플레이북**: 랩 신호는 **자동 티켓**만 발행(사람 호출 X)

### 18.4.4 회귀 테스트 자동화(“탐지는 코드로”)

**테스트 데이터 생성기(Windows 이벤트 라인)**
```python
# gen_sim_events.py — SIEM로 주입할 JSONL(무해)
import json, sys, datetime as dt
now = dt.datetime.utcnow().isoformat()+"Z"
events = [
  {"@timestamp": now, "channel":"Application", "event_id":9001, "source":"ttplab", "message":"Simulated EncodedCommand: -enc AAA="},
  {"@timestamp": now, "channel":"Application", "event_id":9002, "source":"ttplab", "message":"7z a -mx=9 (SIM)"},
]
for e in events:
  print(json.dumps(e))
```

> CI에서 변환 파이프라인(Fluent Bit/Logstash 테스트 입력) → KQL/SPL 쿼리 실행 → **행수 ≥ 1** 를 검사해 룰 회귀를 자동화합니다.

---

## 부록 A. 예시 리포 구조(퍼플킷)

```
purple-kit/
 ├─ scripts/New-TtpSignal.ps1
 ├─ linux/sim.sh
 ├─ sigma/
 │   ├─ sim_encoded.yml
 │   ├─ sim_lsa_drop.yml
 │   └─ sim_sched.yml
 ├─ kql/
 │   ├─ sim_timeline.kql
 │   └─ coverage_cards.kql
 ├─ spl/
 │   └─ sim_searches.spl
 ├─ ci/
 │   ├─ gen_sim_events.py
 │   └─ test_queries.sh   # SIEM API 호출로 결과 검증
 └─ docs/
     ├─ ROE.md
     ├─ Objectives.md
     └─ Metrics.md
```

---

## 부록 B. 위험저감 가드레일
- **실제 크리덴셜/토큰·PII 다루지 않음**(샘플/더미만)  
- **파괴적 행위 금지**(파일 암호화/삭제/권한 변경 없음)  
- **네트워크 외부 전송 금지**(로컬 이벤트만)  
- **모든 아티팩트에 `SAFE-LAB` 마커** 삽입 → 탐지 룰/대시보드에서 분리 필터 가능

---

# 결론

- **Objective-Driven** 방식은 “무엇을 증명할 것인가?”에서 출발해 **측정 가능한 KPI**로 귀결됩니다.  
- **ATT&CK 매핑 + 안전한 Atomic 시뮬**은 **탐지 체계의 품질**을 피해 없이 검증합니다.  
- **퍼플팀 루프(가설→실험→피드백)** 로 **수집·탐지·대응**의 공백을 닫고, 룰/대시보드를 **코드로 관리**하면 **회귀·확장**이 쉬워집니다.
