---
layout: post
title: ì›¹í•´í‚¹ - BOLA, IDOR
date: 2025-10-05 22:25:23 +0900
category: ì›¹í•´í‚¹
---
# BOLA / IDOR (ìˆ˜í‰Â·ìˆ˜ì§ ê¶Œí•œ)

## í•œëˆˆì— ë³´ê¸° (Executive Summary)

- **BOLA/IDORë€?**
  - **Broken Object Level Authorization** / **Insecure Direct Object Reference**.
  - í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ **ê°ì²´ ì‹ë³„ì(ID)** ë¥¼ ì„œë²„ê°€ ì‹ ë¢°í•˜ê³ , **ë¦¬ì†ŒìŠ¤ ì†Œìœ /ê¶Œí•œ**ì„ **ì¬ê²€ì¦í•˜ì§€ ì•Šì•„ì„œ**
    ë‹¤ë¥¸ ì‚¬ìš©ìì˜ **ë°ì´í„°ë¥¼ ì—´ëŒ/ìˆ˜ì •/ì‚­ì œ**í•  ìˆ˜ ìˆê²Œ ë˜ëŠ” ì·¨ì•½ì .
- **ìˆ˜í‰ vs ìˆ˜ì§ ê¶Œí•œ**
  - **ìˆ˜í‰**: ê°™ì€ ì—­í• (ì˜ˆ: ì¼ë°˜ ì‚¬ìš©ì Aâ†’Bì˜ ë¦¬ì†ŒìŠ¤ ì ‘ê·¼).
  - **ìˆ˜ì§**: **ì—­í•  ìƒìŠ¹**(ì˜ˆ: ì¼ë°˜ ì‚¬ìš©ìê°€ ê´€ë¦¬ ê¸°ëŠ¥/íƒ€ ê³„ì • ì†Œìœ  ë¦¬ì†ŒìŠ¤ ì ‘ê·¼).
- **í•µì‹¬ ë°©ì–´**
  1) **ë¦¬ì†ŒìŠ¤ ì†Œìœ ì/í…Œë„ŒíŠ¸ ì¬ê²€ì¦**: **ì¿¼ë¦¬ ë‹¨ê³„**ì—ì„œ `WHERE owner_id = :me AND id = :id`ë¡œ **ì„ ë³„**
  2) **ì •ì±… ì—”ì§„**: RBAC/ABACë¡œ **action Ã— object**ë¥¼ ì¤‘ì•™ì—ì„œ íŒë‹¨
  3) **ì°¸ì¡° í† í°í™”**: ì™¸ë¶€ ë…¸ì¶œ IDëŠ” **UUID/ULID(ë‚œìˆ˜)** ë˜ëŠ” **Capability í† í°**. ë‚´ë¶€ PK(ìˆœë²ˆ)ëŠ” ìˆ¨ê¹€
  4) **ì…ë ¥ ì •ê·œí™”Â·í•„ë“œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸**: **mass assignment**ë¡œ `owner_id`/`role`ì„ ë°”ê¾¸ì§€ ëª»í•˜ê²Œ
  5) **ë‹¤ì¤‘ í…Œë„ŒíŠ¸**: ëª¨ë“  ì¿¼ë¦¬ì— **tenant_id ìŠ¤ì½”í”„** ê³ ì •(ë˜ëŠ” DB **RLS**)
  6) **ì•ˆì „í•œ ì˜¤ë¥˜ ì²˜ë¦¬**: ì¡´ì¬/ê¶Œí•œ ìœ ë¬´ë¥¼ **ê· ì§ˆ**í•˜ê²Œ ì‘ë‹µ(404/403 ì „ëµ)
  7) **ë¡œê¹…/íƒì§€Â·í…ŒìŠ¤íŠ¸ ìë™í™”**: ID ì—´ê±° íŒ¨í„´, 404â†’200 ì „í™˜ ê°ì§€, ê¶Œí•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

---

# ì „í˜•ì  ê³µê²© ì‹œë‚˜ë¦¬ì˜¤(ê°œë… â†’ ì•ˆì „ ì¬í˜„)

## REST: ìˆœë²ˆ ID ì—´ê±°

```
GET /api/v1/invoices/123          # ë‚´ ê²ƒ
GET /api/v1/invoices/124          # ë‚¨ì˜ ê²ƒ â†’ 200ì´ë©´ BOLA
PATCH /api/v1/users/42/role=admin  # ìˆ˜ì§ ê¶Œí•œ ìƒìŠ¹(IDOR)
```
- **ì›ì¸**: ì„œë²„ê°€ `id=124`ë¡œ **ë‹¨ê±´ ì¡°íšŒ í›„** â€œì£¼ì¸ ê²€ì‚¬â€ë¥¼ **ê¹œë¹¡**í•˜ê±°ë‚˜, ì•„ì˜ˆ ê²€ì‚¬ ì—†ìŒ.

**ë°©ì–´ ìš”ì•½**:
- **ì¡°íšŒ/ìˆ˜ì • ì¿¼ë¦¬ ìì²´ì— ì†Œìœ ì/í…Œë„ŒíŠ¸ ì¡°ê±´**ì„ í¬í•¨.
- ì™¸ë¶€ ë…¸ì¶œ IDëŠ” **ì˜ˆì¸¡ ë¶ˆê°€(UUID/ULID)**.
- ìˆ˜ì • ì‹œ **í—ˆìš© í•„ë“œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸**.

## ë‹¤ì¤‘ í…Œë„ŒíŠ¸: íŒŒë¼ë¯¸í„° ë°”ê¿” íƒ€ì‚¬ ë°ì´í„° ì ‘ê·¼

```
GET /api/v1/tenants/acme/orders/uuid-v7-...   # ë‚´ í…Œë„ŒíŠ¸
GET /api/v1/tenants/othercorp/orders/uuid-v7  # ë°”ê¿”ì¹˜ê¸°
```
- **ì›ì¸**: `tenant` ê²½ë¡œ íŒŒë¼ë¯¸í„°ë¥¼ ì‹ ë¢°í•˜ê³ , ì„œë²„ê°€ `tenant_id` ì¬ê²€ì¦ ëˆ„ë½.

**ë°©ì–´ ìš”ì•½**:
- ì¸ì¦ ì»¨í…ìŠ¤íŠ¸ì˜ `tenant_id`ë¡œ **ê°•ì œ í•„í„°**(`WHERE tenant_id = :ctx.tenant_id`).
- ê²½ë¡œì˜ tenant ë¬¸ìì—´ì€ **í‘œì‹œìš©**ì¼ ë¿ **ê¶Œí•œ íŒë‹¨ì— ì‚¬ìš©í•˜ì§€ ì•Šê¸°**.

## íŒŒì¼/ë‹¤ìš´ë¡œë“œ: ì§ì ‘ ê°ì²´ ì°¸ì¡°

```
GET /download?file_id=1001  # 1002ë¡œ ë°”ê¾¸ë©´ ë‚¨ì˜ íŒŒì¼?
```
- **ë°©ì–´**: **capability(ì‚¬ì „ ì„œëª…) URL** ë˜ëŠ” **owner í•„í„° ì¿¼ë¦¬**.
- ì‚¬ì „ ì„œëª… í† í°ì—ëŠ” **ê°ì²´/í–‰ë™/ë§Œë£Œ/í…Œë„ŒíŠ¸**ê°€ í¬í•¨ë˜ì–´ì•¼ í•¨.

## GraphQL: global ID ì—´ê±°

```graphql
query { user(id: "42") { email, invoices { id, total } } }
```
- **ë°©ì–´**: ê° ë¦¬ì¡¸ë²„ì—ì„œ **ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš©ìë¡œ ì¬ê²€ì¦**,
  í•„ë“œ/ë…¸ë“œ ì ‘ê·¼ì€ **ê¶Œí•œ ê°€ë“œ**ë¥¼ í†µê³¼í•´ì•¼ ë°˜í™˜.

---

# ì„¤ê³„ ì•ˆí‹°íŒ¨í„´(í”¼í•´ì•¼ í•  ê²ƒ)

- **ì‚¬í›„ ê²€ì‚¬(Post-check)**:
  1) `record = findById(id)` â†’ 2) `if (record.ownerId !== me) 403`
  â†’ **ê²½ìŸ ìƒíƒœ/ìºì‹œ/ì˜¤ë¥˜ ê²½ë¡œ**ë¡œ ëˆ„ë½ë  ìˆ˜ ìˆìŒ. **ì‚¬ì „ í•„í„°**ë¡œ ë°”ê¾¸ê¸°.
- **ë‚´ë¶€ PK ë…¸ì¶œ**: ì˜¤í†  ì¸í¬ë¦¬ë¨¼íŠ¸ ìˆ«ìë¥¼ URLì— ê·¸ëŒ€ë¡œ ë…¸ì¶œ â†’ **ì˜ˆì¸¡/ì—´ê±° ìš©ì´**.
- **Mass Assignment**: PATCH bodyì— `ownerId`, `role` ê°™ì€ ë¯¼ê° í•„ë“œë¥¼ ì„œë²„ê°€ ê·¸ëŒ€ë¡œ ë°˜ì˜.
- **ê¶Œí•œì„ í´ë¼ì´ì–¸íŠ¸ê°€ ì£¼ì¥**: `X-User-Id` ê°™ì€ í—¤ë”ë¥¼ ê·¸ëŒ€ë¡œ ì‹ ë¢°.
- **í…Œë„ŒíŠ¸/ì†Œìœ ì í•„í„° ëˆ„ë½**: ì¡°ì¸Â·í†µê³„Â·ê²€ìƒ‰ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ë¹ ì§€ê¸° ì‰¬ì›€.
- **ëª¨ë†€ë¦¬ì‹ â€œisAdminâ€ í”Œë˜ê·¸ ë‚¨ìš©**: ì„¸ë¶„ ê¶Œí•œ ì—†ì´ ê±°ì¹œ ë¶„ê¸° â†’ ìˆ˜ì§ ê¶Œí•œ ì·¨ì•½.

---

# ë°©ì–´ ì•„í‚¤í…ì²˜(ì „ì²´ ê·¸ë¦¼)

1) **ì¸ì¦(WHO)**: `sub`, `tenant`, `roles`, `scopes`ë¥¼ ë‹´ì€ í† í°(JWT ë“±).
2) **ì •ì±…(WHAT on WHICH)**: `can(subject, action, object)` ì¤‘ì•™ íŒì •(RBAC/ABAC).
3) **ë°ì´í„° ì ‘ê·¼(WHERE)**: **ì¿¼ë¦¬ ë‹¨ê³„ì—ì„œ ìŠ¤ì½”í”„ í•„í„°**(owner/tenant).
4) **ì‹ë³„ì(REFERENCE)**: ì™¸ë¶€ëŠ” **ë‚œìˆ˜í˜• ID(ULID/UUIDv7)** ë˜ëŠ” **Capability í† í°**.
5) **ì…ë ¥/ì¶œë ¥(EDGE)**: í•„ë“œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸, í‘œì¤€ ì˜¤ë¥˜, ìºì‹œ ê¸ˆì§€.
6) **ê´€ì¸¡/ê²€ì¦(OBSERVE)**: ë¡œê¹…, ID ì—´ê±° íƒì§€, í…ŒìŠ¤íŠ¸/CI.

---

# ì½”ë“œ í…œí”Œë¦¿ (ì–¸ì–´ë³„)

## Node.js (Express + Prisma)

### íƒ€ì…/ìŠ¤ì½”í”„ ì•ˆì „ ì¡°íšŒ (ì‚¬ì „ í•„í„°)

```ts
// auth.ts â€” ì»¨í…ìŠ¤íŠ¸ ì£¼ì…
export type AuthCtx = { userId: string; tenantId: string; roles: string[] };

declare global { namespace Express { interface Request { auth?: AuthCtx } }}

// invoices.ts â€” BOLA ë°©ì§€
router.get('/invoices/:id', async (req, res) => {
  const { userId, tenantId } = req.auth!;
  const id = String(req.params.id);                 // UUID/ULID ì™¸ë¶€ ID
  const inv = await prisma.invoice.findFirst({
    where: { id, tenantId, ownerId: userId }        // ğŸ”´ ì¿¼ë¦¬ ë‹¨ê³„ì—ì„œ ì†Œìœ ì/í…Œë„ŒíŠ¸ í•„í„°
  });
  if (!inv) return res.sendStatus(404);             // ì¡´ì¬/ê¶Œí•œ ë¶ˆë¬¸ ë™ì¼ ì‘ë‹µ ì „ëµ
  res.json(inv);
});
```

### ìˆ˜ì •(í—ˆìš© í•„ë“œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸)

```ts
router.patch('/invoices/:id', async (req, res) => {
  const { userId, tenantId } = req.auth!;
  const id = String(req.params.id);
  const { status, memo } = pick(req.body, ['status','memo']); // âœ… í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸

  const inv = await prisma.invoice.updateMany({
    where: { id, tenantId, ownerId: userId },      // ğŸ”´ ì‚¬ì „ í•„í„°
    data: { status, memo }
  });
  if (inv.count === 0) return res.sendStatus(404);
  res.sendStatus(204);
});
```

### ìˆ˜ì§ ê¶Œí•œ ì˜ˆ(RBAC + ABAC í˜¼í•©)

```ts
function can(ctx: AuthCtx, action: 'user.promote'|'invoice.refund', obj?: any) {
  if (action === 'user.promote') return ctx.roles.includes('admin');               // RBAC
  if (action === 'invoice.refund') return obj?.ownerId === ctx.userId || ctx.roles.includes('agent');
  return false;
}

router.post('/users/:id/promote', async (req,res)=>{
  if (!can(req.auth!, 'user.promote')) return res.sendStatus(403);
  // â€¦
  res.sendStatus(204);
});
```

---

## â€” Service + Method Security

### ì—”í‹°í‹°/ë¦¬í¬ì§€í† ë¦¬

```java
@Entity class Invoice {
  @Id UUID id;
  UUID tenantId;
  UUID ownerId;
  BigDecimal total;
  String status;
}

public interface InvoiceRepo extends JpaRepository<Invoice, UUID> {
  Optional<Invoice> findByIdAndTenantIdAndOwnerId(UUID id, UUID tenantId, UUID ownerId);
  int updateStatusByIdAndTenantIdAndOwnerId(UUID id, UUID tenant, UUID owner, String status);
}
```

### ì„œë¹„ìŠ¤/ì»¨íŠ¸ë¡¤ëŸ¬ (ì‚¬ì „ í•„í„° + @PreAuthorize)

```java
@Service
public class InvoiceSvc {
  @Autowired InvoiceRepo repo;

  public Invoice getForUser(UUID id, UUID tenant, UUID user) {
    return repo.findByIdAndTenantIdAndOwnerId(id, tenant, user)
               .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND));
  }

  public void updateForUser(UUID id, UUID tenant, UUID user, String status) {
    int n = repo.updateStatusByIdAndTenantIdAndOwnerId(id, tenant, user, status);
    if (n == 0) throw new ResponseStatusException(HttpStatus.NOT_FOUND);
  }
}

@RestController @RequestMapping("/api/invoices")
public class InvoiceCtrl {
  @Autowired InvoiceSvc svc;

  @GetMapping("/{id}")
  public Invoice get(@PathVariable UUID id, @AuthenticationPrincipal MyUser u) {
    return svc.getForUser(id, u.getTenantId(), u.getUserId());
  }

  @PatchMapping("/{id}")
  @PreAuthorize("hasAnyRole('USER','AGENT')") // ìˆ˜ì§ ê¶Œí•œ í•„í„°
  public void patch(@PathVariable UUID id, @RequestBody PatchDto dto,
                    @AuthenticationPrincipal MyUser u) {
    svc.updateForUser(id, u.getTenantId(), u.getUserId(), dto.status());
  }
}
```

---

## â€” ORM í•„í„° + Serializer í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸

```python
# models.py

class Invoice(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    tenant = models.ForeignKey('Tenant', on_delete=models.CASCADE)
    owner  = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE)
    total  = models.DecimalField(max_digits=12, decimal_places=2)
    status = models.CharField(max_length=20)

# views.py (DRF)

class InvoiceView(APIView):
    permission_classes = [IsAuthenticated]

    def get(self, request, id):
        inv = get_object_or_404(Invoice, id=id, tenant=request.user.tenant, owner=request.user)
        return Response(InvoiceSerializer(inv).data)

    def patch(self, request, id):
        inv = get_object_or_404(Invoice, id=id, tenant=request.user.tenant, owner=request.user)
        ser = InvoicePatchSerializer(inv, data=request.data, partial=True)
        ser.is_valid(raise_exception=True)
        ser.save()  # Serializerì˜ fieldsê°€ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì—­í• 
        return Response(status=204)

# serializers.py

class InvoicePatchSerializer(serializers.ModelSerializer):
    class Meta:
        model = Invoice
        fields = ['status', 'memo']     # âœ… í—ˆìš© í•„ë“œë§Œ
```

---

## SQL ì§ì ‘ ì‚¬ìš© â€” â€œì‚¬ì „ í•„í„°â€ ì›ì¹™

```sql
-- âŒ ë‚˜ìœ ì˜ˆ
SELECT * FROM invoices WHERE id = $1;             -- ê°€ì ¸ì˜¨ ë’¤ owner ë¹„êµ (ì‚¬í›„ ê²€ì‚¬)

-- âœ… ì¢‹ì€ ì˜ˆ (ìˆ˜í‰ + í…Œë„ŒíŠ¸)
SELECT * FROM invoices
WHERE id = $1 AND tenant_id = $2 AND owner_id = $3;

-- âœ… ìˆ˜ì •/ì‚­ì œë„ ë™ì¼
UPDATE invoices SET status = $4
WHERE id = $1 AND tenant_id = $2 AND owner_id = $3;
```

---

## Postgres **Row-Level Security (RLS)**

```sql
ALTER TABLE invoices ENABLE ROW LEVEL SECURITY;

-- í˜„ì¬ ì„¸ì…˜ì— ì»¨í…ìŠ¤íŠ¸ ì£¼ì…(ë¯¸ë“¤ì›¨ì–´ì—ì„œ)
-- SELECT set_config('app.user_id',  '<uuid>', true);
-- SELECT set_config('app.tenant_id','<uuid>', true);

CREATE POLICY p_invoice_owner ON invoices
USING ( tenant_id::text = current_setting('app.tenant_id', true)
    AND owner_id::text  = current_setting('app.user_id', true) );

-- ì´ì œ ë‹¨ìˆœ ì¿¼ë¦¬ë„ ìë™ìœ¼ë¡œ ìŠ¤ì½”í”„ë¨
SELECT * FROM invoices WHERE id = $1;                   -- RLSê°€ í•„í„°ë§
```
> RLSëŠ” ê°•ë ¥í•˜ì§€ë§Œ, **ì„¸ì…˜ ì»¨í…ìŠ¤íŠ¸ ì£¼ì…**ì´ í™•ì‹¤í•´ì•¼ í•©ë‹ˆë‹¤. (ì»¤ë„¥ì…˜ í’€/íŠ¸ëœì­ì…˜ ê²½ê³„ ì£¼ì˜)

---

## GraphQL â€” ë¦¬ì¡¸ë²„ ê¶Œí•œ ê°€ë“œ

```ts
// resolver.ts
const resolvers = {
  Query: {
    invoice: async (_: any, { id }: {id: string}, ctx: Ctx) => {
      const inv = await db.invoice.findFirst({ where: { id, ownerId: ctx.user.id, tenantId: ctx.tenant.id }});
      if (!inv) throw new NotFoundError();
      return inv;
    },
  },
  Mutation: {
    updateInvoice: async (_: any, { id, input }, ctx) => {
      if (!ctx.can('invoice.update')) throw new ForbiddenError();
      const updated = await db.invoice.updateMany({ where: { id, ownerId: ctx.user.id, tenantId: ctx.tenant.id }, data: pick(input, ['status','memo']) });
      if (updated.count === 0) throw new NotFoundError();
      return true;
    }
  }
};
```

---

# **ì°¸ì¡° í† í°í™”**(ì™¸ë¶€ ID ì„¤ê³„)

## ë‚œìˆ˜í˜• ì™¸ë¶€ ID (UUID/ULID/UUIDv7)

- **ì˜ˆì¸¡ ë¶ˆê°€** + **íƒ€ì„ ì •ë ¬(ULID/UUIDv7)** â†’ UX/ì¸ë±ìŠ¤ ìœ ë¦¬.
- ë‚´ë¶€ PK(ìˆœë²ˆ)ëŠ” **ì ˆëŒ€ ì™¸ë¶€ ë…¸ì¶œ ê¸ˆì§€**.

```ts
// Prisma ì˜ˆ
model Invoice {
  id        String   @id @default(uuid()) // ì™¸ë¶€ì— ê·¸ëŒ€ë¡œ ì“°ëŠ” ë‚œìˆ˜ ID
  internal  Int      @default(autoincrement()) @unique
  tenantId  String
  ownerId   String
}
```

## Capability / ì‚¬ì „ ì„œëª… í† í°(ë‹¤ìš´ë¡œë“œÂ·ê³µìœ )

- **í† í° = ê°ì²´ + ê¶Œí•œ + ë§Œë£Œ + ì„œëª…** (ì˜ˆ: HMAC/JWT).
- ìš”ì²­ ì‹œ í† í°ì„ ê²€ì¦í•˜ê³  **ê¶Œí•œ ë²”ìœ„**ì™€ **ë§Œë£Œ**ë¥¼ í™•ì¸.

```ts
// í† í° ìƒì„±(ì„œë²„)
function signDownload(objectId: string, sub: string, scope='download', ttl=600_000) {
  const payload = { obj: objectId, sub, scope, exp: Date.now()+ttl };
  const sig = hmacSHA256(JSON.stringify(payload), SECRET);
  return base64url(`${JSON.stringify(payload)}.${sig}`);
}

// ê²€ì¦
function verify(token: string, requester: string) {
  const [p64, sig] = token.split('.');
  const payload = JSON.parse(base64urlDecode(p64));
  const ok = hmacSHA256(p64, SECRET) === sig && payload.exp > Date.now() && payload.sub === requester;
  return ok ? payload : null;
}
```

> **ì£¼ì˜**: â€œì‚¬ì „ì„œëª… URLâ€ì€ **ê³µìœ  ë²”ìœ„**ê°€ ì„¤ê³„ ê·¸ ìì²´ì…ë‹ˆë‹¤. **ì§§ì€ ë§Œë£Œ**ì™€ **ìŠ¤ì½”í”„ ì œí•œ**, í•„ìš” ì‹œ **1íšŒì„±**.

---

# **RBAC/ABAC** ì •ì±…

## RBAC (ì—­í•  ê¸°ë°˜)

- ë‹¨ìˆœ/ëª…í™•. ì—”ë“œí¬ì¸íŠ¸/ì˜¤í¼ë ˆì´ì…˜ ë‹¨ìœ„ë¡œ `role âˆ‹ permission` í™•ì¸.

```ts
const PERMS: Record<string, string[]> = {
  admin: ['user.promote','invoice.read','invoice.update','invoice.refund'],
  user:  ['invoice.read','invoice.update:self'],
};
```

## ABAC (ì†ì„± ê¸°ë°˜)

- **subject, object, action, context** ì†ì„±ìœ¼ë¡œ ì„¸ë°€í•˜ê²Œ.

```ts
type Subject = { id: string, tenant: string, roles: string[] };
type Invoice = { id: string, tenantId: string, ownerId: string, status: string };

function canReadInvoice(s: Subject, inv: Invoice) {
  return s.tenant === inv.tenantId && (s.roles.includes('admin') || inv.ownerId === s.id);
}
```

## OPA/Rego ìŠ¤íƒ€ì¼ ì˜ˆ(ê°œë…)

```rego
package auth

default allow = false

allow {
  input.action == "invoice.read"
  input.subject.tenant == input.object.tenantId
  input.subject.id == input.object.ownerId
}

allow {
  input.action == "invoice.read"
  input.subject.roles[_] == "admin"
  input.subject.tenant == input.object.tenantId
}
```

---

# **Mass Assignment** ì°¨ë‹¨

- ì—…ë°ì´íŠ¸ ì…ë ¥ì€ **í—ˆìš© í•„ë“œë§Œ** ì ìš©. `ownerId`, `role`, `tenantId`, `price` ë“± ë¯¼ê° í•„ë“œëŠ” ë³„ë„ ì—”ë“œí¬ì¸íŠ¸/ì›Œí¬í”Œë¡œë¡œ.

```ts
function pick<T extends object>(obj: T, keys: (keyof T)[]) {
  return Object.fromEntries(Object.entries(obj).filter(([k]) => (keys as string[]).includes(k)));
}
```

---

# ì˜¤ë¥˜ ì²˜ë¦¬ & ìºì‹œ

- **404 vs 403**:
  - ì—´ê±° ë°©ì§€ë¥¼ ìœ„í•´ **404ë¡œ í†µì¼**(ì¡´ì¬Â·ê¶Œí•œ ë¶ˆë¬¸) ì „ëµì´ í”í•¨.
  - ë‹¨, **ìê¸° ë¦¬ì†ŒìŠ¤**ì—ëŠ” 403ì„ ì£¼ëŠ” ë°©ì¹¨ë„ ê°€ëŠ¥(ì •ì±… ì¼ê´€ì„± í•„ìš”).
- **ìºì‹œ**: ID ê¸°ë°˜ ë¯¼ê° ì—”ë“œí¬ì¸íŠ¸ëŠ” `Cache-Control: no-store`.
  **í”„ë¡ì‹œ ìºì‹œ**ê°€ ì„ì´ë©´ ê¶Œí•œ ìºì‹± ì‚¬ê³  ë°œìƒ.

```nginx
add_header Cache-Control "no-store" always;
```

---

# ë¡œê¹…/íƒì§€(ì‹¤ë¬´)

- **í•„ë“œ**: `ts`, `uid`, `tenant`, `ip`, `route`, `target_id`, `result(200/404/403)`.
- **íƒì§€ ê·œì¹™**:
  - ë™ì¼ IP/ì‚¬ìš©ìê°€ **ì§§ì€ ì‹œê°„ì— IDë¥¼ ì—°ì† ì‹œë„**(íŒ¨í„´: +1, ëœë¤ ì—´ê±°)
  - **404 ë¹„ìœ¨ ê¸‰ì¦**(íŠ¹íˆ object ë¼ìš°íŠ¸)
  - **ë‹¤ë¥¸ í…Œë„ŒíŠ¸ ID ìš”ì²­**
  - 404â†’200ë¡œ **ì „í™˜**í•œ IDì˜ ë¹„ì •ìƒ ì†ë„

---

# í…ŒìŠ¤íŠ¸(ë‹¨ìœ„/E2E/CI)

## Node + supertest

```ts
it('ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ì²­êµ¬ì„œ ì ‘ê·¼ì€ 404', async () => {
  const me = await loginAs('u1');    // í† í°ì— userId=u1
  const other = await createInvoice({ ownerId: 'u2' });
  await request(app).get(`/api/invoices/${other.id}`).set('Authorization', me).expect(404);
});

it('PATCH í—ˆìš© í•„ë“œë§Œ ë°˜ì˜', async () => {
  const me = await loginAs('u1');
  const inv = await createInvoice({ ownerId: 'u1' });
  await request(app).patch(`/api/invoices/${inv.id}`)
    .set('Authorization', me)
    .send({ status:'paid', ownerId:'u2' })           // ownerId ë¬´ì‹œë˜ì–´ì•¼
    .expect(204);
  const after = await getInvoice(inv.id);
  expect(after.ownerId).toBe('u1');
});
```

## Django pytest

```python
def test_idor(client, user_a, user_b, invoice_b):
    client.force_login(user_a)
    r = client.get(f"/api/invoices/{invoice_b.id}")
    assert r.status_code == 404
```

## ìŠ¤ìºë„ˆ/í”„ë¡œí¼í‹° í…ŒìŠ¤íŠ¸ ì•„ì´ë””ì–´

- ì‹œë“œ IDì—ì„œ Â±N ë²”ìœ„ ìë™ ìš”ì²­ â†’ 2xx ì‘ë‹µ ë°œìƒ ì‹œ ê²½ë³´.
- GraphQL: `id` ì‚¬ì „Â·ë‚œìˆ˜ë¡œ `node(id: â€¦)` íƒìƒ‰ â†’ ê¶Œí•œ ì‹¤íŒ¨ìœ¨ í™•ì¸.

---

# ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ(ìˆœë²ˆ ID â†’ ë‚œìˆ˜ ID)

1) ìŠ¤í‚¤ë§ˆì— `public_id UUID/ULID` ì¶”ê°€(+ UNIQUE).
2) ë°ì´í„° ë°±í•„: `UPDATE t SET public_id = gen_random_uuid();`
3) ì—”ë“œí¬ì¸íŠ¸ë¥¼ `/:public_id`ë¡œ ì „í™˜, í´ë¼ì´ì–¸íŠ¸ ë¦´ë¦¬ì¦ˆ.
4) ì¼ì • ê¸°ê°„ ë¦¬ë‹¤ì´ë ‰íŠ¸/í˜¸í™˜(ë‚´ë¶€ ID â†’ public_id ë§¤í•‘).
5) ë‚´ë¶€ ID ë…¸ì¶œ ì œê±°.

---

# ì²´í¬ë¦¬ìŠ¤íŠ¸ (í˜„ì¥ìš©)

- [ ] **ì¿¼ë¦¬ ë‹¨ê³„**ì—ì„œ `WHERE tenant_id = :me.tenant AND owner_id = :me.id`
- [ ] **ì™¸ë¶€ IDëŠ” ë‚œìˆ˜(UUID/ULID/UUIDv7)**, ë‚´ë¶€ PK ë…¸ì¶œ ê¸ˆì§€
- [ ] **RBAC/ABAC** ì¤‘ì•™ íŒì •(`can(subject, action, object)`)
- [ ] **í—ˆìš© í•„ë“œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸**(mass assignment ì°¨ë‹¨)
- [ ] **ë‹¤ì¤‘ í…Œë„ŒíŠ¸ ìŠ¤ì½”í”„ ê°•ì œ**(ëª¨ë“  ì¿¼ë¦¬/ê²€ìƒ‰/í†µê³„)
- [ ] **íŒŒì¼/ë‹¤ìš´ë¡œë“œëŠ” Capability í† í°**(ê°ì²´Â·ë™ì‘Â·ë§Œë£ŒÂ·ì„œëª…)
- [ ] **404/403 ì „ëµ ì¼ê´€** + **Cache-Control: no-store**
- [ ] **ë¡œê·¸/íƒì§€**: ID ì—´ê±°Â·404 ê¸‰ì¦Â·í…Œë„ŒíŠ¸ ë¶ˆì¼ì¹˜
- [ ] **í…ŒìŠ¤íŠ¸/CI**: ìˆ˜í‰/ìˆ˜ì§ ê¶Œí•œ ì¼€ì´ìŠ¤, ID ì—´ê±° ìë™í™”
- [ ] **ë¬¸ì„œí™”**: ID ê·œì•½, ì •ì±… ì—”ì§„ ê·œì¹™, ì—ëŸ¬/ë¡œê·¸ ê¸°ì¤€

---

## ë§ºìŒë§

BOLA/IDORëŠ” â€œ**í´ë¼ì´ì–¸íŠ¸ê°€ ì¤€ IDë¥¼ ë¯¿ì€ ëŒ€ê°€**â€ì…ë‹ˆë‹¤.
**ì‚¬ì „ í•„í„°(ì†Œìœ ìÂ·í…Œë„ŒíŠ¸)**, **ì¤‘ì•™ ì •ì±…(RBAC/ABAC)**, **ë‚œìˆ˜í˜• ì‹ë³„ìÂ·Capability í† í°**, **í—ˆìš© í•„ë“œ ì—…ë°ì´íŠ¸**ë¥¼ ê¸°ë³¸ê¸°ë¡œ ì‚¼ìœ¼ë©´
ìˆ˜í‰/ìˆ˜ì§ ê¶Œí•œ ì·¨ì•½ì„ **êµ¬ì¡°ì ìœ¼ë¡œ** ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
