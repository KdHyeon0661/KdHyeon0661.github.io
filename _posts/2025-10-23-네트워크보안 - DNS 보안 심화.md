---
layout: post
title: 네트워크보안 - DNS 보안 심화
date: 2025-10-23 23:25:23 +0900
category: 네트워크보안
---
# 8. DNS 보안 심화

## 8.1 도메인 생태계와 위협 모델

### 8.1.1 생태계 훑어보기
- **Registrant(등록자)** ↔ **Registrar(등록대행)** ↔ **Registry(레지스트리, TLD 운영자)**  
- **권한(Authoritative) DNS**: 존(Zone) 파일을 보유·응답  
- **재귀(Resolver)**: 클라이언트 대신 조회(캐시·검증) — 기업 내부는 **엔터프라이즈 리졸버** 권장  
- **Glue**: 부모 존이 보유하는 자식 NS의 A/AAAA(‘부트스트랩’용); 잘못되면 **네임서버 하이재킹**로 직결

### 8.1.2 대표 위협 모델
- **계정/레지스트라 탈취**: 2FA 미적용·이메일 탈취로 네임서버/연락처 변경 → 전체 접수  
- **Glue/NS 하이재킹**: 부모 존(NS/Glue) 변경으로 트래픽 가로채기  
- **Zone Shadowing**: 합법 존에 **은닉 서브도메인**을 대량 생성해 악성 호스팅  
- **Dangling DNS(서브도메인 테이크오버)**: CNAME/NS/A가 **없어진 리소스**를 가리킴 → 제3자가 점유  
- **Fast-Flux/DGA**: 짧은 TTL, 다수 A/NS 로테이션, 알고리즘 생성 도메인  
- **IDN Homograph**: 유사 문자(라틴 ‘a’ vs 키릴 ‘а’)로 **피싱**  
- **Split-Horizon/내·외부 응답 상이**: 정책 혼선·오류로 **우회/정보유출**  
- **캐시 포이즈닝/랜덤 서브도메인/NXNS류**: 리졸버·권한서버 구현 취약/오용  
- **DNS隧道/데이터 유출**: TXT/NULL/NXDomain 패턴으로 은닉 전송

> 핵심: **등록자 계정·NS/Glue·권한DNS·리졸버** 어느 한 곳이 뚫려도 전체 보안이 무너진다.

---

## 8.2 DNSSEC 개념과 운영 난점

### 8.2.1 핵심 개념
- **서명된 존**: RRset에 **RRSIG** 부착, 공개키는 **DNSKEY**, 부모는 **DS**로 체인 연결  
- **KSK/ZSK 분리**:  
  - **KSK**(Key Signing Key): DNSKEY RRset 서명, **DS 등록/롤오버 영향 큼**  
  - **ZSK**(Zone Signing Key): 다른 RRset 서명, **더 잦은 교체 가능**  
- **NSEC/NSEC3**: 부존재(negative) 증명. NSEC3는 사전(dictionary) 역탐색 완화(Opt-Out 옵션 주의)  
- **검증(Validator)**: 리졸버가 체인을 따라 **서명 검증** → 위·변조 탐지

### 8.2.2 운영 난점(현업 포인트)
- **KSK 롤오버**: DS 변경은 **레지스트리/레지스트라** 참여가 필요 → 절차·지연·실수 위험  
- **대형 DNSKEY/UDP 분절**: 큰 응답은 **분절/조각**으로 손실 ↑ → **EDNS 크기/TC=1/TCP 폴백** 튜닝 필요  
- **알고리즘 교체**: RSA→ECDSA(P-256)/Ed25519 로 전환 시 **검증기 호환성** 확인  
- **CDS/CDNSKEY(자동 DS 배포)**: 자동화 편리하지만, **권한 확인/변조 위험** 고려해 정책·감사를 병행  
- **서명 만료/시계 문제**: RRSIG 만료·NTP 오차로 **대규모 해석 실패** 가능 → 모니터링 필수

### 8.2.3 랩: 작은 존 서명(권한DNS: BIND)

**1) 간단 존 파일(`example.internal`)**
```
$TTL 300
@   IN SOA ns1.example.internal. dnsadmin.example.internal. (1 60 30 604800 60)
    IN NS  ns1.example.internal.
ns1 IN A   10.0.0.53
www IN A   10.0.0.80
```

**2) 키 생성 & 서명**
```bash
# ZSK/KSK 생성(알고리즘 ECDSAP256SHA256 예)
dnssec-keygen -a ECDSAP256SHA256 -b 256 -n ZONE example.internal
dnssec-keygen -f KSK -a ECDSAP256SHA256 -b 256 -n ZONE example.internal

# 존 서명
dnssec-signzone -o example.internal -N increment -g -k Kexample.internal.+013+KSKID.key example.internal
# 결과: example.internal.signed, dsset-example.internal.
```

**3) named.conf 발췌**
```conf
zone "example.internal" IN {
  type master;
  file "/var/named/example.internal.signed";
  auto-dnssec maintain;    // 자동 재서명
  inline-signing yes;
};
```

**4) 검증 테스트**
```bash
# 리졸버에서 도메인 확인(+DO 플래그로 DNSSEC 데이터 요청)
dig +dnssec www.example.internal
# 권한 서버에서 RRSIG/DNSKEY 유무 확인
dig @10.0.0.53 DNSKEY example.internal +multi +dnssec
```

> 실제 운영: KSK 롤오버 정책(예: 연 1회), ZSK는 더 자주(예: 30~90일) 자동 교체, 모니터링 경보(만료 14일 전).

### 8.2.4 리졸버(검증기) 구성: Unbound
```yaml
# /etc/unbound/unbound.conf.d/validator.conf
server:
  auto-trust-anchor-file: "/var/lib/unbound/root.key"
  qname-minimisation: yes
  harden-below-nxdomain: yes
  harden-algo-downgrade: yes
  prefetch: yes

# 실패 시 진단: unbound-control lookup/dnstap로 원인 파악(시계·체인·알고리즘)
```

### 8.2.5 DNSSEC 운영 체크리스트(요약)
- [ ] KSK/ZSK 분리, 롤오버 일정/절차 문서화(레지스트리 단계 포함)  
- [ ] EDNS 사이즈, TCP 폴백, 프래그멘테이션 모니터링  
- [ ] RRSIG 만료/서명 주기 알림, NTP 정확도 SLO  
- [ ] CDS/CDNSKEY 사용 시 승인 체계/감사 로그  
- [ ] 알고리즘·키 길이 정책(현대 곡선 우선: ECDSA/Ed25519)

---

## 8.3 피싱 도메인 헌팅, Sinkhole/블랙홀

### 8.3.1 피싱 헌팅 시그널
- **NOD(Newly Observed Domain)**: 등록/최초 관측 후 **24~72h 이내** 트래픽 집중  
- **유사 도메인(타이포/동형이의어)**: Levenshtein 거리, **IDN confusable** 매핑  
- **CT(인증서 투명성) 로그**: 새 인증서(SAN) 중 **브랜드 유사 문자열** 필터  
- **서브도메인 깊이/폭**: 짧은 시간 **대량 생성/삭제**  
- **메일 정합성**: SPF/DKIM/DMARC 미정의/오정의와 결합  
- **DGA 특징**: **높은 엔트로피**, n-gram 분포 비정상, 모음/자음 패턴 왜곡  
- **NXDomain 폭주**: 터널링/무차별 시도 징후

### 8.3.2 간단 도메인 스코어러(파이썬, 외부패키지 없이)
```python
# domain_score.py
# 입력: 도메인 목록 → 피싱 위험 점수(엔트로피, 길이, n-gram, 브랜드 유사도, IDN 혼동)
import math, unicodedata

BRANDS = ["paypal", "naver", "kakao", "google", "apple", "microsoft"]

def shannon_entropy(s):
    from collections import Counter
    c = Counter(s)
    n = len(s)
    return -sum((count/n)*math.log2(count/n) for count in c.values())

def levenshtein(a, b):
    dp = list(range(len(b)+1))
    for i, ca in enumerate(a,1):
        ndp = [i] + [0]*len(b)
        for j, cb in enumerate(b,1):
            ndp[j] = min(dp[j]+1, ndp[j-1]+1, dp[j-1]+(ca!=cb))
        dp = ndp
    return dp[-1]

CONFUSABLE = {
    "а":"a","е":"e","о":"o","р":"p","с":"c","у":"y","х":"x",  # Cyrillic→Latin
    "０":"0","１":"1","５":"5","６":"6","９":"9"             # fullwidth digits
}

def to_skeleton(label):
    out=[]
    for ch in label:
        out.append(CONFUSABLE.get(ch, ch))
    return ''.join(out)

def score_domain(d):
    d = d.strip().lower().encode("idna").decode()  # normalize IDN
    labels = d.split(".")
    sld = labels[-2] if len(labels)>1 else labels[0]
    skel = to_skeleton(sld)
    ent = shannon_entropy(skel)
    # 브랜드 유사도(최소 거리)
    lev_min = min(levenshtein(skel, b) for b in BRANDS)
    # 특징 조합(가중치는 예시)
    score = 0
    score += 10 if ent > 3.5 else 0
    score += 8  if len(sld) >= 12 else 0
    score += 12 if lev_min <= 2 else 0
    score += 6  if any(c.isdigit() for c in sld) else 0
    score += 6  if "-" in sld else 0
    depth = len(labels)
    score += 5 if depth >= 4 else 0  # deep subdomain
    return {"domain": d, "entropy": round(ent,2), "lev_min": lev_min, "depth": depth, "score": score}

if __name__ == "__main__":
    samples = ["paypa1-login-secure.com", "xn--pple-43a.com", "gogle-security-update.net",
               "news.example.com", "na-ver-login.co", "xn--navr-9o0b.com"]
    for s in samples:
        print(score_domain(s))
```

> 실제 운영에서는 **피쳐 엔지니어링 + ML(One-Class/IsolationForest)**로 정교화하고, **CT/Passive DNS**를 결합합니다.

### 8.3.3 Sinkhole / 블랙홀 운영

**(A) RPZ(응답 정책 존)** — Resolver에서 정책 기반 차단/리다이렉트  
- **블록**: `NXDOMAIN`/`NODATA` 응답  
- **싱크홀**: 내부 웹서버로 **리다이렉트**(차단 페이지/텔레메트리)

**Unbound RPZ 예시(요약)**
```yaml
server:
  module-config: "validator iterator"
  aggressive-nsec: yes

rpz:
  name: "corp-block"
  zonefile: "/etc/unbound/rpz/corp-block.zone"
  # action: nxdomain / nodata / redirect
```

**RPZ 존 파일(싱크홀)**
```
$TTL 60
@       IN  SOA rpz.local. noc.rpz.local. (1 60 60 86400 60)
        IN  NS  localhost.
*.malicious-example.com. CNAME sinkhole.corp.local.
bad-login.co.            CNAME sinkhole.corp.local.
```

**(B) 권한DNS에서 블랙홀(권장 적음)**  
- 내부 권한DNS에서 NXDOMAIN 유도 가능하나, **정책은 리졸버(RPZ)** 측에서 일원화가 깔끔

**(C) 싱크홀 웹서버**
- 접근 시 **세션/UA/IP/Referer** 로깅 → 임직원 보호 교육/대응  
- 개인정보·과도한 수집 금지, 보관 기간 제한

### 8.3.4 CT 로그 감시(개념 파이프라인)
- **certstream**(실시간 WebSocket) 수집 → **브랜드 키워드/레벤슈타인** 필터 → **대상 도메인 자동 스코어링** → **RPZ(관찰→차단)**  
- 운영: **관찰 단계**에서 오탐 분석 → **차단 승격** 플로우 필수

### 8.3.5 Zeek/Suricata 탐지 아이디어

**Zeek(의사코드): NOD + 엔트로피/깊이**
```zeek
@load protocols/dns
event dns_request(c: connection, msg: dns_msg, query: string) {
  local labels = split_string(query, /\./);
  if (|labels| >= 4) {
    NOTICE([$note=DNS_Suspicious_Depth, $msg=fmt("%s depth=%d", query, |labels|)]);
  }
}
```

**Suricata(EVE 후단 룰 개념)**
```
if event_type == "dns" AND dns.rcode_name == "NXDOMAIN" AND count_by_src_ip_over_1m > 500:
  alert("Possible DNS tunneling / brute")
```

---

## 8.4 실습: 내부 도메인 보안 체크리스트

### 8.4.1 두 줄 요약
1) **등록자/레지스트라 보안**이 최우선(2FA, **Registry Lock**, 연락처 검증, 계정 접근제어).  
2) **권한DNS/리졸버**를 분리해서 운영하며, **DNSSEC + RPZ + 모니터링** 3종 세트를 갖춘다.

### 8.4.2 체크리스트(세부)

#### A. 등록·레지스트라
- [ ] 계정 **2FA/MFA**  
- [ ] **Registry Lock**(레지스트리 수준 변경 보호) 신청  
- [ ] 연락처/네임서버 변경 시 **승인 워크플로우** & 감사 로깅  
- [ ] **Whois Privacy** 적용 시 내부 비상연락 경로 별도 확보

#### B. 네임서버/Glue/권한DNS
- [ ] **NS 다양성**(다중 벤더/ASN 권장, 지리 분산)  
- [ ] **Glue 정확성**: 부모·자식 간 일치, TTL 합리화(짧게 바꾸면 잦은 조회 비용↑)  
- [ ] **DNSSEC 서명**(KSK/ZSK 분리, RRSIG 모니터링)  
- [ ] **서브도메인 위임(NS Delegation)** 시 책임 분리/변경 프로세스 문서화  
- [ ] **Dangling 레코드** 점검(주기적으로 CNAME/A/NS 대상 리소스 존재 검사)  
- [ ] AXFR 제한(ACL/TSIG), 동적 업데이트 `update-policy` 최소화

#### C. 리졸버(엔터프라이즈)
- [ ] **DNSSEC 검증** 활성 + 실패 알림  
- [ ] **RPZ**로 차단/싱크홀(관찰→차단 승격 플로우)  
- [ ] **Qname 최소화**, 하드닝 옵션(`harden-below-nxdomain` 등)  
- [ ] **DoH/DoT 정책**: 허용 목록 외 차단·감시(프록시 경유 강제)  
- [ ] **로그/지표**: NXDOMAIN, NOD, 상위 Talker, 쿼리 폭주, TCP fallback율

#### D. 메일·도메인 세트
- [ ] **SPF/DKIM/DMARC** 올바른 설정, DMARC **p=quarantine/reject** 목표  
- [ ] **유사 도메인 선점**(브랜드 보호), 자동 감시(CT/Passive DNS)

#### E. 모니터링/대응
- [ ] **CT 로그**: 신규 인증서 → 스코어링 → RPZ 관찰 등록  
- [ ] **Passive DNS**: 이력 조회(보안 벤더/자산)  
- [ ] **플레이북**: 피싱 확인 → 차단(레코드/RPZ) → 임직원 알림/교육 → 증거 보관/기간

### 8.4.3 작은 실습(엔드투엔드)

**Step 1) 권한DNS BIND + 서명 존 배포**
- 8.2.3 예시대로 `example.internal` 서명 → named 재시작  
- `dig +dnssec` 로 RRSIG 확인

**Step 2) 리졸버 Unbound + RPZ**
- 8.3.3 예시대로 RPZ 구성, 싱크홀 도메인 추가  
- 테스트:
```bash
dig @<UNBOUND_IP> bad-login.co
# → 싱크홀 CNAME/주소로 응답되어야 함
```

**Step 3) 스코어러로 도메인 평가 → RPZ 자동 반영(개념)**
```bash
python3 domain_score.py > scores.jsonl
# score >= 20 이상 도메인을 RPZ 존에 append 후, unbound-control reload
```

**Step 4) 모니터링**
- NXDOMAIN 비율, TCP fallback률, RRSIG 만료 임박 알림  
- 싱크홀 접근 로그(개인정보 최소 수집)로 임직원 교육·보호

---

## 부록 A: BIND — 권한DNS 하드닝 스니펫
```conf
options {
  rate-limit { responses-per-second 50; window 5; };
  minimal-responses yes;
  recursion no;            // 권한DNS는 재귀 금지
  allow-transfer { none; }; // AXFR 제한(필요 시 TSIG+IP ACL)
  dnssec-enable yes;
  dnssec-validation no;   // 권한DNS는 검증자가 아님
  tcp-clients 1000;
  edns-udp-size 1232;     // 분절 위험 완화(네트워크 MTU 고려)
};
```

## 부록 B: Unbound — 리졸버 하드닝 스니펫
```yaml
server:
  qname-minimisation: yes
  harden-below-nxdomain: yes
  harden-glue: yes
  harden-referral-path: yes
  edns-buffer-size: 1232
  do-ip6: yes
  do-tcp: yes
  unwanted-reply-threshold: 10000
```

## 부록 C: Dangling CNAME 탐지(간단 스캐너)
```python
# dangling_check.py
# CNAME 대상이 NXDOMAIN/NoError(NODATA)·폐쇄 클라우드 리소스를 가리키는지 검사
import subprocess, sys, json

def dig(name, rr="CNAME"):
    out = subprocess.run(["dig","+short",rr,name],capture_output=True,text=True).stdout.strip()
    return out.splitlines()

def exists(host):
    # 간단 존재감 체크(A/AAAA가 하나라도 있으면 존재하는 것으로 판단)
    return bool(dig(host,"A") or dig(host,"AAAA"))

bad = []
for dn in sys.stdin:
    dn = dn.strip()
    cn = dig(dn,"CNAME")
    if not cn:
        continue
    target = cn[0].rstrip(".")
    if not exists(target):
        bad.append({"domain":dn, "cname_target":target, "issue":"dangling"})
print(json.dumps(bad, indent=2))
```

## 부록 D: 운영 대시보드 지표(아이디어)
- **Resolver**: qps, NXDOMAIN%, NOD%, TCP fallback%, Top QNAME, Top Clients  
- **Auth**: 응답 사이즈 상위, Truncation율, 서명 만료 D-일수, AXFR 실패  
- **보안**: RPZ hit, 싱크홀 hit, JA3/도메인 평판 상관, 신규 CT 관찰 수

---

## 요약
- **DNSSEC**은 무결성의 핵심이지만 **KSK/DS/EDNS/분절** 등 **운영 난점**을 가진다—자동화와 모니터링이 필수.  
- **피싱 헌팅**은 **NOD·유사도·IDN·CT·Passive DNS**를 결합한 **스코어링/승격** 파이프라인이 핵심.  
- **RPZ 싱크홀**로 안전하게 **차단/관찰**을 운영하고, **리졸버 하드닝**으로 캐시 포이즈닝·오용을 줄인다.  
- **체크리스트**를 통해 등록·권한DNS·리졸버·메일·대응을 전 주기로 다지고,  
  **작은 랩**에서 엔드투엔드로 **검증→자동화**까지 연결하라.
