---
layout: post
title: ì›¹í•´í‚¹ - SSTI
date: 2025-09-30 20:25:23 +0900
category: ì›¹í•´í‚¹
---
# ğŸ§© 4. SSTI(Server-Side Template Injection) â€” ê°œë…Â·ê·¼ë³¸ ì›ì¸Â·ì•ˆì „í•œ ì¬í˜„/íƒì§€Â·í”„ë ˆì„ì›Œí¬ë³„ ë°©ì–´ íŒ¨í„´(ì˜ˆì œ ì¤‘ì‹¬)

## í•œëˆˆì— ë³´ê¸°

- **SSTI(Server-Side Template Injection)**: í…œí”Œë¦¿ ì—”ì§„(Jinja2/Twig/FreeMarker/Thymeleaf/ERB ë“±)ì´ **ì‚¬ìš©ì ì…ë ¥ì„ â€œë°ì´í„°â€ê°€ ì•„ë‹ˆë¼ â€œí‘œí˜„ì‹/ì½”ë“œâ€ë¡œ í‰ê°€**í•˜ëŠ” ë°”ëŒì— ì„œë²„ì—ì„œ **ì˜ë„ì¹˜ ì•Šì€ ì‹¤í–‰/íŒŒì¼ ì ‘ê·¼**ì´ ì¼ì–´ë‚˜ëŠ” ì·¨ì•½ì„±.
- **ì™œ ìœ„í—˜í•œê°€?**
  ì„œë²„ë‹¨ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ **XSS ê°™ì€ í´ë¼ì´ì–¸íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì°¨ë‹¨ì±…(CSP, HttpOnly)** ê³¼ ë¬´ê´€í•˜ê²Œ **ì„œë²„ ë¦¬ì†ŒìŠ¤**ê°€ ë…¸ì¶œÂ·ìˆ˜ì •ë  ìˆ˜ ìˆìŒ.
- **ì „í˜•ì ì¸ ì‹¤ìˆ˜**
  1) ì‚¬ìš©ì ì…ë ¥ì„ **í…œí”Œë¦¿ ë¬¸ìì—´**ë¡œ ì§ì ‘ ë Œë”(`render_template_string`, `fromString`, `Template(...)`)
  2) ì‚¬ìš©ì ì…ë ¥ì„ **í…œí”Œë¦¿ ê²½ë¡œ/ì´ë¦„**ìœ¼ë¡œ ì‚¬ìš©(ê²½ë¡œ ì¡°ì‘Â·ëŒ€ì²´ í…œí”Œë¦¿ ë¡œë”©)
  3) â€œí¼ìŠ¤ë„ë¼ì´ì¦ˆâ€ ê¸°ëŠ¥ì„ êµ¬í˜„í•œë‹¤ë©° **í‘œí˜„ì‹ì´ ê°€ëŠ¥í•œ ì—”ì§„**ì— **ì‚¬ìš©ì ì‘ì„± ë¬¸ë²•**ì„ ê·¸ëŒ€ë¡œ ë¨¹ì„
  4) ë°ì´í„° ëª¨ë¸ì— **í”„ë ˆì„ì›Œí¬/ì‹œìŠ¤í…œ ê°ì²´**ë¥¼ ê·¸ëŒ€ë¡œ ë‹´ì•„ ë„˜ê¹€(ë©”ì„œë“œÂ·ì†ì„± ë…¸ì¶œ)

- **í•µì‹¬ ë°©ì–´**
  - **ë¡œì§ ì—†ëŠ” í…œí”Œë¦¿(Logic-less)** ì›ì¹™: *í…œí”Œë¦¿ì€ ë·°, ë¡œì§ì€ ì½”ë“œ*.
  - **ë³€ìˆ˜ë§Œ ë°”ì¸ë”©**: ì‚¬ìš©ì ì…ë ¥ì€ **ê°’**ìœ¼ë¡œë§Œ ì „ë‹¬, **í…œí”Œë¦¿/í‘œí˜„ì‹/ê²½ë¡œ**ì—” ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€.
  - **í…œí”Œë¦¿ ì„ íƒì€ ë§¤í•‘(í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸)**: `id â†’ ê³ ì • í…œí”Œë¦¿` ë§µí•‘ë§Œ í—ˆìš©.
  - **ì—”ì§„ ë³´ì•ˆ ì„¤ì •**: *ì—„ê²© ëª¨ë“œ*, *Sandbox/Restricted wrapper*, *ë¯¸ì •ì˜ ë³€ìˆ˜ ì—ëŸ¬*, *API ë…¸ì¶œ ì°¨ë‹¨*.
  - **ì‚¬ìš©ì ì •ì˜ ë¬¸ë²•ì´ í•„ìš”í•œ ê²½ìš°**: í‘œí˜„ì‹ ë¶ˆê°€í•œ **Logic-less ì—”ì§„(Handlebars/Mustache/Liquid ê³„ì—´)** ë¡œ í•œì • + **í—ˆìš© í† í° í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸**.

---

## SSTI ë™ì‘ ì›ë¦¬ â€” â€œë°ì´í„°ê°€ ì½”ë“œê°€ ë˜ëŠ” ìˆœê°„â€

í…œí”Œë¦¿ ì—”ì§„ì€ ë¬¸ìì—´ ì•ˆì˜ **í‘œí˜„ì‹/ì§€ì‹œì–´**ë¥¼ í•´ì„í•˜ì—¬ ë™ì ìœ¼ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
- ì•ˆì „í•œ ê²½ìš°: `render("hello.html", {name: user_input})` â†’ í…œí”Œë¦¿ ì—”ì§„ì´ **ë³€ìˆ˜ë¡œì¨** `name`ì„ ì¶œë ¥(í•„ìš” ì‹œ ì´ìŠ¤ì¼€ì´í”„).
- ìœ„í—˜í•œ ê²½ìš°: `render_string(user_input)` ë˜ëŠ” `render(template_name=user_input)` â†’ ì…ë ¥ì´ **í…œí”Œë¦¿ ê·¸ ìì²´**ë¡œ í‰ê°€ë˜ì–´ ì—”ì§„ì˜ **í‘œí˜„ì‹ í‰ê°€ê¸°**ê°€ ì‹¤í–‰.

> ì •ë¦¬: **â€œí…œí”Œë¦¿=ì½”ë“œ, ë³€ìˆ˜=ë°ì´í„°â€**. ì‚¬ìš©ìê°€ ë§Œì§€ëŠ” ê±´ **ë³€ìˆ˜**ê¹Œì§€ë§Œ í—ˆìš©í•´ì•¼ í•˜ë©°, **í…œí”Œë¦¿/í‘œí˜„ì‹/ê²½ë¡œ**ëŠ” ì ˆëŒ€ ì•ˆ ë©ë‹ˆë‹¤.

---

## ì·¨ì•½ ì‹œë‚˜ë¦¬ì˜¤ì™€ ì•ˆì „ ëŒ€ì²´ ì„¤ê³„

### â€œëœë” í…œí”Œë¦¿ ìŠ¤íŠ¸ë§â€ ì˜¤ìš©

**âŒ ì·¨ì•½ (Flask + Jinja2)**
```python
from flask import Flask, request, render_template_string
app = Flask(__name__)

# "ë¯¸ë¦¬ë³´ê¸°"ë¥¼ ë§Œë“ ë‹¤ë©° ì‚¬ìš©ì ì…ë ¥ì„ í…œí”Œë¦¿ìœ¼ë¡œ ì§ì ‘ í‰ê°€

@app.post("/preview")
def preview():
    raw = request.form.get("body", "")
    return render_template_string(raw)  # â† ì‚¬ìš©ì ì…ë ¥ì´ 'í…œí”Œë¦¿'ì´ ë¨ (ê¸ˆì§€)
```

**âœ… ì•ˆì „ ëŒ€ì²´**
{% raw %}
```python
from flask import render_template, escape

@app.post("/preview")
def preview():
    raw = request.form.get("body", "")
    # 1) í…ìŠ¤íŠ¸ë¡œë§Œ ì¶œë ¥: í…œí”Œë¦¿ì€ ê³ ì •, ì‚¬ìš©ì ì…ë ¥ì€ ë°ì´í„°
    return render_template("preview.html", body=raw)  # í…œí”Œë¦¿: {{ body }} (autoescape on)

# preview.html (Jinja2 ê¸°ë³¸ autoescape)
# <h1>Preview</h1>
# <pre>{{ body }}</pre>   <!-- ë°ì´í„°ë¡œë§Œ ì‚¬ìš© -->

```
{% endraw %}

### â€œí…œí”Œë¦¿ ì„ íƒ/ê²½ë¡œâ€ë¥¼ ì…ë ¥ìœ¼ë¡œ ë°›ëŠ” ê²½ìš°

**âŒ ì·¨ì•½ (Twig ì˜ˆ)**
```php
// /render?tpl=invoice.html ê°™ì€ ë°©ì‹ìœ¼ë¡œ íŒŒì¼ëª…/ê²½ë¡œë¥¼ ê·¸ëŒ€ë¡œ ë°›ìŒ
$tpl = $_GET['tpl'];                     // ì˜ˆ: ../../../../etc/passwd ë¼ë©´?
echo $twig->render($tpl, ['user'=>$u]);  // íŒŒì¼ í¬í•¨/ê²½ë¡œ ì¡°ì‘ ìœ„í—˜ + ì„ì˜ í…œí”Œë¦¿ ì‹¤í–‰
```

**âœ… ì•ˆì „ ëŒ€ì²´(í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë§µí•‘)**
```php
$allowed = [
  'invoice' => 'tpl/invoice.html.twig',
  'welcome' => 'tpl/welcome.html.twig'
];
$key = $_GET['tpl'] ?? '';
if (!array_key_exists($key, $allowed)) { http_response_code(400); exit; }
echo $twig->render($allowed[$key], ['user' => $u]);
```

### â€œí¼ìŠ¤ë„ë¼ì´ì¦ˆ ë¬¸ë²•â€ ìˆ˜ìš”ê°€ ìˆì„ ë•Œ

- **ë‚˜ìœ ì ‘ê·¼**: ì™„ì „í•œ í…œí”Œë¦¿ ì—”ì§„(Jinja2/Freemarker ë“±)ì˜ **í‘œí˜„ì‹/í•¨ìˆ˜**ê¹Œì§€ ì—´ì–´ì¤Œ â†’ ê³§ SSTI í‘œë©´.
- **ì¢‹ì€ ì ‘ê·¼**: **Logic-less ì—”ì§„**(Mustache/Handlebars/Liquid) + **í—ˆìš© í† í°ë§Œ** ì¹˜í™˜.

**âœ… ì˜ˆ: â€œí† í° ë¦¬ì¡¸ë²„â€ ì§ì ‘ êµ¬í˜„ (Node)**
```js
// ì§€ì› í† í°: [[name]], [[date]], [[company]] â€” í‘œí˜„ì‹/í•¨ìˆ˜ ì—†ìŒ
const TOKENS = new Map([
  ["[[name]]",    (ctx) => ctx.name ?? ""],
  ["[[date]]",    (ctx) => new Date().toISOString().slice(0,10)],
  ["[[company]]", (ctx) => ctx.company ?? ""],
]);

export function renderTokens(template, ctx) {
  // ë³µì¡í•œ ì •ê·œì‹/í‰ê°€ê¸° ì—†ì´ í† í° ì‚¬ì „ ë§¤ì¹­ë§Œ
  let out = template;
  for (const [t, fn] of TOKENS) out = out.split(t).join(String(fn(ctx)));
  return out;
}
```

---

## í”„ë ˆì„ì›Œí¬/ì—”ì§„ë³„ ë°©ì–´ ì²´í¬ë¦¬ìŠ¤íŠ¸ & ì½”ë“œ

> ê³µí†µ: **ì‚¬ìš©ì ì…ë ¥ì„ í…œí”Œë¦¿/ê²½ë¡œ/í‘œí˜„ì‹ì— ì ˆëŒ€ ì“°ì§€ ë§ ê²ƒ**. â€œë°ì´í„° ë°”ì¸ë”©â€ë§Œ í—ˆìš©.

### Python â€” Jinja2(Flask/FastAPI ë“±)

**ê¶Œì¥ ì„¤ì •**
```python
from jinja2 import Environment, FileSystemLoader, StrictUndefined, select_autoescape

env = Environment(
    loader=FileSystemLoader("templates"),
    autoescape=select_autoescape(["html","xml"]),
    undefined=StrictUndefined,  # ë¯¸ì •ì˜ ë³€ìˆ˜ ì ‘ê·¼ ì‹œ ì¦‰ì‹œ ì—ëŸ¬(ì‹¤íŒ¨-ìš°ì„ )
)

# SandboxëŠ” ë³´ì¡° ìˆ˜ë‹¨ì¼ ë¿ "í‘œí˜„ì‹ í—ˆìš©" ìš”êµ¬ ìì²´ë¥¼ ì¤„ì´ëŠ” ê²Œ ë³¸ì§ˆ
# from jinja2.sandbox import SandboxedEnvironment

```

**íŒ¨í„´ ìš”ì•½**
- `render_template_string` **ê¸ˆì§€**.
- í…œí”Œë¦¿ì€ **ê³ ì • íŒŒì¼**ì—ì„œë§Œ ë¡œë“œ(í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸).
- **ë°ì´í„° ëª¨ë¸**ì— í”„ë ˆì„ì›Œí¬/ì‹œìŠ¤í…œ ê°ì²´(ìš”ì²­/ì‘ë‹µ, íŒŒì¼ í•¸ë“¤ëŸ¬ ë“±) ë„£ì§€ ì•Šê¸°.
- ì˜ˆì™¸ë¥¼ **ë¡œê·¸/ì•Œë¦¼**ìœ¼ë¡œ ì „í™˜(ë‚´ë¶€ ì •ë³´ ë…¸ì¶œ ê¸ˆì§€).

**ì•ˆì „ í…ŒìŠ¤íŠ¸(â€œí‰ê°€â€ê°€ ì•„ë‹Œ â€œê·¸ëŒ€ë¡œ ì¶œë ¥â€ í™•ì¸)**
> ëª©ì : íŠ¹ì • í…ìŠ¤íŠ¸({% raw %}`{{ ... }}`{% endraw %} ê°™ì€ íŒ¨í„´)ê°€ **í‰ê°€ ë˜ì§€ ì•Šê³  ë¬¸ì ê·¸ëŒ€ë¡œ** ë³´ì´ëŠ”ì§€ í™•ì¸.
{% raw %}
```python
def test_preview_literal(client):
    r = client.post("/preview", data={"body": "Hello {{ username }} !"})
    assert "{{ username }}" in r.text   # â† í‘œí˜„ì‹ì´ ê·¸ëŒ€ë¡œ ë³´ì´ë©´ ì•ˆì „í•œ ì¶œë ¥
```
{% endraw %}

### PHP â€” Twig

**ê¶Œì¥ ì„¤ì •**
```php
$loader = new \Twig\Loader\FilesystemLoader('/var/app/templates');
$twig = new \Twig\Environment($loader, [
  'cache' => '/var/app/twig-cache',
  'autoescape' => 'html',
  'strict_variables' => true, // ë¯¸ì •ì˜ ë³€ìˆ˜ ì‚¬ìš©ì‹œ ì—ëŸ¬
]);

// (ì„ íƒ) Sandbox ì •ì±…: í—ˆìš© íƒœê·¸/í•„í„°/í•¨ìˆ˜ë§Œ
// $policy = new \Twig\Sandbox\SecurityPolicy([...]);
// $sandbox = new \Twig\Extension\SandboxExtension($policy, true);
// $twig->addExtension($sandbox);
```

**íŒ¨í„´ ìš”ì•½**
- `createTemplate`/`render`ì— **ì‚¬ìš©ì ë¬¸ìì—´** ì§ì ‘ ì „ë‹¬ ê¸ˆì§€.
- í…œí”Œë¦¿ ì„ íƒì€ **í‚¤â†’íŒŒì¼** ë§µìœ¼ë¡œë§Œ.
- ì‚¬ìš©ì ì½˜í…ì¸ ëŠ” í…ìŠ¤íŠ¸ë¡œ ë°”ì¸ë”© + ìë™ ì´ìŠ¤ì¼€ì´í”„.

**ì•ˆì „ í…ŒìŠ¤íŠ¸**
{% raw %}
```php
// PHPUnit ì˜ˆì‹œ
$resp = $client->post('/preview', ['body' => 'Hello {{ now }}']);
$this->assertStringContainsString('{{ now }}', (string)$resp->getBody());
```
{% endraw %}

### Java â€” FreeMarker

**ê¶Œì¥ ì„¤ì •**
```java
Configuration cfg = new Configuration(Configuration.VERSION_2_3_32);
cfg.setClassLoaderForTemplateLoading(getClass().getClassLoader(), "/templates");
cfg.setDefaultEncoding("UTF-8");
cfg.setLogTemplateExceptions(false);
cfg.setTemplateExceptionHandler(TemplateExceptionHandler.RETHROW_HANDLER);

// ìœ„í—˜ ì¶•ì†Œ: API / ë©”ì„œë“œ ë…¸ì¶œ ì œí•œ
cfg.setAPIBuiltinEnabled(false); // ?api ë¹„í™œì„±í™”
// ë°ì´í„° ëª¨ë¸ì—” Map/DTOë§Œ â†’ ì„ì˜ ê°ì²´/ë©”ì„œë“œ ì°¸ì¡° ë°©ì§€
```

**íŒ¨í„´ ìš”ì•½**
- `new Template(String name, Reader reader, ...)`ì— ì‚¬ìš©ì ë¬¸ìì—´ ê¸ˆì§€.
- `?api`, `?new` ë“± **ê°•ë ¥ ê¸°ëŠ¥ ë¹„í™œì„±í™”**(ë²„ì „/ì„¤ì • í™•ì¸).
- í…œí”Œë¦¿ ê²½ë¡œëŠ” **ì •í•´ì§„ ë¡œë”** ê¸°ë°˜ + í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸.

**ì•ˆì „ í…ŒìŠ¤íŠ¸**
```java
String body = "Hello ${ user_input }";
String out = renderPreview(body, Map.of("user_input", "Alice"));
// ì•ˆì „ ì„¤ê³„ë¼ë©´ "${ user_input }" ê·¸ëŒ€ë¡œ ë³´ì—¬ì•¼ í•¨(í…œí”Œë¦¿ìœ¼ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ)
assertTrue(out.contains("${ user_input }"));
```

### Java â€” Thymeleaf(Spring)

- ThymeleafëŠ” SpEL/OGNL í‰ê°€ë¥¼ í¬í•¨. **ì‚¬ìš©ì ì…ë ¥ìœ¼ë¡œ í…œí”Œë¦¿ ì¡°ë¦½ ê¸ˆì§€**.
- HTML í…œí”Œë¦¿ íŒŒì¼ ê³ ì • + ëª¨ë¸ì— ê°’ë§Œ ë°”ì¸ë”©.
- `th:utext`(ì–¸ì´ìŠ¤ì¼€ì´í”„) ë‚¨ìš© ê¸ˆì§€, í•„ìš” ì‹œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ Sanitizer í›„ ì£¼ì….

```java
// ì•ˆì „: ê³ ì • í…œí”Œë¦¿ + ëª¨ë¸ ë°ì´í„°ë§Œ
@GetMapping("/preview")
public String preview(@RequestParam String body, Model m) {
  m.addAttribute("body", body);  // í…ìŠ¤íŠ¸ë¡œ ì¶œë ¥ (í…œí”Œë¦¿ì— [[${body}]] ë˜ëŠ” th:text ì‚¬ìš©)
  return "preview";              // preview.htmlì€ ê³ ì • íŒŒì¼
}
```

### Ruby â€” ERB

- ERBëŠ” ë£¨ë¹„ ì½”ë“œê°€ ê·¸ëŒ€ë¡œ ì‹¤í–‰ë˜ë¯€ë¡œ **ì‚¬ìš©ì ì…ë ¥ì„ ERBë¡œ í‰ê°€ ê¸ˆì§€**.
- ë¯¸ë¦¬ ì •í•´ì§„ í…œí”Œë¦¿ íŒŒì¼ì— `ERB#result_with_hash` ë¡œ **ë°ì´í„°ë§Œ ë°”ì¸ë”©**.
- ì‚¬ìš©ì ì½˜í…ì¸ ëŠ” view helperë¡œ ì´ìŠ¤ì¼€ì´í”„ë˜ì–´ í…ìŠ¤íŠ¸ë¡œ ì¶œë ¥.

---

## â€œì‚¬ìš©ì ì •ì˜ í…œí”Œë¦¿â€ ê¸°ëŠ¥ì´ ê¼­ í•„ìš”í•  ë•Œì˜ ì•ˆì „í•œ ì„¤ê³„

1) **Logic-less ì—”ì§„ ì„ íƒ**: Mustache/Handlebars/Liquid(í‘œí˜„ì‹/í•¨ìˆ˜ ê¸ˆì§€, ì„€ë„ DOM ì ‘ê·¼ ë¶ˆê°€).
2) **í—ˆìš© í† í° ëª©ë¡ ìš´ì˜**: `[[name]]`, `[[date]]`, `[[order_id]]` ë“± *ì •í•´ì§„ í‚¤*ë§Œ ëŒ€ì²´.
3) **ë¯¸ë¦¬ ì»´íŒŒì¼/ê²€ì¦**: ì €ì¥ ì‹œ ì •ê·œì‹ìœ¼ë¡œ **í—ˆìš© í† í°ë§Œ ì¡´ì¬**í•˜ëŠ”ì§€ í™•ì¸.
4) **ëŸ°íƒ€ì„ ì¹˜í™˜ì€ ë¬¸ìì—´ ì¹˜í™˜**ìœ¼ë¡œë§Œ(ìì²´ í‰ê°€ê¸°/`eval` ì—†ìŒ).
5) **í”„ë¦¬ë·°/ë Œë” ë¡œê·¸**: ì¹˜í™˜ëœ í† í°Â·ê¸¸ì´Â·ì‹œê°„ì„ ë‚¨ê²¨ *ì˜¤ë¥˜/ë‚¨ìš© íƒì§€*.
6) **í…œí”Œë¦¿ íŒŒì¼/ê²½ë¡œëŠ” ë°±ì—”ë“œ ì†Œìœ **(ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ HTMLì„ ì„œë²„ í…œí”Œë¦¿ í´ë”ì— ë‘ì§€ ì•ŠìŒ).

**ê²€ì¦ ì˜ˆì‹œ(ì„œë²„ ì €ì¥ ì „)**
```ts
// í—ˆìš© í† í°ë§Œ í¬í•¨ë˜ì–´ì•¼ ì €ì¥ ê°€ëŠ¥
const ALLOWED = new Set(["[[name]]","[[date]]","[[company]]"]);
function validateTemplate(tpl: string): boolean {
  // í† í° ì¶”ì¶œ
  const found = new Set(Array.from(tpl.matchAll(/$$$$[a-z0-9_]+$$$$/gi)).map(m=>m[0]));
  // í—ˆìš© ì™¸ í† í°Â·í‘œí˜„ì‹ ê¸ˆì§€(ì¤‘ê´„í˜¸, ì œì–´ë¬¸ ë“± íƒì§€)
  if (/[{}%]|<%|%>/.test(tpl)) return false;   // í…œí”Œë¦¿/ìŠ¤ë§ˆíŠ¸íƒœê·¸ í”ì  ê±°ì ˆ
  for (const tok of found) if (!ALLOWED.has(tok)) return false;
  return true;
}
```

---

## íƒì§€Â·ëª¨ë‹ˆí„°ë§Â·SAST/DAST í¬í•¨

### ëŸ°íƒ€ì„ ë¡œê·¸/ì§€í‘œ

- **í…œí”Œë¦¿ ì˜ˆì™¸ ê¸‰ì¦**: `TemplateSyntaxError`, `UndefinedError`, `TemplateException`
- **ë¯¸ë¦¬ë³´ê¸°/í¼ìŠ¤ë„ë¼ì´ì¦ˆ API**ì˜ **500/400** ë¹„ìœ¨ ê¸‰ì¦
- **ì €ì¥ ì‹œ ê²€ì¦ ì‹¤íŒ¨ìœ¨**: ë¶ˆí—ˆ ë¬¸ë²• ì‹œë„ê°€ ëŠ˜ë©´ ê²½ë³´

**Loki ì˜ˆì‹œ(LogQL)**
```logql
{service="web"} |= "Template" |= "Error" | count_over_time(5m) > 5
```

**Splunk ì˜ˆì‹œ**
```spl
index=app ("TemplateSyntaxError" OR "TemplateException" OR "UndefinedError")
| timechart span=5m count
```

### SAST(ì •ì  ë¶„ì„) ë£° ì•„ì´ë””ì–´

- **í”Œë˜ê·¸ í•¨ìˆ˜**: `render_template_string`, `from_string`, `new Template(String, ...)`, `Twig\Environment::createTemplate`, `ERB.new(user_input)`
- **ë™ì  ê²½ë¡œ**: `render(user_input + ".html")` ê°™ì€ íŒ¨í„´
- **ë°ì´í„° ëª¨ë¸ì— ìœ„í—˜ ê°ì²´ í¬í•¨**: ìš”ì²­/ì‘ë‹µ/íŒŒì¼ í•¸ë“¤ëŸ¬/ë¦¬í”Œë ‰ì…˜ ì˜¤ë¸Œì íŠ¸

### DAST(ë™ì ) â€” â€œì°¨ë‹¨ í…ŒìŠ¤íŠ¸â€ ìœ„ì£¼

- ìŠ¤í…Œì´ì§•ì—ì„œ **í‘œí˜„ì‹ ë¬¸ë²• ë¹„ìŠ¤ë¬´ë¦¬í•œ ë¬¸ìì—´**ì„ ë°ì´í„° ì…ë ¥ì— ë„£ì—ˆì„ ë•Œ **ê·¸ëŒ€ë¡œ ì¶œë ¥**ë˜ë©´ OK.
- ë°˜ëŒ€ë¡œ **ì„œë²„ ì—ëŸ¬/í‰ê°€ í”ì **ì´ ë³´ì´ë©´ ê²½ë³´ â†’ ì½”ë“œ ë¦¬ë·°.

---

## CI íŒŒì´í”„ë¼ì¸ í†µí•©(ì•ˆì „ í…ŒìŠ¤íŠ¸ ìë™í™”)

**GitHub Actions ì˜ˆì‹œ**
```yaml
name: ci-ssti-guard
on: [push, pull_request]
jobs:
  sast:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Grep unsafe template apis
        run: |
          if grep -R --line-number -E "render_template_string|createTemplate\(|new Template\(|fromString\(" -n src/; then
            echo "::error title=SSTI risk detected::Remove unsafe template APIs"
            exit 1
          fi

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          npm ci || pip install -r requirements.txt || true
          npm test || pytest -q
```

---

## ìš´ì˜ ìˆ˜ì¹™ ìš”ì•½(í”„ë¡ì‹œ/ì•±/í”Œë«í¼)

- **í”„ë¡ì‹œ/ê²Œì´íŠ¸ì›¨ì´**: í…œí”Œë¦¿ì„ ì™¸ë¶€ ìš”ì²­ìœ¼ë¡œ ì—…ë¡œë“œ/ì„ íƒí•˜ì§€ ì•ŠìŒ. ì—…ë¡œë“œëœ HTMLì€ **ë‹¤ìš´ë¡œë“œ ì „ìš©**(Content-Disposition: attachment).
- **ì• í”Œë¦¬ì¼€ì´ì…˜**:
  - í…œí”Œë¦¿ ì—”ì§„ APIëŠ” **íŒŒì¼ ê¸°ë°˜ ê³ ì • ë¡œë”**ë§Œ ì‚¬ìš©.
  - **Strict/Fail-fast** ì„¤ì •(ë¯¸ì •ì˜ ë³€ìˆ˜ ì—ëŸ¬).
  - ë°ì´í„° ëª¨ë¸ì— **ì›ì¹˜ ì•ŠëŠ” ê°ì²´/í•¨ìˆ˜** í¬í•¨ ê¸ˆì§€.
- **í”Œë«í¼**:
  - í¼ìŠ¤ë„ë¼ì´ì¦ˆê°€ í•„ìš”í•˜ë©´ **Logic-less ì—”ì§„** + í—ˆìš© í† í° ê²€ì¦.
  - í…œí”Œë¦¿ ì €ì¥ì†Œì™€ ì•± ì½”ë“œ ì €ì¥ì†Œ **ê¶Œí•œ ë¶„ë¦¬**, PR ë¦¬ë·° í•„ìˆ˜.
- **ë³´ì•ˆ í—¤ë”**: SSTI ì§ì ‘ ì°¨ë‹¨ì€ ëª» í•˜ì§€ë§Œ, ì˜¤íƒ‘ì¬ë¡œ ì¸í•œ **í´ë¼ì´ì–¸íŠ¸ XSS 2ì°¨ í”¼í•´**ë¥¼ ì¤„ì´ê¸° ìœ„í•´ CSP/HttpOnly/SameSite ìœ ì§€.

---

## â€œëì—ì„œ ëê¹Œì§€â€ ë¯¸ë‹ˆ ìƒ˜í”Œ

### Flask(ì·¨ì•½ â†’ ìˆ˜ì •)

**âŒ ì·¨ì•½**
```python
@app.post("/mail/preview")
def mail_preview():
    # ì‚¬ìš©ì ì…ë ¥ì„ í…œí”Œë¦¿ìœ¼ë¡œ ì§ì ‘ í•´ì„ (ê¸ˆì§€)
    html = render_template_string(request.form.get("html",""))
    return html
```

**âœ… ìˆ˜ì •**
{% raw %}
```python
# app.py

from flask import render_template
@app.post("/mail/preview")
def mail_preview():
    # 1) í…œí”Œë¦¿ì€ ê³ ì • íŒŒì¼
    # 2) ì‚¬ìš©ì ì…ë ¥ì€ ë°ì´í„°ë¡œë§Œ ë°”ì¸ë”©
    body = request.form.get("html","")
    return render_template("mail_preview.html", body=body)

# templates/mail_preview.html

<!doctype html>
<h1>Mail Preview</h1>
<pre>{{ body }}</pre>
```
{% endraw %}

**âœ… ì‚¬ìš©ì ì •ì˜ í† í°ì´ í•„ìš”í•œ ê²½ìš° (Logic-less)**
```python
# utils/tokens.py

ALLOWED = {"[[name]]","[[date]]"}
def render_tokens(tpl: str, ctx: dict) -> str:
    if any(c in tpl for c in "{}%$"):  # í…œí”Œë¦¿ ë¬¸ë²• í”ì  ì°¨ë‹¨
        return "[invalid]"
    return (tpl.replace("[[name]]", ctx.get("name",""))
              .replace("[[date]]", ctx.get("date","")))
```

### Spring + Thymeleaf(ì·¨ì•½ â†’ ìˆ˜ì •)

**âŒ ì·¨ì•½(ê°œë…)**
```java
@GetMapping("/preview")
public String preview(@RequestParam String tpl, Model m) {
  // ì‚¬ìš©ìê°€ ë³´ë‚¸ ë¬¸ìì—´ì„ í…œí”Œë¦¿ìœ¼ë¡œ ê°„ì£¼í•˜ëŠ” ë¡œì§ (ê¸ˆì§€)
  // ...
  return tpl; // (ì‹¤ì œë¡œëŠ” Thymeleafì— ë™ì  í…œí”Œë¦¿ì„ ë¨¹ì´ëŠ” íŒ¨í„´)
}
```

**âœ… ìˆ˜ì •**
```java
@GetMapping("/preview")
public String preview(@RequestParam String body, Model m) {
  m.addAttribute("body", body); // [[${body}]] ë¡œ ì•ˆì „ í‘œì‹œ
  return "preview";             // ê³ ì • í…œí”Œë¦¿ íŒŒì¼
}
```

---

## FAQë¡œ ì •ë¦¬í•˜ëŠ” ì‹¤ë¬´ í¬ì¸íŠ¸

**Q1. ìë™ ì´ìŠ¤ì¼€ì´í”„(autoescape)ê°€ ì¼œì ¸ ìˆìœ¼ë©´ SSTIë„ ë§‰ë‚˜ìš”?**
A. **ì•„ë‹™ë‹ˆë‹¤.** ìë™ ì´ìŠ¤ì¼€ì´í”„ëŠ” **ì¶œë ¥ ì‹œ XSS ìœ„í—˜**ì„ ì¤„ì—¬ì¤„ ë¿, **ì„œë²„ ì¸¡ í‘œí˜„ì‹ í‰ê°€ ìì²´**ë¥¼ ë§‰ì§€ ëª»í•©ë‹ˆë‹¤.

**Q2. ìƒŒë“œë°•ìŠ¤/Restricted ëª¨ë“œë§Œ ì¼œë©´ ì•ˆì „í•œê°€ìš”?**
A. ë„ì›€ì´ ë˜ì§€ë§Œ **ê·¼ë³¸ í•´ê²°**ì€ ì•„ë‹™ë‹ˆë‹¤. *ì‚¬ìš©ì ì…ë ¥ì„ í…œí”Œë¦¿/í‘œí˜„ì‹ìœ¼ë¡œ í‰ê°€í•˜ì§€ ì•ŠëŠ” ì„¤ê³„*ê°€ ìš°ì„ ì…ë‹ˆë‹¤.

**Q3. ì‚¬ìš©ìì—ê²Œ â€œê°„ë‹¨í•œ ìˆ˜ì‹(ë‚ ì§œ í¬ë§· ë“±)â€ë§Œ í—ˆìš©í•˜ê³  ì‹¶ë‹¤ë©´?**
A. í‘œí˜„ì‹ ì—”ì§„ ëŒ€ì‹  **ë¯¸ë¦¬ ì •ì˜í•œ í† í°/í•„í„°**ë§Œ í—ˆìš©í•˜ì„¸ìš”. ì˜ˆ: `[[date]]`, `[[upper:name]]` ì‹ì˜ **í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì¹˜í™˜ê¸°**.

**Q4. ì–´ë–¤ ë¡œê·¸ë¥¼ ë³´ì•„ì•¼ ì¡°ê¸° íƒì§€ì— ë„ì›€ì´ ë˜ë‚˜ìš”?**
A. í…œí”Œë¦¿ íŒŒì‹± ì˜¤ë¥˜/ë¯¸ì •ì˜ ë³€ìˆ˜ ì˜ˆì™¸, ë¯¸ë¦¬ë³´ê¸° APIì˜ 4xx/5xx ê¸‰ì¦, ì €ì¥ ì „ ê²€ì¦ ì‹¤íŒ¨ìœ¨ ìƒìŠ¹ ë“±.

---

## ì²´í¬ë¦¬ìŠ¤íŠ¸(í˜„ì¥ìš©)

- [ ] ì‚¬ìš©ì ì…ë ¥ì„ **í…œí”Œë¦¿/í‘œí˜„ì‹/ê²½ë¡œ**ì— **ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤**
- [ ] í…œí”Œë¦¿ ì„ íƒì€ **í‚¤â†’íŒŒì¼** í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë§¤í•‘ë§Œ í—ˆìš©
- [ ] ì—”ì§„ì€ **Strict/Fail-fast**(ë¯¸ì •ì˜ ë³€ìˆ˜ ì—ëŸ¬), **API ë…¸ì¶œ ì œí•œ**
- [ ] ë°ì´í„° ëª¨ë¸ì—” **DTO/Map**ë§Œ ì „ë‹¬(í”„ë ˆì„ì›Œí¬/ì‹œìŠ¤í…œ ê°ì²´ ê¸ˆì§€)
- [ ] í¼ìŠ¤ë„ë¼ì´ì¦ˆëŠ” **Logic-less + í† í° í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸**
- [ ] ì €ì¥ ì „ **ì •ì  ê²€ì¦**(ê¸ˆì§€ ë¬¸ë²•/í† í°) + ëŸ°íƒ€ì„ **ì˜ˆì™¸ ëª¨ë‹ˆí„°ë§**
- [ ] CIì—ì„œ **ìœ„í—˜ API í˜¸ì¶œ**(render_template_stringÂ·fromString ë“±) íƒì§€
- [ ] ì—ëŸ¬ëŠ” ì‚¬ìš©ìì—ê²Œ ìˆ¨ê¸°ê³ (ì¼ë°˜ ë©”ì‹œì§€), **ë¡œê·¸/ì•Œë¦¼**ìœ¼ë¡œë§Œ

---

### ë§ºìŒë§

SSTIì˜ ë³¸ì§ˆì€ â€œ**ë°ì´í„°ê°€ ì½”ë“œë¡œ í•´ì„ë˜ëŠ” ê²½ê³„ ë¶•ê´´**â€ì…ë‹ˆë‹¤.
**í…œí”Œë¦¿=ê³ ì •, ì…ë ¥=ë°ì´í„°**ë¼ëŠ” ê·œìœ¨ë§Œ ì§€ì¼œë„ **ëŒ€ë¶€ë¶„ì˜ SSTI**ëŠ” ì„¤ê³„ ë‹¨ê³„ì—ì„œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.
