---
layout: post
title: 정보보안기사 - 기타 웹서버 보안 대책, 웹 로그 분석,  보안서버
date: 2025-11-13 15:25:23 +0900
category: 정보보안기사
---
# · 07. 웹 로그 분석 · 08. 보안서버(Security Server) 구축

## 기타 웹서버 보안 대책(아파치 httpd 기준)

### 목표 아키텍처(요구사항 합본)

- **최소 권한 실행**: 전용 사용자/그룹(`www-data`/`apache`), 웹루트는 **읽기 전용**, 업로드 디렉터리는 **실행 금지**.
- **최소 기능 모듈**: 필요한 모듈만 `LoadModule`(화이트리스트).
- **표면 축소**: 불필요한 메서드/리스트/버전 정보 차단.
- **프록시·역프록시 안전화**: `ProxyRequests Off`, 백엔드 화이트리스트, 내부 주소 노출 금지.
- **TLS 현대화**: TLS 1.2/1.3, 안전 암호군, HSTS, OCSP Stapling.
- **요청 한계**: 느린 요청, 대용량 요청, 헤더 폭주에 대한 타임아웃/사이즈 한계.
- **로깅/가시성**: JSON/필수 필드, 회전/보존 정책, SIEM 연계.
- **취약점 방어**: OWASP CRS(mod_security), 속도 제한(mod_ratelimit), 간단한 DoS 억제(mod_evasive).

---

### 서버·파일 권한·프로세스

```bash
# 전용 계정(배포 OS에 따라 다름: Debian/Ubuntu는 www-data, RHEL은 apache)

sudo usermod -s /usr/sbin/nologin -U www-data

# 웹루트 권한: 소유자는 배포 계정, httpd는 읽기만

sudo chown -R deploy:www-data /var/www/app
sudo chmod -R 750 /var/www/app           # 그룹 읽기/실행, world 차단

# 업로드 디렉토리는 실행 금지

sudo chown -R www-data:www-data /var/www/app/uploads
sudo chmod -R 750 /var/www/app/uploads
```

**`/etc/apache2/envvars`**(Debian/Ubuntu 계열)
```
export APACHE_RUN_USER=www-data
export APACHE_RUN_GROUP=www-data
```

---

### 모듈 최소화·MPM 선택

- **MPM**: 동시성/성능/격리 균형 → 일반 웹은 `event` 권장(HTTP/2 포함), PHP-FPM는 외부 FastCGI로.
```bash
# Debian/Ubuntu 예시

a2dismod mpm_prefork && a2enmod mpm_event proxy_fcgi setenvif http2 headers ssl rewrite
systemctl reload apache2
```

---

### 전역 보안 베이스라인(노출 최소화)

**`/etc/apache2/conf-available/security-hardening.conf`**
```apache
# 서버 배너/버전 숨김

ServerTokens Prod
ServerSignature Off
Header unset X-Powered-By

# 메서드 축소(TRACE 금지)

TraceEnable Off
<LimitExcept GET POST HEAD OPTIONS>
  Require all denied
</LimitExcept>

# 느린 HTTP/헤더 폭주 방어

RequestReadTimeout header=20-40,MinRate=500 body=20,MinRate=500
Timeout 60
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5

# 요청 크기/헤더 제한(환경 맞게 조정)

LimitRequestFieldSize 16384
LimitRequestFields 100
LimitRequestBody 10485760

# 디렉토리 기본: 인덱스/실행/심볼릭 제한

<Directory "/var/www">
  Options -Indexes -ExecCGI -FollowSymLinks +SymLinksIfOwnerMatch
  AllowOverride None
  Require all granted
</Directory>

# 민감 파일 차단(화이트리스트 방식)

<FilesMatch "(^\.|\.bak$|\.old$|\.swp$|\.env$|\.sql$|\.log$|\.map$)">
  Require all denied
</FilesMatch>

# CORS/보안 헤더(필요 시 정책 조정)

Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "DENY"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
# CSP는 앱 특성에 맞게 별도 튜닝 권장

```
```bash
a2enconf security-hardening && systemctl reload apache2
```

---

### 가상호스트·리버스 프록시 하드닝

**`/etc/apache2/sites-available/app.conf`**
```apache
<VirtualHost *:80>
  ServerName www.example.com
  # HTTP→HTTPS 리다이렉트
  RewriteEngine On
  RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
  # 건강검진 엔드포인트 등 예외가 필요하면 화이트리스트 추가
</VirtualHost>

<VirtualHost *:443>
  ServerName www.example.com
  Protocols h2 http/1.1
  SSLEngine on
  # (TLS 설정은 아래 6.8, 08 섹션에서 상세히)

  # 역프록시(백엔드 화이트리스트)
  ProxyPreserveHost On
  ProxyRequests Off
  <Proxy "http://app_cluster/">
    Require all denied             # 기본 거부
  </Proxy>
  ProxyPass        "/" "http://127.0.0.1:9000/"
  ProxyPassReverse "/" "http://127.0.0.1:9000/"

  # 내부 주소/포트가 Location 헤더로 노출되지 않도록
  RequestHeader set X-Forwarded-Proto "https"
  RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"
  ProxyPassReverseCookieDomain 127.0.0.1 www.example.com

  # 업로드 디렉토리는 다운로드만
  <Location "/uploads/">
    Header set Content-Disposition "attachment"
  </Location>

  # 로깅(아래 07에서 상세)
  ErrorLog  ${APACHE_LOG_DIR}/www-error.log
  CustomLog ${APACHE_LOG_DIR}/www-access.log combined
</VirtualHost>
```

> **주의**: `ProxyRequests On`(전진 프록시) 금지. `CONNECT` 메서드 오용 차단.

---

### PHP-FPM 연동 시(실행 분리)

```apache
# .php 실행은 특정 경로로만(예: /var/www/app/public)

<Directory "/var/www/app/public">
  AllowOverride None
  Require all granted
</Directory>

# PHP 처리기는 외부 FPM으로

<FilesMatch "\.php$">
  SetHandler "proxy:unix:/run/php/php8.2-fpm.sock|fcgi://localhost/"
</FilesMatch>

# 업로드 디렉터리 내 PHP 실행 금지

<Directory "/var/www/app/uploads">
  php_admin_flag engine off
  RemoveHandler .php
</Directory>
```

---

### 간단 DoS 억제(선택)

```apache
# mod_evasive (패키지 설치 필요)

DOSHashTableSize    3097
DOSPageCount        20
DOSPageInterval     1
DOSSiteCount        200
DOSSiteInterval     1
DOSBlockingPeriod   60
```
```apache
# mod_ratelimit

<Location "/download/">
  SetOutputFilter RATE_LIMIT
  SetEnv rate-limit 512
</Location>
```

---

### TLS 베스트 프랙티스(요지—세부는 08에서 전체 예시)

```apache
# 현대형 프로토콜/암호 스위트

SSLProtocol             all -SSLv3 -TLSv1 -TLSv1.1
SSLCipherSuite          TLSv1.2+HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!RC4
SSLOpenSSLConfCmd       Curves X25519:P-256
SSLHonorCipherOrder     off                 # TLS1.3는 순서 무의미
SSLCompression          off
SSLUseStapling          on
SSLStaplingCache        "shmcb:/var/run/ocsp(128000)"
Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
```

---

### 운영 체크리스트(아파치 대책)

- [ ] `ServerTokens Prod` / `ServerSignature Off`
- [ ] `TraceEnable Off`, 메서드 화이트리스트
- [ ] `Options -Indexes -ExecCGI` / `.git .env .bak` 차단
- [ ] `ProxyRequests Off`, 백엔드 화이트리스트, 내부 주소 비노출
- [ ] TLS 1.2/1.3, HSTS, OCSP Stapling
- [ ] 업로드 디렉토리 **실행 금지** (다운로드 전용)
- [ ] 느린 요청/대용량 방어(`RequestReadTimeout`, `LimitRequest*`)
- [ ] JSON/필수필드 로깅, 회전·보존·전송(SIEM)
- [ ] WAF(mod_security + OWASP CRS) 도입 여부 검토

---

## 웹 로그 분석

### 로그 포맷 설계(Combined → JSON)

**기본(Combined)**
```apache
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\"" combined
CustomLog ${APACHE_LOG_DIR}/www-access.log combined
```

**JSON 로그(머신 파싱/전송 최적)**

{% raw %}
```apache
LogFormat "{ \"ts\":\"%{%Y-%m-%dT%H:%M:%S%z}t\", \"client\":\"%a\", \"host\":\"%v\", \"method\":\"%m\", \"uri\":\"%U%q\", \"status\":%>s, \"bytes\":%B, \"referer\":\"%{Referer}i\", \"ua\":\"%{User-agent}i\", \"xff\":\"%{X-Forwarded-For}i\", \"reqtime\":%D }" json
CustomLog ${APACHE_LOG_DIR}/www-access.json logio:json
```
{% endraw %}

> `mod_logio`를 로드하면 전송 바이트(`%I/%O`) 등도 수집 가능.

---

### 탐지용 정규식(공격 패턴 시그니처 예)

- **경로 조작**: `\.\./|\.\.\\|%2e%2e`
- **SQLi**: `(\bUNION\b|\bSELECT\b|\bSLEEP\(|\bor\b\s+1=1|\binformation_schema\b)`
- **XSS**: `<script\b|onerror=|onload=|%3cscript`
- **RCE 시도**: `(;|\|\||&&)\s*(wget|curl|nc|bash|sh)`
- **스캐너**: `sqlmap|nikto|dirbuster|nmap|acunetix`

---

### 빠른 1차 분석(AWK/grep)

```bash
# 상태코드 분포

awk '{print $9}' /var/log/apache2/www-access.log | sort | uniq -c | sort -nr | head

# 상위 요청자

awk '{print $1}' /var/log/apache2/www-access.log | sort | uniq -c | sort -nr | head

# 초당 요청(간단)

awk '{print $4}' /var/log/apache2/www-access.log | cut -d: -f2-3 | sort | uniq -c | sort -nr | head

# 의심 패턴 필터

grep -E "(\.\./|%2e%2e|UNION|SELECT|<script|cmd=)" /var/log/apache2/www-access.log | tail -n 20
```

---

### Python 스니펫(초간단 IOC 탐지·집계)

```python
# parse_apache.py

import re, sys, json
pat = re.compile(r'(\.\./|%2e%2e|UNION|SELECT|SLEEP\(|<script|onerror=|wget|curl|cmd=|sqlmap|nikto)', re.I)
counts = {}
for line in sys.stdin:
    m = pat.search(line)
    if m:
        ip = line.split()[0]
        sig = m.group(1).lower()
        counts.setdefault((ip,sig),0)
        counts[(ip,sig)] += 1
for (ip,sig), c in sorted(counts.items(), key=lambda x:-x[1]):
    print(json.dumps({"ip":ip, "sig":sig, "count":c}))
```
```bash
python3 parse_apache.py < /var/log/apache2/www-access.log | head
```

---

### GoAccess(실시간 대시보드)

```bash
# 설치 후 실시간 HTML 리포트

goaccess /var/log/apache2/www-access.log -o /var/www/html/report.html --log-format=COMBINED --real-time-html
```

---

### Fail2ban(로그 기반 차단 예)

**필터** `/etc/fail2ban/filter.d/apache-badbots.conf`
```
[Definition]
failregex = <HOST> -.*"(GET|POST).* (sqlmap|nikto|acunetix)
```
**jail** `/etc/fail2ban/jail.d/apache-local.conf`
```
[apache-badbots]
enabled = true
port    = http,https
filter  = apache-badbots
logpath = /var/log/apache2/www-access.log
maxretry = 1
bantime  = 3600
findtime = 600
```

---

### 로그 회전·보존·전송

**logrotate** `/etc/logrotate.d/apache2`
```
/var/log/apache2/*.log {
  daily
  rotate 14
  compress
  missingok
  notifempty
  sharedscripts
  postrotate
    /usr/sbin/apachectl graceful > /dev/null 2>/dev/null || true
  endscript
}
```

**전송(예: rsyslog로 SIEM)**
```
*.* @siem.example.net:514
```

---

### 지표·경보(운영)

- **오류율**: \( \text{ErrorRate} = \frac{\text{5xx}}{\text{모든 요청}} \)
- **리다이렉트 루프**: 301/302 급증 + 동일 URI.
- **폭주 IP**: 초당/분당 rp/ip 임계치.
- **스캐너 UA**: 블랙리스트 UA 접근 시 알림.
- **관리자 경로**: `/admin`, `/manager`에 대한 401/403/404 이상치.

---

### 로그 품질 체크리스트

- [ ] JSON/필드 표준화(클라이언트IP, 요청라인, 상태, 레이턴시, UA, XFF)
- [ ] 회전/보존(법/컴플라이언스 기준), 무결성(해시 체인 고려)
- [ ] 실시간 모니터링/경보(오류율, 폭주, 시그니처)
- [ ] 내부 서비스/건강검진 URL 제외 정책 명문화
- [ ] 개인정보/토큰 로그 노출 금지(마스킹)

---

## 구축 — Apache + TLS(HTTPS)

> 국내에서 “보안서버 구축”은 **웹사이트 TLS(SSL) 암호화 통신 기반**을 의미하는 경우가 많다. 핵심은 **신뢰할 수 있는 인증서**, **현대형 프로토콜/암호군**, **키/체인/갱신 운영**, **엄격한 재설정(HSTS/OCSP)** 이다.

### 준비·요구사항

- 공인 도메인, 방화벽 80/443(인증서 자동갱신용 80 필요)
- 루트 권한, 최신 OpenSSL/Apache(HTTP/2 지원 `mod_http2`)
- **인증서**: 상용 CA 또는 **Let’s Encrypt(무료)**
- 키 관리 정책(퍼미션, 백업, 로테이션)

---

### 인증서 발급(예: Let’s Encrypt + Certbot)

```bash
sudo apt install certbot python3-certbot-apache
sudo certbot --apache -d www.example.com -d example.com
# → 자동으로 vhost 작성/인증서 배치/리다이렉트 설정
# 갱신 테스트

sudo certbot renew --dry-run
```

**수동(ECDSA 키 생성 예)**
```bash
# ECDSA P-256 개인키

openssl genpkey -algorithm EC -pkeyopt ec_paramgen_curve:P-256 -out /etc/ssl/private/www-ecdsa.key
# CSR 생성

openssl req -new -key /etc/ssl/private/www-ecdsa.key -out /etc/ssl/csr/www.csr
# CA에 제출 → crt/chain 수령

```

> 실무에서는 **RSA 2048/3072 + ECDSA P-256 듀얼 인증서**를 사용해 호환성과 성능을 모두 확보하기도 한다(서버/CA 지원 시).

---

### TLS 설정(현대형·보안 헤더 포함)

**`/etc/apache2/sites-available/www-ssl.conf`**
```apache
<VirtualHost *:443>
  ServerName www.example.com
  Protocols h2 http/1.1

  SSLEngine on
  SSLCertificateFile      /etc/letsencrypt/live/www.example.com/fullchain.pem
  SSLCertificateKeyFile   /etc/letsencrypt/live/www.example.com/privkey.pem

  # 프로토콜/암호군
  SSLProtocol             all -SSLv3 -TLSv1 -TLSv1.1
  # TLS1.2 이상: ECDHE + AES-GCM/CHACHA20 우선
  SSLCipherSuite          TLSv1.2+HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!RC4
  SSLHonorCipherOrder     off
  SSLOpenSSLConfCmd       Curves X25519:P-256
  SSLCompression          off

  # OCSP Stapling
  SSLUseStapling          on
  SSLStaplingResponderTimeout 5
  SSLStaplingReturnResponderErrors off
  SSLStaplingCache        "shmcb:/var/run/ocsp(128000)"

  # 보안 헤더
  Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "DENY"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  # CSP는 앱별 튜닝이 필요(예는 최소)
  # Header always set Content-Security-Policy "default-src 'self'"

  # HTTP→HTTPS는 80 vhost에서 301 처리(위 6.5 참고)

  DocumentRoot /var/www/app/public
  ErrorLog  ${APACHE_LOG_DIR}/www-ssl-error.log
  CustomLog ${APACHE_LOG_DIR}/www-ssl-access.log combined
</VirtualHost>
```
```bash
a2enmod ssl http2 headers && a2ensite www-ssl && systemctl reload apache2
```

---

### HTTP/2 성능·호환

- `Protocols h2 http/1.1` 활성화, ALPN 지원(OpenSSL/Apache 버전 확인).
- HPACK/Server Push는 HTTP/3 시대에는 불필요(HTTP/2 Push는 비권장).
- 큰 리소스는 **압축/캐시**(mod_deflate, Cache-Control).

---

### HSTS·리다이렉트 전략

- **HSTS**는 강력하지만, 잘못 설정 시 되돌리기 어렵다. 서브도메인 전체 HTTPS 보장이 가능할 때 `includeSubDomains; preload`.
- 모든 HTTP 요청은 **영구 301**로 HTTPS 전환.
- 내부 헬스체크·배포 훅 등 예외 경로는 최소화.

---

### mTLS(관리자/파트너 전용)

```apache
# 관리자 서브도메인 전용 vhost 예

<VirtualHost *:443>
  ServerName admin.example.com
  SSLEngine on
  SSLCertificateFile    /etc/letsencrypt/live/admin.example.com/fullchain.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/admin.example.com/privkey.pem

  # 클라이언트 인증서 요구
  SSLVerifyClient require
  SSLCACertificateFile /etc/ssl/certs/partner-ca.pem
  SSLVerifyDepth 2

  # mTLS + VPN/IP제한을 겹쳐 다층 방어
  <Location "/">
    Require ip 203.0.113.0/24
  </Location>
</VirtualHost>
```

---

### 키/인증서 운영

- **권한**: `/etc/letsencrypt/live/*/privkey.pem` → `root:root` 600
- **갱신**: `certbot renew` 자동화 + 서비스 재로드 훅
- **가시성**: 만료 D–30 알림, OCSP 상태 모니터링
- **시나리오**: 키 유출 의심 시 즉시 폐기/재발급/전파

---

### 진단·검증

```bash
# 핸드셰이크/체인/OCSP 상태 확인

openssl s_client -connect www.example.com:443 -servername www.example.com -status < /dev/null | egrep "Protocol|Cipher|Verify return code|OCSP Response Status"

# 강제 TLS1.0/1.1 시도(차단되어야 함)

openssl s_client -connect www.example.com:443 -tls1_1 -servername www.example.com </dev/null
```

---

### 위험·효과 근사(학습용)

- 평문 전송 대비 **탈취 위험 감소율**을 \(R\)라 하면,
  $$ R \approx 1 - \frac{P(\text{MITM 성공})}{P(\text{MITM 시도})} $$
- HSTS·OCSP·현대 암호군·인증서 운영 성숙도로 \(P(\text{MITM 성공})\)을 실질적으로 낮춘다.

---

### 보안서버 구축 체크리스트

- [ ] 공인 인증서(체인 정상), 자동 갱신/알림
- [ ] TLS 1.2/1.3만 허용, 안전 암호군, 압축/재협상 비활성
- [ ] HSTS 활성(준비 후 `includeSubDomains; preload`)
- [ ] OCSP Stapling, ALPN/HTTP2 활성
- [ ] HTTP→HTTPS 301 일관 처리
- [ ] 관리자/민감 도메인은 mTLS/VPN/IP 제한
- [ ] 키 권한/백업/교체 정책 수립
- [ ] 정기 스캔(프로토콜/암호/체인/만료) 및 로그 점검

---

## OWASP ModSecurity CRS 적용(선택)

```bash
apt install libapache2-mod-security2
a2enmod security2 && systemctl reload apache2
# CRS 배치(버전별 가이드 참고): /usr/share/modsecurity-crs

IncludeOptional /usr/share/modsecurity-crs/*.conf
IncludeOptional /usr/share/modsecurity-crs/rules/*.conf
```
```apache
# 예: 관리자 경로만 강화 룰 적용

<LocationMatch "^/admin">
  SecRuleEngine On
</LocationMatch>
```

---

## 표 — 핵심 설정 요약

| 범주 | 핵심 디렉티브(예) | 메모 |
|---|---|---|
| 노출 차단 | `ServerTokens Prod`, `ServerSignature Off`, `TraceEnable Off` | 배너/TRACE 차단 |
| 경로/파일 | `Options -Indexes -ExecCGI`, `<FilesMatch>` | 리스트/스크립트 제한 |
| 요청 한계 | `RequestReadTimeout`, `LimitRequestBody` | 느린HTTP/대용량 방어 |
| 프록시 | `ProxyRequests Off`, `ProxyPass/Reverse` | 내부 주소 노출 금지 |
| TLS | `SSLProtocol`, `SSLCipherSuite`, `HSTS`, `OCSP` | 현대화 필수 |
| 로깅 | `LogFormat json`, `CustomLog` | SIEM 연계 |
| 업로드 | `php_admin_flag engine off` | 실행 금지 |
| WAF | `mod_security + CRS` | 공통 룰 |

---

## 최종 요약

- **06**: 아파치 보안은 “**표면 축소 + 현대 TLS + 안전 프록시 + 실행 분리 + 한계 설정**”의 합. 템플릿화로 재발을 막는다.
- **07**: 로그는 “**관측 가능성(Observability)**”의 시작. **표준 포맷(JSON)**, **정규식 패턴**, **회전/전송**, **경보 룰**을 갖추면 공격 징후를 조기에 포착한다.
- **08**: 보안서버는 단순 ‘HTTPS’가 아니라 **인증서 운영·프로토콜·헤더 정책·검증 절차**를 포함한 **체계**다. HSTS/OCSP/HTTP2와 함께 **mTLS/도메인 분리**로 민감면을 격리하면 방어 심도가 크게 향상된다.
