---
layout: post
title: MFC - 인쇄 & 프린트 프리뷰 파이프라인
date: 2025-08-26 19:25:23 +0900
category: MFC
---
# 인쇄 & 프린트 프리뷰 파이프라인 (MFC Doc/View 완전 정리)

이 글은 MFC에서 **인쇄(Printing)**와 **프린트 프리뷰(Print Preview)**가 **어떤 순서로**, **어떤 객체/메서드가** 관여하며, **무엇을 어디서 구현해야 하는지**를 생략 없이 정리합니다. (코드 없이 개념·설계·체크리스트 중심)

---

## 1) 큰 그림: “한 번 그리되, 대상만 바꾼다”

- **그리기 타깃**만 달라집니다.  
  - 화면: `CView::OnDraw(CDC*)`  
  - 인쇄/프리뷰: `CView::OnPrint(CDC*, CPrintInfo*)`
- **프레임워크가 준비하는 것**  
  - **인쇄 명령 경로**: 메뉴/툴바/단축키 → `ID_FILE_PRINT`, `ID_FILE_PRINT_DIRECT`, `ID_FILE_PRINT_PREVIEW`  
  - **프린터 DC 준비**, **페이지 범위/옵션 수집(대화상자)**, **스풀러로 전송**, **프리뷰 창 생성/해제**  
- **개발자가 할 일**  
  - **페이지 매김**(몇 페이지? 어디서 잘라 그릴지),  
  - **좌표/스케일링**(프린터 DPI/여백/안전영역 고려),  
  - `OnPrint`에서 **페이지별로 실제 렌더링**.

---

## 2) 명령 라우팅 & 표준 핸들 흐름

### 2-1. 명령 ID와 라우팅
- **ID_FILE_PRINT**: 일반 인쇄(인쇄 대화상자 보여줌)  
- **ID_FILE_PRINT_DIRECT**: **대화상자 없이** 바로 인쇄(최근 설정/기본 프린터)  
- **ID_FILE_PRINT_PREVIEW**: 프리뷰 모드 진입

명령 라우팅(프레임 기반 규칙):  
**활성 View → Frame → Document → App** 순으로 핸들러/업데이트 핸들러를 찾습니다.  
일반적으로 **View가 주도**(페이지 매김/그리기)하며, 문서 데이터는 `CDocument`에서 공급합니다.

### 2-2. 인쇄 파이프라인 훅(핵심 메서드 역할)
- **`OnPreparePrinting(CPrintInfo* pInfo)`**  
  - **페이지 수 계산**(최소/최대), 프린트 다이얼로그 표시 전 기본값 설정  
  - `DoPreparePrinting` 내부에서 호출됨(표준 경로)  
- **`OnBeginPrinting(CDC* pDC, CPrintInfo* pInfo)`**  
  - **폰트/브러시/버퍼 등 GDI 리소스 준비**(페이지 전체에서 재사용)  
- **`OnPrepareDC(CDC* pDC, CPrintInfo* pInfo)`**  
  - **스케일/맵핑/오리진 설정**(페이지마다 호출, 프리뷰에서도 호출)  
- **`OnPrint(CDC* pDC, CPrintInfo* pInfo)`**  
  - **해당 페이지 번호(`pInfo->m_nCurPage`)를 실제로 렌더링**  
- **`OnEndPrinting(CDC* pDC, CPrintInfo* pInfo)`**  
  - **리소스 해제**, 상태/캐시 정리

> 핵심: **페이지 매김은 `OnPreparePrinting`에서**, **리소스 준비는 `OnBeginPrinting`에서**, **매 페이지 좌표계 설정은 `OnPrepareDC`에서**, **실제 그리기는 `OnPrint`에서**.

---

## 3) 프린트 프리뷰의 동작 방식

- 프리뷰는 **실제 인쇄 경로를 그대로 사용**합니다.  
  - 단, DC는 프린터가 아니라 **프리뷰용 DC**(`CPreviewDC`)이며,  
  - 화면에 **축소된 페이지 그림**을 렌더링합니다(줌/페이지 전환 UI 포함).
- 프리뷰 도중에도 `OnPrepareDC`와 `OnPrint`가 **페이지 단위로** 호출됩니다.
- **툴바/메뉴**: 확대/축소, 한/두 페이지 보기, 인쇄, 닫기(원래 뷰로 복귀) 등을 포함합니다.
- 프리뷰는 **비파괴적 상태**여야 합니다. 인쇄용으로만 필요한 리소스/상태는 `OnBeginPrinting`에서 준비하고, `OnEndPrinting`에서 정리하세요.

---

## 4) 인쇄 준비: 페이지 수 계산 & 범위 설정

### 4-1. `CPrintInfo`에서 다루는 주요 값
- **`m_nCurPage`**: 현재 페이지(1부터 시작)  
- **`SetMinPage`, `SetMaxPage`**: **총 페이지 범위** 지정  
- **`m_rectDraw`**: **그릴 수 있는 유효 영역(디바이스 단위)** — 프레임워크가 계산하여 제공  
- **`m_bPreview`/`m_bDirect`**: 프리뷰/다이렉트 인쇄 플래그  
- **`m_pPD`**: 인쇄 대화상자 객체(용지/복사 매수/범위 등 접근 가능)

### 4-2. 페이지 매김 전략(텍스트 중심 예)
1) **줄 높이/여백/글꼴 메트릭**으로 **한 페이지에 들어갈 라인 수** 계산  
2) 본문을 단락 단위로 **워드랩**하여 **라인 리스트** 생성  
3) 라인 오프셋으로 **페이지 경계 인덱스**(예: 0~49 = 1페이지, 50~98 = 2페이지…)를 미리 만들어 **`SetMaxPage`**에 반영  
4) 인쇄/프리뷰 중에는 **현재 페이지 범위만** 그리기(성능)

### 4-3. 페이지 매김 전략(도면/이미지 중심 예)
- **원본 콘텐츠 크기**(논리 단위)와 **인쇄 가능 영역 크기**(디바이스 단위)를 비교  
- 스케일 = `min(가로_스케일, 세로_스케일)`로 **비율 유지 축소**  
- 여러 시트(타일 인쇄)라면 **행×열**로 나누어 페이지 수 산출, `SetMaxPage`에 반영

---

## 5) 좌표계와 스케일링(가장 중요한 실무 포인트)

### 5-1. DPI와 단위
- 프린터 DC의 DPI: `LOGPIXELSX/LOGPIXELSY` (예: 600×600)  
- 인쇄 가능 영역: `HORZRES`×`VERTRES` (픽셀/디바이스 단위)  
- 물리 여백(인쇄 불가능 영역): `PHYSICALOFFSETX/Y` (장치 기준 오프셋)

### 5-2. 안전 영역과 그리기 영역
- **사용자 마진** + **프린터 물리 여백**을 고려해 **실제 그릴 수 있는 Rect**를 결정  
- 프레임워크가 **`pInfo->m_rectDraw`**로 제공하므로, 기본은 **이 영역만 사용**하면 안전

### 5-3. 맵핑 모드 권장
- **`MM_TEXT`**(픽셀 1:1): 단순하지만 DPI 변화에 약함  
- **`MM_ANISOTROPIC`**: **논리 단위(예: 0.1mm, pt)**를 DC에 매핑해 DPI 차이를 흡수  
  - `WindowExt`(논리 크기) ↔ `ViewportExt`(디바이스 크기) 비율로 스케일  
  - **오리진**을 좌상단 여백에 맞추면 좌표 계산이 쉬워짐

### 5-4. 글꼴 크기 계산(개념)
- **포인트(pt)** → 픽셀 변환: `픽셀높이 = (포인트 * DPI / 72)`  
- 프린터마다 DPI가 다르므로, 동일 포인트의 글꼴도 **프린터 DPI로 재계산**해야 시각적 일관성 확보

---

## 6) 프린트 대화상자 & 옵션

- **용지/트레이/가로세로/양면** 등은 프린터 드라이버의 **DEVMODE**에 저장  
- 인쇄 대화상자에서 **페이지 범위**(모두/일부), **사본 수**, **정렬(콜레이트)** 등을 설정  
- **직접 인쇄(ID_FILE_PRINT_DIRECT)**는 대화상자를 거치지 않으므로 **최근 설정 또는 기본값**이 사용됨  
- **페이지 설정(Page Setup)**을 별도 제공하면 사용자 마진/헤더·푸터/단위 등을 사전에 커스터마이즈 가능

---

## 7) 스풀러 & 성능 고려

- Windows는 **스풀러**가 **EMF(벡터)** 또는 **RAW** 스트림으로 프린터에 전달  
- **큰 비트맵**을 다량 인쇄하면 스풀 파일이 급격히 커짐 →  
  - 이미지 **다운스케일**(인쇄 해상도 기준),  
  - **압축 포맷(DIB/압축)** 활용,  
  - **필요 영역만** 렌더  
- 인쇄는 보통 **동기 작업**입니다. UI 프리징을 막으려면  
  - **진행 대화상자**(취소 버튼 포함)와 **`pInfo->m_bContinuePrinting`** 체크로 **사용자 취소**를 구현

---

## 8) 에러 처리 & 취소

- **파일/드라이버 오류**: 인쇄 시작 전(프린터 DC 획득, 권한/오프라인 등)과 페이지 렌더링 중 모두 발생할 수 있음  
- **취소 처리**:  
  - 진행 UI에서 취소 시 **플래그**를 세팅 → 각 페이지 렌더링 루프에서 **주기적으로 확인** → `m_bContinuePrinting = FALSE` 설정  
  - 즉시 중단하고 리소스 정리(프레임워크가 EndDoc/Abort를 처리)

---

## 9) 프리뷰 UX & 커스터마이징

- **표준 프리뷰 툴바**: 확대/축소, 페이지 넘김, 인쇄하기, 닫기  
- **확대 스케일**: 100/125/150/200% 등 단계형 또는 마우스 휠로 가변  
- **양면/여러 페이지 보기**: 1-up/2-up/썸네일  
- **헤더/푸터**: 날짜/페이지 번호/문서명 등을 상단/하단에 렌더(인쇄/프리뷰 동일 로직 유지)
- **다국어/서체**: 프린터 설치 폰트 vs 장치 독립 폰트 차이를 고려(미설치 폰트 대체 규칙)

---

## 10) 전형적 작업 흐름(시퀀스)

1) 사용자가 **인쇄/프리뷰 명령** → 라우팅되어 **View**가 응답  
2) 프레임워크가 **프린터 DC** 준비/대화상자 표시(프리뷰면 프리뷰 창 준비)  
3) **`OnPreparePrinting`**: 페이지 수 계산(`SetMin/MaxPage`)  
4) **`OnBeginPrinting`**: 글꼴/브러시/버퍼 등 준비  
5) (페이지 루프)  
   - **`OnPrepareDC`**: 맵핑 모드/오리진 설정, 현재 페이지 반영  
   - **`OnPrint`**: 해당 페이지 렌더  
   - 취소 여부 확인(진행 UI ↔ `m_bContinuePrinting`)  
6) **`OnEndPrinting`**: 리소스 해제  
7) 프린트는 스풀러로 전송되어 실제 장치에서 출력, 프리뷰는 창 종료 시 원래 뷰로 복귀

---

## 11) 페이지 구성 요소(레이아웃 설계 체크리스트)

- **머리말/꼬리말**: 문서명, 경로, 날짜/시간, 페이지 X/Y  
- **본문**: 여백, 단락 간격, 컬럼(1~N), 이미지/표 위치  
- **그리드/가이드라인**: 눈금(선택), 텍스트 베이스라인 일치  
- **여백/블리드**: 프린터 물리 여백 고려(완전 무여백은 일부 프린터만 가능)  
- **색/선 두께**: 얇은 선은 프린터 해상도에서 **가시성 저하** 가능 → 최소 두께 보정

---

## 12) 이미지/도형 인쇄 팁

- **벡터 우선**: 선/도형/텍스트는 GDI 벡터로 그릴수록 선명  
- **비트맵 인쇄**:  
  - 인쇄 해상도에 맞게 **미리 스케일**(과도한 업스케일/다운스케일 방지)  
  - **색상 관리**(CMYK는 드라이버에 맡겨야; GDI는 기본적으로 RGB)  
  - **Halftone** 품질(확대 시 `HALFTONE` 모드가 선명)  
- **투명도/알파**: GDI의 알파 합성 한계를 인지(필요 시 GDI+ 사용을 검토)

---

## 13) 다중 페이지/섹션/용지 자동 전환

- 일부 앱은 **페이지마다 다른 방향/용지**(세로/가로, A4/Letter)를 원합니다.  
  - 프레임워크는 **한 문서 내에서의 DEVMODE 변경**을 보장하지 않습니다.  
  - **섹션 단위로 분리 인쇄**(StartDoc/EndDoc를 나눠 호출되는 구조)·**사용자에게 안내**가 현실적입니다.
- **양면 인쇄**: 드라이버 옵션(duplex)로 제어하되, **홀수/짝수 페이지 레이아웃**을 고려(내측/외측 여백).

---

## 14) 테스트 & 디버깅 방법

- **프린터 없이 테스트**:  
  - **Microsoft Print to PDF** 드라이버로 **PDF 출력** 검사  
  - 프리뷰에서 **여백/스케일/페이지 수** 확인  
- **스풀러 모니터링**: 인쇄 큐/문서 크기/오류 상태  
- **메모리/GDI 리소스**: 대량 페이지 인쇄 시 **GDI 객체 누수**가 없는지 점검  
- **국제화**: CJK/RTL 텍스트 줄바꿈/서체 대체 여부 확인  
- **대용량 문서**: 100+ 페이지 스트레스 테스트(취소 동작/메모리 사용량/속도)

---

## 15) 흔한 문제와 원인·해결

| 증상 | 원인 | 해결 |
|---|---|---|
| 프리뷰/인쇄에서 잘림 | 물리 여백 무시, 좌표 0,0 사용 | **`m_rectDraw`** 기준 사용, 오리진을 안전영역 좌상단으로 이동 |
| 화면과 인쇄 크기 불일치 | DPI 반영 부족, 픽셀 고정 크기 | **맵핑 모드(ANISOTROPIC)**, 폰트 pt→픽셀 변환을 **프린터 DPI로** |
| 페이지 수 오판 | 워드랩/라인 높이 계산 부정확 | **사전 레이아웃 패스**로 라인/페이지 테이블을 만든 뒤 `SetMaxPage` |
| 성능/스풀 크기 폭증 | 고해상도 큰 비트맵 다량 출력 | 이미지 **다운스케일/타일링**, 필요한 영역만 렌더 |
| 취소가 안 먹음 | 루프에서 플래그 미검사 | 페이지/단락 루프마다 **`m_bContinuePrinting` 검사** |
| 폰트 깨짐/대체 | 프린터에 폰트 없음, 글꼴 서브셋 이슈 | 장치 독립 폰트/내장 글꼴 사용, **대체 허용** 전제 하에 메트릭 보정 |
| 양면 여백 뒤바뀜 | 내측/외측 여백 미처리 | 홀/짝 페이지 별 여백 계산 분기 |

---

## 16) 구현 순서(프로젝트 적용 가이드)

1. **인쇄 명령 연결**: 메뉴/툴바/단축키에 표준 ID 연결  
2. **`OnPreparePrinting`**: 전체 페이지 수 계산 로직(텍스트/도면별) 마련  
3. **`OnBeginPrinting`**: 페이지 전체에서 공유할 리소스(폰트/브러시/이미지 캐시) 준비  
4. **`OnPrepareDC`**: 맵핑 모드/스케일/오리진 설정(여백+`m_rectDraw`)  
5. **`OnPrint`**: `m_nCurPage` 기준으로 **해당 페이지**만 렌더  
6. **취소/오류 처리**: 진행 UI와 `m_bContinuePrinting` 연동, 예외 발생 시 메시지/정리  
7. **`OnEndPrinting`**: 리소스 해제·상태 복구  
8. **프리뷰 UX**: 헤더/푸터/페이지 번호/줌 동작 등 다듬기

---

## 17) 베스트 프랙티스 요약

- **`m_rectDraw` + ANISOTROPIC 맵핑**으로 **프린터/프리뷰/화면 간 일관성** 확보  
- **두 번 그리기(레이아웃→렌더)** 패턴: 먼저 **페이지 매김 테이블**을 만들고, 인쇄 시 **그 페이지만** 렌더  
- **리소스 수명**: `OnBeginPrinting`에서 만들고 `OnEndPrinting`에서 해제(페이지마다 만들지 않기)  
- **취소 가능성**을 항상 고려(긴 루프 중 플래그 확인)  
- 이미지/표는 **벡터 우선**, 비트맵은 **필요 크기로 사전 스케일**  
- PDF 드라이버/프리뷰로 **여백/스케일/페이지 수**를 먼저 검증

---

### 마무리

MFC의 인쇄·프리뷰 파이프라인은 **정해진 후크 지점**(Prepare/Begin/PrepareDC/Print/End)을 정확히 나눠 쓰면 **예측 가능하고 안정적**입니다.  
핵심은 **페이지 매김과 좌표계**이며, 이를 표준화해두면 **텍스트/도면/이미지 어떤 콘텐츠에도** 일관된 품질의 출력과 프리뷰를 제공할 수 있습니다.