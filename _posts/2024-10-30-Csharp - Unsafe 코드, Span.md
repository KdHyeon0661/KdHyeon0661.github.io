---
layout: post
title: C# - Unsafe μ½”λ“, Span
date: 2024-10-30 19:20:23 +0900
category: Csharp
---
# C# ν¬μΈν„°μ™€ Unsafe μ½”λ“, Span<T> κΈ°μ΄ μ •λ¦¬

C#μ€ κΈ°λ³Έμ μΌλ΅ **μ•μ „ν• λ©”λ¨λ¦¬ κ΄€λ¦¬**λ¥Ό μ κ³µν•μ§€λ§, λ•λ•λ΅ ν¬μΈν„°μ™€ λ©”λ¨λ¦¬ μ£Όμ†λ¥Ό μ§μ ‘ λ‹¤λ¤„μ•Ό ν•  κ²½μ°κ°€ μμµλ‹λ‹¤.  
μ΄ κΈ€μ—μ„λ” C#μ—μ„ `unsafe`, ν¬μΈν„°, `fixed`, `stackalloc`, `Span<T>` λ“± **λ„¤μ΄ν‹°λΈ μμ¤€μ λ©”λ¨λ¦¬ μ ‘κ·Ό λ°©μ‹**μ„ λ‹¤λ£Ήλ‹λ‹¤.

---

## π”· 1. `unsafe` ν‚¤μ›λ“λ€?

- C#μ ν¬μΈν„° μ—°μ‚°μ„ ν—μ©ν•λ” λΈ”λ΅
- **μ»΄νμΌ μµμ… `/unsafe` λλ” `Allow unsafe code` ν•„μ”**

```csharp
unsafe
{
    int x = 10;
    int* p = &x;
    Console.WriteLine(*p); // 10
}
```

- `*p`: ν¬μΈν„° μ—­μ°Έμ΅°
- `&x`: λ³€μμ μ£Όμ†

> κΈ°λ³Έμ μΌλ΅ μ•μ „ν•μ§€ μ•κΈ° λ•λ¬Έμ— μΌλ° μ• ν”λ¦¬μΌ€μ΄μ…μ—μ„λ” μ‚¬μ©μ„ μ ν•ν•©λ‹λ‹¤.

---

## π”· 2. fixed λ¬Έ β€“ GCλ΅λ¶€ν„° λ©”λ¨λ¦¬ κ³ μ •

C#μ κ°€λΉ„μ§€ μ»¬λ ‰ν„°λ” κ°μ²΄λ¥Ό μ΄λ™μ‹ν‚¬ μ μκΈ° λ•λ¬Έμ—, **ν¬μΈν„°λ΅ μ ‘κ·Όν•  λ• μ£Όμ†κ°€ κ³ μ •λμ–΄μ•Ό** ν•©λ‹λ‹¤.

```csharp
unsafe
{
    int[] nums = { 1, 2, 3 };
    fixed (int* p = nums)
    {
        Console.WriteLine(p[0]); // 1
    }
}
```

- `fixed` λΈ”λ΅μ€ ν•΄λ‹Ή λ³€μμ λ©”λ¨λ¦¬λ¥Ό **GCκ°€ μ΄λ™ν•μ§€ λ»ν•λ„λ΅ κ³ μ •**

---

## π”· 3. stackalloc β€“ μ¤νƒ λ©”λ¨λ¦¬ μ§μ ‘ ν• λ‹Ή

μ¤νƒμ— λ©”λ¨λ¦¬λ¥Ό μ§μ ‘ ν• λ‹Ήν•μ—¬ ν™ ν• λ‹Ήλ³΄λ‹¤ λΉ λ¥΄κ² μ²λ¦¬ν•©λ‹λ‹¤.

```csharp
Span<int> buffer = stackalloc int[5];
for (int i = 0; i < buffer.Length; i++)
    buffer[i] = i;

foreach (var n in buffer)
    Console.WriteLine(n); // 0 1 2 3 4
```

- `stackalloc`μ€ ν™μ΄ μ•„λ‹ **μ¤νƒ μμ—­**μ— λ°μ΄ν„°λ¥Ό ν• λ‹Ή
- `Span<T>`μ™€ ν•¨κ» μ‚¬μ©ν•  μ μμ

---

## π”· 4. Span<T> β€“ μ•μ „ν• λ©”λ¨λ¦¬ μ¬λΌμ΄μ¤

```csharp
Span<byte> bytes = stackalloc byte[4];
bytes[0] = 0x10;
bytes[1] = 0x20;

Span<byte> slice = bytes.Slice(1, 2); // 0x20, 0x00
```

- `Span<T>`λ” λ°°μ—΄, ν¬μΈν„°, μ¤νƒ λ©”λ¨λ¦¬ λ“± **λ¨λ“  μ—°μ† λ©”λ¨λ¦¬ λΈ”λ΅μ„ μ¬λΌμ΄μ¤μ²λΌ λ‹¤λ£Έ**
- μ„±λ¥μ€ λ†’μ§€λ§ **`ref struct`λ΅ ν™μ— μ €μ¥ν•  μ μ—†μ**
- λ©”μ„λ“ μΈμλ΅ λ„κΈΈ μ μκ³ , λ³µμ‚¬ λΉ„μ© μ—†μ

---

## π”· 5. ref structμ™€ Spanμ μ μ•½

```csharp
ref struct MyBuffer
{
    public Span<int> Data;
}
```

- `Span<T>`λ” **ν™μ— μ΅΄μ¬ν•  μ μ—†μ β†’ ν΄λμ¤ ν•„λ“λ΅ κ°€μ§ μ μ—†μ**
- λ”°λΌμ„ `ref struct`λ” μ¤νƒμ—λ§ μ΅΄μ¬ν•λ©°, GCμ— μν•΄ κ΄€λ¦¬λμ§€ μ•μ
- λΉ„λ™κΈ° λ©”μ„λ“λ‚ λλ‹¤ μΊ΅μ² λ“±μ—μ„λ„ μ‚¬μ©ν•  μ μ—†μ

---

## β… μ”μ•½ μ •λ¦¬

| ν‚¤μ›λ“ / νƒ€μ… | μ„¤λ… |
|---------------|------|
| `unsafe` | ν¬μΈν„° μ‚¬μ© ν—μ© |
| `*`, `&` | ν¬μΈν„° μ—°μ‚°μ |
| `fixed` | GC μ΄λ™ λ°©μ§€ (λ©”λ¨λ¦¬ κ³ μ •) |
| `stackalloc` | μ¤νƒ λ©”λ¨λ¦¬ μ§μ ‘ ν• λ‹Ή |
| `Span<T>` | μ•μ „ν• μ¬λΌμ΄μ¤ κΈ°λ° λ©”λ¨λ¦¬ μ ‘κ·Ό |
| `ref struct` | Spanμ„ ν¬ν•¨ν•λ” μ¤νƒ μ „μ© κµ¬μ΅°μ²΄ |

---

## π§  μ–Έμ  μ‚¬μ©ν•λ‚μ”?

- **Native API νΈμ¶ μ‹ (P/Invoke)** κµ¬μ΅°μ²΄λ¥Ό ν¬μΈν„°λ΅ λ„κΈΈ λ•
- **μ„±λ¥ μµμ ν™”**κ°€ ν•„μ”ν• μ½”λ“ (ex. λ€λ‰ λ°°μ—΄ μ—°μ‚°)
- **GC ν™μ„ ν”Όν•κ³  μ‹¶μ„ λ•**
- **Span<T>λ¥Ό μ΄μ©ν• λ¬Έμμ—΄ μ²λ¦¬, λ²„νΌ μ΅°μ‘** λ“±μ—