---
layout: post
title: Linux - 시스템 정보와 하드웨어 확인
date: 2024-11-19 19:20:23 +0900
category: Linux
---
# 시스템 정보와 하드웨어 확인

## 관측의 세 가지 층위(요약)

1. **실시간 관측**: `top/htop`, `vmstat`, `iostat`, `ip -s`, `nload`, `dstat`
2. **정적/상세 정보**: `lscpu`, `lsblk -f`, `lspci -nnk`, `lsusb`, `dmidecode`, `lshw`, `/proc`, `/sys`
3. **특화 진단/부하 재현**: `smartctl/nvme-cli`, `fio/ioping`, `ethtool/iperf3`, `perf/turbostat`, `sensors/powertop`

---

## 실시간 자원 사용(운영 관제의 출발점)

### `top` — 기본 실시간 모니터

```bash
top
```
단축키:
- `P`(CPU), `M`(메모리), `T`(시간) 정렬, `k`(PID 종료), `1`(코어별 CPU), `f`(필드 선택), `q`(종료)

### `htop` — 상호작용 UI

```bash
sudo apt install -y htop
htop
```
- F2(설정), F4(필터), F6(정렬), F9(kill), F10(종료)
- 우측 상단에 CPU 코어바, 메모리/스왑, 부하 평균 등 가시성 우수

### `free` — 메모리 요약

```bash
free -h
```
- `available`은 캐시/버퍼 반영한 실제 가용량 추정

### `vmstat` — 전체 성능 스냅샷

```bash
vmstat 2 5     # 2초 간격 5회
```
- `r`(run queue), `si/so`(스왑 in/out), `wa`(I/O wait)로 병목 추정

### `uptime` — 가동 시간과 부하 평균

```bash
uptime
```

### `iostat` — 디스크 I/O

```bash
sudo apt install -y sysstat
iostat -xz 1 3
```
- `r/s`, `w/s`, `rkB/s`, `wkB/s`, `await`, `svctm`, `%util` 해석으로 디스크 포화 감지

### `dstat` — 종합 실시간(대체: `sar`, `atop`)

```bash
sudo apt install -y dstat
dstat -cdngym --top-io --top-bio
```

---

## CPU/메모리/보드 — 정적·상세 정보

### `lscpu` — 마이크로아키텍처/토폴로지

```bash
lscpu
lscpu -e=CPU,CORE,SOCKET,NODE,ONLINE
numactl -H                 # NUMA 노드/메모리 접근성
```
- CPU 플래그, 스레딩, 캐시, NUMA 유무 확인

### 메모리·보드/BIOS — `dmidecode`/`lshw`

```bash
sudo dmidecode -t memory | less
sudo dmidecode -t bios
sudo lshw -short | less
```
- 메모리 채널/슬롯, DIMM 용량·속도·제조사, BIOS 버전 등

### 열/전력/주파수 — `sensors`/`turbostat`/`powertop`

```bash
sudo apt install -y lm-sensors powertop
sudo sensors-detect               # 한 번만
sensors                           # 온도/전압/팬속
sudo powertop                     # 전력 이슈/튜닝 힌트

# Intel 플랫폼(패키지 C-state/주파수)

sudo apt install -y linux-tools-common
which turbostat && sudo turbostat --Summary --interval 5
```

### 커널·하드웨어 ID — `/proc`·`lspci`·`lsusb`

```bash
cat /proc/cpuinfo | grep -E 'model name|flags' | head
lspci -nnk | less       # [벤더:디바이스]와 커널 드라이버
lsusb -v | less
```

---

## 스토리지 — 구조·건강·성능

### 블록 구성 — `lsblk`/`blkid`/`parted`/`fdisk`

```bash
lsblk -o NAME,SIZE,ROTA,TYPE,MOUNTPOINT,FSTYPE,MODEL
sudo blkid
sudo parted -l
sudo fdisk -l
```
- `ROTA=0`(SSD/NVMe), `ROTA=1`(HDD)

### 파일시스템 상태

```bash
df -hT
mount | column -t | grep -v snap
```
- 타입(ext4/xfs/btrfs), 마운트 옵션(noatime, discard 등) 확인

### RAID/LVM/ZFS/Btrfs

```bash
# RAID(md)

sudo mdadm --detail /dev/md0

# LVM

sudo pvs; sudo vgs; sudo lvs -a -o +devices

# ZFS

sudo zpool status; sudo zpool list; sudo zfs list

# Btrfs

sudo btrfs filesystem df /mountpoint
sudo btrfs scrub status /mountpoint
```

### SMART/NVMe 건강 — `smartctl`/`nvme-cli`

```bash
sudo apt install -y smartmontools nvme-cli

# SATA/SAS

sudo smartctl -a /dev/sda
sudo smartctl -H /dev/sda             # 건강 요약
sudo smartctl -t short /dev/sda       # 단기 테스트

# NVMe

sudo nvme list
sudo nvme smart-log /dev/nvme0
sudo nvme error-log /dev/nvme0
```
- 재할당 섹터/미보정 오류/온도/기본 웨어 레벨링 등 체크

### 지연·대역폭 테스트 — `fio`/`ioping`

```bash
sudo apt install -y fio ioping

# 랜덤 읽기/쓰기(4k), 1분, QD32, 측정 타겟 디렉토리 지정

fio --name=randrw --rw=randrw --bs=4k --size=2G --iodepth=32 \
    --runtime=60 --time_based --directory=/data --numjobs=4 --group_reporting

# 지연도 빠른 측정

ioping -c 10 /data
```
> 운영 중인 파일시스템에 부하를 줄 수 있으니 **유의**.

---

## 네트워크 — 링크·통계·오프로드·성능

### 인터페이스·통계 — `ip`/`ss`

```bash
ip -s link                    # 드롭/에러/오버런
ss -tuln                      # 리슨 포트
ss -s                         # 소켓 요약 통계
```

### 드라이버/오프로드/링 버퍼 — `ethtool`

```bash
sudo apt install -y ethtool
sudo ethtool -i eth0                 # 드라이버/버전
sudo ethtool eth0                    # 링크/속도/듀플렉스
sudo ethtool -k eth0                 # 오프로드(메서스/TSO/GRO/RXCSUM)
sudo ethtool -S eth0 | less          # 하드 통계(드롭/에러/큐별 카운터)
sudo ethtool -g eth0                 # RX/TX ring size
```

### 대역폭/지연 측정 — `iperf3`/`mtr`/`traceroute`

```bash
sudo apt install -y iperf3 mtr traceroute

# 서버

iperf3 -s
# 클라이언트 → 서버IP

iperf3 -c 192.0.2.10 -P 4 -t 30

# 경로+품질

mtr -rwzbc 100 8.8.8.8
traceroute -n 8.8.8.8
```

### 트래픽/플로우 장기 수집 — `sar`

```bash
sudo systemctl enable --now sysstat
sar -n DEV 1 5
sar -n TCP,ETCP 1 5
```

---

## 프로세스·커널 관점 — 세밀 분석

### `pidstat`/`mpstat` — per-process/per-CPU

```bash
pidstat 1 5              # 프로세스별 CPU/메모리/IO
mpstat -P ALL 1 5
```

### `perf` — 샘플링/플레임그래프(기초)

```bash
sudo apt install -y linux-tools-$(uname -r)
sudo perf top            # 핫 심볼 확인
sudo perf record -g -- your_cmd
sudo perf report
```
> 심볼 해석/보안 설정에 따라 권한 필요.

### 슬랩/페이지/인터럽트

```bash
slabtop
vmstat -s | head
cat /proc/interrupts | column -t
```
- 특정 NIC 큐에 인터럽트 편중 → **IRQ affinity**/RPS 조정 고려.

---

## GPU/가속 — NVIDIA/AMD

### NVIDIA

```bash
nvidia-smi
nvidia-smi dmon -s pucm
```

### AMD ROCm

```bash
rocm-smi
```

---

## 컨테이너/가상화/NUMA/IRQ 고급 주제

### 가상화 지원/하이퍼바이저 감지

```bash
lscpu | grep -E 'Virtualization|Hypervisor'
systemd-detect-virt
```

### NUMA 바인딩/메모리 정책

```bash
numactl -H
numactl --cpunodebind=0 --membind=0 your_cmd
```

### IRQ Affinity 튜닝(네트워크 고속화)

```bash
# 큐별 IRQ 확인

grep eth0 /proc/interrupts
# 코어 마스크 바인딩(예시: IRQ 90을 CPU 2에)

echo 0x4 | sudo tee /proc/irq/90/smp_affinity
```
> 운영 서버에서는 변경 범위를 작게, 단계적으로 테스트.

---

## 전원/배터리/ACPI(노트북/엣지)

```bash
upower -i $(upower -e | grep BAT) | less
acpi -V
powertop
```

---

## 하드웨어 인벤토리 보고서(원클릭 수집 스크립트)

### 수집 스크립트

```bash
#!/usr/bin/env bash
# sysreport.sh — 시스템/하드웨어/성능 요약 리포트

set -euo pipefail
OUT="sysreport_$(hostname)_$(date +%F_%H%M%S).txt"

exec > >(tee "$OUT") 2>&1

echo "== HOST/OS =="
hostnamectl || true
echo

echo "== KERNEL =="
uname -a
lsb_release -a 2>/dev/null || true
echo

echo "== CPU/NUMA =="
lscpu
numactl -H 2>/dev/null || true
echo

echo "== MEMORY =="
free -h
vmstat -s | head -n 30
echo

echo "== SENSORS =="
sensors 2>/dev/null || true
echo

echo "== BLOCK/LVM/FS =="
lsblk -o NAME,SIZE,ROTA,TYPE,MOUNTPOINT,FSTYPE,MODEL
df -hT
pvs 2>/dev/null || true; vgs 2>/dev/null || true; lvs -a -o +devices 2>/dev/null || true
mdadm --detail /dev/md0 2>/dev/null || true
echo

echo "== SMART/NVME =="
for d in /dev/sd[a-z] /dev/nvme[0-9]n1; do
  [ -e "$d" ] || continue
  if [[ "$d" == /dev/nvme* ]]; then
    echo "-- $d --"
    nvme smart-log "$d" 2>/dev/null || true
  else
    echo "-- $d --"
    smartctl -H -A "$d" 2>/dev/null || true
  fi
done
echo

echo "== PCI/USB =="
lspci -nnk | sed -n '1,120p'
lsusb 2>/dev/null || true
echo

echo "== NET =="
ip -s link
ss -tuln
for nic in $(ls /sys/class/net | grep -v lo); do
  echo "-- ETHTOOL $nic --"
  ethtool $nic 2>/dev/null || true
  ethtool -k $nic 2>/dev/null || true
done
echo

echo "== PROC LIMITS (shell) =="
ulimit -a
echo

echo "== DONE: $OUT =="
```

### 실행

```bash
chmod +x sysreport.sh
./sysreport.sh
```
- 생성 파일: `sysreport_HOST_YYYY-MM-DD_HHMMSS.txt`
- 장애 접수 시 1차 자료로 전달하면 진단 속도가 대폭 향상된다.

---

## 장애 시나리오별 점검 루틴

### “로드가 높은데 서비스가 느리다”

1) CPU/스케줄링:
```bash
uptime; top -H -p $(pgrep -d, -f your_service)
pidstat -t 1 5 -p $(pgrep -d, -f your_service)
```
2) 메모리/스왑:
```bash
free -h; vmstat 1 5
cat /proc/meminfo | egrep 'Dirty|Writeback|Anon|PageTables'
```
3) I/O:
```bash
iostat -xz 1 5
pidstat -d 1 5 -p $(pgrep -d, -f your_service)
```
4) 네트워크:
```bash
ip -s link; ss -s; ethtool -S eth0 | egrep 'drop|err|miss|fail' -i
```

### “디스크 성능 급락/에러 의심”

```bash
dmesg | egrep -i 'error|reset|timeout|link'
iostat -xz 1 5
smartctl -H -A /dev/sda
nvme smart-log /dev/nvme0
```
- `await` 상승 + `dmesg` 오류 → 케이블/포트, 펌웨어/컨트롤러, 디스크 건강 점검

### “네트워크 간헐적 패킷 드롭”

```bash
ip -s link
ethtool -S eth0 | egrep -i 'drop|error'
dmesg | egrep -i 'net|eth|mlx|ixgbe|bnx'   # 드라이버 메시지
mtr -rwzbc 200 8.8.8.8
iperf3 -c GATEWAY -P 4 -t 20
```
- 오프로드 충돌시 `ethtool -K eth0 gro off gso off tso off rx off tx off`로 비교 테스트

### “NUMA/IRQ 편중으로 지연”

```bash
numactl -H
cat /proc/interrupts | column -t | egrep 'eth0|nvme'
# 큐-코어 매핑 재조정(테스트 환경에서)

echo 0x4 | sudo tee /proc/irq/<IRQ>/smp_affinity
```

---

## 보너스: /proc·/sys 필수 포인트

```bash
cat /proc/uptime
cat /proc/loadavg
cat /proc/<PID>/status
cat /proc/meminfo
cat /proc/zoneinfo | less
cat /proc/slabinfo | head
```

`/sys`로 하드웨어/드라이버 파라미터를 확인/조정할 수 있다:
```bash
# CPU governor(배포판/커널에 따라 경로 다름)

cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
```
> 운영환경에서는 변경 전/후를 반드시 기록하고 롤백 계획을 마련할 것.

---

## 스니펫: 주간 성능 스냅샷 수집 크론(요약)

```bash
# /usr/local/bin/quick-snap.sh
#!/usr/bin/env bash

D="/var/log/snap"; mkdir -p "$D"
date '+%F %T' >> "$D/cpu.mem.log"
uptime >> "$D/cpu.mem.log"
vmstat 1 3 >> "$D/cpu.mem.log"
iostat -xz 1 3 >> "$D/io.log"
sar -n DEV 1 3 >> "$D/net.log"
```

```bash
# /etc/cron.d/quick-snap

*/30 * * * * root /usr/local/bin/quick-snap.sh
```

---

## 명령어 요약 치트시트

| 범주 | 핵심 명령 |
|---|---|
| 실시간 총괄 | `top`, `htop`, `vmstat`, `dstat`, `iostat -xz` |
| CPU/NUMA | `lscpu`, `numactl -H`, `mpstat`, `turbostat` |
| 메모리 | `free -h`, `vmstat -s`, `slabtop`, `cat /proc/meminfo` |
| 디스크 구조 | `lsblk -f`, `blkid`, `fdisk -l`, `parted -l`, `df -hT` |
| 디스크 건강 | `smartctl -a`, `nvme smart-log`, `mdadm --detail`, `lvs/vgs/pvs` |
| 디스크 성능 | `fio`, `ioping` |
| 네트워크 링크 | `ip -s link`, `ss -tuln/-s`, `ethtool/-S/-k/-g` |
| 네트워크 성능 | `iperf3`, `mtr`, `traceroute`, `sar -n` |
| 하드웨어 전반 | `dmidecode`, `lshw`, `lspci -nnk`, `lsusb` |
| 전력/온도 | `sensors`, `powertop`, `turbostat` |
| 프로파일링 | `pidstat`, `perf top/record` |

---

## 마무리

- **1단계(실시간)**: `top/htop`, `vmstat`, `iostat`, `ip -s`, `ss`.
- **2단계(상세)**: `lscpu/lsblk/lspci/dmidecode/lshw`와 `smartctl/nvme-cli`로 **건강/펌웨어/드라이버** 확인.
- **3단계(재현/튜닝)**: `fio/ioping`으로 IO 특성 파악, `ethtool/iperf3`로 링크/오프로드 검증, `perf/turbostat/sensors`로 병목 결정.
- **자동화**: 수집 스크립트/크론/`sysstat(sar)`로 **타임라인 데이터화** → 장애 상관관계 분석.
