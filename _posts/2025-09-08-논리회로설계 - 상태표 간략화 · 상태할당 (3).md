---
layout: post
title: 논리회로설계 - 상태표 간략화 · 상태할당 (3)
date: 2025-09-08 22:25:23 +0900
category: 논리회로설계
---
# 상태표 간략화·상태할당 — **등가 상태할당**, **상태할당 가이드라인**, **원-핫(one-hot) 상태할당**(예제 포함)

> 표기: 입력 \(x\), 상태 \(S\in\{S_0,\dots,S_{N-1}\}\), 상태코드(상태벡터) \(\mathbf{Q}=(Q_{m-1}\dots Q_0)\), 다음상태 \(\mathbf{Q}^+\), 출력 \(y\).  
> 모델: 클럭형 순서회로(Mealy/Moore). 수학은 **MathJax**, 코드와 파형은 ```로 표시합니다.

---

## 0) 배경 정리: “상태 최소화” vs “상태할당”
- **상태 최소화**: 등가(동치) 상태 병합으로 **상태 수**를 줄이는 과정(함의 차트/분할정련 등).  
- **상태할당(State Assignment)**: 최소화된 **상태 집합**에 **비트 코드**를 배정하는 과정. 다음상태/출력 로직의 **게이트 수·지연·해저드**가 이 단계에서 크게 좌우됩니다.

---

## 1) 등가 상태할당(Equivalent State Assignment)

### 1.1 정의(개념)
두 개의 상태코드 배정 \(\mathcal{A}_1,\mathcal{A}_2\)가 있을 때,
- **행동 등가**: 같은 상태표(전이/출력)를 구현하면 **항상 등가**(출력열 동일).  
- **비용 등가(코스트 등가)**: 주어진 로직 최적화 규칙·셀 라이브러리 하에서 **동일 게이트 비용/지연**을 낳는 배정.

일반적으로 다음 변환을 조합한 코드 변환은 **동작·비용 모두 보존**되는 경우가 많습니다.

### 1.2 비용을 보존하는 대표 변환(이진 인코딩)
\[
\boxed{\text{(a) 상태 비트의 **치환**},\quad \text{(b) 상태 비트의 **보수(Complement)**},\quad \text{(c) 상태 라벨의 **치환**}}
\]
- (a) \(Q_i \leftrightarrow Q_j\) 교환: K-맵의 축 교환과 동일 → 커버 크기 보존.  
- (b) \(Q_i \mapsto \overline{Q_i}\): K-맵의 축 반전과 동일 → 커버 크기 보존.  
- (c) 상태 이름 바꾸기: 의미적 동일.

> **정리(직관)**: K-맵에서 **축의 교환/반전**은 **최소 커버의 크기**(묶음 크기/개수)를 바꾸지 않으므로, SOP/POS의 항 수·리터럴 수가 **동일 수준**을 유지합니다. → 이런 변환으로 얻은 배정을 **등가 상태할당**이라 부릅니다.

### 1.3 비(非)등가가 될 수 있는 경우
- **인접성 보존 실패**: 자주 오가는 전이가 K-맵 상 **비인접**하도록 코드가 배정되면, 큰 묶음이 깨져 **항 수 증가**.  
- **플랫폼 특성**: FPGA의 **원-핫 최적화/카리 체인**, ASIC의 **AOI/OAI 가용성** 등 셀 세트 차이로 비용 동등성이 깨질 수 있음.  
- **제약된 팬인/배선**: 물리 제약으로 경로 분해가 필요해지면 이론적 동등성이 실무 비용과 달라짐.

---

## 2) 상태할당 가이드라인(체계적 절차)

### 2.1 전체 절차(체크리스트)
1. **상태 최소화**를 먼저 수행(도달성·등가 병합).  
2. **전이 인접 그래프**를 만든다:  
   - 노드=상태, 간선=자주 발생/필수 전이 \((S_i\to S_j)\), 가중치=전이 빈도/중요도.  
3. **출력 지향 설계**(Moore): 출력 비트들을 **상태코드의 비트**로 내장 가능한지 검토.  
4. **인접성 보존 배정**: 자주 오가는 쌍이 **해밍거리 1**이 되도록 **그레이-ish**하게 배정.  
5. **플랫폼 고려**:  
   - FPGA: **원-핫**, 또는 “원-핫+출력 레지스터”가 고속/단순.  
   - ASIC: **이진/그레이**로 FF 절약, **팬인**과 **AOI** 구조에 맞춰 인수화.  
6. **해저드·EMI 고려**: 공정/속도·Mealy 출력이면 **단일비트 전이 우선**(그레이, Johnson).  
7. **검증**: K-맵/합성 결과로 **리터럴 수·셀 수·f\_max**를 비교해 선택.

### 2.2 출력 지향(특히 Moore)
- Moore 출력 \(y\)가 **상태만**의 함수라면, **상태코드의 특정 비트**가 바로 \(y\)가 되도록 배정한다.
  \[
  \boxed{\text{“출력 비트를 상태코드에 내장하면 출력 로직 = 0”}}
  \]
- 다중 출력도 동일: \(y_0,y_1\)를 **상태코드의 두 비트**로 매핑 → 다수 출력이 즉시 제거.

### 2.3 인접성 지향(Adjacency, Huffman 스타일)
- **전이 행렬**에서 빈도가 큰 \((S_i,S_j)\)를 **해밍거리 1**로.  
- 가능한 한 FSM의 **주 순환 루프**를 **그레이 코드**로 감싸면 K-맵 묶음이 크게 형성.

### 2.4 Mealy 출력의 안전
- Mealy는 출력이 **간선**의 함수이므로 **글리치**에 민감.  
- **권장**: (i) 출력 등록 한 단계 추가, (ii) 상태할당은 **전이 시 단일비트 변화**를 최대화(해밍 1).

---

## 3) 예제 1 — 4상태 Moore FSM의 **이진/그레이/등가 배정** 비교

### 3.1 명세(간단 순환 + 분기)
상태: \(A,B,C,D\), 입력 \(x\).  
전이:
- \(A \xrightarrow{x=0} B,\; A \xrightarrow{x=1} C\)  
- \(B \xrightarrow{*} C\) (0/1 모두 C)  
- \(C \xrightarrow{x=0} D,\; C \xrightarrow{x=1} A\)  
- \(D \xrightarrow{*} A\)  
출력(노드): \(y(A)=0,y(B)=0,y(C)=1,y(D)=1\).

### 3.2 배정안 (세 가지)
1) **이진 표준**: \(A=00,B=01,C=10,D=11\)  
2) **그레이**: \(A=00,B=01,C=11,D=10\)  (사이클 \(A\to B\to C\to D\to A\)가 전부 해밍 1)  
3) **등가 변환 예**: (2)에서 **비트 반전** \(Q_1\mapsto \overline{Q_1}\) → \(A=10,B=11,C=01,D=00\)

### 3.3 효과 비교(정성)
- (1) 이진 표준: \(A\leftrightarrow C\) 전이가 **해밍 2** → \(Q^+\) K-맵에서 큰 묶음이 깨질 가능성↑.  
- (2) 그레이: 모든 주 전이가 해밍 1 → \(Q_i^+\)를 단순 XOR/선형 결합으로 표현 가능성↑.  
- (3) 등가 변환: (2)에서 축 반전이므로 **최소 커버 크기 동일**(코스트 등가).

> **실무 팁**: 전이 구조가 순환형이면 **그레이 배정**이 대체로 유리. “등가 변환(축 교환/반전)”은 합성 비용을 거의 바꾸지 않습니다.

---

## 4) 원-핫(one-hot) 상태할당 — **원리·장단점·패턴**

### 4.1 원리
- 상태 수 \(N\)개면 **FF도 \(N\)**개. 그 중 **단 1개**만 ‘1’.  
- 다음상태 FF의 \(D\)식은 **“해당 상태로 들어오는 간선들의 OR”** 한 줄로 끝난다.
  \[
  \boxed{S_j^+ = \bigvee_{(i,x):\,\delta(S_i,x)=S_j}\left(S_i \land \chi_x\right)}
  \]
  (\(\chi_x\): 입력 판별식, 예: \(x\) 또는 \(\overline{x}\) 등)

### 4.2 장단점
- **장점**:  
  - 조합식 **극단적으로 단순**(팬인 2~3), **고속**(FPGA LUT·캐리체인 친화).  
  - 출력(Moore)도 `y = S_k`처럼 간단.  
  - **디버깅** 직관적(스코프에서 ‘상태 비트=1’).  
- **단점**:  
  - FF 수가 큼(ASIC 면적/전력).  
  - **상태 비트 다중 클록 부하**(클록트리 전력↑).  
  - SEU/불법 상태 대응을 “one-hot safe FSM” 옵션이나 **others→IDLE**로 처리 필요.

### 4.3 예제 2 — `1011` Mealy 검출기(중첩 허용)를 **원-핫**으로
상태 의미: \(S_0=\epsilon\), \(S_1=1\), \(S_2=10\), \(S_3=101\). 입력 \(x\).

전이(요약):  
- \(S_0: 0\to S_0,\; 1\to S_1\)  
- \(S_1: 0\to S_2,\; 1\to S_1\)  
- \(S_2: 0\to S_0,\; 1\to S_3\)  
- \(S_3: 0\to S_2,\; 1\to S_1\) (이때 **출력=1**)

**다음상태(원-핫)**
\[
\begin{aligned}
S_0^+ &= S_0\overline{x} + S_2\overline{x}\\
S_1^+ &= S_0 x + S_1 x + S_3 x\\
S_2^+ &= S_1\overline{x} + S_3\overline{x}\\
S_3^+ &= S_2 x\\
y &= S_3 \cdot x \quad(\text{Mealy;\ 1클럭 등록 권장})
\end{aligned}
\]

**VHDL 스켈레톤**
```vhdl
-- one-hot FSM for 1011 (Mealy overlap), registered y
library ieee; use ieee.std_logic_1164.all;
entity det_1011_oh is
  port (clk,rst,x: in std_logic; y: out std_logic);
end;
architecture rtl of det_1011_oh is
  signal S0,S1,S2,S3, y_i : std_logic := '0';
begin
  process(clk) begin
    if rising_edge(clk) then
      if rst='1' then
        S0<='1'; S1<='0'; S2<='0'; S3<='0'; y_i<='0';
      else
        S0 <= (S0 and not x) or (S2 and not x);
        S1 <= (S0 and x)     or (S1 and x)     or (S3 and x);
        S2 <= (S1 and not x) or (S3 and not x);
        S3 <= (S2 and x);
        y_i<= (S3 and x); -- register Mealy output
      end if;
    end if;
  end process;
  y <= y_i;
end;
```

### 4.4 원-핫 Safe FSM 팁(불법상태 복구)
- 합성 옵션의 “safe state machine” 사용 또는
```vhdl
when others => S0 <= '1'; S1 <= '0'; S2 <= '0'; S3 <= '0';
```
- **동기 리셋 해제**(메타안정 방지), **CDC 입력 2단 동기화**.

---

## 5) 예제 3 — **동일 FSM**의 이진 vs 원-핫 **비용 감**(정성)

같은 `1011` Mealy 검출기를 **이진(2 FF)** 로 구현하면, \(Q_1^+,Q_0^+\) 식이 입력 \(x\)와 현상태 \((Q_1,Q_0)\)의 **3변수** K-맵에서 나와 **2~3항** SOP가 됩니다.  
원-핫(4 FF)에서는 각 \(S_j^+\)가 **2항 OR** 수준.  
- **FPGA**: LUT 깊이/팬인이 줄어 **f\_max ↑**, FF 증가는 **보통 허용**.  
- **ASIC**: FF 2→4는 면적/전력↑, 하지만 조합 게이트가 확 줄면 타협 가능.  
- **결론**: 플랫폼과 제약(전력·면적·속도)에 맞춰 선택.

---

## 6) 상태할당 실무 가이드(한 장 요약)

### 6.1 해야 할 일(Do)
- **자주 전이**하는 상태쌍을 **해밍 1**로(인접성 보존).  
- Moore라면 **출력 비트 내장**(출력 로직=0).  
- Mealy 출력은 **레지스터** 한 단계.  
- FPGA면 **원-핫**(또는 “원-핫+출력레지스터”), ASIC면 **이진/그레이** 우선.  
- **others** 절로 **불법코드 복구**(self-start).  
- 합성 결과로 **리터럴 수/셀 수/f\_max/전력**을 **실측 비교**.

### 6.2 하지 말 것(Don’t)
- 빈번 전이를 **해밍 2**로 떨어뜨리는 배정(커버 분할→항 증가).  
- Mealy 출력에 **비등록 신호**를 외부 클록/리셋으로 직접 연결(글리치 위험).  
- 비동기 리셋 **해제 타이밍** 무시(복구·제거 시간 위반).

---

## 7) 플립플롭 입력식 유도(상태할당과 연결)

상태할당이 정해지면, 다음상태 \(\mathbf{Q}^+=F(\mathbf{Q},x)\)를 통해 FF 입력을 얻습니다.

### 7.1 암기 공식
\[
\boxed{
\begin{aligned}
&\text{D-FF: } D_i = Q_i^+ \\
&\text{T-FF: } T_i = Q_i \oplus Q_i^+ \\
&\text{JK-FF: } J_i = \overline{Q_i}\,Q_i^+,\;K_i = Q_i\,\overline{Q_i^+} \\
&\text{SR-FF: } S_i = \overline{Q_i}\,Q_i^+,\;R_i = Q_i\,\overline{Q_i^+}
\end{aligned}}
\]
- **이진 배정**: \(Q_i^+\)를 K-맵으로 최소화 후 위 공식 적용.  
- **원-핫**: 각 상태 비트 \(S_j\)가 곧 FF, \(D_{S_j}=S_j^+\) (상단 §4.3 식).

---

## 8) 예제 4 — **등가 상태할당**의 실제(축 반전/교환)

위 §3의 그레이 배정 (2): \(A=00,B=01,C=11,D=10\).  
축 반전 \(Q_1\mapsto \overline{Q_1}\)을 적용하면 (3): \(A=10,B=11,C=01,D=00\).

### 8.1 왜 비용이 같은가?
- \(Q_1\) 축 반전은 K-맵 상하 반전과 동일 → **묶음(인접 커버) 크기** 불변.  
- 결과적으로 최소 SOP의 **항 수/리터럴 수**가 같아 **셀 수/지연**도 거의 동일.

### 8.2 실무 함의
- 이미 “좋은 배정”을 찾았다면, 축 교환/반전으로 **여러 후보**를 빠르게 생성해 배치배선/타이밍 여유를 탐색할 수 있다(물리설계 친화).

---

## 9) VHDL 팁 — **명시적 인코딩 지시**

합성기마다 문법은 다르지만, 대개 enum 상태 타입에 **encoding 속성**을 줄 수 있습니다.

```vhdl
-- Moore FSM with explicit binary or one-hot encoding
library ieee; use ieee.std_logic_1164.all;
entity fsm_enc is
  port (clk,rst,x: in std_logic; y: out std_logic);
end;
architecture rtl of fsm_enc is
  type state_t is (A,B,C,D);
  signal s, ns: state_t := A;

  -- (1) 이진/그레이 예: A=00, B=01, C=11, D=10
  attribute enum_encoding : string;
  attribute enum_encoding of state_t : type is "00 01 11 10";

  -- (2) 원-핫으로 바꾸려면: "0001 0010 0100 1000"
  -- attribute enum_encoding of state_t : type is "0001 0010 0100 1000";
begin
  process(all) begin
    ns <= s;
    case s is
      when A => if x='0' then ns<=B else ns<=C end if;
      when B => ns<=C;
      when C => if x='0' then ns<=D else ns<=A end if;
      when D => ns<=A;
    end case;
  end process;

  process(clk) begin
    if rising_edge(clk) then
      if rst='1' then s<=A else s<=ns end if;
    end if;
  end process;

  y <= '1' when (s=C or s=D) else '0'; -- Moore 출력 내장도 고려 가능
end;
```

---

## 10) 마무리 포켓 카드

- **등가 상태할당**: 상태비트 **치환/보수**, 상태 라벨 치환은 **코스트 불변**(K-맵 대칭성).  
- **가이드라인**: 전이 **인접성(해밍 1)**, Moore **출력 내장**, 플랫폼별(원-핫 vs 이진/그레이) 최적화.  
- **원-핫**: “들어오는 간선의 OR” → 식 단순·고속(FF↑).  
- **FF 입력식**: \(D=Q^+\), \(T=Q\oplus Q^+\), \(J/K\)·\(S/R\)=세트/리셋 조건.  
- **안전성**: Mealy 출력 **등록**, **others→IDLE**로 불법 상태 복구, 비동기 리셋 **동기 해제**.
