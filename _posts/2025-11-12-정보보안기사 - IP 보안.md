---
layout: post
title: 정보보안기사 - IP 보안
date: 2025-11-12 10:25:23 +0900
category: 정보보안기사
---
# IPsec(IP Security) - AH/ESP 시각화 및 네트워크 보안 프로토콜

## IPsec 개요 및 AH/ESP 시각화

### IPsec 한눈에 보기

- **계층**: L3(IP) 계층에서 **패킷 자체**를 보호(기밀성·무결성·송신자 인증·재전송 방지)
- **구성 요소**
  - **AH(Authentication Header)**: 무결성/인증/재전송 방지, **암호화 없음**
  - **ESP(Encapsulating Security Payload)**: **암호화 + 무결성 + 재전송 방지**(사실상 표준)
  - **IKE(Internet Key Exchange)**: 보안 협상·키 교환(현재 **IKEv2** 권장)

### 전송(Transport) 모드 — AH vs ESP

#### AH (Authentication Header, 프로토콜 51) — 무결성/인증, 기밀성 없음

```
[ Original IP hdr ] [      AH      ] [   TCP/UDP hdr   ] [   App Data   ]
                     └─ SPI ─┘└─ Seq ─┘└────── ICV (Integrity Check Value) ──────┘

무결성/인증 범위(개념도):
<========= AH ICV(무결성/인증) 적용 영역 =========>
[ (IP hdr의 immutable 필드) ][ AH ][ TCP/UDP ][ App Data ]

※ 주: AH는 IP 헤더의 **불변 필드(immutable)** 및 상위 계층까지 무결성/인증을 제공
※ **암호화(기밀성) 없음**, NAT와 **비호환적**(IP/포트가 바뀌면 ICV 불일치)
```

#### ESP (Encapsulating Security Payload, 프로토콜 50) — 무결성/인증(+선택적), **기밀성 제공**

```
[ Original IP hdr ] [ ESP hdr ] [   TCP/UDP hdr   ][   App Data   ][ ESP trailer ][ ESP auth ]
                     └ SPI ┘└ Seq ┘                                  └ Pad/PadLen/NextHdr ┘   └ ICV ┘

보호 범위(개념도):
           <==================== ESP 암호화(기밀성) ====================>
[ Original IP hdr ] [ ESP hdr ] [   TCP/UDP hdr + App Data + ESP trailer ] [ ESP auth ]

※ 주: 전송 모드에서는 **IP 원본 헤더는 평문**으로 남고, 상위계층(TCP/UDP+데이터) 중심으로 **암호화/무결성**
```

### 터널(Tunnel) 모드 — AH vs ESP

#### AH (터널)

```
[ New IP hdr ] [      AH      ] [ Original IP hdr ] [ TCP/UDP hdr ] [ App Data ]
                 └ SPI ┘└ Seq ┘└────────────── AH ICV 적용(무결성/인증) ───────────────┘

※ 주: **내부(Original) IP 헤더 포함**해 무결성/인증. 기밀성은 여전히 제공하지 않음
```

#### ESP (터널)

```
[ New IP hdr ] [ ESP hdr ] [      Original IP hdr + TCP/UDP hdr + App Data + ESP trailer      ] [ ESP auth ]
                 └ SPI ┘└ Seq ┘              <=========== ESP 암호화(기밀성) ============>            └ ICV ┘

※ 주: **내부(Original) IP 헤더까지** 전부 ESP 페이로드로 **암호화**(기밀성) + 무결성/인증(ESP auth)
```

### AH/ESP 헤더 구성(필드 개략)

#### AH 헤더(IPv4/IPv6 공통 개념)

```
┌───────────┬───────────┬───────────┬───────────────────────────────────────┐
│ Next Hdr  │ PayloadLen│ Reserved  │ Security Parameters Index (SPI)       │
├───────────┴───────────┴───────────┼───────────────────────────────────────┤
│ Sequence Number (Seq)             │                                       │
├───────────────────────────────────┴───────────────────────────────────────┤
│ Integrity Check Value (ICV, variable)                                     │
└───────────────────────────────────────────────────────────────────────────┘

- Next Hdr: 다음 상위 프로토콜
- SPI/Seq: SA 식별과 재전송 방지
- ICV: HMAC 등으로 계산된 무결성/인증 태그
```

#### ESP 패킷(외형)

```
[ ESP hdr ][   Payload(암호화: 상위계층/내부IP 등) + ESP trailer   ][ ESP auth(무결성) ]
   SPI,Seq            (Data .... Pad .... PadLen .... NextHdr)                  ICV

- ESP hdr: SPI, Seq
- Payload: 암호화 대상(전송모드: L4+Data / 터널모드: 내부 IP 전체)
- trailer: 패딩/다음헤더 식별
- auth(ICV): 무결성/인증(선택적이던 AH 대비 **ESP auth가 일반적**)
```

---

## 데이터 구조 — SPD/SAD와 패킷 흐름

### SPD/SAD 개념

- **SPD(Security Policy Database)**: "어떤 트래픽을 보호/우회/차단할지" 결정(선택자: src/dst, 프로토콜, 포트)
- **SAD(Security Association Database)**: 실제 **SA(보안연결)** 상태(암호군, 키, 시퀀스번호, 수명 등)

```
Ingress/Egress 패킷
   │
   ├─▶ SPD(정책 결정: BYPASS / DISCARD / PROTECT)
   │         │
   │         └─(PROTECT)▶ SA lookup in SAD ─▶ ESP/AH 적용(암복호/인증)
   │
  L3 포워딩/라우팅
```

### 선택자(Selector) 예

| 필드 | 예시 |
|---|---|
| src/dst IP | 10.10.0.0/16 ↔ 10.20.0.0/16 |
| 프로토콜 | tcp/udp/icmp/any |
| 포트 | 80, 443, 0-65535 |
| 방향 | in / out / fwd |

---

## AH vs ESP, Transport vs Tunnel 비교

### AH vs ESP 비교

| 항목 | AH | ESP |
|---|---|---|
| 기밀성(암호화) | X | **O** |
| 무결성/인증 | **O** | **O** |
| 재전송 방지 | **O** | **O** |
| 사용성/실무 | 낮음(거의 미사용) | **표준 채택** |

### 모드 비교

| 모드 | 보호 범위 | 주 용도 |
|---|---|---|
| **Transport** | L4 페이로드(원 IP 헤더 유지) | 호스트↔호스트, 서버 보호(특수) |
| **Tunnel** | **원 IP 패킷 전체** | **게이트웨이↔게이트웨이(사이트간)**, 원격접속 |

---

## NAT 환경에서의 동작 — AH vs ESP(UDP 4500, NAT-T)

```
                ┌───────────────────── Public/Internet ─────────────────────┐
[Host A]──LAN──[NAT]===================[     WAN / ISP     ]=================[NAT]──LAN──[Host B]
                  │                              │                              │
                  │         AH(51)  ✖            │         ← IP/포트 변조로 ICV 불일치(주로 실패)
                  │         ESP(50) ○/✖          │         ← NAT 장비에 따라 문제 발생 가능
                  │  ESP-in-UDP(4500)  ○         │         ← **NAT-T**: ESP를 UDP/4500으로 캡슐화
                  └─────────────────────────────────────────────────────────────────────────────

IKEv2: UDP/500 (초기 교환) → NAT 검출 시 UDP/4500 전환 → **ESP-in-UDP(4500)** 로 데이터 보호
```

### 프로토콜 번호/포트, 운영 메모

```
- AH  : IP 프로토콜 번호 51 (무결성/인증, NAT 비호환 경향)
- ESP : IP 프로토콜 번호 50 (암호화+무결성/인증)
- IKEv2 : UDP/500 (초기), NAT-T 시 UDP/4500 사용
- NAT-T : ESP를 UDP/4500으로 캡슐화(ESP-in-UDP) → NAT 경유 호환성 확보
```

---

## 암호·무결성·재전송 방지

### 암호군(ESP)

- **AES-GCM**(권장): 암호화+무결성 **AEAD**
- **AES-CBC + HMAC-SHA2**: 레거시/호환(가능하면 GCM 전환)
- 키 길이: 128/192/256(운영 정책에 따름)

### PFS(Perfect Forward Secrecy)

- IKE 협상에서 **(EC)DH** 사용(예: ECP256, ECP384). 키 유출 시 과거 세션 보호

### Anti-Replay(재전송 방지)

- ESP에 **시퀀스 번호** + 수신 측 **슬라이딩 윈도우**
- 윈도우 크기를 $W$라 할 때, 공격자가 과거 패킷 재전송 성공 확률은 **윈도우 밖**이면 사실상 0
  $$ P(\text{replay accept}) \approx 0 \quad (\text{적절한 } W \text{에서}) $$

---

## IKEv2 — 키 교환·인증·재키잉

### 절차 요약

1) **IKE\_SA\_INIT**: 암호군·DH 교환(쿠키로 DDoS 저항)
2) **IKE\_AUTH**: 상호 인증(인증서/PSK/EAP), 첫 **CHILD\_SA** 생성(데이터용)
3) **재키잉(Rekey)**: 수명(예: IKE SA 8h, CHILD SA 1h) 만료 전 교체
4) **DPD(Dead Peer Detection)**: 상대 생존 확인
5) **MOBIKE**: 클라이언트 IP 변경에도 SA 유지(모바일 환경)

### 인증 방식

- **인증서(EAP-TLS 포함)**: 대규모·엔터프라이즈 권장
- **PSK**: 소규모/장비 간 간편(반드시 **고엔트로피**)

---

## 네트워크 구성도

### 게이트웨이 간(사이트-투-사이트) 흐름 개요

```
                 [Site A]                                        [Site B]
   내부망           │                                                │         내부망
[Subnet A]───┐     │                                                │      ┌──[Subnet B]
             │     │                         IKEv2 (UDP 500/4500)   │      │
             │  [IPsec GW A]=======================================[IPsec GW B]───┐
             │     │                        ESP/AH (50/51 or ESP-in-UDP/4500)     │
[Host A]─────┘     │                                                │      └──[Host B]
                   │<—————— Clear(내부) ————>||<——— 보호구간 ——>||<— Clear(내부) —>│
```

### 호스트-투-게이트웨이(원격접속 VPN) 개요

```
[Remote Host]──Internet──[GW / VPN Concentrator]
     │                           │
     ├─ IKEv2(INIT/AUTH) ───────>│
     │<──────── CHILD_SA ────────┤
     │==== ESP(or ESP-in-UDP) ===>│   ← 이후 데이터 트래픽 보호
```

### "정책→SA→트래픽" 연결 개념도

```
[Security Policy(DB)]  →  [IKEv2 협상]  →  [IPsec SA(양방향)]  →  [AH/ESP 적용 트래픽]
  - 대상/예외/모드         - 암호스위트      - SPI/수명/키/재키       - 캡슐화(전송/터널), NAT-T
```

---

## NAT-T, 포트, MTU/오버헤드

### NAT Traversal

- 기본 IKE: **UDP/500**, NAT-T: **UDP/4500**로 ESP를 캡슐화

### 오버헤드·MTU 직관

- 링크 MTU를 $M$, 오버헤드를 $O$라 할 때, **유효 페이로드** 최대치:
  $$ \text{Payload}_{\max} = M - O $$
- 대략(IPv4, NAT-T, ESP-AES-GCM):
  - 외부 IP(20) + UDP(8) + ESP 헤더·IV·태그 등(약 34~52) ⇒ **총 62~80B** 오버헤드
  - **MSS 클램핑**으로 TCP 단절 방지(예: 1360~1380 근처부터 탐색)

---

## 설계 패턴 — Policy vs Route 기반, 원격/사이트/클라우드

### Policy-based

- 선택자 기준으로 자동 보호
- **장점**: 세밀한 트래픽 단위 보호. **단점**: 스케일·운영 난이도↑

### Route-based(VTI/VTUN)

- 가상 터널 인터페이스 생성 → 라우팅/ACL 적용
- **장점**: 단순/일반 라우팅과 잘 맞음(멀티 프리픽스, 동적 라우팅)
- **실무 기본값**: **Route-based** 선호

### 사용 시나리오

- **사이트간**: 본사↔지사, VPC↔온프레(클라우드 게이트웨이)
- **원격접속**: IKEv2(EAP-TLS) 클라이언트, RADIUS/IdP·MFA 연동
- **하이브리드**: 다중 회선/모바일 → **MOBIKE**

---

## 실전 예제 1 — strongSwan(IKEv2, Tunnel, AES-GCM)

### 토폴로지

```
[Site-A] 10.10.0.0/16 ──[GW-A: 공인 203.0.113.1]====(IPsec/IKEv2)====[GW-B: 공인 198.51.100.2]── 10.20.0.0/16 [Site-B]
```

### /etc/ipsec.conf

```conf
config setup
  charondebug="ike 1, knl 1, cfg 1"
  uniqueids=never

conn s2s
  auto=start
  keyexchange=ikev2
  type=tunnel

  left=%any
  leftid=203.0.113.1
  leftcert=/etc/ipsec.d/certs/gwA.crt
  leftsubnet=10.10.0.0/16

  right=198.51.100.2
  rightid=198.51.100.2
  rightsubnet=10.20.0.0/16
  rightauth=pubkey

  # 암호/그룹 (AEAD + PFS)
  ike=aes256gcm16-prfsha384-ecp256!
  esp=aes256gcm16-ecp256!

  dpdaction=restart
  dpddelay=15s

  ikelifetime=8h
  lifetime=1h
  rekeymargin=3m
  rekeyfuzz=30%

  fragmentation=yes
  mobike=yes
```

### /etc/ipsec.secrets

```conf
: RSA /etc/ipsec.d/private/gwA.key
```

### 방화벽·포트

```bash
# UDP 500(IKE), 4500(NAT-T), ESP 허용

iptables -A INPUT -p udp --dport 500 -j ACCEPT
iptables -A INPUT -p udp --dport 4500 -j ACCEPT
iptables -A INPUT -p esp -j ACCEPT
```

### 확인

```bash
ipsec statusall
# 또는 swanctl

swanctl --list-sas
tcpdump -ni any udp port 500 or udp port 4500 or proto 50
ip xfrm state
ip xfrm policy
```

---

## 실전 예제 2 — Linux XFRM 수동 구성(교육용, 정책 기반)

> 일반 운영은 IKEv2 데몬(예: strongSwan)을 권장. 아래는 **핵심 원리 확인용**

### 키/SA/정책 설정(예시)

```bash
# SPI/키는 예시(실무는 IKE가 협상)

LOCAL=203.0.113.1
REMOTE=198.51.100.2
LNET=10.10.0.0/16
RNET=10.20.0.0/16

# 송신 SA(로컬→원격)

ip xfrm state add src $LOCAL dst $REMOTE proto esp spi 0x100 \
  mode tunnel \
  aead 'rfc4106(gcm(aes))' 0x00112233445566778899aabbccddeeff00112233 128 \
  sel src $LNET dst $RNET

# 수신 SA(원격→로컬)

ip xfrm state add src $REMOTE dst $LOCAL proto esp spi 0x200 \
  mode tunnel \
  aead 'rfc4106(gcm(aes))' 0xffeeddccbbaa9988776655443322110000112233 128 \
  sel src $RNET dst $LNET

# 정책(로컬→원격 보호)

ip xfrm policy add src $LNET dst $RNET dir out tmpl \
  src $LOCAL dst $REMOTE proto esp mode tunnel
# 정책(원격→로컬 보호)

ip xfrm policy add src $RNET dst $LNET dir in tmpl \
  src $REMOTE dst $LOCAL proto esp mode tunnel
```

### 확인/삭제

```bash
ip xfrm state
ip xfrm policy
ip xfrm state deleteall
ip xfrm policy flush
```

---

## 실전 예제 3 — Cisco IOS(IKEv2 + ESP-GCM, Route-based)

```cisco
crypto ikev2 proposal PROP1
 encryption aes-gcm-256
 prf sha384
 group 19

crypto ikev2 policy POL1
 proposal PROP1

crypto ikev2 keyring KR1
 peer PEER1
  address 198.51.100.2
  pre-shared-key local <LONG_RANDOM>
  pre-shared-key remote <LONG_RANDOM>

crypto ikev2 profile PROF1
 match identity remote address 198.51.100.2 255.255.255.255
 authentication remote pre-share
 authentication local pre-share
 keyring local KR1
 dpd 10 3 on-demand

crypto ipsec transform-set TS1 esp-gcm 256
 mode tunnel

crypto ipsec profile IPSEC1
 set transform-set TS1
 set ikev2-profile PROF1

interface Tunnel10
 ip address 10.255.0.1 255.255.255.252
 tunnel source GigabitEthernet0/0
 tunnel destination 198.51.100.2
 tunnel protection ipsec profile IPSEC1
!
router bgp 65001
 neighbor 10.255.0.2 remote-as 65002
```

> **VTI(Route-based)**로 라우팅/BGP까지 연계가 수월하다

---

## 실전 예제 4 — Windows IKEv2(원격접속 프로파일)

```powershell
$Server = "vpn.corp.example"
Add-VpnConnection -Name "CORP-IKEv2" -ServerAddress $Server `
  -TunnelType IKEv2 -AuthenticationMethod Eap -EncryptionLevel Required `
  -SplitTunneling -AllUserConnection -Force

# 내부 도메인만 터널로

Add-VpnConnectionRoute -ConnectionName "CORP-IKEv2" -DestinationPrefix "10.10.0.0/16"

# 인증서(EAP-TLS)는 GPO/MDM로 배포, 또는 수동으로 사용자/장치 인증서 설치

```

---

## 운영·모니터링 — 로그·플로우·패킷

### 로그 포인트(예시)

- **SA 수립/재키잉/만료**, **DPD 이벤트**, **MOBIKE 업데이트**
- **NO\_PROPOSAL\_CHOSEN**(암호군 불일치), **AUTHENTICATION\_FAILED**(인증 실패), **TS 불일치**(선택자 충돌)

### 패킷 캡처

```bash
tcpdump -ni any udp port 500 or udp port 4500 or proto 50
```

### 지표

- 동시 **CHILD SA 수**, **성공률**, **재키잉 주기**, **ESP 드롭(anti-replay)**, **CPU(암호화)**, **MTU 재전송** 등

---

## 보안 베스트 프랙티스

**암호/키교환**
- **IKEv2 Only**, **ESP-AES-GCM** 우선, **PFS(ECDHE)** 사용
- 허약 스위트/그룹(3DES, SHA1, MODP1024 등) 비활성

**인증**
- **인증서(EAP-TLS)** 선호, PSK는 **고엔트로피**(길이≥32, 랜덤)
- CA 수명주기/CRL/OCSP, 만료 모니터링

**네트워크**
- **NAT-T(UDP/4500)** 허용, 방화벽/ACL 명시
- **Route-based**로 단순화, 동적 라우팅 연계(BGP/OSPF)

**운영**
- **SA 수명** 짧게(예: IKE 8h/Child 1h), 재키잉 안정화
- **MSS 클램핑/PMTUD** 조정, **DPD** 적극 사용
- 중앙 **로그/SIEM** 연동, 경보 템플릿(인증 실패/프로포절 불일치)

---

## 문제해결(트러블슈팅) 시나리오

### NO_PROPOSAL_CHOSEN

- 현상: IKE 협상 실패
- 조치: 양단 **ike/esp** 암호군 완전 일치 확인(순서·느낌표 강제 `!`), DH 그룹 정합

### AUTHENTICATION_FAILED

- 인증서 CN/ID 불일치, 시간 오차, CA 미신뢰, PSK 오타
- 해결: NTP 동기화, `leftid/rightid` 재검, CA 체인/신뢰 저장소 점검

### 트래픽 일부만 통과

- 선택자/라우트 미스매치(Policy 기반), VTI 라우팅 누락(Route 기반)
- 해결: `ip xfrm policy`/`ip route` 점검(서브넷/대역목록 일치)

### 느림/세션 끊김

- MTU/PMTUD 문제 → **MSS Clamp** 적용, 오버헤드 재산정
- CPU 병목(암호화) → AES-NI/ARMv8-Crypto 확인, 스레드/코어 확장

### NAT 환경 연결 불안

- NAT-T 미허용/ALG 간섭 → 방화벽 정책 명시, IKE 프래그먼테이션 허용(`fragmentation=yes`)

---

## 점검 스크립트(교육용 스니펫)

```bash
#!/usr/bin/env bash
# ipsec_audit.sh — strongSwan/리눅스 핵심 상태 요약

echo "== SA Status =="
swanctl --list-sas 2>/dev/null || ipsec statusall

echo "== XFRM State/Policy =="
ip xfrm state
ip xfrm policy

echo "== UDP/ESP Port Open =="
ss -lunpt | egrep ':(500|4500)\s'
iptables -S | egrep 'udp.*(500|4500)|\sESP\s'
```

---

## 체크리스트

**설계**
- [ ] **IKEv2 + ESP-AES-GCM + PFS**
- [ ] **Route-based(VTI)** 우선, 필요한 경우만 Policy 기반
- [ ] **분리된 선택자/라우팅**(서브넷·포트 명시)

**배포**
- [ ] 방화벽 **UDP 500/4500/ESP** 허용
- [ ] **NAT-T** 적용, 모바일은 **MOBIKE**
- [ ] **SA 수명**(IKE 8h/Child 1h)·재키잉 여유 마진

**운영**
- [ ] **로그 중앙화**(성공/실패/재키잉/DPD)
- [ ] **MTU/MSS** 표준값과 예외 관리
- [ ] 암호군/인증서 **정기 검토**(취약 스위트 제거)

---

## 부록 — 템플릿 모음

### strongSwan(원격접속, EAP-TLS)

```conf
conn ikev2-eap-tls
  keyexchange=ikev2
  auto=add
  left=%any
  leftid=vpn.corp.example
  leftauth=pubkey
  leftcert=/etc/ipsec.d/certs/gw.crt
  right=%any
  rightauth=eap-tls
  eap_identity=%identity
  ike=aes256gcm16-prfsha384-ecp256!
  esp=aes256gcm16-ecp256!
  mobike=yes
  fragmentation=yes
```

### Nftables로 IKE/ESP 허용

```bash
nft add table inet filter
nft add chain inet filter input { type filter hook input priority 0; policy drop; }
nft add rule inet filter input ct state established,related accept
nft add rule inet filter input udp dport {500,4500} accept
nft add rule inet filter input meta l4proto esp accept
nft add rule inet filter input iif "lo" accept
```

### 한 장 요약 (선/박스 스타일)

```
AH(무결성/인증, 51)           ESP(기밀성+무결성/인증, 50)
───────────────              ──────────────────────────────
전송: [IP][AH][L4][Data]      전송: [IP][ESP][L4+Data+trailer][auth]
터널: [NewIP][AH][InnerIP..]  터널: [NewIP][ESP][InnerIP..+trailer][auth]
NAT:  취약/비호환 많음         NAT-T(UDP/4500)로 호환성 ↑
용도: 헤더 무결성 확실         용도: 일반적(데이터 암호화 중심)
```

---

## 요약

- **ESP + IKEv2**가 IPsec의 사실상 표준 조합. **AES-GCM + PFS**로 단순·안전하게
- **Route-based(VTI)**는 운영 단순화·동적 라우팅 통합에 유리
- **NAT-T/MTU/MSS**·**재키잉/DPD**·**로그/가시성**이 **실전 품질/안정성**을 좌우한다
- 인증서는 **EAP-TLS/서버 인증서**로 표준화, PSK는 **충분한 엔트로피**를 확보한다

> 위 내용을 바탕으로, "VPN 개요" 편에서 다룬 IKEv2/SSL/WireGuard와 연계하면 **원격접속·사이트간·클라우드 경계**까지 하나의 운영 기준서로 통합할 수 있다
