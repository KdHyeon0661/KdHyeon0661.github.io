---
layout: post
title: C++ - ìŠ¤ë§ˆíŠ¸ í¬ì¸í„° êµ¬í˜„ (3)
date: 2024-09-25 19:20:23 +0900
category: Cpp
---
# ğŸš€ make_shared ìµœì í™” ì›ë¦¬ì™€ êµ¬í˜„

`std::make_shared<T>(...)`ëŠ” ë‹¨ìˆœí•œ `shared_ptr<T>(new T(...))`ë³´ë‹¤  
**ë©”ëª¨ë¦¬ í• ë‹¹ì´ ì ê³ **, **ì˜ˆì™¸ ì•ˆì „ì„±ë„ ë›°ì–´ë‚˜ë©°**,  
**ìºì‹œ ì¹œí™”ì ì¸ ì„±ëŠ¥**ì„ ì œê³µí•©ë‹ˆë‹¤.

ì´ë²ˆ ê¸€ì—ì„œëŠ” `make_shared`ê°€ **ì™œ íš¨ìœ¨ì ì¸ì§€**,  
ê·¸ë¦¬ê³  ê·¸ê²ƒì„ **ì§ì ‘ êµ¬í˜„í•˜ëŠ” ë°©ë²•**ì„ ì‚´í´ë´…ë‹ˆë‹¤.

---

## âœ… 1. ì¼ë°˜ `shared_ptr` ìƒì„± ë°©ì‹

```cpp
auto ptr = std::shared_ptr<MyClass>(new MyClass(...));
```

- ğŸ”¸ ë©”ëª¨ë¦¬ 2ë²ˆ í• ë‹¹
  - 1. `MyClass` ê°ì²´
  - 2. ì°¸ì¡° ì¹´ìš´íŠ¸ë¥¼ ìœ„í•œ ControlBlock
- ğŸ”¸ ì˜ˆì™¸ ë°œìƒ ì‹œ ê°ì²´ë§Œ ìƒì„±ë˜ê³  `shared_ptr`ë¡œ ë¬¶ì§€ ëª»í•˜ë©´ â†’ **ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê°€ëŠ¥**

---

## âœ… 2. `make_shared` ë°©ì‹

```cpp
auto ptr = std::make_shared<MyClass>(...);
```

- ğŸ”¹ ë©”ëª¨ë¦¬ 1ë²ˆ í• ë‹¹
  - ê°ì²´ + ControlBlockì„ **í•˜ë‚˜ì˜ ë¸”ë¡**ì— í• ë‹¹
- ğŸ”¹ ì˜ˆì™¸ ë°œìƒ ì‹œ ìë™ ì •ë¦¬ â†’ **ì•ˆì „ì„± í–¥ìƒ**
- ğŸ”¹ ìºì‹œ ì¹œí™”ì  â†’ ì„±ëŠ¥ ê°œì„ 

---

## ğŸ§ª 3. ì§ì ‘ êµ¬í˜„í•´ë³´ê¸°: `MyMakeShared`

### ğŸ“¦ ìµœì í™”ëœ êµ¬ì¡°

```cpp
template <typename T>
class MySharedPtr {
private:
    struct ControlBlock {
        int ref_count = 1;
        int weak_count = 0;

        T* getObject() { return reinterpret_cast<T*>(this + 1); }

        void destroy() {
            getObject()->~T();
        }
    };

    T* ptr;
    ControlBlock* ctrl;

public:
    // ë‚´ë¶€ ì „ìš© ìƒì„±ì
    MySharedPtr(ControlBlock* c) : ctrl(c), ptr(c->getObject()) {}

    ~MySharedPtr() {
        release();
    }

    void release() {
        if (!ctrl) return;
        if (--ctrl->ref_count == 0) {
            ctrl->destroy();
            if (ctrl->weak_count == 0) {
                operator delete(ctrl);
            }
        }
    }

    int use_count() const {
        return ctrl ? ctrl->ref_count : 0;
    }

    T* operator->() const { return ptr; }
    T& operator*() const { return *ptr; }

    template <typename... Args>
    friend MySharedPtr<T> MyMakeShared(Args&&... args);
};
```

---

## ğŸ— 4. `MyMakeShared` í•¨ìˆ˜ êµ¬í˜„

```cpp
template <typename T, typename... Args>
MySharedPtr<T> MyMakeShared(Args&&... args) {
    using CB = typename MySharedPtr<T>::ControlBlock;

    // í•˜ë‚˜ì˜ ë©”ëª¨ë¦¬ ë¸”ë¡ì— ControlBlock + T í• ë‹¹
    void* raw = operator new(sizeof(CB) + sizeof(T));

    CB* cb = new (raw) CB();                         // placement new: ControlBlock ìƒì„±
    T* obj = new (cb + 1) T(std::forward<Args>(args)...);  // placement new: T ê°ì²´ ìƒì„±

    return MySharedPtr<T>(cb);
}
```

### ğŸ’¡ í•µì‹¬ ê°œë…: placement new

```cpp
void* mem = operator new(sizeof(T));
T* obj = new (mem) T(...);  // ë©”ëª¨ë¦¬ ìœ„ì¹˜ì— ê°ì²´ë¥¼ ì§ì ‘ ìƒì„±
```

- ë©”ëª¨ë¦¬ í• ë‹¹ê³¼ ê°ì²´ ìƒì„±(ìƒì„±ì í˜¸ì¶œ)ì„ ë¶„ë¦¬
- `delete` ëŒ€ì‹  `obj->~T()`ë¡œ ìˆ˜ë™ íŒŒê´´ í•„ìš”

---

## âœ… ì‚¬ìš© ì˜ˆì‹œ

```cpp
auto p = MyMakeShared<std::string>("Hello make_shared");

std::cout << *p << "\n";  // Hello make_shared
std::cout << "use_count: " << p.use_count() << "\n";  // 1
```

---

## ğŸ“Œ ìš”ì•½

| í•­ëª©                   | ì¼ë°˜ new + shared_ptr | make_shared                |
|------------------------|------------------------|----------------------------|
| ë©”ëª¨ë¦¬ í• ë‹¹ íšŸìˆ˜       | 2íšŒ (ê°ì²´ + ControlBlock) | 1íšŒ (í†µí•© ë¸”ë¡)            |
| ì˜ˆì™¸ ì•ˆì „ì„±            | ë‚®ìŒ (ì¤‘ê°„ ì‹¤íŒ¨ ì‹œ ëˆ„ìˆ˜) | ë†’ìŒ (ì›ìì  ìƒì„±)         |
| ìºì‹œ ì„±ëŠ¥              | ë³´í†µ                    | ìš°ìˆ˜ (ì—°ì† ë©”ëª¨ë¦¬)         |
| êµ¬í˜„ ë³µì¡ë„            | ê°„ë‹¨                    | ë³µì¡ (placement new ë“± í•„ìš”) |

---

## ğŸ§  ë§ˆë¬´ë¦¬

- `make_shared`ëŠ” ë‹¨ìˆœ ìµœì í™”ê°€ ì•„ë‹ˆë¼, **ë©”ëª¨ë¦¬ ì•ˆì „ì„±ê³¼ ì„±ëŠ¥ì„ ë™ì‹œì— ì¡ì€ ê³ ê¸‰ ê¸°ëŠ¥**ì…ë‹ˆë‹¤.
- ì§ì ‘ êµ¬í˜„ì„ í†µí•´ placement new, ì—°ì† ë©”ëª¨ë¦¬ í• ë‹¹ ë“± **low-level ìµœì í™” ê¸°ë²•**ì„ ì²´í—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
