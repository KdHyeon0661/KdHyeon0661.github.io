---
layout: post
title: Linux - 마운트
date: 2024-11-09 19:20:23 +0900
category: Linux
---
# 마운트

## 리눅스 파일 시스템 구조 개요

리눅스는 단일 루트 `/`를 기준으로 모든 장치와 파일시스템이 계층적으로 연결되는 구조를 가지고 있습니다. 외장 디스크, 파티션, 네트워크 공유 등은 **마운트 지점**이라는 디렉터리에 연결하여 시스템에 통합됩니다.

### 주요 디렉터리 의미

| 디렉터리 | 설명 |
|---|---|
| `/` | 최상위 루트 디렉터리 |
| `/home` | 사용자 홈 디렉터리 |
| `/etc` | 시스템 설정 파일 |
| `/var` | 로그 및 가변 데이터 |
| `/usr` | 프로그램과 라이브러리 |
| `/bin`, `/sbin` | 필수 실행 파일 |
| `/mnt`, `/media` | 임시/자동 마운트 지점 |
| `/dev` | 디바이스 파일 (예: `/dev/sda1`) |

---

## 용량/인노드 확인: df/du

```bash
df -hT               # -h: 사람이 읽기 쉬운 단위, -T: 파일시스템 타입
df -hi               # inode 사용량 확인
du -sh *             # 현재 디렉터리 항목별 용량 요약
sudo du -xhd1 /var   # 동일 파일시스템(-x), 깊이 1단계, -h 옵션
```

### 예시 출력 해석

```bash
Filesystem      Type  Size  Used Avail Use% Mounted on
/dev/sda1       ext4   50G   20G   27G  43% /
tmpfs           tmpfs 2.0G     0  2.0G   0% /dev/shm
```
- `Type`: 파일시스템 종류(ext4, xfs, tmpfs 등)
- `Use%`가 100%면 쓰기 실패 발생; `df -i`로 inode 고갈 여부도 확인 필요

---

## 디스크·파티션·UUID 조회

```bash
lsblk -f                            # 파일시스템/라벨/UUID/마운트 정보 한눈에 확인
sudo blkid                          # 상세 식별자(UUID, PARTUUID) 확인
sudo fdisk -l                       # MBR/GPT, 섹터/파티션 테이블 개요
lsblk -o NAME,SIZE,FSTYPE,UUID,MOUNTPOINT,PARTUUID
```

- **UUID**: 파일시스템 고유 식별자(변경 가능성 낮음) — fstab에서 권장하는 방식
- **PARTUUID**: 파티션 엔트리 식별자(GPT에서 특히 유용)
- **LABEL**: 사람이 읽기 쉬운 이름(충돌 위험 있으니 주의 필요)

---

## 파일시스템 생성·점검·튜닝(기초)

```bash
# 파일시스템 생성
sudo mkfs.ext4 /dev/sdb1
sudo mkfs.xfs  /dev/sdb2
sudo mkfs.vfat -F32 /dev/sdc1      # FAT32 (대소문자/권한 제한 있음)

# 라벨/튜닝(ext4)
sudo e2label /dev/sdb1 DATA
sudo tune2fs -m 1 /dev/sdb1        # 예약블록 1% 설정
sudo tune2fs -c 0 -i 0 /dev/sdb1   # 자동 fsck 주기 비활성화(서버 정책에 따라)

# 점검(마운트 해제 후)
sudo fsck -f /dev/sdb1
```

> XFS는 `xfs_repair`, Btrfs/ZFS는 자체 도구 사용. **마운트된 파일시스템에 fsck 실행 금지**(예외적으로 루트는 재부팅 시 실행)

---

## mount/umount 기본과 옵션

```bash
sudo mount /dev/sdb1 /mnt/data
sudo mount -t ext4 -o rw,noexec,nosuid,nodev /dev/sdb1 /mnt/data
sudo umount /mnt/data
```

### 자주 사용하는 마운트 옵션

| 옵션 | 의미/보안 효과 |
|---|---|
| `ro` | 읽기 전용 |
| `rw` | 읽기-쓰기 |
| `noexec` | 이 파일시스템에서 바이너리 실행 금지(스크립트 인터프리터로는 실행 가능) |
| `nosuid` | setuid/setgid 비트 무시(권한 상승 방지) |
| `nodev` | 장치 파일 무시(보안 강화) |
| `relatime` | 접근시간 갱신 최적화(기본값) |
| `discard` | 즉시 TRIM(SSD용; 성능/수명 고려 필요) |
| `noatime` | atime 갱신 안 함(성능 향상, 일부 앱 주의) |
| `uid=,gid=` | vfat/ntfs 같은 권한 없는 파일시스템에 소유자 지정 |
| `x-systemd.device-timeout=` | systemd 마운트 타임아웃 조정 |

### 마운트가 해제되지 않을 때

```bash
lsof +f -- /mnt/usb           # 열려있는 핸들 확인
fuser -vm /mnt/usb            # 어떤 프로세스가 점유 중인지 확인
sudo umount -l /mnt/usb       # lazy(경로 분리, 핸들 종료 시 해제)
sudo umount -f /mnt/usb       # 강제(네트워크 오류 등, 신중하게 사용)
```

---

## /etc/fstab — 부팅 시 자동 마운트

```fstab
# <장치/식별자>   <마운트점>  <타입>  <옵션>                       <dump> <fsck>

UUID=1111-2222     /mnt/data   ext4    defaults,noexec,nosuid,nodev  0      2
PARTUUID=abcd-01   /boot/efi   vfat    umask=0077                     0      1
LABEL=SHARE        /srv/share  xfs     rw,attr2,inode64               0      2
```
- **dump**: 백업 도구 사용 여부(대개 0)
- **fsck**: 검사 순서(루트=1, 다른 로컬 파일시스템=2, 네트워크=0)

### UUID 찾기

```bash
sudo blkid /dev/sdb1
```

### fstab 검증/일시 마운트 테스트

```bash
sudo mount -a                 # fstab에 정의된 것 한 번에 마운트(검증용)
systemd-analyze blame         # 부팅 지연 원인에 마운트가 있는지 확인
```

---

## systemd-mount / .mount / .automount

**일회성 마운트**
```bash
systemd-mount --automount=yes --collect /dev/sdb1 /mnt/data
```

**영구 유닛 파일(추천: drop-in)**
- 마운트 유닛: `/etc/systemd/system/mnt-data.mount`
  (경로 `/mnt/data` → 유닛명 `mnt-data.mount`)
```ini
[Unit]
Description=Data mount

[Mount]
What=/dev/disk/by-uuid/1111-2222
Where=/mnt/data
Type=ext4
Options=rw,noexec,nosuid,nodev

[Install]
WantedBy=multi-user.target
```
```bash
sudo systemctl daemon-reload
sudo systemctl enable --now mnt-data.mount
```

**자동 마운트(접근 시 attach)**
- `/etc/systemd/system/mnt-nfs.automount`
```ini
[Unit]
Description=AutoMount NFS

[Automount]
Where=/mnt/nfs

[Install]
WantedBy=multi-user.target
```
- `/etc/systemd/system/mnt-nfs.mount`
```ini
[Unit]
Description=NFS mount

[Mount]
What=10.0.0.10:/exports/project
Where=/mnt/nfs
Type=nfs
Options=defaults,_netdev,timeo=600,retrans=2

[Install]
WantedBy=multi-user.target
```
```bash
sudo systemctl daemon-reload
sudo systemctl enable --now mnt-nfs.automount
```

---

## 바인드 마운트(bind)와 읽기 전용 슬라이스

```bash
sudo mount --bind /var/log/app /srv/app/logs
sudo mount -o bind,ro /var/www/static /srv/static
# 중첩 옵션 변경(remount)
sudo mount -o remount,bind,ro /srv/static
```
- chroot/컨테이너/서비스 격리에서 유용하게 사용됩니다.

---

## loop 디바이스: 이미지 파일 마운트

```bash
sudo losetup -fP disk.img                   # 빈 loop 자동 할당 + 파티션 스캔
losetup -a                                  # 매핑 확인
sudo mount /dev/loop0p1 /mnt/img
# 해제
sudo umount /mnt/img
sudo losetup -d /dev/loop0
```
**간단한 방법:**
```bash
sudo mount -o loop disk.iso /mnt/iso
```

---

## overlayfs: 읽기 전용 + 쓰기 레이어(컨테이너/빌드 캐시)

```bash
sudo mkdir -p lower upper work merged
sudo mount -t overlay overlay -o lowerdir=lower,upperdir=upper,workdir=work merged
# merged에 쓰기가 upper로 기록됨
```

---

## tmpfs/ramfs — 메모리에 마운트

```bash
sudo mount -t tmpfs -o size=2G tmpfs /mnt/ram
# fstab
tmpfs /mnt/ram tmpfs defaults,size=2G,mode=1777 0 0
```
- `tmpfs`는 swap에 밀어낼 수 있음, `ramfs`는 제한이 없어 위험합니다.

---

## 네트워크 마운트: NFS/CIFS/SSHFS

### NFS

```bash
sudo apt install -y nfs-common    # 클라이언트 설치
sudo mount -t nfs 10.0.0.10:/exports/proj /mnt/proj -o vers=4.1,_netdev,noatime
```
- fstab: `_netdev`, `x-systemd.automount`, `x-systemd.idle-timeout=` 조합 권장

### CIFS(SMB)

```bash
sudo apt install -y cifs-utils
sudo mount -t cifs //win-srv/share /mnt/share -o username=USER,domain=DOM,vers=3.1.1,iocharset=utf8,uid=1000,gid=1000
```
**자격증명 파일**
```bash
sudo tee /etc/samba/cred.proj >/dev/null <<'CRED'
username=USER
password=SECRET
domain=DOM
CRED
sudo chmod 600 /etc/samba/cred.proj
```
```fstab
//win-srv/share /mnt/share cifs credentials=/etc/samba/cred.proj,vers=3.1.1,uid=1000,gid=1000,_netdev 0 0
```

### SSHFS(FUSE)

```bash
sudo apt install -y sshfs
sshfs user@host:/data /mnt/sshfs -o reconnect,ServerAliveInterval=15,ServerAliveCountMax=3
```

---

## SELinux/AppArmor와 마운트 보안

- **SELinux** 사용 시스템(RHEL/Fedora 등)에서 httpd가 읽을 디렉터리는 컨텍스트 조정 필요:
```bash
sudo chcon -R -t httpd_sys_content_t /srv/www
# 영구 설정: semanage fcontext -a -t httpd_sys_content_t '/srv/www(/.*)?' && restorecon -Rv /srv/www
```
- `noexec`, `nosuid`, `nodev`는 서비스 분리/격리 시 유효한 경계 설정
- CIFS/NFS에서 권한/소유자 맵핑(uid/gid, `noperm`)을 이해하고 적용

---

## LVM/RAID와 마운트

### LVM 개요

```bash
sudo pvcreate /dev/sdb
sudo vgcreate vgdata /dev/sdb
sudo lvcreate -L 100G -n lvdata vgdata
sudo mkfs.ext4 /dev/vgdata/lvdata
sudo mount /dev/vgdata/lvdata /mnt/data
```
**온라인 확장**
```bash
sudo lvextend -r -L +50G /dev/vgdata/lvdata   # -r: 파일시스템도 함께 리사이즈(ext4/xfs)
# xfs는 xfs_growfs 사용(마운트된 상태에서 가능)
```

### mdadm RAID(개요)

```bash
sudo mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/sdb1 /dev/sdc1
sudo mkfs.xfs /dev/md0
sudo mount /dev/md0 /mnt/raid
```
- `/etc/mdadm/mdadm.conf`에 배열 정의 저장 → initramfs 갱신 필요

---

## 암호화 볼륨(LUKS)과 마운트

```bash
# 초기화(파괴적 작업)
sudo cryptsetup luksFormat /dev/sdb1
sudo cryptsetup open /dev/sdb1 secure_data
sudo mkfs.ext4 /dev/mapper/secure_data
sudo mount /dev/mapper/secure_data /mnt/secure

# 해제
sudo umount /mnt/secure
sudo cryptsetup close secure_data
```
**부팅 시 자동 오픈(패스프레이즈/키파일)**
- `/etc/crypttab`:
```
secure_data UUID=<UUID-of-sdb1> /root/keyfile luks
```
- `/etc/fstab`:
```
/dev/mapper/secure_data /mnt/secure ext4 defaults 0 2
```

---

## 온라인 확장/축소(파일시스템별 주의)

- **ext4**: 오프라인 축소 가능(마운트 해제 후 `resize2fs`), 온라인 확장 가능
- **xfs**: **축소 불가**, 온라인 확장만 가능(`xfs_growfs`)
- **btrfs**: 온라인 확장/축소/서브볼륨/RAID 유연하게 지원
- 파티션 크기 변경은 `parted`/`gdisk` 사용(백업 필수)

### 예시: ext4 확장

```bash
sudo growpart /dev/sda 3         # 3번째 파티션 확장(클라우드 이미지에서 흔함)
sudo resize2fs /dev/sda3
```

### 예시: xfs 확장

```bash
sudo xfs_growfs /mnt/data        # 마운트된 지점으로 실행
```

---

## 스왑/스왑 파일 마운트

```bash
sudo fallocate -l 8G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
# fstab
/swapfile none swap sw 0 0
```

### zram(메모리 압축 스왑)

```bash
# 고성능 시스템에서 활용 권장
```

---

## 컨테이너/네임스페이스와 마운트

- **mount 네임스페이스**를 통해 프로세스 그룹마다 별도 파일시스템 뷰 제공
- Docker/Podman/K8s는 **bind/overlay**를 광범위하게 활용
- 호스트 보안: 컨테이너에 마운트할 경로는 `nodev,nosuid,noexec`로 제한

---

## 고급 트러블슈팅 시나리오

### 루트 파티션이 가득 차서 부팅 불가

1) 복구 모드/라이브 ISO 부팅 → 루트 마운트
```bash
sudo mount /dev/sda1 /mnt/root
sudo mount -t proc /proc /mnt/root/proc
sudo mount -t sysfs /sys /mnt/root/sys
sudo mount -o bind /dev /mnt/root/dev
sudo chroot /mnt/root
# 불필요 로그/캐시 정리, 대용량 파일 검색
du -xhd1 / | sort -h
```

### 바쁜 디바이스로 umount 실패

```bash
lsof +f -- /mnt/data
fuser -vm /mnt/data
sudo systemctl stop <해당 서비스>
sudo umount -l /mnt/data
```

### fstab 오타로 부팅 지연

- 부팅 중 드롭으로 들어가서 `systemctl default` 이전에 `mount -a`로 테스트
- 문제 엔트리에 `nofail`, `x-systemd.device-timeout=10s` 등 사용

---

## 실전 예제 모음

### 예제 1: USB 드라이브 안전 마운트

```bash
sudo mkdir -p /mnt/usb
lsblk -f                        # 새로 붙은 UUID 확인
sudo mount -o rw,noexec,nosuid,nodev,uid=1000,gid=1000 /dev/sdb1 /mnt/usb
```

### 예제 2: 가장 큰 디렉터리 찾기(서버 디스크 꽉 참)

```bash
sudo du -xhd1 /var | sort -h
sudo du -xhd1 / | sort -h | tail -n 20
```

### 예제 3: fstab에 ext4 데이터 볼륨 등록

```fstab
UUID=123e4567-e89b-12d3-a456-426614174000 /mnt/data ext4 defaults,noatime 0 2
```
```bash
sudo mount -a
```

### 예제 4: systemd automount로 NFS 지연 마운트

- `.automount` + `.mount` 쌍 작성(상단 예시 참조), 접근 시 자동 연결

### 예제 5: overlayfs로 읽기 전용 베이스 + 쓰기 레이어

```bash
sudo mkdir -p /opt/base /opt/upper /opt/work /opt/merged
sudo mount -t overlay overlay -o lowerdir=/opt/base,upperdir=/opt/upper,workdir=/opt/work /opt/merged
```

### 예제 6: LUKS 암호 볼륨 생성/마운트

```bash
sudo cryptsetup luksFormat /dev/sdb1
sudo cryptsetup open /dev/sdb1 vault
sudo mkfs.ext4 /dev/mapper/vault
sudo mount /dev/mapper/vault /mnt/vault
```

---

## 명령어 요약

| 범주 | 명령/파일 |
|---|---|
| 조회 | `lsblk -f`, `blkid`, `fdisk -l`, `df -hT`, `du -xhd1` |
| 마운트 | `mount [-t type] [-o opts] dev dir`, `umount [-l|-f] dir` |
| fstab | `/etc/fstab`, `mount -a` |
| systemd | `.mount`, `.automount`, `systemd-mount`, `systemctl enable --now` |
| 파일시스템 조작 | `mkfs.ext4/xfs/vfat`, `fsck`, `tune2fs`, `xfs_repair` |
| 확장 | `growpart`, `resize2fs`, `xfs_growfs`, `lvextend -r` |
| 특수 마운트 | `mount --bind`, `mount -t overlay`, `mount -t tmpfs` |
| 네트워크 마운트 | `mount -t nfs`, `mount -t cifs`, `sshfs` |
| 암호화 | `cryptsetup luksFormat/open/close`, `/etc/crypttab` |
| loop 디바이스 | `losetup -fP`, `mount -o loop` |
| 점유 확인 | `lsof +f -- /path`, `fuser -vm /path` |

---

## 결론

리눅스의 마운트 시스템은 저장소 관리, 네트워크 공유, 서비스 격리, 보안 정책 등 다양한 요구사항을 통합적으로 해결하는 핵심 메커니즘입니다. 효과적인 마운트 관리를 위해서는 몇 가지 중요한 원칙을 기억해야 합니다.

먼저, 로컬 디스크의 경우 **UUID 기반의 fstab 설정**을 통해 디바이스명 변동에 대비하고, 적절한 마운트 옵션으로 시스템 안정성과 보안을 확보해야 합니다. 네트워크 파일시스템의 경우 **systemd automount**를 활용하여 지연 연결과 장애 내성을 구현할 수 있습니다.

운영 환경에서는 **LVM, RAID, 암호화** 기술과 결합하여 확장성, 보안성, 복원력을 갖춘 스토리지 인프라를 구축해야 합니다. 파일시스템별 특성(ext4의 축소 가능성, xfs의 축소 불가능성 등)을 이해하고 상황에 맞는 도구를 선택하는 것이 중요합니다.

이 문서의 예제들을 템플릿화하여 Ansible이나 Cloud-Init과 같은 자동화 도구와 결합하면, 어떤 환경에서도 일관된 스토리지 운영 기준을 빠르게 정착시킬 수 있습니다. 마운트 설정은 단순한 기술 작업을 넘어 시스템의 신뢰성과 보안을 결정하는 중요한 기반이 됩니다.