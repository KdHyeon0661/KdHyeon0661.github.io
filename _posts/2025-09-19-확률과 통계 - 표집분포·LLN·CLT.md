---
layout: post
title: 확률과 통계 - 표집분포·LLN·CLT
date: 2025-09-19 20:25:23 +0900
category: 확률과 통계
---
# 6) 표집분포·LLN·CLT

> **목표**  
> - **표본평균/표본분산의 분포**와 **t·χ²·F**가 왜 등장하는지 이해한다.  
> - **LLN(대수의 법칙)**, **CLT(중심극한정리)**의 직관과 적용 한계를 안다.  
> - **예시**: “일 단위 CTR의 표집분포”를 시뮬레이션 사고실험으로 추정하고, **집계 주기(일/주)**를 바꿀 때 근사 정확도가 어떻게 달라지는지 설계 관점에서 분석한다.

---

## 0) Hook — “평균은 어디로 수렴하며, 얼마나 빨리 정상처럼 보일까?”
- 전환확률이 $$p=0.03$$인 큰 서비스에서 **일별 CTR**을 추적한다. 표본 수가 많으면 “거의 항상 3% 근처”일까?  
- 어떤 날은 프로모션, 어떤 날은 휴일. **일 간 이질성**이 있으면 “샘플링 변동(이항)”만으로 설명되지 않는 **추가 변동**이 생긴다.  
- **LLN**은 장기적으로 평균이 진실에 가까워짐을 보장하지만, **CLT**가 주는 **정규근사**는 언제, 어떤 요건에서 **실제로** 잘 맞는가?  

---

## 1) 표본평균·표본분산의 표집분포: 출발점

### 1.1 표본평균의 표집분포
표본 $$X_1,\dots,X_n$$ 가 **i.i.d.** 이고 $$E[X_i]=\mu,\ \mathrm{Var}(X_i)=\sigma^2<\infty$$ 일 때  
$$
\bar X=\frac{1}{n}\sum_{i=1}^n X_i,\qquad E[\bar X]=\mu,\qquad \mathrm{Var}(\bar X)=\frac{\sigma^2}{n}.
$$
- 분포의 정확한 형태는 **원분포**에 달려 있다.  
- 단, 원분포가 정규라면 $$\bar X\sim \mathcal{N}(\mu,\sigma^2/n)$$ **정확**.

### 1.2 표본분산의 표집분포(정규 가정)
정규모집단 $$X_i\sim \mathcal{N}(\mu,\sigma^2)$$ 이면  
$$
S^2=\frac{1}{n-1}\sum_{i=1}^n (X_i-\bar X)^2,\qquad \frac{(n-1)S^2}{\sigma^2}\sim \chi^2_{n-1}.
$$
또한 $$\bar X$$와 $$S^2$$는 **독립**. 이 독립성 덕분에 t·F 분포가 등장한다(다음 절).

---

## 2) t·χ²·F: 어디서, 왜 등장하는가

### 2.1 t 분포의 등장 배경
**σ를 모를 때** 평균에 대한 표준화 통계량
$$
T=\frac{\bar X-\mu}{S/\sqrt{n}}
$$
은 정규모집단에서 $$T\sim t_{n-1}$$.  
- 분모에 **추정된 표준편차** $$S$$가 들어가서 **꼬리가 두꺼운** t 분포가 나온다.  
- 표본이 커지면 $$t_{n-1}\to \mathcal{N}(0,1)$$.

### 2.2 χ²와 F의 등장 배경
- **분산 추정**에서 $$\chi^2$$:  
  $$\frac{(n-1)S^2}{\sigma^2}\sim \chi^2_{n-1}.$$
- **두 분산 비**에서 **F**:  
  $$\frac{S_1^2/\sigma_1^2}{S_2^2/\sigma_2^2}=\frac{\chi^2_{\nu_1}/\nu_1}{\chi^2_{\nu_2}/\nu_2}\sim F_{\nu_1,\nu_2}.$$

> **실무 해석**  
> - 평균 비교(µ 차이)에서 **σ 미지**이면 t를 쓴다.  
> - 분산 비교, 회귀의 분산 성분 비교에서 **F**가 등장한다.  
> - 정규가정이 약할 때는 **부트스트랩/퍼뮤테이션**을 병행한다.

---

## 3) LLN(대수의 법칙) 직관 — “평균은 진실로”
**약한 LLN**: $$\bar X\xrightarrow{p}\mu$$.  
**강한 LLN**: $$\bar X\xrightarrow{a.s.}\mu$$.  
- 직관: **많이 평균하면 분산이 $$1/n$$**으로 줄고, 표본평균은 거의 확실히 모평균으로 “붙는다”.  
- 실무: **일별 CTR**의 일시적 요동도 **표본이 충분하면** 축소된다(단, “충분함”의 수준은 **분산**과 **자기상관**에 좌우).

---

## 4) CLT(중심극한정리) 직관 — “합/평균은 정규처럼”
**Lindeberg–Feller** 조건하에서  
$$
\frac{\sum_{i=1}^n (X_i-\mu)}{\sqrt{n\sigma^2}}\Rightarrow \mathcal{N}(0,1).
$$
- **원분포가 무엇이든**(분산 유한), 합/평균은 **정규에 근사**.  
- **Berry–Esseen** 류 경계: 수렴 속도는 **왜도/첨도**(제3절대모멘트)에 좌우 → **heavy-tail**이면 느리다.

> **주의**:  
> - 분산이 무한(예: 파레토 파라미터 작음)하면 CLT 요건이 깨질 수 있다.  
> - **강한 비대칭**/꼬리에서는 큰 n에서도 **정규근사 오차**가 눈에 띄게 남는다.

---

## 5) CTR(전환율) 표집분포 — 이항에서 정규로

### 5.1 한 날의 CTR
하루 노출수가 $$n_d$$, 각 노출의 전환 확률이 $$p$$(동일, 독립)일 때 전환 수 $$X_d\sim \mathrm{Bin}(n_d,p)$$,  
$$
\hat p_d=\frac{X_d}{n_d},\quad E[\hat p_d]=p,\quad \mathrm{Var}(\hat p_d)=\frac{p(1-p)}{n_d}.
$$
- $$n_d$$가 크고 $$p$$가 0이나 1에 치우치지 않으면
$$
\hat p_d \approx \mathcal{N}\!\left(p,\ \frac{p(1-p)}{n_d}\right).
$$

### 5.2 여러 날의 평균 CTR
기간 D일에 대해 **일별 CTR의 평균**  
$$
\bar p=\frac{1}{D}\sum_{d=1}^D \hat p_d.
$$
- 만약 모든 날 $$n_d=n$$, $$p$$ 동일, 일별 독립이면  
  $$
  E[\bar p]=p,\quad \mathrm{Var}(\bar p)=\frac{p(1-p)}{nD}.
  $$
- **노출수 가변**일 때 “**비율의 비율**”  
  $$
  \hat p_{\text{ratio}}=\frac{\sum_d X_d}{\sum_d n_d}
  $$
  가 **일관성**이 더 좋다. 분산은 델타법으로 근사(2편에서 다룸).

### 5.3 일 간 이질성(베타–이항 직관)
만약 날마다 **진짜 확률**이 $$p_d$$로 변동한다면 (예: 평일/주말, 캠페인)  
$$
E[\hat p_d]=E[p_d],\qquad \mathrm{Var}(\hat p_d)=E\!\left[\frac{p_d(1-p_d)}{n_d}\right]+\mathrm{Var}(p_d).
$$
- **두 항**: (i) 이항 샘플링 변동, (ii) **날짜 자체의 차이**.  
- 샘플만 늘려도 (i)는 줄지만, (ii)는 **안 줄어든다** → 집계 주기 선택의 핵심.

---

## 6) 사고실험: “일 단위 CTR의 표집분포”를 그려보자

### 6.1 시나리오 A — 균질한 날
- 파라미터: $$p=0.03,\ n_d=100{,}000$$ (매일 비슷), 일 간 독립.  
- 한 날의 표준오차(SE):  
  $$
  \mathrm{SE}(\hat p_d)=\sqrt{\frac{0.03\cdot 0.97}{100000}}\approx 0.000539\ (\text{약 }0.054\text{pp})
  $$
- 95% 근사구간: $$0.03\pm 1.96\times 0.000539 \approx [0.02894,\,0.03106]$$  
- **100일 평균**의 SE: $$0.000539/\sqrt{100}=0.0000539\ (\text{약 }0.0054\text{pp})$$  
  → **LLN/CLT** 효과가 **확실**.

### 6.2 시나리오 B — 이질한 날(평일/주말)  
- $$p_{\text{평일}}=0.029,\ p_{\text{주말}}=0.034$$, 비율 5:2, $$n_d=100{,}000$$.  
- 개별 날의 분산: 이항항 + **주간 패턴 분산**  
  $$
  \mathrm{Var}(\hat p_d)=\frac{E[p_d(1-p_d)]}{n_d}+\mathrm{Var}(p_d)
  $$
  여기서  
  $$
  E[p_d]=0.03,\quad \mathrm{Var}(p_d)=5/7\cdot(0.029-0.03)^2+2/7\cdot(0.034-0.03)^2.
  $$
- **핵심**: 이질성 항이 **상당하면**, CLT가 말하는 “정규처럼”은 **느리게** 나타난다.  
  - 일별 히스토그램은 **이봉성**(두 봉우리) 양상을 띌 수 있다.

### 6.3 시나리오 C — 노출수도 변동  
- $$n_d$$가 주말에 작고 평일에 크면, **분모 변동**이 추가 변동성을 만든다(비율의 비율 권장).  
- **설계 팁**: 주기 비교 시 **반드시**  
  1) 비율의 비율 사용(총합 기반),  
  2) 날짜 이질성을 모형에 포함(층화/랜덤효과),  
  3) 또는 **블록 부팅**(주간 블록)으로 CI를 얻는다.

---

## 7) 집계 주기(일 → 주) 변경이 근사 정확도에 주는 영향

### 7.1 순수 i.i.d. 가정에서의 수학
- **일별 평균**의 분산: $$\sigma^2/n_d$$  
- **주간 평균**(7일)의 분산: $$\sigma^2/(7n_d)$$  
  → 표준오차 **√7** 배 감소. **정규근사**도 더 잘 맞는다.

### 7.2 현실: 자기상관과 이질성
일별 CTR에 **자기상관**(예: 프로모션 3일 지속)이 있으면,  
$$
\mathrm{Var}\!\left(\bar X\right)\approx \frac{\sigma^2}{D}\Big(1+2\sum_{k=1}^{\infty}\rho_k\Big),
$$
여기서 $$\rho_k$$는 **시차 k 상관**.  
- **블록(주)** 평균을 쓰면, 블록 간 상관이 약해져 CLT가 **더 빨리** 맞는다.  
- 그러나 블록 내부 이질성(평일/주말)이 크면 **일 평균 → 주 평균**으로 가도 그 이질성 자체는 남는다.  
  - **대안**: 주간 평균 대신 “**캠페인 구간**”을 블록으로 잡아 상관을 줄인다.

### 7.3 주간 비율 계산의 두 방식
- (a) **일별 CTR의 단순 평균**  
  $$
  \bar p_{\text{단}}=\frac{1}{7}\sum_{d=1}^7 \hat p_d
  $$
  노출수 차이를 반영하지 못한다.  
- (b) **비율의 비율**  
  $$
  \hat p_{\text{주}}=\frac{\sum_{d=1}^7 X_d}{\sum_{d=1}^7 n_d}
  $$
  → **권장**. 분산은 델타법으로 근사. 노출수 큰 날의 정보가 더 반영되어 **SE ↓**.

---

## 8) 정규근사 정확도: 조건과 실전 규칙

### 8.1 이항→정규 근사 규칙
- **경험 법칙**: $$n p\gtrsim 5,\quad n(1-p)\gtrsim 5$$ (혹은 10)  
- **연속성 보정**을 적용하면 테일에서 오차↓.

### 8.2 비율의 Wald vs Wilson CI
- **Wald**: $$\hat p\pm z\sqrt{\hat p(1-\hat p)/n}$$ 는 **희귀/작은 n**에서 불안정.  
- **Wilson/Agresti–Coull** 권장(특히 일별 이벤트가 적을 때).  
- **주간**으로 합치면 분모가 커져 **Wilson·Wald 차이**가 작아진다.

### 8.3 heavy-tail, 비대칭, 0-인플레이션
- **체류시간/매출**같은 연속형 꼬리에서는 평균의 정규근사가 느리다 → **로그척도** 또는 **부트스트랩**.  
- **제로 인플레이션**이 강하면 이항 근사도 깨질 수 있다(희귀/군집 발생).

---

## 9) 설계: 집계 단위 선택(일 vs 주) 체크리스트
1) **의사결정 시간해상도**: 매일 바꿔야 하는지, 주간 시행인지?  
2) **노출수 규모**: 일별 $$n$$이 작으면 **주간** 합산으로 안정화.  
3) **날짜 이질성**: 상당하면 **층화·고정효과·랜덤효과**를 모델에 넣고 집계.  
4) **자기상관**: 장기 캠페인/프로모션이면 **블록 단위** 평균으로 CLT 가정 강화.  
5) **리포팅 지표**: “단순 평균”이 아니라 **비율의 비율**(총합 기반)으로.  
6) **CI 방식**: 작은 분자/분모는 **Wilson/부트스트랩**, 큰 집계는 **정규 근사** OK.

---

## 10) 수치 예제: 일 vs 주, 근사 정확도 비교

### 10.1 가정
- **평일/주말 이질성**: $$p_{\text{평일}}=0.029,\ p_{\text{주말}}=0.034$$  
- **노출수**: 평일 $$n=120{,}000$$, 주말 $$n=80{,}000$$.  
- 한 주 전환 수 합:  
  $$
  X_{\text{주}}=5\cdot \mathrm{Bin}(120k,0.029)+2\cdot \mathrm{Bin}(80k,0.034).
  $$
- **주간 비율의 비율**  
  $$
  \hat p_{\text{주}}=\frac{X_{\text{주}}}{5\cdot 120k+2\cdot 80k}=\frac{X_{\text{주}}}{760k}.
  $$

### 10.2 기대·분산 근사
- 기대 전환 수:  
  $$
  E[X_{\text{주}}]=5\cdot 120k\cdot 0.029+2\cdot 80k\cdot 0.034=17{,}400+5{,}440=22{,}840.
  $$
- 주간 CTR 기대: $$E[\hat p_{\text{주}}]\approx 22{,}840/760{,}000\approx 0.03005.$$
- 분산(독립 가정):  
  $$
  \mathrm{Var}(\hat p_{\text{주}})=\frac{\sum_d n_d p_d(1-p_d)}{(\sum_d n_d)^2}
  $$
  $$
  =\frac{5\cdot 120k\cdot 0.029\cdot 0.971+2\cdot 80k\cdot 0.034\cdot 0.966}{(760k)^2}.
  $$
  계산하면 **일별 평균보다 명확히 작다** → **정규근사 적합도↑**.

> **요점**: 일별 **두 봉우리**(평/주)였던 분포가 “주간 합산”에선 하나의 벨 모양에 더 가까워진다(혼합이 가중합으로 **평활화**).

---

## 11) 이론+실무 혼합: “두 층 분산 분해”로 오차 원인 보기
날짜 $$d$$ 별로  
$$
\hat p_d=p_d+\varepsilon_d,\quad E[\varepsilon_d\mid p_d]=0,\quad \mathrm{Var}(\varepsilon_d\mid p_d)=\frac{p_d(1-p_d)}{n_d}.
$$
- 전체 변동:  
  $$
  \mathrm{Var}(\hat p_d)=\underbrace{E\!\left[\frac{p_d(1-p_d)}{n_d}\right]}_{\text{샘플링}}+\underbrace{\mathrm{Var}(p_d)}_{\text{날짜 이질성}}.
  $$
- **집계 주기**를 늘리면 첫 항(샘플링)은 감소.  
- 둘째 항(이질성)은 **모형화**(주/평일 더미, 캠페인 고정효과, 랜덤효과)로 줄인다.  
- **CLT 품질**은 둘째 항이 작아질수록 좋아진다(분포가 단봉형으로).

---

## 12) “시뮬레이션 사고실험” 코드 스니펫(개념용)
> 실제 실행은 환경에 맞춰 라이브러리를 쓰세요. 아래는 구조만 보여주는 예시입니다.
```python
# CTR 일별 표집분포 사고실험(개념용)
import random, math

def day_binomial(n, p):
    # 빠른 근사: 정규근사 or Python의 random.betavariate로 변형도 가능
    # 여기선 간단한 합산 (비효율적이므로 실제는 라이브러리 권장)
    c = 0
    for _ in range(n):
        if random.random() < p:
            c += 1
    return c

def simulate_days(D=1000, n_weekday=120_000, n_weekend=80_000, p_wd=0.029, p_we=0.034):
    samples = []
    for _ in range(D):
        # 5 평일 + 2 주말
        xs = []
        for _ in range(5):
            xs.append(day_binomial(n_weekday, p_wd))
        for _ in range(2):
            xs.append(day_binomial(n_weekend, p_we))
        # 일별 CTR들
        ctrs = [x/n_weekday for x in xs[:5]] + [x/n_weekend for x in xs[5:]]
        # 주간 비율의 비율
        weekly_ctr = sum(xs)/float(5*n_weekday + 2*n_weekend)
        samples.append((ctrs, weekly_ctr))
    return samples

# 결과 요약: 일별 평균/분산, 주간 평균/분산, 히스토그램 모양 비교(실제는 numpy/matplotlib이 편리)
```

---

## 13) “일 평균 vs 주 평균” 선택 가이드 (요약 문장 템플릿)
- “**일 평균 CTR**은 $$\text{SE}\approx \sqrt{p(1-p)/n_d}$$ 로 **일별 노이즈**가 크다. 일 간 이질성이 크면 히스토그램이 **이봉성**을 보인다.”  
- “**주간 CTR(비율의 비율)**은 분모가 커져 **SE ↓**. 이질성이 평준화되어 **정규근사**가 더 잘 맞는다. 단, 주간 정책 사이클에 맞춘 **블록 부트스트랩**으로 **CI**를 산출한다.”  
- “**설계**: 빠른 의사결정이 필요하면 ‘일’로 보되, **Wilson/부트스트랩**을 사용. 안정된 보고와 회귀모형 적합에는 ‘주’가 유리.”

---

## 14) 자주 부딪히는 함정과 처방
1) **단순 평균의 함정**: 일별 CTR을 단순 평균하면 **노출 가중치**를 무시 → **비율의 비율** 사용.  
2) **자기상관 무시**: 연속 프로모션 기간엔 CLT 표준오차가 과소추정 → **블록 단위(주/캠페인)**로 리샘플.  
3) **희귀 이벤트**: 일별 분자(전환수)가 작으면 **정규근사** 불안정 → **포아송/정확** 또는 **Wilson**.  
4) **heavy-tail 지표**: 체류시간/ARPU는 평균만 보지 말고 **중앙값+분위** 병기, **로그척도**/부트스트랩.

---

## 15) 연습문제(정답 스케치 포함)

**[1] 일별 CTR의 95% CI (정규근사)**  
- $$p=0.03,\ n=100{,}000$$ 일 때 95% CI?  
- **스케치**: $$\mathrm{SE}=\sqrt{0.03\cdot 0.97/100000}\approx 0.000539$$ → $$0.03\pm 1.96\times 0.000539$$.

**[2] 주간 비율의 비율 SE**  
- 평일 5일 $$n=120k,p=0.029$$, 주말 2일 $$n=80k,p=0.034$$. 주간 CTR의 분산 근사를 써라.  
- **스케치**:  
  $$\mathrm{Var}(\hat p)=\frac{\sum_d n_d p_d(1-p_d)}{(\sum_d n_d)^2}.$$

**[3] LLN/CLT 한계**  
- 일별 체류시간이 로그정규(µ=3.8, σ=1.1)일 때, 일 평균의 정규근사가 느린 이유는?  
- **스케치**: 꼬리가 두꺼워 **Berry–Esseen** 상수가 커지고, 극단값에 민감.

**[4] 블록 부트스트랩**  
- 왜 일별 리샘플보다 주간 블록 리샘플이 더 현실적인가?  
- **스케치**: 일 내 상관/프로모션 지속성 때문에 **독립 가정** 위배 → 블록 단위로 요인 유지.

---

## 16) TL;DR
- **표본평균**: $$E[\bar X]=\mu,\ \mathrm{Var}(\bar X)=\sigma^2/n$$; 정규모집단이면 정확히 정규.  
- **t·χ²·F**: σ 미지의 평균 검정, 분산 추정과 비교에서 자연스럽게 등장.  
- **LLN**: 평균은 진실로; **CLT**: 합/평균은 정규처럼(단, 분산 유한·이질성/상관 작을수록 빠름).  
- **일 단위 CTR**: 이항 샘플링 변동 + **날짜 이질성**. **주간 합산(비율의 비율)**은 SE↓, 정규근사↑.  
- **설계**: 비율의 비율, 층화/랜덤효과, 블록 부트스트랩, Wilson/포아송 대체를 적재적소에.

---

## 수학 박스 B — LLN/CLT/Slutsky/델타 방법
> **붙이는 위치 권장**: 6) 표집분포·LLN·CLT 끝부분

**약한 대수의 법칙(WLLN)**  
$i.i.d.$ $X_i$에 대해 $\mathbb E|X_1|<\infty$이면
$$
\bar X_n=\frac1n\sum_{i=1}^n X_i \xrightarrow{p} \mu=\mathbb E[X_1].
$$

**Lindeberg–Feller CLT(비동분산 독립)**  
독립한 $X_i$가 $\mathbb E[X_i]=0$, 분산합 $s_n^2=\sum_{i=1}^n \sigma_i^2\to\infty$,  
모든 $\varepsilon>0$에 대해 Lindeberg 조건
$$
\frac{1}{s_n^2}\sum_{i=1}^n \mathbb E\!\left[X_i^2\,\mathbf 1\{|X_i|>\varepsilon s_n\}\right]\to 0
$$
이면
$$
\frac{\sum_{i=1}^n X_i}{s_n} \xRightarrow{d} \mathcal N(0,1).
$$

**연속매핑·Slutsky**  
$X_n\xRightarrow{d}X$, $g$ 연속 $\Rightarrow g(X_n)\Rightarrow g(X)$.  
$X_n\xRightarrow{d}X$, $Y_n\xrightarrow{p}c \Rightarrow X_n+Y_n\Rightarrow X+c$, $X_nY_n\Rightarrow cX$.

**델타 방법(1차 테일러)**  
$\sqrt n(\hat\theta-\theta)\Rightarrow \mathcal N(0,V)$, $g$ 미분가능이면
$$
\sqrt n\{g(\hat\theta)-g(\theta)\}\Rightarrow \mathcal N\!\big(0, [g'(\theta)]^2 V\big).
$$

**증명 스케치(한 줄)**  
테일러 전개 $g(\hat\theta)=g(\theta)+g'(\theta)(\hat\theta-\theta)+o_p(n^{-1/2})$ 후 Slutsky 적용.
