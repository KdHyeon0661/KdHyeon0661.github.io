---
layout: post
title: 정보보안기사 - 네트워크 취약점 사례와 대응
date: 2025-11-09 16:25:23 +0900
category: 정보보안기사
---
# 네트워크 취약점 사례와 대응(스푸핑, 세션 하이재킹, 미스컨피그)

## 0) 큰 그림(Threat → Control 맵)

```
Threats
 ├─ Spoofing
 │   ├─ ARP/MAC, IP, DNS, DHCP, IPv6 RA/ND, STP, BGP
 │   └─ 목적: MITM, 세션 탈취, 트래픽 우회/차단
 ├─ Session Hijacking
 │   ├─ TCP 레벨 예측/가로채기(MITM)
 │   └─ Web 레벨 쿠키 탈취(XSS/스니핑)·재사용
 └─ Misconfiguration
     ├─ 모든-허용 FW/ACL, 관리 포트 노출, 클라우드 SG 오개방
     └─ L2/VLAN, STP/BPDU, NAT, DNS, K8s NetworkPolicy 미적용

Controls
 ├─ L2/3: DHCP Snooping, DAI, IP Source Guard, uRPF, RA-Guard, Port-Security
 ├─ L3/4: FW 최소권한, CoPP, TTL-Security(BGP), RPF, Bogon Drop
 ├─ L7/Web: TLS, HSTS, Secure/SameSite Cookies, CSRF, 토큰 회전
 ├─ 무선: WPA3/PMF, 802.1X(EAP-TLS)
 ├─ 가시성: NetFlow/IPFIX, SPAN/TAP, IDS/IPS/WAF, 로그 중앙화
 └─ 클라우드/IaC: SG/NACL 표준 템플릿, 정적 분석·정책 게이트
```

---

# 1) 스푸핑(Spoofing)

> **요지**: **신원(주소/역할)을 속여** 트래픽을 훔치거나 중간에 끼어듭니다. 1계층 위조부터 L3/라우팅까지 광범위합니다.

## 1.1 ARP 스푸핑(MITM) & 대응

- **원리 요지**: 공격자가 **가짜 ARP 응답**(“게이트웨이 IP는 내 MAC”)을 쏘아 L2 테이블을 오염 → 트래픽이 공격자에게 흘러가도록 유도.
- **징후**: 한 IP에 대해 **MAC이 빈번 변경**, **Gratuitous ARP** 다량, **중간 지연 증가**.

### 탐지(방어용) — ARP 테이블 이상 감지 스크립트(수동 수신만)
```python
# arp_watch.py : 동일 IP에 대해 MAC 변동/과다 G-ARP 알림(방어/모니터링용)
from scapy.all import sniff, ARP
from collections import defaultdict, deque
import time

ip2mac = {}
g_arp = deque(maxlen=1000)  # 최근 G-ARP 타임스탬프
THRESH_GARP = 30  # 초당 G-ARP 임계(환경에 맞게)

def on_pkt(p):
    if not p.haslayer(ARP): return
    a = p[ARP]
    # Gratuitous ARP: who-has/ is-at 모두 자기 IP 알림
    if a.psrc == a.pdst or a.op == 2 and a.psrc == a.pdst:
        g_arp.append(time.time())
        g = [t for t in g_arp if time.time() - t < 1.0]
        if len(g) > THRESH_GARP:
            print("[ALERT] Excessive Gratuitous ARP bursts")
    # IP→MAC 매핑 변경 감지
    if a.op == 2:  # is-at(응답)
        old = ip2mac.get(a.psrc)
        if old and old != a.hwsrc:
            print(f"[ALERT] ARP Poison? {a.psrc}: {old} -> {a.hwsrc}")
        ip2mac[a.psrc] = a.hwsrc

sniff(filter="arp", prn=on_pkt, store=0)
```

> **주의**: 위 스니펫은 **수동 수집**만 수행하며 공격 수행 로직은 포함하지 않습니다.

### 차단 구성(스위치, Cisco IOS)

```cisco
! DHCP Snooping + DAI + IP Source Guard (VLAN 10 예시)
ip dhcp snooping
ip dhcp snooping vlan 10
!
ip arp inspection vlan 10
ip arp inspection validate src-mac dst-mac ip
!
interface GigabitEthernet1/0/1
 switchport access vlan 10
 ip dhcp snooping limit rate 30
 ip verify source
 spanning-tree portfast
!
interface GigabitEthernet1/0/48   ! 업링크/신뢰 포트
 ip dhcp snooping trust
 ip arp inspection trust
```

- **DHCP Snooping**: IP–MAC–Port **바인딩 테이블** 생성  
- **DAI**(Dynamic ARP Inspection): 바인딩 테이블과 **ARP 응답 검증**  
- **IP Source Guard**: 바인딩에 없는 IP의 **L3 트래픽 차단**

### Linux 단말 하드닝
```bash
# 정적 ARP로 게이트웨이 고정(소규모 환경 대비책)
sudo arp -s 192.168.10.1 00:11:22:33:44:55
# 혹은 arptables/nft로 불필요 Gratuitous ARP 제한(환경 맞춤)
```

---

## 1.2 IP 스푸핑 & uRPF

- **원리**: 출발지 IP를 임의로 위조. DDoS Amplification, RST 공격, 반사형 공격에 사용.
- **대응**: **uRPF(Loose/Strict)**, Edge ACL(BCP38), Bogon Drop, CoPP.

```cisco
! uRPF + Bogon Drop (Edge)
interface Gi0/0
 ip verify unicast source reachable-via any
!
ip access-list extended EDGE-IN
 deny   ip 10.0.0.0 0.255.255.255 any
 deny   ip 172.16.0.0 0.15.255.255 any
 deny   ip 192.168.0.0 0.0.255.255 any
 permit ip any any
interface Gi0/0
 ip access-group EDGE-IN in
```

---

## 1.3 DNS 스푸핑/포이즈닝(응답 위조) & 방어

- **요지**: 재귀 리졸버/캐시의 응답을 **위조된 레코드**로 오염시키거나, MITM으로 잘못된 A/AAAA를 주입.
- **징후**: **짧은 TTL**의 낯선 A/AAAA, 동일 쿼리에 **다중 상충 응답**, 외부로의 **비정상 DNS** 트래픽.

### 모니터링(방어용) — “동일 TXID에 다중 상충 응답” 경보(간이)
```python
# dns_poison_watch.py : 수동 수신 기반 이상 탐지
from scapy.all import sniff, DNS, DNSRR, UDP
from collections import defaultdict, deque
import time

cache = defaultdict(lambda: deque(maxlen=5))
def cb(p):
    if not p.haslayer(DNS) or p[DNS].qr != 1: return
    k = (p[IP].dst, p[DNS].id, str(p[DNS].qd.qname))
    ips = {p[DNSRR][i].rdata for i in range(p[DNS].ancount)}
    cache[k].append((time.time(), tuple(sorted(ips))))
    items = [x for x in cache[k] if time.time()-x[0] < 1.0]
    if len({x[1] for x in items}) > 1:
        print(f"[ALERT] Conflicting DNS answers for {k[2]}")
sniff(filter="udp port 53", prn=cb, store=0)
```

### 방어 구성 포인트
- **DNSSEC**(권장), 내부 리졸버 **DNS-over-TLS** 아웃바운드 고정, **스플릿 DNS**.  
- **FW/프록시**: 내부 단말의 DNS는 **공식 리졸버만 통과**(이외 차단/리다이렉트).  
- **로그**: 쿼리/응답 **도메인·TTL·응답 수** 수집 → 이상 감지.

---

## 1.4 DHCP Starvation / Rogue DHCP & 대응

- **요지**: DHCP 풀 고갈로 신규 단말 할당 실패, 혹은 **가짜 DHCP**로 게이트웨이/ DNS를 공격자 것으로 지정.
- **대응**: **DHCP Snooping**, 신뢰 포트만 허용, 속도 제한, Option 82 검증.

```cisco
ip dhcp snooping
ip dhcp snooping vlan 10,20
interface Gi1/0/48
 ip dhcp snooping trust
!
interface Gi1/0/1
 ip dhcp snooping limit rate 20
```

---

## 1.5 IPv6 RA/ND 스푸핑 & RA-Guard

- **요지**: 공격자가 **가짜 Router Advertisement**를 뿌려 기본 게이트웨이를 자신으로 지정.
- **대응**: **RA-Guard**, DHCPv6-Shield, MLD 스누핑, SLAAC 정책.

```cisco
ipv6 nd raguard policy BLOCK-ROGUE
 device-role router
!
interface Gi1/0/1
 ipv6 nd raguard attach-policy BLOCK-ROGUE
```

---

## 1.6 STP/BPDU 스푸핑 & Guard

- **요지**: 공격 포트가 STP 루트가 되면 **트래픽 경로 장악/중단**.
- **대응**: **PortFast + BPDU Guard**, 루트가드, 유효 토폴로지 점검.

```cisco
interface range Gi1/0/1-24
 spanning-tree portfast
 spanning-tree bpduguard enable
```

---

## 1.7 (개요) BGP 하이재킹/프리픽스 오용

- **요지**: 잘못된/악의적 prefix 광고 → 트래픽 경로 탈취.  
- **대응**: **TTL-Security**, **Max-Prefix**, **RPKI/ROA 검증**, prefix-filter 철저.

```cisco
router bgp 65001
 neighbor 203.0.113.1 ttl-security hops 2
 neighbor 203.0.113.1 maximum-prefix 100 90 restart 5
 ! prefix-list/inbound 필수, RPKI 검증(장비 지원 시)
```

---

# 2) 세션 하이재킹(Session Hijacking)

> **요지**: 이미 인증된 세션을 **가로채거나 재사용**합니다. 네트워크(MITM/스니핑)와 웹(쿠키·토큰) 레이어로 나뉩니다.

## 2.1 TCP 레벨 (MITM/예측) — 방어 중심

- **현상**: 동일 5-tuple에 **비정상 RST/ACK** 삽입, 시퀀스 번호 추정·주입(고전) 또는 MITM에서 **패킷 조작**.  
- **완화**:  
  - **TLS 강제**(가시성은 프록시/에이전트로), **HSTS**, **ALPN/TLS1.2+**.  
  - **OS 커널**: TCP SEQ 랜덤화, RST rate-limit.  
  - **네트워크**: ARP/RA 방지(상단 1장), **아이솔레이션**(VLAN/무선 PMF).

### 리눅스 커널 보강(발췌)
```bash
# TCP RST rate 제한
sudo sysctl -w net.ipv4.tcp_rfc1337=1
sudo sysctl -w net.ipv4.tcp_max_syn_backlog=4096
sudo sysctl -w net.ipv4.tcp_syncookies=1
```

---

## 2.2 웹 세션(쿠키/토큰) — 탈취·재사용 대응

- **공격 경로**:  
  - **스니핑**(암호화 미적용 구간), **XSS**(document.cookie 노출), **CSRF**, **취약한 쿠키 옵션**.  
- **핵심 대응**:  
  - 모든 인증 경로 **HTTPS 전용** + **HSTS Preload**.  
  - 쿠키에 `Secure; HttpOnly; SameSite=Strict|Lax` 적용.  
  - **토큰 회전(rotate)** + **짧은 만료** + **디바이스/클라이언트 지문**(위험 기반 접근).  
  - 로그인 상태 보호: **IP/UA/지리** 급변 시 **재인증/리바인딩**.

### NGINX HSTS·보안 헤더(간단)
```nginx
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "DENY" always;
```

### 웹 앱(쿠키) 설정 예시
```http
Set-Cookie: SESSIONID=...; Path=/; Secure; HttpOnly; SameSite=Lax
```

### 토큰 회전(의사 로직)
```python
# (서버) Refresh 토큰 사용 시 즉시 재발급, 이전 토큰은 일회용으로 폐기
def refresh(old_refresh):
    claims = verify(old_refresh)
    if used(old_refresh): raise ReuseDetected()
    mark_used(old_refresh)
    return issue_new_access_and_refresh(claims['sub'])
```

---

# 3) 미스컨피그(Misconfiguration)

> **요지**: 공격의 절반은 **잘못된 설정**에서 시작합니다. “기본 허용”, “관리 포트 외부 노출”, “클라우드 SG 0.0.0.0/0” 등.

## 3.1 방화벽/ACL

- **사례**: `permit ip any any`, 내부 DNS/DB 외부 전체 공개, 관리 포트(22/3389) 인터넷 노출.  
- **대응**: **기본 거부** + **화이트리스트**, 관리 포트는 **배스천/SSM** 경유, egress 도 **최소화**.

```cisco
ip access-list extended INBOUND-DMZ
 permit tcp any host 203.0.113.10 eq 443
 deny   ip any any log
interface Gi0/0
 ip access-group INBOUND-DMZ in
```

## 3.2 스위치/L2

- **사례**: Native VLAN 혼용(더블태깅 위험), **BPDU Guard 미적용**, 포트보안 없음.  
- **대응**: **PortFast+BPDU Guard**, **Native VLAN 고정**(미사용/전용), **MAC 제한**.

```cairo
interface Gi1/0/1
 switchport mode access
 switchport access vlan 10
 switchport port-security
 switchport port-security maximum 2
 switchport port-security violation restrict
```

## 3.3 관리면

- **사례**: SNMPv2c `public`/`private`, 텔넷 활성, 장비 웹콘솔 HTTP.  
- **대응**: **SNMPv3**, **SSH 전용**, 관리 VRF/VLAN 분리, **ACL로 관리 IP만 허용**.

## 3.4 클라우드 보안그룹/스토리지

- **사례**: DB(3306/5432) `0.0.0.0/0`, S3 공개 버킷, ALB→백엔드 전포트.  
- **대응**: **SG 표준 템플릿**, IaC 정책 게이트, 정기 쿼리로 **0.0.0.0/0 탐지**.

```bash
# AWS: 0.0.0.0/0 허용 SG 찾기(요지)
aws ec2 describe-security-groups \
  --query "SecurityGroups[?IpPermissions[?IpRanges[?CidrIp=='0.0.0.0/0']]][].{Name:GroupName,Id:GroupId}"
```

## 3.5 DNS/이메일

- **사례**: 오픈 리졸버, SPF/DKIM/DMARC 미설정 → 스푸핑·피싱.  
- **대응**: 내부는 **리졸버 고정**(프록시), 외부 오픈 리졸버 차단. 메일 도메인 **SPF/DKIM/DMARC**.

## 3.6 Kubernetes

- **사례**: `NetworkPolicy` 미적용(모두 허용), `ServiceType=LoadBalancer` 과다, etcd 외부 노출.  
- **대응**: **기본 거부 NP**, Ingress/WAF 전면화, etcd 네트워크 격리+mTLS.

---

# 4) 관측·탐지(필수 로깅)

- **플로우**: NetFlow/IPFIX로 **누가/어디로/얼마나**.  
- **패킷**: SPAN/TAP로 **왜**(프로토콜/헤더).  
- **IDS/IPS/WAF**: 시그니처+행위, **EVE JSON/Access Logs** 중앙화.  
- **경보 예시**:  
  - 1분 내 **Gratuitous ARP 비정상 증가**  
  - 동일 도메인 **상충 DNS 응답**  
  - 내부 단말이 **외부 DNS(53)** 로 직접 통신  
  - **관리 포트(22/3389)** 로 외부 인바운드 발생

---

# 5) 방어 구성 예제(모음)

## 5.1 Edge/코어 공통

```cisco
! Bogon/사설 드롭
ip access-list extended EDGE-IN
 deny ip 10.0.0.0 0.255.255.255 any
 deny ip 172.16.0.0 0.15.255.255 any
 deny ip 192.168.0.0 0.0.255.255 any
 permit ip any any
!
! uRPF (느슨)
interface Gi0/0
 ip verify unicast source reachable-via any
!
! CoPP (제어면 보호 - 개념)
control-plane
 service-policy input CONTROL-PLANE-POLICY
```

## 5.2 NGINX(역방향 프록시)로 HTTPS 강제·기본 보호
```nginx
server {
  listen 443 ssl http2;
  server_name app.example.com;
  ssl_certificate     /etc/nginx/cert.pem;
  ssl_certificate_key /etc/nginx/key.pem;

  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

  location /api/ {
    proxy_pass http://app:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
    limit_req zone=req_per_ip burst=20 nodelay;
  }
}
```

## 5.3 Linux nftables — 아웃바운드 DNS 고정
```bash
nft add table inet egress
nft add chain inet egress output { type filter hook output priority 0; policy drop; }
# 허용: 조직 리졸버로의 DNS만
nft add rule inet egress output ip daddr 10.53.0.10 udp dport 53 accept
nft add rule inet egress output ct state established,related accept
nft add rule inet egress output oif lo accept
```

---

# 6) 시나리오·런북(incident runbook)

## 6.1 의심되는 ARP 스푸핑 발생

1) **징후**: 다수 단말의 게이트웨이 핑 지연↑, 끊김·재연결 반복.  
2) **즉시 조치**  
   - 스위치에서 `show ip arp inspection statistics` 확인, **위반 포트** 식별.  
   - 포트 **shutdown**(격리), DHCP Snooping/DAI 설정 확인·적용.  
3) **근본 원인**  
   - 해당 포트에 연결된 허브/공유기/개인 AP 철거.  
4) **재발 방지**  
   - **DAI 전면 적용**, 포트보안·맥제한, 비인가 장비 탐지(LLDP/NAC).

## 6.2 DNS 스푸핑 의심

1) **징후**: 사내 특정 도메인 접속 시 외부/낯선 IP로 향함.  
2) **조치**  
   - SPAN으로 **DNS 트래픽 캡처**, 한 쿼리에 **다중 응답**/낮은 TTL 반복 확인.  
   - FW에서 **53/udp/tcp 외부 향 단말 차단** → 공식 리졸버로 리다이렉션.  
   - 내부 리졸버 로그로 **요청자 IP** 추적.  
3) **개선**  
   - DNSSEC 도입 검토, egress DNS 강제, 캐시 정책(최소 TTL) 조정.

## 6.3 세션 하이재킹 의심(웹)

1) **징후**: 동일 계정의 **동시/원격 로그인**, 비정상 IP/UA.  
2) **조치**  
   - **Refresh 토큰 즉시 회전** 정책 발동, 기존 세션 무효화.  
   - 의심 IP/ASN 차단, MFA 재검증.  
3) **개선**  
   - HSTS Preload, 쿠키 `SameSite`, 토큰 만료 단축·지문 기반 위험 평가.

---

# 7) 검증·테스트(합법·내부 점검)

- **구성 점검**:  
  - `show/run` 백업 → 정책 Diff(변경관리), **정적 분석**(SG/ACL 금지 패턴).  
  - NetFlow/IPFIX로 **외부 DNS/관리포트** 트래픽 유무 검증.  
- **성능 영향**: DAI/RA-Guard 활성 후 **지연/드롭** 모니터.  
- **침해 가정 연습(Tabletop)**: ARP/DNS/BPDU 사건 카드로 대응 훈련.

---

# 8) 체크리스트(요약)

- [ ] **DHCP Snooping + DAI + IP Source Guard** 전 사무실 VLAN 적용  
- [ ] **uRPF**(Loose) + Bogon Drop, Edge ACL  
- [ ] **RA-Guard / BPDU-Guard / Port-Security**  
- [ ] **HTTPS/HSTS 강제**, 쿠키 `Secure; HttpOnly; SameSite`  
- [ ] **배스천/SSM**로 관리면 통일(22/3389 외부 노출 금지)  
- [ ] **클라우드 SG**: 0.0.0.0/0 검색·차단 가드레일  
- [ ] **Egress DNS 고정**, 내부 오픈 리졸버 금지  
- [ ] **로그 중앙화**(DNS/ARP/Flow/WAF/IDS), NTP 동기화

---

# 9) 미니 과제(실습)

### A. DAI 배포·검증 (20점)
- (10) VLAN 10에 **DHCP Snooping+DAI** 활성  
- (5) 위반 카운터·신뢰 포트 캡처  
- (5) ARP 이상 수신기(위 스크립트) 알람 스크린샷

### B. DNS egress 통제 (20점)
- (10) 단말 egress DNS를 **조직 리졸버로 강제**(FW/nft)  
- (5) 외부 공개 DNS로의 시도 로그 캡처  
- (5) 상충 응답 탐지 알람 케이스 제출

### C. 웹 세션 보호(헤더/토큰) (20점)
- (10) HSTS, Secure/HttpOnly/SameSite 적용 증빙  
- (5) 토큰 회전 구현(의사 코드/로그)  
- (5) 의심 세션 무효화 런북 문서화

---

## 마무리

- **스푸핑**은 L2~L3의 **검증 부재**를 노립니다. **Snooping/Inspection/Guard** 계열 컨트롤을 표준화하세요.  
- **세션 하이재킹**은 **암호화·쿠키/토큰 통제**로 막습니다. (TLS + HSTS + 짧은 수명 + 회전)  
- **미스컨피그**는 **기본 거부·최소권한·IaC/정적 분석·가시성**으로 줄일 수 있습니다.  
- 마지막으로, 모든 방어는 **관측(로그/플로우/패킷)**으로 **증거 기반** 운용이 되어야 개선이 가능합니다.