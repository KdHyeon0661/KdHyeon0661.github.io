---
layout: post
title: Svelte - ì˜ˆì œ ë¯¸ë‹ˆ í”„ë¡œì íŠ¸ (4)
date: 2025-10-08 15:30:23 +0900
category: Svelte
---
# ì˜ˆì œ ë¯¸ë‹ˆ í”„ë¡œì íŠ¸ (4) â€” **ì‹¤ì‹œê°„(ì›¹ì†Œì¼“ / SSE) ì•Œë¦¼ ë³´ë“œ**

> SvelteKitë¡œ **ì‹¤ì‹œê°„ ì•Œë¦¼ ë³´ë“œ**ë¥¼ 0 â†’ 1ë¡œ êµ¬ì¶•í•œë‹¤.  
> - **ì „ì†¡ ë°©ì‹**: WebSocket(ì–‘ë°©í–¥, ì±„ë„/ì¡´ì¬ ê°ì§€) + SSE(ë‹¨ë°©í–¥, ì„œë²„ë¦¬ìŠ¤ ì¹œí™”) ë‘˜ ë‹¤ ì œê³µ  
> - **ì•Œë¦¼ ëª¨ë¸**: êµ¬ë… í† í”½(ì±„ë„), ì½ìŒ/ì•ˆì½ìŒ, ë±ƒì§€ ì¹´ìš´íŠ¸, ì¤‘ìš”ë„(priority)  
> - **í™•ì¥ì„±**: ë©€í‹° ì¸ìŠ¤í„´ìŠ¤ ëŒ€ë¹„ Redis Pub/Sub ì—°ê²°(ì„ íƒ)  
> - **íšŒë³µë ¥**: ì¬ì ‘ì†, í•˜íŠ¸ë¹„íŠ¸, ë°±í”„ë ˆì…”, ë©”ì‹œì§€ ë“œë¡­ ì „ëµ  
> - **ë³´ì•ˆ**: í† í° ê²€ì¦, ë ˆì´íŠ¸ ë¦¬ë¯¸íŒ…, ì…ë ¥ ê²€ì¦(Zod), CORS/Origin, ê¶Œí•œ(ì±„ë„ ì ‘ê·¼)  
> - **í´ë¼ì´ì–¸íŠ¸ UI**: ì¢…(bell) ë±ƒì§€, ì•Œë¦¼ í”¼ë“œ, í•„í„°, í† ìŠ¤íŠ¸, í† í”½(ì±„ë„) êµ¬ë…/í•´ì œ  
> - **ë°°í¬**: Node(WS) / ì„œë²„ë¦¬ìŠ¤(SSE) / ì—ì§€ ì œì•½

---

## 0) ì•„í‚¤í…ì²˜ ì„¤ê³„

### ì„ íƒì§€ ë¹„êµ: **WebSocket vs SSE**
| í•­ëª© | WebSocket | SSE (Server-Sent Events) |
|---|---|---|
| ë°©í–¥ì„± | ì–‘ë°©í–¥ | ì„œë²„â†’í´ë¼ì´ì–¸íŠ¸ ë‹¨ë°©í–¥ |
| ë¸Œë¼ìš°ì € ì§€ì› | ê´‘ë²”ìœ„ | ë§¤ìš° ê´‘ë²”ìœ„ |
| ì„œë²„ í™˜ê²½ | ë…¸ë“œ/ì¥ê¸°ì—°ê²° ì§€ì› í•„ìš” | ì„œë²„ë¦¬ìŠ¤/ì—ì§€ì—ì„œë„ ì‰¬ì›€ |
| ë©”ì‹œì§€ í¬ê¸°/ë¹ˆë„ | ë¹ˆë²ˆ/ìƒí˜¸ì‘ìš© O | ì•Œë¦¼/ë¸Œë¡œë“œìºìŠ¤íŠ¸ ìµœì  |
| ë¶€í•˜ ë¶„ì‚° | ìŠ¤í…Œì´íŠ¸í’€(ì—°ê²° ìœ ì§€) | ìƒëŒ€ì ìœ¼ë¡œ ë‹¨ìˆœ |
| ì‚¬ìš© ì˜ˆ | ì¡´ì¬ê°ì§€, íƒ€ì´í•‘, í™•ì¸ ì‘ë‹µ | ë‰´ìŠ¤/ì•Œë¦¼ feed, ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ |

> ì´ ê°€ì´ë“œëŠ” **ë‘ ê°€ì§€ë¥¼ ëª¨ë‘ êµ¬í˜„**í•œë‹¤. í™˜ê²½ì— ë§ì¶° ì„ íƒ/í˜¼ìš© ê°€ëŠ¥(ì˜ˆ: ì•Œë¦¼ì€ SSE, ìƒí˜¸ì‘ìš©ì€ WS).

---

## 1) ë°ì´í„° ëª¨ë¸ / ì‚¬ì–‘

### ì•Œë¦¼(Notification) ìŠ¤í‚¤ë§ˆ
- `id: string` â€” ê³ ìœ  ID(ulid/cuid)  
- `topic: string` â€” ì±„ë„/ì£¼ì œ(ì˜ˆ: `"sales"`, `"system"`, `"user:123"`)  
- `title: string` â€” ì œëª©  
- `body: string` â€” ë©”ì‹œì§€  
- `priority: 'low'|'normal'|'high'` â€” ìš°ì„ ìˆœìœ„  
- `ts: number` â€” Unix ms (ì •ë ¬/ì¤‘ë³µ ì œê±° ê¸°ì¤€)  
- `meta?: Record<string, any>` â€” ë§í¬/ì•„ì´ì½˜/CTA ë“±  
- `read?: boolean` â€” ì½ìŒ ìƒíƒœ(í´ë¼/ì„œë²„ ì–‘ìª½ ê´€ë¦¬ ê°€ëŠ¥)

### ë©”ì‹œì§€ íƒ€ì…: **ì„œë²„â†’í´ë¼**
```ts
type ServerEvent =
  | { type: 'push'; data: Notification }
  | { type: 'bulk'; data: Notification[] }      // ì´ˆê¸° ë™ê¸°í™”
  | { type: 'ack'; ids: string[] }              // ì„œë²„ ì²˜ë¦¬ í™•ì¸
  | { type: 'presence'; topic: string; count: number }  // êµ¬ë…ììˆ˜
  | { type: 'pong' }                             // í•˜íŠ¸ë¹„íŠ¸ ì‘ë‹µ
  | { type: 'error'; code: string; message: string };
```

### ë©”ì‹œì§€ íƒ€ì…: **í´ë¼â†’ì„œë²„(ì›¹ì†Œì¼“)**
```ts
type ClientEvent =
  | { type: 'hello'; token: string; topics: string[] }
  | { type: 'subscribe'; topics: string[] }
  | { type: 'unsubscribe'; topics: string[] }
  | { type: 'read'; ids: string[] }              // ì½ìŒ í™•ì¸
  | { type: 'ping' }                             // í•˜íŠ¸ë¹„íŠ¸
  | { type: 'emit'; data: Notification };        // ê³ ê¸‰: í´ë¼â†’ì„œë²„ ìƒì„±(ê¶Œí•œ í•„ìš”)
```

---

## 2) ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
src/
  lib/
    schema/
      notif.ts              # Zod ìŠ¤í‚¤ë§ˆ
    server/
      bus.ts                # InMemoryBus / RedisBus(ì„ íƒ)
      auth.ts               # í† í° ê²€ì¦
      rate.ts               # ë ˆì´íŠ¸ ë¦¬ë¯¸íŠ¸/ì•ˆí‹° ìŠ¤íŒ¸
      ws.ts                 # WS í•¸ë“¤ëŸ¬(ë…¸ë“œ)
      sse.ts                # SSE ë¸Œë¡œë“œìºìŠ¤íŠ¸ ìœ í‹¸
    stores/
      notif.ts              # í´ë¼ ìŠ¤í† ì–´(ì•Œë¦¼/êµ¬ë…/ìƒíƒœ)
    components/
      NotificationBell.svelte
      NotificationFeed.svelte
      ChannelBadge.svelte
      Toast.svelte
  routes/
    api/
      notify/+server.ts     # RESTë¡œ ì•Œë¦¼ ë°œí–‰
      ws/+server.ts         # WebSocket ì—…ê·¸ë ˆì´ë“œ ì—”ë“œí¬ì¸íŠ¸ (adapter-node)
      sse/+server.ts        # SSE ìŠ¤íŠ¸ë¦¼
      history/+server.ts    # í˜ì´ì§€ë„¤ì´ì…˜(ì˜¤í”„ë¼ì¸/ì´ˆê¸° ë¡œë“œ)
```

> **WSëŠ” `adapter-node`/ì¥ê¸°ì—°ê²° ì œê³µ í™˜ê²½**ì—ì„œë§Œ ë™ì‘. ì„œë²„ë¦¬ìŠ¤/ì—ì§€ëŠ” SSEë¥¼ ì‚¬ìš©.

---

## 3) Zod ìŠ¤í‚¤ë§ˆ(ì…ì¶œë ¥ ê²€ì¦)

```ts
// src/lib/schema/notif.ts
import { z } from 'zod';

export const zNotification = z.object({
  id: z.string(),
  topic: z.string().min(1),
  title: z.string().min(1).max(140),
  body: z.string().min(1).max(2000),
  priority: z.enum(['low','normal','high']).default('normal'),
  ts: z.number().int().nonnegative(),
  meta: z.record(z.any()).optional(),
  read: z.boolean().optional()
});
export type Notification = z.infer<typeof zNotification>;

export const zServerEvent = z.union([
  z.object({ type: z.literal('push'), data: zNotification }),
  z.object({ type: z.literal('bulk'), data: z.array(zNotification) }),
  z.object({ type: z.literal('ack'), ids: z.array(z.string()) }),
  z.object({ type: z.literal('presence'), topic: z.string(), count: z.number().int().nonnegative() }),
  z.object({ type: z.literal('pong') }),
  z.object({ type: z.literal('error'), code: z.string(), message: z.string() })
]);

export const zClientEvent = z.union([
  z.object({ type: z.literal('hello'), token: z.string(), topics: z.array(z.string()) }),
  z.object({ type: z.literal('subscribe'), topics: z.array(z.string()).min(1) }),
  z.object({ type: z.literal('unsubscribe'), topics: z.array(z.string()).min(1) }),
  z.object({ type: z.literal('read'), ids: z.array(z.string()).min(1) }),
  z.object({ type: z.literal('ping') }),
  z.object({ type: z.literal('emit'), data: zNotification })
]);
export type ClientEvent = z.infer<typeof zClientEvent>;
export type ServerEvent = z.infer<typeof zServerEvent>;
```

---

## 4) ì„œë²„ ì´ë²¤íŠ¸ ë²„ìŠ¤(InMemory / Redis)

### 4.1 InMemory ë²„ìŠ¤(ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ìš©)
```ts
// src/lib/server/bus.ts
import type { Notification } from '$lib/schema/notif';

type Listener = (ev: Notification) => void;

class InMemoryBus {
  topics = new Map<string, Set<Listener>>();

  subscribe(topic: string, fn: Listener) {
    const set = this.topics.get(topic) ?? new Set();
    set.add(fn); this.topics.set(topic, set);
    return () => { set.delete(fn); if (!set.size) this.topics.delete(topic); };
  }

  publish(n: Notification) {
    const set = this.topics.get(n.topic);
    set?.forEach(fn => fn(n));
  }

  count(topic: string) { return this.topics.get(topic)?.size ?? 0; }
}

// ì‹±ê¸€í†¤
export const bus = new InMemoryBus();
```

### 4.2 (ì„ íƒ) Redis Pub/Sub ìŠ¤í…
```ts
// src/lib/server/bus-redis.ts (ì„ íƒ)
import { createClient } from 'redis';
import type { Notification } from '$lib/schema/notif';

export function createRedisBus(url: string) {
  const pub = createClient({ url }); const sub = createClient({ url });
  const local = new Map<string, Set<(n:Notification)=>void>>();

  sub.on('message', (topic, msg) => {
    const set = local.get(topic); if (!set) return;
    const n = JSON.parse(msg) as Notification;
    set.forEach(fn => fn(n));
  });

  return {
    async start() { await pub.connect(); await sub.connect(); },
    subscribe(topic: string, fn: (n:Notification)=>void) {
      const set = local.get(topic) ?? new Set(); set.add(fn); local.set(topic, set);
      sub.subscribe(topic);
      return () => { set.delete(fn); if (!set.size){ local.delete(topic); sub.unsubscribe(topic); } };
    },
    async publish(n: Notification) { await pub.publish(n.topic, JSON.stringify(n)); },
  };
}
```

> ë©€í‹° ì¸ìŠ¤í„´ìŠ¤ì—ì„œ **publish**ë§Œ Redisë¡œ ë³´ë‚´ê³ , ê° ì¸ìŠ¤í„´ìŠ¤ì—ì„œ **subscribe**ë¡œ ìˆ˜ì‹ í•˜ë©´ ìŠ¤ì¼€ì¼ì•„ì›ƒ ê°€ëŠ¥.

---

## 5) ì¸ì¦ / ë ˆì´íŠ¸ ë¦¬ë¯¸íŒ… / ë³´ì•ˆ

```ts
// src/lib/server/auth.ts
import type { RequestEvent } from '@sveltejs/kit';

export async function requireToken(event: RequestEvent): Promise<{ uid: string, topics: string[] }> {
  // ì˜ˆì‹œ: ì¿ í‚¤ì˜ ì„¸ì…˜ì—ì„œ í† í° í™•ì¸(ë˜ëŠ” Authorization í—¤ë” Bearer)
  const token = event.request.headers.get('authorization')?.replace(/^Bearer\s+/,'')
    || event.cookies.get('session_token');

  if (!token) throw Object.assign(new Error('UNAUTHORIZED'), { status: 401 });

  // ë°ëª¨: í† í° == "demo-<uid>"
  const m = token.match(/^demo-(.+)$/);
  if (!m) throw Object.assign(new Error('INVALID_TOKEN'), { status: 401 });

  const uid = m[1];
  // ê¶Œí•œ/ì£¼ì œ ì œí•œ ë¡œì§(ì¡°ì§/ì—­í•  ê¸°ë°˜) â€” ë°ëª¨ë¡œ ëª¨ë“  topic í—ˆìš©
  return { uid, topics: [] };
}
```

```ts
// src/lib/server/rate.ts
const bucket = new Map<string, { n: number; reset: number }>();
export function hit(key: string, limit = 30, windowMs = 60_000) {
  const now = Date.now();
  let r = bucket.get(key) ?? { n: 0, reset: now + windowMs };
  if (now > r.reset) r = { n: 0, reset: now + windowMs };
  r.n++; bucket.set(key, r);
  return { allowed: r.n <= limit, remaining: Math.max(0, limit - r.n) };
}
```

---

## 6) REST ë°œí–‰(ì„œë²„â†’êµ¬ë…ì) â€” `/api/notify`

```ts
// src/routes/api/notify/+server.ts
import type { RequestHandler } from './$types';
import { zNotification } from '$lib/schema/notif';
import { bus } from '$lib/server/bus';
import { requireToken } from '$lib/server/auth';
import { hit } from '$lib/server/rate';

export const POST: RequestHandler = async (event) => {
  try {
    const { uid } = await requireToken(event);
    const { allowed } = hit(`notify:${uid}`, 60, 60_000);
    if (!allowed) return new Response('Too Many Requests', { status: 429 });

    const body = await event.request.json();
    const parsed = zNotification.safeParse(body);
    if (!parsed.success) return new Response(JSON.stringify(parsed.error.flatten()), { status: 400 });

    // ê¶Œí•œ ì²´í¬: uidê°€ topicì— ë°œí–‰í•  ê¶Œí•œì´ ìˆëŠ”ì§€ ê²€ì¦(ìƒëµ/ë°ëª¨)
    bus.publish(parsed.data);

    return new Response(JSON.stringify({ ok: true }), { headers: { 'content-type':'application/json' }});
  } catch (e: any) {
    const status = e.status ?? 500;
    return new Response(e.message ?? 'Server error', { status });
  }
};
```

> í”„ë¡œë•ì…˜ì—ì„œëŠ” ë°œí–‰ ì‹œ DBì—ë„ ê¸°ë¡(ë‚´ì—­/ë¦¬í”Œë ˆì´/ì˜¤í”„ë¼ì¸ íšŒë³µ). ì—¬ê¸°ì„  ë©”ëª¨ë¦¬+íˆìŠ¤í† ë¦¬ APIë¡œ ëŒ€ì²´.

---

## 7) íˆìŠ¤í† ë¦¬(ì´ˆê¸° ë¡œë“œ/ì˜¤í”„ë¼ì¸ ë™ê¸°í™”) â€” `/api/history`

```ts
// src/routes/api/history/+server.ts
import type { RequestHandler } from './$types';
import { z } from 'zod';
import { requireToken } from '$lib/server/auth';

// ë°ëª¨ ë©”ëª¨ë¦¬ ì €ì¥(ì˜µì…˜): ìµœê·¼ Nê°œ ë³´ê´€
const ring: any[] = [];
const MAX = 2000;
export function appendHistory(n: any) { ring.push(n); if (ring.length > MAX) ring.shift(); }

export const GET: RequestHandler = async (event) => {
  await requireToken(event);
  const p = z.object({
    topic: z.string().optional(),
    limit: z.number().int().min(1).max(200).default(50),
    cursor: z.string().optional()  // ts ê¸°ì¤€(ë¬¸ìì—´), ì´í•˜ ê³¼ê±° íƒìƒ‰
  }).safeParse(Object.fromEntries(event.url.searchParams));
  if (!p.success) return new Response(JSON.stringify(p.error.flatten()), { status: 400 });

  const { topic, limit, cursor } = p.data;
  let rows = ring.slice().reverse(); // ìµœì‹ â†’ê³¼ê±°
  if (topic) rows = rows.filter(r => r.topic === topic);

  if (cursor) {
    const c = Number(cursor);
    rows = rows.filter(r => r.ts < c);
  }

  const items = rows.slice(0, limit);
  const next = items.length === limit ? String(items[items.length - 1].ts) : null;

  return new Response(JSON.stringify({ items, next }), { headers: { 'content-type':'application/json' }});
};
```

> **ë°œí–‰** ì‹œ `appendHistory()`ë„ í˜¸ì¶œí•˜ë„ë¡ ì—°ê²°(WS/SSEì—ì„œ ê°™ì´ ì²˜ë¦¬; ì˜ˆì œì—ì„œ WS/SSE êµ¬ê°„ì— í¬í•¨).

---

## 8) SSE ë¼ìš°íŠ¸ â€” `/api/sse`

### 8.1 SSE ìœ í‹¸
```ts
// src/lib/server/sse.ts
type Close = () => void;

export function createSSE(controller: ReadableStreamDefaultController, headers?: Record<string,string>) {
  const enc = new TextEncoder();
  const send = (event: string, data: any, id?: string) => {
    let payload = '';
    if (id) payload += `id: ${id}\n`;
    payload += `event: ${event}\n`;
    for (const line of JSON.stringify(data).split('\n')) {
      payload += `data: ${line}\n`;
    }
    payload += '\n';
    controller.enqueue(enc.encode(payload));
  };
  const keepalive = setInterval(() => controller.enqueue(enc.encode(':ka\n\n')), 20_000);
  const close: Close = () => clearInterval(keepalive);
  return { send, close };
}
```

### 8.2 SSE ì—”ë“œí¬ì¸íŠ¸
```ts
// src/routes/api/sse/+server.ts
import type { RequestHandler } from './$types';
import { bus } from '$lib/server/bus';
import { createSSE } from '$lib/server/sse';
import { z } from 'zod';
import { requireToken } from '$lib/server/auth';
import { appendHistory } from '../history/+server';

export const GET: RequestHandler = async (event) => {
  await requireToken(event);
  const topics = z.array(z.string()).default([]).parse((event.url.searchParams.get('topics')?.split(',').filter(Boolean)) ?? []);

  const stream = new ReadableStream({
    start(controller) {
      const { send, close } = createSSE(controller);

      // ì—°ê²° ì§í›„ í™˜ì˜/ì¬ì‹œì‘ ì•ˆë‚´
      send('hello', { ok: true, topics }, Date.now().toString());

      const unsub: (()=>void)[] = [];
      for (const t of topics) {
        unsub.push(bus.subscribe(t, (n) => {
          send('push', n, String(n.ts));
        }));
        // ì¡´ì¬ê°ì§€(ì˜µì…˜): êµ¬ë…ì ìˆ˜ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ë³´ë‚¼ ìˆ˜ë„ ìˆìŒ â€” ë‹¨ìˆœí™”
      }

      // ì—°ê²° ì¢…ë£Œ ì²˜ë¦¬
      // @ts-ignore
      event.request.signal.addEventListener('abort', () => {
        unsub.forEach(fn => fn());
        close();
        controller.close();
      });
    }
  });

  return new Response(stream, {
    headers: {
      'content-type': 'text/event-stream; charset=utf-8',
      'cache-control': 'no-cache, no-transform',
      'x-accel-buffering': 'no',
      'connection': 'keep-alive'
    }
  });
};

// ë°œí–‰ ì‹œ history ì ì¬ ì—°ê²°(REST/WSì—ì„œ í˜¸ì¶œí•˜ëŠ” ì˜ˆì‹œ)
// ì‹¤ì œë¡œëŠ” /api/notify, WS í•¸ë“¤ëŸ¬ì—ì„œ appendHistory(n) í˜¸ì¶œ
```

---

## 9) WebSocket í•¸ë“¤ëŸ¬ â€” `/api/ws` (Node ì–´ëŒ‘í„°)

> **ì „ì œ**: `adapter-node` ì‚¬ìš©. `ws` íŒ¨í‚¤ì§€ ì„¤ì¹˜.
```bash
pnpm add ws
```

### 9.1 SvelteKitì—ì„œ WS ì—…ê·¸ë ˆì´ë“œ
- `src/routes/api/ws/+server.ts`ì—ì„œ **`upgrade`**ë¥¼ ì§ì ‘ ì²˜ë¦¬.
- Node ì„œë²„ë¡œ ë°°í¬ ì‹œ, ìƒì„±ëœ `build/index.js` ë‚´ë¶€ì˜ `server`ë¥¼ ê°€ì ¸ë‹¤ ì»¤ìŠ¤í…€ ì„œë²„ë¥¼ êµ¬ì„±í•  ìˆ˜ë„ ìˆë‹¤.  
  ì—¬ê¸°ì„œëŠ” **ë¼ìš°íŠ¸ ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ** ì˜ˆì œë¥¼ ì‚¬ìš©.

```ts
// src/routes/api/ws/+server.ts
import type { RequestHandler } from './$types';
import { WebSocketServer } from 'ws';
import { requireToken } from '$lib/server/auth';
import { zClientEvent, zNotification } from '$lib/schema/notif';
import { bus } from '$lib/server/bus';
import { hit } from '$lib/server/rate';
import { appendHistory } from '../history/+server';

let wss: WebSocketServer | null = null;
const listeners = new WeakMap<WebSocket, Set<string>>(); // ì†Œì¼“ë³„ êµ¬ë… í† í”½

export const GET: RequestHandler = async (event) => {
  const { url, request } = event;

  // ì—…ê·¸ë ˆì´ë“œ í•¸ë“¤ (Nodeì „ìš©)
  if (request.headers.get('upgrade') !== 'websocket') {
    return new Response('Expected websocket', { status: 400 });
  }

  // @ts-ignore Node íƒ€ì…
  const { socket, response } = DenoOrNodeCompatibleUpgrade(event); // ì•„ë˜ í—¬í¼ ì°¸ê³ 
  if (!wss) {
    wss = new WebSocketServer({ noServer: true });
  }

  wss.handleUpgrade(request, socket, Buffer.alloc(0), async (ws) => {
    // ì¸ì¦
    let uid = 'anon';
    try {
      const a = await requireToken(event);
      uid = a.uid;
    } catch {
      ws.close(1008, 'Unauthorized'); // policy violation
      return;
    }

    listeners.set(ws, new Set());

    ws.on('message', (raw) => {
      let msg: any;
      try { msg = JSON.parse(String(raw)); } catch { return; }

      const parsed = zClientEvent.safeParse(msg);
      if (!parsed.success) {
        ws.send(JSON.stringify({ type: 'error', code: 'BAD_MESSAGE', message: 'invalid payload' }));
        return;
      }

      const data = parsed.data;
      const key = `ws:${uid}:${data.type}`;
      if (!hit(key, 120, 60_000).allowed) {
        ws.send(JSON.stringify({ type:'error', code:'RATE_LIMIT', message:'too many' }));
        return;
      }

      switch (data.type) {
        case 'hello': {
          // ì´ˆê¸° êµ¬ë…
          const set = listeners.get(ws)!;
          data.topics.forEach(t => {
            if (!set.has(t)) {
              set.add(t);
              bus.subscribe(t, (n) => {
                if (ws.readyState === ws.OPEN) {
                  // ë°±í”„ë ˆì…”: ì†¡ì‹  íê°€ ë„ˆë¬´ í¬ë©´ drop oldest
                  if ((ws as any).bufferedAmount > 1_000_000) return;
                  ws.send(JSON.stringify({ type:'push', data:n }));
                }
              });
            }
          });
          ws.send(JSON.stringify({ type:'ack', ids:[] }));
          break;
        }
        case 'subscribe': {
          const set = listeners.get(ws)!;
          data.topics.forEach(t => set.add(t));
          ws.send(JSON.stringify({ type:'ack', ids:[] }));
          break;
        }
        case 'unsubscribe': {
          const set = listeners.get(ws)!;
          data.topics.forEach(t => set.delete(t));
          ws.send(JSON.stringify({ type:'ack', ids:[] }));
          break;
        }
        case 'emit': {
          // ê¶Œí•œ ì²´í¬(ì£¼ì œ ì“°ê¸° ê¶Œí•œ) â€” ìƒëµ/ë°ëª¨
          const ok = zNotification.safeParse(data.data);
          if (!ok.success) {
            ws.send(JSON.stringify({ type:'error', code:'BAD_NOTIF', message:'invalid notification' }));
            return;
          }
          bus.publish(ok.data);
          appendHistory(ok.data);
          ws.send(JSON.stringify({ type:'ack', ids:[ok.data.id] }));
          break;
        }
        case 'read': {
          // ì„œë²„ ê¸°ë¡ì´ ìˆë‹¤ë©´ ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ â€” ë°ëª¨ ìŠ¤í‚µ
          ws.send(JSON.stringify({ type:'ack', ids: data.ids }));
          break;
        }
        case 'ping': {
          ws.send(JSON.stringify({ type:'pong' }));
          break;
        }
      }
    });

    ws.on('close', () => {
      listeners.delete(ws);
    });
  });

  return response;
};

/** Node/Deno í˜¸í™˜ ì—…ê·¸ë ˆì´ë“œ í—¬í¼ â€” ì—¬ê¸°ì„  Nodeë§Œ ì‚¬ìš©(ê°„ì†Œí™”) */
function DenoOrNodeCompatibleUpgrade(event: any) {
  const nodeRes = new Response(null, { status: 101 });
  // @ts-ignore
  const socket = (event as any).request?.raw?.socket ?? (event.platform?.node?.req?.socket);
  return { socket, response: nodeRes };
}
```

> êµ¬í˜„ ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ ì¼ë¶€ í”Œë«í¼ ë³„ ë‚œì ì„ ì¶”ìƒí™”í–ˆë‹¤. **adapter-node** í™˜ê²½ì—ì„œ `request.raw` ì ‘ê·¼ì´ ê°€ëŠ¥í•œì§€ í™•ì¸í•˜ê³  í•„ìš” ì‹œ `hooks.server.ts`ì—ì„œ ì»¤ìŠ¤í…€ ì„œë²„ë¥¼ êµ¬ì„±í•´ë„ ëœë‹¤.

---

## 10) í´ë¼ì´ì–¸íŠ¸ ìŠ¤í† ì–´

```ts
// src/lib/stores/notif.ts
import { writable } from 'svelte/store';
import type { Notification, ServerEvent } from '$lib/schema/notif';

export const feed = writable<Notification[]>([]);
export const unread = writable<number>(0);
export const connected = writable<'idle'|'connecting'|'open'|'error'>('idle');
export const transport = writable<'ws'|'sse'|'none'>('none');

export function push(n: Notification) {
  feed.update(arr => {
    // ì¤‘ë³µ ì œê±°(id) + ìµœì‹  ì •ë ¬
    const m = new Map(arr.map(x => [x.id, x]));
    m.set(n.id, n);
    const out = [...m.values()].sort((a,b)=> b.ts - a.ts);
    return out.slice(0, 500);
  });
  unread.update(x => x + (n.read ? 0 : 1));
}
export function markRead(ids: string[]) {
  feed.update(arr => arr.map(x => ids.includes(x.id) ? { ...x, read: true } : x));
  unread.set(0);
}
```

---

## 11) í´ë¼ì´ì–¸íŠ¸: SSE êµ¬ë…

```ts
// src/lib/client/sse.ts
import { connected, transport, push } from '$lib/stores/notif';

export function connectSSE(topics: string[], token: string) {
  connected.set('connecting'); transport.set('sse');
  let es: EventSource | null = null;
  let retry = 1000;

  function open() {
    const url = `/api/sse?topics=${encodeURIComponent(topics.join(','))}`;
    // í† í°ì€ ì¿ í‚¤/í—¤ë”ê°€ ê¶Œì¥. SSEëŠ” ì»¤ìŠ¤í…€ í—¤ë” ë¶ˆê°€ â†’ ì¿ í‚¤ ê¸°ë°˜ ì¸ì¦ ì¶”ì²œ
    es = new EventSource(url, { withCredentials: true });

    es.onopen = () => { connected.set('open'); retry = 1000; };
    es.onerror = () => {
      connected.set('error');
      es?.close();
      setTimeout(open, Math.min(retry, 20_000));
      retry *= 2;
    };
    es.addEventListener('push', (e: MessageEvent) => {
      const n = JSON.parse(e.data);
      push(n);
    });
    // bulk, presence, error í•¸ë“¤ëŸ¬ ì¶”ê°€ ê°€ëŠ¥
  }
  open();

  return () => es?.close();
}
```

---

## 12) í´ë¼ì´ì–¸íŠ¸: WebSocket êµ¬ë…(ìë™ ì¬ì—°ê²°)

```ts
// src/lib/client/ws.ts
import { connected, transport, push } from '$lib/stores/notif';

export function connectWS(topics: string[], token: string) {
  connected.set('connecting'); transport.set('ws');
  let ws: WebSocket | null = null;
  let t: any; let hb: any; let retry = 1000;

  function open() {
    ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/api/ws`, ['json']); // subprotocol ì˜ˆì‹œ
    ws.onopen = () => {
      connected.set('open'); retry = 1000;
      ws!.send(JSON.stringify({ type:'hello', token, topics }));
      clearInterval(hb);
      hb = setInterval(()=> ws?.readyState===1 && ws.send(JSON.stringify({ type:'ping' })), 25_000);
    };
    ws.onmessage = (ev) => {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'push') push(msg.data);
      // ack/pong/error/presence ë“± ì¶”ê°€ ì²˜ë¦¬
    };
    ws.onclose = () => {
      connected.set('error');
      clearInterval(hb);
      clearTimeout(t);
      t = setTimeout(open, Math.min(retry, 20_000));
      retry *= 2;
    };
    ws.onerror = () => ws?.close();
  }
  open();

  return () => { clearInterval(hb); clearTimeout(t); ws?.close(); };
}
```

---

## 13) UI ì»´í¬ë„ŒíŠ¸

### 13.1 NotificationBell.svelte
```svelte
<script lang="ts">
  import { unread, connected } from '$lib/stores/notif';
  export let onClick: () => void = () => {};
</script>

<button class="bell" on:click={onClick} aria-label="ì•Œë¦¼">
  ğŸ””
  {#if $unread > 0}
    <span class="badge" aria-live="polite">{$unread}</span>
  {/if}
</button>
<span class="status" aria-live="polite">
  {#if $connected==='open'}â— ì‹¤ì‹œê°„{:else if $connected==='connecting'}â€¦ ì—°ê²°ì¤‘{:else}â—‹ ì˜¤í”„ë¼ì¸{/if}
</span>

<style>
.bell{position:relative}
.badge{position:absolute;top:-6px;right:-6px;background:#ef4444;color:#fff;border-radius:999px;padding:0 .35rem;font-size:.75rem;min-width:1.25rem;text-align:center}
.status{margin-left:.5rem;color:#64748b}
</style>
```

### 13.2 NotificationFeed.svelte
```svelte
<script lang="ts">
  import { feed } from '$lib/stores/notif';
  export let onRead: (ids: string[]) => void = () => {};
</script>

<ul class="feed">
  {#each $feed as n (n.id)}
    <li class:unread={!n.read}>
      <div class="row">
        <strong>{n.title}</strong>
        <small>{new Date(n.ts).toLocaleString()}</small>
      </div>
      <p>{n.body}</p>
      {#if n.meta?.href}
        <a href={n.meta.href} target="_blank" rel="noreferrer">ìì„¸íˆ ë³´ê¸° â†’</a>
      {/if}
    </li>
  {/each}
</ul>
<button on:click={() => onRead($feed.filter(x=>!x.read).map(x=>x.id))}>ëª¨ë‘ ì½ìŒ ì²˜ë¦¬</button>

<style>
.feed{display:grid;gap:.6rem;margin:.6rem 0;padding:0}
.feed li{list-style:none;border:1px solid #e5e7eb;border-radius:12px;padding:.6rem;background:#fff}
.feed li.unread{border-color:#60a5fa;box-shadow:0 0 0 3px rgba(96,165,250,.15)}
.row{display:flex;justify-content:space-between;align-items:center}
</style>
```

### 13.3 ChannelBadge.svelte
```svelte
<script lang="ts">
  export let topic = 'system';
</script>
<span class="chip">{topic}</span>
<style>
.chip{display:inline-block;border-radius:999px;background:#f1f5f9;padding:.1rem .5rem;border:1px solid #e5e7eb;color:#334155}
</style>
```

---

## 14) í˜ì´ì§€ êµ¬ì„±(+page.svelte) â€” ì„ íƒí•œ ì „ì†¡ ë°©ì‹ìœ¼ë¡œ ì—°ê²°

```svelte
<!-- src/routes/+page.svelte (ë°ëª¨ í™ˆ) -->
<script lang="ts">
  import NotificationBell from '$lib/components/NotificationBell.svelte';
  import NotificationFeed from '$lib/components/NotificationFeed.svelte';
  import { markRead } from '$lib/stores/notif';
  import { connectSSE } from '$lib/client/sse';
  import { connectWS } from '$lib/client/ws';
  import { onMount } from 'svelte';

  let disconnect: (() => void) | null = null;
  // ë°ëª¨: ì¸ì¦ í† í°ì€ ì¿ í‚¤ ê¸°ë°˜ì„ ê¶Œì¥. ì—¬ê¸°ì„  ìƒ˜í”Œ ë¬¸ìì—´.
  const token = 'demo-user123';
  const topics = ['system','sales','user:user123'];

  let transport: 'sse'|'ws' = 'sse'; // í† ê¸€í•´ ë³´ì
  onMount(() => {
    disconnect = transport === 'sse' ? connectSSE(topics, token) : connectWS(topics, token);
    return () => disconnect?.();
  });

  function handleRead(ids: string[]) {
    // WSë©´ wsë¡œ ë³´ë‚´ê³ , SSEë©´ RESTë¡œ ë³´ë‚´ëŠ” ì‹ìœ¼ë¡œ êµ¬í˜„(ë°ëª¨ì—ì„  ìŠ¤í† ì–´ë§Œ)
    markRead(ids);
  }
</script>

<header class="bar">
  <select bind:value={transport} on:change={() => (disconnect?.(), disconnect = transport === 'sse' ? connectSSE(topics, token) : connectWS(topics, token))}>
    <option value="sse">SSE</option>
    <option value="ws">WebSocket</option>
  </select>
  <NotificationBell on:click={() => { /* í”¼ë“œ í† ê¸€ ë“± */ }} />
</header>

<h1>ì‹¤ì‹œê°„ ì•Œë¦¼</h1>
<NotificationFeed onRead={handleRead} />

<section class="send">
  <h2>í…ŒìŠ¤íŠ¸ ë°œí–‰</h2>
  <form on:submit|preventDefault={async (e: SubmitEvent) => {
    const fd = new FormData(e.currentTarget as HTMLFormElement);
    const topic = String(fd.get('topic') ?? 'system');
    const now = Date.now();
    const body = {
      id: `n_${now}`,
      topic,
      title: String(fd.get('title') ?? 'ì œëª©'),
      body: String(fd.get('body') ?? 'ë³¸ë¬¸'),
      priority: 'normal',
      ts: now,
      meta: { href: fd.get('href') || '' }
    };
    await fetch('/api/notify', {
      method:'POST',
      headers: { 'content-type':'application/json', authorization: `Bearer demo-user123` },
      body: JSON.stringify(body)
    });
  }}>
    <input name="topic" placeholder="topic (ex: system)" />
    <input name="title" placeholder="title" />
    <input name="body" placeholder="body" />
    <input name="href" placeholder="optional link" />
    <button>ë°œí–‰</button>
  </form>
</section>

<style>
.bar{display:flex;justify-content:flex-end;gap:.5rem;align-items:center}
.send form{display:grid;gap:.4rem;max-width:420px}
</style>
```

---

## 15) WS/SSEì—ì„œ íˆìŠ¤í† ë¦¬ ì ì¬ ì—°ê²°

> **ì¤‘ìš”**: ì‹¤ì „ì—ì„œ **ë°œí–‰ ì‹œ** ì˜ì† ì €ì¥(ì˜ˆ: DB, í)ì„ í•´ë‘ë©´ í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸° ì§„ì… ì‹œ `/api/history`ë¡œ **ìµœê·¼ Nê°œ**ë¥¼ ë°›ì•„ ì¦‰ì‹œ í”¼ë“œë¥¼ ì±„ìš¸ ìˆ˜ ìˆë‹¤. SSE/WS ì—°ê²° ì§í›„ `bulk` ì´ë²¤íŠ¸ë¡œ ì´ˆê¸° ì„¸íŠ¸ë¥¼ ë‚´ë ¤ë„ ëœë‹¤.

- ìœ„ `/api/notify`ì—ì„œ `bus.publish(n)` **ì§í›„** `appendHistory(n)` í˜¸ì¶œì„ ì¶”ê°€í•˜ê±°ë‚˜,  
- WS â€˜emitâ€™ ì²˜ë¦¬ ì‹œ ì´ë¯¸ `appendHistory` í˜¸ì¶œ.

---

## 16) ë°±í”„ë ˆì…” & ë©”ì‹œì§€ ë“œë¡­ ì •ì±…

- **WebSocket**: `ws.bufferedAmount` ê°€ ì„ê³„ì¹˜(ì˜ˆ: 1MB)ë¥¼ ë„˜ìœ¼ë©´ **ë‚®ì€ priority** ë©”ì‹œì§€ë¥¼ ë“œë¡­í•˜ê±°ë‚˜, **ê°€ì¥ ì˜¤ë˜ëœ** íë¥¼ ì œê±°í•œë‹¤.
- **SSE**: HTTP ìŠ¤íŠ¸ë¦¼ì´ë¼ ìì—° ë°±í”„ë ˆì…”ê°€ ê±¸ë¦¬ì§€ë§Œ, ì „ì†¡ ì†ë„ê°€ ë§¤ìš° ëŠë¦° í´ë¼ì´ì–¸íŠ¸ëŠ” **íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì—°ê²° ì¢…ë£Œ** í›„ ì¬ì—°ê²° ì‹œë„í•˜ê²Œ í•œë‹¤.
- **ì„œë²„**: í† í”½ë³„ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì‹œ ê°œë³„ ì†Œì¼“ì˜ ì „ì†¡ ìƒí™©ì„ ê³ ë ¤(ì§€ë‚˜ì¹˜ê²Œ ëŠë¦° ì†Œì¼“ ì •ë¦¬).

---

## 17) ë³´ì•ˆ ì‹¬í™”

1) **ì¸ì¦/ì¸ê°€**  
   - í† í°(JWT/ì„¸ì…˜)ì—ì„œ **ì£¼ì²´(uid)**ì™€ **ê¶Œí•œ(roles)** íŒŒìƒ  
   - í† í”½ ë„¤ì´ë° ê·œì¹™(ì˜ˆ: `user:<uid>` ì±„ë„ì€ **ìê¸° ìì‹ ë§Œ** ì ‘ê·¼) ê°•ì œ  
   - í¼ë¸”ë¦­ í† í”½(`system`)ì€ ì½ê¸°ë§Œ í—ˆìš©, ë°œí–‰ì€ ê´€ë¦¬ìë§Œ

2) **ë ˆì´íŠ¸ ë¦¬ë¯¸íŒ…**  
   - `/api/notify` (ë°œí–‰) IP/uid ë‹¨ìœ„ ì œí•œ  
   - WebSocket `emit`/`subscribe`ì— ì•¡ì…˜ë³„ ë³„ë„ ì œí•œ

3) **ì…ë ¥ ê²€ì¦(Zod)**  
   - ëª¨ë“  ì™¸ë¶€ ì…ë ¥ì€ Zodë¡œ êµ¬ë¬¸Â·ê¸¸ì´ ì œí•œ  
   - HTML/Markdown ë Œë”ë§ ì‹œ XSS ë°©ì§€: **í…ìŠ¤íŠ¸ë§Œ** í‘œì‹œ, ë§í¬ rel ì†ì„±

4) **CORS/Origin**  
   - ë™ì¼ ì¶œì²˜ ê¶Œì¥. í•„ìš” ì‹œ CORS í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸  
   - WebSocketì€ `Origin` ê²€ì‚¬, SSEëŠ” ì¿ í‚¤ ìê²©ì¦ëª… ì‚¬ìš© ì‹œ `SameSite` ì •ì±… í™•ì¸

5) **ì „ì†¡ ì•”í˜¸í™”**  
   - ë°˜ë“œì‹œ HTTPS/WSS

---

## 18) í™•ì¥: ë©€í‹° ì¸ìŠ¤í„´ìŠ¤(ìˆ˜í‰ í™•ì¥)

- **Redis Pub/Sub**  
  - ê° ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ë¡œì»¬ ì—°ê²°ì„ ê´€ë¦¬  
  - ë°œí–‰ ì‹œ Redisì— publish â†’ ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆ˜ì‹ í•˜ì—¬ **ìì‹ ì—ê²Œ ë¶™ì€** í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸  
- **Presence(ì¡´ì¬ê°ì§€)**  
  - í† í”½ë³„ ì¹´ìš´íŠ¸ëŠ” ë¡œì»¬ + Redis `INCR/DECR` ë˜ëŠ” `SET`ë¡œ **ì „ì—­ í•©ì‚°**  
  - ì£¼ê¸°ì ìœ¼ë¡œ ì¡°ì •(ìœ ì‹¤ ëŒ€ë¹„)

---

## 19) ì¥ì• /ë„¤íŠ¸ì›Œí¬ ê³ ë ¤

- **í•˜íŠ¸ë¹„íŠ¸**  
  - WS: ping/pong 20~30ì´ˆ ê°„ê²©. **ë¯¸ì‘ë‹µ** ì‹œ ì¢…ë£Œ  
  - SSE: 20ì´ˆë§ˆë‹¤ `:` ì£¼ì„ ë¼ì¸ ë˜ëŠ” dummy event  
- **ì¬ì—°ê²°**: ì§€ìˆ˜ ë°±ì˜¤í”„(ìµœëŒ€ 20ì´ˆ), **Jitter** ì¶”ê°€ ì¶”ì²œ  
- **ë©”ì‹œì§€ ìˆœì„œ**: ë‹¨ì¼ í† í”½ ë‚´ì—ì„œëŠ” `ts` ê¸°ì¤€ ì •ë ¬ë¡œ ì •í•©ì„± ìœ ì§€  
- **ë¦¬í”Œë ˆì´**: `Last-Event-ID`(SSE) í™œìš© ì‹œ ìœ ì‹¤ ë³µì› ê°€ëŠ¥(ì—¬ê¸°ì„  ë‹¨ìˆœí™”)

---

## 20) ì„±ëŠ¥

- **JSON í¬ê¸°** ìµœì†Œí™”(í•„ë“œëª… ì§§ê²Œ/ë¶ˆí•„ìš” ë°ì´í„° ì œê±°)  
- **í† í”½ ë¶„ë¦¬**: ê³ ë¹ˆë„ì™€ ì €ë¹ˆë„ ì±„ë„ ë¶„ë¦¬ â†’ ì €ë¹ˆë„ êµ¬ë…ìì—ê²Œ ê³ ë¹ˆë„ ìŠ¤íŒ¸ íšŒí”¼  
- **ë°°ì¹˜ ì „ì†¡**: ë°€ë¦¬ì´ˆ ë‹¨ìœ„ë¡œ ìŸì•„ì§€ëŠ” ì´ë²¤íŠ¸ëŠ” **10~100ms** ìœˆë„ìš°ë¡œ ë¬¶ì–´ `bulk`ë¡œ ì „ì†¡  
- **GC ì••ë ¥**: ëŒ€í˜• ë©”ì‹œì§€ëŠ” **ë§í¬**ë§Œ ë³´ë‚´ê³ , ìƒì„¸ëŠ” RESTë¡œ ê°€ì ¸ì˜¤ê¸°

---

## 21) í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

1. **ì´ˆê¸° ì—°ê²°**(SSE/WS): `hello` ìˆ˜ì‹ , ìƒíƒœ `open` ì „í™˜  
2. `/api/notify` í˜¸ì¶œ â†’ í”¼ë“œì— ì¦‰ì‹œ í‘œì‹œ(í•´ë‹¹ í† í”½ êµ¬ë…ìë§Œ)  
3. **ì½ìŒ ì²˜ë¦¬**: ë²„íŠ¼ í´ë¦­ â†’ badge 0  
4. **ì¬ì ‘ì†**: ì„œë²„ ê°•ì œ ì¬ì‹œì‘/ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ â†’ ì¬ì—°ê²° ë™ì‘  
5. **ë ˆì´íŠ¸ ë¦¬ë¯¸íŠ¸**: 1ë¶„ 60íšŒ ì´ìƒ ë°œí–‰ â†’ 429  
6. **ê¶Œí•œ**: `user:other` í† í”½ ë°œí–‰/êµ¬ë… ì‹œë„ â†’ ì°¨ë‹¨

---

## 22) ë°°í¬ ê°€ì´ë“œ

- **SSE ì „ìš©(ì„œë²„ë¦¬ìŠ¤/ì—ì§€)**: Vercel/Netlify/Cloudflareì—ì„œ ë™ì‘ ì‰¬ì›€  
- **WebSocket(ë…¸ë“œ ëŸ°íƒ€ì„)**: `adapter-node` + PM2/Docker. L4(ë¡œë“œë°¸ëŸ°ì„œ)ì—ì„œ **ìŠ¤í‹°í‚¤ ì„¸ì…˜** í•„ìš”  
- **ë©€í‹° ë¦¬ì „**: Redis Global/Upstash, ë˜ëŠ” ì§€ì—­ë³„ í´ëŸ¬ìŠ¤í„° + Edge ë¼ìš°íŒ…  
- **í”„ë¡ì‹œ**: Nginx/Haproxyì—ì„œ `upgrade` í—¤ë” ì „ë‹¬ ì„¤ì •

---

## 23) ë¶€ë¡: ìˆ˜í•™/ì§€í‘œ ì •ì˜ (ì„ íƒ)

ì•Œë¦¼ ì „ë‹¬ ì„±ê³µë¥ :  
$$
\mathrm{DeliveryRate} = \frac{\text{Delivered}}{\text{Published}}
$$

í‰ê·  ì§€ì—°:  
$$
\mathrm{Latency}_{avg} = \frac{1}{N}\sum_{i=1}^N (t_{client,i} - t_{server,i})
$$

> ëª¨ë‹ˆí„°ë§ ì‹œ ìœ„ ì§€í‘œë¥¼ ë¡œê·¸ ê¸°ë°˜ìœ¼ë¡œ ì‚°ì¶œí•´ ëŒ€ì‹œë³´ë“œì— í‘œì‹œí•œë‹¤.

---

## 24) ìš”ì•½ & ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] **ì „ì†¡ ë ˆì´ì–´**: WS(ì–‘ë°©í–¥) + SSE(ë‹¨ë°©í–¥) ë‘˜ ë‹¤ êµ¬í˜„  
- [x] **ë²„ìŠ¤**: InMemory/Redisë¡œ ë¸Œë¡œë“œìºìŠ¤íŠ¸  
- [x] **API**: `/api/notify` ë°œí–‰, `/api/history` ì´ˆê¸° ë¡œë“œ  
- [x] **í´ë¼ ìŠ¤í† ì–´/UI**: ë±ƒì§€/í”¼ë“œ/ì½ìŒ/ì—°ê²°ìƒíƒœ  
- [x] **íšŒë³µë ¥**: ì¬ì—°ê²°, í•˜íŠ¸ë¹„íŠ¸, ë°±í”„ë ˆì…”  
- [x] **ë³´ì•ˆ**: í† í°, ê¶Œí•œ, ë ˆì´íŠ¸ ë¦¬ë¯¸íŠ¸, ê²€ì¦  
- [x] **ë°°í¬**: ì„œë²„ë¦¬ìŠ¤(SSE)/ë…¸ë“œ(WS) ì„ íƒ

---

## 25) ë¹ ë¥¸ ì‹œì‘(ìš”ì•½ ì½”ë“œ ìˆœì„œ)

1. `pnpm add ws zod`  
2. `lib/schema/notif.ts`, `lib/server/bus.ts`, `lib/server/auth.ts` ìƒì„±  
3. `routes/api/notify/+server.ts`, `routes/api/history/+server.ts` ìƒì„±  
4. `routes/api/sse/+server.ts` (SSE), `routes/api/ws/+server.ts` (WS) ìƒì„±  
5. í´ë¼: `stores/notif.ts`, `client/sse.ts`, `client/ws.ts`  
6. UI: `NotificationBell.svelte`, `NotificationFeed.svelte`  
7. í™ˆ í˜ì´ì§€ì—ì„œ ì ‘ì†/ë°œí–‰ í…ŒìŠ¤íŠ¸
