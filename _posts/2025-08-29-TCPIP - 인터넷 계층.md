---
layout: post
title: TCPIP - 인터넷 계층
date: 2025-08-29 17:25:23 +0900
category: TCPIP
---
# 3. IP(인터넷 계층, L3) 핵심  

> 이 글은 IP 계층의 **주소·서브넷·라우팅**부터 **IPv6의 핵심 개념**, 그리고 **프래그멘테이션/PMTUD, TTL, DSCP/ECN, 멀티캐스트**까지 **실무 예제와 관찰 포인트** 중심으로 정리합니다.  
> 코드 대신 **표/다이어그램/수치**에 집중합니다. 수식은 MathJax로 표기합니다.

---

## 3.1 왜 L3가 중요한가
- L7(앱)에서 보이는 **지연/타임아웃/세션 끊김**의 상당수는 L3의 **경로·MTU/PMTUD·정책** 문제로 귀결됩니다.
- “**최단 경로가 아니라 정책 경로**”라는 점(BGP/정책라우팅)에 유의해야 합니다.
- **IPv4·IPv6 이중 스택** 시대에는 두 스택의 **주소·라우팅·MTU·ICMP** 동작 차이를 동시에 고려해야 합니다.

---

## 3.2 IPv4 주소, 서브넷, CIDR, 사설/공인, 라우팅 기본 (🔰)

### 3.2.1 IPv4 주소와 서브넷 마스크
- **IPv4**: 32비트 주소, `a.b.c.d` 4옥텟로 표기(예: `203.0.113.25`).
- **서브넷 마스크**: 네트워크/호스트 영역을 나눔.  
  예: `255.255.255.0` = `/24` = `11111111.11111111.11111111.00000000`.
- **CIDR 표기**: `주소/프리픽스길이` (예: `192.0.2.10/24`).

#### 호스트 수 계산
\[
\text{사용 가능한 호스트 수} = 2^{(32-\text{프리픽스})} - 2
\]
- 예: `/24` → \(2^{8} - 2 = 254\) (네트워크/브로드캐스트 제외)

#### 예제 A — “/26으로 나누기”
```
주어진 대역: 192.0.2.0/24
/26으로 4개 서브넷 만들기:
1) 192.0.2.0/26    호스트: 62, 범위: .1 ~ .62, 브로드캐스트: .63
2) 192.0.2.64/26   호스트: 62, 범위: .65 ~ .126, 브로드캐스트: .127
3) 192.0.2.128/26  호스트: 62, 범위: .129 ~ .190, 브로드캐스트: .191
4) 192.0.2.192/26  호스트: 62, 범위: .193 ~ .254, 브로드캐스트: .255
```

### 3.2.2 사설/공인 IP, CGNAT
- **사설 IPv4**(RFC 1918): `10.0.0.0/8`, `172.16.0.0/12`, `192.168.0.0/16`  
- **공인 IPv4**: 인터넷에 광고/라우팅되는 주소(전세계 유일).  
- **CGNAT(대규모 NAT)**: `100.64.0.0/10` 대역을 사용, 통신사/대규모 네트워크에서 사설↔공인의 다단 변환에 활용.

#### 예제 B — “사무실망 기본 구조”
```
단말(사설 192.168.10.0/24) → 게이트웨이(NAT) → 공인 IP → ISP
증상: 외부에서 사설 단말로 직접 접속 불가 → 포트포워딩 or VPN 필요
```

### 3.2.3 라우팅 기본: **Longest Prefix Match(최장 일치)**
- 라우터는 **여러 경로 중 프리픽스가 가장 긴**(가장 구체적인) 경로를 선택.
- **정적 라우팅**: 관리자가 수동 설정.  
- **동적 라우팅**: OSPF/IS-IS(내부), BGP(외부) 등 프로토콜로 경로 학습.

#### 예제 C — “경로 선택”
```
라우팅 테이블:
0) 0.0.0.0/0 → ISP    (기본)
1) 203.0.113.0/24 → R1
2) 203.0.113.64/26 → R2

목적지 203.0.113.70 → 1)와 2) 둘 다 매치
- /26가 /24보다 프리픽스가 길다 → R2로 포워드 (가장 구체적)
```

### 3.2.4 VLSM(가변 길이 서브넷) & 설계 팁
- 서비스 크기에 맞춰 `/28`, `/26`, `/24` 등 **필요한 만큼만** 배분.
- **요구 호스트 수**와 **성장 여지**, **브로드캐스트 규모**, **보안 경계**를 함께 고려.

---

## 3.3 IPv6 주소 체계, 축약 표기, 링크로컬, 멀티캐스트 (🔰)

### 3.3.1 IPv6 주소 기초
- **IPv6**: 128비트 주소, 16진수 4자리(=16비트) 묶음 8개를 `:`로 구분.  
  예: `2001:0db8:0000:0000:0000:0000:0000:0001`
- **축약 표기**  
  - **선행 0 생략**: `0db8` → `db8`  
  - **연속 0 묶음을 `::` 한 번만**: `2001:db8::1` (가장 긴 0 구간 1회 축약)

> **주의**: `::`는 **한 번만** 사용 가능(몇 비트가 0인지 애매해지지 않도록).

### 3.3.2 주요 주소 유형
- **글로벌 유니캐스트**: `2000::/3` (전세계 라우팅 대상)  
- **링크로컬**: `fe80::/10` (링크 내부, 라우팅되지 않음)  
- **루프백**: `::1/128`  
- **멀티캐스트**: `ff00::/8` (범위 스코프 존재)  
- **ULA(고유 로컬)**: `fc00::/7` (사설 IPv6 유사, 전세계 라우팅 X)

### 3.3.3 링크로컬( fe80::/10 )의 중요성
- **라우팅 없이도** 같은 링크에서 **NDP(Neighbor Discovery), SLAAC** 등 기본 기능 수행.
- 인터페이스마다 자동 생성되며, 동일 호스트 내 인터페이스를 구분하려면 **존 식별자**(예: `%eth0`)를 사용하기도 함.

### 3.3.4 SLAAC(Stateless Address Autoconfiguration) & NDP
- **라우터 광고(RA)**를 받아 프리픽스/기본 게이트웨이 정보 획득.  
- **호스트는 자체 인터페이스 식별자**(랜덤/실리콘ID 기반)로 주소 완성.  
- **DAD(Duplicate Address Detection)**로 충돌 방지.
- **NDP**: ARP의 IPv6 버전(멀티캐스트 기반). 이웃의 MAC을 알아내거나 라우터를 찾음.

### 3.3.5 멀티캐스트(IPv6) 기초
- `ff0s::/8`(s=스코프):  
  - `ff02::1`(링크 로컬 모든 노드), `ff02::2`(모든 라우터)  
  - **Solicited-Node**: `ff02::1:ffXX:XXXX` (NDP에서 이웃 탐색 최적화)
- IPv6는 브로드캐스트 개념이 없고 **필수 멀티캐스트**를 활용.

#### 예제 D — “Solicited-Node 멀티캐스트”
```
호스트 주소: 2001:db8:1::abcd:1234
Solicited-Node: ff02::1:ffcd:1234
NDP는 이 그룹을 대상으로 질의해 '정확히 필요한 이웃'만 깨우도록 최적화
```

---

## 3.4 프래그멘테이션, PMTUD, TTL, DSCP/ECN, 멀티캐스트 개념 (⚙️)

### 3.4.1 프래그멘테이션(IPv4) vs IPv6의 차이
- **IPv4**: 중간 라우터가 **프래그멘트(분할)** 가능.  
  - 헤더 필드: **Identification**, **Flags(DF/MF)**, **Fragment Offset**  
  - `DF=1`이면 라우터는 분할하지 않고 **ICMP Frag Needed**를 보냄(경로 MTU 알림).
- **IPv6**: **중간 라우터 분할 금지**. 발신자/종단만 **Fragmentation Header**로 분할 가능.  
  - 대신 **ICMPv6 Packet Too Big**으로 경로 MTU를 알리고, **발신자**가 재조정.

#### 예제 E — “큰 응답만 뚝 끊김 (PMTUD 블랙홀)”
```
현상: JSON/작은 파일 OK, 큰 이미지/다운로드 Hang
원인: 경로 중간 MTU가 낮음 + ICMP(Frag Needed/Too Big) 차단
결과: 발신자가 MTU를 낮추지 못함 → 계속 큰 패킷 전송 → Drop
해결: ICMP 정상화, PLPMTUD(Probe), TCP MSS 클램핑, 경로 MTU 표준화
```

### 3.4.2 PMTUD/PLPMTUD
- **PMTUD(Path MTU Discovery)**: ICMP 메시지로 경로 MTU 파악.  
- **PLPMTUD(Packetization Layer PMTUD)**: 트랜스포트/상위 레이어가 **능동적으로** 패킷 크기를 조절/탐색(ICMP 의존 완화).

> **실무 팁**: 오버레이(VXLAN/GRE/ERSPAN), 태깅(QinQ/MPLS) 등 **헤더 누적**을 고려해 **MTU 표준값**을 정하고, **엣지에서 MSS 클램핑**으로 안전판을 두는 전략이 흔함.

### 3.4.3 TTL(IPv4) / Hop Limit(IPv6)
- **패킷 생존 한계**: 라우터 통과 시마다 **1씩 감소**, 0이 되면 폐기.  
- 루프 방지 및 **경로 길이/진단**에 활용(Traceroute는 TTL/Hop Limit를 활용).

#### 예제 F — “TTL과 경로 추적”
```
TTL=1 → 1번째 라우터에서 Time Exceeded(ICMP) 응답
TTL=2 → 2번째 라우터 응답 ...
→ 홉별 응답으로 '경로 지도' 확보
```

### 3.4.4 DSCP/ECN — QoS/혼잡 신호
- **DSCP**(Differentiated Services Code Point): 서비스 품질 구분을 위한 6비트 필드.  
  - 예) **EF(Expedited Forwarding)**, **AF** 클래스, **CS0(기본)** 등  
  - 네트워크 정책에 따라 **큐/우선순위/드롭 정책**이 달라짐.
- **ECN**(Explicit Congestion Notification): 혼잡 시 패킷을 **드롭하지 않고** 혼잡을 **표시(ECE/CE)**해 송신자가 전송률을 낮추도록 유도.

> **주의**: 도메인 경계를 넘으면 DSCP/ECN을 **클리어하거나 재마킹**할 수 있음. 엔드—엔드 QoS 보장은 **도메인 간 합의/계약**이 필요.

### 3.4.5 IP 멀티캐스트 개념(IPv4/IPv6 공통)
- **한 번 송신 → 다수 수신**을 네트워크에서 복제해 **대역폭 효율** 향상(스트리밍, 마켓 데이터, 실시간 방송).
- **IPv4 멀티캐스트**: `224.0.0.0/4`  
  - 링크 로컬(224.0.0.x), 관리 범위(239.0.0.0/8) 등  
  - **IGMP**(호스트가 그룹 가입/탈퇴 신호) + **PIM**(라우터 간 분산: Sparse/Dense/SSM).
- **IPv6 멀티캐스트**: `ff00::/8` + **MLD**(IGMP 유사).

#### ASM vs SSM
- **ASM(Any-Source Multicast)**: ( \*, G ) — 소스가 여럿일 수 있음. RP(중앙점) 설계 필요.  
- **SSM(Source-Specific Multicast)**: ( S, G ) — **특정 소스만** 구독. 설계 단순, 보안·정책 유리.

---

## 3.5 관찰 포인트·체크리스트(현장 카드)

### 3.5.1 주소/서브넷
```text
- 프리픽스/마스크: 올바른지 (게이트웨이와 대역 일치)
- 브로드캐스트 크기(IPv4): 과대/과소 설계 여부
- IPv6 축약: 일관성 유지 (문서/모니터링 포맷 통일)
```

### 3.5.2 라우팅
```text
- 최장일치 동작 확인: 특정 목적지가 의도한 경로로 가는가?
- 대체 경로/백업: 수렴 시간, 정책 충돌(BGP LocalPref/AS-Path) 체크
- 비대칭 경로: 역방향이 다른 경우 디버깅/보안 장비 영향
```

### 3.5.3 MTU/PMTUD
```text
- 오버레이/태깅 포함 실효 MTU 계산
- ICMP Frag Needed/Too Big 정상 통과 여부
- PLPMTUD/TCP MSS 클램핑 적용 여부
```

### 3.5.4 IPv6 특화
```text
- 라우터 광고(RA)/SLAAC 타이밍, DAD 실패 로그
- NDP 캐시, Solicited-Node 멀티캐스트 동작
- 듀얼스택: Happy Eyeballs로 서로 다른 경로/지연 비교
```

### 3.5.5 DSCP/ECN/QoS
```text
- 도메인 경계 재마킹/클리어 여부
- 큐 드롭/지연 지표(모니터링)와 DSCP 클래스 상관
- ECN 마킹율, 송신자 혼잡 대응(스택/애플리케이션) 확인
```

---

## 3.6 미니 실습(의도 중심)

### 3.6.1 “CIDR·VLSM 손 연습”
```text
의도: 필요한 호스트 수에 맞춘 VLSM 설계
절차: 300/120/50/20 호스트 네트워크에 /23, /25, /26, /27 등으로 배분
결과: 주소 낭비 최소화·브로드캐스트 도메인 규모 최적화
```

### 3.6.2 “Longest Prefix Match 체감”
```text
의도: 구체 경로가 기본 경로보다 우선됨을 체험
절차: /0, /24, /26 경로를 넣고 동일 목적지 트래픽을 유도
관찰: /26 → /24 → /0 우선순위로 선택
```

### 3.6.3 “PMTUD 블랙홀 재현·해결”
```text
의도: 큰 응답 끊김을 MTU/ICMP 문제로 연결
절차: DF 세팅 큰 패킷 전송 → ICMP 수신 여부 확인 → MSS 클램핑 적용
결과: ICMP 차단 시 Hang, MSS 클램핑/PLPMTUD 후 정상
```

### 3.6.4 “IPv6 NDP·SLAAC 관찰”
```text
의도: IPv6의 ARP 부재와 멀티캐스트 기반 이웃발견 이해
절차: RA 수신, 주소 자동구성, DAD 성공/실패 로그 확인
결과: 링크로컬/글로벌 주소 동작, Solicited-Node 그룹 트래픽 확인
```

### 3.6.5 “DSCP/ECN 효과 보기(개념)”
```text
의도: 혼잡하에서 드롭 대신 ECN 마킹이 동작하는지 관찰
절차: 큐 임계치 하향, ECN 활성 링크에 유량 가중 → 마킹율/처리량/지연 비교
결과: 마킹↑, 드롭↓, 트랜스포트 전송률 조정 확인
```

---

## 3.7 수식·숫자 감각 보충

### 3.7.1 호스트 수·서브넷 수
\[
\text{호스트 수(IPv4)} = 2^{(32-\text{프리픽스})} - 2
\quad
\text{서브넷 수} = 2^{(\text{차용 비트})}
\]

### 3.7.2 경로 선택 — 최장일치
\[
\text{선택 경로} = \arg\max_{r \in \mathcal{R}}(\text{prefix\_length}(r))
\quad \text{s.t. 목적지} \in r
\]

### 3.7.3 MTU와 MSS
\[
\text{MSS} \approx \text{MTU} - (\text{IP 헤더} + \text{TCP 헤더} + \text{옵션/오버레이})
\]
→ 오버레이/태깅이 늘수록 **MSS 감소** → **분할/드롭 위험 증가**.

---

## 3.8 운영 베스트 프랙티스

- **주소계획 문서화**: IPv4·IPv6, 서브넷·게이트웨이·VLAN 매핑 일람표 유지.
- **듀얼스택 운영**: IPv6 우선 정책/Happy Eyeballs에 대비한 **로그·모니터링** 분리.
- **MTU 표준화**: 오버레이 포함 실효 MTU 기준 수립, **MSS 클램핑** 정책 전파.
- **ICMP 정책**: PMTUD 필수 메시지(`Frag Needed`, `Packet Too Big`)는 **허용**.
- **라우팅 변경관리**: 정적/동적 라우팅 수정 시 윈도우 설정/수렴 시간/플랩 알람 확인.
- **QoS**: DSCP/ECN 설계는 **도메인 경계** 계약/문서화와 함께. 임의 재마킹 방지.

---

## 3.9 한 장 요약(포스터 버전)

- **IPv4**: 32비트, CIDR/VLSM로 유연 분할. 사설↔공인, CGNAT 고려. **최장일치**로 경로 결정.  
- **IPv6**: 128비트, 축약/링크로컬/SLAAC/NDP/필수 멀티캐스트. 브로드캐스트 없음.  
- **프래그멘테이션/PMTUD**: v4=라우터도 분할 가능, v6=종단만. ICMP 차단 시 **블랙홀**.  
- **TTL/Hop Limit**: 홉마다 감소, 루프 방지·경로 진단(Traceroute).  
- **DSCP/ECN**: QoS 구분/혼잡 신호. 도메인 경계 재마킹 주의.  
- **멀티캐스트**: IGMP/MLD + PIM/SSM. 다수 송수신을 효율적으로.

---

### 부록 A — IPv4 주소 대역 메모
```text
사설: 10.0.0.0/8 | 172.16.0.0/12 | 192.168.0.0/16
CGNAT: 100.64.0.0/10
루프백: 127.0.0.0/8
링크로컬: 169.254.0.0/16
문서용: 192.0.2.0/24, 198.51.100.0/24, 203.0.113.0/24
멀티캐스트: 224.0.0.0/4 (링크로컬 224.0.0.x, 사설 239.0.0.0/8)
```

### 부록 B — IPv6 주소 대역 메모
```text
글로벌: 2000::/3
링크로컬: fe80::/10
루프백: ::1/128
ULA: fc00::/7
멀티캐스트: ff00::/8 (ff02::1 모든 노드, ff02::2 모든 라우터)
Solicited-Node: ff02::1:ffXX:XXXX
문서용: 2001:db8::/32
```

### 부록 C — 관찰 템플릿
```text
[날짜/구간] 사내-L3GW/엣지-ISP/인터넷-오리진
[증상] 작은 요청 OK, 큰 응답 Hang / IPv4 OK, IPv6 느림 / 특정 경로 타임아웃
[L3 가설] PMTUD 블랙홀, 최장일치 우선 경로, 비대칭 경로, DSCP 재마킹
[근거] ICMP Too Big/Frag Needed, 라우팅 테이블/트레이스, RTT/손실, DSCP/ECN 통계
[조치] MSS 클램핑, 경로/정책 수정, ICMP 허용, QoS 재설계
[결과/후속] 복구 시간, 표준 MTU/주소계획/모니터링 룰 업데이트
```