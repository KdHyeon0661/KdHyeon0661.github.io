---
layout: post
title: AWS - 서비스별 비용 구조와 절감 팁
date: 2025-08-08 22:20:23 +0900
category: AWS
---
# 서비스별 비용 구조와 절감 팁

## 0. 공통 원칙 — “보이는 만큼 줄일 수 있다”
1) **측정 우선**: CloudWatch(메트릭) + CUR(Athena) + Cost Explorer(Forecast/Anomaly)로 *요청 수·바이트·연결 수*를 매일 집계.
2) **모형화**: 서비스별 과금 항목을 변수화해 **월 추정 비용**을 산출(아래 수식·코드 제공).
3) **레버 선택**: 캐시율, 엔드포인트 타입, 라우팅·룰 복잡도, NAT 회피, 엔드포인트 수, 리전/리소스 배치로 절감.
4) **가드레일**: 태그·SCP·Budgets·Anomaly Detection·자동정리로 “늘 같은 습관”을 만든다.

---

## 1. VPC Endpoint — **Gateway vs Interface(PrivateLink)**

### 1.1 과금 포인트
- **Gateway Endpoint** (S3/DynamoDB 전용): **엔드포인트 비용 없음**(라우트 테이블에 엔드포인트 추가).
- **Interface Endpoint(PrivateLink)**: **엔드포인트 시간 요금(ENI × AZ)** + **데이터 처리(GB)**.

### 1.2 비용 모델(개념식)
- 게이트웨이 엔드포인트(무료)로 NAT·인터넷 경유를 줄일 때, 대안인 NAT의 시간·GB 요금을 함께 비교해야 한다.
- 인터페이스 엔드포인트의 월 비용은:
$$
\text{Cost}_{\text{IE}} \approx \left(N_{\text{az}} \times r_{\text{hour}}\right)\times H + \left(B_{\text{GB}} \times r_{\text{GB}}\right)
$$
- NAT 경유 대비 절감 가설:
$$
\Delta \text{Cost} \approx \text{Cost}_{\text{NAT(hour,GB)}} - \text{Cost}_{\text{IE or GW}} \quad(\text{단, GW는 보통 0})
$$

### 1.3 IaC 예제

**Gateway Endpoint (S3) — CloudFormation**
```yaml
AWSTemplateFormatVersion: '2010-09-09'
Resources:
  S3GatewayEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      ServiceName: !Sub com.amazonaws.${AWS::Region}.s3
      RouteTableIds: [rtb-aaaa, rtb-bbbb]  # 퍼블릭이 아닌 프라이빗 라우팅 테이블
      VpcId: vpc-123456
      VpcEndpointType: Gateway
```

**Interface Endpoint(예: Secrets Manager) — CloudFormation**
```yaml
Resources:
  SecretsInterfaceEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      ServiceName: !Sub com.amazonaws.${AWS::Region}.secretsmanager
      SubnetIds: [subnet-azA, subnet-azB]
      SecurityGroupIds: [sg-endpoint]
      VpcId: vpc-123456
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
```

**엔드포인트 정책으로 접근 제한(예: 특정 S3 버킷 전용)**
```json
{
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": "*",
      "Action": ["s3:GetObject","s3:PutObject","s3:ListBucket"],
      "Resource": [
        "arn:aws:s3:::team-artifacts",
        "arn:aws:s3:::team-artifacts/*"
      ],
      "Condition": { "StringEquals": { "aws:SourceVpce": "vpce-0abc..." } }
    }
  ]
}
```

### 1.4 절감 체크리스트
- [ ] **S3/DynamoDB는 Gateway Endpoint**로 NAT 회피(대량 트래픽일수록 효과 큼).
- [ ] Interface Endpoint는 **필요한 서비스만, AZ당 1개 원칙**(과도한 AZ/계정 간 공유는 전송비 역효과 가능).
- [ ] **중앙 VPC(Shared Services) 집결** 시 Cross-VPC/AZ 전송비도 함께 시뮬레이션.

---

## 2. CloudFront — **캐시 히트율 = Origin egress 비용의 핵심**

### 2.1 과금 포인트
- **전송(GB)** + **요청 수(HTTP/HTTPS)** + 기능(Invalidation 등).
- 비용을 좌우하는 것은 **Origin 왕복**(miss). 캐시 히트율이 높을수록 **Origin egress↓**.

### 2.2 비용 모델(개념식)
- 총 요청 \(Q\), 캐시 히트율 \(h\), 평균 객체 크기 \(S\)(bytes), 엣지→클라이언트 전송단가 \(p_e\), Origin egress 단가 \(p_o\).
$$
\begin{aligned}
Q_{\text{miss}} &= Q\cdot(1-h) \\
B_{\text{origin}} &= Q_{\text{miss}}\cdot S \\
\text{Cost}_{\text{CF}} &\approx (Q\cdot p_{\text{req}}) + (B_{\text{edge}}\cdot p_e) + (B_{\text{origin}}\cdot p_o) + \text{etc.}
\end{aligned}
$$
- **핵심**: \(h\uparrow \Rightarrow Q_{\text{miss}}\downarrow \Rightarrow B_{\text{origin}}\downarrow\).

### 2.3 캐시 최적화 실전 팁
- **Cache Key 최소화**: 쿼리·헤더·쿠키 중 캐싱에 불필요한 요소 제외.
- **TTL/버전링**: 정적 리소스는 긴 TTL + 파일명 해시로 배포(Invalidation 최소화).
- **압축**: Gzip/Brotli 활성화.
- **Origin Shield**(Regional Cache)로 멀티 엣지 미스의 Origin 집중 요청 감소.
- **OAC(OAI)**: S3 오리진 보안 + 캐싱 유지.

### 2.4 IaC 예제

**CloudFront with S3 + OAC — Terraform**
```hcl
resource "aws_cloudfront_origin_access_control" "oac" {
  name                              = "s3-oac"
  origin_access_control_origin_type = "s3"
  signing_behavior                  = "always"
  signing_protocol                  = "sigv4"
}

resource "aws_cloudfront_distribution" "cdn" {
  enabled             = true
  default_root_object = "index.html"

  origin {
    domain_name              = aws_s3_bucket.site.bucket_regional_domain_name
    origin_id                = "s3-origin"
    origin_access_control_id = aws_cloudfront_origin_access_control.oac.id
  }

  default_cache_behavior {
    target_origin_id       = "s3-origin"
    viewer_protocol_policy = "redirect-to-https"
    allowed_methods        = ["GET","HEAD"]
    cached_methods         = ["GET","HEAD"]

    compress = true

    forwarded_values {
      query_string = false
      headers      = []
      cookies { forward = "none" }
    }
    min_ttl     = 0
    default_ttl = 3600
    max_ttl     = 86400
  }

  viewer_certificate { cloudfront_default_certificate = true }
}
```

**액세스 로그 분석으로 캐시 히트율 산출 — Athena**
```sql
-- CloudFront 표준 로그 테이블(cf_logs)에서 히트율 계산
SELECT
  date(time) AS d,
  SUM(CASE WHEN x_edge_result_type IN ('Miss','OriginShieldHit') THEN 1 ELSE 0 END) AS miss,
  COUNT(*) AS total,
  1.0 - SUM(CASE WHEN x_edge_result_type IN ('Miss','OriginShieldHit') THEN 1 ELSE 0 END)/COUNT(*) AS hit_rate
FROM cf_logs
WHERE time BETWEEN timestamp '2025-11-01 00:00:00' AND timestamp '2025-12-01 00:00:00'
GROUP BY 1
ORDER BY 1;
```

---

## 3. Global Accelerator — **Anycast + 전용 백본(성능/가용성 대가)**

### 3.1 과금 포인트
- **고정 시간 요금(Accelerator-hour)** + **데이터 전송 프리미엄(GB)** + 표준 데이터 전송.
- 프로비저닝 자체로 시간 요금이 발생(켜둔 채 유휴면 손해).

### 3.2 비용 모델(개념식)
$$
\text{Cost}_{\text{GA}} \approx r_{\text{acc/hr}}\cdot H + r_{\text{dtprem}}\cdot GB_{\text{dom}} + \text{DataTransfer}_{\text{std}}
$$
- \(GB_{\text{dom}}\): 지배적 방향(엣지→리전/리전→엣지) 전송량.

### 3.3 선택 기준(대안과 비교)
- 다음 조건 *동시에* 충족 시 적합:
  1) **글로벌 사용자** 분포 + **저지연/고가용성**에 민감,
  2) **Anycast 단일 IP**가 운영상 가치,
  3) CloudFront 캐시가 주해결책이 아닌 **TCP/UDP 실시간 트래픽**.
- 대안: **CloudFront + Route 53 LBR + Regional ALB**로 충분히 커버되면 비용상 유리.

---

## 4. NLB — **L4 초고성능/저지연, 대량 연결/바이트에 강함**

### 4.1 과금 포인트
- **시간(또는 LCU/NLCU 유닛) + 처리 바이트/연결 지표**.
- 초당 대량 연결·UDP/TCP·정적 IP 필요 시 선택.

### 4.2 비용 모델(개념식)
- 공급자 문서 기준, NLB/ALB는 각각의 “용량 유닛” 기준을 갖는다(처리 바이트·신규/활성 연결·룰평가 등).
- 개념화:
$$
\text{Cost}_{\text{NLB}} \approx r_{\text{hour}}\cdot H + r_{\text{NLCU}}\cdot \max\{\phi_B,\ \phi_{\text{new}},\ \phi_{\text{active}}\}
$$
- \(\phi\) 들은 각 축의 사용량을 유닛으로 환산한 값(자세한 환산은 공식 문서 기준).

### 4.3 CloudWatch로 추정 LCU 계산(샘플)
```python
# NLB 유사 지표 수집 후 NLCU 최대축으로 근사(예시 코드)
import boto3, datetime
cw = boto3.client('cloudwatch')
end = datetime.datetime.utcnow(); start = end - datetime.timedelta(hours=1)

metrics = {
  'ProcessedBytes': {'name':'ProcessedBytes', 'stat':'Sum'},
  'NewFlowCount':   {'name':'NewFlowCount',   'stat':'Sum'},
  'ActiveFlowCount':{'name':'ActiveFlowCount','stat':'Maximum'}
}
def get(mname,stat):
  return cw.get_metric_statistics(
    Namespace='AWS/NetworkELB', MetricName=mname,
    Dimensions=[{'Name':'LoadBalancer','Value':'net/my-nlb/abc'}],
    StartTime=start, EndTime=end, Period=300, Statistics=[stat]
  )['Datapoints']

b = sum(d['Sum'] for d in get('ProcessedBytes','Sum'))  # bytes/시간
new = sum(d['Sum'] for d in get('NewFlowCount','Sum'))
active = max((d['Maximum'] for d in get('ActiveFlowCount','Maximum')), default=0)

# 환산 로직은 공식 환산표에 맞춰 조정 필요(여기선 사용자 입력으로 환산 계수 주입)
print("ProcessedBytes/hour:", b, "NewFlowCount/hour:", new, "PeakActiveFlows:", active)
```

### 4.4 절감 팁
- 대량 바이트/연결/UDP → **NLB**가 ALB보다 비용·성능 적합.
- L7 라우팅이 불필요한 트래픽은 **ALB 대신 NLB**로 정리.
- 반대로 L7 기능(경로/호스트, 헤더/쿠키)은 ALB에서 처리.

---

## 5. ALB — **L7 라우팅/리라이트/웹소켓 + WAF 결합**

### 5.1 과금 포인트
- **시간 요금 + LCU**. LCU는 대략적으로 “처리 바이트, 요청 수, 활성/신규 연결, 규칙 평가” 중 최대 축으로 청구.
- L7 룰이 복잡할수록 **룰 평가 축이 커짐**.

### 5.2 비용 모델(개념식)
$$
\text{Cost}_{\text{ALB}} \approx r_{\text{hour}}\cdot H + r_{\text{LCU}}\cdot \max\{\psi_B,\ \psi_Q,\ \psi_{\text{conn}},\ \psi_{\text{rules}}\}
$$
- \(\psi\): 각 축의 사용량을 LCU 환산한 값(공식 환산표 반영 필요).

### 5.3 CloudWatch로 LCU 근사치 도출(요청/바이트/룰)
```python
# ALB LCU 근사(개념): RequestCount, ProcessedBytes, RuleEvaluations 지표 기반
import boto3, datetime
cw = boto3.client('cloudwatch')
end = datetime.datetime.utcnow(); start = end - datetime.timedelta(hours=1)
dims=[{'Name':'LoadBalancer','Value':'app/my-alb/abc'}]

def pick(name,stat):
  return cw.get_metric_statistics(
    Namespace='AWS/ApplicationELB', MetricName=name,
    Dimensions=dims, StartTime=start, EndTime=end, Period=300,
    Statistics=[stat]
  )['Datapoints']

req = sum(d['Sum'] for d in pick('RequestCount','Sum'))
bytes_sum = sum(d['Sum'] for d in pick('ProcessedBytes','Sum'))
rule_eval = sum(d['Sum'] for d in pick('RuleEvaluations','Sum'))

print("Requests/h:", req, "Bytes/h:", bytes_sum, "RuleEval/h:", rule_eval)
# 환산은 공식 LCU 기준으로 계산(여기서는 사용자 테이블 입력)
```

### 5.4 절감 팁
- **ALB를 통합**: 서비스별로 ALB를 남발하지 말고 **호스트/경로 기반**으로 통합(단, 룰 폭증 시 LCU 증가 주의).
- **리다이렉션/리라이트 최소화**: 애플리케이션/프록시 레벨로 일부 위임.
- **CloudFront 전단 배치**: ALB로 유입되는 요청 자체를 줄여 LCU·egress 절감.

---

## 6. WAF — **룰 수·요청 수가 곧 비용**

### 6.1 과금 포인트
- **Web ACL 월 고정** + **룰 수당 월 고정** + **요청 수당 과금**.
- 관리형 룰(Managed Rules)은 편하지만 추가 비용·성능 임팩트를 수반할 수 있음.

### 6.2 비용 모델(개념식)
- Web ACL 수 \(N_{\text{acl}}\), 룰 수 \(N_{\text{rules}}\), 월 요청 \(Q\), 단가 \(p_{\text{acl}}, p_{\text{rule}}, p_Q\).
$$
\text{Cost}_{\text{WAF}} \approx N_{\text{acl}}\cdot p_{\text{acl}} + N_{\text{rules}}\cdot p_{\text{rule}} + Q\cdot p_Q
$$

### 6.3 절감 팁
- **룰 최소화 & 우선순위 최적화**: 초기에 차단 룰을 두어 **룰 평가 총량**과 다운스트림 요청을 낮춘다.
- **Rate-based Rules**로 공격성 트래픽 조기 차단(봇/스크래핑).
- **엣지 차단**: CloudFront+WAF에서 먼저 거르고, ALB로 내려오는 요청 자체를 줄인다.
- **Managed Rules 체험 후 채택**: 전체 적용 전 샘플 트래픽에 A/B로 시험.

---

## 7. 통합 설계 — **레버 결합으로 총비용 최소화**

### 7.1 전형적 패턴
1) **S3/DynamoDB → Gateway Endpoint**로 NAT 회피.
2) **CloudFront 전단 배치**: 캐시 키·TTL·압축·Origin Shield로 캐시 효율 극대화.
3) **ALB 뒤에 앱**: L7 라우팅만 남기고, 대용량 TCP/UDP는 **NLB**로 우회.
4) **WAF는 엣지 또는 최소 룰**: Rule 수/요청 비용을 관리.
5) **Global Accelerator는 필요 조건 충족 시만**(저지연 글로벌 TCP/UDP + Anycast IP가 핵심 가치일 때).

### 7.2 기준 트리(요약)
- 대량 정적/캐시 가능 → **CloudFront(+OAC)**
- 내부 AWS 서비스 통신 → **Gateway/Interface Endpoint**
- L7 라우팅·WS·OIDC → **ALB(+필요시 WAF)**
- 초대량 TCP/UDP/정적 IP → **NLB**
- 글로벌 저지연 + Anycast 필요 → **Global Accelerator(검증 필수)**

---

## 8. “당장 써먹는” 모니터링/예산/가드레일

### 8.1 Budgets & Anomaly(월 300달러 초과 경보 예시)
```bash
aws budgets create-budget --account-id 123456789012 --budget '{
  "BudgetName":"ELB-CloudFront-Guard",
  "BudgetLimit":{"Amount":"300","Unit":"USD"},
  "TimeUnit":"MONTHLY","BudgetType":"COST"
}' --notifications-with-subscribers '[
  {"Notification":{"NotificationType":"FORECASTED","ComparisonOperator":"GREATER_THAN","Threshold":100,"ThresholdType":"PERCENTAGE"},
   "Subscribers":[{"SubscriptionType":"EMAIL","Address":"finops@example.com"}]}
]'
aws ce create-anomaly-monitor --anomaly-monitor '{"MonitorName":"LB-CF","MonitorType":"DIMENSIONAL","MonitorDimension":"SERVICE"}'
```

### 8.2 태그 강제(SCP) — 미태깅 생성 금지
```json
{
  "Version":"2012-10-17",
  "Statement":[{
    "Effect":"Deny",
    "Action":["ec2:RunInstances","elasticloadbalancing:CreateLoadBalancer","cloudfront:CreateDistribution"],
    "Resource":"*",
    "Condition":{"Null":{"aws:RequestTag/CostCenter":"true","aws:RequestTag/Owner":"true"}}
  }]
}
```

---

## 9. 비용 시뮬레이터(파이썬) — 변수만 넣어보면 바로 계산

```python
# 비용 단가/지표를 넣어 월간 추정치를 계산하는 스케치 스크립트(개념)
def vpc_interface_ep_cost(hours, az_count, r_hour, gb, r_gb):
    return hours * az_count * r_hour + gb * r_gb

def cloudfront_cost(q_total, hit_rate, obj_bytes, req_price, edge_price_per_gb, origin_price_per_gb):
    q_miss = q_total * (1 - hit_rate)
    b_edge_gb   = (q_total * obj_bytes) / (1024**3)
    b_origin_gb = (q_miss  * obj_bytes) / (1024**3)
    return (q_total * req_price) + (b_edge_gb * edge_price_per_gb) + (b_origin_gb * origin_price_per_gb)

def waf_cost(n_acl, p_acl, n_rules, p_rule, q_total, p_req):
    return n_acl*p_acl + n_rules*p_rule + q_total*p_req

# 예시 입력(임의의 값, 실제 단가는 콘솔/문서 기준으로 대입)
H=720
print("InterfaceEP:", vpc_interface_ep_cost(H, az_count=2, r_hour=0.01, gb=500, r_gb=0.01))
print("CloudFront :", cloudfront_cost(q_total=100_000_000, hit_rate=0.92, obj_bytes=64*1024,
                                      req_price=0.000001, edge_price_per_gb=0.08, origin_price_per_gb=0.02))
print("WAF       :", waf_cost(n_acl=1,p_acl=5,n_rules=5,p_rule=1,q_total=10_000_000,p_req=0.0000006))
```

---

## 10. 운영 체크리스트(주간 루틴)

- [ ] CloudFront **히트율/오리진 egress** 대시보드 검토(버전링/TTL/캐시 키 재점검).
- [ ] ALB/NLB **요청·바이트·연결 지표**에서 **LCU/NLCU 축 최대값** 확인(룰/리다이렉션 단순화).
- [ ] VPC Endpoint 수(AZ별)·NAT 트래픽(바이트) 비교: **Gateway Endpoint 전환 가능성** 점검.
- [ ] WAF 룰/요청 상위 Top-N 분석 → **룰 슬림화/Rate-based** 재튜닝.
- [ ] Budgets/Anomaly 알림 리뷰, 예산 한도 재설정.
- [ ] 월 1회: **대안 시나리오**(CloudFront 도입/Origin Shield/GA↔CloudFront·R53 비교) 재평가.

---

## 11. 사례 스냅샷 — “ALB+WAF 비용 폭증” 잡기
- 현상: ALB 뒤 WAF에서 요청 수가 급증, 월 중반부터 비용 곡선이 가팔라짐.
- 조치:
  1) **CloudFront 전단 배치**, 캐시 키 슬림화·TTL 확장 → ALB 유입 자체를 40% 감소.
  2) WAF: **Rate-based** 룰 우선 적용·관리형 룰 일부 제외 → 룰 평가량 35% 감소.
  3) 일부 API 호출은 **Regional API Gateway + WAF**로 분기(저비용 per-request).
- 결과: 다음 달 **WAF 비용 ~50%↓**, ALB LCU 30%↓.

---

## 12. 결론
- 비용은 “**요청·바이트·연결·룰**”의 함수다.
- **CloudFront 캐시율**과 **Gateway Endpoint**만으로도 구조적으로 큰 비중을 줄일 수 있다.
- **ALB↔NLB** 역할을 분리하고, **WAF는 슬림**하게 운용한다.
- **Global Accelerator**는 성능 가치가 명확할 때만 택한다.
- 무엇보다 **매일 측정**하고 **수식으로 모형화**해 **자동화된 가드레일**을 두는 것이 장기 절감의 핵심이다.
