---
layout: post
title: TCPIP - 트러블슈팅 방법론
date: 2025-09-04 21:25:23 +0900
category: TCPIP
---
# 17. 트러블슈팅 방법론
**(🔰 계층별 가설: Top-down/Bottom-up, ⚙️ 진단 도구: ping·traceroute/mtr·nslookup/dig·curl·ss/netstat·ip/route, ⚙️ 패킷 캡처: tcpdump·Wireshark로 무엇을 볼지, 🚀 ‘느림’의 원인 찾기: DNS·MTU·혼잡·서버 자원·중간장비)**

> “느려요/끊겨요/가끔 안 돼요.”라는 모호한 제보를 **측정 → 가설 → 실험 → 원인격리 → 해결**의 루프로 바꾸는 실무 레시피입니다.  
> 명령/출력은 ``` 코드 블록으로, 수식은 *MathJax*로 표기합니다.

---

## 17.1 사고 방식: 계층별 가설 세우기 (🔰)

### 17.1.1 Top-down vs Bottom-up
- **Top-down(사용자 체감 → 프로토콜)**  
  1) **증상 정의**(페이지 로딩/콜 끊김/다운로드 속도)  
  2) **SLO 지표**(TTFB/LCP/Jitter/손실) 관측  
  3) **응용→전송→네트워크** 순으로 가설 축소
- **Bottom-up(링크/라우팅 → 앱)**  
  1) **링크/MTU/ARP/ND**  
  2) **L3 라우팅/ECMP/ACL**  
  3) **TCP/QUIC** 상태 → **HTTP/gRPC/DNS/TLS**

> **실무 팁**: **Top-down**으로 빠르게 사용자 영향 범위를 파악하고, **Bottom-up**으로 근본 원인을 잡습니다. 두 축을 왕복하세요.

### 17.1.2 레이어별 빠른 체크리스트
```
L7  : DNS/URL/쿠키/캐시/오브젝트/인증/백엔드 5xx?
L4  : SYN/ACK/RTT/재전송/윈도우/큐/Keep-Alive/풀?
L3  : 라우팅/비대칭/TTL/ICMP/PMTUD/VRF/정책라우팅?
L2  : ARP/NDP/MAC 충돌/VLAN/스패닝트리/듀플렉스/오토협상?
L1  : 링크 업/오토네고/에러 카운터/광모듈/케이블?
```

### 17.1.3 “좋은 가설”의 형태
- **관측된 현상** + **가능한 원인** + **검증 방법** + **통과/실패 시 다음 분기**
- 예) “**큰 응답만 타임아웃** → **PMTUD 블랙홀** 가설. **DF ping**/`tracepath`로 MTU 확인. 실패면 **MSS 클램핑** A/B.”

---

## 17.2 트리아지 & 증거 수집(골든 루틴)

1) **재현성**: 언제/어디서/누구에게서 재현? (지역/ASN/브라우저/모바일)  
2) **시간 축**: 시작 시점/배포/변경 항목(“무엇이 바뀌었나?”)  
3) **기준선 비교**: 정상 사용자와 **RUM/서버 지표** 비교  
4) **계층 분리**: DNS⟂연결⟂TLS⟂요청⟂응답 구분  
5) **샘플 획득**: pcap, cURL 타이밍, mtr, ss, sysstat, 앱 로그

> 로그/증거 없이 추론만 하는 시간 ≥ 5분이면 **반드시 증거를 모으세요**.

---

## 17.3 도구와 질문 매핑 (⚙️ 한눈표)

| 질문 | 1차 도구 | 보고 싶은 것 |
|---|---|---|
| DNS가 느린가/틀린가 | `dig/nslookup` | 응답 시간(ms), TTL, 권한/재귀, NXDOMAIN |
| 경로/손실/지연은? | `mtr/traceroute` | 홉별 RTT/손실, 비대칭, MPLS/터널 |
| 연결/TTFB이 느린가 | `curl -w` | DNS/Connect/TLS/TTFB 세분 타이밍 |
| 재전송/윈도우 이슈? | `ss -tin` | `rto`, `rtt`, `cwnd`, `retrans` |
| 라우팅/정책 문제? | `ip route/rule` | 일치 경로, FIB 룩업 결과 |
| MTU/블랙홀? | `ping -M do`/`tracepath` | 경로 MTU, PTB 수신 여부 |
| 패킷 실제로? | `tcpdump/Wireshark` | SYN/SYN-ACK, TLS 헬로, `tcp.analysis.*` |

---

## 17.4 핵심 도구 — 실무 사용법 (⚙️)

### 17.4.1 ping — 왕복·지터/패킷 손실
```bash
ping -c 20 <host>
ping -c 20 -s 1472 -M do <host>   # DF=on, 1500 MTU 경로 테스트(IPv4)
ping -6 -c 20 -s 1452 -M do <host> # IPv6
```
- **해석**: 평균 RTT/표준편차(≈지터), 손실률.  
- **주의**: ICMP 차단/우선순위 낮음 → **참고용**. 데이터 패스는 다를 수 있음(TCP/UDP).

### 17.4.2 traceroute/mtr — 경로/손실
```bash
mtr -rwzbc100 <host>         # 100샘플, 손실/RTT 통계
traceroute -T -p 443 <host>  # TCP SYN 기반(방화벽 친화)
traceroute -U -p 53 <dns>    # UDP 53 기반
```
- **팁**: ICMP 필터 환경은 **TCP 모드**.  
- **주의**: **비대칭 경로** 흔함 → 홉별 손실은 라우터의 **ICMP rate limit**일 수 있음.

### 17.4.3 nslookup/dig — DNS
```bash
dig +trace www.example.com         # 권한 체인 추적
dig @resolver.example  www A +stats +nocmd
dig www AAAA +dnssec +edns=1280
```
- **보는 포인트**: `;; Query time:`, `TTL`, `SERVFAIL/NX`, CNAME 체인 길이, **EDNS 크기**.  
- **Split DNS**: 사내/공용 응답 차이 → 리졸버 지정 시험.

### 17.4.4 curl — 타이밍 분해 & 프로토콜 검사
```bash
curl -w 'dns:%{time_namelookup} conn:%{time_connect} tls:%{time_appconnect}\
 ttbf:%{time_starttransfer} total:%{time_total} proto:%{http_version}\n' \
 -o /dev/null -s https://www.example.com

curl --http2 -I https://host
curl --http3 -I https://host      # 빌드 지원 필요
curl --resolve www.example.com:443:203.0.113.10 https://www.example.com/ # DNS 우회
```
- **읽기**:  
  - `time_namelookup`(DNS), `time_connect`(TCP), `time_appconnect`(TLS),  
  - `time_starttransfer`(TTFB – 서버 작업/백엔드), `http_version`(h1/h2/h3).

### 17.4.5 ss/netstat — 소켓 상태/혼잡
```bash
ss -tin '( sport = :443 )'
# 출력 예: cubic wscale:7,7 rto:204 rtt:23.1/3.2 ato:40 cwnd:10 bytes_acked:1.2M reordering:3
ss -s
```
- **키 필드**:  
  - `rtt`/`rto`: 지연/재전송 타이머.  
  - `cwnd`(혼잡 윈도우), `bytes_acked`, `retrans`(재전송 카운트).  
  - `send-q/recv-q`(큐 적체).

### 17.4.6 ip/route/neigh — 라우팅/ARP/정책
```bash
ip route get 8.8.8.8
ip rule show
ip neigh show nud failed|incomplete
```
- **증상**: `incomplete`/`failed` 많음 → **ARP/NDP 문제**.  
- **정책 라우팅**: 소스 기반/테이블별 경로 누락 확인.

---

## 17.5 패킷 캡처/분석 (⚙️ 무엇을 볼지)

### 17.5.1 tcpdump — 필터와 캡처 기법
```bash
# 안전 캡처: 스냅렌, 순환 버퍼, 타임스탬프
tcpdump -i any -s 128 -B 4096 -w trace.pcap \
  'host 203.0.113.10 and (tcp port 443 or icmp)'

# 핸드셰이크만(빠르게 원인 확인)
tcpdump -i eth0 'tcp[tcpflags] & (tcp-syn|tcp-ack) != 0' -nnvv

# HTTP/2(H2C는 평문), DNS, TLS ClientHello만
tcpdump -i any -nn 'port 53 or port 80 or (tcp port 443 and tcp[((tcp[12] & 0xf0) >> 2)] = 0x16)'
```
- **스냅렌(-s)**: 96~128B면 헤더 위주, 전체 분석은 0(전체).  
- **순환(-C/-W)**: 디스크 보호.  
- **VLAN/터널**: `-e`(L2), `vxlan`/`geneve` 디코드 옵션(버전 의존).

### 17.5.2 Wireshark — 표시 필터 & 통계
- **표시 필터**:
  - `tcp.flags.syn==1 and tcp.flags.ack==0` (SYN)  
  - `tcp.analysis.retransmission || tcp.analysis.fast_retransmission`  
  - `http || http2 || quic || tls`  
  - `dns && !(dns.flags.response==1)` (쿼리만)
- **통계**:  
  - *Statistics → I/O Graphs* (지연/재전송 이벤트와 상관),  
  - *Conversations*/*Endpoints* (헤비 토커),  
  - *Flow Graph* (SYN→TLS→HTTP 타임라인).

### 17.5.3 TLS/QUIC 복호(가능하면)
- **브라우저**: `SSLKEYLOGFILE` 환경변수로 키 로그 → Wireshark `TLS (Pre)-Master-Secret log filename`.  
- **QUIC**: 크롬/파폭 최신은 **키 로그 지원**, Wireshark QUIC 디섹터 활성.

> **주의**: 실제 운영 데이터 복호에는 **개인정보/규정** 준수. **테스트 환경** 또는 **허가된 샘플**만.

---

## 17.6 ‘느림’ 원인별 진단 플레이북 (🚀)

### 17.6.1 DNS 느림/오류
**증상**: `curl -w`에서 `dns`만 높음, 첫 요청만 느림, NX/SERVFAIL 많음.  
**가설**: 재귀 리졸버 지연, DoH/DoT 차단, EDNS 크기/프래그멘테이션, Split DNS.  
**검증**
```bash
dig www.example.com A +stats
dig @1.1.1.1 www.example.com A +tcp  # UDP 문제 배제
dig +trace www.example.com           # 권한 체인
```
**조치**
- 재귀 리졸버 변경/근거리 Anycast, **캐시 TTL 조정**.  
- 방화벽에서 **DNS 53/DoT 853/DoH 443** 정책 확인.  
- EDNS 사이즈 축소/`+tcp` 폴백 고려(프래그 문제 시).

### 17.6.2 MTU/PMTUD 블랙홀
**증상**: **작은 컨텐츠 OK, 큰 응답/다운로드 타임아웃**, H3만 실패.  
**검증**
```bash
tracepath <host>               # 경로 MTU 힌트
ping -M do -s 1472 <host>      # IPv4 DF
ping -M do -s 1452 -6 <host>   # IPv6 DF
```
**조치**
- 경계에서 **TCP MSS 클램핑**(예: 1360~1440).  
- **ICMP Too Big** 통과(방화벽).  
- 오버레이/VPN이면 **노드 MTU↓ + CNI MTU↓** 동조.

### 17.6.3 혼잡/버퍼블로트
**증상**: 업로드/다운로드 시 **RTT 급증**, 통화 **로봇보이스**, 손실↑.  
**검증**
```bash
flent rrul -H <host>     # 혼합 트래픽에서 지연/손실 관찰
ss -s                     # 재전송/큐
```
**조치**
- 엣지에 **fq_codel/CAKE**, 서버에 `net.core.default_qdisc=fq`.  
- **BBR** 검토(측정 기반), **ECN** 활성화(경로 지원 시).  
- **업로드 쉐이핑**(ISP 업링크 90~95%).

### 17.6.4 서버 자원/스택
**증상**: TTFB↑(서버 처리 지연), 5xx 증가, 큐 포화.  
**검증**
```bash
ss -tin     # send-q/recv-q, rtt, retrans
top/iostat/vmstat/sar
journalctl -u app.service
```
**조치**
- **풀/스레드/FD** 한도 증설, **DB/캐시** 병목 제거.  
- **Keep-Alive/커넥션 풀** 최적화, **압축/Brotli** CPU 예산.  
- **somaxconn**, `tcp_max_syn_backlog`, `nf_conntrack_max` 적정화.

### 17.6.5 중간장비/정책/ALG
**증상**: 프로토콜 특정 실패(QUIC/H3, WebSocket, FTP 알 수 없는 문제).  
**가설**: 방화벽/IPS/프록시/ALG 간섭, 443/UDP 차단, DPI 오탐.  
**검증**
```bash
curl --http3 -I https://host     # H3 실패?
curl -I https://host             # H2/H1은 OK?
mtr -T -P 443 host               # TCP 443 경로
```
**조치**
- **443/UDP 허용**, **ICMP PTB** 허용.  
- IPS는 **탐지→차단** 단계 도입, 예외 룰 최소화.  
- WebSocket은 **프록시 idle timeout**/버퍼 한도 조정.

---

## 17.7 상황별 결정 트리

### 17.7.1 “접속 자체가 안 된다”
```
A. DNS?  → dig NX/SERVFAIL?   → 권한체크/리졸버 교체
B. TCP?  → SYN→SYN-ACK?       → 아니오: 방화벽/SG/NACL/흑백리스트
C. TLS?  → ClientHello/Cert?  → 핸드셰이크 실패: 버전/암호군/OCSP/유효기간
D. 앱?   → /healthz 200?       → 백엔드/DB/큐 상태
```

### 17.7.2 “느리다(로딩/다운로드)”
```
1) curl -w로 타이밍 분해:
   - DNS↑  → 리졸버/EDNS/캐시 문제
   - Connect↑ → 경로/혼잡/방화벽 지연
   - TLS↑ → OCSP/체인/서명 알고리즘/CPU
   - TTFB↑ → 앱/DB/캐시/Lock/GC
   - total↑ with loss → 혼잡/재전송/MTU
2) mtr: 손실/RTT 스파이크(업/다운 중 변화?)
3) ss: cwnd/rtt/retrans/큐
```

### 17.7.3 “간헐적 5xx/타임아웃”
```
- 특정 리전/ASN? → Anycast/BGP/피어링 불안정
- 시간대 패턴? → 스케줄 작업/스케일/캐시 만료
- LB outlier ejection 로그? → 특정 인스턴스 격리
- DB 커넥션 풀/쿼리 락? → APM/슬로우로그
```

---

## 17.8 캡처/리포트 템플릿

### 17.8.1 재현·증거 패킷 수집
```bash
# 1) 증상 시간대 ±5분
date -Is
# 2) 인터페이스/필터 정의(PII 배제)
tcpdump -i eth0 -s 128 -B 4096 -w repro_$(date +%H%M).pcap \
  'host <server_ip> and (tcp port 443 or icmp)'
# 3) curl 타임라인 + 헤더
curl -v -w '@curl-format.txt' -o /dev/null https://host/path
```
`curl-format.txt`
```
dns:%{time_namelookup} conn:%{time_connect} tls:%{time_appconnect}\
 ttfb:%{time_starttransfer} total:%{time_total} code:%{http_code}\n
```

### 17.8.2 사건 보고서(요약 양식)
```
[증상] 지역/ISP/기기/시간/비율
[영향] 오류율/지연/SLO 위반
[원인가설] DNS/MTU/혼잡/서버/중간장비...
[증거] dig/mtr/curl/ss/pcap 핵심 스크린샷/수치
[조치] 구성/코드/인프라 변경 + 롤백 플랜
[결과] 전/후 수치(95/99퍼센타일), 재발 방지
```

---

## 17.9 미니 레시피: 자주 쓰는 필터 & 명령 모음

### 17.9.1 tcpdump BPF
```
tcp port 443 and host 203.0.113.10
icmp or icmp6
tcp[tcpflags] & (tcp-syn|tcp-fin|tcp-rst) != 0
vlan and port 67 or port 68            # DHCP
udp port 53                             # DNS
(port 80 or port 443) and not (host cdn.example.com)
```

### 17.9.2 Wireshark 표시 필터
```
tcp.analysis.retransmission || tcp.analysis.out_of_order
tcp.window_size_value < 4096
http2 && !(http2.settings)
quic && tls.record.content_type==23   # 앱데이터 epoch
dns.flags.rcode != 0
ip.dsfield.ecn==3 && tcp.flags.ack==1 # ECN CE+ACK
```

### 17.9.3 iperf3 — 처리량/RTT
```bash
iperf3 -s                       # 서버
iperf3 -c <host> -t 20 -R       # 역방향
iperf3 -c <host> -u -b 50M -l 1200  # UDP 손실/지터 관측
```

### 17.9.4 netem — 손실/지연 에뮬
```bash
tc qdisc add dev eth0 root netem delay 80ms 20ms loss 1% rate 50mbit
# 테스트 후
tc qdisc del dev eth0 root
```

---

## 17.10 수식·감각 메모 (MathJax)

### 17.10.1 BDP와 윈도우
\[
\mathrm{BDP} = \mathrm{Bandwidth} \times \mathrm{RTT}
\quad\Rightarrow\quad
\mathrm{필요\ 윈도우} \ge \mathrm{BDP}
\]
윈도우<BDP면 대역폭을 못 채움.

### 17.10.2 TCP 근사 모델(손실 민감)
\[
\text{Throughput} \propto \frac{\text{MSS}}{\text{RTT}\sqrt{p}}
\]
\(p\)↑ → 처리량↓. 혼잡제어/ECN/AQM로 \(p\)를 관리.

### 17.10.3 큐 지연
\[
D_{\text{queue}} \approx \frac{B_{\text{queue}}}{R_{\text{bottleneck}}}
\]
큐 바이트가 커질수록 지연↑ → **버퍼블로트**.

---

## 17.11 베스트 프랙티스(요약 카드)

- **가설은 작게, 증거는 충분히**: `curl -w`·`mtr`·`ss`·`pcap` 4종 세트.  
- **타이밍 분해**: DNS/Connect/TLS/TTFB를 분리해서 봐야 한다.  
- **MTU/ICMP**: `tracepath`, DF ping, ICMP PTB 허용, MSS 클램핑.  
- **혼잡은 큐에서 보인다**: `fq_codel/fq`·BBR·ECN, 업링크 쉐이핑.  
- **서버 풀링**: Keep-Alive/커넥션 풀/백엔드 타임아웃/풀 크기.  
- **중간장비**: 443/UDP/H3, WebSocket 타임아웃, IPS 단계적 적용.  
- **비교 실험**: 정상 케이스 vs 문제 케이스 **차이만** 추적.  
- **문서화**: 전/후 수치·변경내역·롤백 조건.

---

## 17.12 부록 — 퀵 스타트 명령 스크립트 (붙여넣기용)
```bash
#!/usr/bin/env bash
# quickdiag.sh <host>
H=${1:?usage: $0 host}
set -e

echo "# DIG"
dig "$H" A +stats || true

IP=$(dig +short "$H" A | head -1)
echo "# TARGET IP: $IP"

echo "# CURL"
curl -sS -o /dev/null -w 'dns:%{time_namelookup} conn:%{time_connect} tls:%{time_appconnect} ttfb:%{time_starttransfer} total:%{time_total} code:%{http_code} proto:%{http_version}\n' "https://$H" || true

echo "# MTR"
mtr -rwzbc50 "$H" || true

echo "# MTU (IPv4)"
for S in 1472 1464 1452 1440; do
  echo -n "DF ping -s $S: "
  ping -c 1 -M do -s $S "$IP" >/dev/null 2>&1 && echo ok || echo fail
done

echo "# SS (443)"
ss -tin "( dport = :443 )" | head -5 || true
```

---

### 17.13 한 장 요약(포스터)
- **Top-down**으로 **증상/타이밍**을 쪼개고, **Bottom-up**으로 **링크/MTU/라우팅**을 다진다.  
- **도구 4종**: `dig`(DNS), `mtr`(경로), `curl -w`(타임라인), `ss`(TCP 상태).  
- **pcap**은 마지막 판정관. **SYN→TLS→HTTP** 흐름이 보이면 길은 열린다.  
- ‘느림’은 대개 **DNS/MTU/혼잡/서버/중간장비** 다섯 중 하나. **증거로** 고른다.
