---
layout: post
title: AWS - IAM
date: 2025-07-23 17:20:23 +0900
category: AWS
---
# IAM: 사용자 · 권한 · 역할 관리

## 0. 한 장 요약

- **IAM의 본질**: *누가*(주체, Principal)이 *무엇*(Action)을 *어디*(Resource)에 *어떤 조건*(Condition)으로 할 수 있는지 **정책**으로 결정.
- **평가 규칙**: **명시적 Deny > Allow**. 일치하는 Allow가 없으면 Deny.
- **최소 권한**: 시작은 ReadOnly·구체적 리소스 ARN, 이후 필요한 Action만 점진적 허용.
- **권한의 4축**: **ID 기반 정책(IAM/User/Role/Group)**, **리소스 기반 정책(S3/KMS/SQS 등)**, **경계(Permission Boundary/SCP)**, **세션 정책(AssumeRole 시)**.
- **현대적 패턴**: **ABAC(태그 기반)**, **OIDC/SAML 페더레이션**, **교차계정 AssumeRole**, **SSO(Identity Center)**, **IRSA(EKS), Task Role(ECS)**.

---

## 1. IAM이란?

- **Identity and Access Management**: AWS 리소스에 대한 인증·인가를 **정책(JSON)** 기반으로 제어하는 서비스.
- **구성요소**: 사용자(User), 그룹(Group), 역할(Role), 정책(Policy), 인스턴스 프로파일(EC2), 자격증명 소스(IdP, SSO) 등.

---

## 2. 핵심 객체

### 2.1 사용자(User)
- 사람/툴을 대표하는 **장기 자격**(콘솔 비밀번호, Access Key).
- 권장: **개인 사용자 + MFA + 비밀키 로테이션**. 장기 키 대신 **역할/세션** 우선.

```json
// (예시) S3 읽기 전용 최소 정책
{
  "Version":"2012-10-17",
  "Statement":[
    {"Effect":"Allow","Action":["s3:ListBucket"],"Resource":"arn:aws:s3:::my-bucket"},
    {"Effect":"Allow","Action":["s3:GetObject"],"Resource":"arn:aws:s3:::my-bucket/*"}
  ]
}
```

### 2.2 그룹(Group)
- 공통 권한을 묶어 사용자에게 일괄 부여.
- 권장: **“개발-읽기” “운영-배포”** 등 역할 중심 그룹 설계.

### 2.3 역할(Role)
- **임시 자격**(STS)을 발급받아 사용. **사람 없이** 서비스/워크로드에게 권한 위임.
- 예: **EC2 인스턴스 프로파일**, **Lambda 실행 역할**, **ECS Task Role**, **EKS IRSA**.

```json
// (예시) EC2가 AssumeRole 할 수 있도록 하는 신뢰 정책(Trust Policy)
{
  "Version":"2012-10-17",
  "Statement":[
    {"Effect":"Allow","Principal":{"Service":"ec2.amazonaws.com"},"Action":"sts:AssumeRole"}
  ]
}
```

---

## 3. 정책(Policy) 구조와 평가 로직

### 3.1 구조
```json
{
  "Version":"2012-10-17",
  "Statement":[
    {
      "Sid":"ListObjects",
      "Effect":"Allow",
      "Action":"s3:ListBucket",
      "Resource":"arn:aws:s3:::example-bucket",
      "Condition":{"StringLike":{"s3:prefix":"public/*"}}
    }
  ]
}
```
- `Effect`: Allow/Deny
- `Action`: `service:APIname` 배열 가능 (`s3:GetObject`, `iam:CreateRole` 등)
- `Resource`: ARN(정확·패턴 매칭), 일부 API는 `*` 필요(계정 스코프 API 등)
- `Condition`: IP/시간/태그/MFA/소스 VPC 등 **세밀 제어**
- 보조 키워드: `NotAction`, `NotResource` (신중히 사용)

### 3.2 평가 순서(핵심)
1) 요청 컨텍스트(주체/리소스/액션/조건) 수집
2) **명시적 Deny** 매치 시 즉시 거부
3) Allow 매치 있으면 허용, 없으면 거부(암묵적 Deny)

---

## 4. 권한의 네 레이어

| 레이어 | 개요 | 비고 |
|---|---|---|
| **ID 기반 정책** | User/Group/Role에 부착 | 가장 일반적 |
| **리소스 정책** | S3/KMS/SNS/SQS/API GW 등 리소스에 부착 | 교차계정 공유에 유용 |
| **Permission Boundary** | **해당 주체가 가질 수 있는 최대 권한 상한** | 관리자 위임에 필수 |
| **SCP(Organizations)** | **계정 전체 상한**. 허용 상한을 강제 | 루트에도 적용 |

> 최종 권한 = **ID 기반 Allow** ∩ **리소스 정책 Allow** ∩ **Permission Boundary** ∩ **SCP** (그리고 **명시적 Deny는 최우선**).

---

## 5. 조건(Condition) · ABAC

### 5.1 MFA·IP·시간 제한
```json
{
  "Version":"2012-10-17",
  "Statement":[{
    "Effect":"Allow",
    "Action":"ec2:StartInstances",
    "Resource":"*",
    "Condition":{
      "Bool":{"aws:MultiFactorAuthPresent":"true"},
      "IpAddress":{"aws:SourceIp":["203.0.113.0/24"]},
      "DateGreaterThan":{"aws:CurrentTime":"2025-01-01T00:00:00Z"}
    }
  }]
}
```

### 5.2 ABAC(태그기반 접근)
- 사용자/세션 태그와 리소스 태그를 매칭하여 **정책 재사용·스케일**.

```json
{
  "Version":"2012-10-17",
  "Statement":[{
    "Effect":"Allow",
    "Action":["ec2:*"],
    "Resource":["arn:aws:ec2:ap-northeast-2:123456789012:instance/*"],
    "Condition":{"StringEquals":{"aws:ResourceTag:team":"${aws:PrincipalTag/team}"}}
  }]
}
```
- 원리: **주체 태그 team=“ml”**인 사용자는 **리소스 태그 team=“ml”**인 인스턴스만 관리.

---

## 6. 교차 계정 접근(AssumeRole)

### 6.1 시나리오
- **Prod 계정의 Role**을 **Dev 계정 사용자**가 사용.
- Prod Role의 **Trust Policy**에 Dev 계정 주체를 명시.

```json
// Prod 계정: 신뢰 정책
{
  "Version":"2012-10-17",
  "Statement":[{
    "Effect":"Allow",
    "Principal":{"AWS":"arn:aws:iam::111122223333:user/devops"},
    "Action":"sts:AssumeRole",
    "Condition":{"StringEquals":{"sts:ExternalId":"X-EXT-123"}}
  }]
}
```

```bash
# Dev 계정 사용자 측: 역할 세션 발급
aws sts assume-role \
  --role-arn arn:aws:iam::999988887777:role/ProdReadOnly \
  --role-session-name dev2prod \
  --external-id X-EXT-123
```
- **externalId**: 서드파티 위임 시 혼동공격 방지.
- **세션 태그/정책**: `--tags team=ml` / `--policy` 로 **세션 범위 축소** 가능.

---

## 7. 페더레이션: SAML/OIDC · SSO

- **SAML**: 기업 IdP(ADFS/Okta) → 콘솔/CLI SSO.
- **OIDC**: **GitHub Actions, OIDC IdP** → 단기 토큰 발급(비밀키 불필요).
- **AWS IAM Identity Center(SSO)**: 계정/역할 할당·MFA·세션 중앙관리.

```json
// (OIDC) GitHub Actions용 신뢰 정책 요약
{
  "Version":"2012-10-17",
  "Statement":[{
    "Effect":"Allow",
    "Principal":{"Federated":"arn:aws:iam::123456789012:oidc-provider/token.actions.githubusercontent.com"},
    "Action":"sts:AssumeRoleWithWebIdentity",
    "Condition":{
      "StringLike":{"token.actions.githubusercontent.com:sub":"repo:ORG/REPO:*"},
      "StringEquals":{"token.actions.githubusercontent.com:aud":"sts.amazonaws.com"}
    }
  }]
}
```

---

## 8. 서비스별 역할 패턴

### 8.1 EC2 인스턴스 프로파일
- 인스턴스에 역할 연결 → 어플리케이션은 **키 없이** AWS SDK 사용.

```json
// S3 접근 권한(역할에 부착)
{
  "Version":"2012-10-17",
  "Statement":[{"Effect":"Allow","Action":["s3:GetObject","s3:PutObject"],"Resource":"arn:aws:s3:::my-bucket/*"}]
}
```

### 8.2 Lambda 실행 역할
- 최소 권한 **+ CloudWatch Logs** 권한 필수.

```json
{
  "Version":"2012-10-17",
  "Statement":[
    {"Effect":"Allow","Action":["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],"Resource":"*"},
    {"Effect":"Allow","Action":["dynamodb:PutItem"],"Resource":"arn:aws:dynamodb:ap-northeast-2:123456789012:table/Users"}
  ]
}
```

### 8.3 EKS IRSA
- **ServiceAccount ↔ IAM Role**(OIDC) 매핑, 파드별 최소 권한.

```yaml
# ServiceAccount에 주석으로 Role ARN 연결
apiVersion: v1
kind: ServiceAccount
metadata:
  name: s3-reader
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/eks-s3-reader
```

### 8.4 ECS Task Role
- **태스크 정의**에 역할 지정 → 컨테이너가 임시 자격 획득.

---

## 9. 리소스 기반 정책(교차계정 공유에 유용)

### 9.1 S3 버킷 정책 – 특정 계정만 읽기
```json
{
  "Version":"2012-10-17",
  "Statement":[{
    "Sid":"AllowAccountBRead",
    "Effect":"Allow",
    "Principal":{"AWS":"arn:aws:iam::222233334444:root"},
    "Action":["s3:GetObject"],
    "Resource":"arn:aws:s3:::shared-bucket/*"
  }]
}
```

### 9.2 KMS 키 정책 – 소유 및 사용권한
```json
{
  "Version":"2012-10-17",
  "Statement":[
    {"Sid":"KeyAdmin","Effect":"Allow","Principal":{"AWS":"arn:aws:iam::123456789012:role/kms-admin"},"Action":["kms:*"],"Resource":"*"},
    {"Sid":"KeyUse","Effect":"Allow","Principal":{"AWS":"arn:aws:iam::123456789012:role/app-role"},"Action":["kms:Encrypt","kms:Decrypt","kms:GenerateDataKey*"],"Resource":"*"}
  ]
}
```

### 9.3 SQS 정책 – 교차계정 송신 허용
```json
{
  "Version":"2012-10-17",
  "Statement":[{
    "Effect":"Allow",
    "Principal":{"AWS":"arn:aws:iam::222233334444:root"},
    "Action":"sqs:SendMessage",
    "Resource":"arn:aws:sqs:ap-northeast-2:123456789012:my-queue"
  }]
}
```

---

## 10. Permission Boundary · 관리자 위임

- **관리자 역할**이 **하위 사용자/역할을 생성**할 때, **경계**로 최대 권한을 제한.

```json
// Permission Boundary 예시: S3 읽기까지만 가능
{
  "Version":"2012-10-17",
  "Statement":[{
    "Effect":"Allow",
    "Action":["s3:GetObject","s3:ListBucket"],
    "Resource":["arn:aws:s3:::*","arn:aws:s3:::*/*"]
  }]
}
```
- 이 경계를 부착한 사용자에게 **더 넓은 Allow 정책을 붙여도** 경계 범위를 넘어서면 **거부**.

---

## 11. Organizations · SCP

- **Service Control Policy**: 계정/OU 수준 **허용 상한**. 루트 포함 **모든 주체**에 적용.
- 모범사례: 위험한 API(예: `iam:*`, `organizations:LeaveOrganization`)를 기본 Deny 후 필요한 계정만 예외 허용.

```json
// (SCP) 특정 리전만 허용
{
  "Version":"2012-10-17",
  "Statement":[{
    "Effect":"Deny",
    "Action":"*",
    "Resource":"*",
    "Condition":{"StringNotEquals":{"aws:RequestedRegion":["ap-northeast-2","us-east-1"]}}
  }]
}
```

---

## 12. VPC 엔드포인트 · 소스 제한

- S3/KMS 등과 **Interface/Gateway Endpoint** 사용 시 **VPC·엔드포인트 ID** 조건으로 **프라이빗 경로 강제**.

```json
{
  "Version":"2012-10-17",
  "Statement":[{
    "Effect":"Deny",
    "Action":"s3:*",
    "Resource":"arn:aws:s3:::my-bucket/*",
    "Condition":{"StringNotEquals":{"aws:SourceVpce":"vpce-0abc123def456"}}
  }]
}
```

---

## 13. 정책 개발 워크플로 · 테스트

1) **목표 액션·리소스** 식별 → 2) **ReadOnly 기반 최소 세트** →
3) **실패 로그/Access Advisor**로 필요한 액션 추가 → 4) **정책 시뮬레이터** 검증 →
5) **Stage/Tag/시간/IP/MFA**로 조건 제한 → 6) **경계/SCP**와 합성 검토.

### 실습: IAM Policy Simulator & Access Analyzer
- 시뮬레이터로 **특정 주체·Action·Resource**에 대한 허용/거부 확인.
- **IAM Access Analyzer**로 외부공개/교차계정 접근 경로 탐지.

---

## 14. 실전 시나리오 모음

### 14.1 “운영자는 콘솔 접근만, CLI 차단”
```json
{
  "Version":"2012-10-17",
  "Statement":[{
    "Effect":"Deny",
    "Action":"*",
    "Resource":"*",
    "Condition":{"Bool":{"aws:ViaAWSService":"false"}, "StringEquals":{"aws:CalledVia":["signin.amazonaws.com"]}}
  }]
}
```
> 실무에서는 **Permission Set/조건 조합**으로 구현. *서비스 호출 컨텍스트 주의*.

### 14.2 “GitHub Actions에서만 S3 배포”
- OIDC 신뢰 + 버킷 정책에 **`aws:PrincipalTag/repo`** 또는 **`token.actions...:sub`** 조건.

```json
{
  "Version":"2012-10-17",
  "Statement":[{
    "Effect":"Allow",
    "Principal":{"AWS":"arn:aws:iam::123456789012:role/gha-deploy"},
    "Action":["s3:PutObject","s3:DeleteObject"],
    "Resource":"arn:aws:s3:::site-bucket/*",
    "Condition":{"StringLike":{"aws:PrincipalTag:repo":"ORG/REPO"}}
  }]
}
```

### 14.3 “운영계 SSM 접속은 MFA + 사내 IP만”
```json
{
  "Version":"2012-10-17",
  "Statement":[{
    "Effect":"Allow",
    "Action":["ssm:StartSession"],
    "Resource":"arn:aws:ec2:ap-northeast-2:123456789012:instance/*",
    "Condition":{
      "Bool":{"aws:MultiFactorAuthPresent":"true"},
      "IpAddress":{"aws:SourceIp":["203.0.113.0/24"]}
    }
  }]
}
```

---

## 15. IaC 예시 (CloudFormation/Terraform)

### 15.1 CloudFormation – 역할 + 정책
```yaml
Resources:
  AppRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: app-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: [lambda.amazonaws.com] }
            Action: sts:AssumeRole
      Policies:
        - PolicyName: app-s3-dynamo
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: [ 'logs:CreateLogGroup','logs:CreateLogStream','logs:PutLogEvents' ]
                Resource: '*'
              - Effect: Allow
                Action: [ 'dynamodb:PutItem','dynamodb:GetItem' ]
                Resource: 'arn:aws:dynamodb:ap-northeast-2:123456789012:table/Users'
```

### 15.2 Terraform – OIDC + 역할
```hcl
resource "aws_iam_openid_connect_provider" "gh" {
  url = "https://token.actions.githubusercontent.com"
  client_id_list = ["sts.amazonaws.com"]
  thumbprint_list = ["6938fd4d98bab03faadb97b34396831e3780aea1"]
}

data "aws_iam_policy_document" "assume_gh" {
  statement {
    actions = ["sts:AssumeRoleWithWebIdentity"]
    principals { type = "Federated" identifiers = [aws_iam_openid_connect_provider.gh.arn] }
    condition {
      test = "StringLike"
      variable = "token.actions.githubusercontent.com:sub"
      values = ["repo:ORG/REPO:*"]
    }
  }
}

resource "aws_iam_role" "gha_deploy" {
  name               = "gha-deploy"
  assume_role_policy = data.aws_iam_policy_document.assume_gh.json
}

resource "aws_iam_role_policy" "s3_write" {
  role = aws_iam_role.gha_deploy.id
  policy = jsonencode({
    Version="2012-10-17",
    Statement=[{
      Effect="Allow",
      Action=["s3:PutObject","s3:DeleteObject"],
      Resource="arn:aws:s3:::site-bucket/*"
    }]
  })
}
```

---

## 16. 보안 운영 체크리스트

- [ ] **루트 계정**: MFA, 액세스키 금지, 결제·계정관리 전용.
- [ ] **모든 사용자 MFA 강제**(정책/IdP).
- [ ] **장기 키 금지**, 역할 기반 세션으로 전환(SSO/OIDC).
- [ ] **최소 권한**: 구체적 ARN, 읽기부터, 필요 시 점진적 추가.
- [ ] **SCP/Permission Boundary**로 위임 안전장치.
- [ ] **ABAC 태그 표준화**(team, env, owner).
- [ ] **VPC Endpoint + 버킷/키 정책**으로 프라이빗 경로 고정.
- [ ] **Access Analyzer**로 외부 공개/교차계정 경로 탐지.
- [ ] **CloudTrail/Config** 상시 활성화, 비정상 탐지 알람.
- [ ] **키 로테이션/비밀관리(Secrets Manager)** 준수.
- [ ] **정책 시뮬레이터**로 변경 전 검증.
- [ ] **Break-glass**(비상 접근) 절차 문서화·리뷰.

---

## 17. 사고·리뷰 시나리오(테스트 가이드)

1) **권한 과다 탐지**: Access Advisor로 불필요 Action 파악 → 정책 축소.
2) **권한 부여 실패**: 정책 시뮬레이터로 어떤 레이어가 거부했는지 확인
   - 리소스 정책? Boundary? SCP? 세션 정책? 조건 키(Region/IP/MFA)?
3) **교차계정 실패**: Trust 정책 Principal, ExternalId, 세션 태그 확인.
4) **EKS/ECS 실패**: IRSA/TaskRole mapping, 서비스 어카운트/태스크정의와 역할 일치 확인.
5) **S3 접근 실패**: 버킷 정책의 `aws:SourceVpce`·`aws:PrincipalOrgID` 조건, Block Public Access 설정 확인.

---

## 18. 참고 수식(리스크 점수 모델의 한 예)

> 팀/환경/권한 범위를 간단히 수치화하여 **검토 우선순위**를 정하는 내부 지표의 예.

$$
\text{RiskScore}
= \alpha \cdot \underbrace{\#\text{Admin-Actions}}_{\text{iam:*, kms:*, org:*}}
+ \beta \cdot \underbrace{\#\text{Wildcard-Resource}}_{\text{Resource="*"}}
+ \gamma \cdot \underbrace{(1-\text{MFA})}_{\text{MFA 미적용}}
+ \delta \cdot \underbrace{\#\text{CrossAccount}}_{\text{Principal 계정 외}}
$$

- 점수가 높으면: Boundary/SCP 강화, 정책 세분화, MFA 강제 등 조치.

---

## 19. 실습: “Dev는 자기 리소스만, Prod는 배포 역할만”

### 19.1 Dev 사용자(ABAC)
- 사용자 태그: `team=dev`, `env=dev`

```json
{
  "Version":"2012-10-17",
  "Statement":[{
    "Effect":"Allow",
    "Action":["ec2:*","s3:*"],
    "Resource":"*",
    "Condition":{
      "StringEquals":{
        "aws:ResourceTag:team":"${aws:PrincipalTag/team}",
        "aws:ResourceTag:env":"${aws:PrincipalTag/env}"
      }
    }
  }]
}
```

### 19.2 Prod 배포 역할
- 콘솔 접근 불가, **CI/OIDC**에서만 AssumeRole.
- S3/CloudFront/Alias 레코드 배포 권한 최소화.

---

## 20. 결론

IAM은 **정책의 합성**으로 최종 권한이 결정된다.
**명시적 Deny 최우선**, **최소 권한·세분화·조건**이 기본, 그리고 **경계(SCP/Boundary)·리소스정책·세션정책**으로 다층 방어.
**ABAC/페더레이션/교차계정/워크로드 역할**까지 통합하면 **대규모 조직**에서도 안전하고 민첩한 권한 운영이 가능하다.

---

## 부록 A) 빠른 참고 스니펫

### A-1) 시간대 제한(근무시간만 허용)
```json
{
  "Version":"2012-10-17",
  "Statement":[{
    "Effect":"Deny",
    "Action":"*",
    "Resource":"*",
    "Condition":{
      "DateLessThan":{"aws:CurrentTime":"2025-11-10T00:00:00Z"},
      "DateGreaterThan":{"aws:CurrentTime":"2025-11-10T09:00:00Z"}
    }
  }]
}
```

### A-2) S3 퍼블릭 차단(조직 밖 Principal 거부)
```json
{
  "Version":"2012-10-17",
  "Statement":[{
    "Effect":"Deny",
    "Principal":"*",
    "Action":"s3:*",
    "Resource":["arn:aws:s3:::secure-bkt","arn:aws:s3:::secure-bkt/*"],
    "Condition":{"StringNotEquals":{"aws:PrincipalOrgID":"o-abcd1234"}}
  }]
}
```

### A-3) 루트 보호(SCP 예)
```json
{
  "Version":"2012-10-17",
  "Statement":[
    {"Effect":"Deny","Action":["iam:*AccessKey*"],"Resource":"*"},
    {"Effect":"Deny","Action":["organizations:LeaveOrganization"],"Resource":"*"}
  ]
}
```

### A-4) 세션 정책으로 추가 축소(AssumeRole 시)
```bash
aws sts assume-role \
  --role-arn arn:aws:iam::123456789012:role/deployer \
  --role-session-name ci-deploy \
  --policy '{
    "Version":"2012-10-17",
    "Statement":[{"Effect":"Allow","Action":["s3:PutObject"],"Resource":"arn:aws:s3:::site/*"}]
  }'
```

---

## 부록 B) 자주 나는 오해/실수

- **“Allow가 있으면 된다”** → 리소스 정책·Boundary·SCP에서 거부 중일 수 있다.
- **`Resource:"*"` 남발** → 위험. 가능하면 **정확한 ARN** 지정.
- **MFA 조건 누락** → 운영·결제·보안 관련 API엔 필수.
- **IRSA 셋업 불일치** → ServiceAccount 주석의 Role ARN, OIDC Provider, Trust Policy 모두 일치해야 한다.
- **교차계정 AssumeRole 실패** → Principal/ExternalId/세션 태그, SCP 확인.
