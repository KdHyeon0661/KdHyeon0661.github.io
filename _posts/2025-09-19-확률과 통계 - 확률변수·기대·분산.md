---
layout: post
title: 확률과 통계 - 확률변수·기대·분산
date: 2025-09-19 15:25:23 +0900
category: 확률과 통계
---
# 2) 확률변수·기대·분산

> **목표**  
> - **PMF/PDF/CDF**로 이산·연속 확률변수(RV)를 엄밀하게 정의한다.  
> - **기대값(평균)**, **분산**, **공분산**, **상관계수**의 의미와 실무 계산법을 익힌다.  
> - **예제**: 세션당 페이지뷰(이산), 체류시간(연속), **CTR의 분산 추정**(이항·포아송 근사·델타법).  
> - **체크**: 선형결합·스케일링 규칙, **로그 변환 전후 해석**(로그정규, 젠슨 부등식, 델타법).

---

## 0. Hook — “같은 평균, 다른 분산은 완전히 다른 제품 경험”
- 두 기능이 모두 **CTR 3%**를 만든다고 해도, 한쪽은 **분산이 매우 큼**(날마다 요동), 다른 쪽은 **분산이 매우 작음**(안정).  
- **기대값**은 “보통”, **분산**은 “안정성”. 의사결정에서 둘 다 필요하다.

---

## 1. 확률변수: 이산·연속, PMF/PDF/CDF

### 1.1 정의
- **확률변수**: 표본공간의 사건을 실수로 매핑한 함수.  
- **이산형**: 값이 집합 $$\{x_1,x_2,\dots\}$$ 에만 나타남. **질량함수(PMF)** $$p_X(x)=P(X=x)$$.  
- **연속형**: 실수 구간에서 값. **밀도함수(PDF)** $$f_X(x)$$, **분포함수(CDF)** $$F_X(x)=P(X\le x)=\int_{-\infty}^x f_X(t)\,dt$$.

### 1.2 기본 성질
- 이산:  
  $$\sum_x p_X(x)=1,\quad p_X(x)\ge 0$$
- 연속:  
  $$\int_{-\infty}^{\infty} f_X(x)\,dx=1,\quad f_X(x)\ge 0$$

### 1.3 웹/앱 예
- **세션당 페이지뷰**: 이산. 왕왕 **포아송** 또는 **음이항(NB)** 모델로 근사.  
- **체류시간(초)**: 연속. **지수/감마/로그정규**가 자주 맞음.  
- **클릭여부**: 이산 {0,1}. **베르누이**.  
- **노출 $$n$$ 대비 클릭 수 $$C$$**: **이항** $$\text{Bin}(n,p)$$.

---

## 2. 기대값(기대), 분산(흩어짐), 표준편차

### 2.1 기대값
- 이산:  
  $$E[X]=\sum_x x\,p_X(x)$$
- 연속:  
  $$E[X]=\int_{-\infty}^{\infty} x\,f_X(x)\,dx$$
- **선형성**(핵심):  
  $$E[aX+bY]=aE[X]+bE[Y]$$

### 2.2 분산·표준편차
- 분산:  
  $$\mathrm{Var}(X)=E[(X-E[X])^2]=E[X^2]-(E[X])^2$$
- 표준편차:  
  $$\sigma_X=\sqrt{\mathrm{Var}(X)}$$

### 2.3 지표 해석 팁
- **CTR**의 평균은 “평균 전환확률”, 분산은 “그 확률의 샘플링 변동성”.  
- **ARPU**의 평균은 “1인당 평균매출”, 분산은 “유저 간 불균등/꼬리”.

---

## 3. 공분산·상관: 함께 움직임을 수치화
- **공분산**:  
  $$\mathrm{Cov}(X,Y)=E[(X-E[X])(Y-E[Y])]$$
- **상관계수**:  
  $$\rho_{XY}=\frac{\mathrm{Cov}(X,Y)}{\sigma_X\sigma_Y},\quad -1\le \rho\le 1$$

### 3.1 성질
- 스케일 변화:  
  $$\mathrm{Cov}(aX+b,cY+d)=ac\,\mathrm{Cov}(X,Y)$$  
  상관은 **상대적 척도**: 이동·스케일에 불변.
- 독립이면 공분산 0. 그러나 **공분산 0 ⇒ 독립**은 일반적 **아님**(비선형 의존 존재 가능).

### 3.2 퍼널 벡터와 공분산행렬
- 벡터 $$\mathbf{Z}=(N,K,V)^\top$$ (노출·클릭·전환 수)  
- **공분산행렬** $$\Sigma=E[(\mathbf{Z}-E[\mathbf{Z}])(\mathbf{Z}-E[\mathbf{Z}])^\top]$$  
  - 대각: 각 수치의 분산, 비대각: 쌍의 공분산.  
  - 의사결정: “클릭 수가 늘 때 전환 수도 함께 늘어나는가?”를 수학적으로 본다.

---

## 4. 세션당 페이지뷰: 포아송 vs 음이항(NB)

### 4.1 포아송 모델
- $$X\sim \text{Pois}(\lambda)$$  
  $$P(X=k)=e^{-\lambda}\frac{\lambda^k}{k!}$$  
  $$E[X]=\lambda,\quad \mathrm{Var}(X)=\lambda$$
- **적용**: “단위 세션에 랜덤한 페이지 진입”에 근사.

### 4.2 음이항(NB) 모델(과산포)
- $$X\sim \text{NB}(r,p)$$ (실무에선 mean–dispersion 파라미터화를 선호)  
  $$E[X]=\mu,\quad \mathrm{Var}(X)=\mu+\alpha\mu^2\quad(\alpha>0)$$  
- **포인트**: 데이터에서 **분산 > 평균**(과산포)이면 포아송보다 NB가 적합.

### 4.3 작은 예제
- 데이터 관찰: 평균 페이지뷰 2.2, 분산 5.4 → 분산이 평균보다 훨씬 큼 → **NB 후보**.  
- **의사결정**: 버스트 세션(바이럴 유입) 가능성, 캐싱/성능 설계에 반영.

---

## 5. 체류시간: 지수·감마·로그정규

### 5.1 지수·감마
- 지수 $$T\sim\text{Exp}(\lambda)$$:  
  $$f_T(t)=\lambda e^{-\lambda t}\;(t\ge0),\quad E[T]=\frac{1}{\lambda},\;\mathrm{Var}(T)=\frac{1}{\lambda^2}$$  
  **기억없음**:  
  $$P(T>s+t\mid T>s)=P(T>t)$$
- 감마 $$T\sim\text{Gamma}(k,\theta)$$:  
  $$E[T]=k\theta,\quad \mathrm{Var}(T)=k\theta^2$$  
  세션의 “다단계 체류”를 누적하는 해석에 쓰기 좋음.

### 5.2 로그정규 (heavy tail)
- $$X\sim \text{Lognormal}(\mu,\sigma^2)\iff \ln X \sim \mathcal{N}(\mu,\sigma^2)$$  
  $$E[X]=e^{\mu+\sigma^2/2},\quad \mathrm{Var}(X)=e^{2\mu+\sigma^2}(e^{\sigma^2}-1)$$
- **의미**: 체류시간·구매금액처럼 “곱셈적” 요인 합성에 자연스럽다. 평균이 **꼬리에 민감**.

### 5.3 로그 변환의 해석
- **젠슨 부등식**:  
  $$E[\log X]\le \log E[X]$$  
  로그 평균을 **역변환**하면 원래 평균과 다르다(바이어스 주의).  
- **델타법 근사**(뒤에서 CTR에도 사용):  
  $$\mathrm{Var}(g(X))\approx (g'(E[X]))^2\,\mathrm{Var}(X)$$

---

## 6. CTR(전환율)의 분산 추정: 이항·포아송·델타법

### 6.1 정의와 베르누이·이항
- 노출 $$n$$, 클릭 수 $$C\sim \text{Bin}(n,p)$$, **CTR** 추정량 $$\hat p=C/n$$.  
- **기대**:  
  $$E[\hat p]=p$$  
- **분산**:  
  $$\mathrm{Var}(\hat p)=\frac{p(1-p)}{n}$$

### 6.2 근사와 희귀 확률
- 작은 $$p$$, 큰 $$n$$ 에서 **포아송 근사**: $$C\approx \text{Pois}(\lambda=np)$$.  
  그러면  
  $$\mathrm{Var}(\hat p)=\frac{\lambda}{n^2}=\frac{p}{n}$$  
  (정확식의 $$p(1-p)/n$$ 과 매우 근접; 희귀사건이면 차이가 작음).

### 6.3 예제
- $$n=50{,}000,\; \hat p=0.012$$  
  $$\widehat{\mathrm{Var}}(\hat p)=\frac{0.012\times 0.988}{50{,}000}\approx 2.37\times 10^{-7}$$  
  $$\widehat{\mathrm{SE}}(\hat p)\approx 0.000487$$  
  95% 근사 CI(정규):  
  $$\hat p\pm 1.96\,\mathrm{SE}\approx 0.012\pm 0.00095$$  
  보고: **1.20% [1.10, 1.30]** 근사.

> 주의: 표본이 작거나 $$\hat p$$ 이 0/1에 가까우면 **Wald(정규) CI**는 불안정 → **Wilson/Agresti–Coull** 권장(전편 예고).

### 6.4 비율의 **가중 결합**(캠페인·세그먼트 합치기)
- 캠페인별 CTR을 평균 내는 **잘못된** 방법: 단순 평균  
  $$\frac{1}{m}\sum_{j=1}^m \hat p_j$$  
- 옳은 총 CTR: **비율의 비율**  
  $$\hat p_{\text{total}}=\frac{\sum_j C_j}{\sum_j n_j}$$  
- 분산은 **델타법**으로 근사(아래 6.5).

### 6.5 델타법(Delta method)로 **비율-의-비율** 분산
- $$\hat p=\frac{\sum_j C_j}{\sum_j n_j},\quad C_j\sim \text{Bin}(n_j,p_j)$$  
- 벡터 $$\mathbf{T}=(\sum_j C_j,\sum_j n_j)^\top$$, 함수 $$g(u,v)=u/v$$.  
- 델타법:  
  $$\mathrm{Var}(g(\mathbf{T}))\approx \nabla g^\top \,\Sigma_{\mathbf{T}}\,\nabla g$$  
  여기서  
  $$\nabla g=\left(\frac{\partial g}{\partial u},\,\frac{\partial g}{\partial v}\right)^\top=\left(\frac{1}{v},-\frac{u}{v^2}\right)^\top$$  
- 실무 포인트: **분모의 무작위성**까지 반영해야 분산이 과소추정되지 않는다(특히 짧은 기간·작은 캠페인 다수).

---

## 7. 표본 통계량: $$\bar X, S^2, S_{XY}, r$$

### 7.1 표본평균·표본분산(불편)
- 표본 $$x_1,\dots,x_n$$:  
  $$\bar X=\frac{1}{n}\sum_{i=1}^n x_i$$  
  $$S^2=\frac{1}{n-1}\sum_{i=1}^n (x_i-\bar X)^2$$
- 불편성: $$E[S^2]=\mathrm{Var}(X)$$

### 7.2 표본공분산·상관
- 공분산:  
  $$S_{XY}=\frac{1}{n-1}\sum_{i=1}^n (x_i-\bar X)(y_i-\bar Y)$$
- 피어슨 상관:  
  $$r=\frac{S_{XY}}{S_X S_Y}$$

### 7.3 벡터로 쓰면
- 데이터 행렬 $$\mathbf{Z}\in\mathbb{R}^{n\times d}$$, 각 행 사용자/세션, 열은 지표.  
- 표본 공분산행렬:  
  $$\hat\Sigma=\frac{1}{n-1}(\mathbf{Z}-\mathbf{1}\bar{\mathbf{z}}^\top)^\top(\mathbf{Z}-\mathbf{1}\bar{\mathbf{z}}^\top)$$

---

## 8. 선형결합·스케일링: 합·차·평균의 분산

### 8.1 규칙
- $$\mathrm{Var}(aX+bY)=a^2\mathrm{Var}(X)+b^2\mathrm{Var}(Y)+2ab\,\mathrm{Cov}(X,Y)$$
- 독립이면 공분산 0.  
- **합의 평균**: $$\mathrm{Var}\!\left(\frac{X_1+\cdots+X_n}{n}\right)=\frac{\sigma^2}{n}$$ (독립·동분산 가정).

### 8.2 지표 합성 예
- **ARPU**를 **세션·체류시간**으로 설명:  
  $$\mathrm{Var}(\text{ARPU})\approx a^2\mathrm{Var}(\text{Sessions})+b^2\mathrm{Var}(\text{Time})+2ab\,\mathrm{Cov}(\text{Sessions},\text{Time})$$  
- 공분산 부호에 따라 **안정성**이 바뀜(같이 오르면 분산↑).

---

## 9. 로그 변환: 왜, 언제, 어떻게 해석하나

### 9.1 동기
- 양수·꼬리 두꺼운 분포(체류시간·구매금액)는 로그 변환으로 **대칭성·정규성** 접근.  
- 회귀에서 계수의 **상대효과**(퍼센트 변화) 해석에 유리.

### 9.2 수식과 주의
- 젠슨: $$E[\log X]\le \log E[X]$$  
- 로그-정규 역변환 바이어스:  
  $$E[X]\neq \exp(E[\log X])$$  
  로그-정규 가정 시:  
  $$E[X]=\exp(\mu+\sigma^2/2)$$

### 9.3 델타법으로 역변환 평균 보정(간단 근사)
- $$Y=\log X,\ \hat\mu=\bar Y,\ \hat\sigma^2=S_Y^2$$  
  $$\widehat{E[X]}\approx \exp\left(\hat\mu+\frac{\hat\sigma^2}{2}\right)$$

---

## 10. 조건부 기대와 분산 분해(ANOVA 분해)

### 10.1 전개식
- **총분산의 분해**:  
  $$\mathrm{Var}(X)=E[\mathrm{Var}(X\mid Z)]+\mathrm{Var}(E[X\mid Z])$$
- 해석: **세그먼트 내부 변동** + **세그먼트 간 평균 차이**.

### 10.2 퍼널 예
- $$X=\mathbf{1}\{\text{전환}\}$$, $$Z=(\text{디바이스},\ \text{유입})$$.  
- 세그먼트별로 내부 변동이 크면(표본 적음), 전체 불확실성이 커짐 → **가중 절충** 필요.

---

## 11. 실전 예제 1 — CTR 차이의 불확실성

### 11.1 A/B CTR 비교
- A: $$n_A=100{,}000,\; \hat p_A=0.030$$  
- B: $$n_B=80{,}000,\; \hat p_B=0.033$$  
- 차이: $$\hat\Delta=\hat p_B-\hat p_A=0.003$$

### 11.2 표준오차(SE)
- 독립 가정에서  
  $$\widehat{\mathrm{SE}}(\hat\Delta)=\sqrt{\frac{\hat p_A(1-\hat p_A)}{n_A}+\frac{\hat p_B(1-\hat p_B)}{n_B}}$$  
  수치:  
  $$\approx \sqrt{\frac{0.03\cdot 0.97}{100000}+\frac{0.033\cdot 0.967}{80000}}\approx 0.00073$$

### 11.3 95% 근사 CI
- $$\hat\Delta\pm 1.96\,\mathrm{SE}\approx 0.003\pm 0.00143$$  
- 보고: **+0.30pp [ +0.16, +0.44 ]**(정규 근사).  
- 표본이 더 작거나 $$\hat p$$ 이 극단이면 **정확검정** 또는 **Wilson**을 고려.

---

## 12. 실전 예제 2 — 캠페인 합치기: 평균의 함정 vs 비율의 비율

### 12.1 잘못된 단순 평균
- 캠페인 CTR: 1%, 3%, 7% ⇒ 단순 평균 3.67%  
- 노출(분모)이 각각 10k, 10k, 1k라면?

### 12.2 옳은 총 CTR
- 총 클릭: 100 + 300 + 70 = 470  
- 총 노출: 21k ⇒ 총 CTR = 470/21000 ≈ **2.24%**  
- **교훈**: **가중치**(분모)가 다르면 단순 평균은 왜곡.

### 12.3 분산(델타법 힌트)
- 총 CTR의 분산은 각 캠페인의 **공분산** 구조까지 고려(공동 변동)하면 더 정확.

---

## 13. 실전 예제 3 — 세션당 페이지뷰 분산이 인프라에 주는 메시지

### 13.1 포아송 가정
- 평균 2.0 → 분산도 2.0  
- 초당 요청량의 변동을 예측 가능(부하테스트 설계).

### 13.2 음이항 가정(과산포)
- 평균 2.0, 분산 6.0(예: $$\alpha=1$$ 가정)  
- **버스트** 상황에 대비 필요(캐싱·큐잉·오토스케일 정책 상향).

---

## 14. 실전 예제 4 — 체류시간 로그정규의 기대·분산

### 14.1 추정치
- $$\log T\sim \mathcal{N}(\hat\mu=2.1,\hat\sigma^2=0.7^2)$$  
- 기대:  
  $$\widehat{E[T]}=\exp\left(2.1+\frac{0.49}{2}\right)=\exp(2.345)\approx 10.43\ \text{s}$$
- 분산:  
  $$\widehat{\mathrm{Var}}(T)=\exp(2\cdot 2.1+0.49)\left(e^{0.49}-1\right)$$  
  수치상 **매우 큼** → 평균 하나로 설명하기 어렵다.

### 14.2 해석
- **중앙값**은 $$\exp(\mu)=\exp(2.1)\approx 8.17s$$, 평균보다 작다(꼬리 때문).  
- 보고 시 **중앙값+사분위** 병기 권장.

---

## 15. 구현 스니펫(개념 확인용) — 샘플 통계량 계산
```python
# 개념 데모용: 표본 평균/분산/공분산/상관
import math

def mean(xs):
    return sum(xs)/len(xs)

def var(xs):
    m = mean(xs)
    return sum((x - m)**2 for x in xs)/(len(xs)-1)

def cov(xs, ys):
    mx, my = mean(xs), mean(ys)
    return sum((x-mx)*(y-my) for x, y in zip(xs, ys))/(len(xs)-1)

def corr(xs, ys):
    vx, vy = var(xs), var(ys)
    return cov(xs, ys)/math.sqrt(vx*vy)

# 예: 사용자별 (세션수, 체류시간초)
sessions = [1,2,2,3,1,4,2,1]
time_sec = [5,10,8,15,4,20,7,6]

print("mean sessions:", mean(sessions))
print("var sessions:", var(sessions))
print("corr(sessions,time):", corr(sessions, time_sec))
```

---

## 16. 체크리스트 — 본 장 핵심 문장 패턴
- [정의] **PMF/PDF/CDF**를 헷갈리지 않는가?  
- [평균] **선형성**: $$E[aX+bY]=aE[X]+bE[Y]$$  
- [분산] 합의 분산: $$\mathrm{Var}(aX+bY)=a^2\mathrm{Var}(X)+b^2\mathrm{Var}(Y)+2ab\,\mathrm{Cov}(X,Y)$$  
- [CTR] $$\mathrm{Var}(\hat p)=p(1-p)/n$$, 희귀사건은 포아송 근사 가능.  
- [비율합치기] 총 CTR은 **비율의 비율**, 분모 랜덤성은 **델타법**으로.  
- [체류] 로그 변환의 **역변환 바이어스**와 **젠슨**을 이해했는가?  
- [공분산] 상관 0은 독립을 뜻하지 않는다(비선형 의존 가능).  
- [분산분해] $$\mathrm{Var}(X)=E[\mathrm{Var}(X|Z)]+\mathrm{Var}(E[X|Z])$$

---

## 17. 심화: 모멘트·MGF, 꼬리제어(마르코프·체비셰프) 한 줄 맛보기
- **MGF**: $$M_X(t)=E[e^{tX}]$$, 모멘트 유도·합의 분포 도출에 유용(정규·포아송 등).  
- **마르코프 부등식**: $$P(X\ge a)\le \frac{E[X]}{a}$$  
- **체비셰프**: $$P(|X-E[X]|\ge k\sigma)\le \frac{1}{k^2}$$  
  극단 체류시간 비율의 **상계**로 직관을 준다.

---

## 18. 미니 퀴즈(개념+실무)

**Q1.** $$X\sim \text{Pois}(\lambda)$$ 일 때 $$E[X],\ \mathrm{Var}(X)$$ 는?  
→ $$E[X]=\lambda,\ \mathrm{Var}(X)=\lambda$$

**Q2.** CTR 추정량 $$\hat p=C/n$$ 의 분산은? 희귀사건에서 포아송 근사 시 어떻게 단순화되는가?  
→ $$\mathrm{Var}(\hat p)=\frac{p(1-p)}{n}\approx \frac{p}{n}$$

**Q3.** 로그정규 $$X$$ 에 대해 $$E[X]$$ 와 중앙값의 관계는?  
→ $$\text{median}(X)=e^\mu\lt E[X]=e^{\mu+\sigma^2/2}$$

**Q4.** 총분산 분해 공식과 퍼널 세그먼트 해석은?  
→ $$\mathrm{Var}(X)=E[\mathrm{Var}(X|Z)]+\mathrm{Var}(E[X|Z])$$. 내부변동+세그먼트 간 차이.

---

## 19. 한 페이지 요약 (TL;DR)
- **정의**: 이산→PMF, 연속→PDF, 공통→CDF.  
- **평균·분산**: 선형성, 합의 분산 규칙은 모든 모델의 뼈대.  
- **CTR**: 이항 기반 분산, 희귀사건 포아송 근사, **비율의 비율**과 **델타법**.  
- **체류시간**: 로그정규가 잦다. 로그 해석과 역변환 바이어스 주의.  
- **공분산·상관**: 함께 움직임(퍼널 벡터), 상관 0이 독립을 뜻하진 않는다.  
- **분산분해**: 세그먼트 내부/간 변동을 분리해 본다.