---
layout: post
title: Git - SSH 키
date: 2025-01-19 21:20:23 +0900
category: Git
---
# GitHub에서 SSH 키 사용하

## 0. SSH 키란?

**SSH 키**는 공개키(Public Key)–개인키(Private Key) 쌍으로 이루어진 인증 자격입니다.  
- 공개키: GitHub 계정에 **등록**  
- 개인키: 로컬에 **비밀 보관**(유출 금지, 암호문구 권장)

SSH 키를 설정하면 Git 작업(Pull/Push/Fetch 등)을 **암호 입력 없이 안전하게** 수행할 수 있습니다.

---

## 1. SSH 키 생성(권장 파라미터 포함)

기본(권장: ED25519, 암호문구 설정):
```bash
ssh-keygen -t ed25519 -a 64 -o -C "your_email@example.com"
```
- `-t ed25519`: 최신/간결/고성능 곡선
- `-a 64`: KDF 라운드 증가(브루트포스 방어 강화)
- `-o`: 현대적 포맷으로 개인키 저장
- `-C`: 키 식별용 주석(이메일/호스트명 등)

출력 예:
```
Generating public/private ed25519 key pair.
Enter file in which to save the key (/home/user/.ssh/id_ed25519):
```
- 엔터로 기본 경로 저장(기존 키가 있으면 **덮어쓰기 금지**)
- 이어서 **암호문구(passphrase)** 입력(권장)

대안: **하드웨어 보안키(FIDO2/U2F)** 기반(터치 필요)
```bash
ssh-keygen -t ed25519-sk -C "yubikey@example.com"
```
- `-sk` 타입은 보안키가 필요하며 복제 어려움(피싱·스니핑에 강함)

RSA(레거시 호환이 필요한 경우만):
```bash
ssh-keygen -t rsa -b 4096 -a 64 -o -C "legacy@example.com"
```

---

## 2. 공개키 확인·복사 및 등록

공개키 출력:
```bash
cat ~/.ssh/id_ed25519.pub
```
출력 예:
```
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... your_email@example.com
```

GitHub 등록 절차:
1) GitHub → **Settings** → **SSH and GPG keys**  
2) **New SSH key**  
3) Title(예: “My Laptop”) / Key(복사한 공개키 붙여넣기)  
4) **Add SSH key**

여러 장비(회사/개인 PC, WSL 등)는 **장비별로 별도 키**를 만들어 각각 등록합니다.

---

## 3. SSH 연결 테스트(known_hosts 신뢰 수립)

```bash
ssh -T git@github.com
```
처음엔 호스트 신뢰 여부 질문이 뜹니다:
```
The authenticity of host 'github.com' can't be established.
Are you sure you want to continue connecting (yes/no)?
```
- `yes` 입력 → `~/.ssh/known_hosts`에 호스트 키가 저장
- 성공 메시지:
```
Hi <username>! You've successfully authenticated, but GitHub does not provide shell access.
```

호스트 키 사전 등록(자동화/CI 등에서):
```bash
ssh-keyscan -t rsa,ecdsa,ed25519 github.com >> ~/.ssh/known_hosts
```
> 실제 지문 값은 수시로 검증 가능한 공식 채널을 통해 확인하십시오.

---

## 4. 원격 주소를 SSH로 변경/클론

기존 HTTPS → SSH로 교체:
```bash
git remote set-url origin git@github.com:username/repo-name.git
git remote -v
```

새로 클론(SSH):
```bash
git clone git@github.com:username/repo-name.git
```

서브모듈도 SSH로 동기화(혼합 방지):
```bash
git submodule sync --recursive
git submodule update --init --recursive
```
`.gitmodules` 안 URL이 HTTPS라면 SSH로 수정 후 `git submodule sync` 수행.

---

## 5. ssh-agent 사용(키 자동 로드)

에이전트 시작 및 키 등록:
```bash
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519
ssh-add -l          # 등록 키 목록
```

운영체제별 팁:
- **macOS**: 키체인 연동
  ```bash
  ssh-add --apple-use-keychain ~/.ssh/id_ed25519
  # 또는 설정 파일로
  cat >> ~/.ssh/config <<'EOF'
  Host *
    AddKeysToAgent yes
    UseKeychain yes
    IdentityFile ~/.ssh/id_ed25519
  EOF
  ```
- **Windows(Git for Windows)**: Git Credential Manager와 병행 가능  
- **Linux/WSL**: `~/.profile` 혹은 데스크톱 환경에서 agent 자동 시작 스크립트 사용

---

## 6. 여러 키/여러 계정/여러 호스트 관리 — `~/.ssh/config`

### 6.1 단일 계정·단일 키(기본값)
```sshconfig
Host github.com
  HostName github.com
  User git
  AddKeysToAgent yes
  IdentityFile ~/.ssh/id_ed25519
  IdentitiesOnly yes
```

### 6.2 개인/회사 **두 계정** 구분
```sshconfig
# 개인 계정
Host github.com
  HostName github.com
  User git
  IdentityFile ~/.ssh/id_ed25519_personal
  IdentitiesOnly yes

# 회사 계정(호스트 별칭 사용)
Host github-work
  HostName github.com
  User git
  IdentityFile ~/.ssh/id_ed25519_work
  IdentitiesOnly yes
```
- 회사 리포는 주소를 `git@github-work:org/repo.git` 으로 사용(별칭 `github-work` 활용)

### 6.3 저장소별 원격 변경 예
```bash
# 개인 저장소
git remote set-url origin git@github.com:myuser/pet-project.git

# 회사 저장소(별칭 사용)
git remote set-url origin git@github-work:myorg/core-service.git
```

---

## 7. 조직/보안 고려사항(실무 필수)

1) **2FA 활성화**: 계정 탈취 리스크 감소  
2) **키 회전 주기**: 분기/반기에 한 번씩 키 **재발급·구키 폐기**  
3) **키 범위 최소화**: 장비별로 키 분리, 분실 시 해당 키만 폐기  
4) **접근 권한 최소화**: 불필요한 쓰기 권한 제거  
5) **감사 및 모니터링**: GitHub **Recent security events**·키 등록 이력 확인  
6) **조직 정책**: 포크 허용 여부, SSO/SAML, IP Allowlist, 감사 로그

개인키 권한 문제(UNIX 권장):
```bash
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_ed25519
chmod 644 ~/.ssh/id_ed25519.pub
chmod 644 ~/.ssh/config
```

---

## 8. 고급: **SSH 기반 커밋/태그 서명(Verified 배지)**

Git은 GPG 외에 **SSH 키로 커밋 서명**을 지원합니다(서명 검증은 호스트별 정책에 따름).  
설정:
```bash
git config --global gpg.format ssh
git config --global user.signingkey ~/.ssh/id_ed25519.pub
git config --global commit.gpgsign true
```
서명 테스트:
```bash
git commit -S -m "docs: enable SSH signing"
```
- 호스트가 SSH 서명을 “Verified”로 표기하려면 해당 플랫폼 정책에 맞게 **공개키 등록/서명 타입 지원**이 필요합니다.  
- GPG 서명과 비교해 배포·운용이 쉬운 장점이 있습니다.

---

## 9. 하드웨어 보안키(FIDO2)로 GitHub 사용

키 생성:
```bash
ssh-keygen -t ed25519-sk -C "hwkey@example.com"
```
특징:
- **피싱·MITM 저항성**(사용자 터치/프레즌스 필요)
- 분실 대비 **여분 키** 권장(Primary/Backup 두 개 등록)
- 일부 환경/리더기 호환성 확인 필요

사용은 일반 SSH 키와 동일(원격 설정만 같음). 잠금 화면·정책에 따라 터치/핀 요구.

---

## 10. 프록시/점프호스트/사내망

HTTPS만 허용되는 망에서 SSH를 쓰려면 네트워크 정책이 필요합니다. SSH가 가능한 경우:

### 10.1 JumpHost(배스천) 경유
```sshconfig
Host bastion
  HostName bastion.company.internal
  User myid
  IdentityFile ~/.ssh/id_ed25519_work

Host github-work
  HostName github.com
  User git
  ProxyJump bastion
  IdentityFile ~/.ssh/id_ed25519_work
  IdentitiesOnly yes
```

### 10.2 ProxyCommand/ProxyJump(전용 프록시 활용)
```sshconfig
Host github.com
  HostName github.com
  User git
  ProxyJump proxy.company.internal
  IdentityFile ~/.ssh/id_ed25519
```
- 인프라 정책과 보안 가이드를 반드시 준수하세요.

---

## 11. CI/CD와 **배포 키(Deploy Key)**, 머신 사용자

- **Deploy Key**: 특정 리포지토리 단위로 등록되는 **SSH 공개키**(읽기 전용/쓰기 가능 선택).  
  - 프로젝트/조직 토큰 공유 없이, **그 리포 하나**만 접근시키고 싶을 때 적합.
- **머신 사용자(Machine User)**: 별도 GitHub 사용자 계정을 만들어 **PAT/SSH**로 CI가 접근.  
  - 여러 리포 접근/권한이 필요할 때 사용.

CI에서 호스트 키 신뢰(known_hosts) 사전 구성:
```bash
mkdir -p ~/.ssh && chmod 700 ~/.ssh
ssh-keyscan github.com >> ~/.ssh/known_hosts
chmod 644 ~/.ssh/known_hosts
```

---

## 12. 서브모듈과 SSH

서브모듈 초기화/업데이트:
```bash
git submodule update --init --recursive
```
서브모듈 원격을 SSH로 통일:
```bash
git config -f .gitmodules submodule.<path>.url git@github.com:org/sub.git
git submodule sync --recursive
```
얕은 클론과 함께 쓰는 경우(속도 최적화):
```bash
git clone --recurse-submodules --depth 1 git@github.com:org/main.git
git submodule update --init --recursive --depth 1
```

---

## 13. 실전 시나리오

### 13.1 개인/회사 계정 동시 사용
```bash
# 키 2개 생성
ssh-keygen -t ed25519 -a 64 -C "me.personal@example.com" -f ~/.ssh/id_ed25519_personal
ssh-keygen -t ed25519 -a 64 -C "me.work@example.com"     -f ~/.ssh/id_ed25519_work

# 설정
cat > ~/.ssh/config <<'EOF'
Host github.com
  HostName github.com
  User git
  IdentityFile ~/.ssh/id_ed25519_personal
  IdentitiesOnly yes

Host github-work
  HostName github.com
  User git
  IdentityFile ~/.ssh/id_ed25519_work
  IdentitiesOnly yes
EOF

# 사용
git clone git@github.com:myuser/pet-repo.git
git clone git@github-work:myorg/core-repo.git
```

### 13.2 기존 HTTPS 프로젝트를 SSH로 마이그레이션(서브모듈 포함)
```bash
git remote set-url origin git@github.com:org/app.git
git submodule foreach 'git remote set-url origin $(git config --get remote.origin.url | sed "s#https://github.com/#git@github.com:#")'
git submodule sync --recursive
```

---

## 14. 자주 발생하는 오류와 해결

| 증상/메시지 | 원인 | 해결 |
|---|---|---|
| `Permission denied (publickey)` | 키 미등록/에이전트 미로딩/권한 문제 | `ssh-add -l`, `ssh -T git@github.com`, 권한(600), GitHub에 공개키 등록, `IdentitiesOnly yes` |
| `bad permissions` | `~/.ssh`/개인키 권한 과다 | `chmod 700 ~/.ssh; chmod 600 ~/.ssh/id_*` |
| `Load key ... invalid format` | 키 파일 손상/CRLF 변환 | 유닉스 개행 유지, 재생성 |
| `Host key verification failed` | known_hosts 불일치/중간자 공격 의심 | `ssh-keygen -R github.com` 후 재등록, 공식 지문 확인 |
| 무한 자격 프롬프트 | HTTPS로 클론함 | SSH 원격으로 전환 혹은 Credential Manager 점검 |
| 포크/PR CI에서 시크릿 미노출 | 보안 설계 | 메인 저장소 브랜치에서만 시크릿 사용/배포, 워크플로 조건 분기 |
| 서브모듈 업데이트 실패 | 서브모듈 권한/URL 문제 | 서브모듈 URL을 SSH로 전환, 접근 권한 확인, `git submodule sync` |

디버깅 명령:
```bash
ssh -vT git@github.com        # 상세 로그
GIT_SSH_COMMAND="ssh -v" git fetch origin
```

---

## 15. 운영 수칙 요약(체크리스트)

- [ ] ED25519 또는 FIDO2(보안키) 사용, **암호문구 필수**  
- [ ] 장비별 키 분리, 필요 시만 권한 부여  
- [ ] 정기 키 회전 및 불용 키 폐기  
- [ ] `~/.ssh/config`로 **여러 키/계정** 관리  
- [ ] CI에는 Deploy Key 또는 머신 사용자 사용, 시크릿 최소화  
- [ ] 서브모듈·LFS·프록시·배스천 고려  
- [ ] 문제 발생 시 `ssh -vT`, 권한·known_hosts·config 순서로 점검

---

## 16. 핵심 명령 모음

```bash
# 키 생성(권장)
ssh-keygen -t ed25519 -a 64 -o -C "you@example.com"

# 하드웨어 보안키(FIDO2)
ssh-keygen -t ed25519-sk -C "you+hw@example.com"

# 에이전트 등록
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519

# 공개키 출력/등록
cat ~/.ssh/id_ed25519.pub     # GitHub Settings > SSH and GPG keys > New SSH key

# 연결 테스트
ssh -T git@github.com

# 원격 변경(HTTPS -> SSH)
git remote set-url origin git@github.com:username/repo.git

# 서브모듈 동기화
git submodule sync --recursive
git submodule update --init --recursive

# 디버깅
ssh -vT git@github.com
```

---

## 참고
- GitHub Docs — Connecting to GitHub with SSH  
  https://docs.github.com/en/authentication/connecting-to-github-with-ssh
- OpenSSH manual — `ssh`, `ssh-keygen`, `ssh_config`  
  https://man.openbsd.org/
- Git — Signing commits (SSH/GPG)  
  https://git-scm.com/docs