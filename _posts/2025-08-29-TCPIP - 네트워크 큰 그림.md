---
layout: post
title: TCPIP - 네트워크 큰 그림
date: 2025-08-29 15:25:23 +0900
category: TCPIP
---
# 네트워크 큰 그림

> 이 글은 “OSI 7계층 vs TCP/IP 4계층 비교”, “인터넷을 이루는 구성요소(호스트·라우터·ASN·IANA/RIR)”, “패킷의 엔드투엔드 여정”, “각 계층 역할 요약”을 **실무 예제와 관찰 포인트 중심**으로 풀어냅니다.
> 코드 대신 **명령·패킷·다이어그램·수치**에 집중합니다. 수식은 MathJax로 표기합니다.

---

## 왜 ‘큰 그림’인가

- 장애/성능 이슈의 **표면 증상**은 L7(앱)에서 나타나지만, **근본 원인**은 L2~L4에 숨는 경우가 많습니다.
- 계층별로 “무엇이 정상이고, 무엇이 비정상인지”를 아는 것이 **가설→검증 루프**의 속도를 좌우합니다.
- 이후 글(라우팅, TCP, NAT, HTTP/3 등)을 이해하기 위한 **공용 어휘**를 여기서 통일합니다.

---

## OSI 7계층 vs TCP/IP 4계층

### 큰 비교표(실무 대응 예시 포함)

| 구분 | OSI 7계층 | TCP/IP 4계층(실무) | 대표 프로토콜/장비/개념(예시) | 주 관찰 포인트 |
|---|---|---|---|---|
| L1 | 물리(Physical) | 링크(Link)의 하위 | 광/구리, 전파, 케이블, 파워레벨 | 링크 업/다운, 오류율, 신호세기 |
| L2 | 데이터링크(Data Link) | 링크(Link) | Ethernet, Wi-Fi, VLAN(802.1Q), ARP, PPP | MAC, MTU, FCS, 브로드캐스트, STP |
| L3 | 네트워크(Network) | 인터넷(Internet) | IPv4/IPv6, ICMP, 라우팅, NAT | TTL, 경로, 프래그멘트, DSCP/ECN |
| L4 | 전송(Transport) | 전송(Transport) | TCP, UDP, (QUIC은 L4/L7 사이 성격) | 포트, 핸드셰이크, 재전송, 혼잡제어 |
| L5 | 세션(Session) | 응용(Application) | TLS의 세션 개념, RPC 세션 | 세션 재개(0-RTT 등) |
| L6 | 표현(Presentation) | 응용(Application) | TLS(암호화), 인코딩, 압축 | 핸드셰이크, 인증서, ALPN |
| L7 | 응용(Application) | 응용(Application) | HTTP(S), DNS, SMTP, gRPC, MQTT | 상태코드, 헤더, 캐시, 멀티플렉싱 |

> **실무 팁**: 장비는 엄격히 한 계층에만 속하지 않습니다. 예를 들어 **L3 스위치**는 스위칭(L2)과 라우팅(L3)을 **하나의 박스**에서 수행합니다.

### 계층별 “장애 패턴” 감별 퀵가이드

- **L1/L2 문제**: 간헐적 링크 다운, 같은 L2에서만 발생, **작은 패킷은 되는데 큰 패킷이 깨짐(MTU/FCS)**, 특정 포트/SSID만 문제.
- **L3 문제**: 특정 경로만 느리거나 단절, **서브넷 밖**에서만 문제, **TTL** 빠르게 소모, PMTUD 블랙홀.
- **L4 문제**: **SYN/ACK 불균형**, 재전송 급증, **TIME_WAIT 폭증**, 포트 기반 정책 충돌.
- **L7 문제**: HTTP 4xx/5xx, 특정 API 콜만 느림, 캐시/쿠키/압축/멀티플렉싱 이슈.

---

## 인터넷의 구성요소: 호스트, 라우터, ASN, IANA/RIR

### 호스트 vs 스위치 vs 라우터(+ 방화벽/NAT)

- **호스트**: 최종 소비자/서버(PC, 모바일, VM, Pod 등). IP 스택과 포트를 열고 닫습니다.
- **스위치(L2)**: MAC 기반으로 프레임을 포워드. 브로드캐스트 도메인을 형성. VLAN으로 L2 분리.
- **라우터(L3)**: IP 경로 결정을 수행. 서로 다른 L2 도메인을 이어줌.
- **방화벽/게이트웨이**: 상태추적(STATEFUL) 정책, NAT, ALG 등을 수행하는 **경계 장비**.

### ASN(Autonomous System Number)과 BGP

- **AS(자율 시스템)**: 하나의 정책으로 운영되는 IP 네트워크 집합(대개 ISP/대형 기업).
- **ASN**: 각 AS를 식별하는 번호. **프라이빗 ASN**(예: 64512–65534)은 인터넷 공개 경로에 광고되지 않음.
- **BGP**: AS 간 라우팅 프로토콜. 경로(AS PATH), 정책(LocalPref, MED)로 트래픽 흐름을 제어.
- **멀티호밍**: 여러 상위 ISP에 동시에 연결해 가용성과 경로 품질을 확보.

### IANA·RIR: 주소와 번호 자원의 관리자

- **IANA**: 글로벌 자원(IPv4/IPv6 블록, ASN, 포트 번호)의 최상위 관리자.
- **RIR(지역 인터넷 등록기관)**: ARIN(북미), RIPE NCC(유럽), **APNIC(아시아·태평양)**, LACNIC(라틴), AFRINIC(아프리카).
- 흐름: IANA → RIR → LIR(ISP/기업) → 최종 사용자.
- **특수·문서용 주소 공간**(알아두면 실무 편함)
  - IPv4 사설: `10.0.0.0/8`, `172.16.0.0/12`, `192.168.0.0/16`
  - CGNAT: `100.64.0.0/10`
  - 루프백: `127.0.0.0/8` (`127.0.0.1`)
  - 링크로컬: `169.254.0.0/16`
  - 문서용: `192.0.2.0/24`, `198.51.100.0/24`, `203.0.113.0/24`
  - IPv6 링크로컬: `fe80::/10`, 루프백 `::1`, ULA `fc00::/7`, 문서용 `2001:db8::/32`, NAT64 `64:ff9b::/96`

### 인터넷 “물류망” 한 컷

```
[내 단말]--(Wi-Fi/LAN)-->[가정 공유기/NAT]--(ISP 엣지)-->[ISP 백본]--(IXP/피어링)-->
[국제 트랜짓/해저케이블]---> [CDN 엣지/클라우드 PoP] ---> [서비스 원서버/오리진]
```
- **경우에 따라** CDN 엣지에서 응답이 끝나고(캐시 히트), 오리진까지 가지 않습니다.
- 같은 목적지라도 **BGP 정책, Anycast, IXP 혼잡**에 따라 경로·지연이 크게 달라집니다.

---

## 패킷이 이동하는 과정(엔드투엔드)

> 시나리오: 브라우저에서 `https://www.example.com`을 연다.
> 관찰 포인트: DNS, 연결(QUIC/TCP+TLS), MTU/PMTUD, NAT/게이트웨이, 라우팅, 응답/캐시.

### DNS 해석(이름 → 주소)

1) **스텁 리졸버**(내 단말)가 **재귀 DNS**(대개 ISP/OS 설정)를 조회.
2) 재귀 DNS가 **루트 → TLD → 권한(Authoritative)** 서버 순으로 따라가 IP를 얻고 캐시.
3) **A(IPv4), AAAA(IPv6)** 응답을 받으면, 클라이언트는 **Happy Eyeballs** 전략으로 IPv6/IPv4 중 더 빠른 경로를 선택.

- 관찰 팁: 같은 도메인이라도 **지역/Anycast**에 따라 A/AAAA의 **지연·경로가 다를 수 있음**(CDN).

### 연결: QUIC vs TCP(+TLS)

- **HTTP/3(QUIC)**: UDP 기반, **핸드셰이크와 암호화(TLS 1.3)**를 결합해 **빠른 시작**(0-RTT) 가능.
- **HTTP/2/1.1**: 보통 **TCP 3-way** 후 **TLS**(1.2/1.3) 핸드셰이크.

**TCP 3-way 핵심**
```
클 → 서 : SYN (ISN=x)
서 → 클 : SYN+ACK (ISN=y, ACK=x+1)
클 → 서 : ACK (ACK=y+1)  → 연결 성립
```
- 이후 **TLS**: SNI(Server Name Indication), 인증서 검증, **ALPN**으로 `h2`(HTTP/2) 등 선택.

> **주의**: QUIC은 전송과 암호화를 통합해, 중간의 재암호화 프록시나 L4 기반 장비의 가시성이 줄어듭니다(옵저버빌리티 전략이 달라짐).

### 로컬 네트워크: ARP/NDP, 게이트웨이, L2 포워딩

- 목적지가 **로컬 서브넷 밖**이면 **기본 게이트웨이**로 보냄.
- 이때 **게이트웨이 MAC**이 필요하므로 **ARP(IPv4)/NDP(IPv6)**로 MAC을 학습.
- 스위치는 **MAC 테이블**을 통해 올바른 포트로 프레임을 전달(VLAN 고려).

### NAT(가정/기업 경계)과 포트

- 사설 IP → **공인 IP로 변환**되며, 출발지 **에페메럴 포트**가 바뀜(NAPT).
- **Hairpin NAT**(내부에서 외부공인IP→다시 내부) 같은 패턴도 존재.
- ALG가 특정 프로토콜(SIP/FTP)의 **포트 내 주소**를 보정하기도 함.

### ISP 경로, BGP, ECMP

- 패킷은 ISP 라우터를 거치며 **BGP**로 학습한 경로로 **다음 홉 AS**로 이동.
- **ECMP(동일 비용 다중 경로)** 해시로 다수의 링크에 분산될 수 있으며 **역방향 경로가 다르게** 잡힐 수 있음(비대칭 경로).

### MTU / PMTUD / 프래그멘테이션

- 이더넷 MTU가 보통 **1500바이트**(점점 **Jumbo 9000**도 보급).
- 경로 중 더 작은 MTU가 있으면, `DF`(Don’t Fragment)가 설정된 패킷은 **ICMP Too Big**으로 알려줍니다(**PMTUD**).
- **ICMP 필터링**이 과도하면 “큰 응답에서만 끊김” 같은 **PMTUD 블랙홀**이 발생.

> **미니 체크**: “작은 요청은 되는데 큰 파일/이미지 응답만 뚝 끊긴다?” → **MTU/MSS/PMTUD**를 우선 점검.

### 큐·혼잡·QoS

- 병목 링크에서 큐잉이 발생하고, 과도하면 **버퍼블로트**로 지연이 급증.
- **DSCP/ECN**으로 큐 관리/혼잡 신호를 활용하는 환경도 있음(엔터프라이즈/데이터센터).

### 서버 측: LB·프록시·캐시

- L4/L7 **로드밸런서**(혹은 Anycast) → 리버스 프록시 → 오리진 앱/스토리지.
- CDN/프록시에서 **캐시 히트** 시, 오리진까지 가지 않고 응답.

### 응답과 연결 수명

- **HTTP/2**: 하나의 TCP 연결에서 **멀티플렉싱**.
- **HTTP/3(QUIC)**: 스트림 독립, **HOB(Head-of-line) 블로킹 완화**.
- Keep-Alive/세션 재개로 **추가 RTT**를 절약, 모바일·고지연 환경에서 체감 개선.

---

## 작은 관찰 예제(현장 손맛)

### 경로와 지연의 시간 변동

```text
목표: 같은 도메인에 대해 아침/저녁/심야 3회씩 RTT와 홉 수를 관찰
관찰: RTT 평균/최대/표준편차, 경로 변화(중간 ASN/도시), 패킷 손실 유무
가설: 피크 시간대 IXP/트랜짓 혼잡 → RTT↑/손실↑
```

### MTU 문제 의심 재현(개념)

```text
A. 작은 응답(텍스트/JSON)은 성공, 큰 이미지/다운로드는 Hang
B. DF 비트 유지한 채 큰 패킷 전송 → ICMP Too Big 수신 여부 확인
C. ICMP가 차단된 경로라면 MSS 클램핑/MTU 조정으로 우회 가능성 검토
```

### NAT 포트 매핑 감각 익히기

```text
동시 다발적인 아웃바운드 연결 발생 시: 사설IP:Ephemeral → 공인IP:MappedPort
관찰: 포트 범위/여유, 세션 타임아웃, Hairpin NAT 시나리오
```

---

## 각 계층 역할 요약(물리/링크/네트워크/전송/응용)

### 물리 계층(Physical)

- **전송 매체**: 광(싱글/멀티모드), 구리(UTP), 무선(Wi-Fi/셀룰러).
- **단위/지표**: 신호 세기(dBm), 에러율, 광 파워, 링크 업/다운.
- **장애 패턴**: 간헐적 링크 다운, 케이블/광모듈 문제, 전파 간섭(RSSI↓/SNR↓).
- **실무 팁**: 케이블·모듈 규격(속도/거리) 검증, 전원/랙/포트 라벨링, 기본 레이어를 의심하는 습관.

### 링크 계층(Data Link)

- **역할**: **같은 L2 도메인**에서 프레임 전달(MAC 기반).
- **핵심**: ARP/NDP, VLAN, STP/RSTP, LAG(링크 집성), MTU/FCS.
- **장애 패턴**: 브로드캐스트 폭증, 루프(스톰), VLAN 미스매치, MTU 불일치.
- **관찰**: 스위치 **MAC/ARP 테이블**, 포트별 **CRC/FCS 에러**, **BPDU** 로그.

### 네트워크 계층(Network)

- **역할**: **서브넷 간** 라우팅, 경로 선택. NAT, ICMP, 멀티캐스트.
- **핵심 필드**: TTL/Hop Limit, DSCP/ECN, 프래그멘트 ID/오프셋.
- **장애 패턴**: 특정 목적지 경로만 느림/단절, PMTUD 블랙홀, 비대칭 경로로 추적 난항.
- **관찰**: 라우팅 테이블, BGP 상태, ICMP 메시지, 경로 변화(시간대별).

### 전송 계층(Transport)

- **TCP**: 신뢰성(재전송), 흐름 제어(윈도우), 혼잡 제어(cwnd), **3-way**/종료, 상태 다이어그램.
- **UDP**: 비연결, 경량, 실시간/스트리밍/도메인쿼리에 적합.
- **장애 패턴**: **SYN 대기**, 재전송↑, **TIME_WAIT** 폭증, 포트 충돌/필터.
- **관찰**: 포트 상태, 재전송률, RTT·RTO, 윈도우/스케일, SACK, CUBIC/BBR 동작.

> **BDP**(Bandwidth-Delay Product)
> \[
>   \text{BDP} = \text{대역폭} \times \text{RTT}
> \]
> 윈도우가 BDP보다 **훨씬 작으면** 고속 링크도 처리량이 **윈도우/RTT**로 제한.

### 응용 계층(Application)

- **HTTP(S), DNS, SMTP, gRPC, MQTT** 등 서비스 프로토콜.
- **핵심**: 캐시/압축/멀티플렉싱, 인증/인가, 스키마/페이로드, **TLS**(암호화·인증·ALPN).
- **장애 패턴**: 4xx/5xx, 특정 엔드포인트만 느림, 헤더/쿠키/캐시 정책 충돌.
- **관찰**: 상태코드/응답시간 분포, 오류율, 캐시 히트율, 업스트림/다운스트림 분리 관측.

---

## 엔드투엔드 흐름 다이어그램(개념)

```
[브라우저]
   │ 1. DNS 조회 (스텁 → 재귀)
   ▼
[재귀 DNS] ─(루트→TLD→권한)→ [A/AAAA 응답 캐시]
   │
   ▼
[클라이언트 스택]
   │ 2. 연결 (QUIC 또는 TCP 3-way + TLS)
   │ 3. ARP/NDP로 게이트웨이 MAC 학습
   ▼
[L2 스위치] ─(VLAN/브리지)→
   ▼
[NAT/게이트웨이] ─(사설→공인, 포트 매핑)→
   ▼
[ISP 라우터(들)]
   │ 4. BGP 경로/ECMP/IXP/트랜짓
   │ 5. MTU/PMTUD, 큐/혼잡(QoS/ECN)
   ▼
[CDN/LB/리버스 프록시] ─(캐시 히트 시 여기서 응답)→
   ▼
[오리진 서버]
   │ 6. 응답(멀티플렉싱/압축/캐시/세션 재개)
   ▼
[클라이언트]
```

---

## ‘층별’ 디버깅 체크리스트(현장 카드)

- **L2**: 같은 VLAN에서만 문제? 브로드캐스트 폭증? 포트 에러/CRC? MTU/FCS?
- **L3**: 외부에서만 문제? 특정 프리픽스/ASN만? ICMP Too Big 수신? 경로가 아침/저녁 바뀌는가?
- **L4**: SYN만 가고 응답 없음? 재전송률↑? TIME_WAIT 과다? 포트 기반 정책/필터?
- **L7**: 특정 API/메소드만? 캐시 정책/쿠키/압축/콘텐츠 길이? H2/H3 네고 실패?

---

## 미니 실습 과제(명령 나열 대신 “의도” 중심)

### 같은 도메인, 다른 시간대 – 경로 스냅샷 만들기

```text
의도: 혼잡/경로 변동에 따른 체감 변화 이해
방법: 아침/점심/저녁 한 번씩 경로·RTT·손실 관찰(3일)
기록: RTT 평균/최대/표준편차, 홉 수, 중간 ASN/지리 표시(대략)
결과: 피크 시간대의 RTT 상승, 홉 변화, 캐시/에지 PoP 이동 유무
```

### PMTUD 블랙홀 의심 상황 재현(개념)

```text
의도: “작은 건 되는데 큰 건 안 됨”의 핵심 감각 익히기
방법: 큰 응답만 실패하는 경로를 가정, MTU/MSS 조정 전후 비교
기록: 성공/실패 케이스 패킷 길이, ICMP Too Big 수신 여부, MSS 클램핑 적용 여부
결과: ICMP 필터링 시 PMTUD 실패 → MSS 조정으로 회복되는 패턴 이해
```

### NAT 포트 고갈·타임아웃 체감(개념)

```text
의도: 대량 아웃바운드 시 NAT의 포트·타임아웃이 병목이 될 수 있음을 이해
방법: 짧은 수명의 다중 연결을 가정한 시뮬레이션/테스트(개념)
기록: 동시 연결 수, 매핑 테이블 여유, 실패율/지연 상승 시점
결과: 포트 범위/타임아웃 조정, 연결 풀/재사용 전략 필요성 체감
```

---

## 한 장 요약(포스터 버전)

- **모형**: OSI 7 ↔ TCP/IP 4 레이어는 **도구 상자**. 장비는 레이어를 가로지른다.
- **구성요소**: 호스트↔스위치↔라우터, AS/ASN, BGP, IANA/RIR, CDN/IXP/트랜짓.
- **여정**: DNS → (QUIC|TCP+TLS) → L2 포워딩/ARP → NAT → BGP 경로 → (CDN 캐시|오리진).
- **핵심 리스크**: MTU/PMTUD 블랙홀, 비대칭 경로, 버퍼블로트, NAT 포트/타임아웃, H2/H3 네고.
- **디버깅**: **계층별** 가설을 세우고, **패킷/지표/로그** **두 가지 이상**으로 교차검증.

---

## (부록) 용어 미니 사전

- **ASN**: 자율 시스템 번호. BGP에서 경로에 찍히는 **정치적 경계**.
- **IXP**: 인터넷 교환 지점. 각 AS가 **상호 피어링**하는 장소/패브릭.
- **Anycast**: 동일 IP를 여러 지역에서 광고해 **가까운 곳**으로 라우팅.
- **ECMP**: 동일 비용 경로를 **해시 분산**. 흐름 단위로 경로 고정.
- **BDP**: \(\text{대역폭} \times \text{RTT}\). 윈도우가 작으면 고속 링크도 못 채움.
- **PMTUD**: 경로 MTU 발견. ICMP Too Big에 의존.
- **Hairpin NAT**: 내부→공인→다시 내부로 **헤어핀**.

---

## (부록) 숫자 감각 훈련 3문제

1) **100 Mbps, RTT 50 ms**에서 파이프를 채우는 데 필요한 데이터량(BDP)은?
\[
12.5\,\text{MB/s} \times 0.05\,\text{s} \approx 0.625\,\text{MB} \ (\approx 640\,\text{KB})
\]

2) **윈도우 64 KB, RTT 100 ms**면 처리량 상한은?
\[
\approx \frac{64\,\text{KB}}{0.1\,\text{s}} \approx 0.64\,\text{MB/s} \approx 5.12\,\text{Mbps}
\]

3) **MTU 1500, TCP MSS 1460**에서 **옵션 40바이트**면 유효 페이로드는?
\[
1460 - 40 = 1420\,\text{바이트}
\]
(옵션이 늘수록 페이로드 감소 → 작은 요청은 문제없고 큰 응답만 문제되는 패턴을 촉발할 수 있음)
