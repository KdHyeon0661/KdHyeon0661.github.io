---
layout: post
title: 시스템보안 - 실습 환경 구축
date: 2025-10-17 23:30:23 +0900
category: 시스템보안
---
# 0.2 실습 환경 구축 — “하이브리드 + 격리 + 롤백”을 기본값으로

> 목표: **문제 생겨도 10분 내 완전 복구** + **외부 피해 0** + **재현 가능한 로그/스냅샷**  
> 원칙: **내 장비(Host)**는 안전, **피험 환경(Target)**은 완전 격리, **증거(Artifacts)**는 해시로 봉인

---

## 0.2.1 하이브리드 토폴로지 설계

### A) 물리 호스트(노트북/데스크톱)
- **역할**: 도구 운용, 캡처/로그 저장, 하이퍼바이저 구동
- **필수 세팅**
  - 펌웨어: VT-x/AMD-V **Enable**
  - 디스크: OS 파티션과 **랩 데이터 파티션** 분리 (암호화 권장: BitLocker/LUKS)
  - 네트워크: **Egress 제한**(방화벽), VM 전용 Host-only 어댑터 생성
  - 백업: 실험 전 **시스템 복원/이미지** 1회

### B) VM 팜(Windows/Linux 다중)
- **역할**: 타겟/공격자/라우터/로거 등 역할별 분리
- **권장 최소 구성**
  - `Kali`(공격자), `Ubuntu LTS`(서비스/타겟), `Windows 11 Dev`(타겟/디버깅)
  - 스냅샷 계층: `Base → Patch0 → Patch1` (각 단계에서 이름/설명 필수)

### C) 네트워크 레이아웃
- **Host-only**: VM↔VM, VM↔Host만 통신. 인터넷 **불가**.  
  예: `vboxnet0: 192.168.56.1/24` (Host), VM들은 `192.168.56.0/24`
- **NAT**: VM이 외부로 나가되 외부→VM은 기본 차단.  
  예: 패키지 업데이트/도구 다운로드 용도
- **인터넷 완전 차단 랩**: Host-only + 오프라인 리포/Mirror(apt-cacher-ng)

> 원칙: **Host-only 기본**, NAT는 **업데이트 시에만** 임시 ON, 끝나면 OFF.

---

## 0.2.2 하이퍼바이저별 핵심 설정

### VirtualBox (크로스플랫폼)
- **Host-only 어댑터 생성**
  1) `File → Host Network Manager → Create` → `vboxnet0` 확인
  2) DHCP 필요하면 `Enable` (고정 IP 선호 시 `Disable`)
- **VM 네트워크**
  - 어댑터1: `Host-only(vboxnet0)`  
  - 어댑터2(선택): `NAT` (패치/apt용)
- **스냅샷**
  - `Machine → Take Snapshot` 이름 규칙: `B0-CleanInstall`, `B1-Tools`, `EYYYMMDD-TestXYZ`

### VMware Workstation/Player
- **VMnet 설정**
  - `VMnet1` Host-only, `VMnet8` NAT
- **스냅샷/클론**
  - 실험 전 **Linked Clone** 권장 (빠른 재실행)

### KVM/QEMU (Linux 호스트)
- **브리지/Host-only**
  - libvirt 기본 `virbr0`(NAT). Host-only 용으로 **별도 네트워크** 생성 권장.
- **스냅샷(qcow2)**
  ```bash
  # qcow2 + 백업 이미지 체인
  qemu-img create -f qcow2 -b base.qcow2 -F qcow2 lablayer.qcow2 30G
  # 스냅샷
  qemu-img snapshot -c pretest lablayer.qcow2
  # 되돌리기
  qemu-img snapshot -a pretest lablayer.qcow2
  ```

### QEMU 실행 예시(학습용, 사용자 네트워크 + 포트포워딩)
```bash
qemu-system-x86_64 \
 -m 4096 -smp 4 -enable-kvm \
 -drive file=lablayer.qcow2,if=virtio \
 -netdev user,id=net0,hostfwd=tcp::10022-:22 \
 -device virtio-net-pci,netdev=net0 \
 -monitor stdio
# 주의: user 네트워크는 외부로 나감. 실습 후 hostfwd 삭제/차단!
```

---

## 0.2.3 NAT / Host-only 안전 운영 패턴

### 안전한 “업데이트만 NAT” 스크립트(예: VBoxManage)
```bash
# VM "Ubuntu-Target"의 어댑터2(NAT) ON → apt → OFF
VM="Ubuntu-Target"
VBoxManage modifyvm "$VM" --nic2 nat
VBoxManage startvm "$VM" --type headless
# VM 안에서 apt update/upgrade 수행 (Ansible/SSH)
# ... 끝나면
VBoxManage controlvm "$VM" acpipowerbutton
sleep 20
VBoxManage modifyvm "$VM" --nic2 none
```

### Host-only + 내부 라우터(VM)로 팩스/필터링
- 라우터 VM(Ubuntu) 1대 생성: NIC1=Host-only, NIC2=NAT
- iptables/nftables로 **도메인 허용 화이트리스트만 통과**
- 끝나면 라우터 VM **중지** (기본은 인터넷 단절)

---

## 0.2.4 스냅샷 운용 체크리스트
- [ ] 스냅샷 이름/설명에 **용도/도구 버전/날짜** 포함  
- [ ] 실험 전/후 **자동 해시 로그**(스크립트로 상태 캡처)  
- [ ] 스냅샷 간 **공유 폴더/클립보드 OFF** (필요 시 일시적으로만 ON)  
- [ ] 주기적 **정리/압축** (오래된 스냅샷 보관 정책 수립)

---

## 0.2.5 샌드박스/에뮬레이터: QEMU, Bochs, Frida, Docker

### QEMU vs Bochs
- **QEMU**: 빠름(+KVM), 광범위 아키텍처, 실전 디버깅/가상화에 적합  
- **Bochs**: **순수 에뮬**(느리지만 **디버깅 친화**) — OS 부팅 코드/커널 초기화 학습에 최고

#### Bochs로 부트로더 연구(예시 `bochsrc`)
```
megs: 64
romimage: file=/usr/share/bochs/BIOS-bochs-latest, address=0xfff00000
vgaromimage: file=/usr/share/bochs/VGABIOS-lgpl-latest
boot: disk
ata0-master: type=disk, path="osdev.img", mode=flat, cylinders=40, heads=16, spt=63
log: bochs.log
display_library: sdl
```

### Frida Gadget (모바일/네이티브 훅킹)
- **개념**: 앱/프로세스에 **가젯 주입** → JS로 API 인터셉트/메모리 읽기
- **Android/iOS**: 테스트 기기/에뮬레이터에서 **자신의 앱/허가된 대상만**
- **Hello Hook 예시 (JS)**
```js
// frida -U -f com.example.app -l script.js --no-pause
Java.perform(function () {
  var Target = Java.use("com.example.sec.Checker");
  Target.isRooted.implementation = function () {
    console.log("[*] isRooted() hooked");
    return false; // 루팅 탐지 우회 (교육용)
  };
});
```
> 실제 서비스 우회는 정책 위반/불법 가능. **자체 앱/CTF 문제**로만 사용.

### Docker 기반 “도구 상자” 이미지화
- 취약 웹앱 + 도구(OWASP ZAP, mitmproxy, tcpdump) 묶어 **재현 가능한 랩**
- `docker-compose.yml` 예시
```yaml
services:
  proxy:
    image: mitmproxy/mitmproxy
    command: mitmweb --web-host 0.0.0.0
    ports: ["8080:8080", "8081:8081"]
    networks: [lab]
  juice:
    image: bkimminich/juice-shop
    ports: ["3000:3000"]
    networks: [lab]
  logger:
    image: corfr/tcpdump
    command: ["-i", "any", "-w", "/pcaps/lab.pcap"]
    network_mode: "host"
    volumes: ["./pcaps:/pcaps"]
networks: { lab: {} }
```
> Host-only 네트워크에만 붙이거나, compose 파일에서 **외부 포트 바인딩 제거**로 격리.

---

## 0.2.6 롤백 자동화(Ansible/PowerShell)

### Linux (Ansible)
```yaml
# playbooks/reset.yml
- hosts: lab_targets
  become: true
  tasks:
    - name: Restore snapshot via VBoxManage (delegate to host)
      delegate_to: localhost
      shell: |
        VBoxManage controlvm "{{ inventory_hostname }}" poweroff
        VBoxManage snapshot "{{ inventory_hostname }}" restore "B1-Tools"
        VBoxManage startvm "{{ inventory_hostname }}" --type headless
```

### Windows (Checkpoint + WinRM)
```powershell
# 스냅샷 이름: "B1-Tools"
param([string]$VmName="Win11-Target")
& "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe" controlvm $VmName poweroff
& "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe" snapshot $VmName restore "B1-Tools"
& "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe" startvm $VmName --type headless
```

---

## 0.2.7 아티팩트 보존(증거 봉인)

### 실험 로그/pcap/스크린샷 해시 봉인
```bash
mkdir -p artifacts/$(date +%Y%m%d)
sha256sum pcaps/*.pcap screenshots/*.png logs/*.log > artifacts/$(date +%Y%m%d)/hashes.sha256
gpg --clearsign artifacts/$(date +%Y%m%d)/hashes.sha256
```
- **정책**: PII/비밀정보 금지, 불가피 시 **마스킹** 후 보존기간 설정 및 파기 계획 포함

---

# 0.3 기본 도구 꾸러미 — “편집·디버깅·리버스·트레이스·네트·포렌식·자동화”

> 각 도구는 **역할**과 **가장 작은 유용 예제**를 1개씩. 실습은 **Host-only/샌드박스**에서만.

---

## 0.3.1 에디터/IDE
- **VS Code**: 멀티랭/원격개발/확장 풍부, 리모트(SSH/Containers) 최고
- **Visual Studio**: Windows 네이티브(C/C++), WinDbg 통합 디버깅
- **CLion / Qt Creator**: CMake/LLDB 연동 편리

### 예제: VS Code Devcontainer로 **분석용 컨테이너** 열기
```json
// .devcontainer/devcontainer.json
{
  "image": "mcr.microsoft.com/devcontainers/cpp:ubuntu",
  "features": { "ghcr.io/devcontainers/features/python:1": {} },
  "customizations": {
    "vscode": { "extensions": ["ms-vscode.cpptools", "ms-python.python"] }
  }
}
```
→ “**재현 가능한 툴셋**” 확보. 호스트 깨끗이 유지.

---

## 0.3.2 디버거: gdb / WinDbg / x64dbg

### gdb (Linux/ELF)
- **핵심 옵션**: `set disassemble-next-line on`, `set follow-fork-mode child`
- **스택 버그 기초 재현(교육용)**
```c
// vuln.c (교육용, 절대 프로덕션 금지)
#include <stdio.h>
#include <string.h>
void greet(char *name){ char buf[16]; strcpy(buf, name); printf("Hi %s\n", buf); }
int main(int argc, char**argv){ greet(argc>1?argv[1]:"A"); }
```
```bash
gcc -fno-stack-protector -z execstack -no-pie -g vuln.c -o vuln
gdb -q ./vuln
(gdb) run $(python3 -c 'print("A"*40)')
(gdb) info frame
(gdb) disassemble greet
```
- **학습 포인트**: 프레임 레이아웃, 리턴주소 덮침 관찰(보호 해제 환경에서만)

### WinDbg (Windows/PE)
- **심볼 서버 설정**
```
.symfix srv*c:\symbols*https://msdl.microsoft.com/download/symbols
.reload /f
```
- **프로세스/모듈 조회**
```
!process 0 1
lm
k
```
- **예제**: 크래시 덤프 로드 후 스택 추적
```
windbg.exe -z C:\dumps\app.dmp
!analyze -v
kv
```

### x64dbg (Windows GUI)
- **사용 포인트**: 브레이크포인트, 메모리 뷰, 패치 시뮬
- **간단 API 브레이크**: `Kernel32!CreateFileW` 브레이크 후 파라미터 확인

> WinDbg는 **시스템 심층**, x64dbg는 **사용성**. 병행 스킬 추천.

---

## 0.3.3 리버스: IDA / Ghidra / radare2

### Ghidra(무료, 강력)
- **빠른 시작**: Import → 분석(Analyze) → Functions, Decompile 창
- **예제**: 난독화 없는 바이너리에서 `main` 플로우 태깅 → 의사코드 내 주석으로 흐름 문서화

### radare2 / rizin (CLI)
```bash
r2 -AA ./vuln
afl          # 함수 목록
pdf @ main   # main 디스어셈블리
ood AAAAA... # 인자 넣고 재시작
ds           # step
px 64 @ rsp  # 스택 덤프
```
- **장점**: 스크립팅/자동화 강력, CI 파이프라인 결합 용이

---

## 0.3.4 트레이스: strace / ltrace

### strace (시스템콜 트레이스)
```bash
strace -f -o trace.log ./server --port 8080
# 포인트: 파일/네트워크 접근, 권한 에러, 경로 누락 등 빠르게 파악
```

### ltrace (라이브러리 호출)
```bash
ltrace -o ltrace.log ./client
# 포인트: 암호/토큰 처리 함수 호출 흐름 관찰(테스트 빌드만)
```

---

## 0.3.5 네트워크: tcpdump / Wireshark

### tcpdump 최소 필터 레시피
```bash
# Host-only 네트에 한정된 캡처
tcpdump -i vboxnet0 -w lab.pcap 'tcp port 3000 and host 192.168.56.10'
# HTTP 헤더만 퀵뷰
tcpdump -A -s 0 -i vboxnet0 'tcp port 3000' | sed -n '1,50p'
```

### Wireshark 디스플레이 필터
- `http.request.method == "POST" && tcp.stream == 5`
- `tls.handshake.type == 1` (ClientHello 관찰)
- `frame.time >= "2025-10-31 12:00:00"` (시간 범위)

> **주의**: PII/세션키 포함 가능. 캡처 대상은 **내 랩/테스트 계정만**.

---

## 0.3.6 포렌식: Volatility / Velociraptor

### 메모리 이미지 취득(Windows, winpmem)
```powershell
.\winpmem_mini_x64.exe --format raw -o C:\mem\mem.raw
```

### Volatility3 기본 분석
```bash
vol -f mem.raw windows.pslist
vol -f mem.raw windows.netscan
vol -f mem.raw windows.cmdline
vol -f mem.raw windows.malfind --dump
```
- **활용**: 악성 인젝션 탐지, 프로세스/네트워크 타임라인 복원

### Velociraptor (엔드포인트 헌팅/수집)
- **VQL 예시**: 특정 프로세스 네트워크 연결 사냥
```sql
SELECT Pid, Name, LocalAddress, RemoteAddress, RemotePort, Timestamp
FROM pslist() AS p
JOIN netstat() AS n ON p.Pid = n.Pid
WHERE Name =~ "proc_under_test.exe"
```
> 실습은 **오프라인 랩**. 운영 환경 대상 수집은 **조직 승인 후**.

---

## 0.3.7 자동화(Python) — “안전 가드 내장” 스캐폴드

### A) Rate-Limit + 화이트리스트 + PII 킬스위치
```python
import re, time, hashlib, requests
from urllib.parse import urlparse

ALLOWED = {"192.168.56.20", "juice.lan"}   # Host-only 대상만
QPS = 0.5
PII = re.compile(r'\b(\d{6}-\d{7}|\d{3}-\d{2}-\d{4})\b')

def safe_req(url, **kw):
  host = urlparse(url).hostname
  assert host in ALLOWED, f"Not allowed host: {host}"
  time.sleep(1/QPS*2)  # 보수적
  r = requests.request(timeout=8, **kw, url=url)
  preview = r.text[:800]
  if PII.search(preview):
    raise RuntimeError("PII-like content detected; aborting.")
  print(int(time.time()), r.status_code, hashlib.sha256(preview.encode()).hexdigest())
  return r

# 예시
# safe_req("http://juice.lan:3000/rest/products/search?q=test", method="GET")
```

### B) scapy로 pcap 요약(HTTP 메서드 카운트)
```python
from scapy.all import rdpcap, TCP
from collections import Counter

def http_methods(pcap):
  pkts = rdpcap(pcap)
  c = Counter()
  for p in pkts:
    if p.haslayer(TCP) and p[TCP].dport in (80,3000):
      payload = bytes(p[TCP].payload)
      if payload.startswith(b"GET "): c["GET"]+=1
      elif payload.startswith(b"POST "): c["POST"]+=1
  return c

# print(http_methods("lab.pcap"))
```

### C) gdb 자동화(pexpect)로 크래시 재현/레지스터 덤프
```python
import pexpect, re

g = pexpect.spawn("gdb -q ./vuln")
g.expect_exact("(gdb)")
g.sendline("run $(python3 -c 'print(\"A\"*64)')")
g.expect(re.compile(r"Program received signal"))
g.sendline("info registers")
g.expect_exact("(gdb)")
print(g.before.decode())
g.sendline("quit")
```

---

## 0.3.8 “실전형” 미니 랩 시나리오 (끝까지 안전하게)

### 시나리오 1 — 취약 웹앱 관찰(Host-only)
1) `juice-shop` 컨테이너를 Host-only 네트워크에 올림 (`juice.lan:3000`)  
2) mitmproxy를 같은 네트워크에 올리고 브라우저 프록시 설정  
3) tcpdump로 Host-only 인터페이스만 캡처(`lab.pcap`)  
4) Python 스크립트로 **저속** API 호출 → pcap 요약  
5) Ghidra로 티저 바이너리 분석(문제 제공 파일) — **외부 시스템 미접근**

### 시나리오 2 — 리눅스 타겟 디버깅
1) Ubuntu 타겟 VM에 교육용 `vuln` 배포, ASLR/보호 끈 빌드  
2) gdb로 크래시 포인트 확인(스택/레지스터)  
3) strace로 I/O 경로/오류 확인 → 최소 재현 단계 작성  
4) 보고서 초안: 영향/완화(권한 체크/에러 처리/기본 빌드 보호) 제안

> 모든 단계: **스냅샷 전환으로 10분 내 초기화**, 아티팩트 해시 봉인

---

## 0.3.9 팀/블로그 운영 팁 (재현성과 안전성)

- **문서 템플릿**: 각 글 말미에 “환경/스냅샷명/도구버전/해시” 표 삽입
- **플레이북**: “업데이트 필요 시 NAT ON → 패치 → OFF” Macro 공개
- **스크립트 저장소**: 안전 가드 내장(화이트리스트/PII/Rate-limit) 기본
- **데이터 정책**: 실제 데이터 금지, 합성 데이터 세트 공개

---

# 부록 — 빠른 스타트 패키지(한 번에 깔고 달리기)

### 설치/세팅 앤솔로지(예: Ubuntu 호스트)
```bash
sudo apt update && sudo apt install -y qemu-kvm virt-manager wireshark \
  python3-pip gdb gdbserver strace ltrace tcpdump
sudo usermod -aG kvm,libvirt,wireshark $USER

pip install requests scapy pexpect
```

### Windows 호스트(요지)
- Hyper-V **끄고**(필요 시) VirtualBox/VMware 중 택1
- WinDbg/VS 설치, 심볼 서버 설정
- WSL2 + VS Code Remote로 리눅스 도구 병행

---

## 최종 체크리스트(초보자용 12문)
1) Host-only 네트워크가 **기본**인가?  
2) NAT는 **업데이트 때만** 켰다가 꺼두나?  
3) 스냅샷/클론으로 10분 내 **복구** 가능한가?  
4) 실험 전/후 해시 로그를 남기나?  
5) 공유클립보드/폴더는 **OFF** 인가?  
6) 캡처/로그에 PII가 없나(있다면 마스킹/파기 계획)?  
7) 자동화 스크립트에 화이트리스트/QPS/PII 가드가 있나?  
8) pcap은 Host-only 인터페이스만 캡처하나?  
9) 도구 버전/옵션을 글에 기록했나(재현성)?  
10) 실험 대상은 내가 만든/허가된 시스템인가?  
11) 공개 글에는 PoC를 **최소화**했나?  
12) 끝나고 **NAT OFF**/라우터 VM 중지했나?