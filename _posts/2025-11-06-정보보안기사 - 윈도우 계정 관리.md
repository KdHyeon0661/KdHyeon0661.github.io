---
layout: post
title: 정보보안기사 - 윈도우 계정 관리
date: 2025-11-06 17:25:23 +0900
category: 정보보안기사
---
# SECTION 03 윈도우 서버 취약점 — 01. 계정 관리

## 0. 위협 모델과 핵심 원칙

### 대표 위협
- **약한 암호/공유 계정**: 무차별 대입·크리덴셜 스터핑·블루팀 추적 곤란.
- **로컬 관리자 재사용**: Pass-the-Hash(해시 재사용)로 횡이동.
- **서비스 계정 오남용**: SPN이 있는 약한 비번 → Kerberoasting/AS-REP Roasting.
- **권한 오남용/그룹 관리 실패**: 광범위한 관리자 권한, 그룹 드리프트.
- **인증 스택 취약**: NTLM/LM/RC4 유지, WDigest 활성, LSASS 보호 부재.
- **가시성 부족**: 47xx/46xx 이벤트 미수집, Sysmon/Defender ASR 미활성.
- **수명주기 미관리**: 휴면/퇴사 계정, 암호/키 미회전.

### 핵심 원칙
- **역할 기반 권한(AGDLP/AGUDLP)** + **Tier 분리(0/1/2)** + **PAW(특권 워크스테이션)**.
- **강력 암호 정책 + MFA**(특히 원격/특권·도메인 조작).
- **로컬 관리자 암호 무작위화(LAPS)**, **서비스 계정은 gMSA**.
- **NTLM 축소/차단, Kerberos만 사용**(가능 최대).
- **보호 기능 상시**: LSASS 보호, Credential Guard, Protected Users.
- **이벤트/감사 상시 수집**: 4720/4728/4740/4768/4769/4672 중심.
- **자동화**: 스크립트/정책/보고서로 수명주기 운영.

---

## 1. 로컬 계정·그룹 보안 (단독 서버/멤버 서버 공통)

### 1.1 위험 신호
- 활성 **Administrator** 기본 이름, **Guest** 활성.
- 로컬 **Administrators** 그룹에 불필요 계정/도메인 사용자 다수.
- 동일 암호의 로컬 관리자 계정이 여러 서버에 재사용.
- **빈 암호/암호 미만료**, 암호 길이/복잡성 미적용.
- 로컬 비번이 GPP(cpassword) 등 **평문/약한 암호화로 배포**.

### 1.2 빠른 점검 (PowerShell)
```powershell
# 로컬 계정/그룹 요약
Get-LocalUser | Select-Object Name,Enabled,PasswordNeverExpires,LastLogon
Get-LocalGroupMember -Group "Administrators" | Select-Object Name, PrincipalSource

# 빈 암호 허용 여부 / 암호 정책 요약
secedit /export /cfg C:\Temp\secpol.cfg | Out-Null
Get-Content C:\Temp\secpol.cfg | Select-String -Pattern "MinimumPasswordLength|PasswordComplexity|LimitBlankPasswordUse"

# Guest/Administrator 상태
Get-LocalUser -Name "Administrator","Guest" | Select Name,Enabled
```

### 1.3 권장 조치
- **Administrator**: 이름 변경 + 비활성(도메인 환경에서 로컬 관리자 필요 최소화).
- **Guest**: 항상 비활성.
- **로컬 Admin 암호 무작위화**: **LAPS(Windows LAPS/Legacy LAPS)** 사용.
- **로컬 그룹 멤버십 중앙 통제**: GPO의 **Restricted Groups** 또는 **Group Policy Preferences(로컬 사용자/그룹)** *[비밀번호 저장 금지]*.

#### 로컬 정책(대안 CLI)
```powershell
# 암호 정책(독립 서버에만; 도메인 환경은 Default Domain Policy)
# 길이 12, 복잡성 on, 만료 90일
secedit /export /cfg C:\Temp\secpol.cfg | Out-Null
# 편집 후 secedit /configure /db secedit.sdb /cfg C:\Temp\secpol.cfg /areas SECURITYPOLICY
```

---

## 2. 도메인(AD) 권한 모델 — AGDLP/AGUDLP, OU·그룹 설계

### 2.1 AGDLP / AGUDLP
- **AGDLP**: **A**ccounts → **G**lobal Groups → **D**omain **L**ocal Groups → **P**ermissions
- **AGUDLP**(포리스트/다도메인): Accounts → **U**niversal → Domain Local → Permissions
→ 권한을 **리소스 근처의 Domain Local**에만 연결, 멤버십은 Global/Universal로 관리.

### 2.2 OU 설계
- **Tier 0(AD/DC/PKI)**, **Tier 1(서버)**, **Tier 2(클라이언트)** **분리 OU**.
- GPO 상속/차단을 설계(보안 기준/GPO 링크를 OU별로 분리).

---

## 3. 암호/잠금/로그온 정책 (도메인)

> **기본 원칙**: 도메인 전체 암호/잠금 정책은 **Default Domain Policy**에, 예외는 **FGPP(세분화 암호 정책)** 로 그룹/사용자 단위 적용.

### 3.1 Default Domain Policy(요약)
- **최소 길이 ≥ 12**(권고 14~16), **복잡성** ON, **최대 사용 기간 90일**, **과거 암호 기억 ≥ 24**.
- 잠금 임계값 5회, 관찰 창 30분, 잠금 지속 30분(조직 위험도에 맞게).

CLI(참고):
```cmd
net accounts /minpwlen:12 /maxpwage:90 /uniquepw:24 /lockoutthreshold:5 /lockoutwindow:30 /lockoutduration:30
```

### 3.2 Fine-Grained Password Policy(FGPP) (예제)
```powershell
# AD 모듈 필요
Import-Module ActiveDirectory

# 1. 정책 생성
New-ADFineGrainedPasswordPolicy -Name "FGPP-Admins" `
 -Precedence 1 -ComplexityEnabled $true -LockoutDuration 00:30:00 `
 -LockoutObservationWindow 00:30:00 -LockoutThreshold 3 `
 -MinPasswordLength 16 -PasswordHistoryCount 24 -MaxPasswordAge 30.00:00:00

# 2. 적용 대상(그룹/사용자)
Add-ADFineGrainedPasswordPolicySubject -Identity "FGPP-Admins" -Subjects "GG-PrivAdmins"
```

---

## 4. 인증 스택 강화 — Kerberos 우선, NTLM 축소/차단

### 4.1 Kerberos
- 클라이언트/서버가 **시간 동기화** 되어야 함(NTP).
- 서비스 계정 **AES 암호형식** 활성, RC4/3DES/MD5 비활성화 권장.
- **Protected Users** 그룹: NTLM/RC4/WDigest 사용 금지, 위임 불가, TGT 짧게.

```powershell
# Protected Users 그룹에 계정 추가(특권 사용자)
Add-ADGroupMember -Identity "Protected Users" -Members alice.admin
```

### 4.2 NTLM 축소/차단
- 도메인/로컬 정책: **LAN Manager 인증 수준** → “NTLMv2만”
- “Restrict NTLM: Audit/Block Incoming/Outgoing NTLM” 정책 단계적 시행.
- 애플리케이션/장비 호환성 테스트 필수(감사 모드 → 차단 모드).

---

## 5. 특권 계정 운영 — Tier·PAW·JEA

### 5.1 계층화(Tier) & PAW
- **Tier 0**: 엔터프라이즈 관리자/도메인 관리자/스키마 관리자/AD FS/PKI.
- **PAW(Privileged Access Workstation)**: 특권 작업 전용 워크스테이션, 인터넷/이메일 분리.

### 5.2 Just Enough Administration(JEA)
- PowerShell Remoting에 **역할 기반** 허용만 노출.

예시(요약):
```powershell
# 1. 역할 역량(PSRC) 작성
New-Item -Path 'C:\JEA\RoleCapabilities' -ItemType Directory -Force | Out-Null
@"
VisibleCmdlets = @{
    Name = 'Restart-Service'; Parameters = @{ Name = 'Name' }
}, 'Get-Service'
VisibleFunctions = 'Get-EventLog'
"@ | Out-File C:\JEA\RoleCapabilities\Helpdesk.psrc -Encoding utf8

# 2. 세션 구성( PSSC )
@"
SessionType = 'RestrictedRemoteServer'
RunAsVirtualAccount = $true
RoleDefinitions = @{ 'CONTOSO\GG-Helpdesk' = @{ RoleCapabilities = 'Helpdesk' } }
"@ | Out-File C:\JEA\JEA-Helpdesk.pssc -Encoding utf8

# 3. 등록
Register-PSSessionConfiguration -Name 'JEA-Helpdesk' -Path 'C:\JEA\JEA-Helpdesk.pssc' -Force
```
→ 헬프데스크는 **서비스 재시작** 외 권한 없음.

---

## 6. 로컬 관리자 암호 무작위화 — LAPS

### 6.1 원칙
- 서버마다 로컬 관리자 암호가 **서로 다르고** 주기적으로 **자동 회전**되어야 한다.
- **Legacy LAPS(ms-Mcs-AdmPwd)** 또는 **Windows LAPS(AD 스키마 내장, 2023+)** 사용.
- 접근 권한은 **읽기 RBAC**로 제한(특권 소수 그룹만).

### 6.2 Windows LAPS 간단 흐름(요약)
1) ADMX 템플릿 배포, GPO에서 LAPS 구성(비밀번호 길이/복잡성/회전 주기/백업 대상).
2) 컴퓨터 개체에 **암호·만료 속성**이 저장되고, 권한 있는 계정만 조회 가능.
3) 회전 후 RDP/로컬 로그인에 새 암호 사용.

```powershell
# (참고) 권한 부여 예: LAPS 읽기 권한 그룹에 특정 OU 내 컴퓨터 암호/만료 읽기
# Windows LAPS는 Get-LapsADPassword 사용
Get-LapsADPassword -Identity "SRV-WEB01" -AsPlainText
```
> 운영에서는 **보안 감사**와 **접근 제어**(LAPS 비밀번호 조회 로그/권한 최소화)가 핵심.

---

## 7. 서비스 계정 보안 — gMSA, 위임 제한, SPN 관리

### 7.1 gMSA(Group Managed Service Account)
- **암호 자동 회전**(DC가 관리), **로컬 로그인 불가**, SPN/권한 최소화.
- IIS/서비스/스케줄러에 지정을 권장.

```powershell
# 1. KDS 루트 키(도메인 최초 1회)
Add-KdsRootKey -EffectiveImmediately

# 2. gMSA 생성
New-ADServiceAccount -Name gmsaWeb -DNSHostName gmsaWeb.contoso.com -PrincipalsAllowedToRetrieveManagedPassword "CN=SRV-WEB01,OU=Servers,DC=contoso,DC=com"

# 3. 대상 서버에 설치
Install-ADServiceAccount gmsaWeb
Test-ADServiceAccount gmsaWeb
```
> IIS 응용 풀 ID에 `CONTOSO\gmsaWeb$` 지정.

### 7.2 SPN/위임(Delegation)
- **Unconstrained Delegation** 금지.
- **Constrained Delegation**(필요 서비스만) 또는 **Resource-based Constrained** 권장.
- **SPN 중복**은 Kerberos 실패·스푸핑 유발 → 정기 점검.

```powershell
# SPN 중복 탐지
setspn -X
# 특정 계정 SPN 열람
setspn -L CONTOSO\svc-sql
```

---

## 8. 인증서/스마트카드·MFA 적용(요약)

- **원격/특권 작업**은 MFA 강제(스마트카드/Windows Hello for Business/전용 MFA 솔루션).
- RDP: **NLA** 강제 + **Remote Credential Guard**로 자격 증명 재사용 억제.

```powershell
# RDP NLA 강제
Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name UserAuthentication -Value 1
```

---

## 9. LSA/LSASS 보호, Credential Guard/WDigest/RC4

```powershell
# 9.1 LSA 보호(LSASS 보호: RunAsPPL)
New-Item -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Force | Out-Null
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name RunAsPPL -Type DWord -Value 1

# 9.2 WDigest 비활성화(평문 캐시 금지)
Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest' -Name 'UseLogonCredential' -Type DWord -Value 0

# 9.3 RC4 사용 축소(도메인/클라이언트 정책으로 AES 우선)
# (도메인 GPO: 'Network security: Configure encryption types allowed for Kerberos')
```

> **Credential Guard**: 하드웨어 가상화(VBS) 기반으로 비밀 격리(조직 하드웨어 지원 필수).
> **주의**: 정책 충돌/호환성은 사전 검증.

---

## 10. 모니터링/감사 — 필수 이벤트와 쿼리

### 10.1 핵심 이벤트 ID
- **계정 수명주기**: 4720(계정 생성), 4722(활성), 4725(비활성), 4726(삭제), 4738(속성 변경)
- **그룹 변경**: 4728/4729/4732/4733(멤버 추가/제거)
- **로그온/실패**: 4624/4625, 4768(TGT), 4769(TGS), 4771(프리인증 실패), 4776(NTLM)
- **잠금**: 4740
- **특권 사용**: 4672

### 10.2 예제 쿼리 (PowerShell)
```powershell
# 최근 24시간 새 사용자/비활성/삭제
Get-WinEvent -FilterHashtable @{LogName='Security'; ID=@(4720,4725,4726); StartTime=(Get-Date).AddDays(-1)} |
  Select-Object TimeCreated,Id,(@{n='TargetUser';e={$_.Properties[0].Value}}),(@{n='Actor';e={$_.Properties[-1].Value}})

# 계정 잠금 이벤트
Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4740; StartTime=(Get-Date).AddDays(-1)} |
  Select-Object TimeCreated,(@{n='LockedUser';e={$_.Properties[0].Value}}),(@{n='Caller';e={$_.Properties[1].Value}})
```

### 10.3 AD 기반 탐지(예: 비정상 그룹 추가)
```powershell
# 지난 1시간 도메인 관리자 그룹 변경
$since = (Get-Date).AddHours(-1)
Get-WinEvent -FilterHashtable @{LogName='Security'; ID=@(4728,4729); StartTime=$since} |
  Where-Object { $_.Properties[1].Value -like '*Domain Admins*' } |
  Select TimeCreated, Id, @{n='Member';e={$_.Properties[0].Value}}, @{n='Actor';e={$_.Properties[-1].Value}}
```

---

## 11. 휴면·퇴사 계정 처리(수명주기 자동화)

### 11.1 휴면 계정 식별(AD)
```powershell
Import-Module ActiveDirectory
$cut = (Get-Date).AddDays(-90)
Get-ADUser -Filter {Enabled -eq $true -and lastLogonTimestamp -lt $cut} -Properties lastLogonTimestamp |
  Select-Object SamAccountName,@{n='LastLogon';e={[DateTime]::FromFileTime($_.lastLogonTimestamp)}}
```

### 11.2 단계적 조치
1) **경고**(메일/티켓) → 7일 후 비활성(Disable-ADAccount) → 30일 후 삭제/보관 OU 이동.
2) VPN/메일/파일 서버 접근 제거, 키/토큰 폐기.
3) 감사 로그 스냅샷.

---

## 12. 취약 구성 탐지 — 스캐닝 스크립트 묶음

### 12.1 로컬·도메인 취약 신호
```powershell
# 1. 로컬 Administrators 그룹 덤프
Get-LocalGroupMember Administrators | Select Name, PrincipalSource

# 2. 로컬 유저 상태
Get-LocalUser | Select Name, Enabled, PasswordNeverExpires, LastLogon

# 3. AD: Password never expires / PreAuth disabled / Unconstrained Delegation
Get-ADUser -Filter {Enabled -eq $true -and PasswordNeverExpires -eq $true} | Select SamAccountName
Get-ADUser -LDAPFilter '(userAccountControl:1.2.840.113556.1.4.803:=4194304)' -Properties userAccountControl | Select SamAccountName  # DONT_REQ_PREAUTH
Get-ADUser -LDAPFilter '(userAccountControl:1.2.840.113556.1.4.803:=524288)' | Select SamAccountName  # TRUSTED_FOR_DELEGATION
```

### 12.2 SPN·서비스 계정
```powershell
# Kerberoasting 위험 후보(패스워드 미강화 서비스 계정) 점검 힌트
setspn -X   # 중복 SPN
# 약한 암호/패스워드 만료 제외/높은 권한 가진 SPN 계정 리스트업 후 gMSA로 전환 검토
```

---

## 13. 예상 실무 시나리오와 대응

### 시나리오 A — “로컬 관리자 재사용으로 횡이동”
- **징후**: 동일 해시로 다수 서버 접근(4624 Type 3, 4672 연계).
- **즉시 조치**: LAPS 강제 도입, 로컬 Admin 네트워크 로그온 금지(“Deny access from the network”).
- **근본 개선**: PAW, JEA, Tier 모델, 원격은 RCG/NLA+MFA.

### 시나리오 B — “SPN 약한 계정 Kerberoasting”
- **징후**: 4769 이벤트 급증, 특정 SPN 대상.
- **즉시 조치**: 서비스 계정 비번 회전·강화, AES만 허용.
- **근본 개선**: gMSA 전환, 위임 제한, 모니터링 룰 추가.

### 시나리오 C — “휴면 계정 악용”
- **징후**: 4624 성공 로그온이 수개월 미사용 계정에서 발생.
- **즉시 조치**: 해당 계정 비활성/암호 초기화, 활동 범위 포렌식.
- **근본 개선**: 60~90일 비활성 자동 잠금/삭제 워크플로우.

---

## 14. 체크리스트 (운영 증적 중심)

- [ ] **Administrator** 이름 변경/비활성, **Guest** 비활성.
- [ ] **LAPS**(Windows LAPS)로 로컬 Admin 암호 무작위화·회전, 조회 RBAC·감사.
- [ ] **AGDLP/AGUDLP** 모델 적용, **Tier/OU** 분리와 GPO 링크 설계.
- [ ] **Default Domain Policy**: 길이/복잡성/만료/잠금 기준 적용, **FGPP**로 예외.
- [ ] **Protected Users** 그룹 사용(특권 사용자), **NTLM 축소/차단** 로드맵.
- [ ] **LSASS 보호/WDigest Off/Credential Guard** 적용(호환성 검토 포함).
- [ ] **gMSA**로 서비스 계정 전환, **Unconstrained Delegation 금지**, SPN 중복 해소.
- [ ] **RDP NLA/Remote Credential Guard** + MFA.
- [ ] **이벤트 4720/4728/4740/4768/4769/4672** 수집·경보.
- [ ] **휴면/퇴사 계정 자동화**: Disable/삭제/OU 격리·접근 회수.

---

## 15. 암호 강도 간단 수식 메모(복습)
암호 길이 \(L\), 문자집합 크기 \(N\)일 때 가능한 조합은 \(N^L\), 엔트로피 근사:
$$
H \approx L \cdot \log_2(N)
$$
- 예: \(N\approx 90, L=14 \Rightarrow H \approx 14 \cdot 6.49 \approx 90.9 \text{ bits}\).
- 엔트로피만이 전부가 아니다: **온라인 시도 한계/잠금/MFA**가 **실제 방어**를 결정.

---

## 16. 미니 랩 (테스트 도메인 권장)

### 랩 1 — LAPS(Windows LAPS)로 로컬 관리자 회전
1) ADMX 배포, GPO에서 LAPS 구성(길이 20/복잡성·회전 7일).
2) 멤버 서버 2대에 적용, 30분 후 각기 다른 암호 확인(`Get-LapsADPassword`).
3) 보안 그룹 외에는 조회 불가 확인(접근 거부 이벤트).

### 랩 2 — gMSA 서비스 전환
1) `Add-KdsRootKey` → `New-ADServiceAccount` → 대상 서버 `Install-ADServiceAccount`.
2) IIS AppPool을 gMSA로 전환, 애플리케이션 정상 동작 확인.
3) SPN 중복 여부/위임 설정 점검.

### 랩 3 — NTLM 감사 → 단계적 차단
1) “Restrict NTLM: Audit” 정책 적용, 1~2주 로그 분석(4776/4624 NTLM).
2) 예외 목록(레거시 장비/앱) 관리 후 “Deny” 전환.

---

## 17. 예상문제(필기/실무)

1) **AGDLP** 모델을 설명하고, 파일 서버 권한 부여 예시를 설계하라.
2) **LAPS** 도입 목적과 운영 시 위험 포인트(조회 RBAC, 감사)를 서술하라.
3) **gMSA**의 장점과 전환 절차(AD/서버 단계)를 기술하라.
4) **Protected Users** 그룹의 효과(금지·제한 사항)를 3가지 이상 쓰라.
5) **Unconstrained Delegation**과 **Constrained Delegation**의 차이와 위험을 비교하라.
6) 도메인에서 **NTLM 축소/차단**을 적용하기 위한 단계적 접근을 제시하라.
7) 계정 잠금 이벤트(4740)와 원인 분석 절차(소스 DC, PDC Emulator, 로그 경로)를 설명하라.

예시 스니펫:
```powershell
# AGDLP: 도메인 로컬 권한 그룹에 글로벌 그룹을 넣어 리소스 ACL 연결
# GG-FileEditors -> DL-FileShare-Edit -> 파일서버 공유/NTFS 권한
```
```powershell
# 잠금 원인 추적(4740)
Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4740; StartTime=(Get-Date).AddDays(-1)} |
  Select TimeCreated, @{n='User';e={$_.Properties[0].Value}}, @{n='Source';e={$_.Properties[1].Value}}
```
```powershell
# LAPS 조회 권한 테스트(권한 없는 계정은 거부)
Get-LapsADPassword -Identity 'SRV-APP01' -AsPlainText
```

---

## 18. 마무리

- 윈도우 서버 **계정 관리**는 단일 정책이 아니라, **권한 모델(AGDLP/Tier)**, **보호 기능(LSA/CG/PU)**, **로컬·서비스 계정 통제(LAPS/gMSA)**, **인증 스택 정비(Kerberos/NTLM 축소)**, **감사·자동화**가 맞물려야 효과가 난다.
- 본 문서의 **점검 스크립트/정책 템플릿/체크리스트**를 **GPO/PowerShell/IaC**로 고정하고, 주기적 **감사 보고**와 **탐지 규칙**으로 **드리프트를 억제**하라.
