---
layout: post
title: 시스템보안 - 크레덴셜·비밀관리 & 영속화
date: 2025-10-26 16:30:23 +0900
category: 시스템보안
---
# 크레덴셜·비밀관리 & 영속화

## OS/브라우저/클라우드 자격증명 저장 위치 (지도 + 점검 스크립트)

### Windows (요약 지도)

| 범주 | 대표 저장소/메커니즘 | 보호 기제 | 위험 포인트(모델) | 방어·점검 핵심 |
|---|---|---|---|---|
| LSASS/로그온 세션 | 메모리 내 자격(해시/티켓/SSP 캐시) | PPL(LSA 보호), Credential Guard | 디버그/핸들/덤프 시 노출 | RunAsPPL·CredGuard·ASR(자격 유출 차단), Sysmon(10) |
| DPAPI | `HKEY_CURRENT_USER`/프로필 내 DPAPI blob | 마스터키(사용자 비밀) | 마스터키 유출·리플레이 | Windows Hello/보호 키, EFS·DPAPI 백업 금고 관리 |
| Windows Credential Manager | `vaultcmd`, `cmdkey` 저장 항목 | DPAPI | 저장형 자격 과다 | 주기 점검 및 만료·제거 |
| 브라우저 | Chrome/Edge: `Login Data`(SQLite) + DPAPI, Firefox: NSS(Key4.db) | DPAPI/NSS master | 프로파일 탈취·동기화 위험 | 프로파일 격리·조직 정책·암호 관리자 표준화 |
| RDP/원격 | `.rdp` 파일의 `password 51`(암호화), mstsc 캐시 | DPAPI | 잔존 캐시 | 로밍 금지·정책으로 암호 저장 차단 |
| 툴 체인 | PuTTY/WinSCP, Git 크리덴셜(Manager) | 앱별 | 플레인/약한 보호 | 표준 자격 금고 통일/감사 |

#### (랩) Windows 빠른 점검 스크립트(읽기 전용)

```powershell
<# win_creds_audit.ps1 — 민감 위치 존재 유무/설정 상태 요약 (권장: 관리자)
    공격·탈취 X, 경로/설정만 열람해 "정리 대상" 식별
#>

Write-Host "== Credential Manager (Generic/Domain) =="
try { cmdkey /list } catch {}

Write-Host "`n== RDP .rdp files (profile) =="
Get-ChildItem "$env:USERPROFILE" -Recurse -Include *.rdp -ErrorAction SilentlyContinue |
  Select-Object FullName, LastWriteTime

Write-Host "`n== Browser profiles (Chrome/Edge) existence =="
$chrome = "$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Login Data"
$edge   = "$env:LOCALAPPDATA\Microsoft\Edge\User Data\Default\Login Data"
$ffp    = "$env:APPDATA\Mozilla\Firefox\Profiles"
Get-Item $chrome,$edge -ErrorAction SilentlyContinue | Select FullName, Length, LastWriteTime
Get-ChildItem $ffp -Directory -ErrorAction SilentlyContinue | Select Name, FullName

Write-Host "`n== SSH keys (OpenSSH) =="
Get-ChildItem "$env:USERPROFILE\.ssh" -ErrorAction SilentlyContinue |
  Select Name, Length, LastWriteTime

Write-Host "`n== AWS/Azure/GCP CLI creds existence =="
$paths = @(
  "$env:USERPROFILE\.aws\credentials",
  "$env:USERPROFILE\.azure",               # 토큰 캐시 폴더
  "$env:USERPROFILE\AppData\Roaming\gcloud" # 토큰·구성
)
$paths | % { Get-Item $_ -ErrorAction SilentlyContinue | Select FullName, LastWriteTime }
```

**정리 원칙**
- **저장형 자격 최소화**(RDP 암호 저장 금지, 브라우저 저장 금지 정책)
- **암호 관리자 표준화**(기업용 Password Manager) 및 **2FA/MFA 필수**
- **Credential Guard + LSA 보호(PPL) + ASR(자격 유출 차단)**

---

### Linux / macOS (요약 지도)

| 범주 | Linux | macOS | 위험 포인트 | 방어 |
|---|---|---|---|---|
| 키링/키체인 | `gnome-keyring`, `libsecret`(Seahorse) | Keychain | 빈약한 잠금·평문 캐시 | 화면 잠금/오토락·보안 토큰 |
| SSH | `~/.ssh/id_*`, `known_hosts` | 동일 | 프라이빗 키 권한·에이전트 포워딩 | `chmod 600`, `ForwardAgent no` |
| 브라우저 | Chromium/Firefox 프로파일 | Safari Keychain | 프로파일 탈취 | 프로파일 격리, 기업 정책 |
| 클라우드 CLI | `~/.aws`, `~/.azure`, `~/.config/gcloud` | 동일 | 장기 토큰 | SSO/OIDC, 단기 세션(최소 만료) |

#### (랩) Linux 점검 스니펫(읽기 전용)

```bash
echo "== SSH keys =="; ls -l ~/.ssh || true
echo "== AWS creds =="; ls -l ~/.aws || true
echo "== GCP gcloud =="; ls -l ~/.config/gcloud || true
echo "== Browser profiles =="
ls -ld ~/.config/google-chrome* ~/.mozilla/firefox/* 2>/dev/null || true
```

---

## Pass-the-Hash / Pass-the-Ticket, Kerberoasting (개념·방어·가시성)

> 공통 개념: **비밀번호 ‘자체’가 아니라, 재사용 가능한 토큰/해시/티켓을 획득**해 다른 시스템에서 **재사용**하는 공격군입니다.
> 실무 방어의 본질은 ① **자격 격리** ② **재사용 무력화** ③ **강제 암호화/최신 알고리즘** ④ **짧은 수명** ⑤ **가시성**입니다.

### Pass-the-Hash (PtH)

- **무엇**: NTLM 해시를 얻어 **해시 자체로 인증**(도메인/로컬)
- **전제**: 동일 해시로 인증 허용, 해시 노출(메모리/디스크/전송)
- **방어**
  - **Credential Guard + LSA PPL**(LSASS 접근 차단)
  - **로컬 관리자 계정 무작위화(LAPS/Windows LAPS)** → **해시 재사용 가치 제거**
  - **NTLM 비활성/제한**, SMB 서명/채널 바인딩
  - **RDP Restricted Admin 모드 제한**, 원격 데스크톱 자격 위임 금지
  - 관리 평면 분리(관리용 워크스테이션/Jump Server)

### Pass-the-Ticket (PtT)

- **무엇**: Kerberos 티켓(TGT/TGS)을 탈취해 재사용
- **전제**: 티켓 파일/메모리 노출, 유효 시간
- **방어**
  - **TGT 수명 최소화**, **AES-only**, **RC4 비활성**
  - **Protected Users** 그룹(티켓 캐시·NTLM 금지 등 강화)
  - 티켓 캐시 접근 모니터링, **KDC 감사**(이상 TGS 요청)

### Kerberoasting

- **무엇**: **SPN**이 있는 서비스 계정의 TGS를 가져와 **오프라인**에서 키 크래킹 시도
- **전제**: 약한 비밀번호·RC4 허용, 서비스 계정 권한 과다
- **방어**
  - **gMSA(그룹 관리 서비스 계정)** 채택 → **자동 길고 강한 키 회전**
  - **AES-only** 강제, **RC4** 차단
  - **서비스 계정 최소 권한**, 비활성 SPN 제거
  - **이상 TGS 요청 탐지**(대량, 낮은 시간대, 비정상 클라이언트)

#### (운영) Windows 이벤트/탐지 힌트

- **Kerberos**: 4768(TGT), 4769(TGS), 4771/4776(실패)
- **NTLM**: 4624/4625(Logon Type, AuthenticationPackage=NTLM)
- **의심 시그널 예**
  - 짧은 시간 **TGS(4769)** 폭증(특히 서비스 계정 대상 다양)
  - **NTLM 인증 비율** 급증, 서버별 산발적 4624 Type 3 증가
  - 관리가정 외 워크스테이션에서 **도메인 관리자** 티켓 사용

#### (랩) Sigma 스타일 예시(개념)

```yaml
title: Kerberoasting Suspicious TGS Volume
logsource:
  product: windows
  service: security
detection:
  selection:
    EventID: 4769
  condition: selection | count() by SrcIP, ServiceName > 100 within 5m
level: medium
```

---

## 초기 접근 후 Persistence (Run Key / Services / WMI / EventLog abuse)

> 포커스: **어떤 설정이 영속 지점을 만들 수 있는가**를 **점검·차단**하는 방법입니다. 아래 PowerShell은 **읽기 전용 점검**과 **수정(하드닝)** 예시를 분리해 제공합니다. (악성 유지 스크립트는 제공하지 않습니다.)

### Autoruns 범주 요약

| 범주 | 예 | 방어 포인트 |
|---|---|---|
| Run Keys | `HKCU/HKLM\...\Run`, `RunOnce` | 승인 목록 외 차단(AppLocker/WDAC), 정기 감사 |
| 서비스 | ImagePath, Unquoted Path, 쓰기 가능한 디렉터리 | 경로 따옴표, 디렉터리 권한, 서비스 DACL 표준화 |
| 스케줄러 | SYSTEM/경로 쓰기 가능 작업 | 권한/경로 점검, 운영 표준 템플릿 |
| WMI 영구 구독 | `__EventFilter`/`CommandLineEventConsumer`/`__FilterToConsumerBinding` | 주기 열람, 비인가 구독 제거 |
| LNK/시작프로그램 | `%ProgramData%\Microsoft\Windows\Start Menu\Programs\Startup` | LNK 원본 경로 검증·서명 요구 |
| EventLog abuse (개념) | 로거/구성 이벤트를 **스텔스 시도**에 사용 | 운영 정책·로그 무결성·감사 규칙으로 탐지/거부 |

---

### Windows “읽기 전용” 전수 점검 스크립트

```powershell
<# win_persistence_audit.ps1 — 권한 상승/실행 X, "의심 지점" 나열
    실행: 관리자 권장
#>

Write-Host "== Run Keys =="
$runPaths = @(
 "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run",
 "HKCU:\Software\Microsoft\Windows\CurrentVersion\RunOnce",
 "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run",
 "HKLM:\Software\Microsoft\Windows\CurrentVersion\RunOnce",
 "HKLM:\Software\WOW6432Node\Microsoft\Windows\CurrentVersion\Run"
)
foreach($p in $runPaths){ if(Test-Path $p){ Get-ItemProperty $p | Format-List } }

Write-Host "`n== Startup Folders (LNK) =="
$startup = @(
 "$env:ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp",
 "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup"
)
$startup | % { Get-ChildItem $_ -Filter *.lnk -ErrorAction SilentlyContinue | Select FullName,LastWriteTime }

Write-Host "`n== Services: Unquoted or Writable =="
function Test-Writable { param([string]$Path)
  try { (Get-Acl -LiteralPath $Path).Access | ?{ $_.IdentityReference -match 'Everyone|Users|Authenticated Users' -and $_.FileSystemRights.ToString() -match 'Write|Modify|FullControl' } | % { $true } | Select -First 1 } catch { $false } }
$svcs = Get-WmiObject Win32_Service
foreach($s in $svcs){
  $img = $s.PathName
  if(-not $img){ continue }
  $unquoted = ($img -notmatch '^".*"$') -and ($img -match '\s')
  $exe = ($img -replace '^"','' -replace '"$','').Split(' ')[0]
  if(Test-Path $exe){
    $dir = Split-Path $exe -Parent
    $wExe = Test-Writable $exe
    $wDir = Test-Writable $dir
    if($unquoted -or $wExe -or $wDir){
      [PSCustomObject]@{ Service=$s.Name; Unquoted=$unquoted; WritableExe=$wExe; WritableDir=$wDir; ImagePath=$img }
    }
  }
} | Sort Service | Format-Table -AutoSize

Write-Host "`n== Scheduled Tasks (SYSTEM + Writable Exec Dir) =="
Get-ScheduledTask | % {
  $sys = $_.Principal.UserId -match 'SYSTEM'
  $_.Actions | % {
    if($sys -and $_.Execute -and (Test-Path $_.Execute)){
      $d = Split-Path $_.Execute -Parent
      if(Test-Writable $d){
        [PSCustomObject]@{ Task=$_.Id; Exec=$_.Execute; DirWritable=$true }
      }
    }
  }
} | Format-Table -AutoSize

Write-Host "`n== WMI Permanent Subscriptions =="
Get-WmiObject -Namespace root\subscription -Class __EventFilter | Select Name,Query,EventNamespace
Get-WmiObject -Namespace root\subscription -Class CommandLineEventConsumer | Select Name,CommandLineTemplate
Get-WmiObject -Namespace root\subscription -Class __FilterToConsumerBinding | Select Filter,Consumer
```

**읽는 법**
- **Run/Startup**: 승인되지 않은 실행 경로 존재 여부
- **Service**: `Unquoted=true` 또는 `Writable* = true` → **즉시 수정 대상**
- **Task**: SYSTEM 작업이 쓰기 가능한 디렉터리에서 실행 → **경로 권한 조정**
- **WMI**: 조직 표준 이외의 **구독/컨슈머/바인딩**은 조사·삭제

---

### 수정(하드닝) 예시 — 서비스/작업/WMI (안전)

> 변경은 **벤더 문서/운영 절차**에 따라 승인 후 수행하세요.

**A) 서비스 경로 따옴표·권한**
```powershell
# ImagePath 이중 따옴표 보정

$svc = "VendorApp"
$k = "HKLM:\SYSTEM\CurrentControlSet\Services\$svc"
$img = (Get-ItemProperty $k).ImagePath
if($img -notmatch '^".*"$'){ Set-ItemProperty $k ImagePath ('"'+$img+'"') }

# 디렉터리 권한: Users/Everyone 쓰기 제거

$exe = ($img -replace '^"','' -replace '"$','').Split(' ')[0]
$dir = Split-Path $exe -Parent
icacls $dir /inheritance:r
icacls $dir /grant:r "SYSTEM:(OI)(CI)(F)" "Administrators:(OI)(CI)(M)"
icacls $dir /remove:g "Users" "Authenticated Users" "Everyone"
```

**B) 위험 작업 수정**
```powershell
# SYSTEM 작업 실행 경로 디렉터리 권한 경직

Get-ScheduledTask | ? { $_.Principal.UserId -match 'SYSTEM' } | % {
  $_.Actions | % {
    if($_.Execute -and (Test-Path $_.Execute)){
      $d = Split-Path $_.Execute -Parent
      icacls $d /inheritance:r
      icacls $d /grant:r "SYSTEM:(OI)(CI)(F)" "Administrators:(OI)(CI)(M)"
      icacls $d /remove:g "Users" "Authenticated Users" "Everyone"
    }
  }
}
```

**C) WMI 구독 정리(비인가만)**
```powershell
# 식별된 비인가 구독 제거 (예시: 이름 기준)

$badFilter = Get-WmiObject -Namespace root\subscription -Class __EventFilter -Filter "Name='UnapprovedFilter'"
$badConsumer = Get-WmiObject -Namespace root\subscription -Class CommandLineEventConsumer -Filter "Name='UnapprovedConsumer'"
$badBind = Get-WmiObject -Namespace root\subscription -Class __FilterToConsumerBinding -Filter "Filter=""$($badFilter.__RELPATH)"""
$badBind | % { $_.Delete() } ; $badConsumer.Delete() ; $badFilter.Delete()
```

---

### EventLog abuse(개념) — 방어 관점 가이드

- **아이디어(공격 모델)**: 이벤트 트리거·로거·서명되지 않은 소스 추가 등으로 **스텔스 영속성** 시도
- **방어**
  - **이벤트 로그 소스 등록 권한** 최소화, 감사
  - **로그 무결성 정책**(크기/백업/보존) 유지, “비정상 소스 추가·삭제” 탐지
  - SIEM에서 **신규 채널/소스·오류율 급증** 이상치 룰

**(SIEM 룰 스케치)**
- **System/Application** 채널에 **이전엔 없던 Source 이름** 등장 → 경고
- **EventLog 서비스 구성 변경**(보존/최대 크기) → Change 관리 연계

---

## 8.x 운영 체크리스트 (요약)

**자격/비밀**
- [ ] 브라우저 저장형 암호 금지, 기업용 Password Manager 강제
- [ ] Credential Guard + LSA PPL + ASR(자격 유출 차단 규칙)
- [ ] LAPS/Windows LAPS로 로컬 관리자 **랜덤화/주기 회전**
- [ ] Kerberos **AES-only**, RC4 비활성, 서비스 계정 **gMSA** 전환
- [ ] 클라우드 자격(aws/azure/gcp) **단기 세션·OIDC/SSO**, 장기 키 축소

**영속화·가시성**
- [ ] Run/Services/Tasks/WMI 정기 감사(위 스크립트 자동화 + 주간 리포트)
- [ ] 서비스 경로 **따옴표/권한** 표준화, 작업 실행 디렉터리 쓰기 제한
- [ ] Pod/컨테이너 보안(별도 장에서 제시)과 결합: `no-new-privileges`, seccomp/AppArmor
- [ ] Sysmon(1/7/10/12/13/14/19/20/21) + Kerberos(4768/4769/4771/4776) 루틴 모니터
- [ ] 예외는 **만료일/사유** 필수, 재검토 루프

---

## 8.x 트러블슈팅(자주 묻는 질문)

- **“ASR/LSA 보호 켜니 운영툴이 동작 안 해요.”**
  → 벤더 서명/드라이버 기반 합법 접근 방식으로 전환. 예외는 **서명·경로·시간제한**.
- **“Kerberoasting 탐지 오탐 많음.”**
  → 정상 배치/스케줄러 잡의 TGS 패턴 화이트리스트, “비정상 클라이언트/시간대/대량”에 가중치.
- **“WMI 구독이 많은데 뭘 지워야 하죠?”**
  → 표준 명명 규칙·소유자·배포 파이프라인을 문서화. **표준 외**는 티켓 열어 검증 후 제거.

---

# 마무리

- **크레덴셜 보호**는 “어디에/무엇이/어떻게 보호되는가”를 아는 순간부터 시작합니다.
- PtH/PtT/Kerberoasting은 **재사용 가능한 비밀**의 문제입니다. **격리·회전·최신 암호화·짧은 수명**으로 구조적으로 무력화하세요.
- 초기 접근 이후 **영속화 지점**은 대부분 **설정/권한/경로 조합**의 실패입니다. 본문 점검·하드닝 스크립트를 **정기 작업**으로 편성하고, **SIEM 룰**과 **정책(ASR/WDAC/PodSecurity)**을 결합해 “배포 전 차단 → 배포 후 가시성” 루프를 완성하세요.
