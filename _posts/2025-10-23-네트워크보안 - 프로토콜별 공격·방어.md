---
layout: post
title: 네트워크보안 - 프로토콜별 공격·방어
date: 2025-10-23 21:25:23 +0900
category: 네트워크보안
---
# 6. 프로토콜별 공격·방어

> 목표: TCP/UDP/ICMP에서 자주 악용되는 패턴을 이해하고, **시스템·네트워크 레벨 방어와 탐지 지표**,
> 그리고 **레이트 리미트/큐 관리 튜닝**을 합법적인 샌드박스에서 검증한다.

---

## 6.1 TCP: SYN Flood, RST 인젝션, 윈도 조작 / SYN 쿠키·uRPF

### 6.1.1 공격 원리 이해(비재현)
- **SYN Flood**: 대량의 초기 SYN을 보내 **백로그/세션 테이블**을 소진시켜 신규 접속을 방해.
- **RST Injection**: 활성 연결에 **위조 RST**를 주입해 조기 종료 유도(과거 BGP 세션 공격 등).
- **Window Manipulation**: **Window Size/Zero-Window** 남발로 송신 측 전송률 저하·혼잡 유발.

> 공통 전제: **소스 IP 스푸핑**이 가능하거나(UDP·TCP SYN), **중간자·경로상 가시성**이 있을 때 위력이 커짐.

---

### 6.1.2 방어·완화 체크리스트(호스트/리눅스 기반 웹/프록시 예)

#### (A) 커널 파라미터(학습용 템플릿)
```bash
# SYN Flood 내성
sysctl -w net.ipv4.tcp_syncookies=1               # SYN 쿠키
sysctl -w net.ipv4.tcp_max_syn_backlog=4096       # 백로그 여유
sysctl -w net.ipv4.tcp_synack_retries=3           # 절충적 재시도

# RST 남발·비정상 플래그 완화
sysctl -w net.ipv4.tcp_rfc1337=1                  # TIME-WAIT RST 보호
sysctl -w net.ipv4.tcp_abort_on_overflow=0

# uRPF 유사(호스트 차원 역방향 경로 체크) — 라우터엔 BCP38/uRPF 권장
sysctl -w net.ipv4.conf.all.rp_filter=1
sysctl -w net.ipv4.conf.default.rp_filter=1

# 큐·버퍼(서비스 특성에 맞게 보수적으로)
sysctl -w net.core.somaxconn=4096
sysctl -w net.core.netdev_max_backlog=2500
```

#### (B) nftables로 TCP 기본 하드닝(개념 예)
```nft
table inet filter {
  chains {
    input {
      type filter hook input priority 0; policy accept;
      # 비정상 TCP 플래그(Christmas/NULL 등) 드롭
      tcp flags & (fin|syn|rst|psh|ack|urg) == 0 drop
      # RST 레이트 리미트
      tcp flags & rst != 0 limit rate 10/second burst 20 accept
      tcp flags & rst != 0 drop
      # SYN 레이트 리미트(1 소스당, 과도한 초기 시도 억제)
      ct state new tcp flags & syn != 0 limit rate over 200/second drop
    }
  }
}
```

#### (C) 프런트(프록시/웹서버)에서 연결 수 제한
- **프록시 단**: 커넥션 풀 상한, 백엔드별 동시 연결 제한
- **애플리케이션 단**: `keep-alive` 타임아웃 합리화, 혹은 HTTP/2로 다중화

Nginx 예(핵심만)
```nginx
http {
  limit_conn_zone $binary_remote_addr zone=perip:10m;
  limit_req_zone  $binary_remote_addr zone=req:10m rate=50r/s;

  server {
    location / {
      limit_conn perip 50;
      limit_req  zone=req burst=100 nodelay;
    }
    keepalive_timeout 10s;
  }
}
```

---

### 6.1.3 네트워크 계층 방어
- **BCP38(소스 주소 검증)** / **uRPF**: 스푸핑 **원천 차단**(엣지/라스트 마일 라우터)
- **ACL/CoPP(제어평면 보호)**: 라우터 제어 트래픽에 레이트 리미트
- **DDoS 스크러빙/블랙홀·Flowspec(고급)**: 조직 외곽/업스트림 연계로 대규모 공격 흡수

---

### 6.1.4 탐지 지표 & 경보 아이디어
- **SYN:ACK 비율**, **SYN-RECV 큐 점유율**, **초당 새 연결 시도** 급증
- **RST 비율 상승**(시간 창 당)
- **ZeroWindow/WindowFull** 이벤트 급증(서버/클라이언트 어느쪽 병목인지 구분)

TShark 빠른 힌트(오프라인 분석)
```bash
# SYN만 집계
tshark -r cap.pcap -Y "tcp.flags.syn==1 && tcp.flags.ack==0" | wc -l
# RST만 집계
tshark -r cap.pcap -Y "tcp.flags.rst==1" | wc -l
```

---

## 6.2 UDP: 리플렉션/앰플리피케이션(DNS/NTP/SSDP/Memcached)

### 6.2.1 원리 이해(비재현)
- 공격자는 **스푸핑된 소스 IP(피해자 주소)**로 **증폭 가능한 서버**에 요청 → 서버가 **큰 응답**을 피해자에게 전송.
- 대표 프로토콜:
  - **DNS**(오픈 리졸버, ANY/큰 TXT/분절),
  - **NTP**(과거 `monlist`/`readvar`),
  - **SSDP/UPnP**(239.255.255.250/1900),
  - **Memcached**(UDP 모드, 과거 대형 키 응답)

---

### 6.2.2 서비스별 방어 가이드(핵심만)

**DNS(리졸버/권한 서버)**
- **오픈 리커전 금지**(ACL), **Response Rate Limiting(RRL)**, **EDNS 크기 제한**
- DoS 시 **대형 응답 금지/압축 제한** 정책, **캐시 키 강화**(DNSSEC 검증 권장)

**NTP**
- 최신 버전, `monlist` 같은 **과거 취약 응답 비활성**, 외부 공개 리스닝 금지
- **대상 포트(123/UDP)** 외부 인바운드 최소화, 혹은 **승인된 동기원만**

**SSDP/UPnP**
- 게이트웨이 외부로 **SSDP 포워드 금지**, 내부 브로드캐스트만 허용
- 서버/프린터 등 단말 **UPnP 비활성화**(정책/관리도구)

**Memcached**
- **UDP 모드 비활성(-U 0)**, 외부 노출 금지
- 내부 접근 제어(방화벽/보안그룹), 인증 프록시 뒤에 배치

---

### 6.2.3 에지/방화벽 레이트 리미트 예(nftables)
```nft
table inet filter {
  chain input {
    type filter hook input priority 0;
    # DNS 응답(서버 역할 시) 폭주 방지: 초과 구간을 천천히 처리
    udp dport 53 ct state established,related limit rate 2000/second burst 5000 accept
    udp dport 53 drop

    # SSP/UPnP 서버가 아예 없다면 외부에서 1900/udp 차단
    ip saddr != { 10.0.0.0/8, 192.168.0.0/16 } udp dport 1900 drop
  }
}
```
> 실제 값은 트래픽 특성/용량에 맞춰 측정 기반으로 산정하세요.

---

### 6.2.4 탐지 지표
- **단일 목적지에 대한 대형 UDP 응답 바이트/초 급증**
- **상위 Talker**에 UDP 53/123/1900/11211의 **비정상 스파이크**
- NetFlow/IPFIX 기반 **5-tuple 집계**로 이상 패턴 탐지

---

## 6.3 ICMP: 스캐닝·터널링, Rate-Limit·필터링 전략

### 6.3.1 원리 이해
- **스캐닝**: Echo Request/Reply로 호스트 가용성 탐색.
- **터널링**: ICMP 페이로드를 임의 데이터 전송 채널로 악용(프록시/우회).
- **DoS/리플렉션**: ICMP Redirect/Fragmentation Needed 남용, 혹은 대형 Echo.

### 6.3.2 정책 설계(차단이 전부가 아님)
- **운영 필요 ICMP 타입은 허용**:
  - Path MTU Discovery: **ICMP Type 3 Code 4(Frag Needed)** 필요
  - Traceroute/진단: Time Exceeded(11)
- **Echo**는 레이트 제한 또는 내부만 허용
- **Redirect**는 라우터에서 비활성화(기본), 호스트 수용 금지

nftables 예
```nft
table inet filter {
  chain input {
    type filter hook input priority 0;
    # PMTUD 필수 타입 허용
    ip protocol icmp icmp type { destination-unreachable, time-exceeded, parameter-problem } accept
    ip6 nexthdr icmpv6 icmpv6 type { packet-too-big, time-exceeded, parameter-problem } accept

    # Echo는 레이트 제한 (서버 특성 고려)
    ip protocol icmp icmp type echo-request limit rate 10/second burst 20 accept
    ip protocol icmp icmp type echo-request drop
  }
}
```

---

### 6.3.3 탐지 아이디어
- **Echo Request/Reply** 급증, **비정상 페이로드 길이**(터널링 의심)
- **Redirect** 프레임 관찰 시 즉시 경보
- **packet-too-big**(ICMPv6) 연속 발생 → **PMTUD 실패**/경로 이상

TShark 힌트
```bash
# ICMP Echo 요청 수
tshark -r cap.pcap -Y "icmp.type==8" | wc -l
# ICMP Redirect
tshark -r cap.pcap -Y "icmp.type==5" | wc -l
```

---

## 6.4 실습: 소규모 DDoS 랩(제한형) + 레이트 리미트 튜닝

> **공격 재현 금지** 원칙에 따라, 실제 Flood 트래픽을 발생시키지 않습니다.
> 대신 **pcap 재생(안전한 속도)**, **합성 이벤트**, **큐/리밋 파라미터 튜닝**을 통해
> “탐지—완화” 체인이 정상 동작하는지 확인합니다.

### 6.4.1 랩 토폴로지(컨테이너)
```
client (부하·정상요청)  ─┐
observer(패시브 캡처) ──┼── proxy/web ── server(app)
synth(합성 이벤트)   ──┘
```
- **client**: 정상 HTTP 부하 생성기(예: `hey`/`wrk` 같은 합법 부하 도구, 낮은 QPS)
- **observer**: `tcpdump`/Zeek/Suricata로 캡처·로그
- **synth**: **합성 경보 이벤트** 생성(아래 스크립트)

> 핵심은 **서버/프록시의 레이트 리미트/큐 튜닝이 정상 동작하는지** 보는 것입니다.

---

### 6.4.2 합성 이벤트 생성기(안전)

#### (A) “SYN 시도 과다” 로그 합성
```python
# synth_syn_spike.py
# 초당 새 연결 시도 카운터만 생성(실제 패킷 X) → SIEM 테스트
import time, json, random
now = int(time.time())
for i in range(60):
    evt = {
      "ts": now+i, "event":"SYN_ATTEMPTS_SYNTH",
      "per_second": random.randint(800, 1200) if 20 <= i <= 30 else random.randint(50, 120)
    }
    print(json.dumps(evt))
```
- SIEM 룰: `per_second > 500` 10초 이상 지속 → **경보**
- 프록시/커널 튜닝 후, 경보가 나더라도 **서비스 지연이 허용 범위인지** 대시보드로 확인

#### (B) “UDP 응답 스파이크(앰플리 가능 포트)” 로그 합성
```python
# synth_udp_amp.py
import time, json, random
ports = [53, 123, 1900, 11211]
for i in range(60):
  for p in ports:
    bps = random.randint(10_000, 50_000)
    if 25<=i<=28: bps *= 30  # 짧은 스파이크
    print(json.dumps({"ts":int(time.time()), "event":"UDP_OUT_BPS_SYNTH", "dport":p, "bps":bps}))
```
- 룰: 특정 포트 `bps`가 기준 초과(예: 100Mbps 환산)시 경보 + **자동 임시 리밋 정책** 제안

#### (C) “ICMP Echo 급증” 로그 합성
```python
# synth_icmp_echo.py
import time, json
for i in range(40):
  print(json.dumps({"ts":int(time.time()), "event":"ICMP_ECHO_SYNTH", "rps": 5 if i<20 else 300}))
```

---

### 6.4.3 pcap 재생으로 서버·프록시 튜닝 검증(무해)
- **아이디어**: SYN/HTTP 요청이 섞인 **샘플 pcap**을 **낮은 속도**로 재생하여
  Nginx `limit_conn/limit_req`, 커널 `tcp_syncookies` 등이 **의도대로 동작하는지** 확인

```bash
# 낮은 QPS로 안전 재생(예: 50pps)
tcpreplay --pps=50 --loop=1 --intf1=eth0 sample_mixed.pcap
# 관측
ss -s              # 큐 점유율
sudo nstat -az | egrep 'ListenOverflows|ListenDrops'
sudo netstat -s | egrep 'listen|SYN'
```

> `ListenOverflows/Drops`가 0에 가깝도록 **limit 값/큐 길이/백로그**를 조정.

---

### 6.4.4 Prometheus 지표·경보(개념)

**Nginx**
- `nginx_http_requests_total` / `nginx_connections{state}`
- `rate(nginx_http_requests_total[1m])` > 임계, `nginx_connections{state="writing"}` 급증

**Linux**
- `node_netstat_Tcp_InSegs`, `InErrs`, `PassiveOpens`, `CurrEstab`
- `ListenOverflows/ListenDrops` (node_exporter textfile 또는 eBPF로 수집)

**Alert 예시(개념)**
```
- alert: SynQueuePressure
  expr: node_netstat_TcpExt_ListenOverflows > 0
  for: 1m
  labels: { severity: warning }
  annotations:
    summary: "SYN queue overflowing"
```

---

### 6.4.5 큐 관리·AQM 힌트
- **fq_codel/CAKE**: 버퍼블로트·버스트 손실 완화
- **임계치 기반 드롭**으로 **긴 꼬리 지연** 방지 → 애플리케이션 체감 개선

```bash
# egress에 fq_codel 적용 예
tc qdisc replace dev eth0 root fq_codel limit 1000 target 5ms interval 100ms ecn
```

---

### 6.4.6 운영 반영 체크리스트
- [ ] **SYN 쿠키/백로그** 조정 및 모니터링
- [ ] **RST 레이트 리미트**, **이상 플래그 차단**(nftables)
- [ ] **BCP38/uRPF**(에지 라우터)와 **CoPP**(제어평면 보호)
- [ ] **DNS/NTP/SSDP/Memcached** 공개 여부 점검, 필요 포트만 허용, **RRL/UDP 비활성**
- [ ] **ICMP 정책**: PMTUD 필수 타입 허용 + Echo 제한
- [ ] **대시보드/경보**: SYN:ACK 비율·RST/UDP 포트별 bps·ICMP rps
- [ ] **회귀 테스트**: 합성 이벤트·pcap 재생으로 정책 업데이트 영향 평가

---

## 요약
- TCP는 **SYN 쿠키/큐 튜닝/플래그 필터/레이트 리미트**로, 네트워크는 **BCP38/uRPF/CoPP**로 뼈대를 세워야 합니다.
- UDP는 **앰플리 원천 제거(서비스 설정)**가 최우선이며, 에지에서 **포트별 레이트 리미트**와 **모니터링**이 필수입니다.
- ICMP는 **완전 차단이 아니라 ‘필요 타입 허용 + 레이트 제한’**이 정답입니다.
- 실습은 **공격 재현 대신** 합성 이벤트/저속 pcap 재생으로 **탐지—완화—튜닝**의 품질을 안전하게 검증합니다.
