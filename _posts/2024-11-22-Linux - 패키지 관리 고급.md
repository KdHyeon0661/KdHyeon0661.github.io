---
layout: post
title: Linux - 패키지 관리 고급
date: 2024-11-22 19:20:23 +0900
category: Linux
---
# 패키지 관리 고급

## 0. 용어 정리 & 큰 그림

- **패키지 관리자 층**
  - **고수준 클라이언트**: `apt`, `dnf`(신세대), `yum`(구세대)
  - **로우레벨**: `dpkg`(DEB 설치기), `rpm`(RPM 설치기)
- **리포지터리(저장소)**: 패키지 인덱스/메타/서명 파일을 제공하는 원격 서버(혹은 로컬 미러).
- **서명/신뢰**: GPG 키로 리포지터리/패키지 신뢰 체인 형성(무결성·출처 검증).
- **신형 포맷**: Snap/Flatpak/AppImage — 각기 **격리/의존성 번들/업데이트** 방식이 다르다.

---

## 1. APT (Debian/Ubuntu) 고급

### 1.1 캐시/의존성/정리
```bash
sudo apt clean                # 다운로드 캐시 전체 삭제
sudo apt autoclean            # 오래된 패키지 캐시만 삭제
sudo apt autoremove           # 더 이상 필요 없는 의존 패키지 제거
sudo apt-get -o Debug::pkgProblemResolver=yes dist-upgrade
```

### 1.2 패키지 메타/탐색/정책
```bash
apt show nginx                # 상세 정보(설치 후보, 버전, 종속성)
apt-cache policy nginx        # 설치 후보/우선순위(Pin) 확인
apt-cache depends nginx       # 정/역 의존성
apt-cache rdepends libssl3
apt-cache madison nginx       # 사용 가능한 버전 라인업
```

### 1.3 버전 고정/홀드/핀(Pinning)
- **특정 버전 설치**
```bash
sudo apt install nginx=1.24.0-2ubuntu7
```
- **업데이트 제외(홀드)**
```bash
sudo apt-mark hold nginx
sudo apt-mark unhold nginx
```
- **리포지터리/배포간 Pin**
```bash
# /etc/apt/preferences.d/99-pin-example
Package: *
Pin: release a=stable
Pin-Priority: 500

Package: nginx
Pin: release a=testing
Pin-Priority: 700   # testing의 nginx를 선호
```
```bash
apt-cache policy nginx        # Pin 결과 검증
```

### 1.4 소스·빌드 의존성
```bash
sudo apt-get source nginx                 # 소스 내려받기
sudo apt-get build-dep nginx              # 빌드 의존성 설치
# (컨테이너/빌드서버에서 재현 가능 빌드를 위해 매우 중요)
```

### 1.5 리포지터리 관리(서명·HTTPS·PPA)
- **리포지토리 선언**
  - `/etc/apt/sources.list` 또는 `/etc/apt/sources.list.d/*.list`
- **GPG 키: apt-key 폐기 추세 → signed-by 권장**
```bash
# 신뢰 키를 키링 파일에 저장(예: /usr/share/keyrings/vendor.gpg)
sudo curl -fsSL https://repo.example.com/pubkey.gpg \
  -o /usr/share/keyrings/vendor.gpg

# 리포지토리 라인에 signed-by 적용
echo "deb [signed-by=/usr/share/keyrings/vendor.gpg] \
https://repo.example.com/ubuntu noble main" | \
sudo tee /etc/apt/sources.list.d/vendor.list

sudo apt update
```
- **PPA**
```bash
sudo add-apt-repository ppa:graphics-drivers/ppa
sudo apt update
```

### 1.6 자동 업데이트(서버)
```bash
sudo apt install unattended-upgrades
sudo dpkg-reconfigure unattended-upgrades
# /etc/apt/apt.conf.d/50unattended-upgrades 편집으로 세부 제어
```

### 1.7 문제 해결 & 되돌리기
```bash
sudo apt -f install                 # 깨진 의존성 복구 시도
sudo dpkg --configure -a            # 구성 단계 중단 복원
sudo apt-get install --reinstall pkg
sudo apt install ./local.deb        # 로컬 파일 설치(의존성은 리포지토리에서 해결)
```

### 1.8 dpkg 심화(디버전/트리거)
```bash
sudo dpkg -S /usr/bin/curl          # 파일 소유 패키지 찾기
sudo dpkg-divert --add --rename --divert /usr/bin/ls.real /usr/bin/ls
sudo dpkg-divert --remove /usr/bin/ls
```
> **divert**는 공급 패키지의 파일을 다른 경로로 비켜놓고 **자체 파일**을 우선 사용하도록 만드는 고급 기법(배포 커스터마이징 시 용이).

---

## 2. DNF / YUM (Fedora/RHEL/CentOS) 고급

### 2.1 캐시/정리/이력
```bash
sudo dnf clean all
sudo dnf autoremove
dnf history                      # 작업 이력
sudo dnf history info 23
sudo dnf history undo 23         # 특정 트랜잭션 되돌리기
```

### 2.2 정보/탐색
```bash
dnf info nginx
dnf repoquery --requires nginx      # 의존성
dnf repoquery --whatrequires openssl
dnf provides /usr/bin/curl          # 해당 파일을 제공하는 패키지
```

### 2.3 리포/키/검증
- 리포 파일: `/etc/yum.repos.d/*.repo`
- 주요 키 옵션: `gpgcheck=1`, `gpgkey=URL_or_path`
```bash
sudo rpm --import https://repo.example.com/RPM-GPG-KEY-vendor
sudo dnf repolist
```

### 2.4 모듈/앱스트림/버전 잠금
```bash
dnf module list nodejs
sudo dnf module enable nodejs:20
sudo dnf module install nodejs:20/minimal

# 버전 잠금(플러그인)
sudo dnf install 'dnf-command(versionlock)'
sudo dnf versionlock add nginx-1:1.24.*
sudo dnf versionlock list
```

### 2.5 동기화/다운그레이드
```bash
sudo dnf distro-sync             # 배포판 기준버전으로 정렬(업/다운그레이드)
sudo dnf downgrade nginx         # 구버전으로 내리기
```

### 2.6 다운로드 전용/오프라인 설치
```bash
sudo dnf download --resolve nginx   # 의존성 포함 내려받기
sudo rpm -Uvh *.rpm                 # 오프라인 설치
```

---

## 3. 저장소 운영·미러·프록시·속도 최적화

### 3.1 APT 미러 빠르게 전환(Ubuntu)
```bash
# 빠른 미러로 일괄 치환(예제)
sudo sed -i 's|archive.ubuntu.com|mirror.kakao.com|g' /etc/apt/sources.list
sudo apt update
```

### 3.2 DNF fastestmirror & 병렬 다운로드
```ini
# /etc/dnf/dnf.conf
fastestmirror=True
max_parallel_downloads=10
defaultyes=True
keepcache=True
```

### 3.3 apt 프록시·캐시 서버(사내 공용)
- **apt-cacher-ng** 또는 **nginx 리버스 프록시**로 대역폭 절감/속도 향상.

---

## 4. “신형” 앱 포맷 — Snap / Flatpak / AppImage

### 4.1 Snap (Canonical)
- **confinement(격리)**: `strict`(기본 샌드박스), `classic`(루트와 유사 권한), `devmode`(개발)
- **interface**: 카메라, 오디오, 블루투스 등 **권한 연결** 필요

```bash
sudo snap install vlc
snap list
snap connections vlc                 # 연결된 인터페이스 확인
sudo snap connect vlc:camera         # 권한 연결
sudo snap refresh vlc                # 업데이트
sudo snap revert vlc                 # 이전 리비전으로 롤백
```

**스냅 서비스(데몬)**
```bash
snap services
sudo snap start <snap>.<service>
sudo snap stop  <snap>.<service>
```

**스토리지/정리**
```bash
snap list --all | awk '/disabled/{print $1, $3}' | \
while read snapname revision; do sudo snap remove "$snapname" --revision="$revision"; done
```

### 4.2 Flatpak (freedesktop + OSTree)
- **Flathub** 기본 원격 저장소, 앱은 **런타임(runtime)** 위에 올려 탐색/업데이트 효율적
- **퍼미션 제어**: `flatpak override`로 **샌드박스 권한 조정**

```bash
sudo apt install flatpak
flatpak remote-add --if-not-exists flathub \
  https://flathub.org/repo/flathub.flatpakrepo

flatpak install flathub org.gimp.GIMP
flatpak list
flatpak info org.gimp.GIMP
flatpak update
```

**권한 오버라이드 예시**
```bash
flatpak override --user --filesystem=home org.gimp.GIMP
flatpak override --user --talk-name=org.freedesktop.secrets org.gimp.GIMP
flatpak override --show  # 현재 오버라이드 목록
```

**런타임 청소**
```bash
flatpak uninstall --unused
```

### 4.3 AppImage
- 단일 실행 파일(대개 FUSE 마운트 후 내부 실행)
- **설치 불필요/루트 불필요**, 업데이트는 파일 교체로 처리
```bash
chmod +x AppName-x86_64.AppImage
./AppName-x86_64.AppImage
```
- **AppImageUpdate**(zsync/델타) 지원 바이너리는 **증분 업데이트** 가능
- **통합 도구**: AppImageLauncher(메뉴 등록/아이콘), 보안상 출처 검증은 별도로 수행

---

## 5. 보안·서명·무결성

### 5.1 APT
- `signed-by=`로 리포 키를 **리포별 격리**(키 남용 방지)
- `Acquire::AllowInsecureRepositories "false";` 유지(기본)
- `apt-get source`로 소스와 서명 확인(재현 빌드 워크플로우)

### 5.2 DNF/RPM
- `gpgcheck=1` 유지, `localpkg_gpgcheck=1` 고려
- 키 회전/만료에 대비해 **키링 관리**(여러 키 병행 신뢰)

### 5.3 Snap/Flatpak/AppImage
- Snap/Flatpak은 스토어·원격에서 **서명·해시 검증** 자동화
- AppImage는 **파일 자체 서명/출처 검증** 파이프라인을 별도 설계(예: 릴리즈 CI에서 서명·서명 검증 스크립트 제공)

---

## 6. 롤백/스냅샷 전략

- **APT/DNF**: 트랜잭션 이력(특히 `dnf history undo`) + **파일시스템 스냅샷(Btrfs/ZFS/LVM)** 조합이 가장 안정적.
- **스냅/플랫팩**: 자체 **리비전/런타임 버전**을 활용한 롤백 가능.
- **AppImage**: 파일 교체가 곧 롤백.

---

## 7. 운영 시나리오별 레시피

### 7.1 “테스팅 리포에서 **딱 하나**만 가져오고 싶다”
```bash
# /etc/apt/preferences.d/nginx-testing
Package: nginx
Pin: release a=testing
Pin-Priority: 700

# 리포 라인은 testing과 stable 둘 다 선언
sudo apt update && sudo apt install nginx
apt-cache policy nginx
```

### 7.2 “업데이트로 서비스가 깨져서 **즉시 다운그레이드**”
```bash
# Debian/Ubuntu
apt-cache madison nginx
sudo apt install nginx=1.24.0-2ubuntu7
sudo apt-mark hold nginx

# Fedora/RHEL
sudo dnf downgrade nginx
sudo dnf versionlock add nginx-1:1.24.*
```

### 7.3 “CI/CD에서 **빌드 의존성** 한 번에 준비”
```bash
sudo apt-get update
sudo apt-get build-dep myapp       # debian/control 기반
# 또는 RPM
sudo dnf builddep myapp.spec
```

### 7.4 “서버는 보안업데이트 **자동**, 앱은 수동 관리”
```bash
# Debian/Ubuntu
sudo apt install unattended-upgrades
sudo dpkg-reconfigure unattended-upgrades
# /etc/apt/apt.conf.d/50unattended-upgrades 에서 Allowed-Origins 조정
```

### 7.5 “Flatpak 앱에 **권한 최소화**”
```bash
flatpak override --user --reset org.example.App       # 초기화
flatpak override --user --nofilesystem=host --no-talk-name=org.freedesktop.secrets org.example.App
# 필요한 최소만 점진 허용
```

### 7.6 “AppImage 대량 배포/업데이트”
- GitHub Release + **AppImageUpdate** 지원 빌드 → 클라이언트는 델타 업데이트
- 사내 배포는 **해시/서명 목록** 제공 + `curl | sh` 대신 **서명 검증 스크립트** 배포

---

## 8. 저장소 직접 운영(개요)

### 8.1 DEB(간단)
```bash
# 폴더 구조
repo/dists/stable/main/binary-amd64/Packages
repo/pool/main/p/pkgname_1.0_amd64.deb

# 인덱스 생성(예: reprepro, apt-ftparchive)
apt-ftparchive packages repo/pool/main > repo/dists/stable/main/binary-amd64/Packages
gzip -k repo/dists/stable/main/binary-amd64/Packages
# Release 파일 생성 + GPG 서명
```

### 8.2 RPM(간단)
```bash
createrepo /var/www/html/repo
# .repo 파일 배포
```

> **권장**: `reprepro`(DEB), `createrepo`(RPM) + CI로 자동화, **서명키 보호**(HSM/전용 빌드서버).

---

## 9. 문제 해결(트러블슈팅) 체크리스트

- **의존성 충돌**: `apt -o Debug::pkgProblemResolver=yes install ...`, `dnf repoquery --unsatisfied`
- **키/서명 오류**: 키 만료/경로/권한 확인 → APT는 `signed-by` 위치, DNF는 `gpgkey` URL 점검
- **속도 저하**: 미러 변경, DNF `fastestmirror`, 프록시캐시 도입
- **공간 부족**: `apt clean/autoremove`, `dnf clean all`, Snap **disabled revision** 정리, Flatpak **unused** 제거
- **롤백 실패**: 패키지 매니저만 믿지 말고 **FS 스냅샷** 병행

---

## 10. 비교 요약표

| 축 | APT | DNF/YUM | Snap | Flatpak | AppImage |
|---|---|---|---|---|---|
| 대상 | 시스템(전역) | 시스템(전역) | 전역(기본) | 전역/사용자 | 사용자 로컬 |
| 의존성 | 공유 라이브러리 | 공유 라이브러리 | 번들(스냅) | 런타임+앱 | 번들(단일) |
| 격리 | 약함 | 약함 | strong(interfaces) | strong(portals) | 없음(FUSE) |
| 롤백 | 제한(스냅샷 권장) | `history undo` | `revert` | 런타임 버전 교체 | 파일 교체 |
| 배포 범용성 | 배포판별 | 배포판별 | 광범위 | 광범위 | 최광범위 |
| 서버 적합 | ★★★★★ | ★★★★★ | ★★ | ★★ | ★ |
| 데스크탑 앱 | ★★ | ★★ | ★★★★ | ★★★★★ | ★★★ |

---

## 11. 빠른 치트시트

```bash
# APT
apt-cache policy pkg
apt-cache madison pkg
sudo apt install pkg=1.2.3-1
sudo apt-mark hold pkg
sudo apt-get build-dep pkg
sudo dpkg -S /path/file

# DNF
dnf repoquery --requires pkg
dnf provides /path/file
sudo dnf history undo <ID>
sudo dnf versionlock add pkg-1.2.*

# Snap
snap connections <snap>
sudo snap revert <snap>
snap list --all

# Flatpak
flatpak override --user --show
flatpak uninstall --unused

# AppImage
chmod +x app.AppImage && ./app.AppImage
```

---

## 마무리

- **서명·핀·버전 고정**으로 **안정성**을, **소스/빌드 의존성**으로 **재현성**을, **자동 업데이트 + 스냅샷**으로 **지속 운용성**을 만든다.
- 데스크탑/서버/IoT 등 상황마다 **적합한 포맷**을 골라 **혼합 전략**을 취하는 것이 최선이다.
- 오늘의 목표: “설치”를 넘어 “**통제 가능한 업데이트**”와 “**안전한 롤백**”을 습관화하자.
