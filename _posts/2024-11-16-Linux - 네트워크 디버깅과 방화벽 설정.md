---
layout: post
title: Linux - 네트워크 디버깅과 방화벽 설정
date: 2024-11-16 19:20:23 +0900
category: Linux
---
# 네트워크 디버깅과 방화벽 설정

## 전체 진단 개요(5분 트리아지 → 심층 분석)
1) **링크/주소**: 링크 업/다운, IPv4/IPv6, 게이트웨이
2) **L3 경로**: 라우팅·ARP/ND, 로컬 vs 원격
3) **L4 소켓**: LISTEN/ESTABLISHED, 바인딩 주소(0.0.0.0 vs 127.0.0.1)
4) **FW/NAT**: 호스트 방화벽·클라우드 SG·컨테이너 체인
5) **앱 계층**: HTTP/TLS/DNS 지연, MTU/MSS, 큐/혼잡

---

## 기본 건강검진(필수 단축 명령)
```bash
ip -br a              # 인터페이스/주소를 한 줄로
ip r                  # 라우팅(기본 게이트웨이 포함)
ping -c 3 8.8.8.8     # 외부 ICMP 왕복 지연
ping -c 3 $(ip r | awk '/default/ {print $3}')  # 게이트웨이
resolvectl status || cat /etc/resolv.conf       # 리졸버 확인
ss -tuln              # 열려 있는 포트
sudo ss -ant state established '( sport = :22 )' # 예: SSH 세션
sudo traceroute -n 1.1.1.1   # 경로 끊김 위치
```

---

## 계층별 상세 디버깅 플레이북

### 링크/주소 계층
```bash
ip link show
ip -br a
sudo ethtool eth0             # 링크 속도/듀플렉스/오토네고
journalctl -k | grep -i link  # 링크 flap 로그
```
- **증상**: RX/TX drops 증가 → 케이블/듀플렉스 불일치/드라이버 확인.
- **IPv6**: `ip -6 r`, `ping6 -c 3 2606:4700:4700::1111`.

### 라우팅/ARP/ND
```bash
ip r get 8.8.8.8
ip neigh
arp -n                     # (net-tools)
```
- **게이트웨이 미설정**: `ip r add default via 192.168.1.1 dev eth0`.
- **ARP 불일치**: 동일 IP를 둘 이상의 MAC이 응답 → `ip neigh flush all` 후 재학습.

### DNS 층(짧게)
```bash
dig +short example.com
dig @1.1.1.1 example.com
getent hosts example.com   # nsswitch 순서로 확인
```
- DNS만 느림 → `ndots`, `timeout`, split-DNS, DoT/프록시 개입 점검.

### 소켓/서비스 계층
```bash
ss -tulnp | grep ':80\>'               # 80/TCP 리슨 여부 및 PID
sudo systemctl status nginx
sudo lsof -iTCP:443 -sTCP:LISTEN -P -n
```
- **127.0.0.1 바인딩**인데 외부 접속 불가 → `listen 0.0.0.0:80`로 수정.

### 경로 추적 & 품질
```bash
sudo traceroute -n 8.8.8.8
mtr -rwzbc 200 8.8.8.8        # 설치 필요: mtr
```
- 특정 홉 이후 손실/지연 → 경계 라우터/업링크 문의 근거 확보.

### HTTP/TLS 애플리케이션
```bash
curl -I https://example.com
curl -v https://example.com --resolve example.com:443:203.0.113.10
openssl s_client -connect example.com:443 -servername example.com < /dev/null
```
- **SNI 미설정**(LB/리버스 프록시) 시 인증서 mismatch → `--resolve`로 IP 직지정 테스트.

### 포트 개방/스캔
```bash
nc -vz example.com 443
sudo nmap -sS -T4 -p 1-1024 192.168.0.10
```
- 외부에서 닫힘 → 호스트 FW·클라우드 SG·NAT 포워딩 순서로 점검.

### 대역폭/지속 트래픽
```bash
iperf3 -s                       # 서버
iperf3 -c server -t 15 -R       # 역방향 테스트
```
- **비정상 저속**: PMTU, shaping, Qdisc, CPU softirq, offload 옵션(ethtool) 점검.

---

## MTU/PMTU/MSS 문제 진단
증상: HTTPS만 느림/끊김, VPN 구간만 실패, ICMP 차단 환경에서 프래그 실패.

```bash
# DF 비트로 PMTU 확인
ping -M do -s 1472 8.8.8.8   # 1500 경로 테스트(IPv4: 20 IP + 8 ICMP = 28 바이트)
ping -M do -s 8972 <peer>    # 점프 MTU(점프스위치/Jumbo)
```

**해결**
- 터널/VPN 장비 MTU 축소: 예) 1500 → 1400
- 서버에서 MSS 클램핑(iptables/nftables)로 SYN 시 MSS 제한.

```bash
# iptables(legacy) 예시: FORWARD에 MSS 클램프
sudo iptables -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN \
  -j TCPMSS --clamp-mss-to-pmtu
```

nftables 버전:
```bash
sudo nft add table ip mangle
sudo nft add chain ip mangle forward { type filter hook forward priority -150 \; }
sudo nft add rule ip mangle forward tcp flags syn tcp option maxseg size set clamp-to-pmtu
```

---

## 패킷 캡처로 확정짓기(tcpdump/tshark)

### 최소 재현 캡처
```bash
sudo tcpdump -i eth0 -w repro.pcap 'host 203.0.113.10 and (port 80 or port 443)'
```

### 커널 드롭/리트랜스 분석
```bash
sudo tcpdump -i eth0 -vvv 'tcp[tcpflags] & (tcp-syn|tcp-fin|tcp-rst) != 0'
tshark -r repro.pcap -z conv,tcp -q
```

### SYN은 오는데 SYN/ACK가 없음?
- **서버 방화벽** 혹은 **리슨 포트 미기동**. `ss -tuln`, `journalctl -u 서비스` 재확인.

### TLS 핸드쉐이크 중단?
- MTU/패킷 분할/중간 장비 DPI 의심 → MSS 클램프/PMTU 테스트.

---

## 연결 상태와 NAT/세션 테이블(conntrack)

```bash
sudo conntrack -L | wc -l
sudo conntrack -S           # 통계
sudo conntrack -L -p tcp --dport 443 | head
```

- 대량 세션 환경: `net.netfilter.nf_conntrack_max` 상향, 해시 버킷 조정.
- 급증/타임아웃 문제: 서비스별 idle timeout 조정(로드밸런서/방화벽/프록시).

---

## 방화벽 실전: UFW / firewalld / nftables

### UFW(간단·Ubuntu 친화)
```bash
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 22/tcp
sudo ufw allow 80,443/tcp
sudo ufw enable
sudo ufw status verbose
sudo ufw delete allow 22/tcp
```
- 특정 대역만 허용:
```bash
sudo ufw allow from 203.0.113.0/24 to any port 22 proto tcp
```
- 로그:
```bash
sudo ufw logging on
```

### firewalld(동적·RHEL/Fedora)
```bash
sudo systemctl enable --now firewalld
sudo firewall-cmd --get-active-zones
sudo firewall-cmd --zone=public --add-service=http --permanent
sudo firewall-cmd --add-port=8443/tcp --permanent
sudo firewall-cmd --reload
sudo firewall-cmd --zone=public --list-all
```
- 소스 대역 전용:
```bash
sudo firewall-cmd --zone=trusted --add-source=10.10.0.0/16 --permanent
sudo firewall-cmd --reload
```

### nftables(현대 리눅스의 기본 백엔드)
**베이스 테이블/체인** 만들기:
```bash
sudo nft add table inet filter
sudo nft add chain inet filter input { type filter hook input priority 0 \; policy drop \; }
sudo nft add chain inet filter forward { type filter hook forward priority 0 \; policy drop \; }
sudo nft add chain inet filter output { type filter hook output priority 0 \; policy accept \; }
```
**기본 허용 규칙**:
```bash
# 루프백, ESTABLISHED/RELATED 허용
sudo nft add rule inet filter input iif lo accept
sudo nft add rule inet filter input ct state established,related accept
# SSH/HTTP/HTTPS 허용
sudo nft add rule inet filter input tcp dport {22,80,443} accept
# ICMP 합리적 허용
sudo nft add rule inet filter input ip protocol icmp accept
sudo nft add rule inet filter input ip6 nexthdr icmpv6 accept
# 로그(속도 제한)
sudo nft add rule inet filter input limit rate 5/second log prefix \"NFT IN: \" flags all counter
```
**저장/영구화**:
```bash
sudo sh -c 'nft list ruleset > /etc/nftables.conf'
sudo systemctl enable --now nftables
```

### DNAT/포트포워딩(예: 80→내부 10.0.0.10)
```bash
sudo nft add table ip nat
sudo nft add chain ip nat prerouting { type nat hook prerouting priority -100 \; }
sudo nft add chain ip nat postrouting { type nat hook postrouting priority 100 \; }
sudo nft add rule ip nat prerouting tcp dport 80 dnat to 10.0.0.10:80
sudo nft add rule ip nat postrouting oif eth0 masquerade
```

---

## iptables(레거시) 빠른 참고
```bash
sudo iptables -P INPUT DROP
sudo iptables -A INPUT -i lo -j ACCEPT
sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
sudo iptables -A INPUT -p tcp -m multiport --dports 22,80,443 -j ACCEPT
sudo iptables -A INPUT -p icmp -j ACCEPT
sudo iptables -A INPUT -m limit --limit 5/second -j LOG --log-prefix "IPT IN: "
```
- 저장(배포판별 도구 상이): `iptables-save > /etc/iptables/rules.v4` 등.

> 현대 커널은 내부적으로 **nftables 백엔드**(iptables-nft)를 사용하기도 한다. 혼용을 피하고 한 체계로 통일하라.

---

## 환경별 주의(클라우드/컨테이너/SELinux)
- **클라우드**: 호스트 방화벽 외에도 **보안그룹(SG)**, **NACL**이 우선 차단할 수 있다. 퍼블릭 LB 뒤라면 **타겟그룹 헬스체크** 상태도 진단.
- **Docker/Podman**: 데몬이 자체 체인(`DOCKER`)을 설치해 NAT/FORWARD 규칙을 바꾼다. 커스텀 FW와 충돌 시 **브리지/포워딩** 정책을 명확히.
- **SELinux/AppArmor**: 네트워크 바인딩/리스닝을 정책이 막을 수 있다. `audit2why`, `semanage port` 등으로 컨텍스트 열람/조정.

---

## 시스템 튜닝(혼잡·지연·대규모 커넥션)
```bash
# /etc/sysctl.d/99-net.conf (예시)
net.core.somaxconn = 4096
net.ipv4.tcp_max_syn_backlog = 4096
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_syncookies = 1
net.ipv4.ip_local_port_range = 1024 65000
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 134217728
net.ipv4.tcp_wmem = 4096 65536 134217728
```
```bash
sudo sysctl --system
```
- 큐가 찬다면 **애플리케이션 레벨**(nginx `worker_connections`, JVM 스레드/큐)도 병행 튜닝.

---

## 케이스 스터디: 단계별 해결

### 케이스 1) 외부에서 `https://서버` 접속 불가
1. `ss -tuln | grep ':443\>'` → 리슨 확인
2. `curl -I https://127.0.0.1 --insecure` → 로컬 OK?
3. `sudo nft list ruleset` / `sudo ufw status` → FW 오픈?
4. 클라우드 SG/NACL/LB TG 헬스체크 확인
5. `tcpdump -i eth0 host <클라이언트IP> and port 443` → SYN/ACK 흐름 확인
6. SNI/서버블록/프록시 설정(nginx `server_name`) 점검

### 케이스 2) 내부는 빠른데 외부는 느림
- `mtr`로 경로 품질 비교(사내 네트워크 출구 혼잡?)
- PMTU/조각화 테스트(`ping -M do -s ...`)
- LB나 CDN 구간의 핸드쉐이크/재전송 확인(tcpdump)

### 케이스 3) 간헐적 타임아웃(웹소켓/롱폴링)
- `conntrack -S`로 드롭/에빅션
- LB idle timeout vs 앱 keepalive 불일치
- 방화벽 state timeout, NAT 게이트웨이 세션당 제한

---

## 실전 스니펫(반복 진단 자동화)

### 서버 개방 상태 종합표
```bash
#!/usr/bin/env bash
echo "[IP/Route]"
ip -br a; echo; ip r; echo
echo "[DNS]"
(getent hosts example.com || true) | sed 's/^/  /'
echo; echo "[LISTEN]"
ss -tuln | awk 'NR==1 || /LISTEN/'; echo
echo "[ESTABLISHED :80/:443]"
ss -ant '( sport = :80 or sport = :443 )' state established | wc -l
```

### 지정 대상 포트 헬스체크
```bash
#!/usr/bin/env bash
host=$1; port=$2
if nc -vz -w 2 "$host" "$port"; then
  echo "OK: $host:$port reachable"
else
  echo "FAIL: $host:$port"
fi
```

---

## 방화벽 정책 설계 가이드(요약)
- **기본 거부(DROP) + 필요한 서비스만 허용**
- **상태 추적**(ESTABLISHED, RELATED) 우선 허용
- 로깅은 **레이트리밋**과 함께(DoS 시 로그폭탄 방지)
- ICMP는 과도 차단 금지(경로 MTU 발견, 오류 통지)
- 관리 포트(SSH)에는 **소스 제한**·키 인증·fail2ban 연계
- 환경 통합: 클라우드 SG / 호스트 FW / 컨테이너 체인 **역할 분담**

---

## 명령어 요약(확장판)

| 범주 | 대표 명령 |
|---|---|
| 링크/주소 | `ip -br a`, `ethtool`, `journalctl -k` |
| 경로/ARP | `ip r`, `ip neigh`, `arp -n` |
| 진단 레이어 | `ping`, `traceroute`, `mtr` |
| 소켓/서비스 | `ss -tulnp`, `lsof -i`, `systemctl status` |
| 앱/HTTP/TLS | `curl -I/-v`, `openssl s_client` |
| 캡처/분석 | `tcpdump`, `tshark`, `wireshark` |
| 스캔/포트 | `nc -vz`, `nmap` |
| 대역폭 | `iperf3` |
| 방화벽(간단) | `ufw` |
| 방화벽(동적) | `firewalld` |
| 방화벽(네이티브) | `nft`, `nftables.conf` |
| NAT/세션 | `conntrack -L/-S` |

---

## 마무리
- **진단은 계층 순서**(링크→라우팅→소켓→FW/NAT→앱)로 진행하면 빠르다.
- 확신이 서지 않을 때는 **패킷 캡처가 정답**이다. 증거로 대화하면 해결 속도가 달라진다.
- 방화벽은 **기본 거부 + 최소 허용 + 상태 추적 + 제한된 로그**가 원칙이며, 환경별(클라우드/컨테이너) 제어면을 이해하고 한 체계로 통일하라.
- MTU/MSS·세션 타임아웃·SNI·split-DNS 같은 **미묘한 원인**이 빈번하므로, 오늘의 체크리스트와 스니펫을 팀 표준에 편입해 재사용하자.
