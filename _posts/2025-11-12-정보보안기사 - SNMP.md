---
layout: post
title: 정보보안기사 - SNMP
date: 2025-11-12 18:25:23 +0900
category: 정보보안기사
---
# SECTION 07 애플리케이션 기본 학습 — 04. SNMP(Simple Network Management Protocol) 완전 정리 (구조·MIB/OID·PDU·v1/v2c/v3 보안·트랩/인폼·NAT/방화벽·리눅스/네트워크장비 설정·도구(snmpwalk/pySNMP/PowerShell)·성능계산·운영/보안 체크리스트)

## 개요 — “장비 상태를 숫자로 말하게 하라”
SNMP는 네트워크 장비·서버·스토리지 등 **관리 대상(Agent)** 의 상태를 중앙 **관리자(Manager/NMS)** 가 표준화된 방법으로 **조회/설정**하고, 이벤트를 **통지(Trap/Inform)** 받는 **애플리케이션 계층 프로토콜**이다.  
핵심 키워드:

- **데이터 모델**: SMIv2, **OID 트리**, MIB 모듈(MIB-2, IF-MIB, HOST-RESOURCES-MIB 등)
- **프로토콜**: UDP/161(쿼리), UDP/162(Trap/Inform), **PDU**(Get/GetNext/GetBulk/Set/Trap/Inform/Report)
- **버전**: v1(레거시), v2c(커뮤니티 문자열), **v3(사용자 기반 보안: authNoPriv/authPriv, VACM)**
- **실무 포인트**: **RO만 허용**, **v3 우선**, **전용 관리망/IP ACL**, **Trap은 선택적, Polling과 병행**, **64bit 카운터 사용**

---

## 1. SNMP 구성요소·데이터 모델

### 1.1 매니저–에이전트–MIB
```
+-------------+      UDP/161              +------------------+
|   Manager   | <-----------------------> |  Agent (Device)  |
| (NMS/툴)    |  Get / GetNext / Bulk /   | Ex: 스위치/서버   |
|             |  Set / (Report,v3)        |                  |
+-------------+                            +------------------+
        ^                                         |
        | Trap/Inform (UDP/162)                   |  MIB 구현
        +-----------------------------------------+
```

- **Manager**: Zabbix, SolarWinds, Prometheus SNMP exporter, net-snmp 툴 등
- **Agent**: 장비 내 SNMP 엔진(네트워크 OS), 또는 리눅스의 `snmpd`

### 1.2 SMIv2·MIB·OID
- **OID**: “.`.”로 구분된 정수 경로. 예) `1.3.6.1.2.1.1.5.0` = `sysName.0`
- **SMIv2 타입**: `INTEGER`, `OCTET STRING`, `OBJECT IDENTIFIER`, `Counter32/64`, `Gauge32`, `TimeTicks`, `IpAddress`, `TruthValue(BOOLEAN)`
- **스칼라 vs 테이블**
  - 스칼라: 끝이 **`.0`** (`sysUpTime.0`)
  - 테이블: `ifTable/ifEntry/ifIndex` 형태. 예) `ifDescr.1`, `ifHCInOctets.5`
- **대표 MIB**
  - **MIB-2(1.3.6.1.2.1)**: `system`, `interfaces`, `ip`, `tcp`, `udp`
  - **IF-MIB**: 인터페이스 테이블·64비트 카운터(`ifHCInOctets`/`ifHCOutOctets`)
  - **HOST-RESOURCES-MIB**: CPU/메모리/프로세스 등(서버)
  - 벤더별 Enterprise MIB: `1.3.6.1.4.1.*`

---

## 2. PDU(프로토콜 데이터 단위)·동작

| PDU | 용도 | 비고 |
|---|---|---|
| **Get** | OID 값 조회 | 단건/복수 |
| **GetNext** | 다음 OID 조회 | Walk의 기본 |
| **GetBulk** | 블록 조회 | v2c/v3 전용, 테이블 빠른 수집 |
| **Set** | OID 값 설정 | 위험: RW 권한 주의 |
| **Trap** | 비동기 알림(무응답) | v1/v2c/v3 |
| **Inform** | **응답 받는 트랩** | 안정성↑, 재전송 |
| **Report** | v3 에러/상태 보고 | 엔진시계/인증오류 등 |

### 2.1 Walk vs Bulk Walk
- **Walk**(GetNext 반복): 느림, 호환성 최고
- **BulkWalk**(GetBulk): 빠름. 파라미터 **non-repeaters, max-repetitions**로 한 번에 다량 조회

---

## 3. 버전·보안

| 항목 | SNMPv1 | SNMPv2c | **SNMPv3** |
|---|---|---|---|
| 인증 | 커뮤니티 문자열 | 커뮤니티 문자열 | **USM 사용자/키**, 또는 TSM(TLS/DTLS) |
| 암호화 | 없음 | 없음 | **authNoPriv / authPriv** |
| 성능 | 낮음 | **GetBulk 지원** | GetBulk 가능 |
| 권고 | 사용지양 | 내부망에서 RO 제한적으로 | **표준 권장** |

### 3.1 v3 구성요소
- **USM(User-based Security Model)**: 사용자 기반 인증/암호화
  - 인증: HMAC-SHA-1/224/256 (제품별 지원상 차이), 과거 MD5 권장X
  - 암호화: **AES-128**(표준), 일부 AES-192/256, 과거 DES는 지양
- **VACM(View-based Access Control Model)**: 뷰/그룹/사용자 매핑으로 **접근 범위 제한**
- **EngineID**: v3 엔진 식별자(클럭/재부팅 카운터 포함)
- **보안 레벨**: `noAuthNoPriv` / **`authNoPriv`** / **`authPriv`**

---

## 4. 트랩(Trap) vs 인폼(Inform)

| 항목 | Trap | **Inform** |
|---|---|---|
| 응답 | 없음(발신 후 끝) | **Manager ACK 필요**(재전송) |
| 신뢰성 | 전송손실 가능 | **더 신뢰성** |
| 부하 | 낮음 | 약간 높음 |
| 용도 | 대량 이벤트 브로드캐스트 | 크리티컬 알림(ACK 중요) |

**중요**: 트랩에는 **Source IP**가 신뢰의 기준. 라우터/방화벽/NAT 환경에서 **원본 IP 고정**·경로 제어.

---

## 5. NAT·방화벽·네트워크 고려

- **폴링(Manager→Agent)**: UDP/161 **인바운드 허용** 필요(Agent가 열어둠)
- **Trap/Inform(Agent→Manager)**: UDP/162 **인바운드 허용** 필요(Manager가 열어둠)
- **ACL/라우팅**: 관리망 분리, SNMP 접근을 **NMS 전용 IP로 제한**
- **대역폭/지연/손실**: SNMP는 UDP. **재시도/타임아웃** 튜닝, 너무 큰 `max-repetitions`는 조심
- **IPv6**: v2c/v3 모두 지원. **EPSV/EPRT 같은 개념 없음**(FTP와 혼동 금지)

---

## 6. 도구 사용(net-snmp)

### 6.1 OID 해석
```bash
# MIB 로드 경로 확인
export MIBS=+ALL
snmptranslate -On sysName.0         # 숫자 OID
snmptranslate -Td IF-MIB::ifHCInOctets
```

### 6.2 v2c 조회/설정
```bash
# sysName 읽기 (v2c, community=monitor)
snmpget -v2c -c monitor 192.0.2.10 sysName.0

# ifTable Walk
snmpwalk -v2c -c monitor 192.0.2.10 IF-MIB::ifTable

# Bulk Walk(빠름)
snmpbulkwalk -v2c -c monitor -Cr50 -Cn0 192.0.2.10 IF-MIB::ifXTable

# Set (위험: 신중!)
snmpset -v2c -c adminRW 192.0.2.10 sysLocation.0 s "DC-Seoul"
```

### 6.3 v3 조회(authPriv)
```bash
# 사용자/usm: u-op, auth: SHA, priv: AES
snmpget -v3 -u u-op -l authPriv -a SHA -A 'authpass!!' -x AES -X 'privpass!!' 192.0.2.10 sysUpTime.0

# v3 Bulk Walk
snmpbulkwalk -v3 -u u-op -l authPriv -a SHA -A 'authpass!!' -x AES -X 'privpass!!' 192.0.2.10 IF-MIB::ifXTable
```

### 6.4 Trap 수신(snmptrapd)
```bash
# /etc/snmp/snmptrapd.conf
authCommunity log,execute,net monitor
format1 %A [%b %d %H:%M:%S] %N - %w\n
```
```bash
systemctl enable --now snmptrapd
# 테스트 트랩 송신
snmptrap -v2c -c monitor 198.51.100.5 '' .1.3.6.1.6.3.1.1.5.3
```

---

## 7. 리눅스 에이전트 설정(net-snmp: snmpd)

### 7.1 최소 RO(v2c) + v3(authPriv) 동시 운용 예
```conf
# /etc/snmp/snmpd.conf (주요 부분만)
agentAddress udp:161

# v2c: RO만 (내부 NMS만 접근)
rocommunity monitor 10.10.10.0/24

# v3 사용자 생성(엔진 로컬): 처음엔 createUser, 그 후 rouser
#   createUser는 일반적으로 /var/lib/net-snmp/snmpd.conf에 보관됨
# 아래는 운용시에는 주석처리/삭제(한번만 실행 후)
# createUser u-op SHA "authpass!!" AES "privpass!!"

rouser u-op authPriv

# VACM View: system + 인터페이스만 노출 (예시)
view vSystem  included .1.3.6.1.2.1.1
view vIf      included .1.3.6.1.2.1.2
view vIfX     included .1.3.6.1.2.1.31
rouser u-op authPriv -V vSystem -V vIf -V vIfX

sysLocation DC-Seoul
sysContact  noc@example.com

# 확장: 외부 스크립트 노출(주의)
# extend .1.3.6.1.4.1.8072.1.3.2 temp /usr/local/bin/read_temp.sh
```
```bash
systemctl enable --now snmpd
ss -lunp | grep :161
```

---

## 8. 네트워크 장비 예시 설정

### 8.1 Cisco IOS-XE (예시)
```cisco
! v2c: RO 커뮤니티 + 접근제한
ip access-list standard SNMP-MANAGERS
  permit 10.10.10.10
  permit 10.10.10.11
snmp-server community monitor RO SNMP-MANAGERS

! v3: user/group/view
snmp-server view V-BASE iso included
snmp-server group G-RO v3 priv read V-BASE
snmp-server user U-RO G-RO v3 auth sha AUTHp@ss priv aes 128 PRIVp@ss

! Trap 전송
snmp-server host 10.10.10.20 version 3 priv U-RO
snmp-server enable traps snmp linkdown linkup coldstart warmstart
```

### 8.2 Juniper JunOS (예시)
```juniper
set snmp community monitor authorization read-only clients 10.10.10.0/24
set snmp view V-BASE oid .1 include
set snmp v3 usm local-engine user u-op authentication-sha authentication-key "authpass!!"
set snmp v3 usm local-engine user u-op privacy-aes128 privacy-key "privpass!!"
set snmp v3 vacm security-to-group security-model usm security-name u-op group G-RO
set snmp v3 vacm access group G-RO default-context-prefix security-model usm security-level privacy read-view V-BASE
set snmp trap-group NMS targets 10.10.10.20 categories link
```

---

## 9. Python(pySNMP) 실습

### 9.1 v3 GetBulk로 인터페이스 Octets 수집
```python
# pip install pysnmp
from pysnmp.hlapi import *
TARGET = '192.0.2.10'
USER = UsmUserData('u-op', authKey='authpass!!', privKey='privpass!!', authProtocol=usmHMACSHAAuthProtocol, privProtocol=usmAesCfb128Protocol)

it = bulkCmd(
    SnmpEngine(),
    USER,
    UdpTransportTarget((TARGET, 161), timeout=1, retries=2),
    ContextData(),
    0, 50,  # nonRepeaters=0, maxRepetitions=50
    ObjectType(ObjectIdentity('IF-MIB', 'ifName')),
    ObjectType(ObjectIdentity('IF-MIB', 'ifHCInOctets')),
    ObjectType(ObjectIdentity('IF-MIB', 'ifHCOutOctets'))
)

for (errInd, errStat, errIdx, varBinds) in it:
    if errInd:
        print("Error:", errInd); break
    elif errStat:
        print('%s at %s' % (errStat.prettyPrint(), errIdx and varBinds[int(errIdx)-1][0] or '?')); break
    else:
        for oid, val in varBinds:
            print(oid.prettyPrint(), val.prettyPrint())
```

### 9.2 64비트 카운터로 **링크 사용률 계산**
링크 속도 \(S\) (bps), 두 시점의 카운터 차이 \(\Delta\) 와 시간 \(\Delta t\)로 **평균 비트레이트**:
$$
\text{bps} = \frac{8 \times \Delta\text{Octets}}{\Delta t}, \qquad
\text{Util}(\%) = \frac{\text{bps}}{S} \times 100
$$

```python
import time
from pysnmp.hlapi import *

def get_counter(oid):
    g = getCmd(SnmpEngine(), USER, UdpTransportTarget((TARGET,161)), ContextData(),
               ObjectType(ObjectIdentity(oid)))
    errInd, errStat, errIdx, varBinds = next(g)
    if errInd or errStat: raise RuntimeError(errInd or errStat.prettyPrint())
    return int(varBinds[0][1])

IFX_IN = 'IF-MIB::ifHCInOctets.5'
IFX_OUT= 'IF-MIB::ifHCOutOctets.5'
IF_SPEED = 1000000000  # 1 Gbps

c1_in, c1_out, t1 = get_counter(IFX_IN), get_counter(IFX_OUT), time.time()
time.sleep(5)
c2_in, c2_out, t2 = get_counter(IFX_IN), get_counter(IFX_OUT), time.time()
dt = t2 - t1
bps_in  = 8*( (c2_in - c1_in) & ((1<<64)-1) ) / dt
bps_out = 8*( (c2_out - c1_out) & ((1<<64)-1) ) / dt
util_in  = bps_in  / IF_SPEED * 100
util_out = bps_out / IF_SPEED * 100
print(f"in={bps_in:.0f}bps({util_in:.2f}%), out={bps_out:.0f}bps({util_out:.2f}%)")
```
> 주의: **Counter wrap**·장비 리셋 시 불연속성. 가능하면 **ifHC\*** + `ifCounterDiscontinuityTime` 참고.

---

## 10. PowerShell 예시(Windows에서 폴링 스크립트)

```powershell
# Windows에는 기본 SNMP 모듈이 빈약. 외부 라이브러리(SharpSnmpLib) 사용 권장.
# 아래는 간단한 snmpwalk.exe 호출 예 (툴 설치 가정)
$host = "192.0.2.10"
$community = "monitor"
& snmpwalk -v2c -c $community $host IF-MIB::ifXTable
```

---

## 11. 트랩 운영(snmptrapd → Syslog/SIEM 연계)

```conf
# /etc/snmp/snmptrapd.conf
disableAuthorization yes
# v2c: monitor 커뮤니티만
authCommunity execute monitor
# 포맷 커스터마이즈
format1 %A %B %Y %H:%M:%S %N %P %v\n
# 특정 OID 매칭 시 스크립트 실행(예: 링크다운)
traphandle IF-MIB::linkDown /usr/local/bin/on_linkdown.sh
```
```bash
# 링크다운 가상 테스트(장비에서 실제로 발생시키기 어려우면 snmptrap 사용)
snmptrap -v2c -c monitor 127.0.0.1 '' IF-MIB::linkDown \
  ifIndex i 5 ifDescr s "ge-0/0/5" ifAdminStatus i 1 ifOperStatus i 2
```

---

## 12. 성능·스케일링 팁

- **Bulk 파라미터**: `-Cr<max-repetitions>`(예: 50~100)로 왕복 감소. 장비/경로 MTU 고려.
- **폴링 주기**: 인터페이스 트래픽은 30~60초, 시스템 리소스는 1~5분.
- **샤딩**: 대상 장비를 여러 폴러로 분산. NMS HA/수평확장.
- **Trap Storm**: 이벤트 폭주 시 드롭. **Rate limit/덜 중요한 트랩 비활성**.

---

## 13. 보안 베스트 프랙티스

1. **가능한 v3(authPriv) 사용**, v1/v2c는 **내부 망 RO** 한정.
2. **RW 권한 금지**(정말 필요한 경우만, IP ACL·뷰로 최소화).
3. **관리망/Out-of-band**: SNMP 접근은 전용망/전용 VRF.
4. **방화벽/ACL**: UDP/161,162를 **NMS IP로 제한**.
5. **커뮤니티 문자열 난이도↑**, 기본값(`public/private`) 금지.
6. **VACM 뷰**로 노출 범위 제한(MIB 전체 공개 금지).
7. **엔진/에이전트 업데이트**, 취약 스위트(DES/MD5) 제거.
8. **트랩 소스IP 고정**, **NTP 동기화**(이벤트 타임라인 정확도).
9. **로그/감사/SIEM** 연계, 실패/인증오류 모니터링.
10. **문서화**: OID맵·폴링주기·임계치·트랩 규칙·장비별 특이점.

---

## 14. 운영 체크리스트(현장용)

- [ ] v3 **authPriv** 사용자/키 수명/교체 주기 정의
- [ ] v2c는 **RO + ACL 제한**만 허용
- [ ] **IF-MIB 64bit** 카운터 사용(`ifHC*`)
- [ ] 장비/서버 **SNMP CPU/메모리/온도** MIB 매핑 검증
- [ ] **BulkWalk 파라미터** 튜닝(장비별 최적값 기록)
- [ ] **Trap 목록/중요도** 정의, 불필요 트랩 비활성
- [ ] **snmptrapd 포맷** 표준화, SIEM 파서 검증
- [ ] 장비 **sysName/sysLocation/sysContact** 표준
- [ ] **엔진ID/시간** 정상(Report 없을 것)
- [ ] 백업/DR: NMS 폴링 상태·Trap 경로 **이중화**

---

## 15. 표/그림 요약

### 15.1 버전/보안 비교
| 항목 | v1 | v2c | **v3** |
|---|---|---|---|
| 인증 | 커뮤니티 | 커뮤니티 | **USM/TSM** |
| 암호화 | 없음 | 없음 | **AES(권장)** |
| 성능 | 낮음 | **GetBulk 지원** | 중 |
| 권장 | 지양 | 내부 RO 한정 | **표준** |

### 15.2 인터페이스 트래픽 계산 흐름(ASCII)
```
t0: read ifHCInOctets.X -> C0
t1: read ifHCInOctets.X -> C1
ΔC = (C1 - C0) mod 2^64
Δt = t1 - t0
bps = (ΔC * 8) / Δt
util% = bps / ifSpeed.X * 100
```

---

## 16. 심화: VACM 개념(간단)

- **view**: OID 서브트리 포함/제외 규칙
- **group**: 보안모델/사용자 → 그룹 매핑
- **access**: 그룹별 컨텍스트/보안레벨/읽기/쓰기/알림 권한
- **매핑** 예: `user u-op` → `group G-RO` → `access G-RO authPriv read vBase`

---

## 17. 실습 시나리오(따라하기)

### A. 리눅스 snmpd(v3) + net-snmp 도구
1) `snmpd` 설치 → `/etc/snmp/snmpd.conf` 편집(위 예시)  
2) `createUser` 1회 수행 → `rouser`로 전환  
3) `snmpbulkwalk -v3 ... IF-MIB::ifXTable` 결과 확인

### B. Cisco 스위치 링크 변동 트랩
1) `snmp-server enable traps snmp linkdown linkup`  
2) `snmp-server host <NMS-IP> version 3 priv U-RO`  
3) 포트 flap 후 `snmptrapd` 수신 로그 확인

### C. Python으로 5초 평균 트래픽 계산
1) `pySNMP` 코드 실행  
2) `bps`/`util%` 출력 → 대역폭 초과 시 알림 로직 추가

---

## 18. 자주 나오는 실수·함정

- **ifInOctets(32bit)**를 10G 링크에 사용 → **랩/롤오버**로 엉터리 값
- v3 사용자 만들고 `rouser` 누락 → `usmStatsUnknownUserNames` Report
- 트랩만 믿음 → **폴링** 병행 안 해서 누락
- 방화벽에서 161/162 방향 반대로 열기
- `public` 커뮤니티 그대로 운용
- `snmpwalk` 결과 파서에 `LIST` 형식 의존 → **MLST/표준화** 권장

---

## 19. 실기형 미니문제

1) **문제**: NMS가 v3 `authPriv`로 `ifHCOutOctets.10`을 15초 간격으로 수집한다. 15초 동안 카운터 증가가 `3,000,000` 옥텟이었다. 링크 속도 1Gbps일 때 출력 사용률(%)은?  
   **풀이**:  
   $$\text{bps} = \frac{8 \times 3{,}000{,}000}{15} = 1.6\ \text{Mbps}$$  
   $$\text{Util} = \frac{1.6\ \text{Mbps}}{1000\ \text{Mbps}} \times 100 \approx 0.16\%$$

2) **문제**: SNMPv3에서 인증은 하고 암호화는 하지 않는 보안 레벨은?  
   **답**: `authNoPriv`.

3) **문제**: `snmpbulkwalk -Cr50 -Cn0`의 의미는?  
   **답**: `max-repetitions=50`, `non-repeaters=0`으로 테이블을 한 번에 최대 50행씩 가져옴.

4) **문제**: Trap과 Inform의 차이 2가지?  
   **답**: 응답 유무(Inform은 ACK 필요), 재전송(Inform은 재시도)/신뢰성 차이.

5) **문제**: v2c를 계속 써야 한다면 필수 보안 조치는?  
   **답**: **RO만**, **강한 커뮤니티 문자열**, **NMS IP ACL 제한**, **관리망 분리**, **외부 차단**.

---

## 20. 요약
- **SNMP는 “표준화된 상태·성능 관찰어”**다. MIB/OID·PDU·버전별 보안을 이해해야 실전 운영이 수월하다.  
- **v3(authPriv) + VACM + 관리망/ACL**이 현대 운영의 기본. v2c는 내부 RO 제한에서만.  
- 성능 수집은 **64비트 카운터 + Bulk**로, 이벤트는 **Trap/Inform**을 가볍게·정확히.  
- 본 문서의 **리눅스/네트워크장비 설정, net-snmp/pySNMP 실습, 수식/스크립트**로 즉시 **모니터링/알림 체계**를 구축할 수 있다.