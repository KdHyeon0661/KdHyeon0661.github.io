---
layout: post
title: 논리회로설계 - 래치와 플립플롭
date: 2025-09-03 23:25:23 +0900
category: 논리회로설계
---
# 래치와 플립플롭 — **S–R 래치**, **게이티드 D 래치**, **에지-트리거 D 플립플롭**, **S–R 플립플롭**

## 0. 큰 그림 — 래치 vs 플립플롭

| 구분 | 민감도 | 동작 요약 | 장점 | 주의점/리스크 |
|---|---|---|---|---|
| **래치(latch)** | **레벨** | Enable(또는 CLK의 특정 레벨) 동안 **투명(transparent)**, 나머지 시간 **유지(hold)** | **타임 보로잉(time borrowing)** 가능, 지연 완화 | 투명 창(window) 동안 **글리치 전파**, 의도치 않은 **래치 인퍼런스** 위험 |
| **플립플롭(FF)** | **에지** | **상승/하강 에지**에서만 샘플 | 동기 설계 안전, STA 용이 | **셋업/홀드 위반 → 메타안정성**, CDC 처리 필요 |

최대 동작 주파수 근사:
$$
f_{\max}\approx\frac{1}{t_{\text{CQ}}+t_{\text{comb}}+t_{\text{setup}}+t_{\text{skew}}+t_{\text{jitter}}}
$$

---

## 1. **S–R 래치(Set–Reset Latch)**

### 1.1 NOR형(활성 High \(S,R\)) — 교차결합 NOR

- 구조: 두 NOR의 **상호 피드백**. 입력 \(S\)가 1이면 **Set( \(Q\!\leftarrow\!1\) )**, \(R\)이 1이면 **Reset( \(Q\!\leftarrow\!0\) )**.
- 진리표(이전 상태 \(Q_{prev}\)):

| S | R | \(Q_{next}\) | 설명 |
|:-:|:-:|:--:|:--|
| 0 | 0 | \(Q_{prev}\) | 유지 |
| 1 | 0 | 1 | Set |
| 0 | 1 | 0 | Reset |
| 1 | 1 | **금지** | (두 출력이 일시 0 → 해제 순서에 따라 불확정) |

- 간단 등가모델(직관):
  \(Q = \overline{R + \overline{S + \overline{Q}}}\) (피드백 형태이므로 **동시식**보다는 **상태표**로 이해)

**게이트 수준 스케치(텍스트)**
```
S ──┐        ┌── Q
    │  ┌──┐  │
    └──┤NOR├─┘
       └──┘
        ▲
        │ 피드백
        │
       ┌──┐
R ─────┤NOR├── Q' (= \overline{Q})
       └──┘
```

### 1.2 NAND형(활성 Low \(\overline{S},\overline{R}\)) — 교차결합 NAND

| \(\overline{S}\) | \(\overline{R}\) | \(Q_{next}\) |
|:-:|:-:|:--:|
| 1 | 1 | \(Q_{prev}\) |
| 0 | 1 | 1 (Set) |
| 1 | 0 | 0 (Reset) |
| 0 | 0 | **금지** |

> **NOR형**과 **NAND형**은 **활성 레벨**만 다르고 **기능은 쌍대**.

### 1.3 특성/주의
- \(S=R=1\) (NOR형) 또는 \(\overline{S}=\overline{R}=0\) (NAND형)은 **금지**. 해제 순서에 따라 **메타안정** 가능.
- 입력 글리치에 민감. **비동기 제어**(간단 펄스/초기화)에서만 제한적으로 사용 권장.

### 1.4 HDL(합성 가능) 모델

#### VHDL — 활성 High S,R (금지시 ‘X’)
```vhdl
entity sr_latch is
  port (S, R: in  std_logic; Q: out std_logic);
end;
architecture rtl of sr_latch is
  signal q_i: std_logic := '0';
begin
  process(all) is
  begin
    if    (S='1' and R='0') then q_i <= '1';
    elsif (S='0' and R='1') then q_i <= '0';
    elsif (S='0' and R='0') then q_i <= q_i; -- hold
    else                           q_i <= 'X'; -- 금지
    end if;
  end process;
  Q <= q_i;
end;
```

#### Verilog — 활성 High S,R (행동 모델)
```verilog
module sr_latch(input S, R, output Q);
  reg q;
  assign Q = q;
  always @* begin
    case ({S,R})
      2'b10: q = 1'b1;
      2'b01: q = 1'b0;
      2'b00: q = q;     // hold
      default: q = 1'bx; // 금지
    endcase
  end
endmodule
```

---

## 2. **게이티드 D 래치(Gated D Latch)**

### 2.1 아이디어 (SR 금지 제거)
- \( S = \text{EN}\cdot D,\quad R = \text{EN}\cdot \overline{D}\)
  → **EN=1**일 때만 S/R 경로가 열리고, 동시에 1이 될 수 없음.
- 동작:
  - **EN=1(투명)**: \(Q\leftarrow D\)
  - **EN=0(잠금)**: \(Q\) 유지

### 2.2 진리표(요약)

| EN | D | \(Q_{next}\) |
|:-:|:-:|:--:|
| 0 | X | \(Q\) |
| 1 | 0 | 0 |
| 1 | 1 | 1 |

### 2.3 HDL

#### VHDL — 의도적 래치 합성
```vhdl
entity d_latch is
  port (D, EN: in  std_logic; Q: out std_logic);
end;
architecture rtl of d_latch is
  signal q_i: std_logic := '0';
begin
  process(all) is
  begin
    if EN='1' then
      q_i <= D;         -- 투명
    else
      q_i <= q_i;       -- 유지 (래치 인퍼런스)
    end if;
  end process;
  Q <= q_i;
end;
```

#### Verilog — always_latch 권장
```verilog
module d_latch(input D, EN, output Q);
  reg q;
  assign Q = q;
  always @* begin : always_latch
    if (EN) q = D;
    else    q = q; // hold
  end
endmodule
```

### 2.4 게이트 구현(개념)
- NOR형 SR 래치 앞단에 **AND** 2개로 \(S=\text{EN}\cdot D\), \(R=\text{EN}\cdot \overline{D}\) 생성.
- NAND형은 **활성 Low**로 대칭 구성 가능.

### 2.5 타임 보로잉(Time Borrowing) 메모
- **두 단계 래치 파이프라인**(비중첩 \(\phi_1,\phi_2\))에서 느린 1단 조합 지연을 **다음 래치의 투명 구간 일부**로 **차용** 가능.
- 이상적 차용량 근사:
  $$
  t_{\text{borrow}}\lesssim t_{\phi_2\text{(투명)}}-\text{마진}
  $$
- 장점은 크지만, **클록 위상/겹침/펄스폭** 관리가 어렵고 **STA 제약**이 복잡해 **대부분의 ASIC/FPGA는 에지 FF**를 기본으로 사용.

---

## 3. **에지-트리거 D 플립플롭(Edge-Triggered D FF)**

### 3.1 마스터–슬레이브(래치 2개 직렬)
- **양(+)에지 FF**:
  - 마스터: **CLK=0**에서 투명, **CLK=1**에서 잠금
  - 슬레이브: **CLK=1**에서 투명, **CLK=0**에서 잠금
  → **상승 에지 직후** 마스터가 닫히며 D를 캡처, 슬레이브가 열려 Q로 전달.

### 3.2 타이밍 파라미터

| 기호 | 의미 |
|---|---|
| \(t_{su}\) | 셋업: 에지 **이전** 안정 필요 시간 |
| \(t_h\) | 홀드: 에지 **이후** 유지 필요 시간 |
| \(t_{CQ}\) | 클록→Q 지연 |
| \(t_w^{H/L}\) | 클록 High/Low **최소 펄스폭** |
| \(t_{rec},t_{rem}\) | (비동기) **복구/제거** 시간 |

### 3.3 메타안정성(Metastability)

- \(t_{su}/t_h\) 위반이나 **CDC**(클록 도메인 교차)에서 발생 → 내부 노드가 중간 전압으로 **불확정 시간** 머물다 수렴.
- MTBF 근사(개념):
$$
\mathrm{MTBF}\approx \frac{1}{f_{\text{clk}} f_{\text{data}}}\,C\,e^{\frac{T - T_0}{\tau}}
$$
- **대응**: 비동기/타 도메인 입력은 **2단 이상 동기화 FF**(synchronizer) 사용.

#### Verilog — 2단 동기화기
```verilog
module sync_2ff #(parameter INIT=1'b0)(
  input  clk, rst_n,
  input  async_in,
  output sync_out
);
  reg s1, s2;
  always @(posedge clk or negedge rst_n) begin
    if (!rst_n) begin s1 <= INIT; s2 <= INIT; end
    else begin s1 <= async_in; s2 <= s1; end
  end
  assign sync_out = s2;
endmodule
```

### 3.4 DFF(비동기 리셋) — VHDL
```vhdl
entity dff_async is
  port (clk, rst_n: in std_logic; D: in std_logic; Q: out std_logic);
end;
architecture rtl of dff_async is
  signal q_i: std_logic := '0';
begin
  process(clk, rst_n) is
  begin
    if rst_n='0' then
      q_i <= '0';                    -- 비동기 Reset 적용
    elsif rising_edge(clk) then
      q_i <= D;                      -- 에지 샘플
    end if;
  end process;
  Q <= q_i;
end;
```

> **리셋 해제는 동기**가 바람직: 별도 **리셋 동기화기**를 통해 해제 타이밍을 통일.

---

## 4. **S–R 플립플롭(Synchronous SR FF)**

### 4.1 동기식 정의
- \(S,R\)를 **클록 에지에서만** 샘플 → 에지 순간에 Set/Reset/유지 결정.
- \(S=R=1\)은 **금지**(혹은 우선순위 규정 필요).

### 4.2 진리표(양(+)에지 기준, 활성 High)

| S | R | \(Q_{next}\) | 비고 |
|:-:|:-:|:--:|:--|
| 0 | 0 | \(Q\) | Hold |
| 1 | 0 | 1 | Set |
| 0 | 1 | 0 | Reset |
| 1 | 1 | **금지** | 또는 우선순위 규칙 필요 |

### 4.3 D FF + 로직으로 구현
- 금지 상태를 피하며 동작 등가:
$$
D = S + \overline{R}\cdot Q
$$
- HDL (VHDL):
```vhdl
entity sr_ff_sync is
  port (clk: in std_logic; S,R: in std_logic; Q: out std_logic);
end;
architecture rtl of sr_ff_sync is
  signal q_i: std_logic := '0';
begin
  process(clk) is
  begin
    if rising_edge(clk) then
      if    (S='1' and R='0') then q_i <= '1';
      elsif (S='0' and R='1') then q_i <= '0';
      elsif (S='0' and R='0') then q_i <= q_i;
      else                         q_i <= 'X'; -- 금지
      end if;
    end if;
  end process;
  Q <= q_i;
end;
```

---

## 5. 타이밍/파형으로 이해

### 5.1 게이티드 D 래치 (EN=1 투명)
```
EN: ────████████───────████──────
D : ──0───1110─0───────1───0─────
Q : ──0───1110─0───────0───0─────   ← EN=1 기간에 D가 그대로 통과
```

### 5.2 에지-트리거 D FF (↑에지)
```
CLK: _/‾\_/‾\_/‾\_/‾\_/‾\_
D  : 0──1──0────1────0────
Q  : 0───1────0────1────0  ← 상승 에지 직후에만 갱신
```

---

## 6. 구현·합성·검증 — 실전 팁

### 6.1 래치 인퍼런스 방지(조합 블록)
- **조합 프로세스**에서 **불완전 할당** → **래치 합성**.
- 방지: `process(all)` + 모든 분기에서 **완전 할당**(기본값 포함).

### 6.2 클록 게이팅(AND 금지 → ICG 사용)
- 단순 `gclk = clk & en;` 은 **글리치** 유발.
- **ICG 셀(내부 래치 포함)** 또는 **래치+AND** 방식 사용:
```verilog
// 글리치 없는 게이팅(개념)
always @(*) if (!clk) en_l <= en; // clk=0 동안만 래치가 en 샘플
assign gclk = clk & en_l;
```

### 6.3 리셋 설계
- **적용**은 비동기 가능, **해제**는 **동기화**.
- **복구/제거 시간**(\(t_{rec},t_{rem}\)) 위반 금지.

### 6.4 CDC(클록 도메인 교차)
- 단일 비트: **2FF 동기화기**.
- 버스/토글/펄스: **핸드셰이크** 또는 **Gray 코드 카운터**.

### 6.5 STA 체크(요지)
- **Setup**: \(t_{CQ}+t_{\text{comb}}+t_{\text{skew}} \le T_{\text{clk}} - t_{su}\)
- **Hold**: \(t_{\text{min comb}} + t_{\text{skew(min)}} \ge t_h\)

---

## 7. 게이트 수준 예제 모음

### 7.1 D 래치 — 게이트 구성(NOR형)
```verilog
module d_latch_gate(input D, EN, output Q);
  wire S = EN & D;
  wire R = EN & ~D;
  wire nQ;
  nor (Q,  R, nQ);
  nor (nQ, S, Q );
endmodule
```

### 7.2 마스터–슬레이브 D FF (개념 RTL)
```verilog
module dff_ms(input CLK, D, output Q);
  wire qm;  // master output
  // master: transparent when CLK=0 (use EN = ~CLK)
  d_latch u_m (.D(D), .EN(~CLK), .Q(qm));
  // slave: transparent when CLK=1 (EN = CLK)
  d_latch u_s (.D(qm), .EN(CLK),  .Q(Q));
endmodule
```

### 7.3 DFF with Enable (합성 우호적 MUX 스타일)
```verilog
module dff_en(input clk, rst_n, en, input D, output Q);
  reg q;
  assign Q = q;
  always @(posedge clk or negedge rst_n) begin
    if (!rst_n) q <= 1'b0;
    else if (en) q <= D;           // MUX로 인식
  end
endmodule
```

---

## 8. 테스트·검증 코드 스니펫

### 8.1 래치의 글리치 전파 관찰(Testbench)
```verilog
module tb_latch;
  reg D=0, EN=0; wire Q;
  d_latch uut(.D(D), .EN(EN), .Q(Q));
  initial begin
    #5 EN=1; #3 D=1; #1 D=0; #1 D=1; // EN=1 동안 D 글리치 발생
    #5 EN=0; #4 D=0;                 // 잠금 구간에선 Q 유지
    #10 $finish;
  end
endmodule
```

### 8.2 DFF 셋업/홀드 위반 시뮬(개념)
```verilog
module tb_dff;
  reg clk=0, rst_n=0, D=0; wire Q;
  dff_async dut(.clk(clk), .rst_n(rst_n), .D(D), .Q(Q));
  always #5 clk = ~clk;
  initial begin
    #2  rst_n=1;
    #6  D=1;     // 에지 직전 바뀌어 셋업 위반 가능
    #11 D=0;     // 에지 직후 즉시 바꿔 홀드 위반 가능
    #100 $finish;
  end
endmodule
```

### 8.3 간단 SVA(설계 규율용) — 금지 상태 방지
```verilog
// SR FF 동기식: S and R not both 1 at posedge
property p_no_forbidden;
  @(posedge clk) !(S && R);
endproperty
assert property (p_no_forbidden);
```

---

## 9. 표/정의 모음 — 빠른 참조

### 9.1 래치/플립플롭 요약

| 소자 | 입력 | 제어 | 민감도 | 금지 | 전형 용도 |
|---|---|---|---|---|---|
| **S–R 래치** | S,R | - | 레벨 | 있음 | 간단 비동기 저장 |
| **D 래치** | D | EN | 레벨 | 없음 | 타임 보로잉, 게이팅 |
| **D FF** | D | CLK | **에지** | 없음 | 파이프라인, 동기 설계 |
| **S–R FF** | S,R | CLK | **에지** | 구현에 따라 | 이벤트 래칭(규칙 필요) |

### 9.2 타이밍 파라미터

| 파라미터 | 설명 |
|---|---|
| \(t_{su}\) | 에지 **이전** 데이터 안정 |
| \(t_h\) | 에지 **이후** 데이터 유지 |
| \(t_{CQ}\) | 클록→Q 지연 |
| \(t_w^{H/L}\) | 클록 최소 High/Low 폭 |
| \(t_{rec}/t_{rem}\) | 비동기 복구/제거 시간 |

---

## 10. 연습문제 (원하면 해설 추가 제공)

1) **NOR형 S–R 래치**의 금지 상태를 **파형**으로 설명하고, 해제 순서에 따라 결과가 달라지는 이유(관성 지연, 이력)를 기술하라.
2) **게이티드 D 래치**를 **NAND형 활성 Low**로 설계하라. \( \overline{S}=\overline{\text{EN}\cdot D}\), \( \overline{R}=\overline{\text{EN}\cdot \overline{D}} \) 관계를 회로로 그려라.
3) **마스터–슬레이브 D FF**에서 **펄스폭 제약** \(t_w^{H/L}\)이 왜 필요한지 설명하고, 너무 짧을 때의 고장을 파형으로 예시하라.
4) **동기 S–R FF**를 **D FF+로직**으로 합성하라. \(D=S+\overline{R}\cdot Q\) 가 S/R/금지 상태를 어떻게 반영하는지 진리표로 검증하라.
5) **CDC 입력**에 2FF 동기화기를 적용했을 때, 데이터 토글 빈도와 클록 주파수에 대한 **MTBF** 추세를 설명하라(지수 의존).
6) **ICG 없는 단순 클록 게이팅**의 글리치 발생 원인을 설명하고, **래치 기반** 게이팅 원리를 타이밍 관점에서 서술하라.

---

## 11. 포켓 요약

- **래치**: 레벨 투명. **EN=1** 동안 글리치 전파 주의. **타임 보로잉** 장점.
- **D FF**: 에지 샘플. **셋업/홀드**와 **MTBF** 관리 필수.
- **S–R**: 금지 상태 존재 → **D 래치/FF**로 변환해 안전화.
- **합성 습관**: 불완전 할당 금지(래치 인퍼런스 방지), **ICG**로 게이팅, 리셋 **동기 해제**, CDC는 **2FF** 이상.
