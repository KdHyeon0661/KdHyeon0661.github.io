---
layout: post
title: AWS - EC2
date: 2025-07-12 20:20:23 +0900
category: AWS
---
# EC2: AWSì˜ ê°€ìƒ ì„œë²„ ê°œë…ê³¼ í•µì‹¬ êµ¬ì„± ìš”ì†Œ

## í•œëˆˆì— ë³´ëŠ” ë¡œë“œë§µ

1. EC2 ê°œìš”, ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤
2. ì¸ìŠ¤í„´ìŠ¤ **íƒ€ì…/ê³„ì—´/ì„¸ëŒ€**ì™€ ì„ íƒ ê°€ì´ë“œ
3. **AMI**(ë¨¸ì‹  ì´ë¯¸ì§€)ì™€ **User Data**(ë¶€íŒ… ìŠ¤í¬ë¦½íŠ¸)
4. **í‚¤ í˜ì–´**ì™€ ì•ˆì „í•œ ì ‘ì†(SSH vs **SSM Session Manager**)
5. **ìŠ¤í† ë¦¬ì§€**: EBS(gp3/io2/st1), ì¸ìŠ¤í„´ìŠ¤ ìŠ¤í† ì–´, ìŠ¤ëƒ…ìƒ·/ì•”í˜¸í™”
6. **ë„¤íŠ¸ì›Œí‚¹**: ENI/ë³´ì•ˆê·¸ë£¹/NACL/Placement Group/EIP/IMDSv2
7. **ìˆ˜ëª…ì£¼ê¸°**: Launch Template/Auto Scaling/í—¬ìŠ¤ì²´í¬/ë³µêµ¬
8. **ë¹„ìš© ìµœì í™”**: ì˜¨ë””ë§¨ë“œ/ìŠ¤íŒŸ/ì˜ˆì•½/Savings Plans/í¬ê¸°ì¡°ì •
9. **ìš´ì˜**: CloudWatch/X-Ray/CloudTrail/íŒ¨ì¹˜/ë°±ì—…/DR
10. **IaC**: CloudFormation/Terraform/CDK ìŠ¤ë‹ˆí« ëª¨ìŒ
11. ì²´í¬ë¦¬ìŠ¤íŠ¸, í”í•œ í•¨ì •, ì‹¤ìŠµ ë ˆì‹œí”¼

---

## 1ï¸âƒ£ EC2ë€ ë¬´ì—‡ì¸ê°€?

**EC2 (Elastic Compute Cloud)**ëŠ” AWSì˜ **ê°€ìƒ ì„œë²„(Compute) ì„œë¹„ìŠ¤**ë‹¤.
ë¬¼ë¦¬ ì¥ë¹„ ì—†ì´ í´ë¦­/ëª…ë ¹ ëª‡ ë²ˆìœ¼ë¡œ **CPU/ë©”ëª¨ë¦¬/ë””ìŠ¤í¬/ë„¤íŠ¸ì›Œí¬** ì‚¬ì–‘ì„ ê°€ì§„ ì„œë²„ë¥¼ ì‹ ì†í•˜ê²Œ ìƒì„±Â·í™•ì¥Â·íê¸°í•  ìˆ˜ ìˆë‹¤.

### ëŒ€í‘œ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

- **ì›¹/ë°±ì—”ë“œ**: Nginx/Apache, Node.js, Spring, Django, FastAPI
- **ë°°ì¹˜/ETL/ë°ì´í„° ì²˜ë¦¬**: Spark, Dask, Airflow ì›Œì»¤
- **ê³ ì„±ëŠ¥ ì»´í“¨íŒ…(HPC)**: C/C++/Fortran, CFD/FEA, MPI
- **GPU ì¶”ë¡ /í•™ìŠµ**: PyTorch/TensorFlow, Stable Diffusion
- **ê²Œì„/ì‹¤ì‹œê°„ ì„œë²„**: UDP/TCP ì„¸ì…˜ ì„œë²„
- **ê°œë°œ/í…ŒìŠ¤íŠ¸**: ìƒŒë“œë°•ìŠ¤, CI ëŸ°ë„ˆ, ì„ì‹œ í™˜ê²½

---

## 2ï¸âƒ£ EC2ì˜ ì£¼ìš” êµ¬ì„± ìš”ì†Œì™€ ê°œë…

### ğŸ–¥ï¸ 2.1 ì¸ìŠ¤í„´ìŠ¤(Instance)

**ì¸ìŠ¤í„´ìŠ¤**ëŠ” í´ë¼ìš°ë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” **ê°€ìƒ ì„œë²„**ë‹¤. ìƒíƒœëŠ” ëŒ€ê°œ ë‹¤ìŒê³¼ ê°™ë‹¤.

| ìƒíƒœ | ì„¤ëª… |
|---|---|
| `pending` | ìƒì„± ì¤‘ |
| `running` | ì‹¤í–‰ ì¤‘ |
| `stopping/stopped` | ì¤‘ì§€ ì¤‘/ì¤‘ì§€ë¨ (EBS ë¹„ìš©ë§Œ ì²­êµ¬) |
| `shutting-down/terminated` | ì¢…ë£Œ ì¤‘/ì¢…ë£Œë¨(ë³µêµ¬ ë¶ˆê°€) |

**Nitro ê¸°ë°˜** ì¸ìŠ¤í„´ìŠ¤ëŠ” ìµœì‹  ì„¸ëŒ€ì—ì„œ ë³´í¸ì ì´ë©°, ì„±ëŠ¥/ë³´ì•ˆ ê²©ë¦¬/ENA ë„¤íŠ¸ì›Œí‚¹ ì´ì ì„ ì œê³µí•œë‹¤.

---

### âš™ï¸ 2.2 ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•(Instance Type)

ì¸ìŠ¤í„´ìŠ¤ëŠ” **íŒ¨ë°€ë¦¬**(ìš©ë„) Ã— **ì„¸ëŒ€**(ì„±ëŠ¥/ê°€ê²©ëŒ€) Ã— **ì‚¬ì´ì¦ˆ**(vCPU/ë©”ëª¨ë¦¬)ì— ë”°ë¼ êµ¬ë¶„ëœë‹¤.

| íŒ¨ë°€ë¦¬(ì˜ˆ) | ìš©ë„ | ì˜ˆì‹œ |
|---|---|---|
| `t` | ë²”ìš©/ë²„ìŠ¤í„°ë¸” | `t3.micro`, `t4g.small` |
| `m` | ë²”ìš©(ê· í˜•) | `m6i.large`, `m7g.large` |
| `c` | CPU ìµœì (ì—°ì‚° ì§‘ì•½) | `c7i.large`, `c7g.xlarge` |
| `r` | ë©”ëª¨ë¦¬ ìµœì  | `r7i.large` |
| `p/g` | GPU(í•™ìŠµ/ì¶”ë¡ /ê·¸ë˜í”½) | `g6`, `p4d` |
| `i` | ìŠ¤í† ë¦¬ì§€ IOPS ìµœì  | `i4i.large` |
| `h/d` | ê³ ë°€ë„ ìŠ¤í† ë¦¬ì§€ | `h1`, `d3` |

**ë¬´ë£Œ í‹°ì–´**: `t2.micro` ë˜ëŠ” `t3.micro` (ë¦¬ì „/ì‹œê¸°ë³„ ë³€ë™ ê°€ëŠ¥).
ARM(Graviton, `*.g`) ê³„ì—´ì€ **ì„±ëŠ¥/ì „ë ¥/ë¹„ìš© íš¨ìœ¨**ì´ ìš°ìˆ˜í•´ ì ì°¨ ê¸°ë³¸ ì„ íƒì§€ë¡œ ë¶€ìƒ.

> ê°„ë‹¨ ì„ íƒ íŒ
> - **ì›¹/API**: `t3/t4g`, íŠ¸ë˜í”½ ì¦ê°€ ì‹œ `m6/m7`
> - **ì—°ì‚°ì§‘ì•½(ë¹Œë“œ/ì••ì¶•)**: `c7`
> - **ë©”ëª¨ë¦¬ìºì‹œ/ì¸ë©”ëª¨ë¦¬ ë¶„ì„**: `r7`
> - **GPU ì¶”ë¡ /í•™ìŠµ**: `g/p` (ë“œë¼ì´ë²„/AMI ìš”ê±´ í™•ì¸)

---

### ğŸ“¸ 2.3 AMI (Amazon Machine Image)

**AMI**ëŠ” **OS + ì‚¬ì „ ì„¤ì¹˜ SW + ì„¤ì •**ì„ í¬í•¨í•˜ëŠ” **ì´ë¯¸ì§€ í…œí”Œë¦¿**ì´ë‹¤.

- **AWS ì œê³µ**: Amazon Linux, Ubuntu, Windows ë“±
- **ë§ˆì¼“í”Œë ˆì´ìŠ¤/ì»¤ë®¤ë‹ˆí‹°**: ìƒìš©/ì˜¤í”ˆ AMI(ë³´ì•ˆ ê²€ì¦ í•„ìš”)
- **ì‚¬ìš©ì ì •ì˜ AMI**: ë² ì´ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì´ë¯¸ì§€ ìƒì„±

AMIëŠ” **ë£¨íŠ¸ ë³¼ë¥¨ ìœ í˜•(EBS/Instance Store)**, ê°€ìš© ì˜ì—­ í˜¸í™˜ì„±, ë“œë¼ì´ë²„(ENA/NVMe) ë“±ì„ í¬í•¨í•œë‹¤.

#### ìµœì‹  AMI ì¡°íšŒ(ì˜ˆ: Amazon Linux 2023)

```bash
aws ec2 describe-images \
  --owners amazon \
  --filters "Name=name,Values=al2023-ami-*" "Name=architecture,Values=x86_64" \
  --query "reverse(sort_by(Images, &CreationDate))[:1].[ImageId,Name,CreationDate]" \
  --output table --region ap-northeast-2
```

---

### ğŸ§° 2.4 User Data & cloud-init (ë¶€íŒ… ìë™í™”)

ì¸ìŠ¤í„´ìŠ¤ ì²« ë¶€íŒ… ì‹œ **User Data** ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•´ **íŒ¨í‚¤ì§€ ì„¤ì¹˜/ì„¤ì •**ì„ ìë™í™”í•œë‹¤.

#### ì˜ˆ: ê°„ë‹¨í•œ Nginx ì›¹ì„œë²„ ë¶€íŒ… ìŠ¤í¬ë¦½íŠ¸(Amazon Linux)

```bash
#!/bin/bash

dnf -y update
dnf -y install nginx
systemctl enable nginx
cat >/usr/share/nginx/html/index.html <<'EOF'
<!doctype html><h1>Hello from EC2 (Multi-AZ Ready)</h1>
EOF
systemctl start nginx
```

> **ì›ì¹™**: ì¸ìŠ¤í„´ìŠ¤ ë‚´ ì„¤ì •ì€ ê°€ëŠ¥í•˜ë©´ **IaC/ì´ë¯¸ì§€ ë¹Œë”**ë¡œ ì´ì „í•˜ê³ , User DataëŠ” **ìµœì†Œ/Idempotent**í•˜ê²Œ ìœ ì§€.

---

### & ì•ˆì „í•œ ì ‘ì†

EC2ëŠ” **ê³µê°œí‚¤ ê¸°ë°˜ ì¸ì¦**ì„ ì‚¬ìš©í•œë‹¤. ì½˜ì†”/CLIì—ì„œ í‚¤ í˜ì–´(`.pem`)ë¥¼ ìƒì„±í•œë‹¤.

```bash
aws ec2 create-key-pair \
  --key-name blog-key \
  --query 'KeyMaterial' \
  --output text > blog-key.pem
chmod 400 blog-key.pem
```

ì ‘ì†:
```bash
ssh -i blog-key.pem ec2-user@<PublicIP>
```

> **ë³´ì•ˆ ìµœìƒ**: SSH(22) ëŒ€ì‹  **AWS Systems Manager Session Manager(SSM)** ì‚¬ìš©
> - **ì¥ì **: ì¸ë°”ìš´ë“œ í¬íŠ¸ 0, í‚¤ ë°°í¬ ç„¡, ê°ì‚¬ ë¡œê·¸/ë…¹í™” ê°€ëŠ¥
> - í•„ìš”: SSM Agent(ê¸°ë³¸ í¬í•¨ AMI å¤š), ì¸ìŠ¤í„´ìŠ¤ í”„ë¡œíŒŒì¼(IAM Role) + VPC ì—”ë“œí¬ì¸íŠ¸(í”„ë¼ì´ë¹—)

**SSM ì˜ˆì‹œ(IAM Role ì •ì±…)**
```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Action": [
      "ssm:UpdateInstanceInformation",
      "ssmmessages:*",
      "ec2messages:*",
      "logs:CreateLogStream",
      "logs:PutLogEvents"
    ],
    "Resource": "*"
  }]
}
```

---

### ğŸ’½ 2.6 ìŠ¤í† ë¦¬ì§€(EBS/ì¸ìŠ¤í„´ìŠ¤ ìŠ¤í† ì–´)

**EBS(Elastic Block Store)** ëŠ” ë„¤íŠ¸ì›Œí¬ ë¸”ë¡ ìŠ¤í† ë¦¬ì§€ë¡œ **ì¸ìŠ¤í„´ìŠ¤ë¥¼ êº¼ë„ ë°ì´í„° ìœ ì§€**ê°€ ê°€ëŠ¥í•˜ë‹¤.

| íƒ€ì… | ìš©ë„ | ë©”ëª¨ |
|---|---|---|
| `gp3` | ë²”ìš© SSD | IOPS/ì²˜ë¦¬ëŸ‰ ë…ë¦½ ì„¤ì •, **ê¸°ë³¸ ì¶”ì²œ** |
| `io2/io2 Block Express` | ê³ IOPS ë¯¸ì…˜í¬ë¦¬í‹°ì»¬ | ë¹„ìš© ë†’ìŒ |
| `st1` | HDD, ì²˜ë¦¬ëŸ‰ ì¤‘ì‹¬ | ëŒ€ìš©ëŸ‰ ë¡œê·¸/ETL |
| `sc1` | HDD, ì•„ì¹´ì´ë¹™ | ë“œë¬¼ê²Œ ì ‘ê·¼ |

- **ìŠ¤ëƒ…ìƒ·**: ì¦ë¶„ ë°±ì—…, **ë‹¤ë¥¸ ë¦¬ì „ ë³µì œ** ê°€ëŠ¥
- **ì•”í˜¸í™”**: KMSë¡œ **ê¸°ë³¸ ì•”í˜¸í™”** ê¶Œì¥(ì»´í”Œë¼ì´ì–¸ìŠ¤/ë°ì´í„° ë³´í˜¸)

#### EBS ë³¼ë¥¨ ì¦ì„¤(ë¬´ì¤‘ë‹¨, íŒŒì¼ì‹œìŠ¤í…œ í™•ì¥ í•„ìš”)

```bash
# í¬ê¸° 20GBë¡œ í™•ì¥

aws ec2 modify-volume --volume-id vol-xxxx --size 20
# OS ë‚´ì—ì„œ growpart/resize2fs ë“±ìœ¼ë¡œ í™•ì¥

```

**ì¸ìŠ¤í„´ìŠ¤ ìŠ¤í† ì–´**ëŠ” ë¡œì»¬ NVMe ê¸°ë°˜ ì´ˆê³ ì†ì´ì§€ë§Œ **ì¤‘ì§€/ì¢…ë£Œ ì‹œ ë°ì´í„° ì†Œì‹¤** â†’ ìºì‹œ/ì„ì‹œ ì €ì¥ì†Œ ìš©ë„.

---

### & NACL

**ë³´ì•ˆ ê·¸ë£¹(SG)** ì€ **ìƒíƒœ ì €ì¥(Stateful)** ë°©í™”ë²½(ENI ë‹¨ìœ„).
**NACL**ì€ **ë¬´ìƒíƒœ(Stateless)** ì„œë¸Œë„· ë°©í™”ë²½ìœ¼ë¡œ **í—ˆìš©/ê±°ë¶€ ë£°** ê°€ëŠ¥.

- SG ìµœì†Œ ì˜ˆ:
```text
22/tcp (SSH)  â†’ ë‚´ IPë§Œ
80/tcp (HTTP) â†’ 0.0.0.0/0
443/tcp (HTTPS) â†’ 0.0.0.0/0
```

- ìš´ì˜ì—ì„œëŠ” SSH ëŒ€ì‹  **SSM**, ì›¹ì€ **ALB** ë’¤ì— ë‘ê³  ì› ì¸ë°”ìš´ë“œëŠ” LBë§Œ í—ˆìš©í•˜ëŠ” êµ¬ì„±ì´ í‘œì¤€.

---

### ğŸŒ 2.8 ë„¤íŠ¸ì›Œí‚¹ ê³ ê¸‰: ENI, Placement Group, EIP, IMDSv2

- **ENI(Elastic Network Interface)**: ë„¤íŠ¸ì›Œí¬ ì–´ëŒ‘í„°. ë©€í‹° ENIë¡œ NIC ë¶„ë¦¬/ê³ ê°€ìš©ì„± ì „ëµ ê°€ëŠ¥
- **Placement Group**
  - `cluster`: ì €ì§€ì—°/ê³ ëŒ€ì—­í­, HPC
  - `spread`: ì¥ì•  ë„ë©”ì¸ ë¶„ì‚°(ì‘ì€ ìˆ˜ì˜ ì¤‘ìš” ì¸ìŠ¤í„´ìŠ¤)
  - `partition`: ëŒ€ê·œëª¨ ë¶„ì‚°(ë¹…ë°ì´í„°/HDFS)
- **EIP(Elastic IP)**: ê³ ì • ê³µì¸ IP(ë¯¸ì‚¬ìš©/ì—°ê²° ëŠê¹€ ìƒíƒœ ê³¼ê¸ˆ ì£¼ì˜)
- **IMDSv2**: ë©”íƒ€ë°ì´í„° ì„œë¹„ìŠ¤. **v2 ì „í™˜ ê°•ë ¥ ê¶Œì¥**(ì„¸ì…˜ í† í° ê¸°ë°˜)

IMDSv2 ê°•ì œ(Launch Template ê³ ê¸‰ì˜µì…˜ ë˜ëŠ” CLI):
```bash
aws ec2 modify-instance-metadata-options \
  --instance-id i-xxxx \
  --http-endpoint enabled \
  --http-tokens required
```

---

## ğŸ§ª 3ï¸âƒ£ EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„± â€” ì½˜ì†” & CLI & IaC

### ì½˜ì†” ìŠ¤í…(ìš”ì•½)

1) AMI ì„ íƒ(ì˜ˆ: Amazon Linux 2023)
2) íƒ€ì… ì„ íƒ(ì˜ˆ: `t3.micro`)
3) í‚¤ í˜ì–´/ë„¤íŠ¸ì›Œí¬/ë³´ì•ˆê·¸ë£¹/ìŠ¤í† ë¦¬ì§€/ê³ ê¸‰(User Data/IMDSv2)
4) ê²€í†  ë° ì‹œì‘

### CLI ì˜ˆì œ(ë¬´ë£Œ í‹°ì–´ ê°€ì´ë“œ)

```bash
# ë³´ì•ˆê·¸ë£¹

MYIP=$(curl -s https://checkip.amazonaws.com)/32
SG_ID=$(aws ec2 create-security-group \
  --group-name web-sg --description "web sg" \
  --vpc-id vpc-xxxxxxxx \
  --query 'GroupId' --output text)

aws ec2 authorize-security-group-ingress --group-id $SG_ID \
  --ip-permissions \
  "IpProtocol=tcp,FromPort=22,ToPort=22,IpRanges=[{CidrIp=\"$MYIP\"}]" \
  "IpProtocol=tcp,FromPort=80,ToPort=80,IpRanges=[{CidrIp=\"0.0.0.0/0\"}]"

# í‚¤í˜ì–´

aws ec2 create-key-pair --key-name blog-key \
  --query 'KeyMaterial' --output text > blog-key.pem && chmod 400 blog-key.pem

# AMI ì¡°íšŒ(ìµœì‹  1ê°œ)

AMI_ID=$(aws ec2 describe-images \
  --owners amazon \
  --filters "Name=name,Values=al2023-ami-*" "Name=architecture,Values=x86_64" \
  --query "reverse(sort_by(Images, &CreationDate))[:1].ImageId" \
  --output text)

# ìœ ì €ë°ì´í„° íŒŒì¼

cat >user-data.sh <<'UD'
#!/bin/bash

dnf -y update
dnf -y install nginx
systemctl enable --now nginx
UD

# ì‹¤í–‰

aws ec2 run-instances \
  --image-id $AMI_ID \
  --instance-type t3.micro \
  --key-name blog-key \
  --security-group-ids $SG_ID \
  --subnet-id subnet-xxxxxxxx \
  --user-data file://user-data.sh \
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=blog-ec2}]' \
  --count 1
```

### CloudFormation(Launch Template + ASG ìš”ì•½)

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Resources:
  LT:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: web-lt
      LaunchTemplateData:
        InstanceType: t3.micro
        ImageId: ami-xxxxxxxx
        MetadataOptions:
          HttpTokens: required
        UserData: !Base64 |
          #!/bin/bash
          dnf -y install nginx && systemctl enable --now nginx
  ASG:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      VPCZoneIdentifier: [subnet-a, subnet-b]
      MinSize: '2'
      MaxSize: '6'
      DesiredCapacity: '2'
      LaunchTemplate:
        LaunchTemplateName: !Ref LT
        Version: !GetAtt LT.LatestVersionNumber
```

### Terraform(ìš”ì•½)

```hcl
resource "aws_launch_template" "lt" {
  name_prefix   = "web-lt-"
  image_id      = var.ami_id
  instance_type = "t3.micro"
  metadata_options { http_tokens = "required" }
  user_data = base64encode(<<-EOT
    #!/bin/bash
    dnf -y install nginx && systemctl enable --now nginx
  EOT
  )
}

resource "aws_autoscaling_group" "asg" {
  desired_capacity    = 2
  max_size            = 6
  min_size            = 2
  vpc_zone_identifier = [var.subnet_a, var.subnet_b]
  launch_template {
    id      = aws_launch_template.lt.id
    version = "$Latest"
  }
}
```

---

## ğŸ”Œ 4ï¸âƒ£ ì ‘ì† ì‹¤ìŠµ (SSH vs SSM)

### SSH

```bash
ssh -i blog-key.pem ec2-user@<PublicIP>
```

### SSM Session Manager (ê¶Œì¥)

```bash
# í”„ë¼ì´ë¹— ì¸ìŠ¤í„´ìŠ¤ë„ ì ‘ì† ê°€ëŠ¥ (SSM Agent + IAM Role í•„ìš”)

aws ssm start-session --target i-xxxxxxxx --region ap-northeast-2
```

**ë¹„êµ ìš”ì•½**

| í•­ëª© | SSH | SSM |
|---|---|---|
| ë„¤íŠ¸ì›Œí¬ | 22/tcp ì˜¤í”ˆ í•„ìš” | ì¸ë°”ìš´ë“œ ç„¡ |
| ì¸ì¦/ê´€ë¦¬ | í‚¤ ë°°í¬/íšŒìˆ˜ ë¶€ë‹´ | IAM + ì„¸ì…˜ ë¡œê¹… |
| ê°ì‚¬ | ì œí•œì  | CloudWatch/CloudTrailë¡œ ë…¹í™” |

---

## ğŸ’¡ 5ï¸âƒ£ ìš´ì˜ íŒ(ìŠ¤ì¼€ì¤„/íŒ¨ì¹˜/ëª¨ë‹ˆí„°ë§)

### ìë™ ì‹œì‘/ì •ì§€ ìŠ¤ì¼€ì¤„ (EventBridge + Lambda)

- ì•¼ê°„/ì£¼ë§ ì •ì§€ë¡œ ë¹„ìš© ì ˆê°
- íƒœê·¸ ê¸°ë°˜(`AutoStop=true`)ìœ¼ë¡œ íŠ¹ì • ì¸ìŠ¤í„´ìŠ¤ë§Œ ì œì–´

### íŒ¨ì¹˜Â·ì—ì´ì „íŠ¸

- **SSM Patch Manager**ë¡œ OS íŒ¨ì¹˜
- **CloudWatch Agent**ë¡œ ë””ìŠ¤í¬/ë©”ëª¨ë¦¬/í”„ë¡œì„¸ìŠ¤ ì§€í‘œ ìˆ˜ì§‘

### CloudWatch ì•ŒëŒ(ì˜ˆ)

```bash
aws cloudwatch put-metric-alarm \
  --alarm-name "EC2-High-CPU" \
  --metric-name CPUUtilization \
  --namespace AWS/EC2 \
  --statistic Average --period 60 \
  --threshold 80 --comparison-operator GreaterThanThreshold \
  --dimensions Name=InstanceId,Value=i-xxxxxxxx \
  --evaluation-periods 3 \
  --alarm-actions arn:aws:sns:ap-northeast-2:123456789012:ops
```

---

## ğŸ’° 6ï¸âƒ£ ê³¼ê¸ˆ ëª¨ë¸ & ê³„ì‚°ì‹

| ëª¨ë¸ | ì„¤ëª… | ì í•© |
|---|---|---|
| ì˜¨ë””ë§¨ë“œ | ì´ˆ/ì‹œê°„ ë‹¨ìœ„ | ê°€ë³€ ì›Œí¬ë¡œë“œ, PoC |
| ìŠ¤íŒŸ | ì‰ì—¬ ìì›, ìµœëŒ€ 90%â†“ | ì¤‘ë‹¨ í—ˆìš© ë°°ì¹˜/ETL |
| ì˜ˆì•½(RI) | 1~3ë…„ ì•½ì • | ì˜ˆì¸¡ ê°€ëŠ¥í•œ ìƒì‹œ ì›Œí¬ë¡œë“œ |
| Savings Plans | ì¸ìŠ¤í„´ìŠ¤/ì»´í“¨íŠ¸ ì•½ì • | ê´‘ë²”ìœ„ í• ì¸ ì ìš© |

**ë‹¨ìˆœ ì›”ë¹„ìš© ê·¼ì‚¬**
$$
\text{ì›” ë¹„ìš©} \approx \sum_k (c_k \cdot H_k \cdot N_k) + C_{\text{EBS}} + C_{\text{ì „ì†¡}} + \cdots
$$
- \(c_k\): ì¸ìŠ¤í„´ìŠ¤ ë‹¨ê°€(USD/h)
- \(H_k\): ì›” ì‚¬ìš© ì‹œê°„(ì‹œê°„)
- \(N_k\): ì¸ìŠ¤í„´ìŠ¤ ìˆ˜

**ë²„ìŠ¤í„°ë¸”(T ì‹œë¦¬ì¦ˆ) í¬ë ˆë”§ ê°œë…(ì§ê´€ ëª¨ë¸)**
> í‰ê·  CPU í—ˆìš©ì¹˜ëŠ” ì¶•ì ëœ **CPU í¬ë ˆë”§**ê³¼ ìƒì„±ë¥ ì— ì˜í•´ ì œí•œ. ìŠ¤íŒŒì´í¬ í›„ **í‰ê· ì´ ë‚®ì•„ì•¼** ì§€ì† ê°€ëŠ¥.

---

## ğŸ§¹ 7ï¸âƒ£ ì¢…ë£Œ/ì •ë¦¬(ëˆ„ìˆ˜ ë°©ì§€)

- **ì¸ìŠ¤í„´ìŠ¤ ì¢…ë£Œ** í›„ì—ë„ **EBS ìŠ¤ëƒ…ìƒ·/AMI/EIP/ALB** ë“±ì€ **ìš”ê¸ˆ ë°œìƒ** ê°€ëŠ¥ â†’ **ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸** ê¶Œì¥
```bash
# ì—°ê²° ì•ˆ ëœ EIP ì°¾ê¸°

aws ec2 describe-addresses --query 'Addresses[?AssociationId==`null`].[PublicIp,AllocationId]' --output table

# í›„ ì‚­ì œ

```

---

## & í™•ì¥(Auto Scaling) ì„¤ê³„

- **ë‹¤ì¤‘ AZ** ì„œë¸Œë„·ì— **ASG** ë°°ì¹˜ â†’ AZ ì¥ì•  ì‹œ ìë™ ë³´ì¶©
- **ALB** í—¬ìŠ¤ì²´í¬ `/healthz` â†’ ë¶ˆê±´ê°• ì¸ìŠ¤í„´ìŠ¤ ê²©ë¦¬
- **ìƒíƒœ ì €ì¥ ì„¸ì…˜**ì€ **ì™¸ë¶€í™”**(ElastiCache/DB/S3) ë˜ëŠ” ALB Sticky/ì„¸ì…˜ ë³µì œ

**ì´ì¤‘ AZ ê°€ìš©ì„± ê·¼ì‚¬**
$$
A_{\text{dual}} = 1 - (1-A)(1-B)
$$
ì˜ˆ) \(A=B=99.9\% \Rightarrow A_{\text{dual}} \approx 99.9999\%\)

---

## ğŸ”’ 9ï¸âƒ£ ë³´ì•ˆ í•„ìˆ˜ ì²´í¬

- **IMDSv2 í•„ìˆ˜í™”**, **ë³´ì•ˆê·¸ë£¹ ìµœì†Œ ê°œë°©**, **NACL ê¸°ë³¸ ê±°ë¶€ ì „ëµ** ê²€í† 
- **KMS ê¸°ë³¸ ì•”í˜¸í™”(EBS/S3/ìŠ¤ëƒ…ìƒ·)**
- **SSM ì„¸ì…˜**ìœ¼ë¡œ ìš´ì˜, SSH í•„ìš” ì‹œë§Œ ì—´ê³  **ë‚´ IP ì œí•œ**
- **CloudTrail/Config/GuardDuty/Security Hub** í™œì„±í™”

---

## IaC ìŠ¤ë‹ˆí« ëª¨ìŒ

### CloudFormation â€” ë³´ì•ˆê·¸ë£¹ + IMDSv2 + UserData

```yaml
Resources:
  WebSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: web sg
      VpcId: vpc-xxxxxxxx
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 203.0.113.10/32
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0

  WebLT:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        ImageId: ami-xxxxxxxx
        InstanceType: t3.micro
        SecurityGroupIds: [ !Ref WebSG ]
        MetadataOptions:
          HttpEndpoint: enabled
          HttpTokens: required
        UserData: !Base64 |
          #!/bin/bash
          dnf -y install nginx && systemctl enable --now nginx
```

### Terraform â€” gp3 EBS ë£¨íŠ¸ + íƒœê·¸ í‘œì¤€

```hcl
resource "aws_instance" "web" {
  ami           = var.ami_id
  instance_type = "t3.micro"
  subnet_id     = var.subnet_id
  vpc_security_group_ids = [var.sg_id]

  root_block_device {
    volume_type = "gp3"
    volume_size = 16
    delete_on_termination = true
    encrypted  = true
  }

  metadata_options {
    http_tokens = "required"
  }

  user_data = <<-EOS
    #!/bin/bash
    dnf -y install nginx && systemctl enable --now nginx
  EOS

  tags = {
    Project    = "blog"
    Env        = "dev"
    Owner      = "do-hyun"
    CostCenter = "R&D"
  }
}
```

### â€” SSM ê¸°ë°˜ ì ‘ì†

```ts
import * as cdk from 'aws-cdk-lib';
import * as ec2 from 'aws-cdk-lib/aws-ec2';
import * as iam from 'aws-cdk-lib/aws-iam';

export class Ec2SsmStack extends cdk.Stack {
  constructor(scope: cdk.App, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    const vpc = ec2.Vpc.fromLookup(this, 'Vpc', { isDefault: true });

    const role = new iam.Role(this, 'SSMRole', {
      assumedBy: new iam.ServicePrincipal('ec2.amazonaws.com')
    });
    role.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName('AmazonSSMManagedInstanceCore'));

    const sg = new ec2.SecurityGroup(this, 'SG', { vpc, allowAllOutbound: true });

    new ec2.Instance(this, 'Ec2', {
      vpc,
      role,
      securityGroup: sg,
      instanceType: new ec2.InstanceType('t3.micro'),
      machineImage: ec2.MachineImage.latestAmazonLinux2023(),
      ssmSessionPermissions: true
    });
  }
}
```

---

## ì²´í¬ë¦¬ìŠ¤íŠ¸(ì´ˆê¸°/ìš´ì˜/ë¹„ìš©/ë³´ì•ˆ)

**ì´ˆê¸°**
- [ ] IMDSv2 `required`
- [ ] í‚¤í˜ì–´ ì•ˆì „ ë³´ê´€(ë˜ëŠ” SSM)
- [ ] SG ìµœì†Œ ê°œë°©, SSHëŠ” ë‚´ IPë§Œ
- [ ] EBS ì•”í˜¸í™”/KMS, gp3 ê¸°ë³¸
- [ ] User DataëŠ” **Idempotent**
- [ ] íƒœê·¸ í‘œì¤€(Project/Env/Owner/CostCenter)

**ìš´ì˜**
- [ ] CloudWatch ì•ŒëŒ(CPU/ìƒíƒœ/ë””ìŠ¤í¬)
- [ ] CloudWatch/SSM Agent ì„¤ì¹˜
- [ ] íŒ¨ì¹˜/ì¬ë¶€íŒ… ìœˆë„ìš° ê´€ë¦¬
- [ ] ë°±ì—…(AMI/ìŠ¤ëƒ…ìƒ·) ì£¼ê¸° + ë³´ì¡´
- [ ] ASG + ALB í—¬ìŠ¤ì²´í¬

**ë¹„ìš©**
- [ ] ì €ì‚¬ìš©/ìœ íœ´ ì¸ìŠ¤í„´ìŠ¤/ë³¼ë¥¨ ì •ë¦¬
- [ ] ìŠ¤íŒŸ/RI/Savings Plans ê²€í† 
- [ ] ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤/ìˆ˜ëª…ì£¼ê¸°
- [ ] EIP/ALB/ìŠ¤ëƒ…ìƒ· ëˆ„ìˆ˜ ì ê²€

**ë³´ì•ˆ**
- [ ] CloudTrail/Config/GuardDuty/Security Hub ì¼œê¸°
- [ ] SSM ìš°ì„  ìš´ì˜, SSH ì˜ˆì™¸ë§Œ í—ˆìš©
- [ ] OS/ë¯¸ë“¤ì›¨ì–´ ì—…ë°ì´íŠ¸ ì •ì±…

---

## í”í•œ í•¨ì •ê³¼ í•´ê²°

- **22 í¬íŠ¸ ì—´ë¦¼ + ë°©ì¹˜** â†’ ê³µê²© í‘œì , **SSM ì „í™˜** + ë‚´ IP ì œí•œ
- **EBS ìŠ¤ëƒ…ìƒ·/AMI ëˆ„ìˆ˜** â†’ ì›”ë§ ì²­êµ¬í­íƒ„, **ë³´ì¡´ê¸°ê°„/ìë™ ì •ë¦¬**
- **IMDSv1 í—ˆìš©** â†’ ìê²©ì¦ëª… ë…¸ì¶œ ë¦¬ìŠ¤í¬, **IMDSv2ë¡œ ê°•ì œ**
- **ë‹¨ì¼ AZ ë°°ì¹˜** â†’ ì¥ì•  ì·¨ì•½, **2+ AZ ì„œë¸Œë„· + ASG**
- **ALB í—¬ìŠ¤ì²´í¬ ë¯¸êµ¬í˜„** â†’ ë¸”ë™í™€ íŠ¸ë˜í”½, `/healthz` ì¤€ë¹„
- **t ê³„ì—´ ê³¼ë„í•œ ë¶€í•˜** â†’ í¬ë ˆë”§ ê³ ê°ˆ, **m/c/rë¡œ ë¦¬ì‚¬ì´ì¦ˆ**

---

## ì‹¤ìŠµ ë ˆì‹œí”¼ â€” â€œ5ë¶„ ì›¹ì„œë²„ + 2AZ í™•ì¥ ì¤€ë¹„â€

1) **AZ/ì„œë¸Œë„· ì ê²€**
```bash
aws ec2 describe-availability-zones \
  --query "AvailabilityZones[].{Name:ZoneName,Id:ZoneId}" \
  --region ap-northeast-2
```

2) **SG(80/22) + í‚¤ + AMI + User Data** ìƒì„±(ì•ì˜ CLI ì‚¬ìš©)

3) **ì¸ìŠ¤í„´ìŠ¤ 1ëŒ€ ìƒì„± â†’ í¼ë¸”ë¦­ IPë¡œ ì ‘ì†**
```bash
curl http://<PublicIP>
# "Hello from EC2 (Multi-AZ Ready)" í™•ì¸

```

4) **ASG/ALBë¡œ í™•ì¥**(CloudFormation/Terraform ì˜ˆì‹œ í™œìš©)
   - ì„œë¸Œë„· **2ê°œ ì´ìƒ(AZ a,b)** ì—°ê²°
   - ALB Target Group í—¬ìŠ¤ì²´í¬ `/healthz`

---

## âœ… ì •ë¦¬

- EC2ëŠ” **ê°€ì¥ ìœ ì—°í•œ ì»´í“¨íŒ… ë‹¨ìœ„**ë¡œ, **íƒ€ì…/ìŠ¤í† ë¦¬ì§€/ë„¤íŠ¸ì›Œí¬/ë³´ì•ˆ/ìë™í™”** ì¡°í•©ì— ë”°ë¼ ê´‘ë²”ìœ„í•œ ì›Œí¬ë¡œë“œë¥¼ ì»¤ë²„í•œë‹¤.
- **ë³´ì•ˆ(SSM/IMDSv2/ì•”í˜¸í™”)**, **ê°€ìš©ì„±(ë‹¤ì¤‘ AZ + ALB/ASG)**, **ë¹„ìš©(ìŠ¤íŒŸ/RI/Savings)** ì„ í•¨ê»˜ ê³ ë ¤í•˜ë©´ **ì•ˆì •ì ì´ê³  ê²½ì œì ì¸ ìš´ì˜**ì´ ê°€ëŠ¥í•˜ë‹¤.
- ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” **IaC + ê´€ì¸¡ì„± + íŒ¨ì¹˜/ë°±ì—…**ì„ í‘œì¤€í™”í•˜ê³ , **ëˆ„ìˆ˜ ë¦¬ì†ŒìŠ¤**ë¥¼ ì§€ì† ì ê²€í•˜ë¼.

---

## ë¹ ë¥¸ ëª…ë ¹ ëª¨ìŒ

```bash
# í˜„ì¬ ê³„ì •/ë¦¬ì „ í™•ì¸

aws sts get-caller-identity
aws configure list
aws ec2 describe-account-attributes

# ì¸ìŠ¤í„´ìŠ¤/ë³¼ë¥¨/ìŠ¤ëƒ…ìƒ· íƒœê·¸ ì¼ê´„ ë¶€ì—¬(ì˜ˆ)

aws ec2 create-tags --resources i-xxxx vol-xxxx snap-xxxx \
  --tags Key=Project,Value=blog Key=Env,Value=dev

# ì˜¤ë˜ëœ ë¯¸ì‚¬ìš© ìŠ¤ëƒ…ìƒ· ì°¾ê¸°(ì˜ˆ: íƒœê·¸/ë‚ ì§œë¡œ jq í•„í„°)

aws ec2 describe-snapshots --owner-ids self | jq '.Snapshots[] | select(.StartTime < "2025-09-01T00:00:00Z") | .SnapshotId'
```

---

## ë¬¸ì œí•´ê²°(íŠ¸ëŸ¬ë¸”ìŠˆíŒ…) ë‹¨ê³¨

- **SSH íƒ€ì„ì•„ì›ƒ**: SG 22 í—ˆìš©? ë¼ìš°íŒ…/NACL? Bastion/SSM ì‚¬ìš©?
- **User Data ë¯¸ì‹¤í–‰**: ë¡œê·¸ í™•ì¸(`/var/log/cloud-init-output.log`)
- **ALB 5xx**: í—¬ìŠ¤ì²´í¬ ê²½ë¡œ/ë³´ì•ˆê·¸ë£¹/ì• í”Œë¦¬ì¼€ì´ì…˜ í¬íŠ¸ ì¼ì¹˜?
- **ë””ìŠ¤í¬ Full**: CloudWatch Agentë¡œ ë””ìŠ¤í¬ ì‚¬ìš© ì•ŒëŒ, ë¡œí…Œì´ì…˜/ì•„ì¹´ì´ë¹™
- **ì„±ëŠ¥ ì €í•˜**: `dmesg`/`/var/log/messages`/CloudWatch ì§€í‘œ ìƒê´€ë¶„ì„, íƒ€ì… ë¦¬ì‚¬ì´ì¦ˆ ë˜ëŠ” EBS IOPS/ìŠ¤ë£¨í’‹ íŠœë‹
