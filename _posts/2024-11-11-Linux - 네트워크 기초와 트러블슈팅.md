---
layout: post
title: Linux - 네트워크 기초와 트러블슈팅
date: 2024-11-11 19:20:23 +0900
category: Linux
---
# 네트워크 기초와 트러블슈팅 — 핵심 도구와 접근법

## 네트워크 장애 진단의 체계적 접근법

네트워크 문제를 해결할 때는 체계적인 접근이 중요합니다. 전형적인 문제 원인을 5단계로 구분하고, 단계별로 문제 범위를 축소해 나가는 전략을 사용할 수 있습니다.

### 문제 원인의 5단계 분류

1. **로컬 시스템 스택**: IP 주소 할당, 라우팅 테이블, 호스트 방화벽, 프로세스 상태
2. **LAN 환경**: 스위치, VLAN 설정, 게이트웨이 연결, ARP 해상도
3. **WAN/ISP 연결**: 경로 문제, 패킷 손실, 네트워크 지연
4. **DNS 해석**: 도메인 이름을 IP 주소로 변환하는 과정
5. **원격 서비스**: 대상 서버의 리스닝 상태, 방화벽 규칙, 애플리케이션 상태

### 빠른 5단계 점검 순서

문제가 발생했을 때 아래 순서대로 확인하면 효율적으로 원인을 찾을 수 있습니다.

```bash
# 1단계: 로컬 네트워크 설정 확인
ip a     # IP 주소가 있는지 확인
ip r     # 라우팅 테이블 확인

# 2단계: 게이트웨이 및 로컬 연결 확인
ip r | grep default      # 기본 게이트웨이 확인
ip neigh                 # ARP 테이블 확인

# 3단계: L2/L3 연결성 테스트
ping -c 3 <gateway-ip>   # 게이트웨이 핑 테스트
ping -c 3 8.8.8.8        # 외부 서버 핑 테스트

# 4단계: DNS 해석 확인
dig +short example.com @1.1.1.1  # DNS 해석 테스트

# 5단계: 원격 서비스 접속 확인
ss -tS                    # TCP 소켓 상태 확인
nc -vz example.com 443    # 443 포트 연결 테스트
curl -vI https://example.com  # HTTP/HTTPS 연결 테스트
```

위 점검 과정에서 실패 지점을 발견하면, 해당 단계에 집중하여 `traceroute`나 `mtr`로 경로를 분석하거나, `ss`와 `tcpdump`로 포트 상태를 확인하며, 방화벽 규칙과 네트워크 정책을 교차 검증합니다.

---

## 핵심 네트워크 진단 도구

### ping — 기본 연결성, 지연, 패킷 손실 확인

`ping`은 ICMP 에코 요청을 보내어 네트워크 연결성, 응답 시간, 패킷 손실률을 측정하는 가장 기본적인 도구입니다.

```bash
ping -c 4 naver.com          # 4회만 핑 테스트
ping -i 0.5 8.8.8.8          # 0.5초 간격으로 핑
ping -s 1400 1.1.1.1         # 1400바이트 페이로드로 핑 (큰 패킷 테스트)
ping -c 10 -M do -s 1472 8.8.8.8  # PMTUD 테스트
```

- `-M do` 옵션은 패킷 분할(Don't Fragment)을 지정하여 경로 MTU 탐색(PMTUD) 테스트에 유용합니다.
- **주의사항**: 일부 네트워크 환경에서는 ICMP 트래픽이 차단되어 `ping`이 실패할 수 있지만, 실제 TCP 연결은 정상적으로 작동할 수 있습니다. 이런 경우에는 `curl`이나 `nc`(netcat)로 추가 검증이 필요합니다.

### ip — 현대 리눅스의 통합 네트워크 관리 도구

`ip` 명령어는 네트워크 인터페이스, 주소, 라우팅, ARP 등을 모두 관리할 수 있는 강력한 도구입니다.

#### 인터페이스와 주소 관리
```bash
ip a                         # 모든 인터페이스의 주소 정보
ip link                      # 링크 상태 확인
ip link set eth0 up          # 인터페이스 활성화
ip link set eth0 down        # 인터페이스 비활성화
ip addr add 192.168.10.10/24 dev eth0  # IP 주소 추가
ip addr del 192.168.10.10/24 dev eth0  # IP 주소 삭제
```

#### 라우팅 테이블 관리
```bash
ip r                         # 라우팅 테이블 전체 보기
ip route get 1.1.1.1         # 특정 목적지로의 경로 확인
sudo ip route add 10.10.0.0/16 via 10.0.0.1 dev eth0  # 정적 경로 추가
sudo ip route del 10.10.0.0/16                          # 정적 경로 삭제
```

#### ARP 및 이웃 테이블 관리
```bash
ip neigh                     # ARP/이웃 테이블 확인
sudo ip neigh flush all     # ARP 캐시 초기화
```

#### 고급 기능: 정책 라우팅
```bash
# 별도의 라우팅 테이블 생성 및 사용
echo "200 alt" | sudo tee -a /etc/iproute2/rt_tables
sudo ip rule add from 10.0.2.0/24 table alt
sudo ip route add default via 10.0.2.1 dev eth1 table alt
```

### ss와 netstat — 소켓 상태 확인

`ss`(socket statistics)는 최신 리눅스 시스템에서 `netstat`을 대체하는 더 빠르고 효율적인 도구입니다.

#### netstat (레거시, 참고용)
```bash
netstat -tuln                # 리스닝 중인 TCP/UDP 포트 확인
netstat -tulnp | grep :80    # 80 포트를 사용하는 프로세스 확인
```

#### ss (권장)
```bash
ss -tuln                     # 리스닝 중인 소켓 확인
ss -tulnp | grep nginx       # nginx 프로세스의 소켓 상태 확인
ss -ant | grep ESTAB         # ESTABLISHED 상태의 연결만 확인
ss -s                        # 소켓 통계 요약 (큐, 메모리, 상태별 카운트)
```

**리스닝 중인데 접속이 안 되는 경우 점검사항**: 방화벽(호스트/네트워크), 바인딩 주소(0.0.0.0 vs 127.0.0.1), SELinux 정책, 백로그(backlog) 제한 등을 확인해야 합니다.

### traceroute와 mtr — 네트워크 경로 분석

#### traceroute
```bash
sudo apt install -y traceroute  # 설치 (필요시)
traceroute -n example.com       # 역방향 DNS 조회 생략으로 속도 향상
```

#### mtr (My TraceRoute)
`mtr`은 `traceroute`와 `ping`을 결합한 도구로, 실시간으로 경로별 패킷 손실률과 지연 시간 변동을 관찰할 수 있습니다.

```bash
sudo apt install -y mtr      # 설치 (필요시)
mtr -nzwc 100 example.com    # 100회 측정 후 통계 요약 출력
```

`mtr`은 간헐적으로 발생하는 네트워크 문제나 패킷 손실이 어느 홉(hop)에서 발생하는지 식별하는 데 특히 유용합니다.

### dig와 nslookup — DNS 진단

DNS 문제는 네트워크 연결성 문제로 오해하기 쉽습니다. DNS 해석이 제대로 작동하는지 확인하는 것이 중요합니다.

```bash
dig +short openai.com                    # 간단한 DNS 조회
dig @1.1.1.1 openai.com A +noall +answer # 특정 DNS 서버로 조회
dig example.com ANY                      # 모든 DNS 레코드 유형 조회 (권한 정책상 제한될 수 있음)
nslookup github.com                      # 대화형 DNS 조회
```

**DNS 문제 의심 포인트**:
- 로컬 리졸버(systemd-resolved, NetworkManager)와 공용 DNS 서버 결과 차이
- 검색 도메인(search domain) 충돌
- `/etc/hosts` 파일의 오버라이드 설정

#### systemd-resolved 환경에서의 DNS 확인
```bash
resolvectl status           # systemd-resolved 상태 확인
resolvectl query example.com  # DNS 조회
```
`/etc/resolv.conf` 파일이 `systemd-resolved`의 스텁(127.0.0.53)을 가리키는지 확인해야 합니다.

### nmap — 포트 스캔과 서비스 탐지

`nmap`은 네트워크 탐색과 보안 감사에 사용되는 강력한 도구입니다. 허가 없는 시스템에 대한 스캔은 불법일 수 있으니 주의가 필요합니다.

```bash
sudo nmap -sS -p 22,80,443 192.168.0.1  # 특정 포트 스캔 (SYN 스캔)
nmap -p 1-1000 localhost                 # 로컬호스트의 1-1000 포트 스캔
nmap -A openai.com                       # 공격적 스캔 (OS 탐지, 서비스 버전 확인 등)
nmap -Pn example.com                     # ICMP 핑을 무시하고 스캔
```

**주의사항**: `nmap` 사용 시 반드시 보안 정책을 준수하고 필요한 허가를 받아야 합니다. 방화벽이나 IPS(침입 방지 시스템)에 의해 차단되거나 오탐(false positive)이 발생할 수 있습니다.

### tcpdump — 패킷 수준의 네트워크 분석

`tcpdump`는 네트워크 인터페이스를 통해 오가는 실제 패킷을 캡처하고 분석할 수 있는 도구입니다. 네트워크 문제의 근본 원인을 파악하는 데 필수적입니다.

```bash
sudo tcpdump -ni any tcp port 443 -c 50  # 443 포트 TCP 패킷 50개 캡처
sudo tcpdump -ni eth0 host 8.8.8.8 and icmp  # 특정 호스트의 ICMP 트래픽 캡처
sudo tcpdump -ni eth0 'tcp[tcpflags] & (tcp-syn|tcp-ack) != 0' -c 20  # SYN/ACK 패킷만 캡처
sudo tcpdump -ni eth0 -w capture.pcap   # 파일로 저장 (와이어샤크로 후분석)
```

**패턴 분석**:
- **증상**: SYN 패킷은 보내지만 SYN/ACK 응답이 없음 → 경로 문제, 방화벽 차단, 리턴 경로 문제
- **증상**: 서버는 SYN/ACK를 보내지만 클라이언트가 받지 못함 → 비대칭 라우팅, 중간 장비 필터링 가능성

### curl과 nc — 응용 계층 연결 테스트

#### curl (HTTP/HTTPS 테스트)
```bash
curl -vI https://example.com/healthz  # 상세 정보 출력하며 HTTPS 연결 테스트
```

#### nc (netcat, TCP/UDP 연결 테스트)
```bash
nc -vz example.com 443  # 443 포트 TCP 연결 테스트
```

`curl -v` 옵션은 TLS 핸드셰이크 과정, 리다이렉트, HTTP 헤더 등을 상세히 보여줍니다. `nc -vz`는 단순히 TCP 연결 가능성만 테스트합니다.

---

## 특수 네트워크 문제 해결

### MTU와 PMTUD 문제 — 큰 패킷 전송 실패

**증상**: 작은 파일 전송이나 일반 웹 브라우징은 되지만, 대용량 파일 업로드나 특정 사이트 접속 시 연결이 끊김.

**원인**: 경로상의 어느 장비에서 패킷 크기(MTU) 제한이 있고, PMTUD(Path MTU Discovery)가 실패하여 ICMP 패킷이 차단됨.

**진단 방법**:
```bash
# MTU 테스트 (DF=Don't Fragment 플래그 설정)
ping -c 3 -M do -s 1472 8.8.8.8

# 실패 시 인터페이스 MTU 값을 낮춰 테스트
ip link set dev eth0 mtu 1400
```

**해결책**: VPN, 터널(GRE, WireGuard, IPsec)을 사용하는 환경에서는 MTU 값을 더 낮게 설정해야 합니다(일반적으로 1380~1420 사이).

### 방화벽 점검 — nftables, ufw, firewalld

#### nftables (현대 커널의 기본 방화벽 프레임워크)
```bash
sudo nft list ruleset          # 전체 규칙셋 확인
sudo nft list table inet filter  # 특정 테이블 규칙 확인
```

#### ufw (간편 방화벽, Ubuntu 기본)
```bash
sudo ufw status verbose        # 방화벽 상태 상세 확인
sudo ufw allow 443/tcp         # 443 포트 TCP 허용
```

#### firewalld (RHEL/Fedora 계열)
```bash
sudo firewall-cmd --state      # 방화벽 서비스 상태 확인
sudo firewall-cmd --list-all   # 모든 설정 확인
sudo firewall-cmd --add-service=https --permanent  # HTTPS 서비스 허용
sudo firewall-cmd --reload     # 설정 재적용
```

#### SELinux 환경 추가 점검
```bash
sudo semanage port -l | grep http  # HTTP 관련 SELinux 포트 문맥 확인
sudo getenforce                    # SELinux 모드 확인 (Enforcing/Disabled)
```

### 네트워크 인터페이스와 드라이버 문제 — ethtool

```bash
sudo ethtool eth0              # 인터페이스 기본 정보
sudo ethtool -i eth0           # 드라이버 및 펌웨어 정보
sudo ethtool -S eth0           # NIC 통계 카운터 (드롭, 에러 등)
```

링크 속도, 듀플렉스 모드, 자동 협상(auto-negotiation) 설정을 확인하고, 에러 카운터가 지속적으로 증가한다면 물리적 문제(케이블, 포트, 스위치)를 의심해야 합니다.

### 커널 네트워크 파라미터 튜닝 — sysctl

```bash
# 현재 값 확인
sysctl net.ipv4.tcp_syn_retries      # SYN 재시도 횟수
sysctl net.core.somaxconn            # 최대 연결 대기 큐 크기
sysctl net.ipv4.ip_local_port_range  # 로컬 포트 범위

# 임시 변경
sudo sysctl -w net.core.somaxconn=4096

# 영구 변경
sudo tee -a /etc/sysctl.d/99-tuning.conf >/dev/null <<'SYS'
net.core.somaxconn = 4096
net.ipv4.tcp_tw_reuse = 1
net.ipv4.ip_local_port_range = 10000 65000
SYS
sudo sysctl --system  # 변경사항 적용
```

**주의사항**: 의미를 이해하지 못한 튜닝은 문제를 악화시킬 수 있습니다. 관측 → 병목 지점 파악 → 변경 → 회귀 테스트 순으로 신중하게 진행해야 합니다.

### 컨테이너 네트워킹 문제

Docker나 Podman과 같은 컨테이너 런타임은 `docker0` 브리지나 CNI 네트워크를 사용합니다.

```bash
# 컨테이너 네트워크 인터페이스 확인
ip a | grep -E 'docker0|cni|br-'

# NAT 규칙 확인 (레거시 iptables)
iptables -t nat -L -n | sed -n '1,80p'

# 또는 nftables 규칙 확인
sudo nft list ruleset | head -100
```

**주요 문제점**: 호스트 방화벽이 컨테이너의 DNAT/SNAT 경로를 차단하거나, 정책 라우팅(Policy Routing)과 충돌할 수 있습니다.

### IPv6 문제 해결

IPv6 환경에서도 동일한 도구를 `-6` 옵션과 함께 사용할 수 있습니다.

```bash
ping -6 -c 3 2001:4860:4860::8888  # IPv6 핑 테스트
ip -6 r                             # IPv6 라우팅 테이블
ss -6 -tuln                         # IPv6 소켓 상태
```

IPv6는 프라이버시 확장 주소, RA(Router Advertisement), 경로 단절 등으로 예기치 않은 경로를 사용할 수 있으므로, IPv4와 IPv6를 동시에 점검하는 것이 좋습니다.

---

## 실전 트러블슈팅 시나리오

### 시나리오 A — "웹 서비스가 느리고 간헐적으로 끊김"

```bash
# 1단계: 경로별 지연과 패킷 손실 확인
mtr -nzwc 200 example.com

# 2단계: MTU/PMTUD 문제 확인
ping -c 5 -M do -s 1472 example.com

# 3단계: 서버 측 소켓 및 큐 상태 확인
ss -s
cat /proc/sys/net/core/somaxconn

# 4단계: 패킷 수준 분석 (필요시)
sudo tcpdump -ni eth0 tcp port 443 -w web.pcap
```

### 시나리오 B — "내 서버의 443 포트가 외부에서 접근 불가"

```bash
# 1단계: 서비스 리스닝 상태 확인
ss -tulnp | grep ':443 '

# 2단계: 방화벽 및 SELinux 정책 확인
sudo ufw status
sudo semanage port -l | grep https

# 3단계: 경로 및 리턴 트래픽 확인
ip route get <client-ip>
sudo tcpdump -ni eth0 'tcp port 443 and (tcp[tcpflags] & (tcp-syn|tcp-ack) != 0)'

# 4단계: 외부에서 포트 스캔 (허가된 테스트 환경에서만)
nmap -Pn -p 443 <server-ip>
```

### 시나리오 C — "DNS는 정상이지만 실제 접속 실패"

```bash
# 1단계: DNS 해석 결과 확인
dig +short service.example.com

# 2단계: HTTP/HTTPS 레벨에서 문제 확인
curl -vI https://service.example.com

# 3단계: SNI, 인증서, 프록시 관련 문제 확인
curl -vkI --resolve service.example.com:443:<resolved-ip> https://service.example.com
```

### 시나리오 D — "VPC/온프레미스 혼합 환경에서 특정 서브넷만 통신 안 됨"

```bash
# 1단계: 라우팅 테이블 충돌 확인
ip r | grep -E '10\.|172\.|192\.168\.'

# 2단계: 정책 라우팅 규칙 확인
ip rule
ip route show table all
ip route get 10.20.30.40

# 3단계: MTU 및 터널 설정 확인
ping -M do -s 1400 10.20.30.40
```

---

## 실무 예제 모음 (바로 적용 가능)

### "서비스 재시작 후부터 502 에러 증가" — 서버 측 원인 분석

```bash
# 서비스 로그 확인
journalctl -u nginx --since "-10min" -p warning

# 소켓 통계 및 상태 확인
ss -s
ss -ant | awk '{print $1}' | sort | uniq -c

# 디스크 I/O 상태 확인 (성능 문제 가능성)
iostat -x 1 3
```

### "VPN 연결 후 특정 사이트만 접속 불가" — MTU 문제 확인

```bash
# VPN 인터페이스 MTU 확인
ip link show dev wg0

# MTU 테스트
ping -c 3 -M do -s 1372 1.1.1.1

# MTU 값 조정 (필요시)
ip link set dev wg0 mtu 1380
```

### "DNS 응답이 가끔 느려짐" — DNS 리졸버 문제 진단

```bash
# systemd-resolved 상태 확인
resolvectl status

# DNS 조회 경로 추적
dig +trace example.com
```

### "컨테이너 노드포트로 통신 불가" — 호스트 네트워크 스택 문제

```bash
# 호스트 방화벽 규칙 확인
sudo nft list ruleset | sed -n '1,200p'

# 컨테이너 네트워크 인터페이스 확인
ip a | grep -E 'cni|docker0|br-'
```

---

## 명령어 요약 표

| 진단 범주 | 주요 도구 | 주요 용도 |
|---|---|---|
| **L3 연결성** | `ping` | 지연, 패킷 손실, PMTUD 테스트 |
| **주소/라우팅** | `ip a/r/neigh` | 인터페이스, 라우팅 테이블, ARP 관리 |
| **포트/소켓** | `ss` (권장) | 리스닝 소켓, 연결 상태, 큐 관리 |
| **네트워크 경로** | `traceroute`/`mtr` | 홉별 지연, 패킷 손실 분석 |
| **DNS 해석** | `dig`/`nslookup`/`resolvectl` | DNS 레코드 조회, 리졸버 상태 확인 |
| **포트 스캔** | `nmap` | 서비스 탐지, 버전 확인 (허가 필요) |
| **패킷 분석** | `tcpdump` | 실제 네트워크 트래픽 캡처 및 분석 |
| **응용 계층 테스트** | `curl`/`nc` | HTTP/HTTPS, TCP/UDP 연결 테스트 |
| **하드웨어/드라이버** | `ethtool` | NIC 정보, 에러 통계 확인 |
| **방화벽 관리** | `nft`/`ufw`/`firewalld` | 방화벽 규칙, NAT 정책 관리 |
| **커널 튜닝** | `sysctl` | 네트워크 관련 커널 파라미터 조정 |

---

## 결론

효율적인 네트워크 트러블슈팅은 체계적인 접근법과 적절한 도구의 조합에서 비롯됩니다. **관측 → 가설 수립 → 교차 검증**의 과학적 방법론이 핵심입니다.

문제 해결 과정에서는 로컬 시스템(IP 주소, 라우팅, 포트)부터 시작하여 점차 외부로 범위를 확장해 나가는 것이 효과적입니다. `ss`, `mtr`, `tcpdump`, `curl`의 조합은 대부분의 네트워크 문제를 진단하고 위치를 특정하는 데 충분한 정보를 제공합니다.

특히 **MTU 문제, 방화벽 정책, SELinux 제한, 정책 라우팅 충돌**은 간헐적이거나 환경에 의존적인 문제의 흔한 원인입니다. 이러한 요소들을 항상 의심 목록에 포함시켜 놓는 것이 좋습니다.

마지막으로, 네트워크 트러블슈팅은 단순히 명령어를 아는 것 이상으로 시스템 전체에 대한 이해가 필요합니다. 각 도구가 제공하는 정보를 종합적으로 해석하고, 네트워크 스택의 각 계층에서 발생할 수 있는 문제들을 체계적으로 배제해 나가는 과정을 통해 보다 효율적으로 문제를 해결할 수 있습니다.