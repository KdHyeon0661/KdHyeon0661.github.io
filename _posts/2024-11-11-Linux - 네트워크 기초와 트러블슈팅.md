---
layout: post
title: Linux - 네트워크 기초와 트러블슈팅
date: 2024-11-11 19:20:23 +0900
category: Linux
---
# 네트워크 기초와 트러블슈팅 — ping, ip, netstat, ss, traceroute

## 네트워크 장애의 전형적 원인과 “5단계” 축소 전략
1) **로컬 스택**(IP/라우팅/방화벽/프로세스)
2) **LAN**(스위치/VLAN/게이트웨이·ARP)
3) **WAN/ISP**(경로·손실·지연)
4) **DNS**(이름 해석)
5) **원격 서비스**(리스닝/방화벽/애플리케이션)

**빠른 5단계 점검 순서**:
```bash
# 0. 나는 살아있나? IP가 있는가?
ip a; ip r

# 1. 게이트웨이/로컬 ARP?
ip r | grep default
ip neigh

# 2. L2/L3는 살아있나?
ping -c 3 <gateway-ip>
ping -c 3 8.8.8.8

# 3. DNS는 되는가?
dig +short example.com @1.1.1.1

# 4. 원격 서비스 포트 접속?
# 443으로 예시
ss -tS;  nc -vz example.com 443 || curl -vI https://example.com
```
- 여기서 실패 지점을 잡아 **traceroute/mtr**로 경로, **ss/tcpdump**로 포트, **nmap**으로 접근 가능성, **방화벽/정책**을 교차 검증한다.

---

## ping — ICMP 에코로 L3 연결성·지연·손실 확인
```bash
ping -c 4 naver.com          # 지정 횟수
ping -i 0.5 8.8.8.8          # 간격 0.5초
ping -s 1400 1.1.1.1         # 페이로드 크기 1400B
ping -c 10 -M do -s 1472 8.8.8.8  # PMTUD: DF(do) + 1472(payload) → 1500 MTU 테스트
```
- `-M do`: **Fragment 금지(DF)**로 **PMTUD(Path MTU Discovery)** 테스트에 유용.
- **주의**: ICMP가 차단된 환경에서는 `ping`이 실패해도 L4/TCP는 정상일 수 있다. 이때는 `curl`/`nc`로 별도 검증.

---

## ip — 현대 리눅스의 네트워킹 만능툴
### 인터페이스·주소·링크
```bash
ip a                                   # 주소
ip link                                # 링크 상태
ip link set eth0 up|down               # 링크 up/down
ip addr add 192.168.10.10/24 dev eth0
ip addr del 192.168.10.10/24 dev eth0
```

### 라우팅
```bash
ip r                                   # 라우팅 테이블
ip route get 1.1.1.1                   # 목적지에 대한 실제 경로/출구
sudo ip route add 10.10.0.0/16 via 10.0.0.1 dev eth0
sudo ip route del 10.10.0.0/16
```

### ARP/이웃
```bash
ip neigh                               # ARP/NDP 캐시
sudo ip neigh flush all
```

### 고급: 정책 라우팅(RT Tables)
```bash
# 다른 출구를 쓰는 별도 정책
echo "200 alt" | sudo tee -a /etc/iproute2/rt_tables
sudo ip rule add from 10.0.2.0/24 table alt
sudo ip route add default via 10.0.2.1 dev eth1 table alt
```

---

## netstat(구버전)/ss(권장) — 리스닝·ESTABLISHED·큐 상태
### netstat (구버전, 참고용)
```bash
netstat -tuln
netstat -tulnp | grep :80
```

### ss (대체)
```bash
ss -tuln                         # 리스닝 소켓
ss -tulnp | grep nginx          # 프로세스(PID/명) 포함
ss -ant | grep ESTAB            # ESTABLISHED 연결
ss -s                           # 통계(큐/메모리/상태)
```
- **리슨 중인데 접속이 안됨** → 방화벽(호스트/네트워크), 바인딩 주소(0.0.0.0 vs 127.0.0.1), SELinux, 리밋(backlog) 점검.

---

## traceroute / mtr — 홉별 경로·지연·손실(연속 관찰)
```bash
sudo apt install -y traceroute mtr
traceroute -n example.com          # 역조회 생략(-n)으로 속도↑
mtr -nzwc 100 example.com          # 100회 측정, 종합 통계
```
- **mtr**: traceroute + ping을 결합해 **실시간 손실/지연 변동**을 관측. 간헐적 손실/지연의 위치 식별에 유리.

---

## dig / nslookup — DNS 확인
```bash
dig +short openai.com
dig @1.1.1.1 openai.com A +noall +answer
dig example.com ANY                 # 레코드 전반 확인(권한 정책상 제한될 수 있음)
nslookup github.com
```
- **의심 포인트**: 로컬 리졸버(systemd-resolved/NetworkManager)와 퍼블릭 리졸버 결과 차이, 서치 도메인 충돌, /etc/hosts 오버라이드.

### systemd-resolved 사용 환경
```bash
resolvectl status
resolvectl query example.com
```
- `/etc/resolv.conf`가 `systemd-resolved`의 스텁(127.0.0.53)을 가리키는지 확인.

---

## nmap — 포트/서비스/버전/스크립트(신중 사용)
```bash
sudo nmap -sS -p 22,80,443 192.168.0.1
nmap -p 1-1000 localhost
nmap -A openai.com                 # OS/서비스/추적(공격적일 수 있음)
nmap -Pn example.com               # ICMP 무시 후 스캔
```
- 보안 정책 준수/허가 하에만 사용. 방화벽·IPS에 의해 차단/오탐 가능.

---

## tcpdump — 패킷 레벨에서 “실제로 오고 가는가?”
```bash
sudo tcpdump -ni any tcp port 443 -c 50
sudo tcpdump -ni eth0 host 8.8.8.8 and icmp
sudo tcpdump -ni eth0 'tcp[tcpflags] & (tcp-syn|tcp-ack) != 0' -c 20
sudo tcpdump -ni eth0 -w capture.pcap   # 후분석(Wireshark)용
```
- **증상**: SYN은 나가지만 SYN/ACK가 안 온다 → 경로/방화벽/리턴 경로 문제.
- **증상**: 서버는 SYN/ACK를 보내는데 클라이언트는 못 받는다 → **대칭 라우팅 불일치**, **중간 필터링** 가능성.

---

## curl / nc — L7/L4 가시성
```bash
curl -vI https://example.com/healthz
nc -vz example.com 443
```
- `curl -v`: TLS 핸드셰이크/리다이렉트/헤더 확인.
- `nc -vz`: L4 TCP 연결 확인(방화벽/리스닝 여부).

---

## MTU/PMTUD — “큰 패킷이 못 지나갈 때”의 교과서
- **증상**: 작은 ping/HTTP는 통과, 큰 업로드/특정 사이트는 멈춤 → **PMTUD 실패/ICMP 차단** 의심.
```bash
# 1500 MTU 경로 확인(DF=1)
ping -c 3 -M do -s 1472 8.8.8.8
# 실패한다면 인터페이스 MTU 하향 후 재시도
ip link set dev eth0 mtu 1400
```
- VPN/터널(GRE/WireGuard/IPsec) 위에서는 MTU를 더 낮게 잡아야 한다(예: 1380~1420 사이 튜닝).

---

## 방화벽 빠른 점검: nftables/ufw/firewalld
### nftables(현행 커널 디폴트 프레임워크)
```bash
sudo nft list ruleset
sudo nft list table inet filter
```

### ufw(간편)
```bash
sudo ufw status verbose
sudo ufw allow 443/tcp
```

### firewalld(RHEL/Fedora 선호)
```bash
sudo firewall-cmd --state
sudo firewall-cmd --list-all
sudo firewall-cmd --add-service=https --permanent && sudo firewall-cmd --reload
```
- **SELinux** ON 환경에서 서비스 포트/컨텍스트도 점검:
```bash
sudo semanage port -l | grep http
sudo getenforce
```

---

## 인터페이스·드라이버: ethtool / 링크 품질
```bash
sudo ethtool eth0
sudo ethtool -i eth0           # 드라이버/펌웨어
sudo ethtool -S eth0           # NIC 통계(드롭/에러)
```
- 링크 속도/듀플렉스/오토네고 검증, 에러 카운터 상승 시 케이블/포트/스위치 의심.

---

## 시스템 튜닝(sysctl) — 큐·재시도·콘트롤
```bash
# 현재 값 확인
sysctl net.ipv4.tcp_syn_retries
sysctl net.core.somaxconn
sysctl net.ipv4.ip_local_port_range

# 일시 적용
sudo sysctl -w net.core.somaxconn=4096

# 영구 적용
sudo tee -a /etc/sysctl.d/99-tuning.conf >/dev/null <<'SYS'
net.core.somaxconn = 4096
net.ipv4.tcp_tw_reuse = 1
net.ipv4.ip_local_port_range = 10000 65000
SYS
sudo sysctl --system
```
- **주의**: 의미 모르는 튜닝은 금물. 관측→병목 지점 파악→변경→회귀 테스트 순으로.

---

## 컨테이너·네임스페이스·브리지
- Docker/Podman는 `docker0`/CNI 브리지를 사용.
```bash
ip a | grep -E 'docker0|cni|br-'
iptables -t nat -L -n | sed -n '1,80p'   # 또는 nft로 NAT 규칙 확인
```
- **문제**: 호스트 방화벽이 컨테이너 DNAT/SNAT 경로를 차단, 혹은 **Policy Routing** 충돌.

---

## IPv6도 동일하게: ping -6 / ip -6 / ss
```bash
ping -6 -c 3 2001:4860:4860::8888
ip -6 r
ss -6 -tuln
```
- IPv6가 **프라이버시 확장 주소**/RA/단절로 예기치 못한 경로를 타기도 한다. v4/v6 동시 점검.

---

## 실전 트러블슈팅 시나리오

### 시나리오 A — “웹이 느리다. 간헐적 끊김”
1) 지연/손실 경로:
```bash
mtr -nzwc 200 example.com
```
2) MTU/PMTUD:
```bash
ping -c 5 -M do -s 1472 example.com
```
3) 서버 측 큐/소켓:
```bash
ss -s
cat /proc/sys/net/core/somaxconn
```
4) 패킷 드롭 위치:
```bash
sudo tcpdump -ni eth0 tcp port 443 -w web.pcap
```

### 시나리오 B — “내 서비스 443 열었는데 외부 접속 불가”
1) 리스닝 여부:
```bash
ss -tulnp | grep ':443 '
```
2) 방화벽/SELinux:
```bash
sudo ufw status
sudo semanage port -l | grep https
```
3) 경로/리턴 경로:
```bash
ip route get <client-ip>
sudo tcpdump -ni eth0 'tcp port 443 and (tcp[tcpflags] & (tcp-syn|tcp-ack) != 0)'
```
4) 외부에서 스캔(허가된 테스트망):
```bash
nmap -Pn -p 443 <server-ip>
```

### 시나리오 C — “DNS 이름은 되는데 접속은 실패”
1) 이름→IP 확인:
```bash
dig +short service.example.com
```
2) HTTP 레벨 문제 여부:
```bash
curl -vI https://service.example.com
```
3) SNI/인증서/프록시 문제 확인:
```bash
curl -vkI --resolve service.example.com:443:<resolved-ip> https://service.example.com
```

### 시나리오 D — “VPC/온프레 혼합, 특정 서브넷만 통신 안 됨”
1) 라우팅 충돌 확인:
```bash
ip r | grep -E '10\.|172\.|192\.168\.'
```
2) 정책 라우팅/테이블 히트:
```bash
ip rule; ip route show table all
ip route get 10.20.30.40
```
3) MTU/터널:
```bash
ping -M do -s 1400 10.20.30.40
```

---

## 운영 체크리스트(핵심 요약)
- **연결성**: `ip a|r`, `ping`, `traceroute/mtr`
- **포트/프로세스**: `ss -tulnp`, `curl -v`, `nc -vz`
- **패킷 관찰**: `tcpdump -ni <iface> ...`
- **DNS**: `dig/resolvectl`, `/etc/hosts` 확인
- **방화벽/보안**: `nft/ufw/firewalld`, SELinux 컨텍스트
- **MTU/경로**: `ping -M do -s ...`, 터널/클라우드 환경 주의
- **드라이버/링크**: `ethtool -S`, 케이블/스위치 의심 시 교차검증
- **튜닝**: `sysctl` 변경은 측정 기반 + 롤백 계획

---

## 명령어/툴 요약 표
| 범주 | 도구 | 한 줄 설명 |
|---|---|---|
| L3 연결 | `ping` | 지연·손실·PMTUD(DF) |
| 주소/라우팅 | `ip a/r/neigh` | 인터페이스/경로/ARP |
| 포트/소켓 | `ss`(권장)/`netstat` | 리스닝/ESTAB/큐 |
| 경로 | `traceroute`/`mtr` | 홉별 지연/손실(연속) |
| DNS | `dig`/`nslookup`/`resolvectl` | 레코드·리졸버 상태 |
| 포트 스캔 | `nmap` | 서비스/버전(허가 필요) |
| 패킷 | `tcpdump` | 실제 패킷 입출 확인 |
| HTTP/TCP | `curl`/`nc` | L7/L4 테스트 |
| 링크/드라이버 | `ethtool` | NIC 정보/에러 통계 |
| 방화벽 | `nft`/`ufw`/`firewalld` | 필터·NAT/정책 |
| 튜닝 | `sysctl` | 네트워크 커널 파라미터 |

---

## 실무 예제 모음(복붙용)

### “서비스 재시작 후부터 502 증가” — 서버 측 원인 스캔
```bash
journalctl -u nginx --since "-10min" -p warning
ss -s
ss -ant | awk '{print $1}' | sort | uniq -c
iostat -x 1 3
```

### “VPN 켠 뒤 특정 사이트만 안 열림” — MTU 확인
```bash
ip link show dev wg0
ping -c 3 -M do -s 1372 1.1.1.1
ip link set dev wg0 mtu 1380
```

### “DNS가 랜덤하게 느려짐” — 리졸버/서치 도메인 충돌
```bash
resolvectl status
dig +trace example.com
```

### “컨테이너 노드포트 통신 안됨” — 호스트 방화벽/NAT 경로
```bash
sudo nft list ruleset | sed -n '1,200p'
ip a | grep -E 'cni|docker0|br-'
```

---

## 마무리
네트워크 트러블슈팅은 **관측 → 가설 → 교차검증**의 반복이다.
- 로컬(주소·라우팅·포트) → 경로(홉별 손실·지연) → 이름 해석 → 원격 서비스 순으로 **좁혀가기**가 핵심이며,
- `ss/mtr/tcpdump/curl`의 **조합**은 대부분의 문제를 위치시킨다.
- 마지막으로 **MTU/방화벽/SELinux/정책라우팅**은 “간헐적·환경 의존” 이슈의 주범이니 항상 후보에 올려 놓자.
