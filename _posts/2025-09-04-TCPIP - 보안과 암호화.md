---
layout: post
title: TCPIP - 보안과 암호화
date: 2025-09-04 14:25:23 +0900
category: TCPIP
---
# 보안과 암호화

**(🔰 TLS 개념·핸드셰이크·인증서·HSTS, ⚙️ IPsec(전송/터널)·AH/ESP, 🚀 방화벽(State/Stateless)·IDS/IPS·세그멘테이션)**

> 이 글은 “**전송 보안(TLS)**”, “**네트워크 보안(IPsec)**”, “**경계 방어(방화벽/IDS·IPS)**”, “**세그멘테이션**”을 **설계·운영·트러블슈팅** 관점으로 정리합니다.
> 예제·체크리스트 중심이며, 수식은 MathJax로 표기합니다.

---

## 왜 ‘보안과 암호화’인가

- 트래픽은 **도청/위·변조/재생**에 노출됩니다. **TLS/DTLS/QUIC**는 **앱–앱** 구간을, **IPsec**은 **호스트/사이트–사이트** 구간을 보호합니다.
- **방화벽/IDS·IPS/세그멘테이션**은 **공격면 축소**와 **피해 확산 방지**의 기본 장치입니다.
- “암호화만 켰다”로 끝나지 않습니다. **인증서/키 수명**, **알고리즘 선택**, **로그/가시성**, **운영 런북**이 함께 맞물려야 합니다.

---

## TLS: 핸드셰이크·인증서·HSTS (🔰)

### TLS 큰 그림

- **목표**: 기밀성(암호화), 무결성(AEAD), 인증(서버/클라이언트).
- **핵심 구성**: 핸드셰이크(키 합의/서버 인증/옵션), 레코드(데이터 보호).
- **버전**: 1.0/1.1(퇴출 권고), 1.2(현역), **1.3(권장)**.

#### AEAD(예: AES-GCM, ChaCha20-Poly1305)

- **한 번에 암호화+인증** → 패딩/순서 오류 등 취약점 감소.
- 오버헤드(태그 16B 등)를 고려한 **MTU/세그먼트** 설계 필요.

---

### TLS 1.2 vs 1.3 — 핸드셰이크 비교

#### TLS 1.2 (ECDHE-RSA 가정)

```
C → S: ClientHello (버전/랜덤/서트옵션/암호군/SNI/ALPN)
S → C: ServerHello (암호군) + Certificate + ServerKeyExchange(ECDHE) + ...
C → S: ClientKeyExchange + ChangeCipherSpec + Finished
S → C: ChangeCipherSpec + Finished
(애플리케이션 데이터 시작)
```
- **RSA 키교환**은 **Perfect Forward Secrecy(전방기밀)** 없음 → *비권장*.
- **ECDHE**를 사용하면 PFS 확보.

#### TLS 1.3 (기본)

```
C → S: ClientHello + (key_share, SNI, ALPN, etc.)
S → C: ServerHello + (key_share) + EncryptedExtensions + Certificate + CertificateVerify + Finished
C → S: Finished
(애플리케이션 데이터 시작, 1-RTT)
```
- 핸드셰이크가 **짧아짐(1-RTT)**, 암호군 단순화(모두 PFS+AEAD).
- **0-RTT(옵션)**: 재방문 시 **데이터 0-RTT** 전송 가능(**재생 공격 주의**).

---

### TLS 1.3 키 스케줄(요지; HKDF)

\[
\begin{aligned}
\text{early\_secret} &= \mathrm{HKDF\text{-}Extract}(0,\ \text{PSK}) \\
\text{handshake\_secret} &= \mathrm{HKDF\text{-}Extract}(\mathrm{DeriveSecret}(\text{early\_secret},\ "derived",\ \emptyset),\ \text{ECDHE}) \\
\text{master\_secret} &= \mathrm{HKDF\text{-}Extract}(\mathrm{DeriveSecret}(\text{handshake\_secret},\ "derived",\ \emptyset),\ 0)
\end{aligned}
\]
- 모든 트래픽 키는 이 스케줄에서 파생. **키 순환/회전**이 체계화되어 있습니다.

---

### 인증서·체인·검증

- **루트(CA)** → **중간(CA)** → **서버(리프)** 로 **신뢰 체인**. 클라이언트는 로컬 **신뢰 저장소**의 루트를 믿습니다.
- **SAN(Subject Alternative Name)**가 **호스트명 매칭**의 표준(옛 CN 단독 사용 지양).
- **만료/폐기**: CRL·OCSP·**OCSP Stapling**(서버가 최신 상태를 함께 첨부)이 권장.
- **mTLS**(클라이언트 인증): 클라이언트도 인증서 제시 → API·사내간 통신에 유용.

**운영 팁**
- **키 길이/곡선**: RSA 2048+/ECC P-256/P-384 권장.
- **서명 알고리즘**: SHA-256 이상.
- **자동 갱신**: ACME(예: 90일 주기) + 다중 릴로드 안전화(runbook).

---

### 암호군·기능 선택(현대 권장)

- **TLS 1.3**만 허용 가능한 환경이면 가장 단순(내장된 세트: `TLS_AES_128_GCM_SHA256`, `TLS_AES_256_GCM_SHA384`, `TLS_CHACHA20_POLY1305_SHA256`).
- **TLS 1.2 병행 시**: `ECDHE_ECDSA/AES128-GCM` 또는 `ECDHE_RSA/AES128-GCM` 중심, **RSA 키교환/RC4/3DES**는 금지.
- **ALPN**: `h2`, `http/1.1`, `h3` 협상.
- **SNI**: 가상호스트 구분. (개인정보 보호 목적의 **ECH(Encrypted ClientHello)** 는 점진 확산 중)

---

### (🔰)

- **목표**: “이 도메인은 **항상 HTTPS**로만 접속”. 브라우저가 **강제 리다이렉트 없이** HTTP 차단.
- **헤더 예시**
```
Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
```
- **옵션**
  - `max-age`: 초 단위(보통 6–12개월).
  - `includeSubDomains`: 하위 도메인까지 강제.
  - `preload`: 주요 브라우저 **사전 목록**에 포함(등록 절차 필요).
- **주의**: 잘못 설정 시 **잠김(lock-out)** 위험. **모든 서브도메인**이 HTTPS로 준비된 뒤 적용.

**운영 단계**
1) 수일~수주 **낮은 max-age**로 시작 → 모니터링
2) 문제 없으면 **기간 확대** + `includeSubDomains`
3) 최종적으로 `preload` 고려(되돌리기 매우 어려움)

---

### TLS 실무 체크리스트

```text
- TLS 1.0/1.1 비활성, 1.2/1.3 허용
- ECDHE+AEAD, RSA 키교환 금지, PFS 보장
- 인증서 SAN·만료·체인·OCSP Stapling 확인
- HSTS 단계적 도입, preload는 마지막 단계
- 세션 재개(1.2 세션티켓/1.3 PSK) 키 롤링 주기 설정
- 로그: 실패 핸드셰이크 사유(버전/암호군/이름 불일치) 정규화
```

---

## IPsec: 전송/터널, AH/ESP (⚙️)

### 무엇을 지키나

- **L3 레벨**에서 IP 패킷을 보호. 앱 수정 없이 **호스트–호스트**, **사이트–사이트**, **원격접속**에 적용.
- **구성 요소**
  - **AH(Authentication Header)**: 무결성·인증(기밀성 X).
  - **ESP(Encapsulating Security Payload)**: **기밀성+무결성**(권장 기본).
- **모드**
  - **Transport**: **IP 페이로드만** 보호(원래 IP 헤더 유지) → **호스트–호스트**.
  - **Tunnel**: **새 IP 헤더**를 씌워 **원본 전체를 캡슐화** → **게이트웨이–게Gate**(사이트–사이트) 표준.

### SA/SPD/SAD — 데이터 경로

- **SA(Security Association)**: “한 방향” 보안 파라미터(키/알고리즘/SPI/수명).
- **SPD(Security Policy DB)**: 어떤 트래픽을 **보호/허용/드롭**할지 정책.
- **SAD(Security Association DB)**: 실제 적용할 **SA 항목** 저장.

### IKEv2(키 관리)

- **IKE_SA_INIT**: 암호군·DH 교환, SPI 협상.
- **IKE_AUTH**: 인증(서버/클라), **Child SA** 생성(실제 ESP 용).
- **재키/재협상**: SA 수명 도달 전 **재키**(Perfect Forward Secrecy 그룹 사용 권장).

**수식 직관: DH 공유비밀**
\[
g^{ab} \ (\text{mod } p) \quad\Rightarrow\quad \text{키 파생(HKDF)} \Rightarrow \text{ESP 키/IV}
\]

### NAT-T, PFS, 알고리즘

- **NAT-T**: NAT 환경에서 **UDP 4500**으로 ESP를 캡슐화.
- **PFS**: 매 Child SA마다 **새 DH 교환** → 과거 키 유출 영향 최소화.
- **알고리즘**: AES-GCM(AEAD), AES-CBC+HMAC(레거시), ChaCha20-Poly1305(경량/모바일).

### 전송 vs 터널 — 언제?

- **전송(Transport)**: 서버–서버 간 L3 보호(내부 DC 호스트 간).
- **터널(Tunnel)**: **사이트–사이트**, **원격접속**(게이트웨이–게이트웨이/클라이언트). **클라우드 VPC 간 연결** 표준.

### 사용 패턴 예시

**(A) 사이트–사이트 (본사↔지사)**
```
지사 LAN(10.20.0.0/16) —[GW]—≪ IPsec Tunnel ≫—[GW]— 본사 LAN(10.10.0.0/16)
- SPD: 소스=10.20/16 & 목적=10.10/16 → 보호(ESP 터널)
- 라우팅: 목적지에 IPsec 다음홉
```

**(B) 원격접속(VPN 클라이언트)**
```
노트북 —[IKEv2 EAP/MSCHAPv2 or mTLS]— GW — 사내
- Split Tunnel vs Full Tunnel 정책
- Always-on + 장치 인증(mTLS) 권장
```

### 트러블슈팅

```text
- SA 협상 실패: 암호군/그룹 불일치, 신뢰(anchor)/정책 누락
- NAT-T: 포트/ALG 간섭, UDP 4500/500 차단
- 경로 MTU: ESP 헤더/캡슐화 오버헤드 → MSS 클램핑/PMTUD
- 수명 만료 재키 실패: 클록/라이프타임 불일치
- 선택적 암호군 차단: 고속 장비의 오프로드 지원 여부 확인
```

**운영 체크리스트**
```text
- IKEv2 우선, PFS on, AES-GCM/ChaCha20-Poly1305
- SA 수명(예: IKE 8h/ESP 1h), 재키 여유시간 설정
- NAT-T on(필요 시), UDP/500,4500 허용
- SPD 최소권한, 라우팅 일치, 로깅/알람
```

---

## 방화벽: Stateless vs Stateful (🚀 기본/확장)

### Stateless 패킷 필터

- 각 패킷을 **독립** 평가(5-튜플·플래그·ICMP 타입 등).
- **장점**: 빠름/간단/대규모 ACL. **단점**: 연결 맥락 인지 X.

### Stateful(연결 추적)

- **SYN/ACK/FIN/RST** 상태를 추적(UDP는 타임아웃 기반).
- “**이전 아웃바운드가 만든 리턴 트래픽**”은 자동 허용(규칙 간소화).
- **NAT**와 결합이 일반적(가정/기업 게이트웨이).

### 방화벽·프록시(간단 언급)

- HTTP/SNI/ALPN/도메인 기반 정책, **WAF**(웹 취약점 차단) 등.
- 트래픽이 **암호화**되면 **TLS 종단**(프록시) 없이는 L7 인지가 제한.

### 룰 설계 패턴

```text
- 기본 거부(default deny), 필요한 서비스만 허용(화이트리스트)
- 아웃바운드도 제한(특히 서버→외부)
- 관리 평면(SSH/RDP/VPN)은 별도 세그먼트/주소에서만 허용
- 로깅/레이트리밋/IPS와 연동
```

**예시(개념, 리눅스 nftables 스타일)**
```bash
# 외부→DMZ 웹만 허용, 그 외 드롭

tcp dport {80,443} ct state new accept
ip saddr 0.0.0.0/0 drop
```

---

## IDS/IPS 개요 (🚀)

### 개념

- **IDS(침입 탐지)**: 복제 트래픽을 관찰하여 **알림**.
- **IPS(침입 방지)**: **인라인**으로 통과 트래픽을 평가해 **차단**.

### 탐지 방식

- **서명 기반**: 알려진 패턴/규칙(정확하나 **제로데이** 취약).
- **이상 탐지**(행동/통계/ML): 새로운 패턴 감지(**False Positive** 관리 필요).

### 배치

- IDS: **SPAN/TAP**로 미러링(성능 영향↓).
- IPS: 인라인(지연/성능/안정성 요구 높음). **Fail-open**/Bypass 고려.

### TLS 시대의 가시성

- E2E 암호화 증가로 **패턴 가시성 감소**. 대안:
  - **메타데이터 분석**(SNI/JA3/크기/방향성/빈도),
  - **프록시 구간**에서 복호(프라이버시·컴플라이언스 고려),
  - **엔드포인트 보안**과 연합.

---

## 세그멘테이션: L2→L3→마이크로 (🚀)

### 목적

- **Flat 네트워크**는 공격 확산에 취약. **세그멘테이션**으로 **동서(East–West)** 트래픽을 제한.

### 계층별 방법

- **L2 VLAN**: 브로드캐스트 도메인 분리.
- **L3 서브넷/VRF**: 라우팅 경계 분리, **VRF**로 **논리적 네트워크 격리**.
- **ACL/보안그룹**: 세그먼트 간 통신 화이트리스트.
- **마이크로세그먼트(호스트/하이퍼바이저)**: 워크로드 단위 정책(에이전트/가상스위치/서비스 메시).

### 설계 패턴

- **티어드(웹/앱/DB)**: 각 티어 간 **필수 포트만** 허용.
- **관리 평면 격리**: 관리용 점프호스트만 인바운드 가능.
- **제로 트러스트**: 사용자·디바이스·앱 **신원/상태 기반** 최소 권한 접근.

**예시(개념 룰)**
```text
- Web → App: TCP 8443만 허용
- App → DB: TCP 5432만 허용
- Web ↛ DB 직접 차단
- Any → Mgmt: 전면 차단, JumpHost(10.0.5.10)만 허용
```

---

## 운영·트러블슈팅 런북

### TLS

```text
- 실패 핸드셰이크: 버전/암호군/이름(SAN) 불일치 점검
- 인증서 만료 임박 알람(≥30d), 자동 갱신/릴로드 테스트
- HSTS 단계적 확대, 혼합 콘텐츠(HTTP 자원) 제거
- 0-RTT 사용 서비스: 재생 방지 정책(토큰/Idempotent 요청만)
```

### IPsec

```text
- IKE 협상 로그(WHY: NO_PROPOSAL_CHOSEN 등) 정규화
- NAT-T·포트(500/4500), ESP 패스스루 점검
- SA 라이프타임/재키 시각 로그, 시간 동기화(NTP)
- MSS 클램핑/PMTUD: 대용량만 끊김 시 우선 점검
```

### 방화벽/IDS·IPS

```text
- 룰/정책 변경은 티켓과 리뷰, 롤백 플랜 포함
- 기본 거부, 서비스별 표준 포트 프로파일 유지
- IPS는 단계적(탐지→차단), FPs 추적/튜닝
- 로그 중앙집중/지표: 차단률, 규칙 히트Top-N, 세션/초(PPS)
```

### 세그멘테이션

```text
- 자산/흐름 인벤토리(소스·목적·포트·주기) 확보
- “허용 목록” 생성 → 단계적 강제
- 예외는 **기간 한정** + 재검토
```

---

## 미니 랩(개념 중심)

### TLS 서버 하드닝(개념 nginx)

```nginx
server {
  listen 443 ssl http2;
  server_name example.com;

  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers   TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384;
  ssl_prefer_server_ciphers on;

  ssl_certificate     /etc/ssl/certs/fullchain.pem;
  ssl_certificate_key /etc/ssl/private/privkey.pem;
  ssl_stapling on; ssl_stapling_verify on;

  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

  # 앱 블록…
}
```
> 실제 값/경로/옵션은 배포 판올림과 정책에 맞춰 조정하세요.

### IKEv2 사이트–사이트(개념 흐름)

```text
- 제안(Proposal): AES-GCM-256 / PRF SHA-256 / DH Group 14
- IKE SA 수립 → 인증(mTLS/PSK) → CHILD SA(ESP) 생성
- SPD: 10.10.0.0/16 ↔ 10.20.0.0/16 보호
- NAT-T on, DPD(Dead Peer Detection) 10s/3회
```

### 세그멘테이션 검증

```text
- Web→DB 직접 연결 시도: 차단 로그 기대
- App→DB 정상(5432), 그 외 포트 차단
- 관리망은 JumpHost만 성공(소스IP 고정)
- 스캐너로 포트 스윕 → “허용 외 전부 폐쇄” 확인
```

---

## 자주 보는 문제–원인–조치

| 증상 | 흔한 원인 | 1차 조치 |
|---|---|---|
| HTTPS 접속 실패(일부 지역) | 중간 프록시/레거시 TLS1.0만 지원 | TLS1.2 fallback 허용 여부 검토, 모던화 가이드 |
| 인증서 에러 | 만료/체인 누락/SAN 불일치 | 체인 포함 배포, SAN 교정, 자동갱신 |
| TLS 핸드셰이크 느림 | OCSP 실패/대형 인증서·CRL 조회 | OCSP Stapling, 캐시/짧은 체인 |
| IPsec 터널 간헐 끊김 | 재키 타이밍/클록 불일치 | NTP, 라이프타임·DPD 재설정 |
| 대용량 파일만 실패 | PMTUD 실패/ESP 오버헤드 | MSS 클램핑/ICMP 허용 |
| IPS 오탐으로 서비스 다운 | 서명 과격/인라인 튜닝 미흡 | “탐지→차단” 단계적 도입, 예외 룰 |
| 내부 확산 의심 | 세그멘트 부족/기본 허용 | 세그멘테이션·화이트리스트 전환 |

---

## 보안·암호화 베스트 프랙티스(요약 카드)

- **TLS**: 1.3 우선, 1.2 최소화. ECDHE+AEAD, HSTS 단계 도입, OCSP Stapling, 자동갱신.
- **IPsec**: IKEv2+ESP+PFS, NAT-T, SA 수명/재키, MSS/PMTUD.
- **방화벽**: 기본 거부/화이트리스트, 상태 추적, 아웃바운드도 최소권한.
- **IDS/IPS**: 서명+이상 하이브리드, 인라인은 점진, 로그 중앙화.
- **세그멘테이션**: VLAN/VRF/보안그룹/마이크로세그, 관리망 분리, 제로 트러스트 지향.
- **운영**: 런북/롤백, 알람 기준, 주기적 침투테스트·리뷰.

---

## 한 장 요약(포스터)

- **TLS**는 **앱–앱** 보호: 1.3, PFS, AEAD, HSTS.
- **IPsec**은 **L3** 보호: ESP 터널로 사이트–사이트/원격접속, IKEv2+PFS.
- **방화벽**은 **정책의 문지기**, **IDS/IPS**는 **센서/차단기**.
- **세그멘테이션**은 **피해 확산 방지의 마지막 보루**.
- **운영·가시성·자동화**가 곧 **보안 품질**이다.

---

### 부록 A — 용어 빠른 참조

```
TLS 1.3, AEAD(GCM/ChaCha20-Poly1305), PFS(ECDHE), ALPN, SNI, ECH,
HSTS, OCSP Stapling, mTLS,
IPsec, IKEv2, SA/SPD/SAD, AH/ESP, NAT-T, PFS, Child SA,
Stateless/Stateful FW, WAF, IDS/IPS(서명/이상),
세그멘테이션(VLAN/VRF/보안그룹/마이크로), 제로 트러스트
```

### 부록 B — 점검 템플릿

```text
[자산] 도메인/인증서/키/CA/수명, IPsec 터널 목록, 방화벽 룰, 세그먼트 지도
[정책] 허용 목록, 암호군/버전, PFS/ECN, IPS 모드
[가시성] 실패 핸드셰이크/SA재키/차단 로그/탭-메타데이터
[테스트] 브라우저/CLI/모바일, 경계/클라우드 경로, netem 손실/지연
[운영] 런북/롤백, 자동갱신, 키 롤링, 정기 감사·리뷰
```
