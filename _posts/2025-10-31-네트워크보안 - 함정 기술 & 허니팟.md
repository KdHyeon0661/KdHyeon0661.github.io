---
layout: post
title: 네트워크보안 - 함정 기술 & 허니팟
date: 2025-10-31 22:25:23 +0900
category: 네트워크보안
---
# 27. 함정 기술(Deception) & 허니팟

> 목표  
> - **Low/High Interaction** 허니팟의 선택 기준(위험·효과·운영 난이도·가시성)을 명료화한다.  
> - **Lateral Movement 유인 전략**(AD/SMB/클라우드·크리덴셜·포트폴리오형 미끼)으로 **조기 탐지**와 **행위 수집**을 노린다.  
> - 수집된 이벤트를 **로깅·포렌식** 파이프라인(Zeek/Suricata/EDR/SIEM)으로 연계하고, **증거 보존**·**타임라인링** 절차를 문서화한다.  
> - **실습**: 컨테이너 기반 **미니 허니넷**(외곽/내부, L2/L3, 윈도/리눅스 프로토콜 혼합)을 구축하고, **허니토큰**·**SMB/SSH/HTTP** 미끼, **대시보드/플레이북**까지 완결한다.

---

## 27.1 Low/High Interaction 선택

### 27.1.1 개념 요약
- **Low Interaction**: 프로토콜 핸드셰이크/배너/기초 명령만 에뮬레이션.  
  - 예: **OpenCanary**, **Cowrie(SSH/Telnet 에뮬)**, **Dionaea(악성코드 수집)**, **HoneyDB 에이전트**.  
  - **장점**: 안전(격리 용이), 대량 배치, 운영 간단, 오탐↓(스캔·브루트포스 탐지에 강함).  
  - **단점**: 공격자의 **심층 TTP**(권한 상승/측면 이동/도구 사용법) 수집 한계.  
- **High Interaction**: 실제 OS/서비스를 **진짜로** 운영(샌드박스/스냅샷).  
  - 예: **가상 머신에 진짜 IIS/SMB/AD 조각**, 컨테이너에 진짜 DB.  
  - **장점**: **실전 행위**(익스플로잇 체인/도구 다운로드/측면 이동) 수집, 위장성 최고.  
  - **단점**: **위험**(탈주·피벗), 운영 난이도↑, 롤백/격리 장치 필요.

### 27.1.2 선택 매트릭스

| 상황 | 권장 | 이유 | 주의 |
|---|---|---|---|
| 외곽(인터넷 노출) 스캔·봇넷 탐지 | **Low** (OpenCanary+Dionaea) | 무차별 스캔/암호대입 조기 경보 | 송수신 제한, 다운로드 차단 |
| 내부망 조기 탐지(크리덴셜 탈취/SMB) | **Low+중간** (Cowrie/SMB 에뮬+허니토큰) | 가벼운 배치, 크리덴셜 악용 즉시 탐지 | 비즈니스 서비스와 혼동 방지 |
| 레드팀/고급 TTP 수집 | **High** (진짜 OS/AD 조각) | 권한 상승/측면 이동 전체 체인 관찰 | 스냅샷·VFIREWALL·아웃바운드 봉쇄 |
| 클라우드 액세스 키 오남용 탐지 | **허니토큰**(AccessKey/DB DSN) | 사용 즉시 외부 콜백 | 키 유출 경로 추적 로깅 |

### 27.1.3 운영 KPI
- **MTTD**(평균 탐지 시간): 허니팟 노출 후 이벤트 발생까지 시간.  
- **커버리지**: 네트워크 구간/세그먼트별 **미끼 존재율**.  
- **품질**: **행위 밀도**(이벤트당 고유 TTP 수), **분기 의사결정**(차단·조사)까지 연결되는 비율.  
- **안전성**: 아웃바운드 차단 비율, 스냅샷 롤백 시간.

---

## 27.2 Lateral Movement 유인 전략

### 27.2.1 AD/자격증명 미끼
- **허니 계정**: `svc_backup_ro` 같은 그럴듯한 **비활성** 계정(로그온 금지), **스프레이/티켓 요청** 시 알림.  
- **SPN Honey**: Kerberoasting 유인용 **서비스 계정 SPN**(예: `HTTP/hub.corp.local`), 티켓 요청 Event 4769 알림.  
- **LSASS 미끼 크리덴셜**: 허위 자격증명을 **메모리/파일**에 심고 접근 시 탐지.  
- **네트워크 드라이브/SMB 쉐어**: `\\files\Projects\_Archive` 같은 공유에 **허니토큰** 문서 배치.

**윈도: Kerberos 티켓 요청 모니터링(Sigma 개념)**  
```yaml
title: Kerberoast Honey SPN Request
logsource: { product: windows, service: security }
detection:
  sel:
    EventID: 4769
    ServiceName: HTTP/hub.corp.local
condition: sel
level: high
tags: [attack.t1558.003, deception]
```

### 27.2.2 파일·DB·코드 레벨 허니토큰
- **문서 토큰**: 내부 문서(엑셀/워드)에 **웹 비콘**(외부 1px 이미지) 또는 **고유 URL** 삽입 → 열람시 호출.  
- **DB DSN/커넥션 스트링**: 코드·설정에 가짜 DSN(접속 시 **블랙홀 프록시**로 연결 → 알림).  
- **API Key/Cloud AccessKey**: 미리 등록되지 않은 **미끼 키**를 유출 가능 위치(깃/공유)에 배치 → 사용 시 **Webhook**.

**간단 허니 비콘(Flask)**
```python
# beacon.py
from flask import Flask, request
app = Flask(__name__)

@app.route("/b/<tid>.png")
def beacon(tid):
    ip = request.headers.get("X-Forwarded-For", request.remote_addr)
    ua = request.headers.get("User-Agent","?")
    # TODO: SIEM 전송/Slack 알림
    print("[BEACON]", tid, ip, ua)
    return b"\x89PNG\r\n\x1a\n", 200, {"Content-Type":"image/png"}  # 1px 생략

# 문서에 https://beacon.corp/b/INV123.png 삽입
```

### 27.2.3 네트워크·포트·배너 미끼
- **배너 인텔**: `OpenSSH_7.9p1 Debian-10` 같은 **그럴듯한 구버전 배너**(실제 취약점은 없음).  
- **포트 라벨링**: 비표준 포트에 **SMB/HTTP 배너** 노출(스캐너 낚기용).  
- **DNS 미끼**: 내부 전용 도메인에 **허니 A/AAAA** 생성 → 외부 획득 시 **DNS 질의**만으로 알림.

**OpenCanary 설정(발췌)**
```json
{
  "device.node_id":"edge-canary-01",
  "ftp.enabled": false,
  "http.enabled": true,
  "http.port": 8080,
  "http.banner": "nginx/1.18.0",
  "ssh.enabled": true,
  "ssh.port": 22,
  "ssh.version": "OpenSSH_7.4p1 Debian-10",
  "smb.enabled": true,
  "smb.filelist": ["\\HR\\Salary_2022.xlsx","\\Projects\\Roadmap.pptx"],
  "logger": {"class": "PyLogger","handlers": {"class": "TimedRotatingFileHandler","filename": "canary.json"}}
}
```

### 27.2.4 클라우드·SaaS 미끼
- **S3 허니 버킷 이름**(private) + 가짜 크리덴셜 → 접근 시 **CloudTrail**로 알림.  
- **IAM Role 이름 미끼**: `AdminEmergency` 존재만(권한 X)… STS AssumeRole 실패/시도 감지.  
- **Git 허니 리포지토리/Issue**: 내부 토큰 단서가 있는 듯 보이게 구성(실제는 콜백만).

---

## 27.3 로깅·포렌식 연계

### 27.3.1 수집 경로
- **네트워크**: SPAN/TAP → **Zeek/Suricata**(배너·프로토콜·파일 추출)  
- **호스트**: EDR/Sysmon(프로세스/파일/네트워크), 윈도 이벤트(4624/4769/5140 등)  
- **허니팟 앱 로그**: Cowrie(OpenSSH 유사 세션 로그), Dionaea(샘플 해시/URL), OpenCanary(JSON 이벤트)  
- **허니토큰 비콘**: Webhook/Flask → SIEM 인덱싱

**Filebeat 입력 예(허니 로그 수집)**
```yaml
filebeat.inputs:
  - type: filestream
    id: cowrie
    paths: ["/var/log/cowrie/cowrie.json"]
    fields: { app: "cowrie" }
  - type: filestream
    id: canary
    paths: ["/opt/opencanary/canary.json"]
    fields: { app: "opencanary" }
  - type: filestream
    id: dionaea
    paths: ["/var/log/dionaea/*.json"]
    fields: { app: "dionaea" }
output.elasticsearch:
  hosts: ["http://es:9200"]
  index: "honey-%{[fields.app]}-%{+yyyy.MM.dd}"
```

### 27.3.2 지표·탐지 룰
- **지표**:  
  - 서비스별 **첫 접촉 시간**, TOR/클라우드 ASN 비율, **시도/성공 로그인 비율**, 세션 평균 길이/명령 다양도.  
  - 허니토큰 **클릭 경로**(Referrer/UA), 외부 IP 지리/ASN.  
- **탐지 룰**(예시):
  - **허니 계정 로그인 시도** → **Critical**(즉시 티켓+블록)  
  - **SMB 허니 파일 열람** → 내부 측면 이동 의심, 해당 자산 EDR 격리  
  - **Cowrie에서 `wget|curl` + 실행** → 샘플 URL 추출 → **샌드박스 분석**

**Elastic KQL 예**
```kql
(index:honey-cowrie-*) and event.action: "login.failed" and user.name: "svc_backup_ro"
```

### 27.3.3 포렌식: 캡처/보존/타임라인
- **PCAP 링버퍼**: 허니넷 인터페이스에 **pcap-ring(최소 24h)**, 이벤트 발생 시 **N분 전후 스냅샷** 보존.  
- **증거 해시**: 파일/샘플은 SHA-256 해시 기록, **WORM 저장소**로 복사.  
- **타임라인**:  
  - `Cowrie(session start)` → `Zeek(conn/http/dns)` → `Suricata(alert)` → `EDR(process)` → `Canary(beacon)`  
  - **공통 타임스탬프(UTC)** 및 **호스트 라벨** 사용.

**tcpdump 링버퍼**
```bash
sudo tcpdump -i eth1 -w /pcap/honey-%Y%m%d%H%M.pcap -G 300 -W 288 -s 256 -Z root \
  '(tcp or udp) and (port 22 or port 80 or port 445)'
# 5분 단위 24시간(288개) 순환 캡처
```

---

## 27.4 실습: 미니 허니넷 구축

> **구성 목표**  
> - **Front(외곽 형식)**: Cowrie(SSH), OpenCanary(HTTP/SMB), Dionaea(악성 샘플 흡수)  
> - **Sensor**: Zeek + Suricata(미러 인터페이스)  
> - **SIEM**: Elasticsearch + Kibana(대시보드), Filebeat/Logstash 옵션  
> - **허니토큰**: Flask Beacon + 토큰 생성 스크립트  
> - **안전장치**: 아웃바운드 **차단**, egress 필요 시 **프록시**를 통해서만

### 27.4.1 네트워크 다이어그램(논리)
```
[Attacker or Test Host]
          |
       (veth)
          |
   [Front Net]  ---mirror---> [Sensor Net]
   |  cowrie     |             |  zeek
   |  canary     |             |  suricata
   |  dionaea    |             |
   +---------------------------+--> [Filebeat → ES/Kibana]
                          \
                           +--> [beacon(Flask)]
```

### 27.4.2 Docker Compose (핵심)

```yaml
# docker-compose.yml
version: "3.9"
networks:
  front:
  sensor:
services:
  cowrie:
    image: cowrie/cowrie
    networks: [front]
    ports: ["2222:2222"]  # 외부 노출 포트(SSH 에뮬)
    environment:
      - COWRIE_TELNET_ENABLED=false
    volumes:
      - ./vol/cowrie:/cowrie
  canary:
    image: thinkst/opencanary
    networks: [front]
    ports: ["8080:8080","445:445"]   # HTTP/SMB 데모
    volumes:
      - ./conf/opencanary.json:/root/.opencanary.conf
      - ./vol/canary:/var/log/opencanary
  dionaea:
    image: dtagdevsec/dionaea
    networks: [front]
    ports: ["21:21","80:80","443:443","445:445"]
    volumes:
      - ./vol/dionaea:/opt/dionaea/var/log
  zeek:
    image: blacktop/zeek
    command: ["-i","eth0"]
    networks: [sensor]
    volumes:
      - ./vol/zeek:/pcap
  suricata:
    image: jasonish/suricata
    networks: [sensor]
    cap_add: ["NET_ADMIN"]
    command: ["-i","eth0","-k","none","-S","/etc/suricata/rules/ti.rules"]
    volumes:
      - ./vol/suricata:/var/log/suricata
      - ./rules:/etc/suricata/rules
  filebeat:
    image: elastic/filebeat:8.13.0
    user: root
    networks: [sensor]
    volumes:
      - ./conf/filebeat.yml:/usr/share/filebeat/filebeat.yml
      - ./vol:/var/log/vol:ro
  elasticsearch:
    image: elasticsearch:8.13.0
    environment: [ "discovery.type=single-node", "xpack.security.enabled=false" ]
    networks: [sensor]
    ports: ["9200:9200"]
  kibana:
    image: kibana:8.13.0
    environment: [ "ELASTICSEARCH_HOSTS=http://elasticsearch:9200" ]
    networks: [sensor]
    ports: ["5601:5601"]
  beacon:
    build: ./beacon
    networks: [front]
    ports: ["9090:9090"]
```

> **주의**  
> - SMB/445 포트는 **동작만** 에뮬레이트. 실제 파일 쓰기/실행 차단 모드 권장.  
> - 외부 노출 시 방화벽으로 **이 아키텍처만** 접근 허용(테스트 클라이언트의 소스 IP 제한).

### 27.4.3 OpenCanary 설정 예시
```json
{
  "device.node_id":"hn-canary-01",
  "http.enabled": true,
  "http.port": 8080,
  "http.skin": "nasLogin",
  "smb.enabled": true,
  "smb.share_list": ["HR","Projects","_Archive"],
  "smb.auditfile": "/var/log/opencanary/smb_audit.log",
  "logger": {
    "class": "PyLogger",
    "handlers": {
      "class": "TimedRotatingFileHandler",
      "filename": "/var/log/opencanary/canary.json"
    }
  }
}
```

### 27.4.4 Suricata 허니 룰(간단)
```suricata
alert http any any -> any any (msg:"HONEY HTTP login attempt"; http.method; content:"POST"; http.uri; content:"/login"; sid:900001; rev:1;)
alert smb any any -> any any (msg:"HONEY SMB access"; flow:to_server,established; sid:900002; rev:1;)
```

### 27.4.5 허니토큰(문서) 자동 생성 스크립트
```python
# make_tokens.py
import uuid, pathlib
TEMPLATE = """Confidential - Do not distribute
Project: Alpha
Access Gateway: https://beacon.local/b/{tid}.png
"""
out = pathlib.Path("./tokens"); out.mkdir(exist_ok=True, parents=True)
for i in range(10):
    tid = uuid.uuid4().hex[:12]
    (out/f"Alpha_{i}.txt").write_text(TEMPLATE.format(tid=tid), encoding="utf-8")
print("generated tokens in ./tokens")
```

### 27.4.6 대시보드(핵심 위젯)
- **Top 접속 원천 ASN/TOR 비율**(Cowrie/Canary/Dionaea 합산)  
- **First Contact 타임라인**(신규 소스 IP/도메인/UA)  
- **SMB 허니 파일 열람 목록**(호스트·사용자·시간)  
- **허니토큰 비콘 히트**(문서 ID→자산/프로젝트 매핑)  
- **명령 상위**(Cowrie `grep|uname|wget|curl|python` 등 빈도)

**Kibana KQL(예)**
```kql
(index:honey-*) and fields.app : "cowrie" and event.action: "command.input"
| stats count() by process.args
| sort count desc
```

### 27.4.7 플레이북(반응 절차)

**1) 허니 계정/허니 SPN 접촉**  
- 즉시 **High/Critical** 티켓 → AD 보안 팀 알림  
- 접촉 호스트의 **EDR 격리**(네트워크 봉쇄), 직전 24h 로그인/티켓 타임라인 수집  
- 동일 세그먼트 **허니 쉐어/토큰** 추가 투하(가시성 확대)

**2) Cowrie 명령 실행 + 다운로드 URL 발견**  
- URL 샌드박스 제출(격리 네트워크), 해시/행위 요약  
- Suricata 룰로 **URL/IP 임시 차단**, Proxy Category 임시 블록  
- 동일 소스 IP **레이블링**(상시 경보 가중치)

**3) 허니토큰(문서) 비콘 히트**  
- Referrer/UA/IP/Geo 확인 → 외부 유출 가능 경로 역추적  
- 내부지표: 최근 문서 접근한 사용자 리스트 → 계정 비밀번호 교체/세션 무효화  
- 재발 방지: 저장소 접근 제어·링크 만료 정책 강화

### 27.4.8 안전 장치·테스트
- 컨테이너/VM **스냅샷** 및 **정기 롤백**(크론)  
- 아웃바운드 **기본 차단** + **허용 목록**만 열기  
- **격리 네트워크**에서만 동작하는 **DNS/HTTP 프록시**  
- **부하 테스트**: 스캐너(예: nmap)·ssh brute(패스워드 목록)·SMB 열람 스크립트로 알림 흐름 검증

**간단 SSH 브루트 시뮬레이터**
```bash
#!/usr/bin/env bash
for p in password1 qwerty admin admin123 welcome; do
  ssh -p 2222 root@127.0.0.1 "exit" -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no 2>/dev/null <<EOF
$p
EOF
done
```

---

## 부록 A. 위험·윤리·법적 고려
- 운영망/고객망에서 **실 트래픽 유도** 목적의 함정은 법적 분쟁 소지. **테스트·보안 목적으로만**.  
- 수집 데이터에 **개인정보**가 포함되지 않도록 **최소 수집**·**익명화** 적용(특히 SMB/HTTP 헤더/로그).  
- **Outbound 악성 전파 금지**: 허니넷에서 외부로 악성 파일/스캔 **발신 차단**.  
- 모든 변경은 **승인 절차(변경관리)** 및 **롤백 계획**을 둔다.

## 부록 B. 체크리스트
- [ ] 세그먼트별 미끼 1개 이상(SSH/SMB/HTTP)  
- [ ] 허니 계정/허니 SPN/허니 쉐어 구성  
- [ ] 허니토큰(문서/API Key/DSN) 발급·시딩 문서화  
- [ ] 로깅 파이프라인(Zeek/Suricata/EDR/Filebeat→ES) 정상  
- [ ] 대시보드/경보 룰(티켓 시스템 연계)  
- [ ] 아웃바운드 차단/스냅샷/롤백 스크립트  
- [ ] 월간 리허설(가짜 침해 시나리오 연습)

---

## 요약
- **Low vs High**는 **위험·운영 비용·목표 TTP**로 결정한다. 외곽/대량 탐지는 **Low**, 내부 측면 이동 감시는 **Low+허니토큰**, 레드팀·심층 TTP는 **High**.  
- **Lateral Movement 유인**은 **AD·크리덴셜·SMB·문서·클라우드 키**에서 작은 **징후**를 빨리 포착하는 데 초점.  
- **로깅·포렌식**은 **Zeek/Suricata/EDR/SIEM**으로 통합하고, **PCAP 링버퍼**와 **타임라인**을 기본값으로.  
- 실습 **미니 허니넷**으로 **배치→탐지→경보→플레이북**의 **폐루프**를 완성하라.
