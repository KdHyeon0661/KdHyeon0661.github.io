---
layout: post
title: TCPIP - NAT, NAPT
date: 2025-08-29 21:25:23 +0900
category: TCPIP
---
# NAT/NAPT

**(🔰 소스 NAT·포트 변환(PAT)·포트포워딩, ⚙️ CGNAT·Hairpin NAT·ALG, 🚀 P2P·VoIP·게임/원격접속 영향)**

> 이 글은 NAT의 **원리/종류/동작**을 실무 감각으로 정리합니다.
> “SNAT ↔ DNAT/포트포워딩 ↔ NAPT(PAT)”의 기본부터 **CGNAT/Hairpin/ALG**, 그리고 **P2P·VoIP·게임·원격접속**에 미치는 효과까지 **예제·다이어그램·체크리스트**로 설명합니다.

---

## 왜 NAT를 이해해야 하나

- 사설 IPv4를 공인 IPv4로 **많이/안전하게 공유**하기 위한 기술이 **NAT/NAPT**입니다.
- NAT는 “연결 추적(state)”이 핵심이므로 **성능·가용성·보안·트러블슈팅** 모두에 영향.
- P2P/VoIP/게임/원격접속은 **인바운드 연결**을 자주 쓰거나 **UDP**에 의존 → NAT의 세부 동작(포트 보존/랜덤화, 매핑 시간, 필터 규칙)에 따라 성공/실패가 갈립니다.

---

## NAT 용어 지도(큰 그림)

| 용어 | 의미 | 다른 이름/관용 |
|---|---|---|
| **SNAT** | 출발지 주소 변환(사설→공인) | Source NAT |
| **DNAT** | 목적지 주소 변환(공인→사설) | Destination NAT |
| **NAPT(PAT)** | 주소 + **포트**까지 변환 | Port Address Translation, Overload NAT |
| **포트포워딩** | 특정 공인IP:포트를 **내부 호스트**에 정적 연결 | Static DNAT |
| **Hairpin NAT** | 내부 클라이언트가 **자기 조직의 공인IP**로 접속할 때 NAT가 다시 내부로 **반사(loopback)** | NAT Loopback/Reflection |
| **ALG** | L3/L4 장비가 **응용 프로토콜 내 IP/포트**를 읽고 수정 | SIP/FTP ALG 등 |
| **CGNAT** | 통신사 규모(NAT444) NAT | 캐리어그레이드 NAT |
| **UPnP/PCP/NAT-PMP** | 앱이 **라우터에 포트 개방/매핑** 요청 | 자동 포트 포워딩 |

---

## NAPT(PAT)의 핵심 동작(🔰)

### “한 공인IP로 다 같이 나가기”

```
[내부] 192.168.1.10:54321  \
[내부] 192.168.1.11:55555   \   (출발)                     (도착)
[내부] 192.168.1.12:60001    >  NAT → 공인 203.0.113.5:40001 → 인터넷
                              /         203.0.113.5:40002
                             /          203.0.113.5:40003
```
- NAT 장비는 **(출발지 사설IP:사설포트) → (공인IP:변환포트)** 매핑을 만들고 **상대방에게는 공인IP:변환포트만** 보입니다.
- **리턴 트래픽**은 이 매핑을 보고 다시 **원래 사설IP:사설포트**로 돌려보냅니다.

### 매핑 테이블(상태)

- 키(흔한 구현): **5-튜플**(프로토콜, 출발/목적 IP와 포트)
- 항목: `내부IP:내부포트 ↔ 공인IP:외부포트 ↔ 목적지IP:목적지포트`
- **타임아웃**: UDP(짧음, 수~수십초), TCP(세션 상태별로 다름: ESTABLISHED 수분~수십분).
- **포트 보존/랜덤화**: 일부 NAT는 내부 포트를 **가능하면 보존**(예: 54321→54321), 일부는 **랜덤화**(추적 회피·보안).

### 포트포워딩(정적 DNAT)

- 예: `203.0.113.5:8443 → 192.168.1.50:443`
- 외부에서 공인IP:포트로 오면 **NAT가 목적지(내부 서버)로 바꿔** 전달.
- **상태추적**이 있으므로 응답은 자동 역방향 매핑.

---

## SNAT/DNAT/NAPT 실제 패턴(🔰)

### SNAT(소스 NAT)

- **출발지 주소**를 바꾸어 외부로 나가게 함.
- **오버로드** 모드(NAPT): **여러 내부 호스트**가 **한 공인IP**를 **포트로 구분**해 공유.

### DNAT(목적지 NAT)

- 인바운드 트래픽 **목적지**를 내부 서버로 바꿔 **서비스 노출**.
- 로드밸런서·프록시와 달리 **패킷 헤더**만 바꿀 뿐, L7 기능은 없음(단, ALG 예외).

### 1:1 정적 NAT

- 내부IP ↔ 공인IP를 **1:1로 영구 매핑**. 포트는 보통 그대로.
- DMZ 서버에 흔함(보안은 **별도 방화벽**으로 통제; NAT ≠ 방화벽).

---

## NAT의 동작 변형과 세부속성

### 필터/매핑의 종류(콘 NAT 분류 직관)

| 구분 | 설명 | 흔한 영향 |
|---|---|---|
| **Endpoint-Independent Mapping** | 목적지와 무관하게 **같은 내부 5-튜플→외부포트 유지** | P2P 친화, “Open/Type A”에 가까움 |
| **Address-Dependent Mapping** | **목적지 IP**가 다르면 외부포트가 달라질 수 있음 | P2P 일부 제한 |
| **Address+Port-Dependent Mapping (Symmetric)** | 목적지 IP/포트 바뀌면 **새 외부포트** | P2P·VoIP에 **제일 어려움** |
| **Filtering(Independent/Dependent)** | 외부에서 누가/어디서 오는 트래픽을 허용할지 | 연결 유입 난이도 결정 |

> 콘(cone)·대칭(symmetric) 용어는 구현마다 다르므로, 실제 동작은 **STUN/ICE 테스트**로 확인하는 것이 정확합니다.

### 포트/세션 수와 리소스

- **에페메럴 포트 풀**(대개 49152~65535) + NAT **포트풀**(CGNAT은 블록 할당 PBA).
- 동시 연결 수가 폭증하면 **포트고갈/테이블 고갈** → 새로운 연결 실패/지연.

### 프래그먼트 & NAT

- 일부 NAT는 **첫 번째 프래그먼트**가 없으면(5-튜플 식별 불가) 나머지를 드롭.
- UDP 대형 패킷/터널(오버레이)은 **분절 없이** 보내도록 MTU/MSS를 사전에 맞추는 것이 안전.

---

## Hairpin NAT(⚙️)

- 내부 클라이언트가 **조직의 공인IP**(또는 DDNS 이름)로 접근 → NAT가 **DNAT**로 내부 서버를 가리키고, 동시에 **SNAT**로 **소스도 NAT**하여 **역응답 경로가 NAT로 돌아오게** 만드는 기능.
```
Client 192.168.1.10 → 203.0.113.5:8443
NAT:
  DNAT 203.0.113.5:8443 → 192.168.1.50:443
  SNAT 192.168.1.10:55000 → 192.168.1.1:40001(예)
Server 192.168.1.50 → 192.168.1.1:40001 → NAT가 203.0.113.5:8443 응답으로 재작성
```
- Hairpin이 없으면 내부 클라이언트는 **자신의 공인IP로 접속 실패**(서버가 로컬 경로로 응답해 NAT 경유가 깨짐).
- **대안**: **스플릿 DNS**(내부에서는 서비스 FQDN을 **사설 IP**로 응답).

---

## ALG(Application Layer Gateway) 개요(⚙️)

- NAT가 L7 페이로드 안의 **IP/포트 텍스트**까지 읽어 변환.
- 예) **SIP ALG**: SIP/SDP에 포함된 **미디어 IP/포트** 갱신. **FTP ALG**: Active 모드의 **데이터 포트** 열어주기.

> **현장 주의**: ALG는 **표준 미준수/벤더 편차/암호화(TLS, SRTP)**로 인해 **문제**를 더 만들기도 합니다. **현대 VoIP/WebRTC/FTP Passive**는 **ALG 끄기**가 권장되는 경우가 많습니다.

---

## CGNAT(Carrier-Grade NAT)(⚙️)

- 통신사가 **가입자 사설(예: 10.x/100.64/172.16/192.168)**을 **공인IP**로 대규모 변환. (**NAT444**: 고객 CPE NAT + 통신사 NAT + 목적지)
- **장점**: 공인 IPv4 절약, 간편한 가입자 관리.
- **단점**:
  - 인바운드 포트포워딩 **불가**(공유 공인IP), P2P/게임/원격접속에 제약.
  - **로그·법집행·추적** 위해 **포트블록할당(PBA)/결정론적 NAT**와 **정밀 로깅** 필요 → 설계 복잡.
  - **추가 지연/병목**: 고성능 장비 필요, 포트·테이블 한계 관리.

**사용자 관점 해결책**
- **IPv6 사용**(End-to-end),
- **리버스 터널/VPN**(WireGuard/Tailscale/ZeroTier/OpenVPN),
- 가능하면 **고정 공인IP 상품** 선택.

---

## NAT와 프로토콜/서비스의 상호작용(🚀)

### P2P(파일공유/웹RTC 데이터채널 등)

- **문제**: **상호 인바운드** 필요, **UDP** 선호, 포트가 **동적으로** 생성.
- **해결 레이어**: **STUN → TURN → ICE**
  - **STUN**: “내 **공인IP:포트**가 뭔지” 반환(매핑 관찰).
  - **ICE**: 다양한 “**후보 경로**”(내부·공인·릴레이)를 교환하고 **실제로 연결 테스트**해 최적 선택.
  - **TURN**: 직접 연결 불가 시 **중계 서버**를 통해 릴레이(대역폭 비용↑).
- **Symmetric NAT**(Address+Port Dependent)는 **직접 연결 실패** 확률↑ → TURN 사용률 상승.

### VoIP(SIP/RTP)

- **SIP 시그널링**은 TCP/UDP 5060(또는 TLS 5061),
- **RTP/RTCP**는 **동적 UDP 포트 범위**(예: 16384–32767).
- NAT가 **미디어 포트**를 막으면 **한쪽 음성만 들림/무음**.
- 해결책: **ICE-Lite/STUN/TURN**, **SIP 프로키시/세션보더컨트롤러(SBC)**, **SIP ALG 비활성화**(권장), **고정 포트 범위**와 **방화벽 정책** 명확화.

### 게임 콘솔/PC 멀티플레이

- 플랫폼은 NAT 상태를 **Open/Moderate/Strict**(혹은 Type A/B/C)로 표기.
  - **Open**: 인바운드 가능(UPnP/포워딩/Hairpin 정상).
  - **Moderate**: 제한적 매칭/방 만들기는 어려움.
  - **Strict**: **대부분의 피어링 실패**(대칭 NAT·CGNAT 흔함).
- **UPnP/PCP**가 켜져 있으면 **게임이 자동으로 포트 개방**을 요청. 기업/공용망에서는 꺼두는 편이 안전.

### 원격접속(SSH/RDP/VNC/자체 에이전트)

- 단순 포트포워딩: `203.0.113.5:2222 → 192.168.1.10:22`
- CGNAT/대칭 NAT 환경에서는 불가 → **역방향 터널/중계형** 솔루션(클라우드 에이전트, Tailscale·ZeroTier·Remote.It 등) 사용.
- **보안 메모**: 퍼블릭 포트 오픈 시 **비밀번호 금지·키 인증·Fail2ban·FW** 필수.

---

## 운영 관점: NAT는 방화벽이 아니다

- NAT는 **주소/포트 변환**일 뿐, **보안 정책**은 별개입니다.
- 다만 **상태추적(Stateful)** 덕분에 “밖에서 먼저 들어오는” 트래픽이 **자동 차단**되는 효과가 있어 **느슨한 보호막**처럼 보일 뿐입니다.
- **명시적 방화벽 정책**(L3/L4/L7)과 **로깅**이 필수.

---

## 성능·확장성

### 테이블/포트 고갈

- 동시 연결\(N\)·흐름 churn이 클수록 NAT **conntrack**과 **해시 버킷**이 커짐.
- **관찰 지표**: 테이블 사용률, 포트풀 사용률, 포트가용 실패 카운터, 충돌률, 리밸런싱 지연.

### 처리량/지연

- NAT 자체 지연은 **µs–ms 단위**지만, **큐잉/버퍼블로트**와 합쳐지면 체감↑.
- 고속 환경은 **ASIC/오프로드/DPDK** 기반 NAT, **RSS**(Receive Side Scaling)와 **멀티큐** 튜닝 필요.

### MTU/MSS

- NAT 경유 터널/오버레이가 있으면 **실효 MTU 감소** → **MSS 클램핑** 일괄 적용(예: TCP 1452/1432 등 환경표준).

---

## 진단·트러블슈팅 체크리스트

### “연결은 되는데 끊김/무음/매칭 실패”

```text
- NAT 유형: 대칭(Symmetric)인지? (STUN 테스트/게임 NAT Type)
- 포트 타임아웃: UDP Keepalive 빈도가 충분한가? (예: 15–30s)
- ALG 개입: SIP/FTP ALG가 헤더를 망치지 않는가? (가능하면 Off)
- Hairpin: 내부에서 ‘우리 공인IP’로 접속이 필요한가? (스플릿 DNS 또는 Hairpin On)
- CGNAT: 외부에서 인바운드가 아예 불가한 환경 아닌가? (대안: TURN/VPN/역터널)
```

### “간헐 5xx/타임아웃(대용량 응답에서만)”

```text
- PMTUD 블랙홀: NAT/방화벽이 ICMP Frag Needed/Too Big을 막지 않는가?
- 프래그먼트 처리: 최초 프래그먼트 미도달 시 나머지 Drop?
- MSS 클램핑: 터널/오버레이 고려 값으로 적용 중인가?
```

### “대규모 동시접속 서비스에서 실패율 급증”

```text
- 포트풀 고갈: 에페메럴 범위 확장/포트 블록 분배(PBA) 적용?
- conntrack 테이블 크기/GC 튜닝: 해시 버킷/슬랩 메모리/워터마크?
- CPU/오프로드: LRO/GRO/RSS/멀티큐 및 드라이버 옵션 점검
```

---

## 구성·정책 베스트 프랙티스

- **문서화**: 포트포워딩 목록, Hairpin 지원, ALG 상태, UPnP/PCP 정책.
- **보안**: NAT 외에 **방화벽 ACL**(화이트리스트), 관리 포트 분리, 공개 서비스는 **리버스 프록시/LB** 권장.
- **P2P/VoIP/게임**:
  - 가능하면 **Endpoint-Independent Mapping**(포트 보존, NAT 친화)
  - **UDP keepalive** 주기 문서화(예: 20s), **ICE/TURN** 경로 준비
  - 콘솔 게임은 **UPnP/PCP 허용 범위** 최소화(지정 포트만, 임대시간 제한)
- **CGNAT**: 포트블록 크기·로그 설계(Deterministic NAT), IPv6 전개와 병행.
- **가용성**: 이중화(Active/Standby/VRRP), **GARP/NA Override**로 빠른 캐시 갱신.
- **성능**: conntrack size/timeout 표준화, 오버레이 구간 **MSS** 일괄 적용, **BFD/FRR**로 우회 경로 준비(업스트림 라우팅).

---

## 미니 랩(개념 중심)

### 랩 A — 포트포워딩과 Hairpin 검증

```text
의도: 내부/외부·공인/사설 경로를 구분하고 Hairpin 필요성 체감
절차:
  1) 203.0.113.5:8443 → 192.168.1.50:443 포워딩
  2) 외부 클라이언트로 접속 성공 확인
  3) 내부 클라이언트에서 FQDN(공인IP 응답)로 접속 시도
  4) 실패 시: Hairpin On 또는 스플릿 DNS로 내부는 사설IP 응답
기록: 성공/실패 케이스, NAT 로그(매핑 생성/히트), DNS 뷰 비교
```

### 랩 B — STUN/ICE로 NAT 성격 파악

```text
의도: NAT가 대칭인지/포트 보존인지 감지
절차:
  1) STUN 테스트 툴로 공인IP:포트 관찰
  2) 목적지 주소/포트를 바꿔가며 외부포트 변동성 확인
  3) WebRTC ICE 후보 수집 → 직접/릴레이 선택 결과 비교
결과: Endpoint-Independent vs Symmetric 경향 파악, TURN 필요성 판단
```

### 랩 C — UDP 타임아웃/Keepalive

```text
의도: NAT의 UDP 매핑 만료가 미디어/게임에 미치는 영향
절차: NAT UDP timeout을 낮추고(예: 30s) keepalive on/off 비교
관찰: 무음/세션 드롭 시점, 패킷 캡처의 재시작 패턴
```

### 랩 D — 포트/테이블 고갈 재현(저부하 환경)

```text
의도: 테이블/포트 가용 한계 체감
절차: 작은 클라이언트 팜으로 짧은 생명 UDP/TCP 연결 대량 생성
관찰: NAT 포트풀 사용률, 실패율, CPU/큐 지연, GC 이벤트
개선: 포트범위 확장, PBA, conntrack 크기/타임아웃 조정
```

---

## “현장 카드” 한 눈 체크

- **안 된다(인바운드)**: CGNAT/대칭 NAT/포워딩 미구성/ISP 차단/ALG 간섭.
- **간헐 무음**: UDP 매핑 만료/Keepalive 누락/미디어 포트 범위 불일치.
- **자기 도메인 못 접속**: Hairpin 미지원 → 스플릿 DNS 또는 기능 활성.
- **대용량 응답 끊김**: PMTUD/프래그먼트/NAT-ICMP 정책 점검, MSS 클램핑.
- **NAT 타입 Strict**: UPnP/PCP 허용 또는 TURN/VPN/역터널 대안.

---

## Q&A 미니 FAQ

**Q1. NAT 있으면 안전한가요?**
아니요. 외부 선제 인바운드가 막히는 **부수 효과**가 있을 뿐, **정책적 방어**는 별도로 필요합니다.

**Q2. IPv6에서는 NAT가 사라지나요?**
권장 아키텍처는 **NAT 없이**(엔드투엔드). 필요시 **NPTv6(프리픽스 변환)**를 사용하지만, **NAT66**은 일반적이지 않습니다.

**Q3. SIP ALG를 켜야 하나요?**
대부분 환경은 **끄는** 것이 더 안정적입니다. 대신 **ICE/TURN/SBC**를 쓰세요.

**Q4. 게임 NAT Type을 Open으로 만들려면?**
UPnP/PCP 허용(제한적), **정적 포트포워딩**, 또는 **공인IP/IPv6**/VPN(리버스) 고려.

---

## 한 장 요약(포스터)

- **NAPT**: 주소+포트 변환으로 한 공인IP를 **여럿이 공유**. 매핑/타임아웃/포트정책이 관건.
- **포트포워딩/Hairpin**: 인바운드/내부↔공인 경로 해결. **스플릿 DNS**와 세트로 운용.
- **ALG**: 일부 프로토콜 포트 개방을 돕지만 **문제 유발 빈번** → 가능하면 Off.
- **CGNAT**: 인바운드 불가·추적/로그 복잡. 사용자 대안은 **IPv6/역터널/TURN/VPN**.
- **P2P/VoIP/게임**: **STUN/ICE/TURN**과 **UPnP/PCP**(선택적) 조합. 대칭 NAT는 릴레이 의존↑.
- **성능/확장**: 포트/테이블·conntrack·MSS/MTU·오프로드 튜닝, 로깅·모니터링 필수.
- **보안**: NAT는 방화벽이 아니다. **명시적 ACL·인증·암호화**가 진짜 방어.

---

### 부록 A — 용어 빠른 참조

- **SNAT/DNAT/NAPT(PAT)**, **포트포워딩**, **Hairpin/Loopback**, **ALG**, **UPnP/PCP/NAT-PMP**, **STUN/ICE/TURN**, **CGNAT/NAT444**, **Endpoint-Independent/Symmetric**, **conntrack**, **MSS 클램핑**.

### 부록 B — 관찰 템플릿

```text
[상황] P2P / VoIP / 게임 / 원격접속 / 대용량 다운로드
[NAT 종류] 가정 NAT / 기업 방화벽 NAT / CGNAT
[증상] 매칭 실패 / 무음 / 내부에서 공인FQDN 불가 / 대용량만 타임아웃
[가설] 대칭NAT / UDP 타임아웃 / Hairpin 미지원 / PMTUD/프래그먼트
[근거] STUN 결과 / 포워딩/UPnP 로그 / ICMP 정책 / NAT 테이블/포트풀 지표
[조치] TURN/VPN/역터널 / Hairpin On·스플릿 DNS / ALG Off / MSS 클램핑 / conntrack/포트풀 튜닝
[후속] 문서화(포트, 타임아웃, 정책) / 모니터링 대시보드 업데이트
```
