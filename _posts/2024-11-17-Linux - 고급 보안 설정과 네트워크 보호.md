---
layout: post
title: Linux - 고급 보안 설정과 네트워크 보호
date: 2024-11-17 19:20:23 +0900
category: Linux
---
# 고급 보안 설정과 네트워크 보호

## 운영 원칙(요약)

- **기본 정책 DROP + 필요한 서비스만 명시 허용**
- **상태추적(ESTABLISHED, RELATED) 우선 허용**
- **로그는 레이트리밋과 함께**(로그 폭탄 방지)
- **ICMP 과도 차단 금지**(PMTU/오류 통지에 필요)
- **관리 포트(SSH)는 소스 제한 + 키 인증 + fail2ban**
- **클라우드라면** 보안그룹/네트워크 ACL/호스트 FW **역할 분담**
- **VPN**: sysctl IP 포워딩, NAT, 라우트/ DNS 푸시, MTU/MSS 조정

---

## iptables — 필수부터 고급까지 한 번에

### 테이블·체인 빠른 상기

- **filter**: 패킷 허용/거부(기본) — `INPUT`, `FORWARD`, `OUTPUT`
- **nat**: 최초 패킷의 주소 변환 — `PREROUTING`, `OUTPUT`, `POSTROUTING`
- **mangle**: TOS/TTL/마크/세그먼트 조정
- **raw**: conntrack 예외

### 최소 정책 스켈레톤(IPv4)

> 목적: **기본 DROP**, 루프백 허용, 상태추적 허용, SSH/HTTP/HTTPS 허용, ICMP 허용, 로그(제한)

```bash
# 기본 정책

sudo iptables -P INPUT DROP
sudo iptables -P FORWARD DROP
sudo iptables -P OUTPUT ACCEPT

# 공통 초반 허용

sudo iptables -A INPUT -i lo -j ACCEPT
sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# 관리/서비스 포트

sudo iptables -A INPUT -p tcp -m multiport --dports 22,80,443 -m conntrack --ctstate NEW -j ACCEPT

# ICMP 합리적 허용(IPv4)

sudo iptables -A INPUT -p icmp -m icmp --icmp-type echo-request -j ACCEPT
sudo iptables -A INPUT -p icmp -m icmp --icmp-type destination-unreachable -j ACCEPT
sudo iptables -A INPUT -p icmp -m icmp --icmp-type time-exceeded -j ACCEPT

# 후 드롭

sudo iptables -A INPUT -m limit --limit 5/second --limit-burst 20 -j LOG --log-prefix "FW DROP IN: " --log-level 6
sudo iptables -A INPUT -j DROP
```

> IPv6는 `ip6tables`로 유사하게 구성(또는 nftables로 전환 권장).

### SSH 소스 제한 + 포트녹 중간 예시

```bash
# 사무실 대역만 SSH 허용

sudo iptables -I INPUT 3 -p tcp -s 203.0.113.0/24 --dport 22 -j ACCEPT
# 그 외 SSH 드롭(룰 끝부분에 위임되므로 별도 필요 없음)

```

**포트 녹(port knocking) 간단 체감**(security by obscurity 보조책, 필수 아님):
```bash
# 예: knock 10001->10002->10003 순서로 30초 내 접근시 22 허용 (recent 모듈)

sudo iptables -N KNOCKING
sudo iptables -A INPUT -p tcp --dport 10001 -m recent --name KNOCK1 --set -j DROP
sudo iptables -A INPUT -p tcp --dport 10002 -m recent --rcheck --seconds 30 --name KNOCK1 \
  -m recent --name KNOCK2 --set -j DROP
sudo iptables -A INPUT -p tcp --dport 10003 -m recent --rcheck --seconds 30 --name KNOCK2 \
  -j ACCEPT
# 일단 10003 접속 성공 시, fail2ban과 병행해 SSH 오픈을 짧게 허용하는 스크립트와 연동 가능

```

### DDoS/스캔 완화(기초)

```bash
# SYN 폭주 방지(큐가 찰 때 도움)

sudo iptables -A INPUT -p tcp --syn -m limit --limit 30/second --limit-burst 100 -j ACCEPT
# 동일 IP 다량 스캔 제한(hashlimit)

sudo iptables -A INPUT -p tcp --syn -m hashlimit --hashlimit 50/second --hashlimit-burst 200 \
  --hashlimit-mode srcip --hashlimit-name synlimit -j ACCEPT
sudo iptables -A INPUT -p tcp --syn -j DROP
```

### 애플리케이션 보호(HTTP 기본 속도 제한)

```bash
# 초보적 요청 레이트 조절(프런트 프록시/서버 앞)

sudo iptables -A INPUT -p tcp --dport 80 -m state --state NEW -m limit --limit 50/second --limit-burst 200 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 80 -j DROP
```

> 정교한 레이트는 NGINX/Envoy/WAF·LB에서 구현 권장.

### NAT/포워딩 + MSS 클램핑(터널/VPN 구간)

```bash
# 라우터 역할: 내부 10.0.0.0/24 → 외부 인터페이스 eth0 NAT

sudo iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -o eth0 -j MASQUERADE

# PMTU 문제 회피를 위한 MSS 클램프

sudo iptables -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN \
  -j TCPMSS --clamp-mss-to-pmtu
```

### 영구화·복구

배포판에 따라:
```bash
# Debian/Ubuntu

sudo apt install iptables-persistent
sudo netfilter-persistent save
sudo netfilter-persistent reload

# 수동

sudo iptables-save | sudo tee /etc/iptables/rules.v4
sudo iptables-restore < /etc/iptables/rules.v4
```

---

## fail2ban — 로그 기반 자동 차단

### 설치·기본 구동

```bash
sudo apt install fail2ban
sudo systemctl enable --now fail2ban
```

구성 원리: **jail(감시대상)** → **filter(정규식)** → **action(차단수단: iptables/firewalld/nftables)**

### SSH 기본 Jail(요청 확장 반영)

`/etc/fail2ban/jail.local`
```ini
[DEFAULT]
banaction = iptables-multiport
bantime.increment = true
bantime.rndtime = 30m
bantime.factor = 1.5
bantime = 15m
findtime = 10m
maxretry = 5
ignoreip = 127.0.0.1/8 10.0.0.0/8 192.168.0.0/16

[sshd]
enabled = true
port    = ssh
filter  = sshd
logpath = /var/log/auth.log
backend = systemd
```

> `bantime.increment=true`로 **재범 가중**. 운영 중 오탐이 생기면 `ignoreip` 추가.

### 웹 기본 인증·워드프레스·관리 URL 보호 예시

```ini
[nginx-http-auth]
enabled  = true
port     = http,https
filter   = nginx-http-auth
logpath  = /var/log/nginx/error.log
maxretry = 3
findtime = 5m
bantime  = 1h

[nginx-404-scan]
enabled  = true
port     = http,https
filter   = nginx-404-scan
logpath  = /var/log/nginx/access.log
maxretry = 15
findtime = 5m
bantime  = 30m
```

`/etc/fail2ban/filter.d/nginx-404-scan.conf`
```ini
[Definition]
failregex = ^<HOST> - - $$.*$$ "GET .*(/wp-admin|/phpmyadmin|/manager|/admin).+" 404 .*
ignoreregex =
```

> 실제 환경 로그 포맷에 맞춰 `failregex` 조정 필요.

### 상태/운영

```bash
sudo fail2ban-client status
sudo fail2ban-client status sshd
sudo fail2ban-client set sshd unbanip 203.0.113.55
```

### firewalld/nftables 사용시

```ini
[DEFAULT]
banaction = firewallcmd-multiport
# 또는

banaction = nftables
```

---

## VPN — OpenVPN 실전(서버·클라·라우팅·DNS·MTU)

> 핵심은 **암호화 터널 + 올바른 라우팅 + DNS + NAT + MTU/MSS**.
> 서버는 UDP 1194 권장(지연·손실에 강함). 방화벽에서 포트 개방 필요.

### 서버 준비(요약)

```bash
sudo apt update && sudo apt install -y openvpn easy-rsa
make-cadir ~/openvpn-ca && cd ~/openvpn-ca
# (Easy-RSA로 CA, 서버/클라 키·인증서 생성 절차 수행)

```

### server.conf(핵심 옵션)

`/etc/openvpn/server.conf`
```conf
port 1194
proto udp
dev tun

# 암호/TLS(현대값 예시: 배포판/버전에 맞춰 조정)

tls-version-min 1.2
tls-crypt ta.key
cipher AES-256-GCM
data-ciphers AES-256-GCM:AES-128-GCM
auth SHA256
reneg-sec 0

server 10.8.0.0 255.255.255.0
ifconfig-pool-persist ipp.txt

# 클라이언트에 라우트/DNS 푸시

push "redirect-gateway def1"
push "dhcp-option DNS 1.1.1.1"
push "dhcp-option DNS 9.9.9.9"

# keepalive

keepalive 10 60
persist-key
persist-tun

# 클라이언트-클라이언트 통신 허용(필요 시)

client-to-client

# 권한/로그

user  nobody
group nogroup
verb 3
```

### 커널 포워딩 + NAT + MSS

```bash
# IP 포워딩

echo "net.ipv4.ip_forward=1" | sudo tee /etc/sysctl.d/99-vpn.conf
sudo sysctl --system

# NAT (클라우드/LB 환경은 불필요할 수 있음)

sudo iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE

# MTU 문제가 보이면 MSS 클램핑

sudo iptables -t mangle -A FORWARD -s 10.8.0.0/24 -p tcp --tcp-flags SYN,RST SYN \
  -j TCPMSS --clamp-mss-to-pmtu
```

### 서비스

```bash
sudo systemctl enable --now openvpn@server
sudo systemctl status openvpn@server
```

### 클라이언트 .ovpn 예시(전체 트래픽 경유)

`client1.ovpn`
```conf
client
dev tun
proto udp
remote vpn.example.com 1194
resolv-retry infinite
nobind
persist-key
persist-tun

remote-cert-tls server
cipher AES-256-GCM
auth SHA256
verb 3

# 전체 트래픽 VPN 경유

redirect-gateway def1
# VPN 시 DNS

dhcp-option DNS 1.1.1.1
dhcp-option DNS 9.9.9.9
```

### Split Tunneling(사내망만)

`.ovpn`에서 `redirect-gateway` 제거하고 라우트 개별 지정:
```conf
route 10.0.0.0 255.255.0.0
route 172.16.10.0 255.255.255.0
```

### per-client 정책(고정 IP/접근제어)

- server.conf에 `client-config-dir ccd`
- `mkdir /etc/openvpn/ccd`
- `ccd/client1`:
```conf
ifconfig-push 10.8.0.10 255.255.255.0
```
- 특정 네트워크 접근만 허용하려면 서버 방화벽/라우팅과 연동.

### TLS 보강 팁

- `tls-crypt`(메타데이터 은닉)·`tls-auth`
- 중간자 방지용 **서버 인증서의 CN/SAN** 점검
- 키·인증서 권한 600 유지

---

## — 경량·고성능 대안

> 간단한 키 교환 + 커널 모듈. 설정이 짧고 성능이 좋다.

### 서버

```bash
sudo apt install wireguard
wg genkey | tee /etc/wireguard/server.key | wg pubkey > /etc/wireguard/server.pub

cat <<'CONF' | sudo tee /etc/wireguard/wg0.conf
[Interface]
Address = 10.9.0.1/24
ListenPort = 51820
PrivateKey = (서버프라이빗키)

# 포워딩과 NAT은 OpenVPN과 동일 원칙 적용

SaveConfig = true
CONF

sudo systemctl enable --now wg-quick@wg0
```

### 클라이언트

```conf
[Interface]
Address = 10.9.0.2/24
PrivateKey = (클라이언트프라이빗키)
DNS = 1.1.1.1

[Peer]
PublicKey = (서버퍼블릭키)
AllowedIPs = 0.0.0.0/0, ::/0   # 전체 트래픽 경유
Endpoint = vpn.example.com:51820
PersistentKeepalive = 25
```

**AllowedIPs**에 사내망만 넣으면 Split Tunneling.

---

## SSH 하드닝(방화벽과 짝맞춤)

```bash
# /etc/ssh/sshd_config (현대 OpenSSH 가이드라인 예시)

Protocol 2
Port 22
PermitRootLogin prohibit-password
PasswordAuthentication no
PubkeyAuthentication yes
ChallengeResponseAuthentication no
UsePAM yes
X11Forwarding no
AllowUsers devkim opsuser
ClientAliveInterval 60
ClientAliveCountMax 3
MaxAuthTries 3
```
- 방화벽 **소스 제한** + **fail2ban**과 병행.

---

## 로깅·가시성(운영 필수)

### iptables 로그 → rsyslog → 파일/전송

`/etc/rsyslog.d/20-iptables.conf`
```conf
:msg, contains, "FW DROP IN:"  -/var/log/iptables_drop.log
& stop
```
```bash
sudo systemctl restart rsyslog
tail -f /var/log/iptables_drop.log
```

### journalctl로 fail2ban/OVPN 추적

```bash
journalctl -u fail2ban -f
journalctl -u openvpn@server -f
```

---

## 커널 네트워크 튜닝(요약)

`/etc/sysctl.d/99-net.conf`
```conf
net.ipv4.tcp_syncookies = 1
net.core.somaxconn = 4096
net.ipv4.tcp_max_syn_backlog = 4096
net.ipv4.tcp_fin_timeout = 30
net.ipv4.ip_local_port_range = 1024 65000
# VPN/터널 환경에서 유용한 PMTU

net.ipv4.ip_no_pmtu_disc = 0
```
```bash
sudo sysctl --system
```

---

## 실전 시나리오(끝장 체크리스트)

### 시나리오 A — 외부 HTTPS 접속 안 됨

1) `ss -tuln | grep ':443\>'` 리슨 확인
2) `sudo iptables -S` 룰 상단에 ACCEPT 있는지 확인(룰 순서 중요)
3) 클라우드 **Security Group**/LB 리스너/TG 헬스 체크
4) `tcpdump -i eth0 port 443 -w repro.pcap` 패킷 흐름 확인
5) MTU/MSS 이슈면 **MSS 클램프** 적용

### 시나리오 B — SSH 무차별 시도 급증

1) `fail2ban` 적용, `bantime.increment` 활성화
2) 관리 대역 이외 **소스 제한**(iptables `-s`)
3) 키 인증 강제, 패스워드 로그인 비활성

### 시나리오 C — VPN 연결 OK, 인터넷 안 됨

1) 서버 IP 포워딩, NAT(MASQUERADE) 적용 여부
2) 클라 라우팅(`redirect-gateway def1` 또는 AllowedIPs)
3) DNS 누수/해결(클라 DNS 설정)
4) 느리면 **MSS 클램프**/PMTU 테스트

---

## 명령어·파일 요약

| 범주 | 핵심 |
|---|---|
| 방화벽 | `iptables`, `iptables-save/restore`, `iptables-persistent` |
| 자동차단 | `fail2ban-client status`, `jail.local`, `filter.d/*`, `banaction` |
| VPN(OpenVPN) | `openvpn@server`, `server.conf`, `client .ovpn`, `push`, `MASQUERADE`, `TCPMSS` |
| VPN(WireGuard) | `wg-quick@wg0`, `wg show`, `AllowedIPs`, `Endpoint` |
| 로깅 | iptables LOG + rsyslog/journalctl |
| 튜닝 | `sysctl` 네트워크 파라미터 |

---

## 마무리

- **iptables**로 “기본 거부 + 최소 허용 + 상태추적 + 제한 로그”의 **보안 기본선**을 만든다.
- **fail2ban**으로 SSH/웹 인증 시도 **자동 완화**와 **재범 가중**을 적용한다.
- **VPN**은 라우팅·DNS·NAT·MTU/MSS까지 한 세트로 봐야 진짜 배포가 끝난다.
- 환경이 nftables/firewalld 중심이어도 **원리는 동일**하다. 팀 표준으로 본 문서의 스켈레톤을 도입하고, 실서비스 로그·트래픽 특성에 맞춰 **수치·정규식**을 조정하라.
