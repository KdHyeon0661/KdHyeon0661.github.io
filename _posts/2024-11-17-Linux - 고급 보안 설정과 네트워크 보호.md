---
layout: post
title: Linux - ê³ ê¸‰ ë³´ì•ˆ ì„¤ì •ê³¼ ë„¤íŠ¸ì›Œí¬ ë³´í˜¸
date: 2024-11-17 19:20:23 +0900
category: Linux
---
# ë¦¬ëˆ…ìŠ¤ 16í¸: ê³ ê¸‰ ë³´ì•ˆ ì„¤ì •ê³¼ ë„¤íŠ¸ì›Œí¬ ë³´í˜¸  
> iptables, fail2ban, VPN ì„¤ì •ê¹Œì§€ ì‹¤ì „ ì¤‘ì‹¬ìœ¼ë¡œ

---

## ğŸ” 1. iptables - ì „í†µì ì¸ íŒ¨í‚· í•„í„°ë§ ë°©í™”ë²½

`iptables`ëŠ” **ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì—ì„œ íŒ¨í‚·ì„ í•„í„°ë§í•˜ê³  ì œì–´**í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë°©í™”ë²½ ë„êµ¬ì…ë‹ˆë‹¤.  
í˜„ì¬ëŠ” `nftables`ë‚˜ `firewalld`ë¡œ ëŒ€ì²´ë˜ëŠ” ì¶”ì„¸ì§€ë§Œ, ì„¸ë°€í•œ ì œì–´ê°€ ê°€ëŠ¥í•´ ê³ ê¸‰ ì„¤ì •ì— ìœ ìš©í•©ë‹ˆë‹¤.

### ğŸ”§ ì²´ì¸ êµ¬ì¡°

| ì²´ì¸ | ì„¤ëª… |
|------|------|
| INPUT | ì™¸ë¶€ â†’ ë¡œì»¬ë¡œ ë“¤ì–´ì˜¤ëŠ” íŒ¨í‚· |
| OUTPUT | ë¡œì»¬ â†’ ì™¸ë¶€ë¡œ ë‚˜ê°€ëŠ” íŒ¨í‚· |
| FORWARD | ì„œë²„ë¥¼ ê±°ì³ê°€ëŠ” íŒ¨í‚· (ë¼ìš°íŒ… ì‹œ ì‚¬ìš©) |

### âœ… ê¸°ë³¸ ì‚¬ìš© ì˜ˆì‹œ

```bash
sudo iptables -L -n        # ëª¨ë“  ì²´ì¸ì˜ ê·œì¹™ ì¶œë ¥ (IP í•´ì„ ì—†ìŒ)
sudo iptables -F           # ëª¨ë“  ê·œì¹™ ì´ˆê¸°í™”
```

```bash
# SSH í—ˆìš© (22ë²ˆ í¬íŠ¸)
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# ë‚˜ë¨¸ì§€ëŠ” ì°¨ë‹¨
sudo iptables -A INPUT -j DROP
```

```bash
# ì„¤ì • ì €ì¥
sudo iptables-save | sudo tee /etc/iptables/rules.v4
```

### ğŸ§¾ ì£¼ìš” ì˜µì…˜ í‘œ

| ì˜µì…˜                  | ì„¤ëª…                                                        |
|-----------------------|-------------------------------------------------------------|
| `-A`, `--append`      | ê·œì¹™ ì¶”ê°€ (Append)                                          |
| `-I`, `--insert`      | ê·œì¹™ ì‚½ì… (Insert)                                          |
| `-D`, `--delete`      | ê·œì¹™ ì‚­ì œ (Delete)                                          |
| `-L`, `--list`        | í˜„ì¬ ê·œì¹™ ëª©ë¡ ì¶œë ¥                                         |
| `-F`, `--flush`       | ëª¨ë“  ê·œì¹™ ì´ˆê¸°í™”                                            |
| `-p`, `--protocol`    | í”„ë¡œí† ì½œ ì§€ì • (ì˜ˆ: tcp, udp, icmp ë“±)                      |
| `--dport`             | ëª©ì ì§€ í¬íŠ¸ ì§€ì •                                            |
| `--sport`             | ì†ŒìŠ¤ í¬íŠ¸ ì§€ì •                                              |
| `-s`, `--source`      | ì†ŒìŠ¤ IP ì£¼ì†Œ/ë„¤íŠ¸ì›Œí¬ ì§€ì •                                  |
| `-d`, `--destination` | ëª©ì ì§€ IP ì£¼ì†Œ/ë„¤íŠ¸ì›Œí¬ ì§€ì •                               |
| `-j`, `--jump`        | ë™ì‘ ì§€ì • (ACCEPT, DROP, REJECT ë“±)                        |
| `-v`, `--verbose`     | ìì„¸í•œ ì¶œë ¥                                                 |
| `-n`, `--numeric`     | IP/í¬íŠ¸ ë²ˆí˜¸ë¥¼ ìˆ«ìë¡œ ì¶œë ¥                                  |
| `-t`, `--table`       | í…Œì´ë¸” ì§€ì • (ê¸°ë³¸: filter, ì˜ˆ: nat, mangle ë“±)             |
| `-m`, `--match`       | í™•ì¥ ëª¨ë“ˆ ì‚¬ìš© (ì˜ˆ: state, multiport ë“±)                   |
| `--state`             | íŒ¨í‚· ìƒíƒœ ì§€ì • (NEW, ESTABLISHED, RELATED ë“±, `-m state` í•„ìš”) |

---

## ğŸ›¡ï¸ 2. fail2ban - ë¡œê·¸ì¸ ê³µê²© ìë™ ì°¨ë‹¨

`fail2ban`ì€ **ë¡œê·¸ë¥¼ ê°ì‹œí•˜ì—¬ ë¹„ì •ìƒì ì¸ ì ‘ì† ì‹œë„ë¥¼ íƒì§€í•˜ê³  ìë™ìœ¼ë¡œ ì°¨ë‹¨**í•˜ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.  
SSH, FTP, ì›¹ì„œë²„ ë“±ê³¼ ì—°ë™í•˜ì—¬ IP ì°¨ë‹¨ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### âœ… ì„¤ì¹˜ ë° ì‹¤í–‰

```bash
sudo apt install fail2ban
sudo systemctl enable --now fail2ban
```

### ğŸ”§ ì„¤ì • íŒŒì¼

- `/etc/fail2ban/jail.conf`: ê¸°ë³¸ ì„¤ì • íŒŒì¼ (ìˆ˜ì • ê¸ˆì§€ ê¶Œì¥)
- `/etc/fail2ban/jail.local`: ì‚¬ìš©ì ì •ì˜ ì„¤ì • íŒŒì¼

### âœï¸ SSH ê³µê²© ì°¨ë‹¨ ì„¤ì • (`/etc/fail2ban/jail.local`)

```ini
[sshd]
enabled = true
port    = ssh
filter  = sshd
logpath = /var/log/auth.log
maxretry = 5
bantime = 600         # ì°¨ë‹¨ ì‹œê°„ (ì´ˆ)
findtime = 300        # ìµœëŒ€ ì‹œë„ ì‹œê°„ ë²”ìœ„ (ì´ˆ)
```

### ğŸ” ìƒíƒœ í™•ì¸

```bash
sudo fail2ban-client status
sudo fail2ban-client status sshd
```

### ì‹¤ì „ ì˜ˆì‹œ

```bash
# í˜„ì¬ ì°¨ë‹¨ëœ IP ëª©ë¡ ë³´ê¸°
sudo iptables -L -n

# íŠ¹ì • jailì— ëŒ€í•œ ì„¤ì • í™•ì¸
sudo fail2ban-client get sshd config
```

---

## ğŸŒ 3. VPN ì„¤ì • (OpenVPN ê¸°ë°˜)

VPNì€ ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬ì™€ **ì•”í˜¸í™”ëœ í„°ë„ì„ í†µí•´ ì•ˆì „í•˜ê²Œ í†µì‹ **í•˜ê¸° ìœ„í•œ ë°©ë²•ì…ë‹ˆë‹¤.  
ì—¬ê¸°ì„œëŠ” OpenVPNì„ ê¸°ì¤€ìœ¼ë¡œ **ì„œë²„ êµ¬ì„±, í´ë¼ì´ì–¸íŠ¸ ì„¤ì •, ê³ ê¸‰ íŠ¸ë˜í”½ ì œì–´**ê¹Œì§€ ì‚´í´ë´…ë‹ˆë‹¤.

---

### âœ… ì„œë²„ ì„¤ì¹˜ (Ubuntu ê¸°ì¤€)

```bash
sudo apt update
sudo apt install openvpn easy-rsa
```

```bash
make-cadir ~/openvpn-ca
cd ~/openvpn-ca
```

ì´í›„ ì¸ì¦ì„œ ìƒì„±ì„ ìœ„í•´ EasyRSAë¥¼ ì‚¬ìš©í•´ CA, ì„œë²„ ì¸ì¦ì„œ, í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

#### ğŸ“¦ OpenVPN ì„œë²„ ì‹¤í–‰ ì˜ˆì‹œ

```bash
sudo cp server.conf /etc/openvpn/
sudo systemctl start openvpn@server
sudo systemctl enable openvpn@server
```

---

### ğŸ“¥ í´ë¼ì´ì–¸íŠ¸ ì„¤ì • (client.ovpn)

#### ì˜ˆì‹œ 1: ëª¨ë“  ì™¸ë¶€ íŠ¸ë˜í”½ VPN ê²½ìœ  (`redirect-gateway`)

```bash
redirect-gateway def1
```

- ì´ ì„¤ì •ì€ í´ë¼ì´ì–¸íŠ¸ì˜ **ê¸°ë³¸ ê²Œì´íŠ¸ì›¨ì´ë¥¼ VPNìœ¼ë¡œ ë³€ê²½**í•˜ì—¬, ëª¨ë“  ì¸í„°ë„· íŠ¸ë˜í”½ì´ VPN ì„œë²„ë¥¼ í†µí•´ ë‚˜ê°€ë„ë¡ í•©ë‹ˆë‹¤.
- `def1`ì€ ê¸°ì¡´ ë¼ìš°íŒ…ì„ ì•ˆì „í•˜ê²Œ ìœ ì§€í•˜ë©´ì„œ ê²½ë¡œ ìš°ì„ ìˆœìœ„ë¥¼ ë°”ê¾¸ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.

---

#### ì˜ˆì‹œ 2: DNS Push ì„¤ì •

VPN ì—°ê²° ì‹œ DNS ì„œë²„ë¥¼ ì§€ì •í•´ ì‚¬ìš©í•˜ë ¤ë©´ ë‹¤ìŒì„ ì¶”ê°€í•©ë‹ˆë‹¤:

```bash
dhcp-option DNS 1.1.1.1
dhcp-option DNS 8.8.8.8
```

- í´ë¼ì´ì–¸íŠ¸ëŠ” VPN ì—°ê²° ì¤‘ì— í•´ë‹¹ DNSë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
- DNS ëˆ„ìˆ˜ ë°©ì§€ë¥¼ ìœ„í•´ ìœ ìš©í•©ë‹ˆë‹¤.

---

#### ì˜ˆì‹œ 3: Split Tunneling (ì„ íƒí•œ íŠ¸ë˜í”½ë§Œ VPN ì‚¬ìš©)

í´ë¼ì´ì–¸íŠ¸ ì „ì²´ íŠ¸ë˜í”½ì„ VPNìœ¼ë¡œ ë³´ë‚´ê³  ì‹¶ì§€ ì•Šì„ ê²½ìš° `redirect-gateway`ë¥¼ ì œê±°í•˜ê³  ë‹¤ìŒê³¼ ê°™ì€ ë¼ìš°íŠ¸ë¥¼ ìˆ˜ë™ ì§€ì •í•©ë‹ˆë‹¤:

```bash
route 10.0.0.0 255.255.255.0
route 192.168.0.0 255.255.0.0
```

- ë‚´ë¶€ë§ì´ë‚˜ íŠ¹ì • ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ë§Œ VPNì„ í†µí•´ ì—°ê²°í•˜ê³ , ë‚˜ë¨¸ì§€ëŠ” ê¸°ì¡´ ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©

---

#### ì˜ˆì‹œ 4: IPv6 ê²½ë¡œ ìš°íšŒ

```bash
tun-ipv6
push "redirect-gateway ipv6"
```

- IPv6 íŠ¸ë˜í”½ë„ VPNì„ í†µí•´ ì•ˆì „í•˜ê²Œ ì „ì†¡ë˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
- í´ë¼ì´ì–¸íŠ¸ë„ IPv6 ì§€ì›ì´ í•„ìš”í•©ë‹ˆë‹¤.

---

## ğŸ”’ 4. ê¸°íƒ€ ë°©í™”ë²½: UFW, firewalld

| í•­ëª© | UFW | Firewalld |
|------|-----|-----------|
| ê¶Œì¥ ë°°í¬íŒ | Ubuntu | RHEL, Fedora |
| íŠ¹ì§• | ì§ê´€ì ì¸ CLI | ì˜ì—­(zone) ê¸°ë°˜ |
| ë°±ì—”ë“œ | iptables | iptables ë˜ëŠ” nftables |
| ì„¤ì • íŒŒì¼ | `/etc/ufw/ufw.conf` | `/etc/firewalld/zones/*.xml` |

### UFW ì˜ˆì‹œ

```bash
sudo ufw enable
sudo ufw allow 22/tcp
sudo ufw deny 23/tcp
sudo ufw status numbered
```

---

## ğŸ§ª ì‹¤ì „ ì˜ˆì‹œ ëª¨ìŒ

### ğŸ§± iptables

```bash
# SSH í—ˆìš©, ë‚˜ë¨¸ì§€ ì°¨ë‹¨
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
sudo iptables -A INPUT -j DROP

# ì›¹ì„œë²„ í¬íŠ¸ í—ˆìš©
sudo iptables -A INPUT -p tcp -m multiport --dports 80,443 -j ACCEPT
```

---

### ğŸš« fail2ban

```ini
[nginx-http-auth]
enabled = true
port    = http,https
filter  = nginx-http-auth
logpath = /var/log/nginx/error.log
maxretry = 3
```

---

### ğŸ” OpenVPN

```bash
# í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œ ìƒì„±
./build-key client1

# client1.ovpn ì„¤ì • ë‚´:
remote vpn.example.com 1194
proto udp
dev tun
redirect-gateway def1
dhcp-option DNS 1.1.1.1
```

---

## ğŸ“ ëª…ë ¹ì–´ ìš”ì•½

| ëª…ë ¹ì–´ | ì„¤ëª… |
|--------|------|
| `iptables`, `iptables-save` | íŒ¨í‚· í•„í„°ë§ ê·œì¹™ ì„¤ì • ë° ì €ì¥ |
| `fail2ban-client` | ì¹¨ì… ì°¨ë‹¨ ìƒíƒœ í™•ì¸ |
| `ufw`, `firewalld` | ê°„í¸ ë°©í™”ë²½ ê´€ë¦¬ ë„êµ¬ |
| `openvpn`, `easy-rsa` | VPN ì„œë²„ ë° ì¸ì¦ì„œ êµ¬ì„± |
| `dhcp-option`, `redirect-gateway` | í´ë¼ì´ì–¸íŠ¸ íŠ¸ë˜í”½ ì œì–´ ì˜µì…˜ |

---

## âœ¨ ë§ˆë¬´ë¦¬

ì´ì œ ë¦¬ëˆ…ìŠ¤ ë³´ì•ˆì˜ **í•µì‹¬ ìš”ì†Œì¸ íŒ¨í‚· í•„í„°ë§(iptables)**, **ìë™ ì¹¨ì… ì°¨ë‹¨(fail2ban)**, **ì•”í˜¸í™”ëœ VPN í„°ë„ë§(OpenVPN)**ì„ ëª¨ë‘ ìµí˜”ìŠµë‹ˆë‹¤.

ì´ ë‚´ìš©ì€ ë‹¨ìˆœ ì´ë¡ ì´ ì•„ë‹ˆë¼ **ì‹¤ì œ ì„œë²„ ë³´ì•ˆì˜ ê¸°ì´ˆ**ì´ì, ìš´ì˜í™˜ê²½ì—ì„œ í•„ìˆ˜ì ìœ¼ë¡œ í™œìš©ë˜ëŠ” ê¸°ë²•ë“¤ì…ë‹ˆë‹¤.  
ê¼­ ì‹¤ìŠµ í™˜ê²½ì—ì„œ ì§ì ‘ êµ¬ì„±í•´ë³´ë©° ì²´í™”í•˜ëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤.