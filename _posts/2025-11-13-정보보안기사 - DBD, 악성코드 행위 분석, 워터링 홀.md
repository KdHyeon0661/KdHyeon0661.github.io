---
layout: post
title: 정보보안기사 - 리버스 쉘, 루트킷
date: 2025-11-13 23:25:24 +0900
category: 정보보안기사
---
# SECTION 15 침해사고 유형별 시나리오 — 03. DBD(Drive-By Download) · 04. 악성코드 행위 분석 · 05. 워터링 홀(Watering Hole)

## 문서 목적과 범위

- **방어자(블루팀)** 관점에서 3가지 대표 시나리오를 **감지 → 분석 → 격리 → 근절 → 복구 → 사후학습** 흐름으로 정리한다.
- 실제 공격 재현/악성코드 제작/취약점 악용 **방법은 제공하지 않는다.** 예제 코드는 **모의 로그 생성/분석, 정책·규칙 설계, 포렌식 자동화**에 한정한다.
- 최신 브라우저/OS/EDR 동향을 반영해 **2025년 기준 방어 실무**에 맞춘다(예: JA3/JA4, CSP Report-To, Sysmon/Defender, EDR Telemetry).

---

## 공통 가시성 모델(데이터 소스)

```
[엔드포인트]  : 프로세스 트리, 명령행, 파일/레지스트리/스케줄러, 네트워크(프로세스 주체)
[네트워크]    : DNS(DoH 포함), 프록시/WAF/게이트웨이, TLS 핑거프린트(JA3/JA4), PCAP
[애플리케이션] : 웹/메일/프록시 로그(Referer/UA/URI/Response), 서버 측 에러·성능 지표
[무결성]      : 웹콘텐츠/패키지/이미지 해시, AIDE/Tripwire, CI/CD 아티팩트 해시
[클라우드]    : IAM/API 호출 로그, 오브젝트 스토리지 Access Log, CDN 로그
```

---

## DBD(Drive-By Download) 침해 사고 시나리오

### 개요

- **정의**: 사용자가 웹사이트를 방문하는 것만으로(혹은 클릭 1~2회 내) **악성 파일이 다운로드/실행되는** 공격 범주.
- **벡터**: 광고망(Malvertising), SEO 포이즈닝, 리다이렉트 체인/`iframe` 인젝션, 취약 플러그인 악용, 사회공학(업데이트 위장).
- **현대적 양상(2025)**: 플러그인 의존 저하로 **“사용자 보조형(Consent-assisted)”**이 다수. 서명 악용·SFX·원격 템플릿·스크립트 인젝션 조합.

### 공격 체인(방어 관점)

| 단계 | 방어 포인트 |
|---|---|
| 1. 유입(페이지 뷰) | 프록시에서 **Referer/UA/카테고리** 비이상 여부, 도메인 신규성/연령 |
| 2. 리다이렉트/스크립트 | **CSP 위반 리포트**, SRI 불일치, 의심 TLD/경유지 |
| 3. 다운로드 트리거 | 브라우저 정책(무인 자동 다운로드 차단), **MIME/확장자 불일치** |
| 4. 파일 저장 | **Zone.Identifier(ADS)**, 해시, 평판, 최초 관측(First-Seen) |
| 5. 실행 시도 | 부모 프로세스가 **브라우저**인지, **LOLBins** 호출 여부 |
| 6. 지속성/C2 | 스케줄러/런키, 외부 연결 JA3/도메인 신규성 |

### 탐지 규칙 아이디어

#### (A) 프록시/WAF: “짧은 체류+다중 리다이렉트+바이너리 다운로드”

- **시나리오**: 첫 방문 후 **<5초** 내 `application/octet-stream` 또는 PE/스크립트 MIME 다운로드.
- **필드**: `referer`, `user_agent`, `resp_content_type`, `time_taken`, `sc_status`, `cs_host`, `cs_uri_path`.

```pseudo
IF  resp_content_type IN ["application/x-msdownload","application/octet-stream","application/x-dosexec"]
AND time_taken < 5s
AND num_redirects >= 2
AND domain_reputation IN ["new","parked","suspicious"]
THEN alert "Possible Drive-By Download"
```

#### (B) 엔드포인트(Sysmon): “브라우저 → 다운로더/LOLBins → 외부 연결”

- **Event ID 1**: `chrome.exe|msedge.exe|iexplore.exe|firefox.exe`의 자식으로 `rundll32.exe`, `mshta.exe`, `powershell.exe` 등 스폰
- **Event ID 3**: 위 프로세스의 외부 연결(비표준 포트/희귀 ASN)
- **Event ID 11**: 다운로드 폴더에 PE 생성

```xml
<!-- Sysmon 개념 스니펫 -->
<RuleGroup name="DBD_ProcessChain" groupRelation="and">
  <ProcessCreate onmatch="include">
    <ParentImage condition="contains">\chrome.exe</ParentImage>
    <Image condition="end with">rundll32.exe</Image>
    <CommandLine condition="contains">http</CommandLine>
  </ProcessCreate>
  <NetworkConnect onmatch="include">
    <Image condition="end with">rundll32.exe</Image>
    <DestinationPort condition="is not">443</DestinationPort>
  </NetworkConnect>
</RuleGroup>
```

### 모의 로그 & 분석 스크립트

#### (예) 프록시 W3C 유사 로그(모의)

```
2025-11-12T02:10:01 10.10.20.5 "GET http://news.example" 200 "-" "Mozilla/5.0"
2025-11-12T02:10:02 10.10.20.5 "302 http://ad-network.tld/redirect" 302 "http://news.example" "Mozilla/5.0"
2025-11-12T02:10:03 10.10.20.5 "GET http://cdn-cool.tld/x" 200 "http://ad-network.tld/redirect" "Mozilla/5.0"
2025-11-12T02:10:04 10.10.20.5 "GET http://cdn-cool.tld/update.exe" 200 "http://cdn-cool.tld/x" "Mozilla/5.0" ct=application/octet-stream
```

#### (예) 파서(파이썬) — **짧은 체류 + 바이너리 MIME** 탐지

```python
import sys, re, datetime as dt

r = re.compile(r'(?P<ts>\S+) (?P<src>\S+) "(\w+) (?P<url>\S+)" (?P<status>\d+) "(?P<ref>[^"]*)" "(?P<ua>[^"]*)" ?(ct=(?P<ct>\S+))?')

events = []
for line in sys.stdin:
    m = r.search(line)
    if not m: continue
    ts = dt.datetime.fromisoformat(m.group('ts'))
    events.append(dict(ts=ts, src=m.group('src'), url=m.group('url'),
                       ref=m.group('ref'), status=int(m.group('status')),
                       ct=(m.group('ct') or ""), ua=m.group('ua')))

events.sort(key=lambda x:x['ts'])
for i,e in enumerate(events):
    # 단순 휴리스틱: 5초 이내 체류 + 바이너리 MIME
    if 'application' in e['ct'] and any(ext in e['url'] for ext in ('.exe','.dll','.msi','.js','.vbs','.ps1','.img','.iso')):
        prev = [p for p in events[max(0,i-5):i] if (e['ts']-p['ts']).total_seconds()<5]
        if len(prev)>=2:
            print(f"[ALERT] {e['src']} {e['url']} via {e['ref']} @ {e['ts']} UA={e['ua']} ct={e['ct']}")
```

### 윈도우 Zone.Identifier(ADS) 점검

- **의미**: 인터넷에서 내려받은 파일에 **보안 영역** 메타데이터가 붙음.
- **헌팅 스크립트(안전)**

```powershell
$downloads = "$env:USERPROFILE\Downloads"
Get-ChildItem $downloads -File -Recurse -ErrorAction SilentlyContinue |
  ForEach-Object {
    $zone = (Get-Item -LiteralPath $_.FullName -Stream Zone.Identifier -ErrorAction SilentlyContinue)
    if ($zone) {
      $stream = Get-Content -LiteralPath $_.FullName -Stream Zone.Identifier -ErrorAction SilentlyContinue
      if ($_.Extension -match '\.(exe|dll|msi|js|vbs|ps1|img|iso)$') {
        [PSCustomObject]@{ Path=$_.FullName; Zone=$stream -join ';' }
      }
    }
  }
```

### 대응 플레이북(요약)

1. **격리**: 의심 호스트 EDR 네트워크 격리, **다운로드 도메인** 임시 차단.
2. **근절**: 다운로더/지속성 제거(런키/스케줄러), 브라우저 정책 재점검(자동 다운로드 차단).
3. **복구**: 클린 이미지/프로필 복구, 캐시/확장 기능 정리.
4. **사후학습**: 프록시 룰/JAR3 화이트리스트·블랙리스트 보완, 사용자 경고 배너, 안전 브라우징 교육.

---

## 악성코드 행위 분석 시나리오(방어자 트리아지 중심)

### 분석 단계(안전 절차)

| 단계 | 목적 | 핵심 산출물 |
|---|---|---|
| 1. 트리아지 | 파일/해시/평판/정적 특징 | 파일 타입·해시, Import/Section, YARA 매칭 |
| 2. 동적(샌드박스) | 기본 행위 관찰 | 프로세스 트리, 파일/레지스트리/네트워크 트레이스 |
| 3. 메모리 | 주입/디옵스케이션 | 메모리 맵, Inject 이벤트, 스레드 스택 |
| 4. 네트워크 | C2·도메인·TLS | 도메인/JA3/URI 패턴, PCAP 요약 |
| 5. 결론/보고 | 분류/IOC/대응 | TTP 매핑, 차단 리스트, 완화책 |

> 실분석은 **격리 VM/스냅샷/프록시·INetSim/허니 서비스** 환경에서. 본 문서는 **행위 시그널 중심**.

### 정적 트리아지(코드 실행 없음)

#### YARA(안전한 범용 룰 예시) — “프로세스 주입·네트워크 API 지표”

```yara
rule Generic_Injection_And_Net_APIs
{
  meta:
    author = "BlueTeam"
    purpose = "Static triage indicator (not a verdict)"
  strings:
    $api1 = "VirtualAllocEx" ascii
    $api2 = "WriteProcessMemory" ascii
    $api3 = "CreateRemoteThread" ascii
    $api4 = "WinHttpOpen" ascii
    $api5 = "InternetConnectA" ascii
  condition:
    uint16(0) == 0x5A4D and 2 of ($api*)
}
```
> **주의**: 탐지 보조 신호일 뿐 **오탐 가능**. 서명 결론으로 사용 금지.

#### PE 메타 요약(파이썬 `pefile` 활용 예, 실행 없음)

```python
import pefile, sys
pe = pefile.PE(sys.argv[1])
imports = [e.dll.decode(errors='ignore').lower() for e in pe.DIRECTORY_ENTRY_IMPORT]
print("DLL Imports:", set(imports))
for s in pe.sections:
    print(hex(s.VirtualAddress), s.Name.decode().strip(), s.get_entropy())
```

### 동적 행위(샌드박스/EDR 텔레메트리)

#### Sysmon(개념) — 주입 및 네트워크 상관

- **Event ID 8**: `CreateRemoteThread`(프로세스 주입)
- **Event ID 10**: `ProcessAccess`(권한 높은 접근)
- **Event ID 1/3**: 프로세스 생성 후 네트워크 연결

```xml
<RuleGroup name="Mal_Behavior" groupRelation="or">
  <CreateRemoteThread onmatch="include">
    <TargetImage condition="contains">\lsass.exe</TargetImage>
  </CreateRemoteThread>
  <ProcessAccess onmatch="include">
    <CallTrace condition="contains">ntdll</CallTrace>
    <TargetImage condition="end with">lsass.exe</TargetImage>
  </ProcessAccess>
</RuleGroup>
```

#### 네트워크 캡처 요약(무해한 예)

```bash
# HTTP Host/URI 빈도 요약

tshark -r sample.pcap -Y "http.request" -T fields -e ip.src -e http.host -e http.request.uri \
  | awk '{print $2$3}' | sort | uniq -c | sort -nr | head
```

### 메모리 관점(개념)

- **징후**: `RWX` 메모리, 미서명 모듈 인젝션, 자식 없는 네트워크 소켓, 스택 문자열에 URL/키.
- **볼라틸러티 예시(명령어 소개)**:
  - `linux/malfind`, `windows/malfind` — 의심 메모리 영역
  - `windows/pslist`, `netscan` — 프로세스/네트워크 상관

### 자동 리포트 스켈레톤(파이썬; 모의 데이터 입력)

```python
report = {
  "file_sha256": "<hash>",
  "static": {"imports":["winhttp","advapi32"], "entropy":"high"},
  "dynamic": {"proctree":[["parent.exe","child.exe"]], "net":["1.2.3.4:443"]},
  "ioc": {"domains":["example.c2"], "ja3":["<fingerprint>"]},
  "mitre": ["T1055 Process Injection","T1105 Exfil/Ingress Tool Transfer"]
}
for k,v in report.items():
    print(k,":",v)
```

### 대응 체크리스트

- [ ] **격리**: EDR 격리, 계정 크리덴셜 리셋, 토큰 무효화
- [ ] **근절**: 지속성 제거(서비스/런키/스케줄러/프로필 스크립트)
- [ ] **차단**: C2 도메인/IP, JA3, URI 패턴, 파일 해시
- [ ] **재이미징 판단**: 커널/부트/중앙 라이브러리 오염 시 즉시
- [ ] **사후학습**: 룰/대시보드/플레이북 업데이트, 개발·운영 피드백

---

## 워터링 홀(Watering Hole) 침해사고 시나리오

### 개요

- **정의**: 특정 집단이 자주 방문하는 **신뢰 사이트/포털**을 공격자가 먼저 침해해 **방문자를 2차 감염/탈취**하는 공격.
- **차별점**: 개별 사용자 표적화보다 **공급 측(콘텐츠/인프라)을 악용**. 서드파티 JS/CDN, 광고망, 위젯, 취약 CMS/플러그인 경유.

### 공격 체인(사이트 소유자 vs 방문자)

| 관점 | 단계 | 방어 포인트 |
|---|---|---|
| 사이트 소유자 | 코드/플러그인 오염 → 외부 스크립트 인젝션 → 리다이렉트/키로깅/폼 탈취 | **SRI + 강한 CSP + 빌드/배포 무결성** |
| 방문자 | 정상 도메인 방문 → 악성 하위리소스 로드 → DBD/세션 탈취 | **프록시/EDR 상관, CSP 보고 수집, 스크립트 화이트리스트** |

### CSP/SRI로 탐지·차단(소유자 관점)

#### Nginx 예(개념): 강한 CSP + Report-To

```nginx
add_header Content-Security-Policy "default-src 'self'; script-src 'self' https://cdn.trusted.com 'sha256-<SRI_HASH>'; object-src 'none'; frame-ancestors 'none'; report-to default";
add_header Report-To '{"group":"default","max_age":10886400,"endpoints":[{"url":"https://csp-report.yourcorp.com/report"}]}' always;
```

#### CSP 위반 리포트(모의 JSON)

```json
{
  "csp-report": {
    "document-uri": "https://portal.example/index.html",
    "violated-directive": "script-src-elem",
    "blocked-uri": "http://cdn-evil.tld/track.js",
    "source-file": "https://portal.example/index.html",
    "line-number": 42
  }
}
```

#### 수집·집계(파이썬; 무해)

```python
import json, sys, collections
dom = collections.Counter()
for line in sys.stdin:
    try:
        d = json.loads(line)
        u = d.get("csp-report",{}).get("blocked-uri","")
        if u: dom[u.split('/')[2]] += 1
    except: pass
for k,v in dom.most_common(10):
    print(v, k)
```

### 방문자 측 탐지: “정상 도메인 + 비정상 하위리소스”

- **프록시 규칙**: `Referer=trusted.example` 이면서 `Host not in allowlist` 인 `script/css/img` 요청 급증.
- **SRI 불일치**: 빌드 파이프라인의 기대 해시와 런타임 해시 상이.

```pseudo
IF content_type in [script, css, image]
AND referer_domain in trusted_portal_list
AND host_domain NOT IN allowed_subresources[referer_domain]
THEN alert "WateringHole subresource anomaly"
```

### 서버 파일 무결성(소유자 관점)

- **AIDE/Tripwire**로 웹 루트 **정적 파일 해시** 모니터링.
- **CI/CD**: 배포 아티팩트 해시를 **서명**하고, 배포 후 서버 측 재검증.

```bash
# 간단 해시 스냅샷(개념)

find /var/www/html -type f -name "*.js" -o -name "*.php" -print0 | xargs -0 sha256sum > /var/www/.hash-baseline
# 이후 비교

sha256sum -c /var/www/.hash-baseline | grep -v 'OK'
```

### HTML 인젝션 탐지(안전한 문자열 정적 탐색)

```python
import re, sys, pathlib
sus = re.compile(r'(document\.write|atob\(|fromCharCode\(|data:application/javascript|<iframe[^>]+hidden)', re.I)
for p in pathlib.Path('/var/www/html').rglob('*.html'):
    try:
        s = p.read_text(errors='ignore')
        if sus.search(s):
            print("[SUSPECT]", p)
    except: pass
```

### 대응 플레이북(소유자/방문자)

**사이트 소유자**
1. **격리**: 의심 리소스/경로 비활성화, CDN 키 롤오버.
2. **근절**: 오염 코드 롤백, 관리자 계정·API키 교체, 취약 플러그인 제거/패치.
3. **무결성**: AIDE/Tripwire 초기화, SRI/CSP 테스트 강화, CI/CD 서명 강제.
4. **통지**: 사용자 공지, 브라우저/블랙리스트 벤더 신고.

**방문자 조직**
1. **격리**: 감염 호스트 격리, 세션/쿠키 무효화, 비밀번호 리셋.
2. **근절**: 브라우저 확장 정리, 프로필 초기화/재이미징 판단.
3. **차단**: 관련 도메인/IP/JA3 차단, 프록시 룰 업데이트.
4. **학습**: 업무 포털 허용 리스트 관리, 스크립트 화이트리스트 정책 재검토.

---

## 통합 타임라인 예시(모의)

```
09:00  사용자가 trusted-portal.example 접속
09:00  프록시: subresource 요청 cdn-evil.tld/track.js (허용 리스트 불일치)
09:00  브라우저: 다운로드 트리거(update.exe, CT=application/octet-stream)
09:01  엔드포인트: chrome.exe -> rundll32.exe 프로세스 체인 + 외부 연결
09:02  EDR: 호스트 격리, IOC(도메인/해시) 생성
10:30  포털 운영: CSP 리포트 급증 확인, 오염 JS 롤백/키 교체
16:00  재검증: 프록시/EDR 알림 0, SRI/CSP 정상
```

---

## 실무 체크리스트(요약)

### DBD

- [ ] 브라우저 정책: **자동 다운로드 차단**, 위험 확장자 경고 강화
- [ ] 프록시 탐지: **짧은 체류 + 다중 리다이렉트 + 바이너리 MIME**
- [ ] 엔드포인트: **브라우저→LOLBins** 프로세스 체인 룰, Zone.Identifier 점검
- [ ] 차단: 신규/의심 도메인·TLD 카테고리, JA3/JA4 프로필 기반 룰
- [ ] 교육: “업데이트 위장/확장 설치” 주의 안내

### 악성코드 행위 분석

- [ ] 트리아지: 해시/평판/정적 메타(Imports/Entropy) 자동화
- [ ] 동적: 샌드박스/EDR **주입/권한 상승/네트워크** 상관
- [ ] 메모리: 의심 `RWX`/CreateRemoteThread/미서명 모듈 지표
- [ ] 보고서: IOC·TTP·완화책·재현 절차(비파괴) 포함

### 워터링 홀

- [ ] 사이트: **SRI + 강한 CSP + Report-To**, 정적 파일 무결성
- [ ] 방문자: **신뢰 도메인 + 비허용 하위리소스** 탐지
- [ ] 공급망: CDN 키/토큰 관리, 플러그인/위젯 검증
- [ ] 대응: 오염 코드 롤백, 사용자 통지, 블록리스트 신고

---

## 보고서 템플릿(재현 절차·영향·완화책)

| 항목 | 기재 예시 |
|---|---|
| 개요 | “워터링 홀로 의심되는 하위리소스 인젝션과 DBD 시도가 관찰됨” |
| 관찰(재현) | 프록시/WAF/CSP 리포트/EDR 타임라인(초 단위) |
| 영향 | 자격증명 탈취/원격 실행 위험/업무 중단 가능성 |
| 근본 원인 | 서드파티 스크립트 서명·검증 미흡, 프록시 허용 리스트 과대 |
| 완화책 | SRI·CSP 강화, 허용 리스트 축소, JA3/도메인 차단, 브라우저 정책 강화 |
| 재발 방지 | CI/CD 서명·검증 게이트, 정적 무결성 점검, 교육/캠페인 |
| IOC | 해시/도메인/IP/JA3/URI/파일 경로(정책 허용 범위 내) |

---

## 부록: 모의 데이터 생성(안전)

```python
# 모의 프록시 로그 생성기(안전)

import random, datetime as dt
hosts = ["news.example","portal.example","ad-network.tld","cdn-cool.tld","cdn-evil.tld"]
ua = ["Mozilla/5.0","curl/8.4.0","Python-urllib/3.11"]
now = dt.datetime.now()
for i in range(20):
    h = random.choice(hosts)
    path = random.choice(["/","/x","/track.js","/update.exe","/img.png"])
    ct = ""
    if path.endswith(".exe"): ct=" ct=application/octet-stream"
    print(f'{(now+dt.timedelta(seconds=i)).isoformat()} 10.10.20.5 "GET http://{h}{path}" 200 "-" "{random.choice(ua)}"{ct}')
```

---
**면책**: 본 문서는 **방어·분석 목적**의 모의 지침과 코드만 포함한다. 실제 테스트/헌팅은 **명시적 승인**과 **격리 환경**에서 수행해야 하며, 공격·오남용을 의도하지 않는다.
