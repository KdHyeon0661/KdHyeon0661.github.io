---
layout: post
title: TCPIP - 응용계층 프로토콜
date: 2025-09-04 16:25:23 +0900
category: TCPIP
---
# 응용계층 프로토콜

**(🔰 SSH · SMTP/IMAP/POP3 · NTP · SNMP, ⚙️ REST/gRPC · MQTT(IoT) · WebSocket, 🚀 프로토콜 선택 기준 & 네트워크 제약 하 최적화)**

> 이 글은 **운영·개발·SRE** 관점에서 많이 쓰는 응용계층 프로토콜을 **한 자리에** 모아 **원리 → 실무 옵션 → 보안/성능 → 트러블슈팅**까지 정리합니다.
> 코드/명령은 ``` 로, 수식은 MathJax로 표기합니다.

---

## 왜 ‘응용계층’인가

- 전송 계층(TCP/UDP)이 **기초 체력**이라면, 응용 프로토콜은 **사용자 경험·운영 품질**을 결정합니다.
- 같은 네트워크라도 프로토콜 선택과 옵션에 따라 **지연·손실·보안·확장성**이 크게 달라집니다.
- 본 글은 **현장 설정·베스트 프랙티스·디버깅 포인트** 위주로 설명합니다.

---

## SSH (Secure Shell) — 원격관리 표준 (🔰)

### 개념/흐름

- **TCP/22**, **암호화된 터미널/포팅**: 키 교환(KEX) → 서버 인증(host key) → 사용자 인증(키/패스/SSO) → 채널 할당(pty/sftp/포트포워딩).
- **하위 기능**: `ssh`(터미널), `sftp`(파일), `scp`(복사), **로컬/원격/다이내믹 포워딩**(SOCKS).

### 핵심 옵션/보안

- **서버 하드닝**(개념 `sshd_config`)
```sshconfig
Port 22
Protocol 2
HostKey /etc/ssh/ssh_host_ed25519_key
KexAlgorithms curve25519-sha256
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com
MACs hmac-sha2-256-etm@openssh.com
PasswordAuthentication no           # 키 인증만
PubkeyAuthentication yes
PermitRootLogin prohibit-password
AllowUsers ops deploy
ClientAliveInterval 30
ClientAliveCountMax 3
```
- **클라이언트 멀티플렉싱**: 동일 호스트 다중 세션 **재사용**으로 지연↓
```sshconfig
# ~/.ssh/config

Host bastion
  HostName bastion.example.com
  User ops
  ControlMaster auto
  ControlPath ~/.ssh/cm-%r@%h:%p
  ControlPersist 5m
```
- **점프호스트**: `ProxyJump` / `-J` 로 체인 연결.
- **에이전트포워딩 최소화**: 유출 위험, 필요 시만 허용.

### 포트포워딩

- **로컬 → 원격**(L): `ssh -L 127.0.0.1:8443:intra:443 bastion`
- **원격 → 로컬**(R): `ssh -R 0.0.0.0:2222:localhost:22 bastion`
- **다이내믹(SOCKS)**: `ssh -D 1080 bastion` → 브라우저 프록시로 사용.

### 성능/안정

- **긴 RTT**: `ServerAliveInterval`/`ClientAliveInterval`로 **NAT 타임아웃** 회피.
- **모바일/로스**: **mosh**(UDP 기반 예측 에코) 고려.
- **파일전송**: `rsync -e ssh`로 델타/압축·재개.

### 트러블슈팅

```text
- 연결 지연: DNS/SRVTCP/키 교환 로그(Verbose -vvv)
- 인증 실패: 권한(600), 서버 authorized_keys 권한(700/600)
- 끊김: 방화벽 idle timeout, TCP keepalive/ServerAlive 조정
```

---

## 이메일: SMTP / IMAP / POP3 (🔰)

### 역할 분담

```
[보내기] MUA → MSA(SMTP SUBMIT 587) → MTA → … → MX(MTA) → MDA → 사서함
[받기]   MUA → IMAP(143/993) 또는 POP3(110/995) → 사서함
```
- **SMTP**: **전송**(MTA↔MTA) / **제출**(클라→서버 587, AUTH 필수).
- **IMAP**: **서버 보관/동기화**(폴더, 부분 다운로드).
- **POP3**: 단순 다운로드(오프라인 사용), 현대엔 드묾.

### 포트/TLS

- **SMTP 전송**: 25(STARTTLS 권장)
- **제출(Submission)**: **587(STARTTLS+AUTH 필수)**
- **SMTPS**: 465(레거시, 요즘은 “Implicit TLS”로 재정의)
- **IMAP**: 143 / **IMAPS**: 993
- **POP3**: 110 / **POP3S**: 995

### 반스팸/도메인 인증

- **SPF**(보내는 서버 허용 목록), **DKIM**(헤더/바디 서명), **DMARC**(정책+리포트).
- 발신 평판을 위해 **역방향 PTR**, 정적 IP, **25 포트 블록**(클라우드) 주의.

### 큐/재시도

- **일시 오류(4xx)** 재시도, **영구 오류(5xx)** 바운스.
- 큐 폭주 시 **늦은 수신/중복** 가능 → **모니터링** 필수.

### 클라이언트 예

```bash
# 제출

swaks --server smtp.example.com --port 587 --auth LOGIN --tls \
      --auth-user user --auth-password pass --to you@example.net --from me@example.com
```

### 트러블슈팅

```text
- 배달 안됨: MX 조회, 25/587 차단, SPF/DMARC 정책, 블랙리스트
- TLS 실패: 체인 누락/호스트명 불일치
- 대용량 첨부 제한: 10~25MB → 링크/스토리지로 전환
```

---

## NTP (Network Time Protocol) — 시간 동기 (🔰)

### 개념

- **Stratum**: 0(원천) → 1(직결 서버) → 2/3(체인).
- **Offset(오프셋)**·**Delay(왕복)**·**Jitter** 추정으로 로컬 클록 보정.

\[
\text{offset} \approx \frac{(t_2 - t_1) + (t_3 - t_4)}{2},\quad
\text{delay} \approx (t_4 - t_1) - (t_3 - t_2)
\]
- \(t_1\): 클라 전송, \(t_2\): 서버 수신, \(t_3\): 서버 전송, \(t_4\): 클라 수신.

### 구성(chrony 예)

```ini
# /etc/chrony/chrony.conf

pool time.google.com     iburst maxsources 4
pool 0.kr.pool.ntp.org   iburst
driftfile /var/lib/chrony/drift
makestep 0.1 3
rtcsync
```
- **iburst**: 초기 빠른 수렴. **makestep**: 큰 오프셋 초기에 즉시 보정.

### 보안·운영

- **NTP 인증**(대칭키/Autokey) 또는 **NTS(UDP+TLS)**로 스푸핑 방지(점진 확산).
- 방화벽: UDP/123 허용, **“Kiss-o’-Death”**(rate limit) 응답 처리.
- **PTP**: 마이크로초 정밀(DC/금융). 네트워크 지원 필요.

### 문제 패턴

```text
- VM/클라우드 시간 점프: 가상화 클록 소스 불안 → chrony 권장
- 방화벽/NAT: 대칭 NAT에서 응답 손실 → 다른 서버/DoT 기반 NTS 검토
```

---

## SNMP — 모니터링/관리 (🔰)

### 개념

- **GET/GETNEXT/BULK**(조회), **SET**(변경), **TRAP/INFORM**(이벤트 푸시).
- **MIB/OID**: 관리 정보 트리, 예: `1.3.6.1.2.1.1`(system).

### 버전/보안

- **v1/v2c**: community string(사실상 평문) → **읽기전용 제한**.
- **v3**: **auth(무결성) + priv(암호화)**, 사용자/그룹/뷰 기반 접근.

### 실무 예

```bash
# 장비 기초 정보(v2c, 읽기전용)

snmpwalk -v2c -c public 10.0.0.1 1.3.6.1.2.1.1

# v3 (authPriv)

snmpwalk -v3 -u mon -l authPriv -a SHA -A 'authpass' -x AES -X 'privpass' 10.0.0.1 sysUpTime
```
- **Trap 수신기**: snmptrapd → SIEM으로 전달.

### 운영 주의

- **정책 IP 제한**: 관리망만 접근.
- **OID 문서화**: 멀티벤더 MIB 편차.
- 대량 수집은 **BULK** 사용, 폴 주기 분산.

---

## REST vs gRPC (⚙️)

### REST(HTTP/JSON) 특징

- 직관적(리소스/메서드), **캐시·프록시 친화**. 사람 읽기 쉬움.
- 단점: **스키마 약함**, **payload 부피↑**, **양방향 스트리밍 불리**.

```http
GET /v1/users/123
Accept: application/json
---
200 OK
{"id":123,"name":"Ada"}
```

### gRPC(HTTP/2/Protobuf)

- **IDL(proto)** 기반 **강한 스키마**, **양방향 스트리밍**(H2), **바이너리 효율**.
- 단점: 브라우저 직접 호출 제한(프록시/게이트웨이 필요), **중간 장비 가시성↓**.

```proto
service Greeter {
  rpc SayHello(HelloReq) returns (HelloResp);
  rpc Chat(stream ChatMsg) returns (stream ChatMsg);  // 스트리밍
}
message HelloReq { string name = 1; }
message HelloResp { string msg = 1; }
```
- **게이트웨이**: gRPC ↔ REST 변환(Envoy, grpc-gateway).
- **로드밸런싱**: xDS/Envoy, **hedging/retry** 정책.

### 선택 기준

- **브라우저/캐시/단순성**: REST 우세.
- **내부 마이크로서비스/고성능/스트리밍**: gRPC 우세.
- **혼합**: 외부 REST, 내부 gRPC.

---

## MQTT — IoT 메시징 (⚙️)

### 개념

- **브로커 중심 Pub/Sub**: `topic`(계층 문자열), **QoS 0/1/2**.
- **경량**(헤더 몇 바이트), **비연결/손실 환경** 친화(셀룰러/저전력).

### QoS/세션

- **QoS 0**: 최대 한번(ACK 없음) — 텔레메트리.
- **QoS 1**: 최소 한번(PUBACK).
- **QoS 2**: 정확히 한번(네 단계 핸드셰이크).
- **Persistent Session**: **Clean Session=false**, **세션 상태/미전달 메시지** 보존.
- **Retained 메시지**: 최근 1개 보관 → 신규 구독자 즉시 수신.
- **Last Will**: 비정상 종료 시 **의지 메시지** 자동 발행.

### 보안/전송

- **TLS(8883)**, 클라이언트 인증서/mTLS, 토큰 인증.
- **WebSocket over TLS(443)**: 방화벽 통과 용이.
- **ACL**: 토픽별 publish/subscribe 권한.

### 실무 예 (mosquitto)

```ini
# mosquitto.conf

listener 8883
cafile /etc/ssl/certs/ca.crt
certfile /etc/ssl/certs/broker.crt
keyfile  /etc/ssl/private/broker.key
require_certificate true
use_identity_as_username true
allow_anonymous false
```
```bash
# Publish/Subscribe

mosquitto_sub -h broker -p 8883 -t 'sensors/+/temp' --cafile ca.crt --cert dev.crt --key dev.key
mosquitto_pub -h broker -p 8883 -t 'sensors/kitchen/temp' -m '24.2' --cafile ca.crt --cert dev.crt --key dev.key
```

### 운영 포인트

- **토픽 설계**: `site/device/class` 표준화, 와일드카드 `+/#` 남용 금지.
- **오프라인 큐**: 디바이스 저장소·전송률 제한, 배터리 보호.
- **브로커 클러스터**: 스케일·HA(브리지/미러), 순서 보장 요구 분석.

---

## WebSocket — 양방향 실시간 (⚙️)

### 개념/핸드셰이크

- **HTTP 업그레이드** → **단일 TCP**(또는 **H3 위 WebTransport** 신세대 대안).
- 프레임: **텍스트/바이너리**, **ping/pong** keepalive.

```http
GET /chat HTTP/1.1
Host: wss.example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: <nonce>
Sec-WebSocket-Version: 13
```

### 운영/스케일

- **LB/프록시**: **장수 연결**, **스티키 세션** 또는 **백엔드 브로커(pub/sub)**.
- **역시계산**: 수만~수십만 커넥션 → 커널 fd/메모리/핸들 튜닝.
- 대안: **SSE(Server-Sent Events)**(단방향, 프락시 친화) / **WebTransport(QUIC)**(실험적).

### 보안

- **WSS(TLS)**, **오리진 검증**, **토큰 재발급**(장수 연결), **메시지 크기 제한·레이트리밋**.

---

## 프로토콜 선택 기준 (🚀)

### 의사결정 매트릭스(요약)

| 시나리오 | 지연 | 신뢰 | 중간장비 | 양방향 | 권장 |
|---|---|---|---|---|---|
| 브라우저 API/캐시 | 보통 | 높음 | 프록시 친화 | 필요 없음 | **REST(HTTP/2/3)** |
| 대화형/알림 | 낮음 | 중간 | 프록시 제약 | 필요 | **WebSocket/SSE** |
| 내부 마이크로서비스 | 낮음 | 높음 | LB 친화 | 스트리밍 | **gRPC(H2)** |
| IoT 텔레메트리 | 낮음 | 선택 | 셀룰러/NAT | 보통 | **MQTT** |
| 파일 전송/운영 | 가변 | 높음 | 방화벽 | 가끔 | **SSH/SFTP** |
| 시계 동기 | 높음 | 중 | 방화벽 | N/A | **NTP/Chrony, PTP** |
| 네트워크 관리 | 중 | 중 | 제한 | N/A | **SNMPv3(RO/TRAP)** |
| 메일 | 낮음 | 높음 | 필수 | N/A | **SMTP/IMAP(STARTTLS)** |

### 추가 고려

- **NAT/방화벽**: 443/TCP·UDP 우선(HTTP/3, WSS), 전용 포트는 기업망에서 차단 가능.
- **페이로드**: 바이너리/스키마(ProtoBuf) vs 텍스트(JSON); 디버깅·보안·전파비용.
- **멱등성/재시도**: 네트워크 오류 대비 idempotent 설계.
- **표준/에코시스템**: SDK/프록시/가시성 도구 가용성.

---

## 네트워크 제약 하 최적화 (🚀)

### 지연·손실·모바일

- **배치/코얼레싱**: 채팅/알림은 **메시지 묶어 전송**, **주기적 flush**.
- **압축**: 텍스트 Brotli, 바이너리 ProtoBuf/MessagePack.
- **ACK/Keepalive 주기**: NAT 타임아웃보다 짧게(예: 15–30s), 배터리와 균형.
- **QUIC/HTTP/3**: 로스/리오더 내성↑, **경로 전환**(Wi-Fi↔LTE) 매끄러움.

### 백프레셔/흐름제어

- **소비자 속도 기준**으로 송신량 제한(Queue Depth/RTT/에러율 지표).
- **서버 푸시**는 **레이트 리밋/버퍼 한도**를 클라에 명시.

### 캐싱/오프라인

- **ETag/If-None-Match**, `stale-while-revalidate`.
- **오프라인 큐/리플레이**: 이벤트 로그를 로컬에 저장 후 전송(멱등 키 필요).

### 보안/성능 절충

- **TLS 1.3** 기본, **세션 재개**로 핸드셰이크 비용↓.
- **0-RTT**: **멱등 요청만**, **재생 윈도우** 관리.
- **증폭 방지**: 초기 윈도우 제한(QUIC), 토큰 검증.

---

## 프로토콜별 디버깅 체크리스트

### SSH

```text
- 핸드셰이크: KEX/Cipher 미스매치? ssh -vvv
- 끊김: NAT idle timeout, ServerAlive/ClientAlive
- 느림: DNS역조회 UseDNS off, ControlMaster로 재사용
```

### SMTP/IMAP

```text
- 25/587 차단/필터링? STARTTLS 캡처
- SPF/DKIM/DMARC 검사 결과
- 큐 딜레이/Defer 원인(4xx/5xx)
```

### NTP

```text
- 오프셋/지터 과대: chronyc tracking/sources
- 방화벽: UDP/123, KOD 수신?
- VM 클록 드리프트: guest tools vs chrony 충돌
```

### SNMP

```text
- v3 authPriv 설정 정확? 뷰/ACL 일치?
- 대량 walk는 BULK, 폴 간격 분산
- Trap 수신기/타임스탬프 NTP 동기
```

### REST/gRPC

```text
- REST: 캐시/압축/Keep-Alive, H2/H3 여부
- gRPC: H2 필요, L7 프록시/ALB 호환성, 메시지 크기 제한
- 양방향: backpressure/flow control 계측
```

### MQTT

```text
- 세션/클린 플래그, QoS 합의
- TLS/클라 인증서, 토픽 ACL
- 오프라인 메시지 폭주(메모리/스토리지 한도)
```

### WebSocket

```text
- 업그레이드 헤더, 프록시 100-continue/idle timeout
- Ping/Pong 주기, 메시지 최대 크기
- 스티키/브로커링, 장애시 재연결 backoff
```

---

## 베스트 프랙티스(요약 카드)

- **SSH**: 키 인증·ControlMaster·점프호스트, 에이전트포워딩 최소화.
- **메일**: Submission 587+AUTH+STARTTLS, SPF/DKIM/DMARC 정합.
- **NTP**: chrony+iburst, NTS/방화벽, PTP는 특수환경.
- **SNMP**: v3 authPriv, 관리망 격리, BULK 폴링.
- **REST**: H2/H3, 캐시·Brotli·ETag, 멱등/재시도.
- **gRPC**: IDL·스트리밍·게이트웨이, 메시지/시간 제한.
- **MQTT**: QoS/세션/Will/Retain, TLS+mTLS, 토픽/ACL 설계.
- **WebSocket**: WSS, ping/pong, LB 스케일/브로커.
- **공통**: TLS1.3, 세션 재개/키 로테이션, 0-RTT는 멱등만, NAT/MTU/ICMP 고려.

---

### 부록 A — 포트/요약 치트시트

```
SSH: 22/TCP
SMTP: 25(TCP), Submission: 587/TCP, SMTPS: 465/TCP
IMAP: 143/TCP, IMAPS: 993/TCP
POP3: 110/TCP, POP3S: 995/TCP
NTP: 123/UDP
SNMP: 161/UDP, Trap: 162/UDP
MQTT: 1883/TCP, MQTTS: 8883/TCP, MQTT over WSS: 443/TCP
WebSocket: 80/443 (HTTP 업그레이드, WSS 권장)
```

### 부록 B — 관측 지표 필드 제안

```text
[공통] rtt_ms, plr(%), ttfb_ms, reconnects, errors
[SSH] session_len_s, keepalive_s, rekey_cnt
[SMTP/IMAP] queue_len, defer_ratio, tls_fail_rate
[NTP] offset_ms, jitter_ms, stratum, reach
[SNMP] poll_time_ms, bulk_rows, trap_rate
[REST] h2/h3_ratio, cache_hit, brotli_ratio
[gRPC] stream_cnt, msg_size_p95, retry/hedge
[MQTT] qos_mix, offline_msgs, retain_hits
[WebSocket] conn_active, ping_rtt, broadcast_fanout
```

### 부록 C — 설계 템플릿

```text
[요구사항]
- 지연/손실/모바일/배터리 제약
- 멱등/재시도/보안 수준/규제
- 중간장비/프록시/LB 환경

[선택]
- 프로토콜(REST/gRPC/MQTT/WebSocket/…)
- 전송(TCP/QUIC), TLS1.3/세션 재개/0-RTT 정책
- 스키마(JSON/ProtoBuf), 압축, 버전 전략

[운영]
- 가시성(qlog/APM/지표), 알람 기준
- 백프레셔/레이트 리밋/폭주 보호
- 롤백/폴백(H3→H2→H1), 재시도/지수 백오프
```
