---
layout: post
title: Linux - 파일 시스템 고급 설정 및 점검
date: 2024-11-25 19:20:23 +0900
category: Linux
---
# 리눅스 24편: 파일 시스템 고급 설정 및 점검

## 1. 마운트 옵션 심화 — 성능·보안·내구성의 균형

### 1.1 필수 옵션 요약(확장)

| 옵션 | 범용성 | 용도/효과 | 주의/메모 |
|---|---|---|---|
| `ro` / `rw` | ★★★ | 읽기 전용/읽기쓰기로 마운트 | 시스템 손상 예방에 `ro` 부트 유용 |
| `noexec` | ★★★ | 해당 FS에서 실행 금지 | `/tmp`, 다운로드 디렉토리 보안 강화 |
| `nosuid` | ★★★ | setuid/setgid 무력화 | 컨테이너/멀티유저 서버 필수급 |
| `nodev` | ★★★ | 장치 파일 무시 | 비루트 파티션에 기본으로 |
| `relatime` | ★★★ | atime 갱신 최적화(기본) | 대부분의 서버/데스크톱 기본값 |
| `noatime`/`nodiratime` | ★★☆ | 읽기 성능↑, 쓰기↓ | atime 의존 앱(백업/메일) 확인 필요 |
| `sync`/`async` | ★★☆ | 모든 쓰기 동기화/캐싱 | `sync`는 안정↑ 성능↓ |
| `discard` | ★★☆ | 온라인 TRIM(SSD) | 타이머 `fstrim.timer` 권장 대안 |
| `errors=remount-ro` (ext 계열) | ★★☆ | 오류 시 자동 R/O | FS 손상 확산 방지 |
| `data=ordered/journal/writeback` (ext4) | ★★☆ | 저널링 전략 | `ordered`가 안전·기본, `writeback` 성능↑ 위험↑ |
| `noautodefrag`/`autodefrag` (Btrfs) | ★★☆ | 랜덤 I/O 워크로드 최적화 | DB 워크로드엔 비권장 |
| `inode64` (XFS) | ★★☆ | 64비트 inode(대용량) | 오래된 유틸 호환성 체크 |
| `compress=zstd` (Btrfs) | ★★☆ | 투명 압축 | 로그/텍스트에 효과적 |

### 1.2 `/tmp` 보안 마운트(권장 패턴)

```bash
# 일시 적용
sudo mount -o remount,noexec,nosuid,nodev /tmp
```

`/etc/fstab` 영구화(예: 별도 파티션 or tmpfs):

```fstab
# 별도 파티션을 쓰는 경우
UUID=xxxx-xxxx  /tmp  ext4  rw,nosuid,nodev,noexec,relatime  0 2

# 메모리 기반 tmpfs (용량 상한 주기)
tmpfs  /tmp  tmpfs  rw,nosuid,nodev,noexec,mode=1777,size=2G  0  0
```

> `mode=1777`은 스티키비트 포함의 공개 임시폴더 표준 권한.

### 1.3 바인드 마운트와 권한 상속

- **바인드 마운트**: 한 디렉토리를 또 다른 경로에 다시 마운트

```bash
sudo mount --bind /srv/app/data /var/www/data
# 보안 옵션 덧씌우기(새로운 마운트에만 적용)
sudo mount -o remount,bind,ro,nodev,nosuid /var/www/data
```

`/etc/fstab`:

```fstab
/srv/app/data  /var/www/data  none  bind  0 0
/var/www/data  /var/www/data  none  remount,bind,ro,nodev,nosuid  0 0
```

### 1.4 OverlayFS(컨테이너·빌드 캐시)

```bash
sudo mkdir -p /overlay/{lower,upper,work,merged}
sudo mount -t overlay overlay \
  -o lowerdir=/overlay/lower,upperdir=/overlay/upper,workdir=/overlay/work \
  /overlay/merged
```

- 읽기 전용 베이스(`lowerdir`) + 쓰기 레이어(`upperdir`) 조합
- 이미지 빌드, 일시적 테스트 환경에 유용

---

## 2. `/etc/fstab` — 안전한 자동 마운트 설계

### 2.1 기본 형식(복습+패턴)

```text
<장치>   <마운트위치>  <FS타입>  <옵션>                         <dump> <pass>
UUID=... /data         ext4      defaults,noatime              0      2
LABEL=LOGS /var/log    xfs       rw,noatime,attr2,inode64      0      2
```

- **장치 지정 우선순위**: `UUID` > `LABEL` > `/dev/sdX` (udev 순서 변동 위험 회피)
- **fsck(pass)**: `1`=루트, `2`=기타, `0`=검사 안함

UUID 조회:

```bash
sudo blkid
ls -l /dev/disk/by-uuid/
```

### 2.2 실패에 강한 마운트

- **네트워크 FS(NFS, CIFS)**: 부팅 지연 방지

```fstab
server:/share /mnt/nfs  nfs  defaults,_netdev,noauto,x-systemd.automount,x-systemd.device-timeout=5s  0 0
```

- `_netdev`: 네트워크 준비 후 마운트
- `x-systemd.automount`: 접근 시 자동 마운트(아래 3장 참조)
- `x-systemd.device-timeout=5s`: 장치/네트워크 지연 시 빨리 포기

### 2.3 LUKS/LVM/RAID와 결합

- LUKS 매핑 후의 **논리 장치**를 fstab에 기록:

```bash
# 암호화 해제(부팅 시 systemd-cryptsetup가 담당)
sudo cryptsetup open /dev/sdb1 DATA_CRYPT
sudo mkfs.ext4 /dev/mapper/DATA_CRYPT
```

`/etc/crypttab` + `/etc/fstab`를 함께 관리:

```conf
# /etc/crypttab
DATA_CRYPT UUID=<uuid-of-sdb1> none luks,discard

# /etc/fstab
/dev/mapper/DATA_CRYPT  /secure  ext4  rw,relatime,errors=remount-ro  0 2
```

- LVM/RAID는 **매핑(논리) 디바이스** 기준으로 fstab 구성 (`/dev/mapper/vg-lv`, `/dev/md0` 등).

---

## 3. 자동 마운트: `systemd-automount` vs `autofs`

### 3.1 systemd-automount(fstab 한 줄로 끝)

```fstab
server:/share  /mnt/share  nfs  noauto,x-systemd.automount,_netdev,vers=4.2  0 0
```

- **장점**: 간단, 종속성 관리(systemd), 대부분의 케이스에 충분
- **단점**: autofs의 복잡한 동적 맵핑·토폴로지 기능은 제한

### 3.2 autofs(대규모/동적 환경)

설치 & 기본 맵:

```bash
sudo apt install autofs
echo "/nfs  /etc/auto.nfs --timeout=60 --ghost" | sudo tee -a /etc/auto.master
echo "project  -fstype=nfs4  server:/exports/project" | sudo tee /etc/auto.nfs
sudo systemctl enable --now autofs
```

- `/nfs/project` 접근 시 자동 마운트
- LDAP/동적 맵과 결합해 대규모 NFS 트리 자동화에 강함

---

## 4. 점검·유지보수 도구 — ext4/XFS/Btrfs 정석 루틴

### 4.1 ext4: `fsck`/`tune2fs`/`e2label`

```bash
# 안전: 언마운트 후
sudo umount /dev/sda1
sudo e2fsck -f -C 0 /dev/sda1      # 강제 점검, 진행률 표시
sudo tune2fs -c 30 -i 1m /dev/sda1 # 30회 마운트 또는 1개월마다 점검
sudo e2label /dev/sda1 DATA_DISK   # 레이블 부여
```

> 부팅 시 강제 점검: 루트에 `forcefsck` 파일 생성 후 재부팅(배포판 따라 경로/방법 상이)

### 4.2 XFS: `xfs_repair` (fsck.xfs는 경고만)

```bash
sudo umount /dev/sdb1
sudo xfs_repair -n /dev/sdb1   # 시뮬레이션(추천)
sudo xfs_repair    /dev/sdb1   # 실제 수리
```

- XFS는 저널 구조, 디렉터리·할당 설계가 ext와 달라 **전용 도구**만 사용

### 4.3 Btrfs: `scrub`/`check`/스냅샷

```bash
# 온라인 무결성 검사(블럭 레벨 검증, RAID면 자동 복구)
sudo btrfs scrub start -Bd /mnt

# 오프라인 체크(신중)
sudo umount /dev/sdc1
sudo btrfs check --readonly /dev/sdc1
```

스냅샷/롤백(서브볼륨 구조):

```bash
sudo btrfs subvolume snapshot -r /mnt/@ /mnt/@snap-$(date +%F)
sudo btrfs subvolume list /mnt
# 롤백은 스냅샷을 @로 교체 마운트(배포판 스냅샷 도구와 함께 사용)
```

### 4.4 SSD TRIM: 온라인 vs 타이머

```bash
# 일회성
sudo fstrim -av
# 주기 타이머 권장
systemctl enable --now fstrim.timer
```

---

## 5. 성능/내구성/보안 튜닝 — 상황별 처방

### 5.1 로그·임시·캐시 파티션

- `/var/log`는 별도 파티션/XFS 추천(폭주 보호)
- `/tmp`는 tmpfs + `noexec,nosuid,nodev`
- 컨테이너 빌드 캐시는 OverlayFS/전용 SSD로 IOPS 분리

### 5.2 저널 크기/전략(ext4)

```bash
# 저널 크기 조정(언마운트 필요)
sudo tune2fs -J size=512 /dev/sda1   # 512MB 저널
# 마운트 전략
# data=ordered(기본, 안전), writeback(성능↑, 메타데이터만 저널링)
```

### 5.3 atime 정책

- 기본 `relatime`은 대체로 충분
- DB/메일 등 atime 의존 없으면 `noatime`으로 쓰기 감소
- 백업/동기화 툴의 atime 사용 여부 사전 확인

### 5.4 SELinux/AppArmor 컨텍스트

수동 파일 이동/복구 후 컨텍스트 복원:

```bash
sudo restorecon -R /var/www /var/spool/postfix /data
```

---

## 6. Quota & **Project Quota**(디렉터리/프로젝트 단위 제한)

### 6.1 사용자/그룹 쿼터(ext4, XFS)

`/etc/fstab`에 마운트 옵션:

```fstab
UUID=... /home  ext4  usrquota,grpquota  0 2
```

활성화:

```bash
sudo mount -o remount /home
sudo quotacheck -cum /home
sudo quotaon /home
sudo edquota alice
quota -u alice
```

### 6.2 XFS Project Quota(디렉터리 단위)

마운트 옵션: `prjquota` 또는 `pquota`

```fstab
UUID=... /data  xfs  rw,noatime,prjquota  0 2
```

프로젝트 정의:

```ini
# /etc/projects
100:/data/teamA

# /etc/projid
teamA:100
```

적용 및 한도 부여:

```bash
sudo xfs_quota -x -c 'project -s teamA' /data
sudo xfs_quota -x -c 'limit -p bhard=200g teamA' /data
xfs_quota -x -c 'report -p' /data
```

> 대규모 멀티테넌시 스토리지에서 **디렉터리 레벨**로 깔끔히 제한 가능.

---

## 7. 시나리오별 설계/운영 레시피

### 시나리오 A — 보안 강화를 위한 `/tmp`, `/var/tmp`, 컨테이너 빌드 경로 분리
```fstab
tmpfs       /tmp        tmpfs  rw,nosuid,nodev,noexec,mode=1777,size=2G  0 0
UUID=...    /var/tmp    ext4   rw,nosuid,nodev,noexec,relatime           0 2
UUID=...    /var/lib/containers  xfs  rw,noatime,attr2,inode64          0 2
```
- `/tmp`는 휘발, `/var/tmp`는 유지(표준 규약)
- 컨테이너 레이어/이미지는 XFS/SSD에 분리

### 시나리오 B — NFS 공유를 지연 마운트(systemd-automount)
```fstab
server:/export/builds  /n/builds  nfs  noauto,_netdev,x-systemd.automount,vers=4.2  0 0
```
- 접근 시 마운트, 부팅 지연 방지, 네트워크 종속성 자동 처리

### 시나리오 C — 루트 외 데이터 파티션에 `noatime`, 저널 확대, 예약 블록 0~1%
```bash
sudo tune2fs -m 1 /dev/sdb1           # data 전용 파티션
sudo tune2fs -J size=1024 /dev/sdb1   # write 폭주 시 저널 확대로 안정성↑
```
`/etc/fstab`:
```fstab
UUID=...  /data  ext4  rw,noatime,errors=remount-ro  0 2
```

### 시나리오 D — 삭제했는데 공간이 안 줄어든다(삭제-열림 누수)
```bash
lsof +L1 | awk 'NR==1 || $7<0'    # 링크 카운트 0인데 열린 파일
# 해당 서비스 재시작 → 즉시 공간 회수
```

### 시나리오 E — Btrfs 압축+스냅샷 기반 배포
```bash
# 마운트
UUID=... /srv  btrfs  rw,compress=zstd,ssd,space_cache=v2  0 0

# 스냅샷 배포
btrfs subvolume snapshot -r /srv/@app /srv/@app-$(date +%F)
# 롤백은 스냅샷을 마운트 대상(@app)로 전환
```

---

## 8. 점검·모니터링 자동화 스니펫

### 8.1 정기 점검/경보(용량·아이노드)

```bash
#!/usr/bin/env bash
TH=90
MSG=""
while read -r use mnt; do
  u=${use%%%}
  (( u>=TH )) && MSG+="$mnt at $use\n"
done < <(df -hP | awk 'NR>1{print $5, $6}')

while read -r use mnt; do
  u=${use%%%}
  (( u>=TH )) && MSG+="(inode) $mnt at $use\n"
done < <(df -Pi | awk 'NR>1{print $5, $6}')

[ -n "$MSG" ] && printf "Disk Alert %s:\n%b" "$(hostname)" "$MSG" \
 | mail -s "Disk Alert $(hostname)" admin@example.com
```

### 8.2 주간 SSD TRIM/저널 청소(시스템 타이머 활용)

- `fstrim.timer` 활성화
- 저널 청소:
```bash
journalctl --vacuum-time=7d
```

크론 샘플:
```cron
# /etc/cron.weekly/log-vacuum
#!/bin/sh
journalctl --vacuum-time=7d
```

---

## 9. 참고 패턴: 위험 회피 체크리스트

- fstab 수정 전 **`mount -a` 테스트**로 구문·접속 검증
- 네트워크 FS엔 `_netdev` + `x-systemd.automount`로 부팅 지연 방지
- 보안 영역(`/tmp`, 다운로드)은 `noexec,nosuid,nodev`
- ext4 데이터 파티션은 `noatime`, 루트·시스템은 `relatime` 유지 권장
- XFS 점검은 `xfs_repair`, ext4는 `e2fsck`; Btrfs는 `scrub`/스냅샷 먼저
- **스냅샷/백업 후 작업**(tune2fs, xfs_repair, btrfs check)
- LUKS/LVM/RAID 스택에서는 **매핑 순서**(crypttab→fstab) 및 **의존 타겟** 확인
- SELinux 컨텍스트 `restorecon -R <path>` 잊지 않기

---

## 부록 A) 예시 fstab 템플릿(안전·현대적)

```fstab
# 루트(안정성 옵션)
UUID=ROOT-UUID  /       ext4  rw,relatime,errors=remount-ro  0 1

# 홈(사용자많음: XFS 권장, 성능·확장성)
UUID=HOME-UUID  /home   xfs   rw,noatime,attr2,inode64  0 2

# 로그(폭주 보호 위해 분리)
UUID=LOGS-UUID  /var/log  xfs  rw,noatime,attr2,inode64  0 2

# 임시(tmpfs) — 메모리 상한 엄수
tmpfs  /tmp  tmpfs  rw,nosuid,nodev,noexec,mode=1777,size=2G  0 0

# 데이터(대용량 ext4, write 성능·내구성 균형)
UUID=DATA-UUID  /data  ext4  rw,noatime  0 2

# NFS(자동 마운트)
server:/export/share  /mnt/share  nfs  noauto,_netdev,x-systemd.automount,vers=4.2  0 0
```

---

## 부록 B) 실수 방지 커맨드 모음

```bash
# fstab 검증: 에러 즉시 확인(언마운트 변경 없이)
sudo mount -a

# 현재 마운트 옵션 확인
findmnt -t ext4,xfs,btrfs
mount | column -t

# 블록·FS 정보
lsblk -f
blkid

# 삭제-열림 누수
lsof +L1 | awk 'NR==1 || $7<0'
```

---

## 마무리

- **마운트 옵션**은 단순 스위치가 아니라 **보안·성능·복구전략**의 핵심 레버입니다.
- **자동 마운트**는 부팅 신뢰성을 좌우합니다: 대부분은 `systemd-automount`로 충분하고, 대규모 NFS/동적 맵은 `autofs`가 강합니다.
- **점검/복구**는 FS 타입별 정석 도구로, 가능하면 **스냅샷/백업 뒤** 진행하세요.
- **쿼터/프로젝트 쿼터**로 멀티테넌시 배포의 “폭주”를 사전에 차단하세요.
- 본 편의 템플릿·스크립트·체크리스트를 바로 적용해, **안전하고 빠르며 복구 가능한** 파일 시스템 운영 습관을 완성하시길.
