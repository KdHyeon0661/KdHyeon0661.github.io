---
layout: post
title: Linux - 파일 시스템 고급 설정 및 점검
date: 2024-11-25 19:20:23 +0900
category: Linux
---
# 파일 시스템 고급 설정 및 점검

## 마운트 옵션 심화 — 성능, 보안, 내구성의 균형 찾기

### 필수 마운트 옵션 요약

| 옵션 | 범용성 | 용도/효과 | 주의사항 |
|---|---|---|---|
| `ro` / `rw` | ★★★ | 읽기 전용/읽기쓰기 모드 | 시스템 보호를 위해 `ro` 마운트 유용 |
| `noexec` | ★★★ | 파일 시스템 내 실행 금지 | `/tmp`, 다운로드 디렉토리 보안 강화 |
| `nosuid` | ★★★ | setuid/setgid 비활성화 | 컨테이너 및 멀티유저 서버 필수 |
| `nodev` | ★★★ | 장치 파일 무시 | 비루트 파티션에 기본 적용 권장 |
| `relatime` | ★★★ | atime 갱신 최적화 (기본값) | 대부분 서버 및 데스크톱 환경 기본 |
| `noatime`/`nodiratime` | ★★☆ | 읽기 성능 향상, 쓰기 감소 | atime 의존 애플리케이션 확인 필요 |
| `sync`/`async` | ★★☆ | 모든 쓰기 동기화/비동기 캐싱 | `sync`는 안정성↑ 성능↓ |
| `discard` | ★★☆ | 온라인 TRIM (SSD 전용) | 타이머 기반 `fstrim.timer` 대안 권장 |
| `errors=remount-ro` (ext 계열) | ★★☆ | 오류 시 자동 읽기전용 재마운트 | 파일 시스템 손상 확산 방지 |
| `data=ordered/journal/writeback` (ext4) | ★★☆ | 저널링 전략 선택 | `ordered`가 안전한 기본값 |
| `noautodefrag`/`autodefrag` (Btrfs) | ★★☆ | 랜덤 I/O 워크로드 최적화 | 데이터베이스 워크로드 비권장 |
| `inode64` (XFS) | ★★☆ | 64비트 inode 지원 (대용량) | 구형 유틸리티 호환성 확인 필요 |
| `compress=zstd` (Btrfs) | ★★☆ | 투명 압축 활성화 | 로그 및 텍스트 파일에 효과적 |

### `/tmp` 보안 마운트 권장 패턴

일시적인 보안 설정 적용:
```bash
sudo mount -o remount,noexec,nosuid,nodev /tmp
```

`/etc/fstab`을 통한 영구적 설정 (별도 파티션 또는 tmpfs):

```fstab
# 별도 파티션 사용 시
UUID=xxxx-xxxx  /tmp  ext4  rw,nosuid,nodev,noexec,relatime  0 2

# 메모리 기반 tmpfs (용량 상한 설정)
tmpfs  /tmp  tmpfs  rw,nosuid,nodev,noexec,mode=1777,size=2G  0  0
```

`mode=1777`은 스티키 비트를 포함한 공개 임시 디렉토리 표준 권한입니다.

### 바인드 마운트와 권한 상속

바인드 마운트를 사용하면 한 디렉토리를 다른 경로에 다시 마운트할 수 있습니다:

```bash
# 기본 바인드 마운트
sudo mount --bind /srv/app/data /var/www/data

# 보안 옵션 추가 적용 (새로운 마운트에만 적용)
sudo mount -o remount,bind,ro,nodev,nosuid /var/www/data
```

`/etc/fstab` 설정 예시:
```fstab
/srv/app/data  /var/www/data  none  bind  0 0
/var/www/data  /var/www/data  none  remount,bind,ro,nodev,nosuid  0 0
```

### OverlayFS (컨테이너 및 빌드 캐시에 활용)

OverlayFS는 읽기 전용 레이어와 쓰기 가능 레이어를 결합한 파일 시스템입니다:

```bash
sudo mkdir -p /overlay/{lower,upper,work,merged}
sudo mount -t overlay overlay \
  -o lowerdir=/overlay/lower,upperdir=/overlay/upper,workdir=/overlay/work \
  /overlay/merged
```

- `lowerdir`: 읽기 전용 베이스 레이어
- `upperdir`: 쓰기 가능 레이어
- `workdir`: 작업 디렉토리
- 이미지 빌드, 일시적 테스트 환경에 유용합니다

---

## `/etc/fstab` — 안전한 자동 마운트 설계

### 기본 형식 및 패턴

```text
<장치>   <마운트위치>  <FS타입>  <옵션>                         <dump> <pass>
UUID=... /data         ext4      defaults,noatime              0      2
LABEL=LOGS /var/log    xfs       rw,noatime,attr2,inode64      0      2
```

- **장치 지정 우선순위**: `UUID` > `LABEL` > `/dev/sdX` (udev 순서 변동 위험 회피)
- **fsck(pass)**: `1`=루트, `2`=기타, `0`=검사 안함

UUID 확인 방법:
```bash
sudo blkid
ls -l /dev/disk/by-uuid/
```

### 실패에 강한 마운트 설정

네트워크 파일 시스템(NFS, CIFS)의 경우 부팅 지연을 방지해야 합니다:

```fstab
server:/share /mnt/nfs  nfs  defaults,_netdev,noauto,x-systemd.automount,x-systemd.device-timeout=5s  0 0
```

- `_netdev`: 네트워크 준비 후 마운트
- `x-systemd.automount`: 접근 시 자동 마운트
- `x-systemd.device-timeout=5s`: 장치/네트워크 지연 시 빠른 포기

### LUKS 암호화와 LVM/RAID 결합

LUKS 암호화 해제 후 논리 장치를 fstab에 기록합니다:

```bash
# 암호화 해제 (부팅 시 systemd-cryptsetup가 처리)
sudo cryptsetup open /dev/sdb1 DATA_CRYPT
sudo mkfs.ext4 /dev/mapper/DATA_CRYPT
```

`/etc/crypttab`과 `/etc/fstab`을 함께 관리합니다:

```conf
# /etc/crypttab
DATA_CRYPT UUID=<uuid-of-sdb1> none luks,discard

# /etc/fstab
/dev/mapper/DATA_CRYPT  /secure  ext4  rw,relatime,errors=remount-ro  0 2
```

LVM이나 RAID를 사용하는 경우 매핑된 논리 장치를 기준으로 fstab을 구성합니다 (`/dev/mapper/vg-lv`, `/dev/md0` 등).

---

## 자동 마운트: systemd-automount vs autofs

### systemd-automount (간단한 구현)

```fstab
server:/share  /mnt/share  nfs  noauto,x-systemd.automount,_netdev,vers=4.2  0 0
```

- **장점**: 간편함, systemd 종속성 관리, 대부분의 사용 사례에 충분
- **단점**: autofs의 복잡한 동적 매핑 및 토폴로지 기능은 제한적

### autofs (대규모/동적 환경)

설치 및 기본 맵 구성:
```bash
sudo apt install autofs
echo "/nfs  /etc/auto.nfs --timeout=60 --ghost" | sudo tee -a /etc/auto.master
echo "project  -fstype=nfs4  server:/exports/project" | sudo tee /etc/auto.nfs
sudo systemctl enable --now autofs
```

- `/nfs/project` 접근 시 자동 마운트
- LDAP 또는 동적 맵과 결합하여 대규모 NFS 트리 자동화에 적합

---

## 파일 시스템 점검 및 유지보수 도구

### ext4: fsck, tune2fs, e2label

```bash
# 안전한 점검: 언마운트 후 실행
sudo umount /dev/sda1
sudo e2fsck -f -C 0 /dev/sda1      # 강제 점검, 진행률 표시
sudo tune2fs -c 30 -i 1m /dev/sda1 # 30회 마운트 또는 1개월마다 점검 설정
sudo e2label /dev/sda1 DATA_DISK   # 레이블 지정
```

부팅 시 강제 점검을 원하는 경우 루트에 `forcefsck` 파일을 생성한 후 재부팅합니다 (배포판별 방법 상이).

### XFS: xfs_repair

```bash
sudo umount /dev/sdb1
sudo xfs_repair -n /dev/sdb1   # 시뮬레이션 실행 (권장)
sudo xfs_repair /dev/sdb1      # 실제 수리 실행
```

XFS는 저널 구조와 디렉토리/할당 설계가 ext 계열과 다르므로 전용 도구만 사용해야 합니다.

### Btrfs: scrub, check, 스냅샷

```bash
# 온라인 무결성 검사 (블록 레벨 검증, RAID 시 자동 복구)
sudo btrfs scrub start -Bd /mnt

# 오프라인 검사 (신중히 실행)
sudo umount /dev/sdc1
sudo btrfs check --readonly /dev/sdc1
```

스냅샷 생성 및 관리:
```bash
sudo btrfs subvolume snapshot -r /mnt/@ /mnt/@snap-$(date +%F)
sudo btrfs subvolume list /mnt
# 롤백 시 스냅샷을 원본 서브볼륨으로 교체하여 마운트
```

### SSD TRIM: 온라인 vs 타이머

```bash
# 일회성 TRIM 실행
sudo fstrim -av

# 주기적 TRIM 활성화 (권장)
systemctl enable --now fstrim.timer
```

---

## 성능, 내구성, 보안 튜닝

### 특수 용도 파티션 구성

- `/var/log`: 별도 파티션/XFS 권장 (로그 폭주 시 시스템 보호)
- `/tmp`: tmpfs + `noexec,nosuid,nodev` 옵션
- 컨테이너 빌드 캐시: OverlayFS 또는 전용 SSD로 IOPS 분리

### ext4 저널 크기 및 전략 조정

```bash
# 저널 크기 조정 (언마운트 필요)
sudo tune2fs -J size=512 /dev/sda1   # 512MB 저널 설정

# 마운트 전략 옵션
# data=ordered (기본, 안전), writeback (성능↑, 메타데이터만 저널링)
```

### atime 정책 선택

- 기본값 `relatime`이 대부분의 경우 충분합니다
- 데이터베이스나 메일 서버 등 atime 의존성이 없는 경우 `noatime`으로 쓰기 작업 감소
- 백업/동기화 도구의 atime 사용 여부를 사전에 확인합니다

### SELinux/AppArmor 컨텍스트 관리

파일 이동 또는 복구 후 컨텍스트 복원:
```bash
sudo restorecon -R /var/www /var/spool/postfix /data
```

---

## Quota 및 Project Quota 관리

### 사용자/그룹 쿼터 (ext4, XFS)

`/etc/fstab`에 마운트 옵션 추가:
```fstab
UUID=... /home  ext4  usrquota,grpquota  0 2
```

활성화 및 관리:
```bash
sudo mount -o remount /home
sudo quotacheck -cum /home
sudo quotaon /home
sudo edquota alice
quota -u alice
```

### XFS Project Quota (디렉토리 단위)

마운트 옵션: `prjquota` 또는 `pquota`
```fstab
UUID=... /data  xfs  rw,noatime,prjquota  0 2
```

프로젝트 정의:
```ini
# /etc/projects
100:/data/teamA

# /etc/projid
teamA:100
```

적용 및 한도 설정:
```bash
sudo xfs_quota -x -c 'project -s teamA' /data
sudo xfs_quota -x -c 'limit -p bhard=200g teamA' /data
xfs_quota -x -c 'report -p' /data
```

대규모 멀티테넌트 스토리지 환경에서 디렉토리 수준의 정확한 제한이 가능합니다.

---

## 시나리오별 설계 및 운영 레시피

### 시나리오 A — 보안 강화를 위한 디렉토리 분리

```fstab
tmpfs       /tmp        tmpfs  rw,nosuid,nodev,noexec,mode=1777,size=2G  0 0
UUID=...    /var/tmp    ext4   rw,nosuid,nodev,noexec,relatime           0 2
UUID=...    /var/lib/containers  xfs  rw,noatime,attr2,inode64          0 2
```

- `/tmp`: 휘발성 메모리 기반
- `/var/tmp`: 영구 저장소 기반 (표준 규약)
- 컨테이너 레이어/이미지: XFS/SSD에 분리 구성

### 시나리오 B — NFS 공유 지연 마운트

```fstab
server:/export/builds  /n/builds  nfs  noauto,_netdev,x-systemd.automount,vers=4.2  0 0
```

- 접근 시 자동 마운트, 부팅 지연 방지, 네트워크 종속성 자동 처리

### 시나리오 C — 데이터 파티션 최적화

```bash
sudo tune2fs -m 1 /dev/sdb1           # 예약 블록 1% 설정 (데이터 전용)
sudo tune2fs -J size=1024 /dev/sdb1   # 쓰기 폭주 시 저널 확대로 안정성 향상
```

`/etc/fstab` 설정:
```fstab
UUID=...  /data  ext4  rw,noatime,errors=remount-ro  0 2
```

### 시나리오 D — 삭제된 파일의 공간 회수 문제

```bash
lsof +L1 | awk 'NR==1 || $7<0'    # 링크 카운트 0이지만 열려 있는 파일 확인
# 관련 서비스 재시작으로 즉시 공간 회수
```

### 시나리오 E — Btrfs 압축 및 스냅샷 기반 배포

```bash
# 마운트 옵션
UUID=... /srv  btrfs  rw,compress=zstd,ssd,space_cache=v2  0 0

# 스냅샷 생성
btrfs subvolume snapshot -r /srv/@app /srv/@app-$(date +%F)
# 롤백 시 스냅샷을 마운트 대상으로 전환
```

---

## 점검 및 모니터링 자동화

### 정기적 디스크 사용량 모니터링 스크립트

```bash
#!/usr/bin/env bash

TH=90
MSG=""
while read -r use mnt; do
  u=${use%%%}
  (( u>=TH )) && MSG+="$mnt at $use\n"
done < <(df -hP | awk 'NR>1{print $5, $6}')

while read -r use mnt; do
  u=${use%%%}
  (( u>=TH )) && MSG+="(inode) $mnt at $use\n"
done < <(df -Pi | awk 'NR>1{print $5, $6}')

[ -n "$MSG" ] && printf "Disk Alert %s:\n%b" "$(hostname)" "$MSG" \
 | mail -s "Disk Alert $(hostname)" admin@example.com
```

### 주간 유지보수 작업

- `fstrim.timer` 활성화로 주기적 SSD TRIM 실행
- 저널 로그 정리:
```bash
journalctl --vacuum-time=7d
```

크론 예시:
```cron
# /etc/cron.weekly/log-vacuum
#!/bin/sh
journalctl --vacuum-time=7d
```

---

## 안전한 파일 시스템 작업을 위한 체크리스트

- fstab 수정 전 `sudo mount -a` 명령으로 구문 및 접속 검증
- 네트워크 파일 시스템에는 `_netdev` + `x-systemd.automount`로 부팅 지연 방지
- 보안 영역(`/tmp`, 다운로드 디렉토리)은 `noexec,nosuid,nodev` 옵션 적용
- ext4 데이터 파티션은 `noatime`, 루트 및 시스템 파티션은 `relatime` 유지 권장
- XFS 점검은 `xfs_repair`, ext4는 `e2fsck`, Btrfs는 `scrub`/스냅샷 우선
- **스냅샷 또는 백업 후**에 파일 시스템 조정 작업 수행
- LUKS/LVM/RAID 스택 사용 시 매핑 순서 및 시스템 의존성 확인
- SELinux 컨텍스트 복원을 위해 `restorecon -R <path>` 실행

---

## 안전한 fstab 템플릿 예시

```fstab
# 루트 파일 시스템 (안정성 우선)
UUID=ROOT-UUID  /       ext4  rw,relatime,errors=remount-ro  0 1

# 홈 디렉토리 (다수 사용자, XFS 권장)
UUID=HOME-UUID  /home   xfs   rw,noatime,attr2,inode64  0 2

# 로그 디렉토리 (폭주 보호를 위한 분리)
UUID=LOGS-UUID  /var/log  xfs  rw,noatime,attr2,inode64  0 2

# 임시 디렉토리 (메모리 기반, 용량 제한)
tmpfs  /tmp  tmpfs  rw,nosuid,nodev,noexec,mode=1777,size=2G  0 0

# 데이터 저장소 (대용량 ext4, 성능 최적화)
UUID=DATA-UUID  /data  ext4  rw,noatime  0 2

# NFS 공유 (자동 마운트)
server:/export/share  /mnt/share  nfs  noauto,_netdev,x-systemd.automount,vers=4.2  0 0
```

---

## 유용한 진단 명령어 모음

```bash
# fstab 구문 검증 (실제 마운트 없이)
sudo mount -a

# 현재 마운트 상태 확인
findmnt -t ext4,xfs,btrfs
mount | column -t

# 블록 장치 및 파일 시스템 정보
lsblk -f
blkid

# 삭제되었지만 여전히 열려 있는 파일 확인
lsof +L1 | awk 'NR==1 || $7<0'
```

---

## 결론

파일 시스템 관리는 리눅스 시스템 운영의 핵심 요소입니다. 마운트 옵션은 단순한 설정 스위치가 아니라 시스템의 보안, 성능, 복구 전략을 결정하는 중요한 요소입니다. 적절한 옵션 선택을 통해 시스템의 안정성과 효율성을 크게 향상시킬 수 있습니다.

자동 마운트 설정은 시스템 부팅의 신뢰성에 직접적인 영향을 미칩니다. 대부분의 경우 `systemd-automount`로 충분하지만, 대규모 NFS 환경이나 동적 매핑이 필요한 경우 `autofs`를 고려해야 합니다.

파일 시스템 점검과 유지보수는 각 파일 시스템 유형별 전용 도구를 사용해야 합니다. 작업 전에 항상 스냅샷이나 백업을 수행하는 습관이 중요합니다. 쿼터 및 프로젝트 쿼터 시스템을 활용하면 멀티테넌트 환경에서의 자원 충돌을 효과적으로 관리할 수 있습니다.

실제 운영 환경에서는 본 문서에서 제시한 템플릿, 스크립트, 체크리스트를 참고하여 안전하고 효율적이며 복구 가능한 파일 시스템 운영 체계를 구축하는 것이 좋습니다. 파일 시스템 설정은 한 번 구성하면 장기간 유지되는 경우가 많으므로, 초기 설계와 구성에 충분한 시간을 투자하는 것이 장기적인 시스템 안정성에 기여합니다.

궁극적으로 파일 시스템 관리는 단순한 기술적 작업을 넘어 시스템의 전반적인 아키텍처와 운영 철학을 반영합니다. 체계적인 접근과 지속적인 모니터링을 통해 예측 가능하고 신뢰할 수 있는 시스템 환경을 조성할 수 있습니다.