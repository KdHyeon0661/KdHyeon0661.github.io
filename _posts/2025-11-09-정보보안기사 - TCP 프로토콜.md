---
layout: post
title: 정보보안기사 - TCP 프로토콜
date: 2025-11-09 14:25:23 +0900
category: 정보보안기사
---
# SECTION 04 네트워크 기본 학습 — 06. TCP 프로토콜

## 1. TCP가 제공하는 것

- **신뢰성**: 순서 보장, 손실 복구(재전송), 중복 제거.
- **흐름 제어**: **수신 윈도우(rwnd)** 기반의 송신 속도 조절(수신 버퍼 보호).
- **혼잡 제어**: **cwnd**를 동적으로 조절해 네트워크 혼잡 방지(슬로 스타트/혼잡 회피 등).
- **스트림**: 바이트 스트림(메시지 경계 없음).
- **전이중**: 양방향 동시 전송.
- **커넥션 지향**: 3-way handshake로 상태 수립.

---

## 2. TCP 헤더 구조(20B 고정 + 옵션)

### 2.1 ASCII 다이어그램

```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-------------------------------+-------------------------------+
|          Source Port          |       Destination Port        |
+-------------------------------+-------------------------------+
|                        Sequence Number                        |
+---------------------------------------------------------------+
|                    Acknowledgment Number                      |
+---+----+-----------------------+------------------------------+
|HLN| RSV|C|E|U|A|P|R|S|F|       Window Size                   |
|   |    |W|C|R|C|S|S|Y|I|                                      |
+---+----+-----------------------+------------------------------+
|       Checksum                |   Urgent Pointer (rare)       |
+-------------------------------+-------------------------------+
|                    Options (0–40B) + Padding                  |
+---------------------------------------------------------------+
```

- **HLN(Data Offset)**: 32비트 워드 수(최소 5=20B).
- **플래그**: CWR, ECE, URG, ACK, PSH, RST, SYN, FIN.
- **Window Size**: 수신측이 광고하는 **rwnd**(윈도우 스케일 이전 값).
- **Options**: MSS, Window Scale, SACK Permitted/Blocks, Timestamps 등.

### 2.2 주요 필드 요약

| 필드 | 의미/운영 포인트 |
|---|---|
| Source/Dest Port | 0–65535(에페멀 포트 중요) |
| Seq/Ack | 바이트 단위 순서 번호, 누적 ACK(Selective ACK은 옵션) |
| Flags | SYN/ACK/RST/FIN/PSH/URG + ECN(CWR/ECE) |
| Window Size | **흐름 제어**(수신 버퍼 잔여 용량, 스케일 적용 전 값) |
| Checksum | 의무, 페이로드 포함(IPv4 pseudo-header 포함) |
| Urgent | 레거시(거의 사용 안 함) |
| Options | **성능·복구 핵심**(MSS/WS/SACK/TS 등) |

---

## 3. 연결 수립/종료(3-way/4-way)와 상태

### 3.1 3-way Handshake

1) **SYN**(ISN=x, 옵션: MSS/WS/SACK/TS)
2) **SYN+ACK**(ISN=y, Ack=x+1, 동일 옵션 협상)
3) **ACK**(Ack=y+1) → **ESTABLISHED**

**보안/성능 포인트**
- SYN backlog 큐, **SYN cookies**(SYN flood 방어), MSS/WS/TS/SACK 협상.

### 3.2 종료(4-way) & Half-Close

- **일반**: FIN → ACK / FIN → ACK (양방향 각각 종료)
- **Half-close**: 한쪽은 송신만 종료하고 수신은 유지.

### 3.3 상태 머신(요약)

```
CLOSED
  | (connect)
SYN-SENT <-----> SYN-RECEIVED
  |                |
ESTABLISHED <------> ESTABLISHED
  | (close)                 (close)
FIN-WAIT-1            CLOSE-WAIT
FIN-WAIT-2            LAST-ACK
TIME-WAIT <----------- CLOSING
CLOSED
```

- **TIME-WAIT**: 2MSL 동안 대기(지연 중복 세그먼트 흡수).
- **서버는 CLOSE-WAIT 많음**: 애플리케이션이 `close()` 지연 시 누적.

---

## 4. 시퀀스/ACK/슬라이딩 윈도우

### 4.1 누적 ACK & 슬라이딩 윈도우

- 수신측은 **가장 마지막에 연속으로 받은 바이트 다음 번호**를 ACK.
- 송신측 **전송 윈도우 = min(rwnd, cwnd)** 내에서만 새로운 데이터 전송.

**핵심 식**
$$
\text{Throughput} \le \frac{\min(\text{rwnd}, \text{cwnd})}{\text{RTT}}
$$

### 4.2 BDP(대역폭-지연 곱)

- 링크 대역폭 \(B\) (bit/s), 왕복 지연 \(RTT\) (s), 효율적 전송에 필요한 **윈도우(바이트)**:
$$
\text{BDP} = \frac{B \times RTT}{8}
$$
- 예: 1 Gbps, 50 ms → BDP ≈ \(1e9 \times 0.05 / 8 = 6.25\) MB
  → 윈도우 스케일 없으면 65,535B로는 절대 도달 불가 → **WSOPT 필수**.

---

## 5. 흐름 제어(rwnd)와 SWS(바보 윈도우)

- **rwnd**: 수신 버퍼 여유를 송신자에 통지. Zero Window 시 **Persist Timer**로 ZWP(Zero Window Probe) 송신.
- **Silly Window Syndrome(SWS)**: 아주 작은 세그먼트/윈도우 업데이트로 비효율.
  - **송신 측**: **Nagle 알고리즘**(작은 세그먼트 합치기).
  - **수신 측**: **Clark’s solution**(의미 있는 크기 될 때까지 광고 지연).

**Nagle ↔ Delayed ACK 상호작용**
- 쌍으로 지연을 유발할 수 있음(소량/대화형 트래픽).
- **대화형/실시간 앱**: `TCP_NODELAY`로 Nagle 끄는 것을 검토.

---

## 6. 혼잡 제어(cwnd) — 슬로 스타트, 혼잡 회피, Fast Retransmit/Recovery

### 6.1 알고리즘 개요

- **슬로 스타트**: `cwnd`가 **1 MSS**에서 시작해 **RTT당 2배** 성장(ACK마다 MSS만큼 증가). `cwnd >= ssthresh`면 혼잡 회피로 전환.
- **혼잡 회피**: **AIMD**(Additive Increase, Multiplicative Decrease) — RTT당 **선형 증가**, 손실 시 절반으로 감소.
- **Fast Retransmit/Recovery**: **중복 ACK 3개** 받으면 재전송(타임아웃 전에), `ssthresh` 조정 후 빠른 회복.

### 6.2 CWND 성장(개념 그래프)

```
cwnd
 ^       /\
 |      /  \______
 |     /           \___     (손실 시 절반으로)
 |____/                 \___
  time -->
```

**핵심**: `cwnd`는 **네트워크 혼잡 신호**에 의해 조절된다(손실/ECN).

---

## 7. 타이머와 RTO(재전송 타임아웃)

### 7.1 RTT 샘플링 & RTO 추정(Jacobson/Karels)

- **SRTT**: 평활화 RTT, **RTTVAR**: 변동성 추정.
- **RTO**(초기값 보수적):
$$
\text{RTO} = \text{SRTT} + 4 \times \text{RTTVAR}
$$
- 재전송 시 **지수 백오프**.

### 7.2 Delayed ACK

- 수신측은 즉시 ACK 대신 **소량 지연(수 ms, 보통 ≤40ms)** 후 ACK 보내 효율 향상.
- **작은 메시지 상호작용**에서는 지연 유발 → 필요시 비활성화/튜닝.

---

## 8. TCP 옵션 — 성능/복구의 핵심

| 옵션 | 의미/운영 포인트 |
|---|---|
| **MSS(Max Segment Size)** | 세그먼트 최대 페이로드(상대방에게 내가 받을 수 있는 최대). PMTUD 연계 |
| **Window Scale(WSOPT)** | 2^S 스케일(최대 14). 대역폭·지연 큰 링크에서 필수 |
| **SACK Permitted/Blocks** | 부분 누락 복구(패킷 손실 환경에서 대폭 성능↑) |
| **Timestamps(TSval/TSecr)** | 정확한 RTT 추정, PAWS(순서 보호), RTO 정확도↑ |
| **MD5(BGP)** | 세션 무결성(특정 워크로드) |
| **ECN(CWR/ECE)** | 혼잡 신호를 손실 없이 전달(네트워크·엔드 호스트 지원 필요) |

**Wireshark 디스플레이 예**
```
tcp.options.mss
tcp.options.wscale
tcp.options.sack_perm
tcp.options.timestamp
```

---

## 9. 성능/튜닝(리눅스 중심, 일부 윈도우 포함)

### 9.1 리눅스 sysctl 주요 파라미터

```bash
# 1. 혼잡 제어 알고리즘 확인/설정 (cubic 기본)
sysctl -w net.ipv4.tcp_congestion_control=cubic

# 2. 버퍼 자동튜닝
sysctl -w net.ipv4.tcp_rmem="4096 87380 33554432"
sysctl -w net.ipv4.tcp_wmem="4096 65536 33554432"

# 3. 윈도우 스케일/타임스탬프/SACK (대부분 기본 사용)
sysctl -w net.ipv4.tcp_window_scaling=1
sysctl -w net.ipv4.tcp_timestamps=1
sysctl -w net.ipv4.tcp_sack=1

# 4. SYN backlog / 재시도 / SYN쿠키
sysctl -w net.ipv4.tcp_max_syn_backlog=4096
sysctl -w net.ipv4.tcp_synack_retries=5
sysctl -w net.ipv4.tcp_syncookies=1

# 5. TIME-WAIT / FIN 타임아웃
sysctl -w net.ipv4.tcp_fin_timeout=30
# net.ipv4.tcp_tw_reuse=1 은 최신 커널에서 비권장(문서/버전 확인)

# 6. Keepalive
sysctl -w net.ipv4.tcp_keepalive_time=600
sysctl -w net.ipv4.tcp_keepalive_intvl=30
sysctl -w net.ipv4.tcp_keepalive_probes=5
```

### 9.2 윈도우(개요)

- **Auto-Tuning Level**: 수신 윈도우 자동 조절(기본 활성).
- PowerShell:
```powershell
netsh interface tcp show global
# Receive Window Auto-Tuning Level, Add-On Congestion Control 등 확인
```

### 9.3 애플리케이션 레벨

- **Nagle 비활성화**(지연 민감): `TCP_NODELAY`.
- **SO_REUSEADDR/SO_REUSEPORT**: TIME_WAIT/포트 바인딩 이슈 완화(다중 리스닝 스레드).
- **Keepalive**: 장기 유휴 세션 탐지/정리(로드밸런서 Idle Timeout 대비).
- **MSS/PMTUD**: 터널·VPN 경로에서 **MSS Clamp**(방화벽/라우터) 적용.

---

## 10. NAT/부하분산/중간 장비와 TCP

- **NAT**: 5튜플 변환, **에페멀 포트 고갈**(대규모 연결) 위험 → 포트 범위/해시 분산 설계.
- **LB(로드밸런서)**: L4 vs L7, **Proxy 모드**(연결 분리)에서 RTT/혼잡 제어 경계 변경.
- **중간박스**: MSS/WS/TS/SACK **변형/삭제** 가능 → 성능/호환성 이슈.
- **RST/ACK 인젝션**: 중간장비가 트래픽 제어/차단을 위해 RST 삽입(보안 장비 정책 확인).

---

## 11. 보안 — SYN Flood, RST Injection, 하이재킹(개요)

### 11.1 SYN Flood

- **원리**: 다수의 **SYN**으로 backlog 점유, ACK 미전송 → 서버 리소스 고갈.
- **대응**: **SYN cookies**, 백로그 확대, **SYN Proxy/LB**, RTT 기반 보호, Rate Limit/Geo/IP 평판.

```bash
# 리눅스
sysctl -w net.ipv4.tcp_syncookies=1
sysctl -w net.ipv4.tcp_max_syn_backlog=4096
```

### 11.2 TCP RST Injection

- **상황**: BGP 세션 차단, 장기 세션 강제 종료 등.
- **완화**: MD5(Signature) 사용(BGP), 경로 암호화(TLS/IPsec), 미러링·검증.

### 11.3 세션 하이재킹(구형)

- **ISN 예측/스니핑**으로 **Seq/Ack** 끼워넣기.
- **현대**: 난수화 ISN, 스위치 분할/암호화로 난이도↑.

---

## 12. 패킷 분석 — tcpdump/Wireshark

**tcpdump 필터**
```bash
# 3-way 관찰
sudo tcpdump -nni eth0 'tcp[tcpflags] & (tcp-syn|tcp-ack) != 0'
# SYN만
sudo tcpdump -nni eth0 'tcp[tcpflags] & tcp-syn != 0 and tcp[tcpflags] & tcp-ack == 0'
# 재전송 의심(동일 시퀀스 반복)
sudo tcpdump -nni eth0 'tcp[13] & 0x10 != 0'  # ACK 포함 필터, 후 분석
```

**Wireshark 디스플레이**
```
tcp.flags.syn == 1
tcp.analysis.retransmission
tcp.window_size_value
tcp.options.sack
tcp.analysis.duplicate_ack
```

**읽기 팁**
- `Seq=x(상대 Ack-1)`, `Ack=y(상대 Seq+수신 데이터)`
- **ZeroWindow**/`tcp.analysis.zero_window` 경고 확인.
- **Out-of-Order** vs **Retransmission**: 네트워크 vs 손실 차이 파악.

---

## 13. 코드 예제 — Python/PowerShell

### 13.1 Python: 간단 Echo 서버/클라이언트

```python
# tcp_echo_server.py
import socket, os

HOST, PORT = "0.0.0.0", 5000
with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
    # TIME_WAIT 재사용/다중 바인딩 완화
    s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    s.bind((HOST, PORT))
    s.listen(128)
    print(f"PID {os.getpid()} listening on {HOST}:{PORT}")
    while True:
        conn, addr = s.accept()
        with conn:
            # 지연 민감 테스트: Nagle off (선택)
            conn.setsockopt(socket.IPPROTO_TCP, socket.TCP_NODELAY, 1)
            print("connected:", addr)
            while True:
                data = conn.recv(4096)
                if not data:
                    break
                conn.sendall(data)  # echo
```

```python
# tcp_echo_client.py
import socket, sys
HOST, PORT = sys.argv[1], int(sys.argv[2])
with socket.create_connection((HOST, PORT), timeout=5) as s:
    s.setsockopt(socket.IPPROTO_TCP, socket.TCP_NODELAY, 1)
    s.sendall(b"hello tcp\n")
    print("recv:", s.recv(1024))
```

### 13.2 PowerShell: .NET TcpClient

```powershell
# Send a line, print reply
$client = New-Object System.Net.Sockets.TcpClient
$client.Connect("127.0.0.1", 5000)

$stream = $client.GetStream()
$writer = New-Object System.IO.StreamWriter($stream)
$reader = New-Object System.IO.StreamReader($stream)
$writer.AutoFlush = $true

$writer.WriteLine("hello from powershell")
$resp = $reader.ReadLine()
"recv: $resp"

$client.Close()
```

---

## 14. 방화벽·정책 스니펫

### 14.1 리눅스 nftables

```bash
nft add table inet filter
nft add chain inet filter input { type filter hook input priority 0; policy drop; }
nft add rule inet filter input ct state established,related accept
nft add rule inet filter input tcp dport {22,80,443} ct state new accept
# SYN Rate Limit(DoS 완화 보조)
nft add rule inet filter input tcp flags syn limit rate 50/second accept
nft add rule inet filter input tcp flags syn drop
```

### 14.2 윈도우 고급 방화벽(개요)

- 인바운드 규칙: 포트/프로그램/프로필 별 허용.
- **Stateful**: 세션 기반 허용, 새 연결(NEW)만 필터.

---

## 15. 트러블슈팅 체크리스트

- [ ] **MSS/PMTUD**: 터널/PPPoE 경로에서 MSS clamp 필요? ICMP Frag Needed 허용?
- [ ] **Zero Window**: 수신 애플리케이션 병목/버퍼 부족.
- [ ] **Retransmission 증가**: 손실/혼잡/중간 장비 큐 오버플로.
- [ ] **TIME-WAIT 누적**: 단기 클라이언트 폭주. 포트 고갈/바인딩 실패? (REUSEPORT/가속기 사용).
- [ ] **SYN backlog 초과**: SYN flood or 피크. SYN cookies/프록시/LB 도입.
- [ ] **Nagle/Delayed ACK 상호작용**: 지연 민감 서비스에서 TCP_NODELAY 검토.
- [ ] **LB/프록시**: 양단 RTT/혼잡 경계가 바뀜. 타임아웃/버퍼/헬스체크 점검.

---

## 16. 예상 문제(필기/실무)

1) **Throughput ≤ min(rwnd, cwnd) / RTT** 식의 의미를 BDP와 함께 설명하라.
2) **슬로 스타트/혼잡 회피/빠른 재전송**의 차이와 전환 조건을 서술하라.
3) **MSS/WS/SACK/TS** 옵션 각각의 역할과 성능 상 이점을 요약하라.
4) **Silly Window Syndrome**을 방지하는 송신/수신 측 메커니즘을 쓰라.
5) **TIME-WAIT** 상태의 목적과 서버 측에서 다중 리스너 운영 시 완화 방안을 제시하라.
6) **SYN Flood**의 원리와 서버/네트워크 차원의 방어 기법을 두 가지 이상 제시하라.
7) **PMTUD 실패**의 증상과 방화벽에서 필요한 허용 규칙을 구체적으로 쓰라.

---

## 17. 미니 랩(실습)

### 랩 A — 혼잡/손실 관찰(로컬 랩)

1) 서버/클라이언트 사이에 `tc qdisc`로 손실/지연 삽입.
```bash
# 50ms 지연, 1% 손실
sudo tc qdisc add dev eth0 root netem delay 50ms loss 1%
```
2) 대용량 송수신(`iperf3`) 후 Wireshark에서 `tcp.analysis.retransmission`, `SACK` 동작 관찰.
3) 손실 제거 후 Throughput 비교.

### 랩 B — Nagle/Delayed ACK 효과

1) Echo 서버 실행 후 클라이언트에서 1바이트씩 1000회 전송.
2) `TCP_NODELAY` on/off로 RTT·총 소요시간 비교.

### 랩 C — MSS Clamp & PMTUD

1) 경로에 터널을 두어 MTU 축소.
2) **iptables mangle**로 MSS clamp:
```bash
iptables -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN \
  -j TCPMSS --clamp-mss-to-pmtu
```
3) 대용량 다운로드 시 단절 현상 해소 여부 확인.

---

## 18. 요약/결론

- TCP의 성능은 **rwnd·cwnd·RTT**와 **옵션(MSS/WS/SACK/TS)**의 상호작용으로 결정된다.
- 운영의 핵심은 **PMTUD 정상화**, **SACK/TS/WS 활성**, **SYN 보호**, **버퍼/타임아웃 튜닝**, **가시성 확보**다.
- 보안은 **SYN Flood 방어**, **RST 인젝션/미들박스 고려**, **정상/이상 세션을 구분**하는 모니터링이 관건이다.
- 본 장의 표/식/스니펫/랩을 기준으로, 환경별 **파일럿 → 관찰 → 점진 적용**을 수행한다.
