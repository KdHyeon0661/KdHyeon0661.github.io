---
layout: post
title: TCPIP - ê°€ìƒí™”Â·í´ë¼ìš°ë“œÂ·ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí‚¹
date: 2025-09-04 19:25:23 +0900
category: TCPIP
---
# ê°€ìƒí™”Â·í´ë¼ìš°ë“œÂ·ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí‚¹

**(ğŸ”° í•˜ì´í¼ë°”ì´ì €Â·ë¸Œë¦¬ì§€Â·ê°€ìƒ NIC, âš™ï¸ í´ë¼ìš°ë“œ VPCÂ·ì„œë¸Œë„·Â·ë¼ìš°íŒ…Â·NATÂ·SG/NACL, âš™ï¸ ì»¨í…Œì´ë„ˆ CNIÂ·Pod ë„¤íŠ¸ì›Œí¬Â·Service/Ingress, ğŸš€ ì˜¤ë²„ë ˆì´(VXLAN/GRE)Â·eBPF ë°ì´í„°íŒ¨ìŠ¤)**

> ì´ ì¥ì€ â€œ**í•œ ëŒ€ì˜ ë¬¼ë¦¬ ì„œë²„/ë§í¬ ìœ„ì— ìˆ˜ì‹­~ìˆ˜ì²œ ì›Œí¬ë¡œë“œê°€ ê³µì¡´**â€í•˜ëŠ” ì‹œëŒ€ì˜ ë„¤íŠ¸ì›Œí‚¹ì„ **ì›ë¦¬â†’ì„¤ê³„â†’ìš´ì˜â†’ë””ë²„ê¹…** ìˆœìœ¼ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.
> ì½”ë“œ/ëª…ë ¹ì€ ```ë¡œ, ê°„ë‹¨ ìˆ˜ì‹ì€ *MathJax*ë¡œ í‘œê¸°í•©ë‹ˆë‹¤. (ì˜ˆì œëŠ” ë¦¬ëˆ…ìŠ¤ ê¸°ì¤€ì´ ë§ì§€ë§Œ ì›ë¦¬ëŠ” ê³µí†µ)

---

## í•˜ì´í¼ë°”ì´ì €Â·ë¸Œë¦¬ì§€Â·ê°€ìƒ NIC (ğŸ”°)

### í•˜ì´í¼ë°”ì´ì € ê°œë…

- **Type-1(ë² ì–´ë©”íƒˆ)**: ESXi, Hyper-V, KVM(on baremetal). í•˜ë“œì›¨ì–´ ìœ„ì—ì„œ ì§ì ‘ VM ìŠ¤ì¼€ì¤„.
- **Type-2(í˜¸ìŠ¤íŠ¸ ê¸°ë°˜)**: VirtualBox, VMware Workstation. í˜¸ìŠ¤íŠ¸ OS ìœ„ VMM êµ¬ë™.
- **ì—­í• **: **ê°€ìƒ ìŠ¤ìœ„ì¹˜**(vSwitch/ë¦¬ëˆ…ìŠ¤ ë¸Œë¦¬ì§€/OVS), **ê°€ìƒ NIC**(vNIC: virtio-net/e1000), **ê°€ìƒ TAP** ì¸í„°í˜ì´ìŠ¤ë¡œ VM â†” ë„¤íŠ¸ì›Œí¬ ì¤‘ê³„.

### ê°€ìƒ NIC, TAP/TUN, veth

- **TAP**: L2 í”„ë ˆì„(ì´ë”ë„·) ë‹¨ìœ„ë¡œ ì‚¬ìš©ì ê³µê°„ê³¼ ì»¤ë„ ì‚¬ì´ë¥¼ ì—°ê²°(ì£¼ë¡œ VM).
- **TUN**: L3 íŒ¨í‚·(IP) ë‹¨ìœ„(ì£¼ë¡œ VPN).
- **veth pair**: ì»¨í…Œì´ë„ˆ/ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°„ L2 íŒŒì´í”„(ì–‘ ëì€ ì„œë¡œì—ê²Œ ì¼€ì´ë¸”).
- **virtio-net**: VM ë‚´ë¶€ì—ì„œ ê³ ì„±ëŠ¥ íŒŒë¼ë²„ì¶”ì–¼ NIC ë“œë¼ì´ë²„.

### ë¦¬ëˆ…ìŠ¤ ë¸Œë¦¬ì§€ vs OVS

- **linux bridge**: ë‹¨ìˆœ L2 ë¸Œë¦¬ì§€ + VLAN + hairpin + ebtables/iptables í›….
- **Open vSwitch(OVS)**: í”Œë¡œìš° ê¸°ë°˜(ë§¤ì¹˜/ì•¡ì…˜), OpenFlow/OVN, Geneve/VXLAN ë‚´ì¥, ëŒ€ê·œëª¨/SDN ì¹œí™”.

### ë¯¸ë‹ˆ ë©: VMì„ ë¸Œë¦¬ì§€ì— ë¶™ì´ê¸°

```bash
# ë¸Œë¦¬ì§€ ìƒì„±

sudo ip link add br0 type bridge
sudo ip link set br0 up

# ë¬¼ë¦¬ NICë¥¼ ë¸Œë¦¬ì§€ í¬íŠ¸ë¡œ

sudo ip link set eth0 master br0
sudo ip link set eth0 up

# TAP ë§Œë“¤ê³  ë¸Œë¦¬ì§€ì— ë¶™ì´ê¸°(QEMUê°€ ìë™ ìƒì„±í•˜ê¸°ë„ í•¨)

sudo ip tuntap add dev tap0 mode tap
sudo ip link set tap0 master br0
sudo ip link set tap0 up

# VM êµ¬ë™(QEMU ì˜ˆ)

qemu-system-x86_64 -enable-kvm -m 4096 \
  -netdev tap,id=hn0,ifname=tap0,script=no,downscript=no \
  -device virtio-net-pci,netdev=hn0 \
  disk.qcow2
```
- **íë¦„**: `VM(virtio-net)` â†” `tap0` â†” `br0` â†” `eth0` â†” ì™¸ë¶€.
- **ìº¡ì²˜ í¬ì¸íŠ¸**: `tcpdump -i tap0`, `-i br0`, `-i eth0`.

### Hairpin(ë¸Œë¦¬ì§€ ë£¨í”„ë°±)

- ê°™ì€ ë¸Œë¦¬ì§€ì— ë¶™ì€ í¬íŠ¸ ê°„ í†µì‹ ì—ì„œ **NAT/í¬ì›Œë”© í›„ ìê¸° ìì‹ ìœ¼ë¡œ ëŒì•„ì˜¤ëŠ” íŠ¸ë˜í”½ í—ˆìš©** í•„ìš”. ì¼ë¶€ í™˜ê²½(ê°€ì • ê³µìœ ê¸°/ì»¨íŠ¸ë¡¤ëŸ¬)ì—ì„œ **hairpin ëª¨ë“œ** ì˜µì…˜ ë…¸ì¶œ.

---

## í´ë¼ìš°ë“œ VPC: ì„œë¸Œë„·Â·ë¼ìš°íŒ…Â·NATÂ·SG/NACL (âš™ï¸)

> ì˜ˆì‹œëŠ” AWS ìŠ¤íƒ€ì¼ë¡œ ì„¤ëª…í•˜ì§€ë§Œ Azure VNet, GCP VPCë„ **ìš©ì–´/ì˜¤ë¸Œì íŠ¸ë§Œ ë‹¤ë¥´ê³  ì›ë¦¬ ë™ì¼**í•©ë‹ˆë‹¤.

### VPCÂ·CIDRÂ·ì„œë¸Œë„·

- **VPC**: ë…¼ë¦¬ì  L3 ë„¤íŠ¸ì›Œí¬(ì˜ˆ: `10.10.0.0/16`).
- **ì„œë¸Œë„·**: AZ(ê°€ìš© ì˜ì—­) ë‹¨ìœ„ ë¶„í• (ì˜ˆ: `10.10.1.0/24` Public, `10.10.2.0/24` Private).
- **ì£¼ì†Œ ì˜ˆì•½(ë³´í†µ 5ê°œ)**: ë„¤íŠ¸ì›Œí¬/ë¸Œë¡œë“œìºìŠ¤íŠ¸/ê²Œì´íŠ¸ì›¨ì´ ë“± í´ë¼ìš°ë“œê°€ ì˜ˆì•½.
- **ì„¤ê³„ íŒ**: ì´ˆê¸°ì— **ì¶©ë¶„íˆ í° CIDR**(ì˜ˆ: /16) â†’ ì„œë¹„ìŠ¤ ì¦ê°€/í”¼ì–´ë§ ëŒ€ë¹„.

### ë¼ìš°íŒ… í…Œì´ë¸”

- **Public Subnet**: `0.0.0.0/0 â†’ Internet Gateway(IGW)`
- **Private Subnet**: `0.0.0.0/0 â†’ NAT Gateway`
- **VPC Peering/Transit GW**: íŠ¹ì • CIDR â†’ í”¼ì–´ë§/TGW.

```text
# ì˜ˆ: í”„ë¼ì´ë¹— ì„œë¸Œë„· ë¼ìš°íŒ…

10.10.0.0/16    local         # VPC ë‚´ë¶€ ë¼ìš°íŒ…
0.0.0.0/0       nat-0abc123   # ì¸í„°ë„·ì€ NAT GWë¡œ
172.16.0.0/16   tgw-xyz       # ì‚¬ë‚´ë§ì€ Transit GW
```

### NAT Gateway vs NAT ì¸ìŠ¤í„´ìŠ¤

- **NAT GW**: ê´€ë¦¬í˜•Â·í™•ì¥í˜•Â·ê³ ê°€ìš©(ì¡´ë‹¹), **ì†ŒìŠ¤ NAT**ë¡œ í”„ë¼ì´ë¹— ì„œë¸Œë„· ì¸ìŠ¤í„´ìŠ¤ì˜ **ì•„ì›ƒë°”ìš´ë“œë§Œ** í—ˆìš©. ì¸ë°”ìš´ë“œ ì„¸ì…˜ ì‹œì‘ ë¶ˆê°€.
- **NAT ì¸ìŠ¤í„´ìŠ¤**: ì§ì ‘ EC2ë¡œ êµ¬ì„±; ìœ ì—°í•˜ì§€ë§Œ **ê´€ë¦¬/HA ë¶€ë‹´**.

### vs ë„¤íŠ¸ì›Œí¬ ACL(NACL)

- **SG**: **ìƒíƒœ ê¸°ë°˜(Stateful)**, ì¸ìŠ¤í„´ìŠ¤/NICì— **ë¶™ëŠ”** í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸. ë¦¬í„´ íŠ¸ë˜í”½ ìë™ í—ˆìš©.
- **NACL**: **ë¬´ìƒíƒœ(Stateless)**, **ì„œë¸Œë„· ê²½ê³„**. ì¸Â·ì•„ì›ƒ ëª¨ë‘ ê·œì¹™ í•„ìš”, í‰ê°€ ìˆœì„œê°€ ìˆìŒ.
- **ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤**:
  - **SGë¡œ ëŒ€ë¶€ë¶„ì˜ ì •ì±…**(ì—­í•  ë‹¨ìœ„).
  - NACLì€ **ê´‘ì—­ ì°¨ë‹¨/ì œí•œ**(ì˜ˆ: ì™¸ë¶€ì—ì„œ íŠ¹ì • í¬íŠ¸ ì „ë©´ ì°¨ë‹¨).

### ì¸í„°ë„·/í”„ëŸ°íŠ¸ì—”ë“œ íŒ¨í„´

- **ALB/NLB/LB**ë¥¼ Public Subnetì— ë°°ì¹˜, ë°±ì—”ë“œëŠ” Private Subnet.
- **SG ì²´ì´ë‹**: LB SG â†’ App SGë§Œ í—ˆìš©, App SG â†’ DB SGë§Œ í—ˆìš©.

### í”„ë¼ì´ë¹— ì ‘ê·¼: ì—”ë“œí¬ì¸íŠ¸/í”„ë¼ì´ë¹— ë§í¬

- **Gateway Endpoint(S3/Dynamo ë“±)**: VPC ë¼ìš°íŠ¸ë¡œ ì‚¬ì„¤ í†µì‹ .
- **Interface Endpoint(=PrivateLink)**: íŠ¹ì • ì„œë¹„ìŠ¤(ìì‚¬/íƒ€ì‚¬)ì— **ENI**ë¡œ ì‚¬ì„¤ ì ‘ì†.

### ì˜ˆì œ: 3-Tier VPC(ìš”ì•½)

```text
VPC 10.10.0.0/16
  Subnet PublicA  10.10.1.0/24  (ALB, NAT GW)
  Subnet PrivateA 10.10.2.0/24  (App)
  Subnet DB       10.10.3.0/24  (RDS)
Routes:
  PublicA:  0.0.0.0/0 -> IGW
  PrivateA: 0.0.0.0/0 -> NAT GW
  DB:       ë‚´ë¶€ë§Œ(local), ì™¸ë¶€ ë¼ìš°íŠ¸ ì—†ìŒ
SG:
  ALB_SG: In 80/443(ì„¸ìƒ) -> Out App_SG
  App_SG: In 8080(ALB_SG) -> Out DB_SG:5432
  DB_SG:  In 5432(App_SG) -> Out ì œí•œ
```

### Terraform ìŠ¤ë‹ˆí«(ê°œë…)

```hcl
resource "aws_vpc" "main" {
  cidr_block = "10.10.0.0/16"
}

resource "aws_subnet" "priv_a" {
  vpc_id     = aws_vpc.main.id
  cidr_block = "10.10.2.0/24"
  availability_zone = "ap-northeast-2a"
  map_public_ip_on_launch = false
}
# NAT GW, Route table, IGW ë“±ì€ ìƒëµ. ëª¨ë“ˆí™” ê¶Œì¥.

```

### ë””ë²„ê¹… í¬ì¸íŠ¸

- **ê²½ë¡œ**: ë¼ìš°íŒ… í…Œì´ë¸”/ëŒ€ìƒ GW/ì–´ì†Œì‹œì—ì´ì…˜ í™•ì¸.
- **SG/NACL**: ë°©í–¥/í¬íŠ¸/ì†ŒìŠ¤, **ìƒíƒœì„±** ì°¨ì´ ì£¼ì˜.
- **ì†ŒìŠ¤/ëª©ì  ì²´í¬**(EC2 ENI): **Source/Dest Check**ê°€ NAT ì—­í• ì¼ ë• **off** í•„ìš”.
- **VPC Flow Logs**: Drop ì´ìœ /í•„ë“œ ë¶„ì„.
- **MTU**: ENI/VPN/Transit ê²½ë¡œ **ì˜¤ë²„í—¤ë“œ**(VXLAN/GRE/IPsec) ê³ ë ¤.

---

## ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí‚¹: CNIÂ·PodÂ·ServiceÂ·Ingress (âš™ï¸)

### CNI(ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤)

- Kubelet/ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ì´ **Pod Sandbox ìƒì„± ì‹œ í˜¸ì¶œ**í•˜ëŠ” í‘œì¤€.
- **Plugin**ì´ ì‹¤ì œ **veth/ë¸Œë¦¬ì§€/ë¼ìš°íŒ…/ì˜¤ë²„ë ˆì´** êµ¬ì„±, IP í• ë‹¹, ì •ì±… ì„¤ì •.

### Pod ë„¤íŠ¸ì›Œí¬ ëª¨ë¸

- **ê° PodëŠ” ê³ ìœ  IP(í‰ë©´ ì£¼ì†Œ ê³µê°„)**ë¥¼ ê°€ì§. Pod ê°„ í†µì‹ ì€ **NAT ì—†ì´ L3**.
- Pod ë‚´ë¶€: `eth0`(veth) â†” **í˜¸ìŠ¤íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ veth peer** â†” (ë¸Œë¦¬ì§€/ë¼ìš°íŒ…) â†” ë‚˜ë¨¸ì§€ ì„¸ìƒ.
- **pause/ìƒŒë“œë°•ìŠ¤** ì»¨í…Œì´ë„ˆê°€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ë³´ìœ , ìƒìœ„ ì»¨í…Œì´ë„ˆëŠ” ì´ë¥¼ ê³µìœ .

```bash
# í˜¸ìŠ¤íŠ¸ì—ì„œ Pod veth ê´€ì°°

ip netns
ip -n <pod-ns> addr
tc -s qdisc show dev <veth>
```

### Service & kube-proxy

- **Service**: ì—¬ëŸ¬ Pod(Endpoints)ë¥¼ ê°€ë¦¬í‚¤ëŠ” **ê°€ìƒ IP(ClusterIP)**.
- êµ¬í˜„: `kube-proxy`ê°€ **iptables/IPVS/eBPF**ë¡œ **L4 ë¡œë“œë°¸ëŸ°ì‹±**.
- **íƒ€ì…**
  - ClusterIP(ê¸°ë³¸),
  - **NodePort**(ê° ë…¸ë“œ íŠ¹ì • í¬íŠ¸ë¡œ ì˜¤í”ˆ),
  - **LoadBalancer**(í´ë¼ìš°ë“œ LB ì—°ë™),
  - **ExternalName**(DNS CNAME),
  - Headless(`clusterIP: None`, ì§ì ‘ Endpoints ì§ˆì˜).

```yaml
apiVersion: v1
kind: Service
metadata: {name: web}
spec:
  selector: {app: web}
  ports:
  - port: 80
    targetPort: 8080
```

### Ingress & Gateway

- **Ingress**: L7(HTTP/HTTPS) **ê°€ìƒí˜¸ìŠ¤íŠ¸/ê²½ë¡œ** ë¼ìš°íŒ…. ì»¨íŠ¸ë¡¤ëŸ¬(Nginx/HAProxy/Envoy/Traefik)ê°€ LB ì—­í• .
- **Gateway API**: Ingress ë°œì „í˜•(ì—­í• /ì •ì±… ë¶„ë¦¬, ë©€í‹°ë£¨íŠ¸).
- ì˜ˆì œ:
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata: {name: web}
spec:
  rules:
  - host: example.com
    http:
      paths:
      - path: /app
        pathType: Prefix
        backend:
          service:
            name: web
            port: {number: 80}
```

### DNS/ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬

- **CoreDNS**ê°€ `svc.ns.svc.cluster.local` FQDN ì œê³µ.
- Headless + StatefulSet ì¡°í•©ìœ¼ë¡œ **ê°œë³„ Pod A ë ˆì½”ë“œ** ì œê³µ(ë°ì´í„°ë² ì´ìŠ¤ ìƒ¤ë”© ë“±).

### í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ë¡œ: SNAT/MASQUERADE

- Podâ†’ì™¸ë¶€ ì‹œ **ë…¸ë“œ IPë¡œ SNAT**ê°€ ê¸°ë³¸(í´ëŸ¬ìŠ¤í„° CIDRì´ ì™¸ë¶€ ë¼ìš°íŒ…ì— ëª¨ë¦„).
- **Kube-proxy iptables**ì—ì„œ `MASQUERADE` ê·œì¹™ í™•ì¸ ê°€ëŠ¥.

```bash
# iptables -t nat -S | grep MASQUERADE

```

---

## CNI êµ¬í˜„ ë¹„êµ: Flannel/Calico/Cilium/Weave (âš™ï¸)

### Flannel

- **Overlay ì¤‘ì‹¬**(VXLAN, UDP, host-gw ë“± ë°±ì—”ë“œ ì„ íƒ).
- ê°„ë‹¨Â·ê°€ë²¼ì›€. ë‹¤ë§Œ ëŒ€ê·œëª¨/ê³ ì„±ëŠ¥ì—ì„  **ì˜¤ë²„í—¤ë“œ/MTU** ì£¼ì˜.

### Calico

- **ë¼ìš°íŒ… ê¸°ë°˜(BGP)** ë¡œ **NAT ì—†ì´ L3**(ê°€ëŠ¥ ì‹œ), ì˜µì…˜ìœ¼ë¡œ VXLAN/Geneve.
- **NetworkPolicy** ê°•ë ¥, **eBPF ëª¨ë“œ**ë¡œ kube-proxy ëŒ€ì²´ ê°€ëŠ¥.

### Cilium

- **eBPF** ì¤‘ì‹¬ ë°ì´í„°íŒ¨ìŠ¤(XDP/TC/Sockmap), **kube-proxy ì œê±°** LB, **Hubble**(ê°€ì‹œì„±), **Tetragon**(ë³´ì•ˆ).
- DSR/Maglev Hash, **Host/Routing/Overlay** ì—¬ëŸ¬ ëª¨ë“œ.

### Weave Net

- **fastdp(OVS)** + ì•”í˜¸í™”/ìë™ í”¼ì–´ë§. ê°„í¸í•˜ë‚˜ ì´ˆëŒ€ê·œëª¨ì—ëŠ” ì„ íƒì .

### MTU/ì˜¤ë²„ë ˆì´ ê³µì‹

\[
\text{Effective MTU} \approx \text{Underlay MTU} - \text{Encap Overhead}
\]
- VXLAN ì˜¤ë²„í—¤ë“œ(ëŒ€ëµ): **IP(20/40) + UDP(8) + VXLAN(8) = 36~56 B**.
- **1500 MTU**ì—ì„œ VXLANì´ë©´ **1440~1460** ê·¼ë°©ìœ¼ë¡œ ì¡°ì • í•„ìš”(ë‚´ë¶€ TCP MSS í´ë¨í•‘ë„ ê³ ë ¤).

```bash
# CNI MTU ì¡°ì •(ì˜ˆ: Cilium)

cilium config set mtu 1450
```

---

## ì˜¤ë²„ë ˆì´: VXLAN/GRE/Geneve (ğŸš€)

### VXLAN í°ê·¸ë¦¼

- **VTEP**(í„°ë„ ì—”ë“œí¬ì¸íŠ¸)ì´ **VNI(24bit)** ë¡œ L2 ì„¸ê·¸ë¨¼íŠ¸ ê°€ìƒí™”.
- **UDP/4789**. BUM(Broadcast, Unknown-Unicast, Multicast) ì²˜ë¦¬ëŠ” **ë©€í‹°ìºìŠ¤íŠ¸** í˜¹ì€ **ì»¨íŠ¸ë¡¤í”Œë ˆì¸(ì˜ˆ: EVPN, OVS/OVN)** ìœ¼ë¡œ í•´ê²°.
- **í•´ì‹œ/ECMP**: UDPë‹ˆê¹Œ **ì–¸ë”ë ˆì´ L3ì—ì„œ ë¶€í•˜ë¶„ì‚° ìš©ì´**.

### GRE

- **IP-in-IP** ë‹¨ìˆœ ìº¡ìŠí™”(í”„ë¡œí† ì½œ 47). L4 í¬íŠ¸ ë¶€ì¬ë¡œ **ECMP í•´ì‹œ ë¶ˆë¦¬**.
- ì˜¤ë²„í—¤ë“œ ì ê³  êµ¬í˜„ ê°„ë‹¨. DCI/íŠ¹ì • ì¥ë¹„ ìƒí˜¸ìš´ìš©ì— ì—¬ì „íˆ í™œìš©.

### Geneve

- VXLAN ìœ ì‚¬ + **ì˜µì…˜ TLV** í™•ì¥ì„±. OVS/OVN, NVMe/TCP overlay, ëŒ€í˜• í´ë¼ìš°ë“œì— ì±„íƒ.

### EVPN(í•œ ì¤„)

- **BGP EVPN**ì„ ì»¨íŠ¸ë¡¤í”Œë ˆì¸ìœ¼ë¡œ ì‚¬ìš©í•´ **MAC/IP í•™ìŠµ**ì„ ì œì–´, **ë©€í‹°í…Œë„Œì‹œ**Â·ë£¨íŠ¸ê°€ë“œÂ·í”„ë¡ì‹œ ARP/ND ë“± ê³ ê¸‰ ê¸°ëŠ¥.

### MTU/PMTUD ì£¼ì˜

- ìº¡ìŠí™” ê²½ë¡œì—ì„œ **ICMP Too Big**ê°€ ë§‰íˆë©´ **ë¸”ë™í™€**.
- **ë…¸ë“œ NIC MTUâ†“ + TCP MSS í´ë¨í•‘**(Pod/ë…¸ë“œ ì¶œêµ¬)ë¡œ ë°©ì–´.

---

## eBPF ë°ì´í„°íŒ¨ìŠ¤ ê°œìš” (ğŸš€)

### eBPF í›…

- **XDP**(NIC RX ì§í›„) â€” ì´ˆì €ì§€ì—° ë“œë¡­/ë¦¬ë‹¤ì´ë ‰íŠ¸.
- **TC ingress/egress** â€” L2/L3 ì²˜ë¦¬Â·NATÂ·LBÂ·Policy.
- **cgroup/socket** â€” Connect/Bind/Sendmsg ê³ ë¦¬, L7 ë©”íƒ€ ê¸°ë°˜ ì •ì±….
- **Kprobe/Tracepoint** â€” ì»¤ë„ ì´ë²¤íŠ¸ ê´€ì¸¡.

### ê¸°ë³¸ ì—°ì‚°

- **BPF Map**(Hash/Array/LRU/Trie)ë¡œ ìƒíƒœ ì €ì¥(Conntrack/Policy/LB í…Œì´ë¸”).
- **bpf_redirect**, **bpf_fib_lookup**(ì»¤ë„ ë¼ìš°íŒ… ìºì‹œ ì¡°íšŒ), **bpf_map_update_elem**.

### kube-proxy ëŒ€ì²´

- **ë…¸ë“œ ì…êµ¬ì—ì„œ eBPF NAT/LB** â†’ **DSR** ê°€ëŠ¥(ë¦¬í„´ ê²½ë¡œ ì—­ì£¼í–‰ ì œê±°).
- **Maglev/Consistent Hash** ê¸°ë°˜ ì„ íƒìœ¼ë¡œ **ì—°ê²° ìŠ¤í‹°í‚¤** ë³´ì¥.

### ê´€ì¸¡Â·ë³´ì•ˆ

- **Hubble**: eBPFë¡œ Podâ†”Pod/Service/ì •ì±… ë¡œê·¸Â·ì§€í‘œ.
- **ì •ì±…**: L3/L4 + L7 í—¤ë” ë¶„ì„, **DNS ì •ì±…**(FQDN í•´ì„â†’IP ë§¤í•‘ ìºì‹œ).

```bash
# bpftool ê°„ë‹¨ ë‘˜ëŸ¬ë³´ê¸°

bpftool prog show
bpftool map show
```

---

## Kubernetes ì„œë¹„ìŠ¤ í† í´ë¡œì§€ ì‹¬í™”

### externalTrafficPolicy

- **Cluster**(ê¸°ë³¸): ì„ì˜ ë…¸ë“œë¡œ ë“¤ì–´ì˜¨ íŠ¸ë˜í”½ì´ **í´ëŸ¬ìŠ¤í„° ë‚´ë¶€**ì—ì„œ ë‹¤ì‹œ í¬ì›Œë”©(NAT) â†’ **ì†ŒìŠ¤ IP ì†ì‹¤**.
- **Local**: **ë¡œì»¬ ì—”ë“œí¬ì¸íŠ¸ê°€ ìˆëŠ” ë…¸ë“œë§Œ** ìˆ˜ì‹  â†’ **í´ë¼ì´ì–¸íŠ¸ ì†ŒìŠ¤ IP ë³´ì¡´**, ëŒ€ì‹  **ê°€ìš©ì„±/ë¶€í•˜ í¸í–¥** ì£¼ì˜.

### NodePortÂ·LoadBalancerÂ·Ingress ìƒí˜¸ì‘ìš©

- **NodePort**ëŠ” L4. IngressëŠ” L7. LoadBalancerëŠ” ë…¸ë“œ ì•ì˜ **L4 LB**(í´ë¼ìš°ë“œ)ê°€ NodePortë¡œ ì „ë‹¬.
- eBPF LB(DSR) + Ingress(Envoy) ì¡°í•©ìœ¼ë¡œ **L4/7 í˜¼í•© ìŠ¤íƒ** ê°€ëŠ¥.

### Headless & StatefulSet

- `clusterIP: None` â†’ **ê°œë³„ Pod DNS Aë ˆì½”ë“œ**. ìƒ¤ë”© DB/ì¹´í”„ì¹´ ë¸Œë¡œì»¤ì—ì„œ **ì •ì  ID** ì§€ì›.

---

## ë„¤íŠ¸ì›Œí¬ ì •ì±…(NetworkPolicy)

### ê°œë…

- **ë„¤ì„ìŠ¤í˜ì´ìŠ¤/Label** ê¸°ë°˜ L3/L4 í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸. **ê¸°ë³¸ì€ â€œí—ˆìš©â€**(ì •ì±… ì—†ìœ¼ë©´ ëª¨ë‘ í†µì‹  ê°€ëŠ¥).
- êµ¬í˜„ì€ CNI ì˜ì¡´(Calico, Cilium, Kube-router ë“±) â€” ê¸°ëŠ¥/í‘œí˜„ë ¥ ì°¨ì´ ìˆìŒ.

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata: {name: allow-web-to-app, namespace: prod}
spec:
  podSelector: {matchLabels: {app: app}}
  ingress:
  - from:
    - namespaceSelector: {matchLabels: {name: prod}}
      podSelector: {matchLabels: {role: web}}
    ports:
    - protocol: TCP
      port: 8080
```

### íŒ

- **ê¸°ë³¸ê±°ë¶€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤**: `deny-all` ì •ì±…ë¶€í„° ë„ì… â†’ ì˜ˆì™¸ë§Œ í—ˆìš©.
- **DNS/ë©”íŠ¸ë¦­ í—ˆìš©**(CoreDNS/Prometheus ë“±)ì„ ìŠì§€ ë§ ê²ƒ.

---

## MTU/MSS/Conntrack/í—¤ì–´í•€

### Conntrack(ìƒíƒœ í…Œì´ë¸”)

- kube-proxy, NAT, LBëŠ” **conntrack ì—”íŠ¸ë¦¬** ì†Œëª¨.
- **í­ì£¼ ì‹œ** ë“œë¡­/ì§€ì—°â†‘ â†’ `nf_conntrack_max` ìƒí–¥, ì ì ˆí•œ **idle timeout** ì¡°ì •.

```bash
sysctl -w net.netfilter.nf_conntrack_max=262144
conntrack -S
```

### Hairpin NAT(NodePort/Podâ†’ìê¸° ì„œë¹„ìŠ¤)

- ê°™ì€ ë…¸ë“œì—ì„œ **Podê°€ ìê¸° Serviceë¡œ** ì ‘ê·¼ ì‹œ **í—¤ì–´í•€** í•„ìš”.
- ì¼ë¶€ CNI/ë¸Œë¦¬ì§€ ì˜µì…˜ì—ì„œ `hairpinMode=true`/ë¸Œë¦¬ì§€ hairpin on.

### MSS í´ë¨í•‘(ì˜¤ë²„ë ˆì´)

```bash
# ë…¸ë“œ ì¶œêµ¬ì—ì„œ SYNì˜ MSSë¥¼ 1360ìœ¼ë¡œ(ì˜ˆì‹œê°’)

iptables -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN \
  -j TCPMSS --set-mss 1360
```

---

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…: ìƒí™©â†’ê°€ì„¤â†’ê²€ì¦

### â€œPodâ†”PodëŠ” ë˜ëŠ”ë° ì™¸ë¶€ë§Œ ì•ˆë¨â€

```text
ê°€ì„¤: SNAT ëˆ„ë½/í´ë¼ìš°ë“œ ë¼ìš°íŒ… ì—†ìŒ/SG ë§‰í˜
ê²€ì¦: Podâ†’8.8.8.8 ping, ë…¸ë“œ iptables MASQUERADE ê·œì¹™, VPC Route 0.0.0.0/0
ì¡°ì¹˜: ë…¸ë“œ ì¶œêµ¬ SNAT ì¼œê¸°/í´ë¼ìš°ë“œ NAT GW ê²½ë¡œ í™•ì¸/SG ì•„ì›ƒë°”ìš´ë“œ í—ˆìš©
```

### â€œì¼ë¶€ í° ì‘ë‹µë§Œ íƒ€ì„ì•„ì›ƒâ€

```text
ê°€ì„¤: MTU/PMTUD ë¸”ë™í™€(ì˜¤ë²„ë ˆì´/Peering)
ê²€ì¦: DF ping, tracepath, curl --http3 ì‹¤íŒ¨ì—¬ë¶€
ì¡°ì¹˜: CNI MTUâ†“, TCP MSS í´ë¨í•‘, ICMP PTB í—ˆìš©
```

### â€œNodePortì—ì„œ ì†ŒìŠ¤ IPê°€ ì‚¬ë¼ì§â€

```text
ê°€ì„¤: externalTrafficPolicy=Cluster
ì¡°ì¹˜: Localë¡œ ë³€ê²½(ì—”ë“œí¬ì¸íŠ¸ ë¡œì»¬ ë¶„í¬ í™•ì¸), ë˜ëŠ” L7 Ingressì—ì„œ X-Forwarded-For í™œìš©
```

### â€œì—°ê²° ìˆ˜ ëŠ˜ì ì§€ì—° ê¸‰ì¦â€

```text
ê°€ì„¤: conntrack í•œë„/íë””ìŠ¤í¬/ì„¸ê·¸ë¨¼íŠ¸ ë¶€ì¡±
ê²€ì¦: conntrack -S, ss -s, tc -s qdisc, ethtool -S
ì¡°ì¹˜: nf_conntrack_maxâ†‘, fq/fq_codel, CNI/eBPF LB ê²€í† 
```

### â€œë©€í‹°í´ëŸ¬ìŠ¤í„°/í•˜ì´ë¸Œë¦¬ë“œ í†µì‹  ë¶ˆì•ˆâ€

```text
ê°€ì„¤: ë¼ìš°íŒ… ë¹„ëŒ€ì¹­/NAT/ë³´ì•ˆ ì¥ë¹„ DPI
ì¡°ì¹˜: IPsec/WireGuard í„°ë„ ì¼ì›í™”, BGP/EVPN, MTU ì¡°ì •
```

---

## ì„±ëŠ¥Â·í’ˆì§ˆ ìˆ˜ì‹/ê°ê° ë©”ëª¨

### ì˜¤ë²„ë ˆì´ í—¤ë” ì˜¤ë²„í—¤ë“œ

\[
\text{Overhead}_{\text{VXLAN}} \approx \text{IP}_{\text{out}} + \text{UDP} + \text{VXLAN} + \text{L2}_{\text{in}}
\]
- ëŒ€ëµ **50BÂ±**. ìœ íš¨ í˜ì´ë¡œë“œ ë¹„ìœ¨:
\[
\text{Goodput} \approx \frac{\text{Payload}}{\text{Payload}+\text{Overheads}} \times \text{Rate}
\]

### DSRì˜ ì¥ì (ê°œë…)

- ë¦¬í„´ íŒ¨í‚·ì´ **LBë¥¼ ì•ˆ ê±°ì¹¨** â†’ LB ë³‘ëª©/ëŒ€ê¸°ì—´â†“,
- ë‹¨, **ë£¨íŒ…/ì •ì±…**ì´ **ëŒ€ì¹­**ì´ ì•„ë‹ˆë¼ë„ ì„±ë¦½(ì„œë²„ê°€ ì§ì ‘ í´ë¼ì´ì–¸íŠ¸ë¡œ ì‘ë‹µ).

---

## ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤(ìš”ì•½ ì¹´ë“œ)

**ê°€ìƒí™”/í˜¸ìŠ¤íŠ¸**
- [ ] ë¦¬ëˆ…ìŠ¤ ë¸Œë¦¬ì§€/OVS ì„ íƒ ê¸°ì¤€ ë¬¸ì„œí™”, hairpinÂ·VLAN íƒœê¹… ì •ì±….
- [ ] NIC ì˜¤í”„ë¡œë“œ/ë©€í‹°í/RSS/IRQ í•€ë‹, `fq`/`fq_codel` qdisc.

**í´ë¼ìš°ë“œ VPC**
- [ ] CIDR ì—¬ìœ , Public/Private ë¶„ë¦¬, NAT GW ì¡´ë‹¹ ì´ì¤‘í™”.
- [ ] SG=ìƒíƒœê¸°ë°˜(ì—­í•  ì¤‘ì‹¬), NACL=ê´‘ì—­ ì œí•œ.
- [ ] VPC Endpoint/PrivateLinkë¡œ **ì‚¬ì„¤ ê²½ë¡œ** ì ê·¹ í™œìš©.
- [ ] Flow LogsÂ·ë¼ìš°íŠ¸ ì‹œê°í™”Â·í—¬ìŠ¤ ëŒ€ì‹œë³´ë“œ.

**Kubernetes/CNI**
- [ ] CNI MTU/ì˜¤ë²„ë ˆì´ ì„ íƒ(VXLAN vs ë¼ìš°íŒ…), eBPF ê²€í† .
- [ ] kube-proxy ëª¨ë“œ(iptables/IPVS/eBPF) ëª…í™•í™”, externalTrafficPolicy ê³ ë ¤.
- [ ] NetworkPolicy **ê¸°ë³¸ê±°ë¶€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤**ë¶€í„°.
- [ ] DNS/ë©”íŠ¸ë¦­/í—¬ìŠ¤ í¬íŠ¸ í—ˆìš© ëˆ„ë½ ë°©ì§€.

**ì˜¤ë²„ë ˆì´/eBPF**
- [ ] PMTUD/ICMP PTB í†µê³¼, MSS í´ë¨í•‘.
- [ ] eBPF LB/Policyë¡œ ì„±ëŠ¥Â·ê°€ì‹œì„± í–¥ìƒ, qlog/Hubble ë“± ë„ì….
- [ ] DSR/Maglevë¡œ í™•ì¥ì„± í™•ë³´(í…ŒìŠ¤íŠ¸/ê°€ì‹œì„± ì„ í–‰).

---

## ì°¸ê³  í…œí”Œë¦¿/ìŠ¤ë‹ˆí« ëª¨ìŒ

### OVSë¡œ VXLAN ë¸Œë¦¬ì§€(ê°œë…)

```bash
ovs-vsctl add-br br-int
ovs-vsctl add-port br-int vxlan0 -- set interface vxlan0 \
  type=vxlan options:remote_ip=10.0.0.2 options:key=42 options:dst_port=4789
ovs-vsctl add-port br-int tap0
```

### Calico BGP(ìš”ì§€)

```yaml
apiVersion: crd.projectcalico.org/v1
kind: BGPPeer
metadata: {name: rr}
spec:
  peerIP: 10.10.0.254
  asNumber: 64512
```

### Cilium ê°’ ëª‡ ê°€ì§€

```bash
cilium status
cilium config set bpf-lb-dsr-dispatch  opt
cilium hubble enable
```

### Ingress + Service + Deployment (ìš”ì•½)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata: {name: web}
spec:
  replicas: 3
  selector: {matchLabels: {app: web}}
  template:
    metadata: {labels: {app: web}}
    spec:
      containers:
      - name: app
        image: ghcr.io/example/web:1.0
        ports: [{containerPort: 8080}]

---
apiVersion: v1
kind: Service
metadata: {name: web}
spec:
  selector: {app: web}
  ports: [{port: 80, targetPort: 8080}]
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata: {name: web}
spec:
  rules:
  - host: www.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service: {name: web, port: {number: 80}}
```

---

## â€œí•œ ì¥ ìš”ì•½(í¬ìŠ¤í„°)â€

- **í•˜ì´í¼ë°”ì´ì €**ëŠ” TAP/vNIC/ë¸Œë¦¬ì§€ë¡œ VMì„ ì„¸ìƒê³¼ ì—°ê²°, **OVS/OVN** ë“±ìœ¼ë¡œ SDNí™”.
- **í´ë¼ìš°ë“œ VPC**ëŠ” **CIDRÂ·ì„œë¸Œë„·Â·ë¼ìš°íŒ…Â·NATÂ·SG/NACL** ì¡°í•©ì´ ê¸°ë³¸ ë¬¸ë²•.
- **Kubernetes**ëŠ” **CNI**ê°€ ë„¤íŠ¸ì›Œí¬ë¥¼ ë§Œë“¤ê³ , **Service/Ingress**ê°€ L4/7 ì§„ì…ì ì„ ì œê³µ.
- **ì˜¤ë²„ë ˆì´(VXLAN/Geneve)**ì™€ **eBPF ë°ì´í„°íŒ¨ìŠ¤**ë¡œ **ëŒ€ê·œëª¨/ê³ ì„±ëŠ¥Â·ê°€ì‹œì„±**ì„ ë™ì‹œì—.
- **í•­ìƒ MTU/PMTUD/Conntrack**ì„ ìŠì§€ ë§ ê²ƒâ€”ëŒ€ë¶€ë¶„ì˜ ë¯¸ë¬˜í•œ ì¥ì• ëŠ” ì—¬ê¸°ì„œ ì¶œë°œ.

---

### ë¶€ë¡ A â€” ë¹ ë¥¸ ì ê²€ ëª…ë ¹ ëª¨ìŒ

```bash
# í˜¸ìŠ¤íŠ¸/VM/ì»¨í…Œì´ë„ˆ ë§í¬

ip link; ip addr; ip route
bridge link; bridge fdb

# ìº¡ì²˜

tcpdump -i any -nnvv 'host <IP> and port <PORT>'

# Kubernetes

kubectl get pods -o wide
kubectl describe svc <name>
kubectl -n kube-system logs ds/kube-proxy
kubectl exec -it <pod> -- sh -c 'ip addr; ip route'

# Conntrack/iptables

conntrack -S; conntrack -L
iptables -t nat -S | grep -E 'MASQUERADE|DNAT'

# Cilium/Calico

cilium status; cilium service list
calicoctl get ippool
```

### ë¶€ë¡ B â€” ìš©ì–´ ìŠ¤ëƒ…ìƒ·

```
TAP/TUN, veth, linux bridge, OVS/OVN,
VPC/VNet, IGW, NAT GW, SG/NACL, TGW/Peering, Endpoint/PrivateLink,
CNI, Pod CIDR, kube-proxy(iptables/IPVS/eBPF), Service/Ingress/Gateway,
VXLAN/GRE/Geneve, VNI/VTEP, EVPN, PMTUD, MSS Clamp,
eBPF(XDP/TC), BPF Map, DSR, Maglev, Hubble
```
