---
layout: post
title: 네트워크보안 - 케이스 스터디 & 사고 해부
date: 2025-10-31 20:25:23 +0900
category: 네트워크보안
---
# 30. 케이스 스터디 & 사고 해부

> 목표  
> - **공개 사고**(또는 공개된 패턴을 따른 가상의 실제급 사고)를 **네트워크 관점**에서 재구성하고, **근본 원인(기술·프로세스·사람)**을 층위별로 분해한다.  
> - “**무엇이 달랐다면**”을 체계적으로 시뮬레이션해 **예방·탐지·대응** 각각에서 효과가 큰 조치를 가려낸다.  
> - **운영 반영 액션 아이템**을 **우선순위·담당·기한·KPI**로 정량화하여 릴리스한다.  
> - **실습**: 미니 시나리오를 재현하고, **타임라인·패킷·로그 근거** 기반의 **보고서**를 작성해 본다.  
> ⚠️ 본 절의 케이스/로그/도메인/IP는 교육용 샘플로 구성했다. 실제 적용 시 조직의 규정/법/윤리를 반드시 준수할 것.

---

## 30.1 공개 사고의 네트워크 관점 분석

### 30.1.1 케이스 개요(가상·실전급)
- **상황**: SaaS 기업 A사의 일부 직원 계정 피싱→**OAuth 토큰 남용**→클라우드 저장소에서 자격증명 파일 유출→내부망(하이브리드)로 피벗  
- **공격 흐름(요약)**  
  1) **피싱 링크** → 사용자가 IdP(SSO)에 로그인, **동의 스크린**으로 OAuth 권한 위임  
  2) 공격자가 API를 통해 사용자 메일/드라이브에서 **토큰/비밀**이 노출된 파일 검색  
  3) 노출된 **클라우드 액세스 키**로 VPC 안쪽 **프라이빗 엔드포인트**를 경유해 내부 API 호출  
  4) 내부 API 서버 중 한 곳의 **DEBUG 엔드포인트** 노출로 **메타데이터·서비스 계정 토큰** 획득  
  5) **lateral**: K8s 내부에서 **서비스 간 인증** 미흡 구간을 통해 DB 접근  
  6) 데이터 **압축·분활 업로드**(CDN/스토리지)로 반출

> 관점 포인트: **네트워크** 층에서 무엇을 **막거나** **탐지**할 수 있었는가?

### 30.1.2 타임라인(분 단위, 핵심 이벤트)
| T(분) | 이벤트 | 네트워크 신호 |
|---|---|---|
| 0 | 피싱 메일 클릭 → OAuth 앱 승인 | 프록시에서 `accounts.example-idp.com/oauth/*` 정상 트래픽 |
| 3 | API 스코프 사용, 메일·드라이브 인덱스 | SASE/프록시 로그에 **비정상 API 폭주(단기간, 신규 UA/IP)** |
| 15 | 클라우드 액세스 키 발견 | 외부에서 **클라우드 API** 접근(신규 ASN) |
| 25 | PrivateLink 경유 내부 API 호출 | 클라우드 VPC Flow Log에 **비정상 세그먼트로의 동선** |
| 33 | DEBUG 엔드포인트 노출 이용 | LB/WAF 로그에 낮은 빈도 경로 `/debug/vars` |
| 40 | K8s 내부 토큰 사용으로 DB 접근 | Service→DB **NetworkPolicy 미존재**, Pod 간 L3 오픈 |
| 55 | 압축 업로드 시작 | egress **큰 파일 반복 업로드**, 프록시 카테고리 우회형 도메인 |

### 30.1.3 네트워크 관점의 근본 원인(RCA)
- **예방(Prevent)**  
  - (P1) **OAuth 앱 승인 정책 부재**: 검증되지 않은 앱의 광범위 스코프 허용  
  - (P2) **클라우드→프라이빗 엔드포인트** egress 통제가 느슨(모든 사설/서비스 엔드포인트 허용)  
  - (P3) K8s **NetworkPolicy 기본 거부 부재**, 내부 서비스 간 통신이 평면(Flat)  
  - (P4) API 서버의 **디버그 경로 노출**(WAF/리버스 프록시 라우팅 예외)
- **탐지(Detect)**  
  - (D1) OAuth 동의 직후 **API 호출 비정상 패턴**(짧은 시간, 높은 호출 빈도) 룰 없음  
  - (D2) VPC Flow에서 **비정상 경로/세그먼트** 탐지 규칙 미비  
  - (D3) egress **대용량 업로드** 이상탐지/알림 부재  
- **대응(Respond)**  
  - (R1) 토큰 철회·권한 스코프 제한 자동화 미흡  
  - (R2) 빠른 **네임스페이스/세그먼트 격리**(K8s, VPC) 플레이북/자동화 부족

### 30.1.4 증거(패킷/로그) 샘플

**프록시(HTTP) 로그 예시**
```json
{
  "ts":"2025-10-31T11:03:21Z",
  "src_ip":"203.0.113.77",
  "user":"alice@corp",
  "host":"www.googleapis-idp.com",
  "uri":"/oauth2/v2/auth?scope=mail.read%20drive.read",
  "ua":"Chrome/141",
  "bytes_out": 518, "bytes_in": 124812,
  "result":"200"
}
```

**VPC Flow Log (요약)**
```
ACCEPT 10.12.1.23 10.12.90.10 443 -> PrivateLink(service-api) bytes=34291
ACCEPT 10.12.1.23 10.12.40.5  443 -> internal-debug-lb    bytes=1201  uri=/debug/vars
```

**K8s Audit / Envoy Access Log**
```json
{"ts":"...","src":"svc-api","dst":"db-prod","mTLS":"none","result":"200","bytes":49124}
```
→ **mTLS=none** 구간이 핵심 힌트.

**egress 업로드 패턴(프록시 요약)**
```
PUT https://store.cdn-example.net/upload/chunk-0001.bin  size=10MB
PUT https://store.cdn-example.net/upload/chunk-0002.bin  size=10MB
...  (1~50)
```

---

## 30.2 대안 시뮬레이션(무엇이 달랐다면?)

### 30.2.1 시나리오 A — “승인 앱 제한 + ZTNA 프라이빗 경로”
- **변경**:  
  1) **IdP 승인 앱 화이트리스트**만 토큰 교부(SSO 관리자 승인 필수)  
  2) **프라이빗 엔드포인트** 접근은 **ZTNA 프록시**를 통해서만(디바이스·사용자 포스처 검사)
- **예상 네트워크 결과**:  
  - 공격자가 OAuth 토큰을 획득해도 **승인되지 않은 앱**이면 API 호출 실패  
  - 클라우드→내부 API로의 프라이빗 경로는 **ZTNA 컨트롤 플레인**에서 거절
- **탐지 효과**: 승인 실패 이벤트(401/403)가 IdP/프록시에 남고, 통계적으로 **비정상 동의 시도**를 잡아낸다.

**IdP(의사 설정, Pseudo)**
```yaml
oauth:
  allowed_apps:
    - corp-mail-reader
    - corp-drive-min
  scopes:
    corp-mail-reader: [mail.read]
    corp-drive-min:   [drive.metadata.read]
  user_consent: "admin-approval-required"
```

### 30.2.2 시나리오 B — “K8s 기본 거부 + 서비스 메시 mTLS”
- **변경**:  
  1) 모든 네임스페이스 **NetworkPolicy: egress/ingress 기본 거부**  
  2) 메시 **mTLS 강제**, 클레임 기반 **인증·인가 정책**
- **예상 네트워크 결과**:  
  - 서비스 메시 인증 실패(“Peer not verified”)로 DB 접근 차단  
  - `/debug/vars`는 **Ingress 라우팅**에서 블록
- **탐지 효과**: Envoy/Ingress **denied counter** 증가, **허용/차단 비율** 이상 탐지

**NetworkPolicy(예)**
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata: { name: default-deny, namespace: prod }
spec:
  podSelector: {}
  policyTypes: ["Ingress","Egress"]
```

**AuthorizationPolicy(메시 예)**
```yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata: { name: db-allow-from-api, namespace: prod }
spec:
  selector: { matchLabels: { app: db } }
  rules:
  - from:
    - source:
        principals: ["spiffe://corp.local/ns/prod/sa/api-sa"]
    to:
    - operation: { ports: ["5432"] }
```

### 30.2.3 시나리오 C — “egress 대용량/분활 업로드 탐지·차단”
- **변경**: 프록시/차세대 FW에서 **분 분기당 누적 업로드 바이트·객체 수** 임계치 정책
- **예상 결과**: 10MB×50회 업로드가 **N분 내 임계 초과**로 차단/챌린지
- **탐지 룰(의사 KQL)**:
```kql
index: proxy-* method:PUT and bytes_out > 5MB
| stats sum(bytes_out) as out, count() as cnt by src_ip, user, date_histogram(field="@timestamp", fixed_interval="5m")
| where out > 200MB or cnt > 30
```

### 30.2.4 비교 요약(효과/비용/부작용)

| 시나리오 | 예방 효과 | 탐지 개선 | 비용/부작용 |
|---|---|---|---|
| A 승인 앱 + ZTNA | OAuth 남용 대폭 축소 | 승인 실패 신호 ↑ | 초기 사용자 마찰, 승인 대기 |
| B K8s deny + mTLS | 내부 피벗 봉쇄 | 메시 denied 카운트, 라우팅 경보 | 정책/사이드카 오버헤드 |
| C egress 임계 | 반출 방지 | 대용량/분활 패턴 노출 | 업무상 대용량 업로드 오탐 가능 |

---

## 30.3 운영 반영 액션 아이템 목록

### 30.3.1 액션 테이블(담당·기한·KPI)
| ID | 액션 | 담당 | 기한 | KPI | 비고 |
|---|---|---|---|---|---|
| A1 | IdP **승인 앱 화이트리스트** 도입 | IAM | +2주 | 승인 없는 앱 토큰 발급 0건 | 사용자 커뮤니케이션 |
| A2 | **ZTNA 프라이빗 액세스** 강제 | NetSec | +4주 | VPC→PrivateEndpoint 직접 연결 0건 | PoC→확대 |
| B1 | K8s **default-deny NP** 전 네임스페이스 | Platform | +3주 | NP 미적용 NS 0개 | 카나리 NS부터 |
| B2 | **mTLS + AuthZPolicy** 적용 | Platform | +6주 | mTLS 비활성 서비스 0개 | 메시 관측 대시보드 |
| B3 | `/debug/*` **Ingress 차단** | App/NetSec | +1주 | 외부 접근 0건 | WAF 룰 포함 |
| C1 | 프록시 **대용량 업로드 임계** | NetSec | +2주 | 임계 초과 시 자동 알림 100% | 예외 승인 절차 |
| D1 | **탐지 룰**(OAuth 폭주, egress 분활) | SOC | +1주 | 룰 검출→티켓 생성 100% | 튜닝 2주차 |
| R1 | **격리 플레이북**(NS 차단/토큰 폐기) | IR | +2주 | 모의훈련 전환 < 10분 | 분기 리허설 |

### 30.3.2 KPI 대시보드 항목
- 승인 앱 외 OAuth 토큰 발급 **0건** (주간)  
- 메시 **mTLS 적용률** 100% / NP 미적용 네임스페이스 **0개**  
- egress 임계 초과 **탐지→티켓 변환율** 100% / **오탐 비율** < 5%  
- 분기 모의훈련: **격리 전환 시간** p95 < 10분

---

## 30.4 실습: 미니 시나리오 재현·보고서 작성

> **목표**: 작은 랩에서 “OAuth 남용→프라이빗 API 접근→데이터 업로드”를 흉내 내고, **타임라인/로그/패킷**을 근거로 보고서를 작성한다.

### 30.4.1 랩 토폴로지(로컬/클라우드 모두 가능)
```
[Attacker VM]  ──► [Proxy(SQUID/Nginx)] ──► [API GW]
                                     └──► [Storage(Mock S3)]
                          └──► [K8s Mini: api-svc, db, ingress]
```
- Proxy에서 **업로드 임계 룰** 적용, K8s는 **ingress only 허용** + 내부 mTLS OFF(의도)  
- 공격자는 모의 **토큰**을 잡고 API 경로/디버그 경로를 순회

### 30.4.2 준비 스크립트(요약 Docker Compose)

```yaml
version: "3.9"
services:
  proxy:
    image: nginx:alpine
    volumes: [ "./conf/nginx.conf:/etc/nginx/nginx.conf" ]
    ports: ["8080:8080"]
  apigw:
    image: kennethreitz/httpbin
    environment: [ "PORT=8081" ]
    ports: ["8081:8081"]
  storage:
    image: minio/minio
    command: server /data --console-address ":9001"
    environment: [ "MINIO_ROOT_USER=mini", "MINIO_ROOT_PASSWORD=mini12345" ]
    ports: ["9000:9000","9001:9001"]
```

**Nginx(프록시) 업로드 임계(개념)**
```nginx
http {
  limit_req_zone $binary_remote_addr zone=up:10m rate=20r/m;
  map $request_method $is_put { default 0; PUT 1; }
  map $request_length $big { default 0; ~^[1-9][0-9]{7,}$ 1; }  # ~>=10MB
  server {
    listen 8080;
    location / {
      if ($is_put) { limit_req zone=up burst=10 nodelay; }
      proxy_pass http://$host$request_uri;
    }
    location /upload/ {
      if ($big) { return 429 "Too Large/Too Many"; }
      proxy_pass http://storage:9000;
    }
  }
}
```

### 30.4.3 공격 시뮬레이터(샘플 Python)
```python
# simulate.py
import requests, os, time
S = requests.Session()
S.headers["Authorization"] = "Bearer fake-oauth-token"

# 1) 인덱스 폭주(피싱 후 API 남용 가정)
for i in range(50):
    r = S.get("http://apigw:8081/anything/mail/list")
    time.sleep(0.1)

# 2) 디버그 경로 접근 (노출 가정)
print(S.get("http://apigw:8081/debug/vars").status_code)

# 3) 분활 업로드(프록시 경유로 제한 유도)
chunk = os.urandom(10*1024*1024)  # 10MB
for i in range(1, 21):
    url = f"http://proxy:8080/upload/chunk-{i:04}.bin"
    r = S.put(url, data=chunk)
    print(i, r.status_code)
```

### 30.4.4 수집·분석(간단 쿼리/도구)

**Nginx Access**: 업로드 임계 동작 확인
```bash
awk '{print $1,$4,$5,$7,$10}' /var/log/nginx/access.log | tail
# 429 응답이 발생했는지 확인
```

**tcpdump (프록시 인터페이스)**
```bash
sudo tcpdump -i eth0 'tcp port 9000 or tcp port 8081' -w lab.pcap
```

**Wireshark 필터**
```
http.request.method == "PUT" and frame.len > 1500
```

**간단 통계(Python)**
```python
# parse_nginx.py
import re, sys
hits = up = blocked = 0
for line in sys.stdin:
    hits += 1
    if "PUT /upload" in line: up += 1
    if " 429 " in line: blocked += 1
print("hits:",hits,"uploads:",up,"blocked:",blocked, "block_rate:", round(blocked/max(up,1),2))
```

### 30.4.5 보고서 템플릿(제출물)

**1) 개요**
- 사건명 / 일시 / 영향 범위(시스템/데이터) / 현재 상태(격리/복구)

**2) 타임라인**
- `T0` 피싱/토큰 발급, `T+15` PrivateLink, `T+33` 디버그 경로, `T+55` 업로드 시도…

**3) 공격 경로(다이어그램)**  
- SSO(OAuth) → SaaS API → 키 유출 → VPC(PrivateEndpoint) → Ingress/Debug → K8s 내부 → DB → egress 업로드

**4) 증거(첨부)**
- 프록시·WAF·LB·VPC Flow·K8s Audit·PCAP 스냅샷  
- 핵심 페이로드(URI, 메서드, 크기, mTLS 여부)

**5) 근본 원인**
- P1~P4 / D1~D3 / R1~R2 항목별 기술·프로세스·사람 요인

**6) 교정 조치(Corrective Action)**
- 단기(1~2주): 디버그 경로 차단, 업로드 임계 룰, 토큰 스코프 축소  
- 중기(3~6주): ZTNA 프라이빗, K8s default-deny+mTLS, 메시 AuthZ  
- 장기(>6주): 승인 앱 거버넌스, egress 범용 모델, 정기 붉은팀·블루팀 연습

**7) 지표/재발 방지**
- KPI 및 리뷰 주기(분기), 모의훈련 계획

---

### 30.4.6 채점 루브릭(교육/워크숍용)
| 항목 | 가중치 | 기준 |
|---|---|---|
| 타임라인 정확성 | 25% | 로그·패킷 기반 재현, 근거 명시 |
| 네트워크 분석 | 25% | VPC/Proxy/K8s/Ingress 신호를 올바르게 해석 |
| 대안 제시 | 25% | 예방·탐지·대응의 균형, 부작용/ROI 고려 |
| 보고 품질 | 15% | 간결한 서술, 재현 가능성 |
| 자동화 스크립트 | 10% | 쿼리/파서/임계 탐지 코드 포함 |

---

## 부록 A. 체크리스트(현업 반영용)
- [ ] OAuth **승인 앱 거버넌스**(스코프·만료·리뷰)  
- [ ] **프라이빗 엔드포인트 ZTNA 강제**, egress 기본 거부  
- [ ] K8s **기본 거부 NP + 메시 mTLS/정책**, 디버그 경로 외부 차단  
- [ ] **분활·대용량 업로드 탐지** 룰, 예외 승인 절차  
- [ ] **플레이북 자동화**: 토큰 철회, NS 격리, 라우팅 전환, DNS Failover  
- [ ] **모의훈련**: 분기 1회, 타임라인/증거 기반 보고서 제출

---

## 요약
- 네트워크 관점의 사고 해부는 **타임라인·증거**로 시작해 **예방·탐지·대응**의 균형 있는 **대안 시뮬레이션**으로 끝나야 실효가 크다.  
- 이번 케이스에서 **승인 앱/프라이빗 경로/ZTNA**, **K8s 기본 거부+mTLS**, **egress 임계**가 가장 큰 효과를 냈다.  
- 운영 반영은 **액션 테이블**로 담당·기한·KPI를 명확히 하고, **실습 랩**에서 재현→보고서로 학습을 폐루프화하라.  
- 첨부 스크립트/정책 스니펫은 조직 표준에 맞춰 IaC/CI로 흡수해 **지속적 검증**을 권장한다.
