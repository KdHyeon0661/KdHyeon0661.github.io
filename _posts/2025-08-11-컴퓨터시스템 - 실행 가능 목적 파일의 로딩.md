---
layout: post
title: 컴퓨터시스템 - 실행 가능 목적 파일의 로딩
date: 2025-08-11 17:20:23 +0900
category: 컴퓨터시스템
---
# 실행 가능 목적 파일의 로딩(Loading)

**실행 가능 목적 파일 로딩**은 운영체제의 **프로그램 실행 과정**에서 커널이 해당 파일을 분석하고, 필요한 세그먼트를 메모리에 적재한 뒤 CPU 제어를 해당 프로그램에 넘기는 과정이다.  
이는 `exec()` 계열 시스템 호출을 통해 이루어지며, ELF(Executable and Linkable Format) 실행 파일을 기준으로 설명한다.

---

## 1. 로딩의 시작: exec() 호출

사용자가 `./a.out` 같은 명령을 입력하면, 셸은 **fork()**로 자식 프로세스를 만든 뒤, 자식 프로세스에서 **execve()**를 호출한다.

`execve()`는 다음을 수행한다:
1. 지정한 실행 파일을 **열고** ELF 헤더를 확인한다.
2. 파일이 유효한 실행 파일인지, 아키텍처가 맞는지, 접근 권한이 있는지 검사.
3. 기존 프로세스 메모리 공간을 해제.
4. 실행 파일 구조에 맞춰 **새 메모리 이미지**를 구성.

---

## 2. ELF 헤더 해석

커널 로더는 ELF 헤더의 다음 필드를 참고한다:
- **e_entry**: 진입점 주소 (프로그램 시작 위치)
- **e_phoff**: 프로그램 헤더 테이블 오프셋
- **e_phnum**: 프로그램 헤더 엔트리 개수

이를 기반으로 프로그램 헤더 테이블을 순회하며 로딩 대상 세그먼트를 찾는다.

---

## 3. 프로그램 헤더 테이블에 따른 메모리 매핑

ELF 프로그램 헤더의 **PT_LOAD** 타입 세그먼트는 실제 메모리에 매핑된다.

매핑 과정:
1. **코드 세그먼트**(.text)
   - 읽기/실행(RX) 권한
   - CPU가 실행할 기계어 코드 포함
2. **데이터 세그먼트**(.data, .rodata)
   - 읽기/쓰기(RW) 또는 읽기 전용(RO) 권한
   - 전역 변수, 상수 포함
3. **BSS 세그먼트**
   - 초기화되지 않은 전역 변수
   - 실제 파일에는 존재하지 않고, 메모리에서 0으로 초기화

커널은 **mmap()**과 유사한 내부 메커니즘으로 파일의 일부를 프로세스 주소 공간에 매핑한다.

---

## 4. 동적 링크 처리

실행 파일이 **동적 링크**를 사용하는 경우:
1. 프로그램 헤더에서 **PT_INTERP** 엔트리 확인 → 동적 로더(`ld.so`) 경로 읽음
2. 로더를 메모리에 매핑
3. 로더가 필요한 공유 라이브러리(.so) 파일을 탐색하여 매핑
4. 재배치(Relocation) 수행
5. GOT(Global Offset Table), PLT(Procedure Linkage Table) 설정

---

## 5. 스택 초기화

프로그램 시작 전, 커널은 **유저 스택**을 초기화한다:
- `argv[]`: 명령행 인자
- `envp[]`: 환경 변수
- ELF Auxiliary Vector (프로세스 실행 환경 정보: 페이지 크기, 실행 파일 경로, 랜덤 값 등)
- 스택 보호를 위한 **stack canary** 초기화

---

## 6. 진입점으로 점프

모든 메모리 매핑과 초기화가 완료되면:
1. CPU의 **명령 포인터(RIP/EIP)**를 ELF의 `e_entry` 주소로 설정
2. 보통 진입점은 C 런타임 초기화 코드(`_start`)이며, 여기서:
   - 스택 구조를 분석하여 `argc`, `argv`, `envp`를 준비
   - 전역 생성자 함수 호출
   - `main()` 호출
3. `main()` 종료 후, `exit()` 호출로 커널에 제어 반환

---

## 7. 로딩 과정 요약 다이어그램

```
사용자 명령
   |
   v
셸 → fork()
   |
   v
자식 프로세스 execve()
   |
   v
[커널 로더]
  ELF 헤더 읽기
  프로그램 헤더 해석
  세그먼트 메모리 매핑
  (동적 로더 로딩 & .so 매핑)
  스택 초기화
   |
   v
진입점(_start) 실행
   |
   v
main() 호출
```

---

## 8. 보안 및 최적화 고려사항

- **ASLR(Address Space Layout Randomization)**  
  실행 시 메모리 배치를 랜덤화하여 공격 난이도 상승.
- **PIE(Position Independent Executable)**  
  실행 파일 자체도 위치 독립적으로 동작 가능.
- **Lazy Binding**  
  동적 라이브러리 심볼은 처음 호출 시 해석 → 시작 속도 향상.
- **prelink**  
  미리 재배치 계산하여 로딩 속도 단축.

---

## 9. 결론

실행 가능 목적 파일 로딩은 **파일 구조(ELF)**, **커널 메모리 매핑**, **동적 링크 처리**, **스택 초기화**, **진입점 실행**의 연속된 과정이다.  
이 과정을 이해하면, 성능 최적화, 디버깅, 보안 분석 등 다양한 시스템 프로그래밍 문제를 깊이 있게 다룰 수 있다.