---
layout: post
title: 정보보안기사 - 메일서버 보안 설정, 이메일 인증 기술
date: 2025-11-13 17:25:23 +0900
category: 정보보안기사
---
# SECTION 10 이메일(E-Mail) 보안 — 03. 메일서버(sendmail) 보안 설정 · 04. 이메일 인증 기술(스팸 메일 방지)

## 개요

본 문서는 실무/실기 관점에서 **sendmail 기반 메일 서버 하드닝**과 **스팸 방지용 인증·정책 스택(SPF/DKIM/DMARC/ARC, MTA-STS/TLSRPT, DANE, RBL/그레이리스트)**을 단계별로 정리한다.
핵심 산출물: **보안 지향 sendmail.mc 샘플**, **SASL/STARTTLS 설정**, **milter 연동(opendkim/opendmarc/스팸 필터)**, **DNS 레코드 예시**, **검증/로깅/지표 스크립트**, **체크리스트**.

---

## 메일서버(sendmail) 보안 설정

### sendmail 보안 운영의 골자

- **전송 경로 보호**: STARTTLS/SMTPS + **MSA(587)/SMTPS(465)** 분리 운영
- **인증/릴레이 제어**: **SMTP AUTH(SASL)** 필수, access DB 기반 **릴레이 제한**
- **초기 차단**: **RBL(DNSBL)/greet_pause/HELO 검증**으로 봇/스팸 차단
- **콘텐츠/정책**: milter로 **DKIM/DMARC/스팸 필터·AV** 연동
- **가시성**: 로그/지표, 큐 관리, DMARC/TLSRPT 리포트 수집

### 주요 파일/경로(배포 기본값 예)

| 용도 | 경로(예) | 설명 |
|---|---|---|
| 메인 매크로 | `/etc/mail/sendmail.mc` | m4로 `sendmail.cf` 생성(편집 포인트) |
| 제출 매크로 | `/etc/mail/submit.mc` | 로컬 제출(587) 데몬 설정 |
| 본체 설정 | `/etc/mail/sendmail.cf` | 생성물(직접 편집 금지) |
| 제출 설정 | `/etc/mail/submit.cf` | 생성물 |
| 접근 DB | `/etc/mail/access` (+ `.db`) | RELAY/REJECT/OK 등 정책 |
| 허용 도메인 | `/etc/mail/local-host-names` | 수신 대상 로컬 도메인 |
| 가상 사용자 | `/etc/mail/virtusertable` (+ `.db`) | user@domain → localmap |
| 별칭 | `/etc/aliases` | root→ops, postmaster 등 |
| 인증(SASL) | `/etc/sasl2/Sendmail.conf` | AUTH 메커니즘/백엔드 |
| 인증서 | `/etc/pki/tls/{certs,private}` | 서버/CA/키 |
| milter | 각 서비스 유닛/소켓 | opendkim/opendmarc/스팸필터/AV |

> 빌드: `make -C /etc/mail` 혹은 배포 스크립트(배포판별 상이).

### 기본 하드닝 sendmail.mc (주석 포함 샘플)

> 배포판·버전에 따라 매크로/경로가 다를 수 있으니 개념/옵션 위주로 참고.

```m4
divert(-1)dnl
include(`/usr/share/sendmail/cf/m4/cf.m4')dnl
VERSIONID(`secure-mta 2025-11-11')dnl

dnl ── 기본 정책
OSTYPE(`linux')dnl
DOMAIN(`generic')dnl
FEATURE(`use_cw_file')dnl                 dnl /etc/mail/local-host-names
FEATURE(`access_db')dnl                    dnl /etc/mail/access (hash)
FEATURE(`blacklist_recipients')dnl
FEATURE(`delay_checks')dnl                 dnl HELO/MAIL/RCPT 모두 검사
FEATURE(`greet_pause', `5000')dnl          dnl 접속 직후 5초 지연(봇 억제)
FEATURE(`no_default_msa')dnl               dnl MSA는 별도 데몬 옵션으로

dnl ── RBL(DNSBL) 예: Spamhaus + 정책 메시지
FEATURE(`dnsbl', `zen.spamhaus.org', `554 5.7.1 Access denied')dnl

dnl ── STARTTLS: 서버/클라이언트 인증서 경로
define(`confCACERT_PATH',`/etc/pki/tls')dnl
define(`confCACERT',    `/etc/pki/tls/certs/ca-bundle.crt')dnl
define(`confSERVER_CERT',`/etc/pki/tls/certs/mail.example.com.crt')dnl
define(`confSERVER_KEY', `/etc/pki/tls/private/mail.example.com.key')dnl
define(`confCLIENT_CERT',`/etc/pki/tls/certs/mail.example.com.crt')dnl
define(`confCLIENT_KEY', `/etc/pki/tls/private/mail.example.com.key')dnl
define(`confTLS_SRV_OPTIONS',`V')dnl       dnl 로그 상세

dnl ── AUTH(SASL) 설정
define(`confAUTH_OPTIONS',`A p y')dnl      dnl A: advertise, p: cleartext disallow unless TLS, y: authinfo
TRUST_AUTH_MECH(`LOGIN PLAIN')dnl
define(`confAUTH_MECHANISMS',`LOGIN PLAIN')dnl

dnl ── 큐/용량/스레드 제한
define(`confMAX_MESSAGE_SIZE',`10485760')dnl     dnl 10MB
define(`confMAX_DAEMON_CHILDREN',`50')dnl
define(`confCONNECTION_RATE_THROTTLE',`3')dnl
define(`confBAD_RCPT_THROTTLE',`3')dnl
define(`confTO_QUEUERETURN',`5d')dnl             dnl 5일 후 반송
define(`confTO_QUEUEWARN',`4h')dnl                dnl 4시간 경고

dnl ── 데몬: 25(smtp), 587(submission) 분리
DAEMON_OPTIONS(`Port=smtp, Name=MTA-v4, Family=inet')dnl
DAEMON_OPTIONS(`Port=submission, Name=MSA, M=Ea')dnl  dnl MSA: AUTH필수(E), STARTTLS(a)

dnl ── milters: DKIM/DMARC/스팸/AV
INPUT_MAIL_FILTER(`opendkim', `S=inet:8891@127.0.0.1')dnl
INPUT_MAIL_FILTER(`opendmarc', `S=inet:8893@127.0.0.1')dnl
INPUT_MAIL_FILTER(`spamassassin', `S=local:/run/milter-spamd.sock')dnl
INPUT_MAIL_FILTER(`clamav', `S=inet:3310@127.0.0.1, F=T, T=S:4m;R:4m;E:10m')dnl

define(`confMILTER_MACROS_CONNECT',`j, {if_addr}')dnl
define(`confMILTER_MACROS_HELO',`{verify}, {cert_subject}')dnl
define(`confMILTER_MACROS_ENVFROM',`i, {auth_type}, {auth_authen}')dnl
define(`confMILTER_MACROS_ENVRCPT',`i, {rcpt_mailer}, {rcpt_addr}')dnl

MAILER(`smtp')dnl
MAILER(`procmail')dnl
```

**포인트**
- **MSA(587)**에서 `M=Ea` → **E: AUTH 필요**, **a: STARTTLS 가능**. 실제 실무는 **"TLS 후 AUTH"**를 강제(클라이언트 정책/서버 정책 동시 적용).
- `greet_pause`/`dnsbl`/`delay_checks`로 연결 초기에 봇 차단.
- `INPUT_MAIL_FILTER`로 **DKIM/DMARC/스팸/AV**를 **체인**으로 구성.

### access DB(릴레이/차단/정책) 예시

`/etc/mail/access`:
```
# 내부 네트워크 릴레이 허용

Connect:192.0.2              RELAY
Connect:198.51.100           RELAY

# 발신자/받는자 도메인 정책

From:bad-domain.example      REJECT
To:ceo@example.com           OK              # 특정 수신자 예외 허용

# 인증 사용자 그룹(예: SASL)

AuthInfo:example.com "U:no-reply@example.com" "P:***" "M:LOGIN"
```
컴파일:
```bash
makemap hash /etc/mail/access < /etc/mail/access
systemctl reload sendmail
```

### SASL(AUTH) — /etc/sasl2/Sendmail.conf

```conf
pwcheck_method: saslauthd
mech_list: PLAIN LOGIN
```
- `saslauthd` 백엔드: 시스템 계정/LDAP/전용 DB 등 선택.
- **정책**: 클라이언트는 **TLS 성립 후 AUTH**. `confAUTH_OPTIONS`의 `p`는 **평문 AUTH를 TLS 없이 금지**.

### STARTTLS/SMTPS 검증

- **STARTTLS**:
```bash
openssl s_client -starttls smtp -connect mail.example.com:25 -servername mail.example.com
```
- **SMTPS(465)**:
```bash
openssl s_client -connect mail.example.com:465 -servername mail.example.com
```
*체크*: 서버 인증서 CN/SAN, 체인, 암호군, ALPN(해당 시), OCSP Stapling(선택).

### HELO/EHLO·스푸핑 억제

- `FEATURE(delay_checks)` + `smtpd_helo_required` 유사 정책(개념)은 sendmail에선 **HELO 검사 매크로**와 RBL, `reject_invalid_helo_hostname`에 상응하는 규칙(액세스/규칙셋) 조합으로 구현.
- **HELO=IP 리터럴/존재하지 않는 도메인** 차단 → access DB + DNS 검증 활용.

### 큐/재시도·장애 대응

- 큐 확인: `mailq`, `sendmail -bp`
- 강제 재시도: `sendmail -q`
- 경고/반송 타이머: `confTO_QUEUEWARN`, `confTO_QUEUERETURN`
- **MX 다중화** + 시스템 **자원 제한(confMAX_DAEMON_CHILDREN)** 으로 폭주 방지.

### milter 연동(요지)

- **opendkim**: 서명/검증(발신 서명, 수신 검증 모두 가능)
- **opendmarc**: SPF/DKIM 결과 기반 **DMARC 정책** 적용(격리/거부/태깅)
- **spamassassin/rspamd**: 콘텐츠 스코어링 → 헤더 태깅/격리
- **clamav-milter**: 첨부 AV 검사(대용량 타임아웃 조정)
- **ARC**는 opendmarc/rspamd 등 최신 스택에서 지원(포워딩 보전)

### IPv6/바인딩

- v6 리슨: `DAEMON_OPTIONS(\`Port=smtp, Name=MTA-v6, Family=inet6')`
- v4/v6 분리 운영 시 포트 충돌 주의.

### SELinux/AppArmor 메모

- 배포 환경별 **sendmail milter 소켓 접근**, TLS 키 파일 권한, 스풀 디렉토리 권한을 보안 정책과 일치시킬 것.
- 에러 시 `journalctl -u sendmail`/`sealert`로 원인 파악 후 최소 권한 조정.

### 로깅/지표(간단 파서)

```python
# /var/log/maillog를 stdin으로 받아 지연/상태 집계

import re, sys, collections
delay, status = [], collections.Counter()
for line in sys.stdin:
    if m := re.search(r'delay=([\d\.]+)', line): delay.append(float(m.group(1)))
    if m := re.search(r'status=(\w+)', line): status[m.group(1)] += 1
print("count:", len(delay), "avg_delay:", sum(delay)/len(delay) if delay else 0)
print(status)
```

### 통합 체크리스트(sendmail)

- [ ] **MSA(587)** 분리 + **AUTH 필수**, **TLS 후 AUTH**
- [ ] **STARTTLS/SMTPS** 인증서 체인/키 권한/암호군 확인
- [ ] **access DB** 릴레이 제한(내부망/관리 IP만)
- [ ] **RBL + greet_pause + delay_checks** 활성
- [ ] **INPUT_MAIL_FILTER**: DKIM/DMARC/스팸/AV 연동
- [ ] **큐 타이머/용량/스레드 제한** 적정
- [ ] **로그**: TLS 유무/암호군/지연/반송 사유/스코어 태깅 확인
- [ ] **백업/DR**: 설정 파일/키/큐/사서함 백업 절차

---

## 이메일 인증 기술(스팸 메일 방지)

### 계층 요약

```
[발신 정책] SPF ─→ 수신서버에서 "보낸 IP가 합법?" 확인
[콘텐츠 무결] DKIM ─→ 헤더/본문 서명 검증, 도메인 키 신뢰
[정렬과 정책] DMARC ─→ SPF/DKIM 결과 + From: 정렬 → p=none/quarantine/reject
[포워딩 보전] ARC ─→ 중계시 인증결과 보존
[전송 보안] MTA-STS/TLSRPT, DANE ─→ SMTP TLS 강제/보고/DNSSEC 고정
[로고 신뢰] BIMI ─→ DMARC 집행 + VMC 인증서 기반 브랜드 표시(선택)
[평판/내용] RBL/그레이리스트/스팸 필터 ─→ 실시간 차단/스코어링
```

### SPF(Sender Policy Framework)

- TXT 예:
```
example.com. IN TXT "v=spf1 ip4:203.0.113.10 include:_spf.mailhost.com -all"
```
- **메커니즘**: `ip4/ip6/a/mx/ptr/exists/include`
- **한정자**: `+`(pass, 기본), `-`(fail), `~`(softfail), `?`(neutral)
- **정렬(Alignment)**: DMARC에서는 `From:` 도메인과 **SPF 도메인**(smtp.mailfrom)이 **relaxed/strict**로 정렬되는지 본다.
- **주의**: 복잡한 `include` 체인은 **DNS 조회 10회 제한** 초과 위험 → **플래트닝**/서브넷 통합 고려.

### DKIM(DomainKeys Identified Mail)

- **발신자가 헤더/본문에 서명**, 수신자는 **selector._domainkey.domain**에서 공개키 조회 후 검증.
- 선택자/키 롤링 전략: `selectorYYYYMM` 형태 권장, **RSA 2048+** 또는 **ed25519**.
- 중요 파라미터: `d=`(도메인), `s=`(선택자), `h=`(서명 대상 헤더 목록), `c=`(정규화, `relaxed/relaxed` 권장), `t=`(타임스탬프) 등.

**opendkim.conf 예**
```conf
Syslog                  yes
UMask                   002
Mode                    sv
Canonicalization        relaxed/relaxed
Selector                selector1
KeyTable                /etc/opendkim/key.table
SigningTable            /etc/opendkim/signing.table
AutoRestart             yes
Socket                  inet:8891@127.0.0.1
OversignHeaders         From:Subject:To:Date:Message-ID
MinimumKeyBits          2048
```

`/etc/opendkim/key.table`:
```
selector1._domainkey.example.com example.com:selector1:/etc/opendkim/keys/example.com/selector1.private
```
`/etc/opendkim/signing.table`:
```
*@example.com selector1._domainkey.example.com
```
**DNS(TXT)**:
```
selector1._domainkey.example.com. IN TXT "v=DKIM1; k=rsa; p=MIIBIjANBgkq..."
```

### DMARC(Domain-based Message Authentication, Reporting & Conformance)

- **SPF 또는 DKIM 중 최소 하나 pass** + **From: 정렬** 필요
- 정책/보고 예:
```
_dmarc.example.com. IN TXT "v=DMARC1; p=quarantine; sp=reject; adkim=s; aspf=s; pct=100; rua=mailto:dmarc@ex.com"
```
- `p=`: none→quarantine→reject(강화 순)
- `adkim/aspf` strict(`s`) 권장(피싱 억제)
- **운영팁**: 초기에는 `p=none` + `rua`로 데이터 수집 → 정렬/서명 커버리지 개선 후 `quarantine/reject`로 상향.

**opendmarc.conf 예(요지)**:
```conf
Syslog                  true
Socket                  inet:8893@127.0.0.1
AuthservID              mx.receiver.net
TrustedAuthservIDs      mx.receiver.net
RejectFailures          false     # 초반엔 격리/태깅 → 점진 거부
SPFIgnoreResults        false
```

### ARC(Authenticated Received Chain)

- 포워더/메일링리스트 환경에서 **원 인증 결과를 봉인해 전달**.
- DMARC 환경에서 정당한 포워딩이 깨지는 문제를 완화(수신자 정책/평판 시스템이 ARC를 신뢰할 때 유효).

### MTA-STS & TLSRPT(전송 보안 강제/보고)

- **정책 파일(HTTPS)**: `https://mta-sts.example.com/.well-known/mta-sts.txt`
```
version: STSv1
mode: enforce
mx: mx1.example.com
mx: mx2.example.com
max_age: 86400
```
- **DNS**:
```
_mta-sts.example.com.  IN TXT "v=STSv1; id=2024110101"
_smtp._tls.example.com IN TXT "v=TLSRPTv1; rua=mailto:tlsrpt@ex.com"
```
- 목적: **중간자에 의한 STARTTLS 제거(STRIP) 방지**, 실패 보고 수집.

### DANE(SMTP + DNSSEC 기반 TLSA)

- DNSSEC 보호 하에 **TLSA** 레코드로 SMTP 서버 인증서/공개키를 고정.
```
_25._tcp.mail.example.com. IN TLSA 3 1 1 <SPKI-SHA256>
```
- 우선순위: **DANE > MTA-STS**(지원 환경) — 실무는 병행 고려.

### BIMI(Brand Indicators for Message Identification, 선택)

- 전제: **DMARC 집행(quarantine/reject)**, 그리고 VMC(검증 마크 인증서).
- 효과: 지원 클라이언트에서 **브랜드 로고 표시** → 피싱 위험 감소/브랜드 신뢰 향상.

### RBL/그레이리스트/스팸 필터 전략

- **RBL(DNSBL)**: zen.spamhaus.org 등 연결 단계 차단
- **그레이리스트**: 처음은 4xx로 지연, 재시도 여부로 봇/정상 구분
- **콘텐츠 스코어링**: SpamAssassin/Rspamd — URL 평판, 헤더/본문 특징, 첨부 유형 등 종합

스코어링 모델의 단순 수식 예:
$$
S = \sum_{i=1}^{n} w_i \cdot f_i(x) \quad\text{and block if } S \ge T
$$
- \(f_i\): 규칙/특징의 득점 함수, \(w_i\): 가중치, \(T\): 차단 임계치

### SpamAssassin/Rspamd 연동(개요)

- **milter-spamd** 소켓을 sendmail에 연결(`INPUT_MAIL_FILTER`).
- 결과 헤더 예:
```
X-Spam-Flag: YES
X-Spam-Score: 8.0
X-Spam-Status: Yes, score=8.0 required=5.0 tests=DKIM_INVALID,SPF_FAIL,...
```
- 정책: **임계치 이상 격리/태깅**, 사용자 폴더(Spam) 배달.

### 종합 DNS 레코드 샘플(도메인: example.com)

```
; 수신 라우팅
example.com.            MX   10 mx1.example.com.
example.com.            MX   20 mx2.example.com.

; SPF
example.com.            TXT  "v=spf1 ip4:203.0.113.10 include:_spf.mailhost.com -all"

; DKIM (selector1)
selector1._domainkey.example.com. TXT "v=DKIM1; k=rsa; p=MIIBIjANBgkq..."

; DMARC
_dmarc.example.com.     TXT  "v=DMARC1; p=quarantine; adkim=s; aspf=s; rua=mailto:dmarc@ex.com"

; MTA-STS / TLSRPT
_mta-sts.example.com.   TXT  "v=STSv1; id=2024110101"
_smtp._tls.example.com. TXT  "v=TLSRPTv1; rua=mailto:tlsrpt@ex.com"

; DANE (옵션, DNSSEC 전제)
_25._tcp.mail.example.com. TLSA 3 1 1 <SPKI-SHA256>
```

### swaks 테스트(권장 툴)

```bash
# STARTTLS + AUTH 테스트 (MSA 587)

swaks --to user@receiver.net \
      --server smtp.submit.example.com \
      --port 587 --ehlo test --auth LOGIN \
      --auth-user no-reply@example.com --auth-password '***' \
      --tls --tls-verify

# DKIM/DMARC 결과가 Authentication-Results에 표시되는지 수신 측에서 확인

```

### TLSRPT/DMARC 리포트 수집·요약(샘플 파서)

```python
# DMARC aggregate(XML) 혹은 TLSRPT(JSON) 파일을 폴더에서 수집해 간단 집계

import os, json, gzip, xml.etree.ElementTree as ET
from collections import Counter

def parse_dmarc(path):
    try:
        root = ET.parse(path).getroot()
        domain = root.findtext('.//policy_published/domain')
        recs = root.findall('.//record')
        res = Counter()
        for r in recs:
            d = r.findtext('row/policy_evaluated/dkim')
            s = r.findtext('row/policy_evaluated/spf')
            res[(d,s)] += int(r.findtext('row/count'))
        return domain, res
    except Exception:
        return None, Counter()

def parse_tlsrpt(path):
    try:
        data = json.load(open(path))
        issues = Counter()
        for r in data.get("report", {}).get("tls-report", []):
            for pol in r.get("policy", []):
                for s in pol.get("summary", []):
                    issues[s.get("result-type","unknown")] += s.get("result-count",0)
        return issues
    except Exception:
        return Counter()

if __name__ == "__main__":
    base = "/reports"
    dmarc_tot = Counter(); tls_tot = Counter()
    for fn in os.listdir(base):
        p = os.path.join(base, fn)
        if fn.endswith(".xml") or fn.endswith(".xml.gz"):
            if fn.endswith(".gz"):
                with gzip.open(p, 'rb') as f:
                    open("/tmp/_x.xml", "wb").write(f.read()); p = "/tmp/_x.xml"
            _, c = parse_dmarc(p); dmarc_tot += c
        elif fn.endswith(".json"):
            tls_tot += parse_tlsrpt(p)
    print("DMARC:", dmarc_tot)
    print("TLSRPT:", tls_tot)
```

### 운영 체크리스트(인증 기술)

- [ ] **SPF**: 최소화된 권한, 테스트 후 `-all`
- [ ] **DKIM**: 2048+ 키, **OversignHeaders**에 주요 헤더 포함, **선택자 롤링**
- [ ] **DMARC**: 초기 `p=none`+`rua` 수집 → 정렬/커버리지 확보 후 `quarantine/reject`
- [ ] **ARC**: 포워더/게이트웨이 존재 시 도입
- [ ] **MTA-STS/TLSRPT**: `mode=enforce`(준비 완료 후), 리포트 모니터링
- [ ] **DANE**: DNSSEC 도입 시 TLSA 고정
- [ ] **RBL/그레이리스트/스팸 필터**: 연결·콘텐츠 다층 방어, 임계치/격리 정책 운영
- [ ] **모니터링**: DMARC/TLSRPT 대시보드, 반송 코드/지연/스팸 스코어 분포

---

## 부록) 실전 시나리오 — “처음부터 끝까지” 요약

1) **MSA 분리**: `DAEMON_OPTIONS(Port=submission, M=Ea)` + SASL/TLS
2) **릴레이 제한**: `/etc/mail/access`로 내부망 이외 REJECT
3) **milter 체인**: opendkim → opendmarc → spam → AV
4) **DNS 구성**: MX/SPF/DKIM/DMARC/MTA-STS/TLSRPT(옵션: DANE)
5) **검증**: `openssl s_client`, `swaks`, 수신 측 **Authentication-Results** 확인
6) **관측**: maillog/DMARC/TLSRPT 집계 → 정책 강화 사이클 운용

---

## 요약

- **sendmail 하드닝**은 **MSA 분리, TLS+SASL, access/RBL/greet_pause, milter 체인**이 핵심이다.
- **스팸 방지 스택**은 **SPF/DKIM/DMARC/ARC** + **전송 보안(MTA-STS/TLSRPT/DANE)** + **RBL/스팸 필터**의 **다층 방어**로 완성된다.
- **지속적 리포팅/로깅 분석**으로 정렬/평판/지연·반송 지표를 개선하며, DMARC 정책을 점진적으로 **집행(reject)** 단계로 올린다.
