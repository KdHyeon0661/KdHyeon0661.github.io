---
layout: post
title: 정보보안기사 - IP 프로토콜
date: 2025-11-06 22:25:23 +0900
category: 정보보안기사
---
# 프로토콜

## IPv4란 무엇인가

- **역할**: **베스트에포트(best-effort)** 네트워크 계층. 종단간 신뢰성/순서는 TCP 등 **상위 계층**이 책임.
- **핵심 기능**: 주소 지정, 패킷 전달/포워딩, 분절(fragmentation)과 재조립(reassembly), **TTL 기반 루프 억제**, 최소한의 헤더 검증(**헤더 체크섬**).
- **보안상 특징**: 인증/무결성/기밀성 **없음** → 스푸핑/스캐닝/분절 악용 가능 → 상위(IPSec/TLS)나 **경계 필터링(BCP38/uRPF/ACL)** 필요.

---

## IPv4 헤더 구조(고정 20바이트 + 옵션 최대 40바이트)

### ASCII 다이어그램 (비트 단위)

```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+---+---+---+---+---+---+---+---+-------------------------------+
|Ver| IHL|DSCP |ECN |           Total Length                    |
+---+---+---+---+---+---+---+---+-------------------------------+
|           Identification            |Flags|   Fragment Offset |
+-------------------------------------+-----+-------------------+
|   Time To Live    |     Protocol    |      Header Checksum   |
+--------------------------------------------------------------+
|                      Source Address                          |
+--------------------------------------------------------------+
|                   Destination Address                        |
+--------------------------------------------------------------+
|                      Options (0–40B)         |   Padding     |
+--------------------------------------------------------------+
```

### 필드 설명 요약

| 필드 | 길이 | 의미/운영 포인트 |
|---|---:|---|
| **Version** | 4b | 4(IPv4) |
| **IHL** | 4b | 헤더 길이(32비트 워드 수). 최소 5(=20B) |
| **DSCP/ECN** | 6b/2b | QoS·혼잡 알림. DiffServ/ECN |
| **Total Length** | 16b | 헤더+데이터 총길이(최대 65535) |
| **Identification** | 16b | **분절 재조립** 식별자(IPID) |
| **Flags** | 3b | **DF**(Don’t Fragment), **MF**(More Fragments) |
| **Fragment Offset** | 13b | 8바이트 단위 오프셋 |
| **TTL** | 8b | 홉당 감소, 0되면 폐기(ICMP Time Exceeded) |
| **Protocol** | 8b | 상위 프로토콜(TCP=6, UDP=17, ICMP=1 등) |
| **Header Checksum** | 16b | **헤더만** 대상(페이로드 제외) |
| **Source/Destination** | 32b/32b | IPv4 주소 |
| **Options** | 0–40B | (거의 사용하지 않음; 보안상 차단 권고) |

**헤더 체크섬** 계산 메모(1의 보수 합):
$$
\text{Checksum} = \neg \left(\sum_{i=1}^{10} w_i \right)_{\text{1's complement}}
$$
- \(w_i\): 16비트 워드(옵션 포함 시 그만큼 증가).
- 라우터는 TTL 감소 시 **헤더 재계산** 필요 → 성능 영향(현대 HW는 오프로드).

---

## IPv4 주소 체계: 클래스·CIDR·특수 주소

### 주소 클래스(역사적)

- A: 0.0.0.0–127.255.255.255 (/8)
- B: 128.0.0.0–191.255.255.255 (/16)
- C: 192.0.0.0–223.255.255.255 (/24)
→ **현대는 CIDR**(Classless Inter-Domain Routing) 사용.

### CIDR와 서브넷 마스크

- 표기: `192.168.10.0/24`
- **호스트 수**(브로드캐스트 포함 네트워크에서):
  $$
  \text{호스트수} = 2^{(32 - p)} - 2
  $$
  - \(p\): prefix 길이
  - **예외**: `/31`(RFC 3021, **포인트투포인트** 링크에서 -2 제외), `/32`(단일 호스트 라우트)

### 특수/예약 주소(요약 표)

| 용도 | 블록/주소 | 비고 |
|---|---|---|
| 프라이빗 | **10.0.0.0/8**, **172.16.0.0/12**, **192.168.0.0/16** | NAT 내부 |
| 링크로컬 | **169.254.0.0/16** | DHCP 실패 시 자동(APIPA) |
| 루프백 | **127.0.0.0/8**(보통 127.0.0.1) | 로컬 테스트 |
| 멀티캐스트 | **224.0.0.0/4** | 224.0.0.0/24은 링크로컬 |
| 제한 브로드캐스트 | **255.255.255.255** | 로컬 세그먼트 한정 |
| CGNAT | **100.64.0.0/10** | 통신사업자 NAT |
| 테스트/벤치 | 198.18.0.0/15 | 성능 테스트 용도 |
| 예약/실험 | 240.0.0.0/4 등 | 일반 호스트 미사용 |

### 유니캐스트/브로드캐스트/멀티캐스트

- **유니캐스트**: 1:1 전달.
- **디렉티드 브로드캐스트**: `<네트워크>.255` 등(현대 장비는 기본 차단).
- **멀티캐스트**: 224/4, L2에서 **01:00:5e:** OUI 매핑.

---

## 서브넷팅·VLSM·요약(Route Summarization)

### 기본 계산 예

- `192.168.10.0/26` → 호스트 비트 6 → 사용 가능 호스트 **62**
- 네트워크: `192.168.10.0`, 브로드캐스트: `192.168.10.63`
- 범위: `192.168.10.1–62`

### VLSM 설계 예(요구: 50, 25, 10, 5 호스트)

1) /26(62) → 50용: `192.168.10.0/26`
2) /27(30) → 25용: `192.168.10.64/27`
3) /28(14) → 10용: `192.168.10.96/28`
4) /29(6) → 5용: `192.168.10.112/29`

### 예

- 분산된 경로 `10.10.0.0/24`, `10.10.1.0/24`, `10.10.2.0/24`, `10.10.3.0/24` → **`10.10.0.0/22`**로 요약.

**수식 메모(요약 공통 비트 찾기)**:
두 경로의 네트워크 주소를 2진수로 XOR → 선행 0의 개수 = 요약 prefix.

---

## & 재조립(Reassembly), PMTUD

### 왜 분절이 필요한가

- 링크별 **MTU** 차이(이더넷 1500, PPPoE 1492, GRE/IPSec 오버헤드 등).
- IPv4는 **송신 호스트 또는 경로의 라우터**가(DF=0일 때) 분절 가능.

### 관련 헤더 필드

- **DF**: 1이면 **분절 금지**.
- **MF**: 마지막 조각이면 0, 나머지는 1.
- **Fragment Offset**: 8바이트 단위.
- **Identification**: 재조립 식별자.

### Path MTU Discovery (PMTUD)

- DF=1로 전송 → 경로 중 MTU 작을 경우 **ICMP Fragmentation Needed(Type 3 Code 4)** 반환 → 호스트 MSS 조정.
- **ICMP 차단** 시 성능 문제(블랙홀) → **ICMP 필수 타입 허용** 권고.

### 실습: PMTUD 확인

리눅스:
```bash
# DF=1(ping -M do), 페이로드 크기 조절(-s)

sudo ping -M do -s 1472 8.8.8.8     # 1472 + 8(ICMP)+20(IP) = 1500
sudo ping -M do -s 1473 8.8.8.8     # 실패 시 MTU=1500 경로로 판단
```

윈도우:
```cmd
ping -f -l 1472 8.8.8.8
```

### 보안 메모(분절 공격)

- **오버랩 분절(teardrop), tiny fragment**, IDS 우회, CPU/메모리 고갈 → **경계에서 분절 재조립/정상화** 또는 **작은 분절/옵션 드롭** 정책 필요.

nftables(작은 분절 드롭 예시, 신중 적용):
```bash
nft add rule inet filter input ip frag-off & 0x1fff != 0 counter drop
```

---

## TTL·라우팅(포워딩)·LPM

### TTL과 traceroute

- 각 홉에서 TTL–1, 0되면 **ICMP Time Exceeded** 반환 → 경로 추적(traceroute).
리눅스:
```bash
traceroute -n 1.1.1.1
```
윈도우:
```cmd
tracert -d 1.1.1.1
```

### RIB/FIB/Longest Prefix Match(LPM)

- **RIB**: 라우팅 프로토콜(OSPF/BGP/RIP)·정적 경로 **모음**.
- **FIB**: 포워딩 테이블(HW TCAM 등) — **가장 긴 프리픽스**가 승리.
- **Admin Distance/Metric**: 출처/비용 우선순위.

리눅스 정적 경로:
```bash
# 기본 게이트웨이

sudo ip route add default via 192.168.10.1
# 특정 대역 정적 라우트

sudo ip route add 10.20.0.0/16 via 192.168.10.254
ip route show
```

윈도우:
```cmd
route add 10.20.0.0 mask 255.255.0.0 192.168.10.254 metric 5 -p
route print
```

---

## DSCP/ECN — 혼잡제어와 서비스 품질

### 구조

- 상위 **6비트 = DSCP**, 하위 **2비트 = ECN**.
- DSCP 예: **EF(46)**, AFxy(예: AF41=34), CSx.
- ECN: 00(Non-ECT), 10/01(ECT(0/1)), **11(CE, Congestion Experienced)**.

### 마킹 예

리눅스 iptables(mangle):
```bash
# EF 마킹(VoIP 예)

sudo iptables -t mangle -A OUTPUT -p udp --dport 5060 -j DSCP --set-dscp 46
# 웹 트래픽 AF21

sudo iptables -t mangle -A OUTPUT -p tcp --dport 80 -j DSCP --set-dscp-class AF21
```

nftables:
```bash
nft add rule inet mangle output tcp dport 443 ip dscp set cs5
```

**주의**: 경로 상 장비가 DSCP를 **재마킹**하거나 **무시**할 수 있음. 내부 QoS 정책 부합 필요.

---

## IPv4 옵션(Options)과 보안

- 대표 옵션: **Loose/Strict Source Route**, **Record Route**, **Timestamp** 등.
- 현실: **라우터/방화벽에서 드랍/스트립**이 일반적(성능·보안).
- **권고**: 경계에서 **IP 옵션 포함 패킷 차단**(업무 필요 시 예외).

iptables 예:
```bash
sudo iptables -A INPUT -m ipopt --ssrr -j DROP
sudo iptables -A INPUT -m ipopt --lsrr -j DROP
sudo iptables -A INPUT -m ipopt --rr -j DROP
```

---

## NAT(IPv4 주소 절약/경계 정책)

### 유형

- **SNAT(MASQUERADE)**: 내부→외부 **소스 주소 변환**(다수 호스트 공유).
- **DNAT/포트포워딩**: 외부→내부 **목적지 주소/포트 변환**.
- **풀(POOL)/PAT**: 포트 기반 다중 매핑.

### 리눅스 iptables 예

```bash
# 패킷 포워딩 허용

sysctl -w net.ipv4.ip_forward=1

# SNAT (고정 공인IP 203.0.113.10)

iptables -t nat -A POSTROUTING -o eth1 -j SNAT --to-source 203.0.113.10

# 또는 동적(모뎀/다이얼업)

iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE

# DNAT (80→내부 웹 192.168.10.100:80)

iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 \
         -j DNAT --to-destination 192.168.10.100:80
```

nftables(요약):
```bash
table ip nat {
  chain prerouting { type nat hook prerouting priority -100; }
  chain postrouting { type nat hook postrouting priority 100; }
}
nft add rule ip nat postrouting oifname "eth1" masquerade
nft add rule ip nat prerouting iifname "eth1" tcp dport 80 dnat to 192.168.10.100
```

**보안 메모**: NAT는 **보안 기능이 아님**. 인입 제어는 **방화벽 정책**이 수행.

---

## 운영·가시성·트러블슈팅

### 공용 명령

```bash
# Linux

ip -br addr
ip route
ss -ant
sudo tcpdump -nni eth0 ip

# Windows

ipconfig /all
route print
netstat -ano
```

### Wireshark 필터

```
ip && !ipv6
ip.ttl < 5
ip.flags.df == 1 && icmp
ip.frag_offset > 0 || ip.flags.mf == 1   # 분절
ip.dsfield.dscp == 46                    # EF
```

### “왜 안돼?” 체크리스트

- [ ] 기본 게이트웨이/라우팅 설정 오류?
- [ ] 서브넷 마스크 불일치(같은 VLAN 내 상호 통신 불가)?
- [ ] ICMP 완전 차단으로 PMTUD 실패?
- [ ] NAT 테이블 포트 고갈/세션 타임아웃?
- [ ] IP 옵션 포함 패킷 차단으로 업무 영향?

---

## 보안 베스트 프랙티스(IPv4 관점)

- **스푸핑 차단**: **BCP38**(엣지 소스 검증), **uRPF**(Strict/Loose).
- **Martian/Bogon** 필터: 프라이빗/예약 블록의 **WAN 인입 차단**.
리눅스 sysctl:
```bash
sysctl -w net.ipv4.conf.all.rp_filter=1
sysctl -w net.ipv4.conf.default.rp_filter=1
```
- **분절 정책**: 작은 분절/옵션 기반 우회 차단, 경계 재조립/정상화.
- **ICMP 정책**: PMTUD 필수 타입 허용(Type 3 Code 4, Type 11).
- **라우팅 경계**: 기본 거부, 화이트리스트(정적 또는 동적+필터).
- **로그/가시성**: NetFlow/IPFIX, 방화벽 드롭 로그, ICMP rate-limit 관제.

---

## 미니 랩(실습)

### 랩 A — “/24에서 VLSM 설계 후 라우팅”

**요구**: 50/25/10/5 호스트.
**해결**: `/26`, `/27`, `/28`, `/29`로 분할(§4.2).
**검증**:
```bash
# 라우터(리눅스)에서 각 인터페이스에 서브넷 할당

ip addr add 192.168.10.1/26 dev eth0
ip addr add 192.168.10.65/27 dev eth1
ip addr add 192.168.10.97/28 dev eth2
ip addr add 192.168.10.113/29 dev eth3
# 호스트에서 게이트웨이로 ping, 상호 통신 확인

```

### 랩 B — “PMTUD 동작 확인”

```bash
sudo ping -M do -s 1472 1.1.1.1
sudo ping -M do -s 1473 1.1.1.1   # 실패 예상
```
**관찰**: 실패 시 경로 MTU=1500 추정. GRE/IPSec 터널 경로에서는 1472보다 더 작을 수 있음.

### 랩 C — “DSCP 마킹과 관측”

```bash
# EF 마킹 후 tcpdump로 dsfield 확인

iptables -t mangle -A OUTPUT -p udp --dport 5060 -j DSCP --set-dscp 46
sudo tcpdump -nni eth0 'ip[1] & 0xfc = 0xb8'   # 0xb8=46<<2 (DSCP 비트 위치 주의)
```

---

## 예상문제(필기/실무)

1) IPv4 헤더의 **IHL**과 **Total Length**가 의미하는 바와, 옵션이 12바이트 있을 때 IHL 값은?
2) **DF/MF/Fragment Offset/Identification**의 역할을 설명하고, PMTUD와의 관계를 서술하라.
3) `/31` 링크를 사용하는 이유와 장점은? `/30`과 비교해 설명하라.
4) **Longest Prefix Match**가 필요한 이유를 예시(두 경로가 겹치는 상황)로 설명하라.
5) **DSCP/ECN**의 비트 구조, **EF(46)**의 의미와 사용 사례를 쓰라.
6) **IP 옵션**이 보안상 왜 문제가 되는지, 경계 장비에서 취할 수 있는 조치를 쓰라.
7) **BCP38/uRPF**의 개념과 운영 시 주의점(비대칭 라우팅)을 설명하라.
8) NAT 환경에서 **SNAT vs DNAT** 차이와 iptables 설정 예를 각각 제시하라.

---

## 계산 치트시트

- 사용 호스트 ≥ \(H\) → prefix \(p\)는
  $$
  p = 32 - \lceil \log_2(H + 2) \rceil \quad (\text{/31 예외})
  $$
- 요약(prefix) 구하기: 경로의 네트워크 주소를 2진수로 비교 → **공통 선행 비트 수** = 요약 prefix.

---

## 코드/명령 스니펫 모음

```bash
# 리눅스 라우팅/포워딩/NAT 한 번에 (랩 용도)

sysctl -w net.ipv4.ip_forward=1
ip route add 10.20.0.0/16 via 192.168.10.254
iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE
```

```powershell
# 윈도우: 인터페이스/이웃/라우트

Get-NetIPConfiguration
Get-NetNeighbor -AddressFamily IPv4
route add 10.20.0.0 mask 255.255.0.0 192.168.10.254 metric 10 -p
```

```bash
# tcpdump: 분절/DSCP/ICMP PMTUD 관측

sudo tcpdump -nni eth0 'ip[6:2] & 0x3fff != 0'      # MF/frag offset set
sudo tcpdump -nni eth0 'icmp and (icmp[0]=3 and icmp[1]=4)'  # Frag Needed
sudo tcpdump -nni eth0 'ip[1] & 0xfc = 0xb8'        # DSCP=46(EF)
```

---

## 결론

- IPv4는 **간결한 헤더**와 **베스트에포트 전달**을 제공한다. 그 단순함 때문에 **보안 기능이 거의 없고**, **분절/옵션/ICMP 차단**과 같은 요소가 성능·안정성·탐지에 즉각적 영향을 준다.
- 운영의 핵심은 **정확한 서브넷 설계(CIDR/VLSM)**, **LPM 기반 라우팅 이해**, **PMTUD 허용(ICMP 정상화)**, **옵션/분절 우회 방지**, **NAT와 방화벽의 역할 분리**, **가시성 확보(NetFlow/패킷/로그)**이다.
- 본 문서의 표/수식/명령·정책 템플릿을 기준으로, 환경별 **파일럿→모니터링→점진 배포**로 안전하게 적용한다.
