---
layout: post
title: 확률과 통계 - 확률의 언어와 사고법
date: 2025-09-19 14:25:23 +0900
category: 확률과 통계
---
# 1) 확률의 언어와 사고법

---

## 0. 왜 ‘확률의 언어’인가 — 숫자는 맞아도, 문장은 틀리다
- 전환율 3%는 **숫자**다. 그러나 “3%가 **무엇**의 3%인가?”를 말하지 않으면 **문장**은 틀리다.  
  - 전체 사용자 기준의 전환율인지 $$P(V)$$,  
  - 노출자 기준의 전환율인지 $$P(V\mid S)$$,  
  - 클릭자 기준의 전환율인지 $$P(V\mid K)$$.  
- 동일한 3%라도 의사결정은 달라진다. **조건(Condition)**을 명시하는 습관이 데이터의 절반을 지킨다.

---

## 1. 퍼널을 사건으로: 표본공간·사건·확률
- **표본공간**: 오늘의 사용자 집합을 $$\Omega$$ 로 두자.  
- **사건(Event)**  
  - $$S$$: 오늘 푸시/배너가 **노출**됨(Shown)  
  - $$K$$: 노출을 **클릭**함(Click)  
  - $$V$$: **전환**(Convert: 구매/가입/핵심행동)  
- **확률**  
  - $$P(S)$$: 노출 비율  
  - $$P(K\mid S)$$: 노출되었을 때 클릭할 **조건부확률**(CTR)  
  - $$P(V\mid K)$$: 클릭했을 때 전환할 **조건부확률**  
  - **전체 CVR 후보**  
    - 전체 기준: $$P(V)$$  
    - 노출자 기준: $$P(V\mid S)$$  
    - 클릭자 기준: $$P(V\mid K)$$  
  어떤 KPI를 쓸지 먼저 고정해야, A/B 결과가 뒤틀리지 않는다.

---

## 2. 조건부확률·곱셈법칙·전확률법칙 — 퍼널의 기본 문법
- **조건부확률**  
  $$P(A\mid B)=\frac{P(A\cap B)}{P(B)},\quad P(B)>0$$
- **곱셈법칙(체인 룰)**  
  $$P(A\cap B)=P(A\mid B)P(B)=P(B\mid A)P(A)$$
- **전확률법칙** (사건 분할 $$\{B_i\}$$ 에 대하여)  
  $$P(A)=\sum_i P(A\mid B_i)P(B_i)$$

**퍼널에 적용**  
- 전체 전환 확률을 **클릭**을 기준으로 분해:
  $$
  P(V)=P(V\mid K)P(K)+P(V\mid \overline{K})P(\overline{K})
  $$
- 또는 **노출**을 기준으로 분해:
  $$
  P(V)=P(V\mid S)P(S)+P(V\mid \overline{S})P(\overline{S})
  $$

> 메시지: 퍼널은 **전확률 분해**로 읽는다. “전체 변화”는 “중간 단계 변화 × 그 단계의 빈도”로 이해된다.

---

## 3. 베이즈의 관점 — “관측으로 믿음을 업데이트”
- **베이즈 정리**  
  $$
  P(H\mid D)=\frac{P(D\mid H)P(H)}{P(D)}
  $$
  - $$H$$: 가설(예: “사용자는 구매 성향이 높다”)  
  - $$D$$: 데이터(예: “오늘 배너를 클릭했다”)  
- **사전확률** $$P(H)$$: 관측 전 믿음(기저율)  
- **우도** $$P(D\mid H)$$: 가설이 참일 때 데이터의 개연성  
- **사후확률** $$P(H\mid D)$$: 관측 후 업데이트된 믿음

**웹/앱 맥락**  
- $$H$$: “구매 의향 High” 사용자  
- $$D$$: “배너 클릭”  
- 클릭은 신호지만, **기저율(High 비율)**이 낮으면 클릭자 중 High의 비중이 낮을 수 있다(기저율 오류).

---

## 4. 수치 예제 1 — 푸시 알림 퍼널을 전확률로 계산
사건: $$O$$(푸시 Opt-in), $$N$$(노출), $$K$$(클릭), $$V$$(전환)

**가정**(사고실험용)
- $$P(O)=0.6$$ (60%가 수신 허용)  
- $$P(N\mid O)=0.5$$ ⇒ $$P(N)=0.3$$  
- $$P(K\mid N)=0.04$$ ⇒ $$P(K)=0.012$$  
- $$P(V\mid K)=0.12$$  
- $$P(V\mid \overline{K})=0.02$$

**전체 전환 확률**:
$$
P(V)=P(V\mid K)P(K)+P(V\mid \overline{K})P(\overline{K})
=0.12\times 0.012 + 0.02\times 0.988=0.0212
$$
즉, **전체 CVR ≈ 2.12%**.

**“전환자가 클릭했을 확률”**(후향 질문):
$$
P(K\mid V)=\frac{P(V\mid K)P(K)}{P(V)}
=\frac{0.12\times 0.012}{0.0212}\approx 0.0679
$$
**해석**: 전환의 약 6.8%만 푸시 클릭으로 유입. “전환의 대부분이 푸시 덕분”이라는 주장은 **과장**일 수 있다.

---

## 5. 선택편향·생존자 편향·콜라이더 조건화 — 실무의 함정들

### 5.1 선택편향(Selection bias)
- **문제**: “푸시 허용자만”을 분석하고 이를 전체로 일반화. 허용자는 대체로 **참여도↑**, CVR이 높게 관측될 가능성.  
- **해결**: 무작화(랜덤화)나 **층화(Stratification)**로 **Opt-in/Out**을 분리 보고. 보고 문장에 **조건**을 명시:  
  - “Opt-in 사용자 기준 CVR: $$P(V\mid O)=$$ …”

### 5.2 생존자 편향(Survivorship bias)
- **문제**: “최근 30일 **활성** 사용자만” 남기면, **원래 이탈 가능성이 높던 집단**이 사라져 개선폭이 과장.  
- **해결**: **ITT(의도한 대로 분석)**: 실험 배정 당시의 전체 코호트를 유지. 제외 기준은 사전등록(Pre-registration).

### 5.3 콜라이더 조건화(Conditioning on a collider)
- 구조: $$A\rightarrow C\leftarrow B$$ 에서 $$C$$ 로 조건화하면 $$A,B$$ 가 **가짜 상관**을 띤다.  
- **예**: “클릭한 세션만” 모아 A/B의 전환률을 비교하면, 클릭 확률의 차이를 숨긴다.  
  - **잘못된 비교**: $$P(V\mid K,A)$$ vs $$P(V\mid K,B)$$ 만 보고 결론.  
  - **올바른 비교**: 전체 효과는  
    $$
    \Delta P(V)=\Delta\{P(V\mid K)P(K)\}+\Delta\{P(V\mid \overline{K})P(\overline{K})\}
    $$
    **품질 변화**(전환|클릭)와 **양 변화**(클릭 비중)를 함께 본다.

### 5.4 기저율 오류(Base rate fallacy)
- **질문**: “클릭했으니 구매 확률이 높겠죠?”  
- **반례**: 구매 의향 High의 비율이 극히 낮으면, 클릭자 중 상당수는 Low일 수 있다.  
  - 베이즈로 항상 **사전**을 함께 본다:  
    $$
    P(H\mid K)\propto P(K\mid H)P(H)
    $$

---

## 6. 수치 예제 2 — A/B에서 ‘클릭 품질’ vs ‘클릭 양’ 분해
A와 B의 퍼널(하루치, 사용자 기준)을 가정:

- **A**:  
  - $$P(K_A)=0.010$$ (CTR 1.0%)  
  - $$P(V\mid K_A)=0.15$$  
  - $$P(V\mid \overline{K_A})=0.02$$  
  ⇒  
  $$
  P(V_A)=0.15\times 0.010+0.02\times 0.990=0.0015+0.0198=0.0213
  $$
  **CVR_A = 2.13%**

- **B**:  
  - $$P(K_B)=0.016$$ (CTR 1.6%, **양 증가**)  
  - $$P(V\mid K_B)=0.12$$ (**품질 하락**)  
  - $$P(V\mid \overline{K_B})=0.02$$  
  ⇒  
  $$
  P(V_B)=0.12\times 0.016+0.02\times 0.984=0.00192+0.01968=0.0216
  $$
  **CVR_B = 2.16%**

**해석**
- B는 클릭 **양**이 늘고, 클릭 **품질**은 떨어졌으나, 전체 CVR은 **소폭↑**.  
- 리포트 문장:
  - “B는 CTR(+0.6pp) 증가가 **전체 CVR(+0.03pp)** 상승을 견인. 다만 **클릭 품질(전환|클릭)**은 A 대비 하락(−3pp).”

---

## 7. 수치 예제 3 — 심슨의 역설(모바일 vs 데스크톱)
세그먼트별 성과가 전체와 **역전**될 수 있다.

- **모바일(M)**  
  - A: 노출 90k, $$P(V\mid S,A)=2.0\%$$  
  - B: 노출 10k, $$P(V\mid S,B)=2.5\%$$

- **데스크톱(D)**  
  - A: 노출 10k, $$P(V\mid S,A)=5.0\%$$  
  - B: 노출 90k, $$P(V\mid S,B)=4.0\%$$

**세그먼트별**:  
- 모바일: B(2.5%) > A(2.0%)  
- 데스크톱: A(5.0%) > B(4.0%)

**전체**는? 가중치(노출 수)가 다르므로 역전 가능.  
- A 전체 전환 수: $$90{,}000\times 0.02 + 10{,}000\times 0.05=1{,}800+500=2{,}300$$  
- B 전체 전환 수: $$10{,}000\times 0.025 + 90{,}000\times 0.04=250+3{,}600=3{,}850$$  
- **전체 CVR**  
  - A: $$2{,}300/100{,}000=2.30\%$$  
  - B: $$3{,}850/100{,}000=3.85\%$$ ⇒ **B가 우세**

**교훈**: 세그먼트 가중치(트래픽 믹스)가 다르면 전체 결론이 뒤집힌다.  
- **보고 원칙**: 전체 + 주요 세그먼트(모바일/데스크톱 등)를 **동시** 제공.

---

## 8. 독립·배반·조건부독립 — 퍼널 해석의 기초 구분
- **배반(Mutually exclusive)**: $$A\cap B=\varnothing$$  
- **독립(Independent)**: $$P(A\cap B)=P(A)P(B)$$  
  - 독립이면 $$P(A\mid B)=P(A)$$  
- **조건부독립**: $$P(A\cap B\mid C)=P(A\mid C)P(B\mid C)$$  
  - 예: 세그먼트 $$C$$(모바일/데스크톱) 조건에서 클릭과 전환이 “거의” 독립처럼 보일 수 있으나, 조건이 바뀌면 다시 연관.

**실무 주의**  
- “상관이 낮다” ≠ “독립이다”. 비선형 종속이면 공분산 0이어도 독립이 아니다.  
- 퍼널에서 $$K,V$$ 는 일반적으로 독립이 아니다. $$P(V\mid K)\neq P(V)$$ 인 경우가 보통이다.

---

## 9. 무작화 단위·분석 단위 — 크로스오버와 비독립성 방지
- **권장**: D1 리텐션·CVR 등 **사용자 수준** KPI는  
  - **무작화 단위**: 사용자 ID  
  - **분석 단위**: 사용자 ID (ITT)  
- 이유: 한 사용자가 A와 B를 **모두 노출**(크로스오버)받으면, 세션·페이지뷰 분석에서 **비독립성**과 **과소분산** 문제가 생긴다.

---

## 10. 전환율 정의의 일관성 — “조건을 문장에 박아 넣기”
리포트 한 줄 템플릿:
- “**집단/조건**: (전체|Opt-in|신규)… **확률**: (전환|전환|클릭)… **기준**: (오늘|D0 코호트)… **결과**: +x.xpp”
- 예:
  - “Opt-in 사용자 **노출 기준** 전환율 $$P(V\mid S)$$ 이 B가 A 대비 **+0.12pp**(2.10%→2.22%), 95% CI …”
  - “**전체 기준** CVR $$P(V)$$ 은 +0.03pp 상승이나, **클릭 기준** 전환률 $$P(V\mid K)$$ 은 -3pp 하락.”

---

## 11. 베이즈 예제 — 클릭은 얼마나 “구매 의향 High”를 가리키나?
가정:
- $$P(H)=0.05$$ (High 5%)  
- $$P(K\mid H)=0.30$$, $$P(K\mid \overline{H})=0.03$$  
- $$P(K)=0.30\times 0.05+0.03\times 0.95=0.015+0.0285=0.0435$$  
사후:
$$
P(H\mid K)=\frac{0.30\times 0.05}{0.0435}\approx 0.3448
$$
**해석**: 클릭자는 High일 확률이 **34.5%**. **클릭=구매자**는 아니다.  
- 기저율이 낮아도 클릭은 유의미한 **신호 강화**를 준다(5%→35% 근처).

---

## 12. 확률적 사고로 퍼널을 **설계**하기 — 질문 체크리스트
1) **누구의 확률인가?** 전체/Opt-in/신규/재방문/세그먼트?  
2) **어떤 확률인가?** $$P(V), P(V\mid S), P(V\mid K)$$ 중 무엇?  
3) **전확률 분해**로 품질과 양을 함께 봤는가?  
   $$
   P(V)=P(V\mid K)P(K)+P(V\mid \overline{K})P(\overline{K})
   $$
4) **콜라이더 조건화**를 피했는가? (예: 클릭 세션만 필터링)  
5) **선택/생존 편향**을 통제했는가? (무작화·층화·ITT)  
6) **기저율**을 함께 보고 있는가? (베이즈 업데이트의 소재)  
7) **세그먼트 가중치**(트래픽 믹스)로 심슨 역설 가능성을 점검했는가?  
8) **무작화 단위=분석 단위** 정렬이 되었는가? (UserID 단위)  
9) **보고 문장**에 집단·조건·기준을 모두 넣었는가?

---

## 13. 실무 포맷 — 표와 문장 예시(개념용)

**퍼널 개요 표(개념 수치)**

| 항목 | A | B | 메모 |
|---|---:|---:|---|
| $$P(S)$$ (노출률) | 0.60 | 0.62 | B가 노출 약간↑ |
| $$P(K\mid S)$$ (CTR) | 0.016 | 0.020 | B가 클릭↑ |
| $$P(V\mid K)$$ (전환\|클릭) | 0.12 | 0.11 | B가 품질↓ |
| $$P(V\mid \overline{K})$$ | 0.020 | 0.020 | 동일 |
| **$$P(V)$$** | 0.0213 | 0.0216 | B가 +0.03pp |

**리포트 한 줄**  
- “**전체 기준** CVR $$P(V)$$ 은 B가 A 대비 **+0.03pp**. 증가 원인은 **CTR 상승**이며, **전환\|클릭 품질은 하락**(12%→11%). 세그먼트별로는 모바일에서 상승폭↑, 데스크톱에서 하락.”

---

## 14. 퍼널을 나무처럼 그리기 — 조건 체인의 직관
- $$P(V)=P(V\mid K,S)P(K\mid S)P(S)+P(V\mid \overline{K},S)P(\overline{K}\mid S)P(S)+\cdots$$  
- **조건 체인**을 늘릴수록 해석은 세밀해지지만, **표본 수 감소**와 **콜라이더** 위험이 커진다.  
- 원칙: 하향식으로 조건을 추가하되, **모형 단순성**과 **샘플 크기**를 항상 대조.

---

## 15. 희귀 확률과 근사 — Wald vs Wilson (예고)
- CVR이 낮고 표본이 작을수록 **정규근사(Wald CI)**는 불안정.  
- 실전에서는 **Wilson** 또는 **Agresti–Coull** CI 권장(다음 편에서 수식·예제로 상세 전개).

---

## 16. 미니 연습 — 퍼널 분해와 보고 문장 만들기

**문제 1.**  
가정: $$P(S)=0.5,\; P(K\mid S)=0.03,\; P(V\mid K)=0.10,\; P(V\mid \overline{K})=0.01$$  
1) 전체 CVR $$P(V)$$ 를 계산하라.  
2) “전체 CVR은 **클릭 품질**과 **클릭 양**의 결합 결과”임을 수식으로 보여라.  

**풀이 스케치**  
- $$P(K)=0.5\times 0.03=0.015,\; P(\overline{K})=0.985$$  
- $$P(V)=0.10\times 0.015+0.01\times 0.985=0.0015+0.00985=0.01135\;(1.135\%)$$  
- 메시지: $$P(V\mid K)$$ 와 $$P(K)$$ 가 동시에 중요.

**문제 2.**  
모바일/데스크톱으로 나누었을 때, A는 두 세그먼트 모두에서 B보다 낮지만, 전체에서는 A가 더 높은 CVR을 보였다. 어떻게 가능한가?  
- 답: 세그먼트 **가중치(분모)**의 차이로 인한 **심슨의 역설**.

**문제 3.**  
“클릭한 세션만 필터링” 후 A/B 전환률을 비교했다. 어떤 통계적 위험이 있는가?  
- 답: **콜라이더 조건화**로 인한 효과 왜곡.

---

## 17. 한 페이지 요약 (TL;DR)
- 확률은 **사건과 조건**으로 말한다: $$P(V), P(V\mid S), P(V\mid K)$$  
- 전체 전환은 **전확률 분해**:  
  $$
  P(V)=P(V\mid K)P(K)+P(V\mid \overline{K})P(\overline{K})
  $$
- **베이즈**: 관측(클릭)으로 **사전**을 업데이트해 **사후**를 얻는다:  
  $$
  P(H\mid K)\propto P(K\mid H)P(H)
  $$
- **함정**: 선택편향·생존자 편향·콜라이더 조건화·기저율 오류, 세그먼트 가중치로 인한 심슨 역설.  
- **실무 원칙**: 무작화 단위=분석 단위(사용자), ITT, 보고 문장에 **집단·조건·기준**을 필수로 포함.

---

## 수학 박스 A — 확률공간·조건부기대(사영 관점)

**정의(확률공간)**  
확률공간은 $({\Omega},\mathcal F,\mathbb P)$, 확률변수 $X$는 $(\Omega,\mathcal F)\to(\mathbb R,\mathcal B)$ 가측.  
기대는 르베그 적분:  
$$
\mathbb E[X]=\int_\Omega X(\omega)\,d\mathbb P(\omega).
$$

**정의(확률공간)**  
확률공간은 $({\Omega},\mathcal F,\mathbb P)$, 확률변수 $X$는 $(\Omega,\mathcal F)\to(\mathbb R,\mathcal B)$ 가측.  
기대는 르베그 적분:  
$$
\mathbb E[X]=\int_\Omega X(\omega)\,d\mathbb P(\omega).
$$

**$L^2$ 내적·직교사영**  
$L^2(\mathbb P)=\{X:\mathbb E[X^2]<\infty\}$, 내적 $\langle X,Y\rangle=\mathbb E[XY]$.  
$\mathcal G\subseteq\mathcal F$에 대해 **조건부기대** $\mathbb E[X\mid \mathcal G]$는  
$$
\mathbb E[X\mid \mathcal G]
=\arg\min_{Z\in L^2(\mathcal G)} \mathbb E\!\left[(X-Z)^2\right],
$$
즉 $X$를 $L^2(\mathcal G)$에 **직교사영**한 것. 결과적으로
$$
\mathbb E\!\big[X-\mathbb E(X\mid\mathcal G)\big]\cdot Z=0\quad(\forall Z\in L^2(\mathcal G)).
$$

**타워/전분산 법칙**  
$ \mathcal H\subseteq\mathcal G\subseteq \mathcal F$이면
$$
\mathbb E\big[\mathbb E(X\mid \mathcal G)\mid \mathcal H\big]=\mathbb E(X\mid \mathcal H),\qquad
\mathbb E[X]=\mathbb E\!\big[\mathbb E(X\mid Z)\big].
$$
또한
$$
\mathrm{Var}(X)=\mathbb E\!\left[\mathrm{Var}(X\mid Z)\right]+\mathrm{Var}\!\left(\mathbb E[X\mid Z]\right).
$$

**실용 요약**  
- **이산형** $Z$일 때: $\mathbb E[X\mid Z=z]=\sum_x x\,\mathbb P(X=x\mid Z=z)$ (연속형은 적분).  
- **사영 관점**은 CUPED/ANCOVA의 “예측 가능한 부분 제거→분산 감소”의 이론적 근거가 된다.