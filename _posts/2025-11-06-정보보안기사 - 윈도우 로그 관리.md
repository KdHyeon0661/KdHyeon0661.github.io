---
layout: post
title: 정보보안기사 - 윈도우 로그 관리
date: 2025-11-06 19:25:23 +0900
category: 정보보안기사
---
# SECTION 03 윈도우 서버 취약점 — 03. 로그 관리

## 위협 모델과 설계 원칙

### 위협 모델

- **로그 미수집/누락**: 감사 정책 미적용, 크기 부족으로 순환 덮어쓰기, 채널 비활성.
- **시간 불일치**: NTP 오차로 KDC/SSO/분산 탐지 실패.
- **무결성 훼손**: 공격자가 보안 로그 삭제(1102)·정책 변경(4719)·로그 서비스 중지(7036).
- **가시성 불충분**: 기본 채널만 수집(보안·시스템·응용) → 행위 단서(스크립트, WMI, 작업 스케줄러, 서비스 변경, 드라이버 로드) 놓침.
- **단일 호스트 의존**: 침해 시 호스트 로그 소거 → **중앙 수집** 없으면 복구 불가.
- **과다 이벤트**: 경보 피로(Alert fatigue), 저장비 급증 → **튜닝·우선순위** 필요.

### 설계 원칙

- **정책**: “먼저 기록” — Default Deny가 아니라 **필수 채널부터 켠다** → 튜닝.
- **중앙화**: **WEC/WEF + SIEM**으로 저장·검색·경보.
- **무결성**: ForwardedEvents·SIEM **Write Once** 보관, epl 백업, 감사(1102/4719 등) 경보.
- **상호보완**: **Event Log + Sysmon + PowerShell 로그 + 방화벽/IIS + Defender**.
- **시간동기**: **DC/NTP** 레퍼런스 고정.
- **운영성**: **XML/XPath 필터·PowerShell 자동화·GPO 배포**.

---

## Windows Event Log & 채널 개요

- **기본 채널**: `Security`, `System`, `Application`, `Setup`, `ForwardedEvents`.
- **역할 기반 채널**: `Microsoft-Windows-*`(PowerShell/TaskScheduler/WMI/WinRM/CodeIntegrity/Defender/Firewall 등).
- **ETW(Events for Windows)**: 대부분의 모듈이 Event Provider로 ETW 노출 → 필요 시 수집.

확인:
```powershell
# 설치된 로그 목록

wevtutil el | Sort-Object

# 특정 로그 속성

wevtutil gl Security
```

---

## — 골든 프로파일

> GPO 경로: **컴퓨터 구성 → Windows 설정 → 보안 설정 → 고급 감사 정책 구성 → 시스템 감사 정책**

### 우선 활성 범주(필수)

- **계정 로그온**: Kerberos(4768/4769/4771), NTLM(4776)
- **계정 관리**: 사용자/그룹 생성·변경(4720/4722/4723/4725/4726, 4727–4735)
- **로그온/로그오프**: 4624/4625/4634/4647/4672(특권)
- **개체 액세스**: 파일/레지스트리 감사(4663/4657) — *SACL 필요*
- **정책 변경**: 4719(감사 정책), 4739(도메인 정책), 4902(감사 SACL 변경)
- **권한 사용**: 4673/4674(민감 권한 호출)
- **세부 추적**: 4688(프로세스 생성), 4689(종료), 4697(서비스 설치)
- **DS 액세스/변경**: AD 환경에서 필요한 범위만

### 명령 기반 적용

```powershell
# 현재 호스트에 고급 감사 정책 일괄 적용 예 (감사 성공/실패 조합)

auditpol /set /category:"Logon/Logoff" /subcategory:"Logon" /success:enable /failure:enable
auditpol /set /subcategory:"User Account Management" /success:enable /failure:enable
auditpol /set /subcategory:"Process Creation" /success:enable
auditpol /set /subcategory:"Audit Policy Change" /success:enable /failure:enable
auditpol /get /category:*
```

> **도메인 전체**는 **GPO**로 배포, 로컬 `auditpol`은 **정책에 의해 덮어쓰기** 가능.

---

## — 탐지 일관성의 전제

- DC → 외부 신뢰원, 멤버 서버/클라이언트 → **도메인 계층 동기화**.
- 최대 오차는 Kerberos 허용 범위(기본 ±5분) 내.

```powershell
# DC에서

w32tm /query /status
w32tm /query /peers

# 타임 서비스 재구성(필요 시)

w32tm /config /syncfromflags:DOMHIER /update
```

---

## 이벤트 ID — 최소 모니터링 코어 세트

| 범주 | 핵심 이벤트 | 설명 |
|---|---|---|
| 인증/세션 | **4624/4625/4634/4647** | 성공/실패/로그오프/사용자 로그오프 |
| 특권 | **4672** | 특권이 포함된 로그온 |
| 계정 관리 | **4720, 4722, 4725, 4726, 4738** | 사용자 생성/활성/비활성/삭제/변경 |
| 그룹 변경 | **4728/4729/4732/4733** | 보안그룹 멤버 추가/제거(특히 Administrators/DA) |
| Kerberos/NTLM | **4768/4769/4771/4776** | TGT/TGS/프리인증 실패/NTLM |
| 프로세스/서비스 | **4688/4689, 4697** | 프로세스 생성/종료, 서비스 설치 |
| 정책 변경 | **4719, 4739, 4902** | 감사/도메인/객체 SACL 변경 |
| 로그 무결성 | **1102** | 보안 로그 지우기 |
| RDP/네트워크 | **4624(LogonType 10/3)** | 원격 대화형/네트워크 |
| 시스템/서비스 | **7040/7045/7036** | 시작 유형 변경/서비스 설치/상태 변경 |

---

## Get-WinEvent — 고성능 쿼리 패턴

### FilterHashtable (빠르고 간결)

```powershell
# 최근 24시간, 서비스 설치/시작 유형 변경

$since = (Get-Date).AddDays(-1)
Get-WinEvent -FilterHashtable @{LogName='System'; Id=@(7040,7045); StartTime=$since} |
  Select TimeCreated, Id, ProviderName, Message
```

### XML/XPath (정밀 필터)

```powershell
# Administrators/Domain Admins 그룹 추가(4728,4732)만 추출

$xml = @"
<QueryList>
  <Query Id="0" Path="Security">
    <Select Path="Security">
      *[System[(EventID=4728 or EventID=4732)]]
      and
      *[EventData[Data[@Name="TargetSid"] and (contains(., "S-1-5-32-544"))]]  <!-- Administrators -->
    </Select>
  </Query>
</QueryList>
"@
Get-WinEvent -FilterXml $xml | Select TimeCreated, Id, Message
```

### 대용량 내보내기

```powershell
# CSV/CLIXML/JSON (SIEM 업로드 전 간이 분석)

Get-WinEvent -FilterHashtable @{LogName='Security'; StartTime=(Get-Date).AddDays(-1)} |
  Select TimeCreated,Id,ProviderName,Message |
  Export-Csv C:\Logs\security_1d.csv -NoTypeInformation -Encoding UTF8
```

---

## WEF/WEC(Windows Event Forwarding/Collector)

### 아키텍처

- **Collector-Initiated**: 수집기가 각 원격에 접속(소규모).
- **Source-Initiated**: 각 원격이 **구독자(WEC)**에 스스로 전송(대규모, GPO 권장).
- 프로토콜: **WinRM/HTTP(5985)/HTTPS(5986)**. 도메인 Kerberos 권장.

### 컬렉터 준비

```powershell
# WEC 초기화(필수 서비스/방화벽 규칙 구성)

wecutil qc
# WinRM 준비 상태 확인

winrm quickconfig
```

### 구독 생성(예: Source-Initiated)

1) 컬렉터 **Event Viewer → Subscriptions → Create Subscription**
2) **Collector initiated**가 아니라 **Source computer initiated** 선택
3) **컴퓨터 그룹**: GPO의 `Computer Configuration → Policies → Administrative Templates → Windows Components → Event Forwarding → Configure target Subscription Manager`로 전달
```powershell
# GPO 내 클라이언트에 수집기 URL 지정 (예시 문자열)

Server=http://wec.contoso.com:5985/wsman/SubscriptionManager/WEC,Refresh=900
```
4) **쿼리**: Security/7045/7040/4697/1102/4719 등 핵심 이벤트 포함 XML
5) **Delivery Optimization**: Minimize Latency(경보) 또는 Minimize Bandwidth(대량 수집)

### 구독 XML 예시(핵심 이벤트)

```xml
<QueryList>
  <Query Id="0" Path="Security">
    <Select>*[System[(EventID=1102) or (EventID=4697) or (EventID=4719) or
                      (EventID=4720) or (EventID=4728) or (EventID=4732) or
                      (EventID=4768) or (EventID=4769) or (EventID=4771) or
                      (EventID=4624) or (EventID=4625) or (EventID=4672)]]</Select>
  </Query>
  <Query Id="1" Path="System">
    <Select>*[System[(EventID=7040) or (EventID=7045) or (EventID=7036)]]</Select>
  </Query>
  <Query Id="2" Path="Microsoft-Windows-PowerShell/Operational">
    <Select>*[System[(EventID=4103) or (EventID=4104)]]</Select>
  </Query>
  <Query Id="3" Path="Microsoft-Windows-Sysmon/Operational">
    <Select>*</Select>
  </Query>
</QueryList>
```

### ForwardedEvents 검증

```powershell
Get-WinEvent -LogName ForwardedEvents -MaxEvents 5 | Format-List TimeCreated, ProviderName, Id
```

---

## PowerShell 로깅 강화(스クリپ트/모듈/전사)

- **Script Block Logging**: 4104 — 전체 스크립트 콘텐츠(난독 해제 후 일부).
- **Module Logging**: 4103 — 모듈 수준 명령 호출.
- **Transcription**: 전체 콘솔 I/O를 파일로.

GPO 경로:
- **관리 템플릿 → Windows 컴포넌트 → Windows PowerShell**
  - 스크립트 블록 로깅 사용 / 모듈 로깅 사용 / 전사 사용 및 출력 경로

레지스트리(수동):
```powershell
New-Item -Path HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging -Force | Out-Null
New-ItemProperty -Path HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging -Name EnableScriptBlockLogging -Value 1 -Type DWord -Force
New-Item -Path HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging -Force | Out-Null
New-ItemProperty -Path HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging -Name EnableModuleLogging -Value 1 -Type DWord -Force
```

---

## Defender/방화벽/AppLocker/Code Integrity 로그

### Defender

- 로그 채널: `Microsoft-Windows-Windows Defender/Operational`
- 경보 이벤트: 탐지/차단/격리/엔진 업데이트 실패 등.

```powershell
Get-WinEvent -LogName 'Microsoft-Windows-Windows Defender/Operational' -MaxEvents 10 |
  Select TimeCreated, Id, Message
```

### Windows 방화벽

- 채널: `Microsoft-Windows-Windows Firewall With Advanced Security/Firewall`
- 파일 로그: `pfirewall.log`(드롭/허용 기록 — 프로파일별 설정 필요)
```cmd
netsh advfirewall set allprofiles logging droppedconnections enable
netsh advfirewall set allprofiles logging filename "C:\Windows\System32\LogFiles\Firewall\pfirewall.log"
```

### AppLocker/CI(코드 무결성)

- 채널: `Microsoft-Windows-AppLocker/*`, `Microsoft-Windows-CodeIntegrity/Operational`
- **감사 모드**로 먼저 학습 후 차단 모드 전환.

---

## IIS/웹 로그 & LogParser 예시

IIS 로그 필드 확장(소스 IP, 유저 에이전트, URI, 상태 코드 등) → `%SystemDrive%\inetpub\logs\LogFiles\W3SVC*`.

LogParser(SQL 스타일):
```cmd
LogParser "SELECT TOP 20 c-ip, cs-uri-stem, sc-status, COUNT(*) AS hits
           FROM C:\inetpub\logs\LogFiles\W3SVC1\u_ex*.log
           WHERE sc-status IN (404,500,503)
           GROUP BY c-ip, cs-uri-stem, sc-status
           ORDER BY hits DESC" -rtp:-1
```

---

## Sysmon 연계(강력 권장)

설치:
```cmd
# Sysmon v13+ 기준

sysmon64.exe -accepteula -i sysmon-config.xml
```

최소 규칙 예(개념):
```xml
<Sysmon schemaversion="4.82">
  <EventFiltering>
    <ProcessCreate onmatch="include">
      <Image condition="end with">.exe</Image>
    </ProcessCreate>
    <NetworkConnect onmatch="exclude">
      <DestinationPort name="well-known" condition="is">53</DestinationPort>
    </NetworkConnect>
    <FileCreate onmatch="include">
      <TargetFilename condition="contains">\Temp\</TargetFilename>
    </FileCreate>
  </EventFiltering>
</Sysmon>
```

PowerShell:
```powershell
# Sysmon 확인

Get-WinEvent -LogName 'Microsoft-Windows-Sysmon/Operational' -MaxEvents 5 |
  Select TimeCreated, Id, Message
```

---

## 용량 산정·보관·백업·무결성

### 용량 산정(근사)

이벤트 발생률(EPS), 평균 이벤트 크기 \(S\) 바이트, 보관 일수 \(D\)일, 여유율 \(k\).

$$
\text{용량(바이트)} \approx \text{EPS} \times S \times 86400 \times D \times k
$$

예: EPS=5, S=1500, D=30, \(k=1.3\) → \(5 \times 1500 \times 86400 \times 30 \times 1.3 \approx 25.3\ \text{GB}\)

### 로그 크기/보존 정책

```powershell
# 보안 로그 최대 크기 1GB, 자동 덮어쓰기(운영 상황에 맞게)

wevtutil sl Security /ms:1073741824
# 채널 설정 확인

wevtutil gl Security
```
- **ForwardedEvents**(수집기)는 **대형** 설정(수십 GB) + **SIEM로 즉시 전송**.
- **보안 로그 삭제(1102) 경보** + epl 백업 자동화.

### & 해시

```powershell
$ts = Get-Date -Format 'yyyyMMdd_HHmmss'
$dst = "D:\EvtBackup\Security_$ts.evtx"
wevtutil epl Security $dst
Get-FileHash $dst -Algorithm SHA256 | Out-File "$dst.sha256.txt" -Encoding ascii
```

### CrashOnAuditFail(선별)

- 감사 실패 시 시스템 중지(고가용성 환경은 신중하게)
```powershell
New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa' -Name 'CrashOnAuditFail' -Type DWord -Value 1
```

---

## 설정

- 목표: **중요 디렉터리/키** 변경 시 4663/4657 이벤트 생성.
```powershell
# 파일/폴더 SACL: 고급 보안에서 '감사' 또는 PowerShell로 (icacls는 SACL 직접X)
# 예시는 'AuditPol' + GUI를 병행 권장. 레지스트리는 AuditPol로 하위 정책 켜고, SACL은 regedt32 고급 보안에서 설정.

auditpol /set /subcategory:"File System" /success:enable /failure:enable
auditpol /set /subcategory:"Registry" /success:enable /failure:enable
```
> **대상**: `C:\Windows\System32`, `C:\Program Files\<App>`, `HKLM\SYSTEM\CCS\Services`, `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run*` 등.

---

## 탐지 플레이북 — 예제 쿼리 모음

### 로컬/도메인 관리자 그룹 변경 탐지

```powershell
# 멤버 추가/제거(4732/4733)

$since=(Get-Date).AddDays(-1)
Get-WinEvent -FilterHashtable @{LogName='Security'; Id=@(4732,4733); StartTime=$since} |
  Where-Object { $_.Message -match 'Administrators' } |
  Select TimeCreated, Id, Message
```

### 신규 서비스 설치 & 시작유형 변경

```powershell
Get-WinEvent -FilterHashtable @{LogName='System'; Id=@(7045,7040); StartTime=$since} |
  Select TimeCreated, Id, Message
```

### 보안 로그 삭제/감사 정책 변경

```powershell
Get-WinEvent -FilterHashtable @{LogName='Security'; Id=@(1102,4719); StartTime=$since} |
  Select TimeCreated, Id, Message
```

### Kerberos 비정상(비밀번호 추측/오타 반복)

```powershell
Get-WinEvent -FilterHashtable @{LogName='Security'; Id=4771; StartTime=$since} |
  Group-Object {$_.Properties[0].Value} | Sort-Object Count -Descending |
  Select-Object Count, Name
```

### RDP 원격 대화형 로그인

```powershell
# LogonType=10

Get-WinEvent -FilterHashtable @{LogName='Security'; Id=4624; StartTime=$since} |
  Where-Object { $_.Message -match 'Logon Type:\s+10' } |
  Select TimeCreated, Message
```

---

## SIEM로 보내기 — Winlogbeat/Fluent Bit 예시(개념)

### Winlogbeat(개략)

```yaml
winlogbeat.event_logs:
  - name: Security
    ignore_older: 72h
  - name: System
  - name: Microsoft-Windows-PowerShell/Operational
  - name: Microsoft-Windows-Sysmon/Operational

output.elasticsearch:
  hosts: ["https://es.example.local:9200"]
  username: "beats"
  password: "********"
  ssl.verification_mode: "full"
```

### Fluent Bit(Windows)

```ini
[INPUT]
    Name              winlog
    Channels          Security, System, Microsoft-Windows-PowerShell/Operational

[OUTPUT]
    Name              es
    Match             *
    Host              es.example.local
    Port              9200
    HTTP_User         fluent
    HTTP_Passwd       ********
    tls               On
```

> **포인트**: **TLS**, 인증, **전송 재시도/버퍼**, **필드 정규화**(host, channel, event_id, user, logon_type, src_ip 등).

---

## 운영 체크리스트(요약)

- [ ] **NTP** 동기화 일관(DC 기준).
- [ ] **Advanced Audit Policy**: 상기 **핵심 범주** 성공/실패 설정.
- [ ] **PowerShell ScriptBlock/Module/Transcription**(감사 모드→정착).
- [ ] **Defender/Firewall/AppLocker/CI** 채널 활성·수집.
- [ ] **WEF Source-Initiated** + **Collector 다중화** + **TLS/인증**.
- [ ] **ForwardedEvents 대용량** + **SIEM 실시간 전송**.
- [ ] **Security/ForwardedEvents 크기** 상향, 순환 덮어쓰기 정책/경보.
- [ ] **보안 로그 삭제(1102)·감사정책변경(4719)** 실시간 경보.
- [ ] **서비스 설치(7045)/시작 유형 변경(7040)/4697** 실시간 경보.
- [ ] **SACL**: 핵심 경로 파일/레지스트리 개체 액세스 감사.
- [ ] **epl 백업 + 해시** 정기화, 장기보관(WORM/Immutable).
- [ ] **Sysmon** 배포/튜닝, 충돌 없는 룰 관리.
- [ ] **테스트/파일럿 → 전사 배포**, 변경관리·문서화.

---

## 미니 랩

### 랩 A — “핵심 이벤트 수집 & 경보”

1) GPO로 Advanced Audit 핵심 범주 배포.
2) 컬렉터에서 구독(XML) 작성, Source-Initiated 구성.
3) ForwardedEvents에서 7045/4719/1102 트리거 시 Slack/메일 알림(간단 스크립트).

```powershell
# ForwardedEvents 실시간 감시(간단 예)

$ids = @(7045,4719,1102)
Register-ObjectEvent -InputObject (New-WinEvent -LogName ForwardedEvents) -EventName EventRecordWritten -Action {
  $rec = $Event.SourceEventArgs.EventRecord
  if ($rec.Id -in $using:ids) {
    $msg = "[ALERT] $($rec.TimeCreated) ID=$($rec.Id) $($rec.FormatDescription())"
    # 메일/웹훅 등 통보
    Write-Host $msg
  }
}
```

### 랩 B — “PowerShell 로깅”

1) GPO로 ScriptBlock/Module 로그 활성.
2) 테스트 스크립트 실행 → 4103/4104 수집 확인.
3) SIEM에서 `EncodedCommand`, `DownloadString`, `IEX` 키워드 탐지 규칙 작성.

### 랩 C — “Sysmon + 서비스 변경 탐지”

1) Sysmon 최소 규칙 배포.
2) 의도적 서비스 설치/시작유형 변경 → 7045/7040 + Sysmon ID 1(프로세스) 상관분석.

---

## 실무 시나리오

### 시나리오 1 — 보안 로그 삭제(1102)

- 징후: 1102 발생 직전 7045/4697와 4688(cmd/powershell).
- 대응: ForwardedEvents/SIEM 사본으로 복원, 1102 **고위험 경보**, 계정 잠금, 메모리/디스크 포렌식.

### 시나리오 2 — DA 그룹 비정상 추가(4728/4732)

- 징후: 짧은 시간 내 4728/4732 + 4769 TGS 요청 급증.
- 대응: 변경 계정 일시 비활성, 최근 로그인 소스(4624), PIM/승인 흐름 재검토.

### 시나리오 3 — RDP 무차별 시도(4625 Type10)

- 징후: 동일 소스 IP에서 4625 Type10 연속.
- 대응: 해당 IP 차단(방화벽), 계정 잠금 임계치 확인, MFA/NLA/RCG 재점검.

---

## 예상문제(필기/실무)

1) **Advanced Audit Policy**에서 “프로세스 생성(4688)”을 활성화하려면 어떤 범주/하위 범주를 설정해야 하는가?
2) **WEF Source-Initiated** 구성 단계와 GPO 설정 키 포인트를 기술하라.
3) 보안 로그 **삭제(1102)**, **감사 정책 변경(4719)**, **서비스 설치(7045)**가 연속 발생 시 **RCA(근본원인분석)** 절차를 서술하라.
4) **PowerShell Script Block(4104)**과 **Module Logging(4103)**의 차이를 설명하고, 악성 스크립트 탐지 키워드 3가지를 예시하라.
5) **Sysmon**을 도입하는 목적과 Windows 기본 로그로는 놓칠 수 있는 2가지를 서술하라.
6) 로그 용량 산정식과 예시 값을 이용해 **30일 보관**에 필요한 대략적 디스크 용량을 계산하라.
7) **SACL**과 **DACL**의 차이, 그리고 파일/레지스트리 감사 이벤트(4663/4657) 발생 조건을 설명하라.

---

## 결론

- 윈도우 로그 관리의 핵심은 **정책→수집→보관→탐지→무결성→자동화**의 **전주기 설계**다.
- 본 문서 템플릿(감사 정책 세트, WEF 구독 XML, Get-WinEvent 쿼리, Sysmon 연계, epl 백업/해시, 체크리스트)을 **GPO·스크립트·IaC**로 표준화하면, **침해 흔적 은폐·로그 누락·시간 불일치**로 인한 탐지 실패를 크게 줄일 수 있다.
- 다음 작업: 환경별 **이벤트 기준선** 수립(EPS·Top N 이벤트), **SIEM 룰 튜닝**(오탐·중복 제거), **대응 런북**과 연계한 **자동 알림/차단**으로 운영 완성도를 높인다.
