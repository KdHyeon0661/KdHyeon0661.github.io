---
layout: post
title: 확률과 통계 - 로지스틱·포아송 회귀
date: 2025-09-20 17:25:23 +0900
category: 확률과 통계
---
# 13) 로지스틱·포아송 회귀 ― 비율·카운트의 정석

> **목표**  
> - **로지스틱 회귀(Binomial GLM)**: 전환(0/1)·D1(0/1) 같은 **비율** 모델링, **오즈비(OR)**·**한계효과(AME)** 해석, **가중(집계형)**, **클러스터-강건 표준오차**.  
> - **포아송 회귀(Poisson/NB GLM)**: 클릭/오류/이벤트 **카운트**와 **율(rate)**, **오프셋**(log 노출/시간), **과산포**(Quasi-Poisson·Negative Binomial), **제로 인플레**(ZIP/ZINB).  
> - **공통 실무**: 설계→추정→진단(잔차·분산·캘리브레이션)→보고(AIC/BIC, deviance ANOVA, CI/IRR/OR)까지 **끝장 정리**.  
> - **함정**: **OR vs RR**, **분모·노출 혼동**, **완전 분리(separation)**, **희귀사건·과산포**, **랜덤화 단위**와 **클러스터 SE**.

---

## 0) Hook — “비율은 로지스틱, 카운트는 포아송. 그리고 ‘노출’은 오프셋”
- **CVR·D1**은 **0/1**(또는 집계 비율) → **로지스틱**으로 **확률**을 직접 모델.  
- **클릭수·오류수**는 **카운트** → **포아송/음이항**으로 **율(단위 시간/노출당)**을 모델.  
- “**분모**(노출/시간)가 다르다”면 **오프셋**에 넣는다:  
  - 클릭율: $$\log \lambda = X\beta + \log(\text{impressions})\ \Rightarrow\ \text{IRR}$$  
  - 오류율: $$\log \lambda = X\beta + \log(\text{runtime})$$

---

## 1) 로지스틱 회귀 (Binomial GLM)

### 1.1 모형과 링크
- 데이터: 사용자(또는 집계 단위) $$i=1,\dots,n$$, 결과 $$Y_i\in\{0,1\}$$.  
- 확률: $$p_i=\Pr(Y_i=1\mid X_i)$$  
- **로지스틱(로그오즈) 링크**:
$$
\operatorname{logit}(p_i)\ =\ \log\frac{p_i}{1-p_i}\ =\ X_i^\top \beta.
$$
- 역링크: $$p_i=\frac{1}{1+\exp(-X_i^\top \beta)}.$$

### 1.2 계수 해석(핵심)
- $$\beta_j$$는 **오즈(odds)**의 로그 변화 → **오즈비**:
$$
\text{OR}_j=\exp(\beta_j)\quad(\text{X}_j\text{ 1단위↑ 시 오즈가 }\text{OR}_j\text{배}).
$$
- **확률 변화**는 **한계효과**로 보고(§1.5).  
- **범주형**: 변형(variant B=1)의 $$\exp(\beta_\text{B})$$ = **B/A 오즈비**.

### 1.3 예시(단순 A/B)
- A/B 실험, 사용자 단위: `converted ~ variant`  
  - 추정: $$\widehat{\beta}_\text{B}=0.095$$ ⇒ **OR = e^{0.095} ≈ 1.10**  
  - 해석: B의 **오즈**가 A 대비 **10%↑**. (확률 차이는 p 수준에 따라 다름)

### 1.4 집계형(트라이얼-성공)
- 집계 단위(예: 일×버전)에서 **성공 x / 시도 n**:  
  $$ (x_i, n_i)\ \Rightarrow\ \text{glm}(\text{cbind}(x_i, n_i-x_i)\sim X,\ \text{family=Binomial}).$$
- **가중**(weights) 또는 `freq_weights=n_i`로 구현 → **각 행의 정보량 반영**.

### 1.5 한계효과(Marginal Effects)
- **AME**(Average Marginal Effect):  
  $$ \text{AME}_j=\frac{1}{n}\sum_{i}\frac{\partial p_i}{\partial x_{ij}}=\frac{1}{n}\sum_i p_i(1-p_i)\,\beta_j. $$
- **MEM**(at means): $$p(\bar X)(1-p(\bar X))\beta_j$$.  
- 리포팅: “변형 B가 **확률**을 **+0.32pp**(AME) 변화(95% CI …)”.

### 1.6 진단과 적합도
- **Deviance**: $$D=2(\ell_\text{saturated}-\ell_\text{model})$$, 작을수록 적합↑.  
- **우도비 검정(LRT)**: 중첩 모형 비교(예: `+ variant` 추가의 유의성).  
- **Pseudo R²**(McFadden): $$1-\frac{\ell_\text{model}}{\ell_0}$$ (참고용).  
- **캘리브레이션**: reliability curve, **Brier score**, **log loss**.  
- **분류지표**(AUC, 정밀·재현율)는 예측용, **추론**엔 deviance/LRT가 표준.

### 1.7 강건성: 분산·클러스터·희귀/분리
- **클러스터-강건 SE**(사용자/세션 군집): 동일 사용자 반복 관측 시 표준오차 과소를 교정.  
- **희귀사건**(매우 낮은 p): **표준 로지스틱의 편향** 가능 → **Firth**(정칙화) 또는 **가중/언더샘플링 + 보정**.  
- **완전 분리**(어떤 공변량 조합에서 결과가 항상 0/1): **MLE 발산** → **L2·Firth**로 해결.

### 1.8 링크 선택(참고)
- **logit**(표준), **probit**(정규 잠재변수), **cloglog**(극값 위험). 실무는 **logit**을 우선.

---

## 2) 포아송 회귀 (Poisson GLM) — 카운트 & 율(rate)

### 2.1 모형과 링크
- 카운트 $$Y_i\in\{0,1,2,\dots\}$$, 기대값 $$\mu_i=E[Y_i\mid X_i]$$.  
- **로그 링크**:
$$
\log \mu_i\ =\ X_i^\top \beta \quad\Rightarrow\ \mu_i=\exp(X_i^\top \beta).
$$
- **율(rate)** 모델: **오프셋** $$\log(\text{exposure}_i)$$ 추가
$$
\log \mu_i= X_i^\top \beta + \log(\text{exposure}_i)\ \ \Rightarrow\ \ \log \frac{\mu_i}{\text{exposure}_i}=X_i^\top \beta.
$$

### 2.2 계수 해석: IRR
- $$\exp(\beta_j)$$ = **IRR**(Incidence Rate Ratio): X_j 1단위↑ 시 **율이 몇 배**.  
- 예: `clicks ~ variant + offset(log(impr))`에서 $$\exp(\beta_\text{B})=1.06$$ → B가 **클릭율 6%↑**.

### 2.3 과산포(Overdispersion)
- 포아송은 $$\mathrm{Var}(Y)=\mu$$. 현실은 $$\mathrm{Var}(Y)>\mu$$(과산포) 흔함.  
- 대안:
  - **Quasi-Poisson**: 분산 $$\phi\mu$$, **SE만 확대**.  
  - **Negative Binomial(NB2)**: $$\mathrm{Var}(Y)=\mu+\alpha\mu^2$$, **모수 $\alpha$ 추정**.  
  - **제로 인플레**(ZIP/ZINB): 0 과다일 때 **혼합**.

### 2.4 진단
- **피어슨 잔차**·**디비언스 잔차**의 분산/패턴.  
- **분산 지수** $$\hat \phi \approx \frac{\sum r_i^2}{n-p}$$ (1보다 크면 과산포 의심).  
- **루트-포아송 변환** 시각화(참고용).

---

## 3) 로지스틱 vs 포아송 — 언제 무엇을?

| 상황 | 종속 | 분모/노출 | 추천 |
|---|---|---|---|
| 전환(0/1) | 개별 사용자 | 없음 | **로지스틱** |
| 집계 전환 비율 | 성공 x / 시도 n | n | **집계형 로지스틱**(binomial, weights=n) |
| 클릭수 | 클릭 카운트 | **노출수** | **포아송 + offset(log 노출)** (또는 NB) |
| 오류수 | 오류 카운트 | **실행시간** | **포아송 + offset(log 시간)** |
| 희귀 비율(매우 작음) | 비율 | 노출 큼, p≪1 | 포아송(율) 근사도 유효(해석은 IRR) |

> **주의(OR vs RR)**: 로지스틱의 **OR**은 **RR**과 다르다. p가 **작을수록** OR ≈ RR. 큰 p에서 OR은 **효과를 과장**. RR이 필요하면 **로그-바이너리** 또는 **포아송+강건SE**로 RR 근사.

---

## 4) 공통 절차: 설계 → 추정 → 검정 → 진단 → 보고

### 4.1 설계
- **랜덤화 단위=분석 단위**(사용자/클러스터) 일치.  
- **오프셋**(분모/노출/시간) 명확화.  
- **세그먼트/공변량** 사전등록(모바일/국가/신규 등).  
- **기간/샘플수** 및 **정지 규칙**(연속 모니터링 규칙) 정의.

### 4.2 추정
- GLM 적합: **Wald z**, **LR(Deviance) test**, **Type II/III**(중첩·요인).  
- **강건 SE(HC3)** 또는 **클러스터-강건 SE**(user_id)로 보고.

### 4.3 검정·효과크기
- 로지스틱: **OR**, **AME**, **∆p@baseline**.  
- 포아송/NB: **IRR**(율배수), 필요시 **절대율 차**는 기준율과 함께.

### 4.4 진단
- **잔차 그래프**(적합값 vs 잔차), **캘리브레이션**(로지스틱), **과산포 지수**(포아송).  
- **영향점**(Cook’s distance), **다중공선성**(VIF) 점검.

### 4.5 보고
- 모형식/링크/오프셋 명시, **추정치+95% CI**, **Deviance/AIC/BIC**.  
- **효과크기 표준문장**(OR/IRR/AME), **해석 범위**(ceteris paribus), **한계**(과산포·분리 등).

---

## 5) 예시 1 — 로지스틱: CVR ~ variant + device + sessions + (variant×new_user)

### 5.1 모형
$$
\operatorname{logit}(p_i) = \beta_0 + \beta_1\,\text{B}_i + \beta_2\,\text{mobile}_i
+ \beta_3\,\text{sessions}_i^\star + \beta_4\,\text{new}_i + \beta_5\,(\text{B}_i\cdot \text{new}_i).
$$
- **센터링** $$\text{sessions}^\star=s-\bar s$$.  
- **상호작용** $$\beta_5$$: 신규 유저에서 변형 B의 **추가 효과**.

### 5.2 해석(가상의 수치)
- $$\hat\beta_1=0.08\Rightarrow \text{OR}=1.083$$ (전체 기준 B의 오즈 8.3%↑)  
- $$\hat\beta_5=0.12\Rightarrow \text{OR}=1.127$$ (신규유저에서 **추가로** 오즈 12.7%↑)  
- **AME**(B): **+0.28pp** (95% CI +0.10~+0.46pp)  
- **LRT**(상호작용): $$\chi^2(1)=7.4, p=0.006$$ → **유의**

### 5.3 실무 문장
> “로지스틱 회귀(사용자 단위), 변형 B의 **OR=1.08 [1.03, 1.13]**, **AME=+0.28pp**. 신규 유저에서 **추가 상승**(상호작용 OR=1.13). HC3-강건 SE, deviance 감소 유의(LRT p=0.006).”

---

## 6) 예시 2 — 포아송: 클릭수 ~ variant + (오프셋=log 노출)

### 6.1 모형
$$
\log E[\text{clicks}_i] = \beta_0 + \beta_1\,\text{B}_i + \log(\text{impr}_i).
$$
- 해석: $$\exp(\beta_1)=\text{IRR}$$ = **클릭율 배수**.

### 6.2 가상 결과
- $$\hat\beta_1 = 0.058 \Rightarrow \text{IRR}=1.06\ [1.03, 1.09]$$  
- **과산포 지수** $$\hat\phi=1.9$$ → Quasi-Poisson 또는 NB 권장.  
- NB로 재적합 시 **IRR** 유사, **SE↑** → CI 약간 확장.

### 6.3 실무 문장
> “포아송 GLM(오프셋=log 노출), 변형 B의 **IRR=1.06 [1.03, 1.09]**. 과산포(ϕ≈1.9) 관찰 → **NB 대안**에서도 결론 유지.”

---

## 7) deviance ANOVA & 사후(요인 다수)

- **중첩 모형 비교**:  
  - 로지스틱/포아송 모두 **Deviance** 차로 **LR test** 수행.  
  - 예: `~ variant + device` vs `~ variant + device + weekday`의 **추가 설명력** 검정.  
- **요인·수준 다수**(예: 요일 7수준): **EMMeans(LSMeans)**로 대비, **FDR 보정** 병행.  
- 비율/카운트에서 “ANOVA 느낌”을 GLM의 **deviance 분해**로 읽는다.

---

## 8) 캘리브레이션 & 예측 품질(로지스틱)

- **Calibration plot**: 예측확률 bin vs 실제 비율.  
- **Brier score**: $$\frac{1}{n}\sum (y_i-\hat p_i)^2$$, 낮을수록 좋음.  
- **Log loss**: $$-\sum [y_i\log \hat p_i + (1-y_i)\log(1-\hat p_i)]$$.  
- **Recalibration** 필요 시 **Platt/Isotonic** 고려(예측용).  
- **추론용** 보고는 **OR/AME + CI** 중심.

---

## 9) 흔한 함정과 처방

1) **OR를 %p 차이로 오해**  
   - OR은 **오즈 배수**. **AME** 또는 기준 p에서 **∆p**도 함께 보고.  
2) **분모 누락**  
   - 율 모델에 **오프셋** 누락 시 편향. (클릭율→log(impr), 오류율→log(time))  
3) **완전 분리**  
   - 정규화(L2) 또는 **Firth**(bias reduction) 사용.  
4) **과산포 무시**  
   - 포아송에서 **ϕ>1**이면 **Quasi-Poisson** 또는 **NB**.  
5) **희귀사건 비율 회귀**  
   - **Poisson+강건SE**로 **RR** 근사 가능(로그-바이너리 수렴 이슈 회피).  
6) **클러스터링 무시**  
   - 사용자/세션 중첩 → **클러스터-강건 SE** 또는 **GEE/혼합모형**.  
7) **데이터 누수/시간 종속**  
   - 시간 분할 검증, 사용자-시간 **블록**.  
8) **스케일·센터링 부재**(상호작용)  
   - 센터링으로 **해석/수치안정** 개선, VIF↓.

---

## 10) Python 개념 코드 (statsmodels)

> 실무에선 **검증된 라이브러리** 사용. 아래는 **핵심 패턴**만 정리.

```python
# pip install statsmodels patsy numpy pandas scikit-learn
import numpy as np, pandas as pd, statsmodels.api as sm, statsmodels.formula.api as smf

# df: user-level, columns = ['converted','variant','device','sessions','new_user','clicks','impr','errors','runtime','user_id']

# (1) 로지스틱 (Binomial)
df = df.dropna().copy()
df['sessions_c'] = df['sessions'] - df['sessions'].mean()
logit = smf.glm(
    'converted ~ C(variant) + C(device) + sessions_c + new_user + C(variant):new_user',
    data=df, family=sm.families.Binomial()
).fit(cov_type='cluster', cov_kwds={'groups': df['user_id']})  # 클러스터-강건 SE
print(logit.summary())

# AME (Average Marginal Effect)
margeff = logit.get_margeff(at='overall', method='dydx')  # 각 변수 한계효과
print(margeff.summary())

# (2) 포아송 + offset(log 노출)
df['log_impr'] = np.log(df['impr'].clip(lower=1))
pois = smf.glm(
    'clicks ~ C(variant) + C(device)',
    data=df, family=sm.families.Poisson(), offset=df['log_impr']
).fit(cov_type='HC3')
print(pois.summary())  # IRR = exp(coef)

# 과산포 진단 → NB 대안
import statsmodels.api as smapi
nb = smf.glm(
    'clicks ~ C(variant) + C(device)',
    data=df, family=smapi.families.NegativeBinomial(alpha=1.0), offset=df['log_impr']
).fit()
print(nb.summary())

# (3) 집계형 로지스틱 (x/n)
# df_day: columns = ['success','trials','variant','weekday', ...]
logit_agg = smf.glm(
    'success/trials ~ C(variant) + C(weekday)',
    data=df_day, family=sm.families.Binomial(), freq_weights=df_day['trials']
).fit()
print(logit_agg.summary())

# (4) Deviance ANOVA (중첩 모형 비교)
m0 = smf.glm('converted ~ C(device) + sessions_c', data=df, family=sm.families.Binomial()).fit()
m1 = smf.glm('converted ~ C(device) + sessions_c + C(variant)', data=df, family=sm.families.Binomial()).fit()
lr_stat = 2*(m1.llf - m0.llf)
df_diff = m1.df_model - m0.df_model
# p-value: 1 - chi2.cdf(lr_stat, df_diff)  (scipy 사용 권장)
```

---

## 11) 수학 부록: 우도·deviance·표준오차

### 11.1 이항(로지스틱)
- 우도: $$L(\beta)=\prod_i p_i^{y_i}(1-p_i)^{1-y_i},\ \ p_i=\sigma(X_i^\top\beta).$$  
- 로그우도: $$\ell(\beta)=\sum_i [y_i\log p_i+(1-y_i)\log(1-p_i)].$$  
- 뉴턴-랩슨(IRLS): 가중선형화로 최적화.  
- 표준오차: $$\mathrm{Var}(\hat\beta)\approx (X^\top W X)^{-1}$$, $$W=\operatorname{diag}(p_i(1-p_i)).$$

### 11.2 포아송
- 로그우도: $$\ell(\beta)=\sum_i [y_i X_i^\top\beta - \exp(X_i^\top\beta) - \log(y_i!)].$$  
- 분산-평균 동일 가정(과산포 시 왜곡) → **Quasi/NB**로 교정.  
- NB2 분산: $$\mathrm{Var}(Y)=\mu + \alpha \mu^2$$, $$\alpha>0$$.

### 11.3 deviance
- 로지스틱: $$D=2\sum_i \Big[y_i\log\frac{y_i}{\hat p_i}+(1-y_i)\log\frac{1-y_i}{1-\hat p_i}\Big].$$  
- 포아송: $$D=2\sum_i \Big[y_i\log\frac{y_i}{\hat\mu_i}-(y_i-\hat\mu_i)\Big].$$  
- **LR test**: $$D_0-D_1 \sim \chi^2_{df}$$ (중첩, 큰 n).

---

## 12) 체크리스트(실무용)

1) **링크/오프셋**이 문제에 맞는가? (비율=logit, 카운트율=log+offset)  
2) **랜덤화 단위=분석 단위** 일치? (사용자/클러스터)  
3) **집계형**이라면 **freq_weights**로 **n 반영**했는가?  
4) **과산포** 확인? (포아송 ϕ, 필요 시 Quasi/NB)  
5) **완전분리/희귀사건** 대응? (L2/Firth, robust RR)  
6) **한계효과/OR/IRR** 모두 보고? (해석 투명성)  
7) **잔차·영향점·캘리브레이션** 점검?  
8) **AIC/BIC, deviance**, LRT/Type II/III 제시?  
9) **다중비교**(요일·세그먼트)엔 **FDR**?  
10) **문장 템플릿**: “링크/오프셋·효과크기·CI·진단결과·한계”.

---

## 13) 리포팅 템플릿(예)

> **모형**: 로지스틱(사용자 단위), `converted ~ variant + device + sessions_c + new_user + variant:new_user`.  
> **추정**: B의 OR=**1.08 [1.03, 1.13]**, AME=**+0.28pp [ +0.10, +0.46 ]**. 상호작용 OR=**1.13**(신규유저에서 추가 상승).  
> **적합/검정**: deviance 감소 유의(LRT p=0.006), AIC 12,384 → 12,310. HC3-강건 SE.  
> **해석**: 변형 B가 **전체 CVR 소폭 개선**, 특히 **신규 유저**에서 효과 큼.  
> **한계**: 일부 디바이스 조합에서 관측 적음(희귀사건), 민감도 분석에서 동일 결론.

> **모형**: NB(오프셋=log 노출), `clicks ~ variant + device`.  
> **추정**: IRR(B)=**1.06 [1.03, 1.09]**. NB-α=0.42(과산포 존재).  
> **해석**: 변형 B는 **클릭율 6% 상승**. 주요 디바이스에서 일관.  
> **진단**: 피어슨 잔차 분산≈1.1, 영향점 제거 민감도 동일.

---

## 14) 확장 주제(간단 메모)
- **GEE**: 군집 상관 구조(사용자 반복·세션)를 직접 모델(작업상관 AR(1)/교환가능).  
- **혼합모형(GLMM)**: 랜덤 절편/기울기(팀·캠페인 수준) 포함.  
- **로그-바이너리**: RR 직접 모델(수렴 문제 시 Poisson+robust로 대체).  
- **제로 인플레**: 구조적 0/표본 0 분리(사용자 비활성 대다수 상황).  
- **부분 효과(AME) 시각화**: PDP/ICE(예측용), 추론 보고는 CI 중심.

---

## 15) 연습문제(정답 스케치)

1) **OR→∆p 변환**: 기준 p₀=0.03, OR=1.10이면 B의 확률은?  
   - 해: 오즈 p₀/(1−p₀)=0.0309, ×1.10=0.0340 → p≈0.0329 ⇒ **+0.29pp**.  
2) **오프셋**: 일×캠페인 클릭율(클릭/노출). 왜 log(노출)를 오프셋?  
   - 해: **율 모델**(클릭/노출)의 로그율을 선형화하기 위해.  
3) **과산포 판단**: 포아송에서 피어슨 잔차 제곱합/(n−p)=2.3 → 조치?  
   - 해: Quasi-Poisson 또는 NB로 **SE/분산 구조** 보정.  
4) **완전 분리**: 어떤 세그먼트에서 변형 B가 100% 전환. 대안?  
   - 해: **Firth** 로지스틱 또는 **L2** 페널티.  
5) **집계형 로지스틱**: (x_i, n_i) 데이터를 ‘성공률’만 회귀하면?  
   - 해: **가중치(n_i)** 없으면 정보량 왜곡(큰 n과 작은 n 동일 취급).

---

## 16) TL;DR
- **로지스틱**: 0/1·비율(집계형)에 표준. **OR**+**AME**로 투명 보고, **클러스터-강건 SE**.  
- **포아송/NB**: 카운트·율에 표준. **오프셋**으로 **분모/노출** 반영, **IRR** 해석. **과산포**면 **Quasi/NB**.  
- **진단**: deviance/LRT, 잔차·캘리브레이션(로지스틱), 과산포(포아송).  
- **함정**: OR vs RR, 분모 누락, 분리, 희귀사건, 클러스터 무시 — 체크리스트로 방지.
