---
layout: post
title: 데이터 통신 - Data Link Layer (2)
date: 2024-07-27 17:20:23 +0900
category: DataCommunication
---
# 9.2 Link-Layer Addressing

## 1) Three Types of Link-Layer Addresses (Unicast / Broadcast / Multicast)

### 1.1 주소가 필요한 이유
네트워크 계층(L3)의 IP 주소는 **엔드-투-엔드 논리 식별자**이고, 링크 계층(L2)의 주소는 **로컬 전송 식별자**다. 같은 서브넷(브로드캐스트 도메인) 내에서 프레임을 전달하려면 **수신자 L2 주소**가 반드시 필요하다. 이 역할을 가장 널리 수행하는 것이 **MAC(EUI-48)** 이다.

### 1.2 이더넷 MAC 주소 구조(핵심 비트)
- 길이: **48비트** (EUI-48). 전개 표기 예시 `aa:bb:cc:dd:ee:ff`.
- 상위 비트 의미(첫 바이트의 LSB 2개가 중요):
  - **I/G bit (Individual/Group)**: 0=Unicast, 1=Multicast(그룹).
  - **U/L bit (Universal/Local)**: 0=전역(OUI 기반), 1=로컬(관리자 임의 설정).
- **OUI(Organizationally Unique Identifier)**: 상위 24비트. 공급업체·조직 고유 범위.

> 현대 단말은 **개인정보 보호**를 위해 무선에서 **로컬 관리 MAC(랜덤화)** 를 기본 사용한다. (연결 시점마다 변하는 임시 MAC; 유선은 일반적으로 NIC의 전역 MAC 사용)

### 1.3 세 가지 주소 유형

| 유형 | I/G 비트 | 목적 | 대표 값(이더넷) | 특징 |
|---|---|---|---|---|
| **Unicast** | 0 | 단일 수신자 | 일반 MAC (예: `34:12:98:...`) | 1:1 전달. 스위치는 포워딩 테이블에 따라 단일 포트로 전송. |
| **Broadcast** | 1(특수) | 도메인 내 전체 수신자 | `ff:ff:ff:ff:ff:ff` | 브리지/스위치가 **모든 포트로 플러딩**. ARP 요청, DHCP 디스커버 등에 사용. |
| **Multicast** | 1 | 그룹 수신자 | `01:00:5e:xx:xx:xx`(IPv4 관련), `33:33:xx:xx:xx:xx`(IPv6 관련) | 가입자만 수신. 스위치는 IGMP/MLD 스누핑으로 필요 포트만 전달. |

> **Anycast**는 L3 개념(여러 엔드포인트가 같은 IP를 광고). L2에는 동일 의미의 표준화된 “anycast MAC”은 없다(단, 일부 특수 환경/벤더 구현 예외).

### 1.4 IPv4/IPv6 멀티캐스트의 L2 매핑
- **IPv4 멀티캐스트(224.0.0.0/4)** → 이더넷 **01:00:5e**: 하위 23비트 매핑.  
  예: IP 239.1.2.3(=0xEF010203)의 하위 23비트 → MAC `01:00:5e:01:02:03` (상위 1비트는 버림)
- **IPv6 멀티캐스트(ff00::/8)** → 이더넷 **33:33:xx:xx:xx:xx**: 하위 32비트 매핑.  
  예: IPv6 멀티캐스트 ff02::1:ff00:1234 → MAC `33:33:ff:00:12:34`

---

## 2) Address Resolution Protocol (ARP) — IPv4의 주소 해석

### 2.1 문제 정의
IP 패킷을 **같은 서브넷**의 피어에게 보내려면 **상대의 MAC**이 필요하다. 이 **IPv4→MAC 매핑**을 **ARP**가 해결한다.

### 2.2 ARP 기본 동작(이더넷 기준)
- **프레임 타입**: EtherType **0x0806**  
- **요청(Request)**: 송신자가 **브로드캐스트**로 “이 IP 누구냐?”(Who has …?)를 묻는다.  
- **응답(Reply)**: 해당 IP의 소유자가 **유니캐스트**로 자신의 MAC을 회신한다.
- **캐시(ARP Cache)**: 매핑은 **일시적으로 저장**되어 반복 ARP를 줄인다(엔트리 타이머 존재).

**요청 프레임 핵심 필드(개념)**  
```
HTYPE=1(Ethernet) | PTYPE=0x0800(IPv4) | HLEN=6 | PLEN=4
OPER=1(Request)
SHA=Sender MAC | SPA=Sender IPv4 | THA=0 | TPA=Target IPv4
```
**응답(OPER=2)**에서 **THA/TPA**에 대상 정보 채워 회신.

### 2.3 ARP의 확장/파생 개념
- **Gratuitous ARP(GARP)**: 자신의 IP→MAC을 **선언/갱신**(IP 변경, 이중화 페일오버 시 광고, 중복 탐지/ARP 캐시 업데이트).
- **Proxy ARP**: 라우터/방화벽이 **대신 응답**하여 L2는 같지만 L3가 다른 세그먼트 간 통신을 가능하게 함(특정 디자인에서만 권장).
- **ARP 캐시 정책**: 동적 엔트리는 **유효시간(예: 수십 초~수 분)**. 트래픽 발생 시 **리프레시** 가능. 정적 엔트리는 수동 설정.
- **보안 이슈(ARP 스푸핑/중독)**: 공격자가 가짜 응답으로 **게이트웨이의 MAC**을 자신으로 바꾸어 **MITM** 유도.
  - **대응**: **DAI(Dynamic ARP Inspection)**, **DHCP 스누핑** 연계, **정적 ARP**, 포트 보안, L2 ACL.

> **IPv6는 ARP 대신 NDP(Neighbor Discovery)** 를 사용한다. NDP는 **ICMPv6** 기반이며, 멀티캐스트를 통해 이웃 탐색/주소 확인/중복 주소 검출(DAD) 등을 수행한다.

### 2.4 ARP와 라우팅의 접점(게이트웨이 사용)
원격 서브넷으로 보낼 때 호스트는 **대상 IP의 MAC이 아니라 “기본 게이트웨이의 MAC”** 을 필요로 한다. 즉,
1) 라우팅 판단: 대상 IP가 **로컬 서브넷**이면 **상대 MAC**을, **원격 서브넷**이면 **게이트웨이 MAC**을 ARP로 구한다.
2) 프레임 캡슐화: **Dest MAC = (상대/게이트웨이) MAC**, **IP 헤더의 Dest IP = 최종 상대 IP**.

---

## 3) An Example of Communication — 단계별 통신 시나리오

아래 예제는 **소스코드 없이** 상태/타임라인/프레임 관점으로 상세히 전개한다.

### 3.1 시나리오 A — 같은 서브넷(Host A → Host B)

**환경**
- 서브넷: 192.0.2.0/24, VLAN 10
- Host A: IP 192.0.2.10, MAC `aa:aa:aa:aa:aa:01`
- Host B: IP 192.0.2.20, MAC `bb:bb:bb:bb:bb:02`
- 스위치: L2 스위치(학습 브리징), ARP 투명

**타임라인**
1. **A의 ARP 캐시 조회**: `192.0.2.20 → ?`. 엔트리 없음.
2. **ARP Request 브로드캐스트**:  
   - L2 Dest MAC: **ff:ff:ff:ff:ff:ff**  
   - “Who has 192.0.2.20? Tell 192.0.2.10”
3. **스위치 플러딩**: VLAN 10 내 모든 포트로 전달.
4. **B의 ARP Reply 유니캐스트**:  
   - “192.0.2.20 is at `bb:bb:...:02`” (L2 Dest= A의 MAC)
5. **A의 ARP 캐시 등록**: `192.0.2.20 → bb:bb:...:02`
6. **실제 데이터 프레임 전송**:  
   - L2: Dest MAC = `bb:bb:...:02` (Unicast),  
   - L3: Src=192.0.2.10, Dest=192.0.2.20 (엔드-투-엔드)
7. **응답 시**: B도 `192.0.2.10` 매핑이 없으면 **역방향 ARP** 수행 또는 Reply 시 **상대 엔트리도 갱신**(일부 OS는 수신 ARP로 캐시 업데이트).

**도해(개념)**
```
A                             Switch                          B
|-- ARP Req (ff:ff:ff:ff:ff:ff) -->|== flood VLAN10 ==>        |
|<-- ARP Rep (bb:bb:..:02) --------|                           |
|-- Data (Dest MAC=bb:bb:..:02) -->|----> (unicast) ---------->|
```

### 3.2 시나리오 B — 원격 서브넷(Host A → Internet의 X)

**환경**
- A: 192.0.2.10/24, GW=192.0.2.1, GW MAC=`gg:gg:...:01`
- 대상 X: 198.51.100.77 (원격)

**타임라인**
1. **A의 라우팅 판단**: X는 **원격** → **기본 게이트웨이**로 전달.
2. **A의 ARP 캐시 확인**: `192.0.2.1 → ?` 엔트리 없으면 **ARP** 수행.
3. **ARP Reply 수신**: GW MAC 획득(`gg:gg:...:01`).
4. **데이터 프레임 전송**:  
   - L2 Dest MAC: **게이트웨이 MAC**  
   - L3 Dest IP: **198.51.100.77(최종)**  
5. **라우터(GW)**: L3 라우팅 후 다음 홉의 L2로 재캡슐화.

**핵심 교훈**: **원격 통신에도 IP 목적지는 원래 상대**, **L2 목적지는 항상 “다음 홉”** 이다.

### 3.3 시나리오 C — Gratuitous ARP와 이중화 페일오버

**환경**
- 가상 게이트웨이 IP: 192.0.2.1을 **R1/R2**가 공유(고가용성).  
- 정상: R1이 활성 MAC 소유. 페일오버 시 R2가 MAC 인계.

**타임라인**
1. **R2 승계**: R2가 192.0.2.1 **GARP** 송신 → “192.0.2.1 is at `rr:rr:...:02`”.
2. **호스트들**: ARP 캐시의 192.0.2.1 매핑이 **빠르게 갱신**되어 **다운타임 최소화**.

### 3.4 시나리오 D — Proxy ARP (필요 시)

**환경**
- 클라이언트 C가 **같은 L2**에 있으나 **L3 경계** 너머의 H와 통신.
- 라우터가 **Proxy ARP**를 사용해 C의 ARP에 **대신 응답**.

**동작 요지**
- C가 H(원격 IP)에 ARP Request 브로드캐스트 → 라우터가 **자신의 MAC**으로 “내가 그 IP”처럼 **ARP Reply**.  
- C는 라우터 MAC을 **목적 MAC**으로 사용 → 라우터가 L3로 포워딩.

> Proxy ARP는 구형/특수 설계에서만 제한적으로 권장. 현대에는 **정상 라우팅·VLAN 분리**가 일반적이다.

---

## 4) 운영·보안·트러블슈팅 포인트

### 4.1 ARP 캐시/타이머/스케일
- **빈번한 ARP**는 브로드캐스트 폭증을 야기 → 라우터/스위치/호스트의 **캐시 정책**이 중요.
- **대규모 서브넷**(수천 단말)에서 브로드캐스트 도메인을 적절히 분할(VLAN/L3 경계)하고, **IGMP/MLD 스누핑**으로 멀티캐스트 트래픽을 제어.

### 4.2 DAI(Dynamic ARP Inspection)
- **DHCP snooping 바인딩 테이블**과 연동하여, **허용된 IP↔MAC↔포트** 조합만 ARP로 승인.
- 스푸핑·MITM 차단에 효과적. 스태틱 IP 환경에서는 **바인딩 관리** 필요.

### 4.3 가상화/클라우드 특수성
- **VM/컨테이너**: 가상 스위치(브리지) 내부의 ARP 학습/플러딩 동작.
- **오버레이(VXLAN/GENEVE)**: 엔드 호스트 간 L2를 L3 터널로 확장. **ARP 요청/응답이 VNI** 위에서 캡슐화되어 전송.
- **ARP抑制(Proxy/Responder)**: 컨트롤 플레인(EVPN 등)로 MAC/IP 매핑을 학습해 **L2 브로드캐스트 감소**.

### 4.4 무선(802.11) 유의점
- ARP는 **브로드캐스트** → 무선에서는 공중 비용이 큼.  
- AP는 **프록시/캐시** 또는 **멀티캐스트-투-유니캐스트 변환** 등 최적화로 무선 효율 개선.

### 4.5 지연·오버헤드 관점 정리
ARP 요청/응답 교환 지연으로 **첫 패킷 전송이 지연**될 수 있다. 단순화해,
\[
T_{\text{first\_tx}} \approx T_{\text{ARP\_req}} + T_{\text{switch\_flood}} + T_{\text{ARP\_rep}} + T_{\text{queue}} + T_{\text{trans/prop}}
\]
**캐시 적중**이면 \(T_{\text{ARP\_req}} \approx 0\) 에 가까워 초기 지연이 크게 줄어든다.

---

## 5) 표/요약 도해

### 5.1 주소 유형 요약
| 항목 | Unicast | Broadcast | Multicast |
|---|---|---|---|
| I/G 비트 | 0 | 1(특수) | 1 |
| 대표 MAC | 기기 고유 MAC | `ff:ff:ff:ff:ff:ff` | `01:00:5e:..`(IPv4), `33:33:..`(IPv6) |
| 스위치 동작 | 포워딩(단일 포트) | 플러딩(모든 포트) | IGMP/MLD 스누핑 기반 포트 선택 |
| 주 용도 | 일반 1:1 트래픽 | ARP, DHCP | 그룹 스트리밍/제어 |

### 5.2 ARP 동작 스냅샷
```
[호스트 A]
  if (!ARP_cache[DstIP]) → ARP Request(ff:ff:ff:ff:ff:ff)
             ↓ (플러딩)
[같은 브로드캐스트 도메인 내의 모든 호스트/스위치]
             ↓
[호스트 B (DstIP 소유)]
  ARP Reply(유니캐스트: A의 MAC)
             ↓
[호스트 A]
  캐시 저장 → 실제 데이터 유니캐스트 전송 시작
```

---

## 6) 실전 체크리스트

- **브로드캐스트 도메인** 크기 관리(VLAN/L3 경계)로 ARP 폭주 억제.  
- **DAI + DHCP 스누핑**으로 ARP 스푸핑 방지.  
- **게이트웨이 이중화**(VRRP/HSRP/GLBP 등) 시 **GARP**로 캐시 신속 갱신.  
- **가상화/오버레이** 환경에서 ARP 억제(프록시/리졸버)와 컨트롤 플레인 연동(EVPN).  
- **무선**에서는 브로드캐스트/멀티캐스트 최적화(AP 기능) 활성화.  
- **운영 가시성**: ARP 테이블 상태(엔트리 수·타이머), Unknown Unicast 플러딩 비율, DAI drop 카운터, 무선의 재시도율/SNR 등.

---

## 7) 결론

- **세 가지 L2 주소**(Unicast/Broadcast/Multicast)는 스위치 기반 이더넷과 무선 LAN의 **기본 전달 규칙**을 규정한다.  
- **ARP**는 IPv4에서 **필수 주소 해석 메커니즘**이며, 캐시·보안(DAI)·오버레이 최적화와 결합되어 현대 대규모 네트워크에서도 효율적으로 동작한다.  
- **통신 예제**에서 보았듯, 로컬은 **상대 MAC**, 원격은 **게이트웨이 MAC**이 필요하며, L2 목적지와 L3 목적지의 **역할 분리**를 이해하는 것이 실무 트러블슈팅의 출발점이다.