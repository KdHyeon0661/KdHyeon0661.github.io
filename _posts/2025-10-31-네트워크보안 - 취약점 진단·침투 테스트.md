---
layout: post
title: 네트워크보안 - 취약점 진단·침투 테스트
date: 2025-10-31 15:25:23 +0900
category: 네트워크보안
---
# 취약점 진단·침투 테스트(승인 환경)

> 목표
> - **스코핑/ROE/리포팅 표준**을 명확히 하고, **네트워크 레벨 체크리스트**로 점검 범위를 구조화한다.
> - **Exploit 프레임워크**는 **승인된 랩/테스트 세그먼트에서만** 안전 가드(속도 제한, 로그, 세션 TTL)와 함께 사용한다.
> - **내부 세그먼트 침투 시나리오(합법/승인 환경)**를 통해 **발견→증명→리스크 평가→개선안**으로 귀결되는 **안전한 절차**를 체득한다.

---

## 스코핑 / ROE / 리포팅 표준

### 스코핑 질문(필수 체크리스트)

- **목표/성공 기준**: 무엇을 증명하고 싶은가? (예: “세그먼트 A에서 B로의 **무단 접근 차단**”)
- **자산/범위**: IP/CIDR, DNS, 클라우드 계정, 내부망(세그먼트, VLAN), 베타/샌드박스만?
- **금지 대상**: 생산 DB, 결제/PII 시스템, 안전장치 없는 OT, 백업 계층, 오래된 레거시 장비 등
- **시간창/부하 제한**: 업무시간 외/내, pps·rps·동시 연결 상한, 스캔 속도/빈도 제한
- **접근 조건**: 사전 계정/테스트용 크리덴셜, 테스트용 메일계정, 허니토큰 배치 여부
- **검증 방법**: 재현 가능한 PoC/증거(스크린샷/헤더/패킷/로그), 영향·리스크 등급 산정 방법
- **안전 가드**: 모니터링 팀 동기화, 차단 임계(킬스위치), 롤백 계획, 포렌식 로그 보존
- **산출물**: 실행 요약(Executive), 취약점 목록(CWE·CVSS), 재현 절차(리스크 경감된 형태), 개선안/우선순위, 재테스트 계획

**스코프 매트릭스 예시**

| 범위 | 포함 | 제외 | 이유/비고 |
|---|---|---|---|
| VPC-A 10.10.0.0/16 | 웹/앱 서브넷, Bastion | DB 서브넷(Prod) | Prod DB는 Read-only 점검만 |
| 사내망 B | VLAN 20, 22 | VLAN 24(OT) | OT 네트워크 미포함 |
| 도메인 | *.test.corp | *.prod.corp | Prod 도메인 미포함 |

---

### ROE(규칙) 샘플 조항

```text
1) 테스트 기간: 2025-11-05 20:00 KST ~ 2025-11-06 06:00 KST
2) 허용 행위: 정적/동적 스캔, 인증 기반 점검, (사전 승인) 제한적 Payload 테스트
3) 금지 행위: 대용량 DoS, 데이터 무단 열람/유출, 고객/직원 PII 접근
4) 속도 제한: L3/4 스캔 5k pps 이하, HTTP RPS IP당 50 r/s 이하
5) 알림: 임계 초과/중단 필요시 즉시 IR 채널(#sec-bridge) 통지
6) 로깅: 모든 명령·아티팩트, 시간(UTC), 해시, 세션 ID 기록
7) 종료: 요청 시 즉시 중단, 산출물 제출·폐기 정책 준수
```

---

### 리포트 표준(골격)

- **Executive Summary**: 1–2페이지(영향, 핵심 취약점 Top5, 권고)
- **방법론**: 스코프/도구/제약/데이터 보존·윤리
- **발견 목록**: CVE/CWE, 영향 시나리오, 증빙(스크린샷/헤더/로그), 재현 절차(안전화)
- **리스크 평가**: CVSS + 환경 가중치(자산 티어/노출도/보호대책)
- **개선안**: 단·중·장기(설정 수정, 패치, 구조 개선, 탐지 룰 추가)
- **부록**: 세션·명령 로그, 해시, PoC 샌드박스 링크, 재테스트 체크리스트

**취약점 카드 예시**

| 필드 | 내용 |
|---|---|
| ID | NW-2025-001 |
| 제목 | 관리 인터페이스 외부 노출(약한 인증) |
| 분류 | CWE-306(불충분한 인증) |
| 자산 | 10.10.2.15:8443 (/admin) |
| 영향 | 관리자 기능 접근 가능(구성 변경 위험) |
| 증빙 | 헤더·응답코드, 접근 로그, 테스트 계정만 사용 |
| 재현 | (샌드박스 전용) 제한된 요청 시나리오 |
| 리스크 | CVSS 8.1 (환경상 7.6) |
| 권고 | ACL·IP 제한, MFA, 관리자 포트 바인딩, 프록시 뒤 이동 |
| 상태 | 패치 예정(2025-11-12), 재테스트 2025-11-15 |

---

## 네트워크 레벨 점검 체크리스트

### 노출/경계

- [ ] 외부 공격면(ASN/도메인/자산 인벤토리 최신)
- [ ] 경계 방화벽/리버스 프록시 뒤에 **관리 포트** 비노출(SSH/RDP/VNC/웹콘솔)
- [ ] TLS 구성(TLS1.2+/1.3, 안전 Cipher, HSTS, OCSP Stapling)
- [ ] DDoS 보호(업스트림/스크러빙/레이트리밋 정책)

### 라우팅/L3/L4 정책

- [ ] uRPF/BCP38, Bogon 필터
- [ ] ACL 최소허용, Any-Any 규칙 제거, 로깅/히트율 점검
- [ ] BGP 보안(Max-Prefix, RPKI, GTSM, MD5)

### 세그먼트·L2 보안

- [ ] VLAN 경계 명확, 프리우닝
- [ ] Port Security/DAI/DHCP Snooping
- [ ] 동적 ARP 보호, 게이트웨이 MAC 고정/모니터링

### 서비스/포트

- [ ] 기본 포트 변경만으로 보안 기대 X → 인증·네트워크 통제
- [ ] 불필요 서비스 비활성화, 배너 최소화
- [ ] 업그레이드/패치 윈도우·취약점 스캔(안전 프로파일)

---

### 안전 스캔 예시(속도·부하 제한)

> 아래 예시는 **테스트 세그먼트**에서, **속도/빈도 제한** 및 **허용된 시간창**에 맞춰 실행

**Nmap(보수적)**
```bash
# 핑/ARP로 호스트 탐지(내부)

sudo nmap -sn -PR 10.10.2.0/24 -oA hostdisc

# 버전/스크립트 일부 제한, 속도 낮춤

sudo nmap -sS -sV --version-intensity 3 --script "default and not intrusive" \
  --max-retries 2 --host-timeout 60s --max-rate 200 \
  -oA tcp_survey 10.10.2.0/24
```

**UDP 표면(엄격 제한)**
```bash
sudo nmap -sU --top-ports 20 --max-rate 100 --defeat-icmp-ratelimit \
  -oA udp_top20 10.10.2.0/24
```

**배너/헤더 수집(HTTP)**
```bash
nmap -p80,443 --script http-headers,http-title -oA http_headers 10.10.2.0/24
```

> 원칙: “**관측 우선** → **가설 생성** → **제한된 상호작용**”. 무분별한 침투 시도 금지.

---

## Exploit 프레임워크와 OPSEC

> ⚠️ **프레임워크 사용은 오직 승인된 랩/테스트 자산**에서, **무해화된 페이로드**(ex. no-op, benign beacon), **세션 TTL/자동 종료**, **철저한 로깅**으로 제한.

### 안전 가드(필수)

- **속도/동시성 제한**: 모듈 실행 간격, 동시 세션 수 상한
- **세션 TTL/자동 종료**: 지정 시간 이후 세션 파기
- **무해화 페이로드**: 파일 생성 금지, 민감 데이터 접근 금지, “증거만 남기고 데이터 미수집”
- **클린업**: 생성한 계정/키/작업 스케줄러/서비스 철거 스크립트
- **로그**: 명령·아티팩트 해시·시간(UTC)·세션ID

### 프레임워크 운용(일반론)

- **Metasploit/코발트류/맞춤 에이전트**:
  - **Staged vs Stageless**: 테스트 목적상 **Stageless + 무해화** 선호(관측·재현성 ↑)
  - **트랜스포트 제한**: HTTP(S)만, 프록시 경유, 사전 지정 egress(테스트 프록시)
  - **OPSEC**: 식별 가능한 User-Agent/고정 Hostname 사용(사고 대응 시 상호 식별 가능)
  - **계정/비밀**: 테스트 전용 계정·토큰 사용, 만료/회수 계획

**예: 샌드박스용 “빈 페이로드” 실행(개념)**
```bash
# 프레임워크 콘솔에서: (구체 모듈·익스플로잇은 생략)

set PAYLOAD <benign/test_payload>   # 테스트용 모듈(파일·키 생성 없음)
set SessionExpiration 1800          # 30분 TTL
set ExitOnSession true              # 세션 후 자동 종료
run
```

> 본 문서에서는 **실제 취약점 악용 절차/코드 제공을 지양**하며, **재현 가능한 무해화 테스트**만 다룬다.

### 상호운용: 스캐너↔프레임워크↔로그

- 스캐너 결과(CVE/CWE) → **증빙 필요 시** 샌드박스 PoC로 **위험 현실성**만 입증
- SIEM/NDR 연동: 테스트 중 **탐지 이벤트**가 발생하는지 확인(탐지 레그레션 방지)

### 탐지 친화(OPSEC vs 투명성)

- Red/Blue 핸드셰이크: 테스트 중 생성되는 알림의 **기대치/패턴** 사전 공유
- 탐지 회피 기법 지양, 대신 **탐지 유발 체크리스트**로 Blue팀 검증에 협력

---

## 실습: 내부 세그먼트 침투 시나리오(승인 환경)

### 시나리오 개요

- **목표**: `User-Seg (VLAN 20)`에서 `App-Seg (VLAN 22)`의 내부 HTTP API로 **무단 접근 가능성** 평가
- **제약/ROE**:
  - 업무시간 외 4시간 창, RPS 30 제한, 민감 데이터 열람 금지
  - 인증 정보는 **테스트 전용 계정**만 사용
  - 라우팅/ACL 변경 금지, **관측 우선**
- **아키텍처(예)**

```
[User-Seg VLAN20] --FW--> [App-Seg VLAN22] --LB--> [App01/02]
         |                               |
      Bastion                         Log/SIEM
```

---

### 단계 1 — 가시성/정찰(저부하)

**호스트/포트 서베이(내부)**
```bash
sudo nmap -sn -PR 10.20.0.0/24 -oA v20_hosts
sudo nmap -sS -p 80,443,8080,8443 --max-rate 200 -oA v22_web 10.22.0.0/24
```

**HTTP 헤더/타이틀 수집**
```bash
nmap -p443 --script http-headers,http-title -oA v22_headers 10.22.0.10,10.22.0.11
```

**관찰 로그(자기 기록)**
```bash
# 실습 노트(UTC 기준)

date -u +"%F %T" | tee -a run.log
echo "CMD: nmap -sS ..." | tee -a run.log
```

---

### 단계 2 — 정책 검증(ACL/Segmentation)

**세그먼트 간 연결성 점검**
```bash
# 허용된 포트만 열려야 함

nc -vz 10.22.0.10 80
nc -vz 10.22.0.10 443
nc -vz 10.22.0.11 22   # ❌ 기대: 차단
```

**uRPF/로그 확인(Blue 협업)**
- 유효하지 않은 소스 경로 → 드롭되는지
- 방화벽 로그에서 테스트 요청이 기대대로 기록되는지

---

### 단계 3 — 취약 구성 탐색(무해화 상호작용)

**TLS/보안 헤더 검사(저충격)**
```bash
# SSLyze/sslyze 등 안전한 클라이언트 사용(속도 제한)

python3 -m sslyze --regular 10.22.0.10:443
```

**HTTP 보안 헤더(스크립트 예)**
```bash
#!/usr/bin/env bash

set -e
for h in 10.22.0.10 10.22.0.11; do
  echo "== $h =="; curl -skI https://$h | egrep -i 'strict|content-secur|x-frame|x-content|referrer|permissions'
done
```

> 발견 포인트(예): `HSTS 미설정`, `X-Frame-Options 없음`, `Admin 경로 노출` 등

---

### 단계 4 — 인증/권한 검증(테스트 계정)

> **금지**: 특권 상승·타 계정 접근·민감 데이터 열람.
> **허용**: 테스트 계정으로 **권한 경계**만 확인.

**API 권한 경계**
```bash
# 정상: /api/user/profile (200)

curl -sk -H "Authorization: Bearer TEST_TOKEN" https://10.22.0.10/api/user/profile

# 기대: /api/admin/config (403)

curl -sk -H "Authorization: Bearer TEST_TOKEN" https://10.22.0.10/api/admin/config
```

- 만약 200/정보 노출이면: **권한 검증 취약**으로 리포팅(증거: 상태코드·부분 헤더만 캡처)

---

### 단계 5 — 레이트/리소스 보호(DoS 민감도 비테스트)

> DoS는 ROE에서 대부분 **금지**. 대신 **구성 검토**로 보호수준 확인

체크 포인트
- [ ] LB/프록시 `limit_req/limit_conn` 또는 동등 기능
- [ ] 업로드 크기 제한, 타임아웃(슬로우 HTTP 방어)
- [ ] 백엔드 회로차단기/격벽

**구성 스니펫(참고 – 차단 미수행)**
```nginx
limit_req_zone $binary_remote_addr zone=req:10m rate=30r/s;
limit_conn_zone $binary_remote_addr zone=ip:10m;

server {
  location /api/ {
    limit_conn ip 20;
    limit_req zone=req burst=30 nodelay;
    proxy_read_timeout 30s;
    client_max_body_size 8m;
  }
}
```

---

### 단계 6 — (선택) 샌드박스형 PoC로 “위험 현실성”만 증명

> 전제: 사전 승인, **테스트 컨테이너**에 한정, **무해화 페이로드** 사용

**예: 테스트 에이전트 설치/통신 여부만 확인(파일·키 미생성)**
```bash
# (개념) 테스트용 에이전트가 서버에 "ping" 전송 후 즉시 종료
# 세션 TTL 5분, 로깅만 수행

```

- SIEM/NDR에서 **탐지 이벤트가 발생하는지** Blue팀과 함께 검증
- 발견: “탐지 미발생 → 탐지 룰/로깅 보강” 권고

---

### 산출물·개선안 정리

**발견 요약(예시)**

| ID | 발견 | 영향 | 증빙(안전화) | 권고 |
|---|---|---|---|---|
| NW-001 | Admin 포트 외부 노출 | 구성 변경/탈취 위험 | 헤더·타이틀 캡처 | 관리 포트 내망 바인딩, 소스 제한, MFA |
| NW-002 | HSTS 미설정 | 중간자/다운그레이드 위험 | 응답 헤더 캡처 | HSTS 예열/서브도메인 포함 |
| NW-003 | 권한 경계 약함 | 비인가 접근 가능 | 테스트 토큰 403→200 사례 | 경로별 ABAC·정책 테스트 추가 |
| NW-004 | 탐지 미흡 | 침해 가시성 저하 | 샌드박스 에이전트 미탐지 | WAF/NDR 룰·JA3·경보 튜닝 |

**우선순위 로드맵**
- **즉시(주)**: 관리 포트 내재화, WAF 정책 강화, HSTS 배포
- **단기(월)**: 경로별 권한 테스트(계약 전 검증), NDR 룰 셋 추가, 로그 스키마 표준화
- **중기(분기)**: 네트워크 분할 재설계(문턱·허브-스포크), 자동화된 재그레션 스캔 파이프라인

---

## 부록 A. 점검 기록(감사·재현)

**작업 로그 포맷**
```
[UTC] 2025-11-05T11:02:15Z  CMD: nmap -sS -p 80,443 ...
[UTC] 2025-11-05T11:05:40Z  OBS: 10.22.0.10:8443 open, title="Admin Console"
[UTC] 2025-11-05T11:12:01Z  EVID: resp_headers_10.22.0.10_8443.txt (sha256:xxxx)
```

**아티팩트 보존**
- 캡처물/스크린샷/헤더: SHA-256, 증거ID, 사건ID 태깅
- 보존 기간: 계약/법규에 따름, 만료 시 파기

---

## 부록 B. 재테스트 체크리스트

- [ ] 수정·패치 적용 확인(버전/헤더/정책 diff)
- [ ] 이전 재현 절차(안전화) 동일 실행 → 결과 일치?
- [ ] 부작용(정상 기능 영향) 여부
- [ ] 탐지/알림 동작(이벤트/대시보드) 확인
- [ ] 문서/구성 리포지토리 업데이트(GitOps)

---

## 부록 C. 커뮤니케이션 플로우(예)

```
테스트 시작(ROE 공유) → 진행상황 브리핑(중간) → 종료 통보
→ 초안 리포트(3영업일) → 보완/Q&A → 최종 리포트/워크샵
→ 개선 계획 합의 → 재테스트 윈도우 예약
```

---

## 요약

- **스코핑/ROE**는 실수·오탐·사업 영향 최소화의 **보험**이다.
- **네트워크 레벨 체크리스트**로 **경계, 세그먼트, 라우팅, 서비스**를 체계적으로 검토하라.
- **Exploit 프레임워크**는 **무해화·속도 제한·세션 TTL·철저한 로깅** 아래 **샌드박스**에서만 사용하라.
- **침투 시나리오**의 결론은 **취약점 목록**이 아니라 **현실적 리스크 평가와 개선 로드맵**이다.
- 최종 목적은 **“파괴가 아닌 개선”** — 탐지·차단·회복력을 함께 강화해야 한다.
