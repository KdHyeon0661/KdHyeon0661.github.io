---
layout: post
title: Avalonia - íŒŒì¼ ì—…ë¡œë“œ/ë‹¤ìš´ë¡œë“œ
date: 2025-02-09 21:20:23 +0900
category: Avalonia
---
# ğŸ“ Avaloniaì—ì„œ íŒŒì¼ ì—…ë¡œë“œ/ë‹¤ìš´ë¡œë“œ (HttpClient ì—°ë™)

---

## ğŸ¯ ëª©í‘œ

| í•­ëª© | ì„¤ëª… |
|------|------|
| íŒŒì¼ ì—…ë¡œë“œ | ì‚¬ìš©ìë¡œë¶€í„° íŒŒì¼ ì„ íƒ í›„ APIë¡œ ì „ì†¡ |
| íŒŒì¼ ë‹¤ìš´ë¡œë“œ | ì„œë²„ì—ì„œ íŒŒì¼ ë°›ì•„ ì‚¬ìš©ìì—ê²Œ ì €ì¥ |
| UI í†µí•© | OpenFileDialog, SaveFileDialog ì‚¬ìš© |
| MVVM êµ¬ì¡° | ViewModelì—ì„œ ì„œë¹„ìŠ¤ ë¶„ë¦¬, ëª…ë ¹ ê¸°ë°˜ |

---

## ğŸ§± êµ¬ì¡° ì˜ˆì‹œ

```
MyApp/
â”œâ”€â”€ Views/
â”‚   â””â”€â”€ FileTransferView.axaml
â”œâ”€â”€ ViewModels/
â”‚   â””â”€â”€ FileTransferViewModel.cs
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ IFileService.cs
â”‚   â””â”€â”€ FileApiService.cs
```

---

## 1ï¸âƒ£ íŒŒì¼ API ì •ì˜

ì„œë²„ API ì˜ˆì‹œ:

| ê¸°ëŠ¥ | ì—”ë“œí¬ì¸íŠ¸ | ë©”ì„œë“œ | ì„¤ëª… |
|------|------------|--------|------|
| ì—…ë¡œë“œ | `/api/files/upload` | POST | multipart/form-data |
| ë‹¤ìš´ë¡œë“œ | `/api/files/download/{id}` | GET | íŒŒì¼ ìŠ¤íŠ¸ë¦¼ ë°˜í™˜ |

---

## 2ï¸âƒ£ ì¸í„°í˜ì´ìŠ¤ ì •ì˜

### ğŸ“„ Services/IFileService.cs

```csharp
public interface IFileService
{
    Task UploadFileAsync(string filePath);
    Task DownloadFileAsync(int fileId, string savePath);
}
```

---

## 3ï¸âƒ£ HttpClientë¡œ êµ¬í˜„

### ğŸ“„ Services/FileApiService.cs

```csharp
public class FileApiService : IFileService
{
    private readonly HttpClient _http;

    public FileApiService(HttpClient http)
    {
        _http = http;
    }

    public async Task UploadFileAsync(string filePath)
    {
        using var content = new MultipartFormDataContent();
        var fileStream = File.OpenRead(filePath);
        var fileName = Path.GetFileName(filePath);

        content.Add(new StreamContent(fileStream), "file", fileName);

        var response = await _http.PostAsync("/api/files/upload", content);
        response.EnsureSuccessStatusCode();
    }

    public async Task DownloadFileAsync(int fileId, string savePath)
    {
        var response = await _http.GetAsync($"/api/files/download/{fileId}");
        response.EnsureSuccessStatusCode();

        var bytes = await response.Content.ReadAsByteArrayAsync();
        await File.WriteAllBytesAsync(savePath, bytes);
    }
}
```

---

## 4ï¸âƒ£ DI ë“±ë¡

```csharp
services.AddSingleton<IFileService, FileApiService>();
services.AddSingleton(new HttpClient
{
    BaseAddress = new Uri("https://api.example.com")
});
```

---

## 5ï¸âƒ£ UI êµ¬ì„± (íŒŒì¼ ì„ íƒ ë° ì €ì¥)

### ğŸ“„ Views/FileTransferView.axaml

```xml
<StackPanel Margin="20" Spacing="10">
  <Button Content="ğŸ“¤ ì—…ë¡œë“œ" Command="{Binding UploadCommand}"/>
  <Button Content="ğŸ“¥ ë‹¤ìš´ë¡œë“œ" Command="{Binding DownloadCommand}"/>
  <TextBlock Text="{Binding StatusMessage}" Foreground="Green"/>
</StackPanel>
```

---

## 6ï¸âƒ£ ViewModel êµ¬í˜„

### ğŸ“„ ViewModels/FileTransferViewModel.cs

```csharp
public class FileTransferViewModel : ReactiveObject
{
    private readonly IFileService _fileService;
    private readonly Window _parent;

    public string StatusMessage { get; private set; } = "";

    public ReactiveCommand<Unit, Unit> UploadCommand { get; }
    public ReactiveCommand<Unit, Unit> DownloadCommand { get; }

    public FileTransferViewModel(IFileService fileService, Window parent)
    {
        _fileService = fileService;
        _parent = parent;

        UploadCommand = ReactiveCommand.CreateFromTask(UploadFileAsync);
        DownloadCommand = ReactiveCommand.CreateFromTask(DownloadFileAsync);
    }

    private async Task UploadFileAsync()
    {
        var dialog = new OpenFileDialog { Title = "ì—…ë¡œë“œí•  íŒŒì¼ ì„ íƒ" };
        var result = await dialog.ShowAsync(_parent);
        if (result == null || result.Length == 0) return;

        try
        {
            await _fileService.UploadFileAsync(result[0]);
            StatusMessage = "âœ… ì—…ë¡œë“œ ì„±ê³µ";
        }
        catch (Exception ex)
        {
            StatusMessage = $"âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: {ex.Message}";
        }

        this.RaisePropertyChanged(nameof(StatusMessage));
    }

    private async Task DownloadFileAsync()
    {
        var saveDialog = new SaveFileDialog
        {
            Title = "ì €ì¥ ìœ„ì¹˜ ì„ íƒ",
            InitialFileName = "downloaded_file.txt"
        };

        var savePath = await saveDialog.ShowAsync(_parent);
        if (string.IsNullOrEmpty(savePath)) return;

        try
        {
            await _fileService.DownloadFileAsync(fileId: 1, savePath); // ì˜ˆì‹œ ID
            StatusMessage = "âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ";
        }
        catch (Exception ex)
        {
            StatusMessage = $"âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: {ex.Message}";
        }

        this.RaisePropertyChanged(nameof(StatusMessage));
    }
}
```

---

## 7ï¸âƒ£ ViewModel ì—°ê²° (MainWindow ë“±ì—ì„œ)

```csharp
var window = new FileTransferView();
window.DataContext = new FileTransferViewModel(
    Services.GetRequiredService<IFileService>(),
    window
);
window.Show();
```

---

## 8ï¸âƒ£ ì˜ˆì™¸/ë³´ì•ˆ ì²˜ë¦¬ íŒ

| í•­ëª© | ë°©ë²• |
|------|------|
| í° íŒŒì¼ ì—…ë¡œë“œ | `HttpClient.Timeout` ì¡°ì • |
| ì§„í–‰ë¥  í‘œì‹œ | `Progress<T>` ì‚¬ìš© ë˜ëŠ” ë°”ì´íŠ¸ ê³„ì‚° |
| ì¸ì¦ í—¤ë” | `Authorization` í—¤ë” ì¶”ê°€ |
| MIME íƒ€ì… ì²˜ë¦¬ | `Content-Type` ì²´í¬ |
| ì—ëŸ¬ ë©”ì‹œì§€ | ì‚¬ìš©ìì—ê²Œ ëª…í™•íˆ ì „ë‹¬

---

## âœ… ì •ë¦¬

| ê¸°ëŠ¥ | êµ¬í˜„ ë°©ì‹ |
|------|-----------|
| ì—…ë¡œë“œ | `HttpClient.PostAsync` + `MultipartFormDataContent` |
| ë‹¤ìš´ë¡œë“œ | `HttpClient.GetAsync` + `WriteAllBytesAsync` |
| UI ì—°ë™ | `OpenFileDialog`, `SaveFileDialog` |
| êµ¬ì¡° ë¶„ë¦¬ | `IFileService`ë¥¼ í†µí•´ MVVM êµ¬ì¡° ìœ ì§€ |
| ì˜ˆì™¸ ì²˜ë¦¬ | Try-catchë¡œ ìƒíƒœ ë©”ì‹œì§€ ê´€ë¦¬ |

---

## ğŸ’¡ í™•ì¥ ì•„ì´ë””ì–´

- ğŸ”„ ë‹¤ì¤‘ íŒŒì¼ ì—…ë¡œë“œ (`OpenFileDialog.AllowMultiple = true`)
- ğŸ§ª íŒŒì¼ í˜•ì‹ í•„í„° (`Filters.Add(new FileDialogFilter { ... })`)
- ğŸ§¬ ì„œë²„ì— ì—…ë¡œë“œ í›„ ì‘ë‹µìœ¼ë¡œ ì €ì¥ ID ë°˜í™˜
- ğŸ“¤ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì—…ë¡œë“œ ê¸°ëŠ¥ ì¶”ê°€
- ğŸ“Š ì—…ë¡œë“œ/ë‹¤ìš´ë¡œë“œ ì§„í–‰ë¥  ë°”