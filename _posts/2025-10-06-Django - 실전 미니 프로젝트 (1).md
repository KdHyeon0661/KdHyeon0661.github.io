---
layout: post
title: Django - ì‹¤ì „ ë¯¸ë‹ˆ í”„ë¡œì íŠ¸ (1)
date: 2025-10-06 21:25:23 +0900
category: Django
---
# ì‹¤ì „ ë¯¸ë‹ˆ í”„ë¡œì íŠ¸ - ì»¤ë®¤ë‹ˆí‹° & ëŒ“ê¸€

> **ëª©í‘œ**: Django 5.xë¡œ â€œê²Œì‹œíŒ(ê²Œì‹œê¸€) + ëŒ“ê¸€â€ì„ **ê¸°ë³¸ CRUD + ê¶Œí•œ + ìºì‹œ**ê¹Œì§€ í•œ ë²ˆì— êµ¬í˜„í•©ë‹ˆë‹¤.
> - ìŠ¤íƒ: Django 5.x, PostgreSQL, Redis(ìºì‹œ), django-redis
> - ê¸°ëŠ¥: ê²Œì‹œê¸€/ëŒ“ê¸€ CRUD, ë¡œê·¸ì¸/ê¶Œí•œ, ì¢‹ì•„ìš”, í˜ì´ì§•/ê²€ìƒ‰, ìŠ¤íŒ¸/ì•…ì„± ì…ë ¥ ë°©ì§€, ìºì‹œ(per-view, per-object, low-level), ë¹„ë™ê¸° ì¹´ìš´í„°(ì˜µì…˜)
> - ëª¨ë“  ì½”ë“œëŠ” ``` ë¡œ ê°ì‹¸ë©°, ìˆ˜í•™ì‹ì€ ì—†ìŠµë‹ˆë‹¤.

---

## A. ëª¨ë¸ ì„¤ê³„

### A-1. ìš”êµ¬ì‚¬í•­ ìš”ì•½

- ê²Œì‹œê¸€(Post): ì œëª©, ë³¸ë¬¸, ì‘ì„±ì, ê³µê°œ/ë¹„ê³µê°œ, ì¡°íšŒìˆ˜, ëŒ“ê¸€ ìˆ˜, ì¢‹ì•„ìš” ìˆ˜
- ëŒ“ê¸€(Comment): ê²Œì‹œê¸€ FK, ë¶€ëª¨(ëŒ€ëŒ“ê¸€ ì˜µì…˜), ë³¸ë¬¸, ì‘ì„±ì, ìƒíƒœ(ì •ìƒ/ìˆ¨ê¹€/ì‚­ì œ)
- ì¢‹ì•„ìš”(Like): ì‚¬ìš©ì-ê²Œì‹œê¸€ N:M(ìœ ë‹ˆí¬)
- ê°ì‚¬/ê´€ë¦¬: ìˆ˜ì •/ì‚­ì œ ê°ì‚¬ ë¡œê·¸, soft-delete(ì˜µì…˜)
- ì„±ëŠ¥: ì¹´ìš´í„° í•„ë“œ(denormalized), ì¸ë±ìŠ¤ ìµœì í™”

### A-2. ëª¨ë¸ ì½”ë“œ

```python
# apps/community/models.py

from django.db import models
from django.conf import settings
from django.utils import timezone

class Post(models.Model):
    VISIBILITY = (("public","ê³µê°œ"),("private","ë¹„ê³µê°œ"))
    author = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.PROTECT, related_name="posts")
    title = models.CharField(max_length=120, db_index=True)
    body = models.TextField()
    visibility = models.CharField(max_length=7, choices=VISIBILITY, default="public")
    view_count = models.PositiveIntegerField(default=0)
    comment_count = models.PositiveIntegerField(default=0)
    like_count = models.PositiveIntegerField(default=0)
    is_locked = models.BooleanField(default=False)  # ìš´ì˜ ì ê¸ˆ(ìˆ˜ì •/ëŒ“ê¸€ ë¶ˆê°€)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        indexes = [
            models.Index(fields=["-created_at"]),
            models.Index(fields=["visibility","-created_at"]),
            models.Index(fields=["author","-created_at"]),
        ]

    def __str__(self):
        return f"[{self.pk}] {self.title}"

class Comment(models.Model):
    class Status(models.TextChoices):
        NORMAL = "normal","ì •ìƒ"
        HIDDEN = "hidden","ìˆ¨ê¹€"
        DELETED = "deleted","ì‚­ì œ"
    post = models.ForeignKey(Post, on_delete=models.CASCADE, related_name="comments")
    author = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.PROTECT, related_name="comments")
    parent = models.ForeignKey("self", null=True, blank=True, on_delete=models.CASCADE, related_name="children")
    body = models.TextField(max_length=2000)
    status = models.CharField(max_length=10, choices=Status.choices, default=Status.NORMAL)
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        indexes = [
            models.Index(fields=["post","-created_at"]),
            models.Index(fields=["author","-created_at"]),
        ]

class PostLike(models.Model):
    post = models.ForeignKey(Post, on_delete=models.CASCADE, related_name="likes")
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="post_likes")
    created_at = models.DateTimeField(default=timezone.now)

    class Meta:
        unique_together = [("post","user")]
        indexes = [models.Index(fields=["user","-created_at"])]
```

> **ì„¤ê³„ í¬ì¸íŠ¸**
> - `comment_count`, `like_count`ëŠ” **ì“°ê¸° ì‹œ ì—…ë°ì´íŠ¸**í•˜ì—¬ ëª©ë¡/ìƒì„¸ì—ì„œ ì¡°ì¸ ì—†ì´ ì‚¬ìš©.
> - ëŒ“ê¸€ì€ `parent` í•„ë“œë¡œ **2ë‹¨ íŠ¸ë¦¬**(ëŒ€ëŒ“ê¸€) ì§€ì›(í•„ìš” ì‹œ ë¬´ì œí•œ íŠ¸ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ê°€ëŠ¥).
> - `visibility`, `is_locked` ë¡œ ê³µê°œì„±/ìš´ì˜ ì ê¸ˆ ì œì–´.

---

## B. í¼ & ê²€ì¦

```python
# apps/community/forms.py

from django import forms
from .models import Post, Comment

class PostForm(forms.ModelForm):
    class Meta:
        model = Post
        fields = ["title","body","visibility"]
        widgets = {
            "title": forms.TextInput(attrs={"maxlength":120,"placeholder":"ì œëª©"}),
            "body": forms.Textarea(attrs={"rows":10}),
        }

    def clean_title(self):
        t = self.cleaned_data["title"].strip()
        if len(t) < 2:
            raise forms.ValidationError("ì œëª©ì€ 2ì ì´ìƒ")
        return t

class CommentForm(forms.ModelForm):
    class Meta:
        model = Comment
        fields = ["body","parent"]
        widgets = {"body": forms.Textarea(attrs={"rows":3,"maxlength":2000})}

    def clean_body(self):
        b = self.cleaned_data["body"].strip()
        if not b:
            raise forms.ValidationError("ë‚´ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤.")
        # ê°„ë‹¨í•œ ê¸ˆì¹™ì–´ í•„í„°(ì‹¤ë¬´: ì „ì²˜ë¦¬/ìŠ¤íŒ¸í•„í„°/ìš•ì„¤ì‚¬ì „)
        if "http://" in b or "https://" in b:
            # í—ˆìš© ì „ëµ ë‹¤ë¥´ê²Œ ê°€ëŠ¥(ë§í¬ ì œí•œ)
            pass
        return b
```

---

## C. ê¶Œí•œ/ì ‘ê·¼ ì œì–´

### C-1. ê·œì¹™

- **ì½ê¸°**: `public`ì€ ëª¨ë‘, `private`ì€ ì‘ì„±ìë§Œ(ë˜ëŠ” ê·¸ë£¹/íŒ”ë¡œì›Œ ë“± ê·œì¹™ í™•ì¥)
- **ì“°ê¸°**: ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ
- **ìˆ˜ì •/ì‚­ì œ**: ì‘ì„±ì ë˜ëŠ” ìš´ì˜ì(staff)
- **ëŒ“ê¸€**: `is_locked=False`ì¸ ê²Œì‹œê¸€ì—ì„œë§Œ ì‘ì„±/ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥

### C-2. í—¬í¼

```python
# apps/community/permissions.py

from django.http import Http404, HttpResponseForbidden

def can_view_post(request, post):
    if post.visibility == "public":
        return True
    return request.user.is_authenticated and request.user == post.author

def must_be_author_or_staff(request, obj):
    if request.user.is_superuser or request.user.is_staff:
        return True
    return request.user.is_authenticated and obj.author_id == request.user.id

def forbid_or_404(condition):
    if not condition:
        return HttpResponseForbidden("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
    return None
```

---

## D. URL & ë·° (CRUD)

### D-1. URL

```python
# apps/community/urls.py

from django.urls import path
from . import views

app_name = "community"
urlpatterns = [
    path("", views.PostListView.as_view(), name="post_list"),
    path("post/new/", views.PostCreateView.as_view(), name="post_create"),
    path("post/<int:pk>/", views.post_detail, name="post_detail"),
    path("post/<int:pk>/edit/", views.PostUpdateView.as_view(), name="post_edit"),
    path("post/<int:pk>/delete/", views.post_delete, name="post_delete"),

    path("post/<int:pk>/like/", views.post_like_toggle, name="post_like"),
    path("post/<int:pk>/comment/", views.comment_create, name="comment_create"),
    path("comment/<int:pk>/delete/", views.comment_delete, name="comment_delete"),
]
```

### D-2. ë¦¬ìŠ¤íŠ¸/ìƒì„±/ìˆ˜ì • CBV + ìƒì„¸ FBV (ìºì‹œë¥¼ ì‰½ê²Œ ë„£ê¸° ìœ„í•´)

```python
# apps/community/views.py

from django.contrib.auth.mixins import LoginRequiredMixin
from django.views.generic import ListView, CreateView, UpdateView
from django.shortcuts import render, get_object_or_404, redirect
from django.db.models import Q, F
from django.http import HttpResponseForbidden, JsonResponse
from django.urls import reverse_lazy
from django.utils.decorators import method_decorator
from django.views.decorators.cache import cache_page
from django.core.cache import cache
from .models import Post, Comment, PostLike
from .forms import PostForm, CommentForm
from .permissions import can_view_post, must_be_author_or_staff

# --- ë¦¬ìŠ¤íŠ¸ (ê²€ìƒ‰/ì •ë ¬/í˜ì´ì§•)

class PostListView(ListView):
    model = Post
    paginate_by = 20
    template_name = "community/post_list.html"

    def get_queryset(self):
        q = self.request.GET.get("q","").strip()
        qs = Post.objects.filter(visibility="public").order_by("-created_at")
        if q:
            qs = qs.filter(Q(title__icontains=q) | Q(body__icontains=q))
        return qs.select_related("author")

# --- ìƒì„±

class PostCreateView(LoginRequiredMixin, CreateView):
    form_class = PostForm
    template_name = "community/post_form.html"
    success_url = reverse_lazy("community:post_list")

    def form_valid(self, form):
        form.instance.author = self.request.user
        r = super().form_valid(form)
        # ìƒì„¸ ìºì‹œ í‚¤ ì‚¬ì „ ë¬´íš¨í™”(ëª©ë¡ì€ í˜ì´ì§€ ìºì‹œë¡œ ì»¤ë²„)
        cache.delete_pattern(f"post:detail:{self.object.pk}:*")
        return r

# --- ìˆ˜ì •

class PostUpdateView(LoginRequiredMixin, UpdateView):
    form_class = PostForm
    template_name = "community/post_form.html"
    model = Post

    def dispatch(self, request, *args, **kwargs):
        self.object = self.get_object()
        if self.object.is_locked and not request.user.is_staff:
            return HttpResponseForbidden("ìš´ì˜ ì ê¸ˆëœ ê¸€ì…ë‹ˆë‹¤.")
        if not must_be_author_or_staff(request, self.object):
            return HttpResponseForbidden("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return super().dispatch(request, *args, **kwargs)

    def get_success_url(self):
        cache.delete_pattern(f"post:detail:{self.object.pk}:*")
        return reverse_lazy("community:post_detail", kwargs={"pk": self.object.pk})
```

### D-3. ìƒì„¸ ë·° (per-view ìºì‹œ + ì¡°íšŒìˆ˜ ì•ˆì „ ì¦ê°€)

```python
# apps/community/views.py (ê³„ì†)

from django.views.decorators.vary import vary_on_cookie
from django.db import transaction

def _post_detail_cache_key(pk, user_id=None, page=1):
    # ê³µê°œ/ë¹„ê³µê°œ/ì¢‹ì•„ìš” ë²„íŠ¼ ìƒíƒœ(ë¡œê·¸ì¸)ë¡œ ë³€í˜• ê°€ëŠ¥ â†’ user_id í¬í•¨
    uid = user_id or 0
    return f"post:detail:{pk}:u{uid}:p{page}"

@vary_on_cookie  # ë¡œê·¸ì¸/ë¹„ë¡œê·¸ì¸ Vary (ì¿ í‚¤ ë³€ê²½ì— ë”°ë¼ ìºì‹œ ë¶„ë¦¬)
@cache_page(60)  # 60ì´ˆ í˜ì´ì§€ ìºì‹œ(Reverse proxy ì•ë‹¨ë„ ê³ ë ¤)
def post_detail(request, pk):
    post = get_object_or_404(Post.objects.select_related("author"), pk=pk)
    if not can_view_post(request, post):
        return HttpResponseForbidden("ì—´ëŒê¶Œí•œ ì—†ìŒ")
    # ì„¸ì…˜ ê¸°ë°˜ ì¡°íšŒìˆ˜ ì¦ê°€(ìœ ì €ë³„ ì¤‘ë³µ ë°©ì§€)
    key = f"post:viewed:{pk}:{request.session.session_key}"
    if not cache.get(key):
        with transaction.atomic():
            Post.objects.filter(pk=pk).update(view_count=F("view_count")+1)
        cache.set(key, True, 60*10)  # 10ë¶„ ë‚´ ì¬ë°©ë¬¸ ì¹´ìš´íŠ¸ ì œì™¸

    # ëŒ“ê¸€ í˜ì´ì§•(ëŒ€ëŒ“ê¸€ì€ ê°„ë‹¨íˆ parent=Noneë§Œ 1ì°¨ ë…¸ì¶œ)
    page = int(request.GET.get("page",1))
    per_page = 20
    comments_qs = (post.comments
                        .filter(status="normal", parent__isnull=True)
                        .select_related("author")
                        .order_by("-created_at"))
    total = comments_qs.count()
    start = (page-1)*per_page
    comments = list(comments_qs[start:start+per_page])

    # ê° ëŒ“ê¸€ì˜ ëŒ€ëŒ“ê¸€ ë¯¸ë¦¬ ë¡œë“œ(ì˜µì…˜ ìµœì í™”)
    child_map = {}
    for c in Comment.objects.filter(parent__in=[c.pk for c in comments], status="normal").select_related("author"):
        child_map.setdefault(c.parent_id, []).append(c)

    # ì¢‹ì•„ìš” ì—¬ë¶€
    liked = False
    if request.user.is_authenticated:
        liked = PostLike.objects.filter(post=post, user=request.user).exists()

    ctx = {
        "post": post,
        "comments": comments,
        "children": child_map,
        "liked": liked,
        "page": page, "total": total, "per_page": per_page
    }
    return render(request, "community/post_detail.html", ctx)
```

---

## E. ì•¡ì…˜: ì‚­ì œ/ì¢‹ì•„ìš”/ëŒ“ê¸€ ì‘ì„±Â·ì‚­ì œ

```python
# apps/community/views.py (ê³„ì†)

from django.views.decorators.http import require_POST

@require_POST
def post_delete(request, pk):
    post = get_object_or_404(Post, pk=pk)
    if not must_be_author_or_staff(request, post):
        return HttpResponseForbidden("ê¶Œí•œ ì—†ìŒ")
    post.delete()
    cache.delete_pattern(f"post:detail:{pk}:*")
    return redirect("community:post_list")

@require_POST
def post_like_toggle(request, pk):
    if not request.user.is_authenticated:
        return HttpResponseForbidden("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.")
    post = get_object_or_404(Post, pk=pk)
    obj, created = PostLike.objects.get_or_create(post=post, user=request.user)
    if not created:
        obj.delete()
        Post.objects.filter(pk=pk).update(like_count=F("like_count")-1)
        liked = False
    else:
        Post.objects.filter(pk=pk).update(like_count=F("like_count")+1)
        liked = True
    cache.delete_pattern(f"post:detail:{pk}:*")
    return JsonResponse({"liked": liked, "like_count": Post.objects.get(pk=pk).like_count})

@require_POST
def comment_create(request, pk):
    if not request.user.is_authenticated:
        return HttpResponseForbidden("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.")
    post = get_object_or_404(Post, pk=pk)
    if post.is_locked and not request.user.is_staff:
        return HttpResponseForbidden("ìš´ì˜ ì ê¸ˆëœ ê¸€ì…ë‹ˆë‹¤.")
    form = CommentForm(request.POST)
    if not form.is_valid():
        return JsonResponse({"ok": False, "errors": form.errors}, status=400)
    c = form.save(commit=False)
    c.author = request.user
    c.post = post
    c.save()
    Post.objects.filter(pk=pk).update(comment_count=F("comment_count")+1)
    cache.delete_pattern(f"post:detail:{pk}:*")
    return JsonResponse({"ok": True, "id": c.pk, "comment_count": Post.objects.get(pk=pk).comment_count})

@require_POST
def comment_delete(request, pk):
    c = get_object_or_404(Comment.objects.select_related("post"), pk=pk)
    if not must_be_author_or_staff(request, c):
        return HttpResponseForbidden("ê¶Œí•œ ì—†ìŒ")
    post_id = c.post_id
    c.status = Comment.Status.DELETED
    c.save(update_fields=["status"])
    Post.objects.filter(pk=post_id).update(comment_count=F("comment_count")-1)
    cache.delete_pattern(f"post:detail:{post_id}:*")
    return JsonResponse({"ok": True, "comment_count": Post.objects.get(pk=post_id).comment_count})
```

> **ì£¼ì˜**
> - ëŒ“ê¸€ ì‚­ì œëŠ” **ì†Œí”„íŠ¸ ì‚­ì œ**(`status=deleted`)ë¡œ ì²˜ë¦¬ â†’ ë³µêµ¬/ê°ì‚¬ ê°€ëŠ¥.
> - ì¢‹ì•„ìš”ëŠ” **í† ê¸€** ë°©ì‹ìœ¼ë¡œ ë©±ë“±ì— ì‹ ê²½.

---

## F. í…œí”Œë¦¿(ìš”ì•½)

{% raw %}
```html
{# templates/community/post_list.html #}
{% extends "base.html" %}
{% block content %}
<h1>ê²Œì‹œê¸€</h1>
<form method="get"><input type="search" name="q" value="{{ request.GET.q }}"><button>ê²€ìƒ‰</button></form>
<a href="{% url 'community:post_create' %}">ìƒˆ ê¸€</a>
<ul>
{% for p in object_list %}
  <li>
    <a href="{% url 'community:post_detail' p.pk %}">{{ p.title }}</a>
    <small>by {{ p.author }} | {{ p.created_at|date:"Y-m-d H:i" }} | ğŸ’¬ {{ p.comment_count }} | â¤ï¸ {{ p.like_count }}</small>
  </li>
{% empty %}
  <li>ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>
{% endfor %}
</ul>
{% include "partials/pagination.html" %}
{% endblock %}
```
{% endraw %}

{% raw %}
```html
{# templates/community/post_detail.html #}
{% extends "base.html" %}
{% block content %}
<h2>{{ post.title }}</h2>
<p>by {{ post.author }} | ì¡°íšŒìˆ˜ {{ post.view_count }} | â¤ï¸ {{ post.like_count }}</p>
<div class="post-body">{{ post.body|linebreaksbr }}</div>

{% if request.user.is_authenticated %}
  <button id="like-btn" data-liked="{{ liked|yesno:'1,0' }}">â¤ï¸ {{ post.like_count }}</button>
  {% if request.user == post.author or request.user.is_staff %}
    <a href="{% url 'community:post_edit' post.pk %}">ìˆ˜ì •</a>
    <form action="{% url 'community:post_delete' post.pk %}" method="post" style="display:inline">{% csrf_token %}<button>ì‚­ì œ</button></form>
  {% endif %}
{% endif %}

<hr>
<h3>ëŒ“ê¸€ ({{ post.comment_count }})</h3>
{% if request.user.is_authenticated and not post.is_locked %}
<form id="comment-form">{% csrf_token %}
  <textarea name="body" rows="3" maxlength="2000"></textarea>
  <input type="hidden" name="parent" value="">
  <button>ë“±ë¡</button>
</form>
{% elif post.is_locked %}
<p>ì´ ê¸€ì€ ì ê¸ˆë˜ì–´ ëŒ“ê¸€ì„ ë‹¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
{% else %}
<p>ëŒ“ê¸€ì„ ë‹¬ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
{% endif %}

<ul id="comment-list">
{% for c in comments %}
  <li data-id="{{ c.pk }}">
    <b>{{ c.author }}</b> {{ c.body|linebreaksbr }} <small>{{ c.created_at|date:"Y-m-d H:i" }}</small>
    {% if request.user == c.author or request.user.is_staff %}
      <button class="comment-del" data-id="{{ c.pk }}">ì‚­ì œ</button>
    {% endif %}
    {% if children.c.pk %}
      <ul>
      {% for ch in children.c.pk %}
        <li><b>{{ ch.author }}</b> {{ ch.body|linebreaksbr }}</li>
      {% endfor %}
      </ul>
    {% endif %}
  </li>
{% endfor %}
</ul>

<script>
document.getElementById("like-btn")?.addEventListener("click", async (e)=>{
  const res = await fetch("{% url 'community:post_like' post.pk %}", {method:"POST", headers:{"X-CSRFToken":"{{ csrf_token }}"}});
  const j = await res.json(); if(j.liked!==undefined){ e.target.textContent = "â¤ï¸ "+j.like_count; }
});
document.getElementById("comment-form")?.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch("{% url 'community:comment_create' post.pk %}", {method:"POST", headers:{"X-CSRFToken":"{{ csrf_token }}"}, body:fd});
  const j = await res.json();
  if(j.ok){ location.reload(); } else { alert("ì˜¤ë¥˜:"+JSON.stringify(j.errors)); }
});
document.querySelectorAll(".comment-del").forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    const id = btn.dataset.id;
    const res = await fetch("{% url 'community:comment_delete' 0 %}".replace("0", id), {method:"POST", headers:{"X-CSRFToken":"{{ csrf_token }}"}})
    const j = await res.json(); if(j.ok){ location.reload(); }
  })
});
</script>
{% endblock %}
```
{% endraw %}

> í…œí”Œë¦¿ì€ í•µì‹¬ë§Œ ì˜ˆì‹œ. ì‹¤ë¬´ì—ì„  HTMX/Alpine.js/React ë“±ìœ¼ë¡œ ë¶€ë¶„ ì—…ë°ì´íŠ¸ UX ê°œì„  ê¶Œì¥.

---

## G. ìºì‹œ ì„¤ê³„

### G-1. ë ˆì´ì–´

1) **per-view ìºì‹œ**: `@cache_page` (ìƒì„¸/ëª©ë¡)
2) **í…œí”Œë¦¿ í”„ë˜ê·¸ë¨¼íŠ¸ ìºì‹œ**: ì˜ˆ: ëŒ“ê¸€ ë¸”ë¡
3) **Low-level ìºì‹œ**: ì¡°íšŒìˆ˜ ì¤‘ë³µ ë°©ì§€í‚¤, ë¹„ì‹¼ ì¿¼ë¦¬ ê²°ê³¼ ë©”ëª¨

### G-2. ì„¤ì • (django-redis)

```python
# settings.py

CACHES = {
  "default": {
    "BACKEND": "django_redis.cache.RedisCache",
    "LOCATION": "redis://localhost:6379/1",
    "OPTIONS": {"CLIENT_CLASS": "django_redis.client.DefaultClient"}
  }
}
CACHE_MIDDLEWARE_SECONDS = 30
```

### G-3. ìºì‹œ í‚¤ ì „ëµ

- `post:detail:{pk}:u{uid}:p{page}` â€” ì‚¬ìš©ì/í˜ì´ì§€ êµ¬ë¶„
- ë¬´íš¨í™”: **ì“°ê¸° í›„ íŠ¹ì • í‚¤ íŒ¨í„´ ì‚­ì œ**(`delete_pattern`)
- ë†’ì€ ê°±ì‹  ë¹ˆë„ ë°ì´í„°(ì¢‹ì•„ìš” ìˆ˜ ë“±)ëŠ” **ì§§ì€ TTL** ë˜ëŠ” **ì‹¤ì‹œê°„ ë°˜ì˜ + í”„ë˜ê·¸ë¨¼íŠ¸ ìºì‹œ** í˜¼ìš©

### G-4. ëª©ë¡ ìºì‹œ(per-view)

```python
# ëª©ë¡ë„ ê°„ë‹¨íˆ ì ìš© ê°€ëŠ¥

@method_decorator(cache_page(30), name="dispatch")
class PostListView(ListView):
    ...
```

> ê²€ìƒ‰ íŒŒë¼ë¯¸í„°ê°€ ë§ì„ìˆ˜ë¡ ìºì‹œ íŒŒí¸í™” â†’ ìƒìœ„ ì¸ê¸° ëª©ë¡ë§Œ ìºì‹œ, ê²€ìƒ‰ì€ ìƒì¿¼ë¦¬/ESë¡œ.

---

## H. ìŠ¤íŒ¸/ì•…ì„± ì…ë ¥ ë°©ì§€ & ë ˆì´íŠ¸ ë¦¬ë°‹

### H-1. ê°„ë‹¨í•œ ë ˆì´íŠ¸ ë¦¬ë°‹ (ìºì‹œ ì¹´ìš´í„°)

```python
# apps/community/ratelimit.py

from django.core.cache import cache
from django.http import HttpResponseForbidden

def rate_limit(key: str, limit: int, ttl: int = 60):
    cnt = cache.get(key) or 0
    if cnt >= limit:
        return False
    cache.incr(key) if cache.get(key) else cache.set(key, 1, ttl)
    return True

# views.py (ëŒ“ê¸€ ì‘ì„± ì‹œ)

@require_POST
def comment_create(request, pk):
    if not rate_limit(f"rl:cmt:{request.user.id}", limit=10, ttl=60):
        return HttpResponseForbidden("ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.")
    ...
```

### H-2. XSS/ìŠ¤í¬ë¦½íŠ¸ í•„í„°

- Django í…œí”Œë¦¿ ìë™ ì´ìŠ¤ì¼€ì´í”„ ê¸°ë³¸ ì‚¬ìš©
- ë§í¬ í—ˆìš© ì‹œ **bleach** ê°™ì€ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ í•„í„°ë¡œ sanitize ê¶Œì¥

---

## I. ì–´ë“œë¯¼/ìš´ì˜

```python
# apps/community/admin.py

from django.contrib import admin
from .models import Post, Comment, PostLike

@admin.register(Post)
class PostAdmin(admin.ModelAdmin):
    list_display = ("id","title","author","visibility","view_count","comment_count","like_count","created_at","is_locked")
    list_filter = ("visibility","is_locked","created_at")
    search_fields = ("title","body","author__username")
    list_select_related = ("author",)

@admin.register(Comment)
class CommentAdmin(admin.ModelAdmin):
    list_display = ("id","post","author","status","created_at")
    list_filter = ("status","created_at")
    search_fields = ("body","author__username","post__title")
    list_select_related = ("post","author")

@admin.register(PostLike)
class PostLikeAdmin(admin.ModelAdmin):
    list_display = ("id","post","user","created_at")
    list_select_related = ("post","user")
```

> ìš´ì˜ ì ê¸ˆ(`is_locked`)ì€ Adminì—ì„œ í† ê¸€í•˜ì—¬ **ëŒ“ê¸€/ìˆ˜ì • ì°¨ë‹¨**.

---

## J. í…ŒìŠ¤íŠ¸(í•µì‹¬ íë¦„)

```python
# apps/community/tests/test_post_comment.py

import pytest
from django.urls import reverse
from django.contrib.auth import get_user_model
from apps.community.models import Post, Comment

pytestmark = pytest.mark.django_db
User = get_user_model()

def test_post_crud(client):
    u = User.objects.create_user("u","u@x.com","pw")
    client.force_login(u)
    # create
    res = client.post(reverse("community:post_create"), {"title":"hi","body":"hello","visibility":"public"})
    assert res.status_code in (302, 200)
    p = Post.objects.get(title="hi")
    # detail
    res = client.get(reverse("community:post_detail", args=[p.pk]))
    assert res.status_code == 200
    # edit
    res = client.post(reverse("community:post_edit", args=[p.pk]), {"title":"hi2","body":"x","visibility":"public"})
    assert res.status_code in (302, 200)
    p.refresh_from_db(); assert p.title == "hi2"

def test_comment_and_like(client):
    u = User.objects.create_user("u","u@x.com","pw")
    client.force_login(u)
    p = Post.objects.create(author=u, title="t", body="b")
    # like toggle
    res = client.post(reverse("community:post_like", args=[p.pk]))
    assert res.status_code == 200
    p.refresh_from_db(); assert p.like_count == 1
    # comment
    res = client.post(reverse("community:comment_create", args=[p.pk]), {"body":"c"})
    assert res.status_code == 200
    p.refresh_from_db(); assert p.comment_count == 1
    c = Comment.objects.get(post=p)
    # delete
    res = client.post(reverse("community:comment_delete", args=[c.pk]))
    assert res.status_code == 200
    p.refresh_from_db(); assert p.comment_count == 0
```

---

## K. ì„±ëŠ¥ & í™•ì¥ íŒ

1) **N+1 ë°©ì§€**: `select_related("author")`, ëŒ“ê¸€ ëŒ€ëŒ“ê¸€ì€ ë¯¸ë¦¬ í•œ ë²ˆì— ë¡œë“œ
2) **ì¹´ìš´í„° ì •í™•ë„**: ë©€í‹° ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ê²½í•© ì‹œ **F í‘œí˜„ì‹** ì‚¬ìš©(ì´ë¯¸ ë°˜ì˜)
3) **ì¡°íšŒìˆ˜**: ì™„ë²½í•œ ê³ ìœ  ì¹´ìš´íŠ¸ ëŒ€ì‹  **ì„¸ì…˜+TTL** ê·¼ì‚¬(ì‹¤ë¬´ ì¶©ë¶„)
4) **ê²€ìƒ‰**: ë³¸ë¬¸/ì œëª© ê²€ìƒ‰ ë¹ˆë„ ë†’ìœ¼ë©´ **ES ì½ê¸° ëª¨ë¸**ë¡œ ì´ê´€(ì• ì±•í„° ì°¸ê³ )
5) **CDN/ìºì‹œ**: ìƒì„¸ í˜ì´ì§€ëŠ” CDN ì—ì§€ ìºì‹œ TTL ì§§ê²Œ + ì‚¬ìš©ìë³„ ìš”ì†Œ(Ajax)ë¡œ ë‚˜ëˆ ì„œ ë™ì í™”
6) **ë¹„ë™ê¸°í™”(ì˜µì…˜)**: ëŒ“ê¸€/ì¢‹ì•„ìš” í›„ **ì‹¤ì‹œê°„ ì¹´ìš´íŠ¸**ëŠ” Celeryë¡œ ì§€ì—° ë°˜ì˜ë„ ê°€ëŠ¥(ìœ ì € ì‘ë‹µì€ ì¦‰ì‹œ)

---

## L. ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] CSRF ì ìš©(POST ì „ë¶€)
- [ ] ê¶Œí•œ ê²€ì‚¬: ìˆ˜ì •/ì‚­ì œ/ë¹„ê³µê°œ ì—´ëŒ
- [ ] í…œí”Œë¦¿ ìë™ ì´ìŠ¤ì¼€ì´í”„, í—ˆìš© íƒœê·¸ë§Œ sanitize
- [ ] ì—…ë¡œë“œ(ë§Œì•½ ì¶”ê°€ ì‹œ) MIME/í™•ì¥ì ê²€ì¦ + ë°”ì´ëŸ¬ìŠ¤ ìŠ¤ìº”
- [ ] ë ˆì´íŠ¸ ë¦¬ë°‹/ë´‡ ë°©ì§€(ìº¡ì°¨, reCAPTCHA v3 ë“±)
- [ ] ê°ì‚¬ ë¡œê·¸(ìš´ì˜ì ì‚­ì œ/ìˆ¨ê¹€ ê¸°ë¡) í•„ìš” ì‹œ ë¯¸ë“¤ì›¨ì–´ ì¶”ê°€

---

## M. ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸(ìš”ì•½)

- [ ] `django-redis` ì—°ê²° OK, ìºì‹œ í‚¤ TTL/ë©”ëª¨ í™•ì¸
- [ ] DB ì¸ë±ìŠ¤: `Post.created_at`, `visibility`, `author`
- [ ] í—¬ìŠ¤ì²´í¬/ë¡œê¹…: 5xx, ì‘ë‹µì‹œê°„, DB ì»¤ë„¥ì…˜, Redis ì—°ê²°
- [ ] ì •ì /ë¯¸ë””ì–´: CDN or Nginxì—ì„œ ì²˜ë¦¬
- [ ] ë°±ì—…: DB dump, ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸

---

## N. í™•ì¥ ê³¼ì œ(ë‹¤ìŒ ë‹¨ê³„)

- **ì‹ ê³ (Report)**/ë¸”ë¡/í•„í„°ë§ ì›Œí¬í”Œë¡œìš°
- **ëª¨ë”ë ˆì´ì…˜ í** + ê·œì¹™ ì—”ì§„(ìš•ì„¤/ìŠ¤íŒ¸)
- **ì•Œë¦¼**: ëŒ“ê¸€/ë©˜ì…˜/ì¢‹ì•„ìš” ì´ë²¤íŠ¸(Email/WebPush/WebSocket)
- **íƒœê·¸/ì¹´í…Œê³ ë¦¬** + íŠ¸ë Œë”©(ìºì‹œ/ë°°ì¹˜)
- **ëª¨ë°”ì¼ ì¹œí™” UI**(HTMX/Alpine/React)

---

## O. ìš”ì•½

- ë³¸ ë¯¸ë‹ˆ í”„ë¡œì íŠ¸ëŠ” **ê²Œì‹œê¸€Â·ëŒ“ê¸€ CRUD**ì— **ê¶Œí•œ**ê³¼ **ìºì‹œ ì „ëµ**ì„ ë”í•´ **í˜„ì‹¤ì ì¸ ìš´ì˜ ê¸°ì¤€**ì„ ê°–ì¶˜ ì»¤ë®¤ë‹ˆí‹°ì˜ ê³¨ê²©ì…ë‹ˆë‹¤.
- **per-view + low-level ìºì‹œ**, **F-í‘œí˜„ì‹ ì¹´ìš´í„°**, **ê¶Œí•œ/ì ê¸ˆ/ë ˆì´íŠ¸ë¦¬ë°‹**ì„ í‘œì¤€ íŒ¨í„´ìœ¼ë¡œ ì ìš©í•˜ë©´ ì‘ì€ ê·œëª¨ì—ì„œë„ **ë¹ ë¥´ê³  ì•ˆì „**í•©ë‹ˆë‹¤.
- ê²€ìƒ‰/ì•Œë¦¼/ëª¨ë”ë ˆì´ì…˜ ë“±ì€ **CQRS/Outbox/ES/ì‚¬ê°€**ë¡œ ì ì§„ í™•ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.
