---
layout: post
title: WPF - 배포 & 런타임
date: 2025-09-12 15:25:23 +0900
category: WPF
---
# WPF 배포 및 런타임 전략 완전 가이드

이 문서는 WPF 애플리케이션을 실전에 배포하기 위한 세 가지 핵심 전략을 상세히 다룹니다: **ClickOnce 배포**, **.NET 5 이상에서의 WPF 개발**, 그리고 **단일 실행 파일(Single-file) 및 Self-contained 배포** 방식입니다. Visual Studio와 `dotnet` CLI 사용법, `csproj` 설정 예제, 서명, 업데이트, 서버 배포, 런타임 식별자(RID), 트리밍, ReadyToRun, ARM64 지원, 제한사항 및 문제 해결까지 모두 포함합니다.

## 배포 전략 개요: 주요 선택지 비교

WPF 애플리케이션을 배포할 때는 다음과 같은 주요 옵션을 고려할 수 있습니다.

*   **ClickOnce**:
    *   **장점**: 간편한 자동 업데이트와 증분 배포, 관리자 권한 없이 사용자 단위 설치(Per-user) 가능, 문제 발생 시 롤백이 쉬움.
    *   **적합한 상황**: 웹 서버, 파일 공유(UNC)를 통해 배포하고 자동 업데이트 채널이 필요한 경우. 엔터프라이즈(사내망) 환경에서 특히 유리합니다.
*   **MSI/MSIX**:
    *   **MSI** (예: WiX Toolset): 레지스트리 설정, 서비스 설치, 드라이버 설치 등 복잡한 설치 작업이 필요한 전통적인 설치 관리자입니다.
    *   **MSIX**: 현대적인 패키징 및 샌드박싱, 자동 업데이트를 제공합니다. Microsoft Store나 사내 배포에 적합합니다.
*   **단일 실행 파일 (Single-file) / Self-contained**:
    *   **장점**: .NET 런타임을 애플리케이션에 포함시켜 대상 컴퓨터에 별도의 .NET 설치가 필요 없습니다. 이식성이 매우 높습니다.
    *   **구성**: `PublishSingleFile`, `SelfContained`, `RuntimeIdentifier` 설정의 조합으로 구현합니다. 업데이트는 자체 메커니즘(ClickOnce와 결합 가능)으로 처리해야 합니다.

이 가이드는 주로 **ClickOnce**와 **Self-contained/Single-file** 배포에 초점을 맞추며, **.NET 5 이상에서 WPF를 개발하는 필수 설정**을 함께 설명합니다.

---

# .NET 5 이상에서의 WPF 개발

## 프로젝트 기본 구성

### csproj 파일 기본 구조
```xml
<Project Sdk="Microsoft.NET.Sdk.WindowsDesktop">
  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net8.0-windows</TargetFramework>
    <UseWPF>true</UseWPF>
    <!-- 필요 시 최소 OS 버전 지정 -->
    <!-- <TargetFramework>net8.0-windows10.0.19041.0</TargetFramework> -->
  </PropertyGroup>
</Project>
```

### 플랫폼 대상 (Platform Target)
`win-x64`, `win-x86`, `win-arm64` 등의 런타임 식별자(RuntimeIdentifier, RID)를 사용합니다.
*   **ARM64** 배포: `RuntimeIdentifier`를 `win-arm64`로 설정하여 별도로 게시(Publish)합니다.
*   **Self-contained** 또는 단일 파일 배포 시에는 RID 지정이 **필수**입니다.
    ```xml
    <PropertyGroup>
      <RuntimeIdentifier>win-x64</RuntimeIdentifier>
      <!-- 여러 RID: <RuntimeIdentifiers>win-x64;win-arm64</RuntimeIdentifiers> -->
    </PropertyGroup>
    ```

## .NET 5 이상 WPF의 주요 특징 및 이점
*   **WindowsDesktop SDK**: WPF와 WinForms가 포함된 통합 SDK입니다.
*   **성능 개선**: 최신 C#, JIT 컴파일러, 가비지 컬렉터(GC) 및 진단 도구의 향상을 활용할 수 있습니다.
*   **ReadyToRun 지원**: 사전 컴파일된 네이티브 코드로 애플리케이션 시작 성능을 개선할 수 있습니다.
*   **Single-file/Self-contained 배포**: 아래에서 자세히 설명하는 강력한 배포 모델을 완전히 지원합니다.

**중요 참고사항**: WPF는 현재 **NativeAOT** 컴파일 대상이 아닙니다. WPF는 JIT 컴파일, 리플렉션, COM 및 Win32 상호 운용에 크게 의존합니다.

---

# ClickOnce 배포 (WPF on .NET 5+ 포함)

## ClickOnce를 선택하는 시나리오
*   사용자 또는 현장 PC에 **관리자 권한 없이** 애플리케이션을 배포하고 자동 업데이트가 필요한 경우.
*   **사내망, 내부 웹 서버, 파일 공유** 등을 통해 손쉽게 배포 채널을 운영하고자 하는 경우.
*   애플리케이션이 **사용자 단위 설치**에 적합한 경우 (레지스트리나 시스템 서비스 설치 등 고급 설치 작업은 부적합).

## Visual Studio를 이용한 ClickOnce 설정 (요약)
1.  **프로젝트 속성** → **게시(Publish)** → **ClickOnce** 선택.
2.  **설치 모드**: 온라인 전용(웹에서 실행) vs 오프라인 가능(바탕화면/시작 메뉴에 설치).
3.  **게시 위치**:
    *   **웹 서버**(HTTP/HTTPS): 웹 서버에 파일을 복사합니다.
    *   **파일 공유**(SMB/UNC): 네트워크 공유 폴더를 사용합니다.
    *   **로컬 폴더**: 이후 수동으로 외부 위치에 복사/배포합니다.
4.  **자동 업데이트**: 애플리케이션 시작 시 업데이트 확인 (업데이트 URL 지정).
5.  **서명(Signing)**: **배포 매니페스트에 인증서 서명** 및 타임스탬프 서버 설정.
6.  **필수 구성 요소**: .NET Desktop Runtime 등 (.NET 5+에서 Self-contained가 아닌 경우 대상 PC에 런타임이 사전 설치되어 있어야 함).

Visual Studio 2019/2022의 **ClickOnce 게시 프로필(Publish Profile)**을 사용하면 이후 빌드 자동화가 용이해집니다.

## .NET 5+ 프로젝트에서 ClickOnce 설정 (csproj / CLI)

### csproj 예시 (필수 속성)
```xml
<PropertyGroup>
  <TargetFramework>net8.0-windows</TargetFramework>
  <UseWPF>true</UseWPF>

  <!-- ClickOnce 관련 속성 -->
  <GenerateManifests>true</GenerateManifests>
  <PublishProtocol>ClickOnce</PublishProtocol>
  <PublishDir>$(MSBuildProjectDirectory)\publish\clickonce\</PublishDir>
  <Install>true</Install>                        <!-- 오프라인 설치 가능 -->
  <CreateDesktopShortcut>true</CreateDesktopShortcut>
  <PublisherName>내 회사</PublisherName>
  <ProductName>내 WPF 앱</ProductName>
  <ApplicationRevision>1</ApplicationRevision>
  <ApplicationVersion>1.0.0.*</ApplicationVersion> <!-- *: 빌드 시 자동 증가 -->
  <UpdateEnabled>true</UpdateEnabled>
  <UpdateMode>Foreground</UpdateMode>            <!-- 앱 시작 시 업데이트 확인 -->
  <UpdateInterval>1</UpdateInterval>
  <UpdateIntervalUnits>Days</UpdateIntervalUnits>
  <UpdateUrl>https://인트라넷.예제.com/app/</UpdateUrl>
</PropertyGroup>
```

### CLI를 이용한 게시
```bash
# 게시 프로필 사용
dotnet publish -c Release /p:PublishProfile=ClickOnceProfile

# 또는 csproj 속성 기반
dotnet publish -c Release
```
**팁**: `PublishDir`(게시 디렉터리)를 최종 웹 서버 또는 파일 공유의 루트와 일치시키거나, CI/CD 파이프라인에서 게시된 파일을 업로드/미러링하는 단계를 추가하세요.

## 서명(Signing)
*   **배포 매니페스트**는 **인증서로 서명**되어 무결성과 신뢰성을 보장받아야 합니다.
*   **자체 서명 인증서**는 개발/테스트용으로, **공인 코드 서명 인증서**는 운영 환경에 권장됩니다.
*   인증서 만료 또는 교체 시 사용자에게 신뢰 경고가 표시될 수 있으므로 **타임스탬프 서버**를 반드시 설정하세요.

Visual Studio UI 또는 `csproj`에서 설정:
```xml
<PropertyGroup>
  <ManifestCertificateThumbprint>‎‎0011223344AABBCCDDEEFF...</ManifestCertificateThumbprint>
  <ManifestCertificateStoreName>My</ManifestCertificateStoreName>
  <ManifestTimestampUrl>http://timestamp.digicert.com</ManifestTimestampUrl>
</PropertyGroup>
```

## 데이터 및 설정 파일 관리 (업데이트 시 안전하게)
ClickOnce는 애플리케이션 파일을 **프로그램 캐시**에 읽기 전용으로 관리합니다. 사용자가 생성하거나 수정하는 데이터/설정 파일은 다음 위치에 저장해야 업데이트 시 덮어쓰지 않습니다.
*   `ApplicationDeployment.CurrentDeployment.DataDirectory`
*   또는 `%LOCALAPPDATA%` 하위의 사용자 전용 폴더

```csharp
if (ApplicationDeployment.IsNetworkDeployed)
{
    var dataDir = ApplicationDeployment.CurrentDeployment.DataDirectory;
    var userSettingsPath = Path.Combine(dataDir, "user-settings.json");
    // 설정 파일 로드/저장
}
```

## ClickOnce와 Self-contained 결합 가능성
.NET 5+부터 ClickOnce와 Self-contained 배포를 결합하는 것이 **기술적으로 가능**합니다. 그러나 런타임을 포함하므로 배포 패키지 크기가 크게 증가하고, 업데이트 시 다운로드해야 할 데이터 양도 늘어납니다. 일반적으로 사내망처럼 네트워크 대역폭이 충분하거나 대상 PC에 런타임 설치가 어려운 환경에서 고려해볼 수 있습니다.

```xml
<PropertyGroup>
  <SelfContained>true</SelfContained>
  <RuntimeIdentifier>win-x64</RuntimeIdentifier>
</PropertyGroup>
```

## 일반적인 문제 및 해결 방법
| 문제 | 가능한 원인 | 해결 방안 |
| :--- | :--- | :--- |
| 설치/업데이트 시 신뢰 경고 | 서명 인증서 불신, 게시 URL 신뢰 부족 | 공인 인증서 사용, 타임스탬프 서버 설정, 사내 정책에 도메인 등록 |
| “구성 요소 없음(.NET)” 오류 | Framework Dependent 배포인데 대상 PC에 런타임 없음 | **Self-contained**로 배포하거나, 대상 PC에 .NET Desktop Runtime 사전 설치 |
| 업데이트 후 사용자 설정 초기화 | 설정 파일이 애플리케이션 폴더에 저장되어 업데이트 시 교체됨 | 데이터는 **DataDirectory** 또는 **로밍 AppData** 폴더에 분리 저장 |
| 파일 다운로드 실패 | 프록시, 백신 소프트웨어, 파일 권한 문제 | 네트워크/보안 정책 조율, 예외(화이트리스트) 등록 |
| 웹 서버에 배포 후 클릭 시 404 | MIME 타입 미설정, 폴더 구조 오류, 파일 누락 | 게시 폴더 전체 업로드, `*.application` 및 `*.manifest` 파일에 대한 MIME 타입 확인 |

---

# 단일 실행 파일(Single-file) 및 Self-contained 배포

## 개념 정의
*   **Self-contained**: .NET 런타임을 애플리케이션에 포함시킵니다. 대상 컴퓨터에 .NET이 설치되어 있지 않아도 실행 가능합니다.
*   **Single-file**: 빌드 출력물을 **단일 실행 파일(EXE) 하나**로 압축하여 배포합니다. (.NET 6 이상에서는 내부 파일을 앱 시작 시 임시 폴더에 압축 해제하는 방식으로 동작)
*   **Framework-dependent (FDD)**: 대상 컴퓨터에 **.NET 런타임이 설치되어 있어야 합니다**. 애플리케이션 패키지 자체는 가볍습니다.

## 권장 설정 (csproj)
```xml
<Project Sdk="Microsoft.NET.Sdk.WindowsDesktop">
  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net8.0-windows</TargetFramework>
    <UseWPF>true</UseWPF>

    <!-- Self-contained: 런타임 포함 -->
    <SelfContained>true</SelfContained>
    <RuntimeIdentifier>win-x64</RuntimeIdentifier>  <!-- win-arm64 등 -->

    <!-- Single-file: 단일 실행 파일 생성 -->
    <PublishSingleFile>true</PublishSingleFile>
    <IncludeAllContentForSelfExtract>true</IncludeAllContentForSelfExtract>
    <EnableCompressionInSingleFile>true</EnableCompressionInSingleFile>

    <!-- (선택) ReadyToRun: 시작 성능 개선 (파일 크기 증가) -->
    <PublishReadyToRun>true</PublishReadyToRun>

    <!-- (주의) 트리밍: WPF는 리플렉션 의존도가 높아 기본적으로 비활성화 권장 -->
    <PublishTrimmed>false</PublishTrimmed>
  </PropertyGroup>
</Project>
```

### CLI를 이용한 게시
```bash
# 릴리스 빌드 + 단일 실행 파일 + Self-contained
dotnet publish -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true

# ReadyToRun 포함
dotnet publish -c Release -r win-x64 --self-contained true \
  /p:PublishSingleFile=true /p:PublishReadyToRun=true
```

**트리밍에 관한 중요 경고**: WPF 및 .NET Framework 내부는 리플렉션과 동적 로딩을 광범위하게 사용합니다. `PublishTrimmed=true`를 설정하면 런타임에 예기치 않은 오류가 발생할 위험이 매우 높습니다. **일반 WPF 애플리케이션은 `PublishTrimmed=false`로 유지하는 것을 강력히 권장합니다.**

## Single-file 배포의 제약사항 및 고려사항
*   **네이티브/COM 의존 DLL**: 일부 DLL은 외부 파일로 유지되거나 압축 해제 후 로드될 수 있습니다.
*   **임시 폴더 추출**: 실행 시 파일을 임시 폴더에 압축 해제합니다. 파일 경로에 의존하는 코드가 있다면 `AppContext.BaseDirectory`를 사용하세요.
*   **보안 소프트웨어 영향**: 일부 백신/스캐너가 압축 해제 과정을 검사하여 시작 속도를 저하시킬 수 있습니다. 기업 환경에서는 화이트리스트 등록이 필요할 수 있습니다.
*   **시작 성능**: 첫 실행이 느리다면 `PublishReadyToRun=true` 설정으로 개선할 수 있지만, 이 경우 파일 크기가 증가하고 빌드 시간이 늘어납니다.

## 다중 아키텍처 빌드 (예: x64 + ARM64)
서로 다른 CPU 아키텍처를 지원하려면 각 `RuntimeIdentifier`에 대해 별도로 게시(Publish)해야 합니다. 출력 폴더를 구분하여 관리하고, 배포 파이프라인에서 사용자의 플랫폼을 자동 감지하도록 구성할 수 있습니다.

```bash
# x64 용 게시
dotnet publish -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true

# ARM64 용 게시
dotnet publish -c Release -r win-arm64 --self-contained true /p:PublishSingleFile=true
```

---

# 실전 배포 구성 예시

## 시나리오 1: ClickOnce (Framework-dependent, 작은 크기)
```xml
<PropertyGroup>
  <TargetFramework>net8.0-windows</TargetFramework>
  <UseWPF>true</UseWPF>
  <PublishProtocol>ClickOnce</PublishProtocol>
  <GenerateManifests>true</GenerateManifests>
  <Install>true</Install>
  <UpdateEnabled>true</UpdateEnabled>
  <UpdateUrl>https://deploy.mycorp.local/myapp/</UpdateUrl>
  <!-- Framework-dependent: 대상 PC에 .NET 런타임 필요 -->
  <SelfContained>false</SelfContained>
</PropertyGroup>
```

## 시나리오 2: ClickOnce (Self-contained, 런타임 포함)
```xml
<PropertyGroup>
  <PublishProtocol>ClickOnce</PublishProtocol>
  <GenerateManifests>true</GenerateManifests>
  <Install>true</Install>
  <UpdateEnabled>true</UpdateEnabled>
  <UpdateUrl>https://deploy.mycorp.local/myapp/</UpdateUrl>
  <SelfContained>true</SelfContained>
  <RuntimeIdentifier>win-x64</RuntimeIdentifier>
  <!-- ClickOnce는 일반적으로 다중 파일 배포 방식을 사용 -->
  <PublishSingleFile>false</PublishSingleFile>
</PropertyGroup>
```

## 시나리오 3: 단일 실행 파일 (Self-contained, ClickOnce 미사용)
```xml
<PropertyGroup>
  <SelfContained>true</SelfContained>
  <RuntimeIdentifier>win-x64</RuntimeIdentifier>
  <PublishSingleFile>true</PublishSingleFile>
  <EnableCompressionInSingleFile>true</EnableCompressionInSingleFile>
  <PublishReadyToRun>true</PublishReadyToRun>
  <PublishTrimmed>false</PublishTrimmed>
</PropertyGroup>
```

---

# 보안 및 신뢰 관리
*   **코드 서명 (Authenticode)**: 실행 파일(EXE)과 라이브러리(DLL)에 서명하면 Windows SmartScreen, 백신 소프트웨어, 엔드포인트 보안 솔루션에서의 신뢰도를 높일 수 있습니다.
*   **ClickOnce 서명**: 배포 매니페스트에 대한 인증서 서명이 필수입니다.
*   **사내 정책**: Active Directory 그룹 정책을 통해 **신뢰할 수 있는 게시자**로 등록할 수 있습니다.
*   **타임스탬프**: 인증서가 만료된 후에도 서명 당시의 유효성을 증명할 수 있도록 타임스탬프 서버를 설정하세요.

---

# 업데이트 전략 비교
*   **ClickOnce**: 애플리케이션 시작 시 자동으로 업데이트를 확인하고, 증분 업데이트 및 롤백을 내장 지원합니다.
*   **단일 실행 파일 (자체 구현)**:
    *   애플리케이션 내부에서 업데이트 서버(REST API 등)를 폴링하여 새 버전 여부를 확인합니다.
    *   새 버전의 실행 파일을 다운로드하고, SHA256 해시 등을 검증한 후 안전하게 교체합니다. (실행 중인 EXE 파일을 교체하는 것은 까다로울 수 있으므로 별도의 "업데이터" 프로세스를 사용하는 것이 일반적)

---

# WPF 특화 고려사항 (.NET 5+)
*   **High DPI 지원**: `app.manifest` 파일에서 `PerMonitorV2` DPI 인식 모드를 선언하고, WPF 앱 수준 설정(`EnableMultiMonitorHighDpi` 등)을 확인하세요.
*   **Windows 10+ 특정 API**: Target Framework Moniker (TFM)에 최소 OS 버전(예: `net8.0-windows10.0.19041.0`)을 명시하면 해당 API에 대한 컴파일 타임 가드를 활용할 수 있습니다.
*   **네이티브/COM 의존성**: P/Invoke로 호출하는 네이티브 DLL은 프로젝트에서 **출력 디렉터리로 복사**되도록 설정(`CopyToOutputDirectory`)해야 합니다.
*   **파일 경로**: ReadyToRun 또는 단일 파일 배포 시 리소스 접근에는 `AppContext.BaseDirectory`를 사용하세요.

---

# 자주 묻는 질문 (FAQ) 및 문제 해결

**Q1. 단일 파일로 게시했는데 실행 파일 옆에 여러 파일이 생성됩니다.**
A: 네이티브 라이브러리, 리소스, COM 구성 요소 등은 기술적 제약으로 인해 외부 파일로 남을 수 있습니다. `IncludeAllContentForSelfExtract=true` 설정으로 최대한 포함시킬 수 있으나, 100% 단일 파일화는 어려울 수 있습니다.

**Q2. Single-file 앱의 첫 실행이 매우 느립니다.**
A: `PublishReadyToRun=true` 설정으로 사전 컴파일된 코드를 사용해 시작 속도를 개선해 보세요. 또한, `EnableCompressionInSingleFile=true` 설정은 파일 크기를 줄이지만 압축 해제 오버헤드로 인해 시작이 약간 더 느려질 수 있습니다. 백신 소프트웨어의 실시간 검사 영향도 크므로 화이트리스트 등록을 고려하세요.

**Q3. WPF 앱에 트리밍(PublishTrimmed)을 적용해도 안전한가요?**
A: **일반적으로 권장하지 않습니다.** WPF는 데이터 바인딩, 리소스 딕셔너리, XAML 파싱 등에서 광범위하게 리플렉션을 사용하므로, 트리밍 과정에서 필요한 코드가 잘려 나가 런타임 오류가 발생할 위험이 큽니다. 특정 라이브러리에 대한 트리밍이 꼭 필요하다면 `TrimmerRootDescriptor`를 이용한 세밀한 제어가 필요합니다.

**Q4. ClickOnce로 배포한 앱의 환경설정 파일이 업데이트될 때마다 초기화됩니다.**
A: 설정 파일을 애플리케이션 설치 폴더가 아닌 **`ApplicationDeployment.CurrentDeployment.DataDirectory`** 또는 **`Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData)`** 경로에 저장하도록 코드를 수정하세요.

**Q5. ARM64 Windows 장치도 지원하고 싶습니다.**
A: `-r win-arm64` 매개 변수를 사용하여 ARM64용으로 별도로 게시하세요. 배포 웹 페이지나 설치 프로그램에서 사용자가 자신의 아키텍처에 맞는 버전을 선택할 수 있도록 UI를 제공해야 합니다.

---

# 결론: 배포 전략 선택 가이드

WPF 애플리케이션의 배포 전략은 조직의 인프라, 대상 사용자, 유지보수 요구사항에 따라 신중히 선택해야 합니다.

1.  **ClickOnce 배포**는 "설치 간소화 + 자동 업데이트 + 안전한 롤백"이 핵심 요구사항인 **사내 업무용 애플리케이션**이나 **현장 배포** 시나리오에서 여전히 매우 효과적인 솔루션입니다. 사용자 PC에 대한 관리 권한이 제한된 환경에서의 배포와 업데이트 관리 부담을 크게 줄여줍니다.

2.  **.NET 5 이상의 WPF**는 개발자에게 최신 언어 기능과 런타임 성능 향상을 제공하면서도 기존의 풍부한 XAML 생태계와 도구 지원을 그대로 유지합니다. **WindowsDesktop SDK**는 현대적인 .NET 플랫폼으로의 원활한 이전 경로를 제공합니다.

3.  **Self-contained + Single-file 배포**는 최대한의 **이식성**과 **배포 단순성**을 추구할 때 강력한 옵션입니다. 특히 대상 환경에 .NET 런타임을 설치할 수 없거나, 설치 프로세스를 극도로 단순화해야 하는 경우(예: USB 드라이브 실행, 즉시 사용 배포)에 이상적입니다. 단, 파일 크기 증가와 자체적인 업데이트 메커니즘 구현 필요성은 트레이드오프로 고려해야 합니다.

최종 선택은 애플리케이션의 특성, 사용자 베이스, IT 인프라, 장기적인 유지보수 계획을 종합적으로 평가하여 내려야 합니다. 이 문서에 제시된 세부 설정과 고려사항들이 그 결정에 실질적인 도움이 되기를 바랍니다.