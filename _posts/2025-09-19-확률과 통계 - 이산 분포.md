---
layout: post
title: 확률과 통계 - 이산 분포
date: 2025-09-19 16:25:23 +0900
category: 확률과 통계
---
# 3. 이산 분포

> **목표**
> - **베르누이 → 이항 → 포아송 → 하이퍼지오메트릭**의 **관계**를 일관되게 이해한다.
> - 웹/앱 맥락에서 **전환 수(이항)**, **희귀 이벤트 카운트(포아송)**, **중복 없이 샘플링(하이퍼지오메트릭)**을 정확히 적용한다.
> - **근사 조건**(특히 *노출 수 n*이 크고 *p*가 작은 상황의 포아송 근사)을 수식과 예제로 검증한다.
> - **함정**: 독립성 위반(같은 사용자의 반복노출), 이질적 확률(*p*가 사용자마다 다름), 과산포/언더디스퍼전, 분모 랜덤성(노출 수 자체의 변동).

---

## 0. 큰 그림 — 하나의 “성공/실패”에서 모든 것이 출발
- **베르누이(Bernoulli)**: 한 번의 시행에서 “클릭/전환(1)” 또는 “비전환(0)”.
- **이항(Binomial)**: **동일한 확률 p**로 **독립** 베르누이 시행을 **n번** 반복 → “총 전환 수” $$X=\sum_{i=1}^n \text{Bern}(p)$$.
- **포아송(Poisson)**: “아주 작고 드문 사건”을 **시간/노출 단위**로 셈. **이항의 극한**(n→∞, p→0, λ=np 고정).
- **하이퍼지오메트릭(Hypergeometric)**: 유한 집단에서 **복원 없음** 샘플링. “풀에서 사용자 n명을 뽑을 때 성공 K개 포함 확률”.

> 실전 감각
> - **전환 수**: 보통 **이항**.
> - **오류 로그/희귀 이벤트**: 자주 **포아송**.
> - **중복 금지 추출(쿠폰/테스트군 선정)**: **하이퍼지오메트릭**.
> - 같은 사용자에게 **여러 노출**이 섞이면 독립성/동일성 가정이 깨지므로 주의(→ *Poisson-binomial*, *NB* 등으로 확장 고려).

---

## 1. 베르누이 — 한 번의 클릭/전환

### 1.1 정의와 성질
- $$X\sim \mathrm{Bernoulli}(p),\quad P(X=1)=p,\ P(X=0)=1-p$$
- $$E[X]=p,\quad \mathrm{Var}(X)=p(1-p)$$

### 1.2 웹/앱 예
- “**한 사용자**가 오늘 **전환**했는가?”(1/0)
- “**한 노출**이 **클릭**으로 이어졌는가?”(1/0)

### 1.3 실무 포인트
- 베르누이를 **집계**하면 이항·포아송 등으로 바뀐다.
- 동일한 *p* 가정이 안 맞으면(사용자별 성향이 다름) → **Poisson-binomial**(각기 다른 $$p_i$$).

---

## 2. 이항 — n번의 베르누이를 더한 “총 전환 수”

### 2.1 정의
- $$X\sim \mathrm{Binomial}(n,p)$$
- **PMF**:
  $$P(X=k)=\binom{n}{k}p^k(1-p)^{n-k},\quad k=0,1,\dots,n$$
- **기대/분산**:
  $$E[X]=np,\quad \mathrm{Var}(X)=np(1-p)$$

### 2.2 웹/앱 예
- **전환 수**: n=노출(또는 유저 수), p=전환확률 → “금일 전체 전환 수” $$X$$.
- **CTR**: $$\hat p=\frac{X}{n}$$ 의 분산은 $$\frac{p(1-p)}{n}$$.

### 2.3 합성·분할
- **합성**: 독립이면 $$X_1\sim \mathrm{Bin}(n_1,p),\ X_2\sim \mathrm{Bin}(n_2,p) \Rightarrow X_1+X_2\sim \mathrm{Bin}(n_1+n_2,p)$$
- **분할**(thinning): $$X\sim \mathrm{Bin}(n,p),\ Y\mid X\sim \mathrm{Bin}(X,q)\Rightarrow Y\sim \mathrm{Bin}(n,pq)$$

### 2.4 예제(CTR 비교)
- A: $$n_A=100{,}000,\ \hat p_A=0.030\Rightarrow X_A=3{,}000$$
- B: $$n_B=120{,}000,\ \hat p_B=0.031\Rightarrow X_B=3{,}720$$
- **총 CTR**(비율의 비율): $$\hat p_{\text{tot}}=\frac{X_A+X_B}{n_A+n_B}=\frac{6720}{220000}\approx 3.055\%$$
  (단순 평균(3.05%)과 매우 비슷하지만, **항상 가중합**을 써야 정확!)

---

## 3. 포아송 — 희귀 사건의 카운트(시간·노출 단위)

### 3.1 정의
- $$X\sim \mathrm{Pois}(\lambda)$$
- **PMF**:
  $$P(X=k)=e^{-\lambda}\frac{\lambda^k}{k!},\quad k=0,1,\dots$$
- **기대/분산**:
  $$E[X]=\lambda,\quad \mathrm{Var}(X)=\lambda$$
  (평균=분산)

### 3.2 과정 관점
- “단위 시간/노출 동안 발생하는 **드문 사건**”의 개수.
- **초기 가정**: 독립 발생, 겹침 없음, 평균 비율 일정(균일성).
- **합성**(superposition): 독립 포아송(λ₁, λ₂, …)의 합은 포아송(λ₁+λ₂+…).
- **희석**(thinning): 각 사건을 확률 q로 “채택” → 포아송(qλ).

### 3.3 이항의 극한으로서 포아송
- $$X_n\sim \mathrm{Bin}(n,p_n),\ np_n\to \lambda\ (n\to\infty) \Rightarrow X_n\Rightarrow \mathrm{Pois}(\lambda)$$
- 직관: n이 크고 p가 작아 **희귀하지만 기회는 많다** → 총 기대 λ는 유한.

### 3.4 웹/앱 예
- **오류 로그**(HTTP 5xx) 카운트/분: $$X\sim \mathrm{Pois}(\lambda)$$
- **광고 희귀 클릭**: 매우 낮은 p와 큰 노출 n에서, 총 클릭 수를 포아송으로 근사(단, campaign별 p 차이가 크면 주의).

### 3.5 수치 예(오류 로그)
- 최근 1분당 평균 오류 0.8건이라면 $$X\sim \mathrm{Pois}(0.8)$$
  - **1분에 오류 3건 이상**:
    $$P(X\ge 3)=1-\sum_{k=0}^2 e^{-0.8}\frac{0.8^k}{k!}$$
  - 모니터링 알람 임계값 설정에 직접 사용 가능.

---

## 4. 하이퍼지오메트릭 — 복원 없는 추출(유한집단)

### 4.1 정의
- **모수**: 전체 크기 $$N$$, 그중 “성공”의 수 $$K$$, 뽑기 횟수 $$n$$
- $$X\sim \mathrm{Hypergeom}(N,K,n)$$
- **PMF**:
  $$P(X=k)=\frac{\binom{K}{k}\binom{N-K}{n-k}}{\binom{N}{n}},\quad \max(0,n-(N-K))\le k\le \min(n,K)$$
- **기대/분산**:
  $$E[X]=n\frac{K}{N}$$
  $$\mathrm{Var}(X)=n\frac{K}{N}\left(1-\frac{K}{N}\right)\underbrace{\frac{N-n}{N-1}}_{\text{FPC}}$$
  (FPC=Finite Population Correction)

### 4.2 웹/앱 예
- **중복 금지 샘플링**: 오늘 **N명의 후보** 중 **n명**을 **A/B로 균등 추출**(한 번만 노출).
- **쿠폰 배포**: 전체 10만 명 중 5천 명에게만 1회 쿠폰. 쿠폰 보유자 중 전환 수의 분포는 *(N, K, n)*로 모델링 가능.

### 4.3 Binomial vs Hypergeometric
- **Binomial**: “복원 **있음**”(또는 모집단이 매우 큼) → 각 시행이 독립, p 일정.
- **Hypergeometric**: “복원 **없음**” → 시행 간 **종속**(뽑을수록 남은 성공이 줄어듦).
- **근사 조건**: 표본비율이 아주 작을 때(일반적으로 $$n/N\lesssim 0.05$$), Hypergeom ≈ Bin(n, K/N).

---

## 5. 관계도 한 장 요약

- **베르누이** → “한 번의 성공/실패”.
- **이항** = “베르누이 n번 합” (독립·동일 p).
- **포아송** ≈ “이항의 희귀사건 극한” (n↑, p↓, λ=np).
- **하이퍼지오메트릭** = “복원 없는” 이항 (유한집단, 표본비율 큼).
- **근사**
  - Hypergeom → Bin: $$\frac{n}{N}\small\ \text{작을 때}$$
  - Bin → Pois: $$n\ \text{큼},\ p\ \text{작음},\ \lambda=np\ \text{유한}$$
  - Bin → Normal: $$np,\ n(1-p)\gtrsim 5\!\sim\!10$$ (연속성 보정 권장)

---

## 6. 예제 A — “전환 수”의 이항 모델과 보고

### 6.1 상황
- 오늘 **노출 n=200{,}000**, 전환확률 p=0.012(=1.2%). 전환 수 $$X\sim \mathrm{Bin}(200k, 0.012)$$.

### 6.2 기대·표준편차
- $$E[X]=2400,\ \mathrm{Var}(X)=n p(1-p)\approx 200000\times 0.012\times 0.988\approx 2371.2$$
- $$\mathrm{SD}(X)\approx 48.69$$

### 6.3 확률 계산
- **전환 수가 2500 이상일 확률**(정규 근사+연속성 보정):
  - $$Z=\frac{2499.5-2400}{48.69}\approx 2.04\Rightarrow P(X\ge 2500)\approx 0.0206$$
- **보고 문장**
  - “금일 전환 수의 기대는 2400, 표준편차 48.7. 2500+ 발생 확률은 약 2.1%.”

---

## 7. 예제 B — 희귀 이벤트(오류 로그)의 포아송 근사

### 7.1 조건
- 분당 노출 n=400,000, 각 노출에서 오류가 날 확률 p=2.5e-6 → 기대 λ=np=1.0.

### 7.2 근사
- **Bin(n,p)** 대신 **Pois(1.0)** 사용:
  $$P(X\ge 3)\approx 1-(e^{-1}\cdot(1+1))=1- \frac{2}{e}\approx 0.2642$$
- **정확 Binomial**과 비교해도 차이가 매우 작음(여기선 실무적으로 충분).

### 7.3 조건 점검(Why OK?)
- n **매우 큼**, p **매우 작음**, λ=np=1 **작음** → 포아송 근사 **매우 양호**.
- **근사 품질 규칙**(경험적):
  - $$p\le 0.01,\ n\ge 100$$ 또는
  - $$\lambda=np\le 10$$ 에서 실무 오차가 작은 편.
  - 이론적으로는 **Le Cam 경계**: 총변동거리 $$\le 2 n p^2$$ (p가 아주 작을수록 경계가 급감).

---

## 8. 예제 C — 샘플링이 “복원 없음”일 때: 하이퍼지오메트릭

### 8.1 상황
- **N=50{,}000**(푸시 대상 리스트), 그중 **K=5{,}000**은 “충성 고객”.
- 오늘 **n=2{,}000명**에게만 1회 쿠폰 발송(중복 없음). **충성 고객에게 간 쿠폰 수** $$X\sim \mathrm{Hypergeom}(N,K,n)$$.

### 8.2 기대·분산
- $$E[X]=n(K/N)=200$$
- $$\mathrm{Var}(X)=n\frac{K}{N}(1-\frac{K}{N})\frac{N-n}{N-1}$$
  - FPC로 인해 **Binomial보다 분산이 작아짐**(중복이 없어서 변동이 줄어든다).

### 8.3 Binomial 근사 가능?
- $$n/N=2000/50000=0.04\ (4\%)\ \Rightarrow\ \text{근사 양호}$$
- 대체: $$X\approx \mathrm{Bin}(n, K/N)=\mathrm{Bin}(2000, 0.1)$$ 로 빠른 계산 가능.

---

## 9. “노출 수가 큰데 p가 작을 때” 근사 조건 — 실무 체크리스트

### 9.1 포아송 근사(Bin→Pois)
- **필수**: n **큼**, p **작음**(둘 다 수치로 확인).
- **핵심**: λ=np가 **중간 이하**(대략 10 이하)면 보통 매우 안전.
- **주의**: λ가 큰데 p도 그리 작지 않다면(예: p=0.02, n=50k → λ=1000) → **정규 근사**가 더 낫다. 포아송은 평균=분산이라 **언더/오버** 추정이 커질 수 있음.

### 9.2 정규 근사(Bin→Normal)
- **경험 법칙**: $$np\gtrsim 5,\ n(1-p)\gtrsim 5$$ (혹은 10) 이면 양호.
- **연속성 보정**(±0.5) 필수 권장.

### 9.3 Hypergeom→Bin 근사
- **표본비율**: $$n/N\lesssim 0.05$$ 정도면 근사 무난.
- 표본비율이 커질수록 FPC 효과가 커져 Bin보다 **분산이 더 작아져** 근사 오차↑.

---

## 10. 함정과 대안 — 왜 모델이 흔들리는가?

### 10.1 독립·동일 확률 위반
- **같은 사용자**의 다중 노출/세션 → 시도 간 상관↑ → 이항 분산보다 관측 분산↑(**과산포**).
  - 대안: **Poisson-binomial**(각기 다른 $$p_i$$), 또는 **베타-이항**(랜덤 효과) / **음이항(NB)**(포아송-감마 혼합)로 분산 팽창 모델링.

### 10.2 이질적 확률(군집효과)
- 신/구 유저, 국가/디바이스별 **p**가 다름 → 단일 Bin/Poisson 과소적합.
  - 대안: **층화**(세그먼트별 모델 후 가중합), **혼합모형**.

### 10.3 분모의 랜덤성
- 실무에서 **노출 수 n 자체가 랜덤**(트래픽 변동).
  - 단순 Bin(np)만 쓰면 과소분산.
  - 대안: **델타법**으로 비율-의-비율 분산 계산(2편 참고), 또는 **포아송 회귀**로 **노출 로그를 오프셋**에 넣어 모델링(λ = rate × exposure).

### 10.4 제로 인플레이션
- “0”이 유난히 많음(대다수 유저는 클릭/전환 0) → 포아송/이항이 0을 과소추정.
  - 대안: **Zero-inflated** 포아송/이항.

---

## 11. 실전 미세 예제 모음

### 11.1 포아송 thinning — “노출 중 클릭된 것만”
- 노출 수 $$N\sim \mathrm{Pois}(\lambda)$$, 각 노출이 클릭될 확률 q → 클릭 수
  $$C\mid N\sim \mathrm{Bin}(N,q)\Rightarrow C\sim \mathrm{Pois}(q\lambda)$$
- **의미**: 포아송 카운트에 베르누이를 얹어도 포아송(편리한 닫힘성).

### 11.2 포아송 합성 — “다중 채널 오류 합”
- 오류 채널별 $$X_i\sim \mathrm{Pois}(\lambda_i)$$, 독립 → 총 오류 $$X=\sum X_i\sim \mathrm{Pois}(\sum \lambda_i)$$.

### 11.3 하이퍼지오메트릭의 경계값
- **최대 성공수** $$\min(n,K)$$, **최소** $$\max(0,n-(N-K))$$.
- 쿠폰이 **K**보다 훨씬 적고, 표본비율이 작으면 Bin으로 간략화.

---

## 12. 계산 예(수치) — 포아송 vs 이항 오차 감각

### 12.1 설정
- $$n=200{,}000$$, $$p=0.0008$$ → $$\lambda=np=160$$.

### 12.2 관심 확률: “k ≥ 190”
- **Pois(160)** 근사
  - 정규 근사도 사용 가능: $$\mu=\sigma^2=160,\ \sigma=12.649$$
  - $$Z=\frac{189.5-160}{12.649}\approx 2.33 \Rightarrow P\approx 0.0099$$
- **Bin(200k, 0.0008)** 정규 근사(더 정확)
  - $$\sigma=\sqrt{np(1-p)}\approx \sqrt{160\times 0.9992}\approx 12.645$$
  - Z는 거의 동일하나, **테일에서 미세 차이** 발생 → λ가 커질수록 Bin의 정규 근사가 유리.

**메시지**: λ가 **중간 이상(>~30–50)** 이면 포아송보다 **정규 근사**로 Bin을 다루는 게 안정적.

---

## 13. 미니 실습(수기 계산 팁)
- **Binomial 로그확률**은 조합수가 커서 직접 계산이 불안정 → **로그-감마**(Stirling 근사)로 안정화.
- **Poisson 테일**은 정규/감마분포 근사 또는 **체비셰프 상계**로 빠르게 대략 판단.

---

## 14. 리포트 문장 템플릿(분포 선택 포함)
- “전환 수 **X**는 **이항** 모델 **Bin(n,p)** 로 가정. n=…, p는 …의 과거 추정치.
  **희귀 오류** 카운트는 **포아송** **Pois(λ)** 로 가정(λ=…).
  **중복 없는 추출**은 **Hypergeom(N,K,n)** 으로 계산.
  근거: 표본비율 n/N=…, np=…, p=…(근사 조건 충족).”

---

## 15. 체크리스트 — 분포 선택 전 자문 7가지
1) **사건 단위**가 1/0인가? (베르누이)
2) **n번** 독립/동일 확률로 반복되나? (이항)
3) **희귀 사건**을 시간/노출 단위로 세는가? (포아송)
4) **복원 없음**으로 유한집단에서 추출하는가? (하이퍼지오메트릭)
5) 표본비율이 작은가? Hypergeom→Bin 근사 OK?
6) **np** 작고 **p** 작나? Bin→Pois 근사 OK?
7) **np, n(1-p)** 충분히 큰가? Bin→Normal 근사 OK?

---

## 16. 자주 묻는 질문(FAQ)

**Q1. 포아송인가, 이항인가?**
- 분모 **n이 명확**하고, 각 시도가 **동일 p**의 베르누이라면 **이항**.
- 시간·면적·노출량 등 **연속적 노출** 대비 **희귀 발생 수**라면 **포아송**이 자연. (둘이 같은 상황을 다른 렌즈로 볼 수 있는 경우도 있음.)

**Q2. 사용자별 p가 다르면?**
- 단일 이항은 과소분산. **Poisson-binomial**이나 **베타-이항**으로 분산 팽창을 허용. 층화/혼합모형 권장.

**Q3. Hypergeom과 Bin의 선택 기준은?**
- “**중복 추출 금지**”가 엄격하고 **N**이 그리 크지 않다면 Hypergeom.
- **N**이 매우 크고 **n/N**이 작다면 Bin 근사로 속도·단순성 택해도 무방.

---

## 17. (개념용) 계산 스니펫
```python
# 분포별 PMF/테일(개념 확인용; 실전은 검증된 라이브러리 사용 권장)
import math

def log_choose(n,k):
    # 안정적 조합 로그
    return math.lgamma(n+1) - math.lgamma(k+1) - math.lgamma(n-k+1)

def binom_pmf(n,p,k):
    return math.exp(log_choose(n,k) + k*math.log(p) + (n-k)*math.log(1-p))

def pois_pmf(lam,k):
    return math.exp(-lam + k*math.log(lam) - math.lgamma(k+1))

def hypergeom_pmf(N,K,n,k):
    return math.exp(log_choose(K,k) + log_choose(N-K, n-k) - log_choose(N,n))

# 예: Bin(200000, 0.0008)에서 k=190의 확률
print(binom_pmf(200000, 0.0008, 190))

# 예: Pois(160)에서 k=190의 확률(근사)
print(pois_pmf(160, 190))
```

---

## 18. 연습문제 (정답 스케치 포함)

**[1] 포아송 thinning**
- 노출 카운트 $$N\sim \mathrm{Pois}(600)$$, 클릭 확률 q=0.003.
  1) 클릭 수 C의 분포와 모수는?
  2) $$P(C=0)$$ 는?
- **스케치**: C ∼ Pois(600×0.003=1.8), $$P(C=0)=e^{-1.8}$$.

**[2] Hypergeom vs Bin 근사 오차**
- N=100k, K=10k, n=2k.
  1) $$E[X],\ \mathrm{Var}(X)$$(Hypergeom) 구하고
  2) Bin(n, p=K/N) 분산과 비교.
- **스케치**: Hypergeom 분산이 **FPC** 만큼 더 작음.

**[3] Bin→Pois 조건 점검**
- n=40k, p=0.0004(λ=16).
  - k≥25 테일 확률 계산 시 Bin 대신 Pois 사용해도 되는가?
- **스케치**: λ=16은 중간, *p* 충분히 작음. 실무에선 두 값 비교 후 결정(테일이면 Bin 정규근사도 권장).

**[4] 사용자 이질성**
- 50%는 p=0.01, 50%는 p=0.001.
  - 전체를 p=0.0055로 단일 Bin으로 잡으면 분산이 어떻게 왜곡되는지 서술.
- **스케치**: 분산이 **평균적 분산** + **군집 간 분산**으로 팽창(단일 Bin보다 큼).

---

## 19. TL;DR
- **베르누이**: 한 번의 1/0.
- **이항**: n번 베르누이 합, $$E=np,\ \mathrm{Var}=np(1-p)$$.
- **포아송**: 희귀사건 카운트, $$E=\mathrm{Var}=\lambda$$; Bin 극한(λ=np).
- **하이퍼지오메트릭**: 복원 없음, $$\mathrm{Var}=\text{Bin 분산}\times \text{FPC}$$.
- **근사 조건** 정확히 점검:
  - Hypergeom→Bin: $$n/N \ll 1$$
  - Bin→Pois: n↑, p↓, λ=np 중간 이하
  - Bin→Normal: $$np,\ n(1-p)\gtrsim 5\!-\!10$$
- **함정**: 독립성 위반, 이질적 p, 분모 랜덤성, 제로 인플레이션 → 혼합/층화/오프셋/ZI 모형 검토.
