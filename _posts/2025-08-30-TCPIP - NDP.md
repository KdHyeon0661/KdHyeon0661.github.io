---
layout: post
title: TCPIP - NDP
date: 2025-08-30 20:25:23 +0900
category: TCPIP
---
# TCP/IP IPv6 Neighbor Discovery Protocol (NDP)

## IPv6 NDP 개요, 역사, 필요성 및 표준

### 배경과 필요성
IPv6 Neighbor Discovery Protocol(NDP)은 IPv4에서 여러 개별 프로토콜들이 담당하던 기능들을 통합하고 향상시킨 핵심 프로토콜입니다. 1998년 RFC 2461(현재는 RFC 4861로 대체)로 처음 표준화된 NDP는 IPv6 네트워크에서 주소 해석, 라우터 발견, 자동 구성 등 다양한 네트워크 서비스 기능을 제공합니다.

IPv4의 한계를 해결하고 IPv6의 새로운 기능을 지원하기 위해 NDP가 필요해졌습니다:
- **ARP의 대체**: IPv4의 주소 해석 프로토콜(ARP)이 브로드캐스트에 의존하여 확장성 문제 야기
- **ICMP 기능 통합**: 라우터 발견, 리다이렉트 등 여러 ICMP 기능을 일관된 프레임워크로 통합
- **자동 구성 강화**: IPv6의 Stateless Address Autoconfiguration(SLAAC)을 지원
- **보안 강화**: ARP 스푸핑과 같은 보안 취약점 해소

### 표준 발전 과정
```
NDP 표준 발전 타임라인
1998: RFC 2461 - 초기 NDP 표준 (IPv6 Neighbor Discovery)
2007: RFC 4861 - 개정된 NDP 표준 (기존 RFC 2461 대체)
2007: RFC 4862 - IPv6 Stateless Address Autoconfiguration
2011: RFC 6275 - Mobile IPv6 지원 향상
2014: RFC 6980 - 보안 고려사항 업데이트
```

## IPv6 NDP 일반적 운영 개요: 기능, 기능군 및 메시지 유형

### NDP의 5대 핵심 기능군
NDP는 다음과 같은 주요 기능들을 통합하여 제공합니다:

1. **라우터 발견**: 호스트가 로컬 네트워크에서 라우터를 찾고 구성 정보를 획득
2. **접두사 발견**: 로컬 네트워크의 주소 접두사 정보 학습
3. **주소 해석**: IPv6 주소를 링크 계층 주소(MAC 주소)로 변환
4. **인접 노드 연결성 감지**: 이웃 노드의 도달 가능성 모니터링
5. **리다이렉트**: 더 효율적인 경로로의 전환 안내

### NDP 메시지 유형
NDP는 ICMPv6 메시지를 활용하며, 다음과 같은 5가지 주요 메시지 유형을 정의합니다:

```
NDP 메시지 유형 체계
+------------------------+----------------+-----------------------+
| 메시지 유형           | ICMPv6 타입    | 주요 목적             |
+------------------------+----------------+-----------------------+
| 라우터 요청           | 타입 133       | 라우터 정보 요청      |
| 라우터 광고           | 타입 134       | 라우터 정보 제공      |
| 네이버 요청           | 타입 135       | 이웃 노드 정보 요청   |
| 네이버 광고           | 타입 136       | 이웃 노드 정보 제공   |
| 리다이렉트            | 타입 137       | 최적 경로 제안        |
+------------------------+----------------+-----------------------+
```

### NDP 메시지 전송 범위
```
NDP 메시지 전송 범위 구분
+-----------------------+------------------------+------------------------+
| 메시지 유형           | 대상 주소             | 범위                   |
+-----------------------+------------------------+------------------------+
| 라우터 요청           | FF02::2 (모든 라우터) | 링크-로컬 멀티캐스트   |
| 라우터 광고           | FF02::1 (모든 노드)   | 링크-로컬 멀티캐스트   |
| 네이버 요청           | 요청 노드 멀티캐스트  | 링크-로컬 멀티캐스트   |
| 네이버 광고           | 요청자 또는 유니캐스트| 유니캐스트/멀티캐스트  |
| 리다이렉트            | 원본 호스트           | 유니캐스트             |
+-----------------------+------------------------+------------------------+
```

## IPv6 NDP 기능과 동등한 IPv4 기능 비교

NDP는 IPv4에서 여러 개별 프로토콜이 담당하던 기능들을 통합했습니다:

```
IPv4 기능 vs IPv6 NDP 기능 비교
+---------------------+---------------------+-----------------------------+
| IPv4 기능           | 구현 프로토콜       | IPv6 NDP 기능               |
+---------------------+---------------------+-----------------------------+
| 주소 해석           | ARP (브로드캐스트)  | 네이버 발견 (멀티캐스트)    |
| 라우터 발견         | ICMP 라우터 광고    | 라우터 발견                 |
| 주소 자동 구성      | DHCP (상태 기반)    | SLAAC (상태 비저장)         |
| 리다이렉트          | ICMP 리다이렉트     | 리다이렉트                  |
| 중복 주소 감지      | 그래티투이스 ARP    | DAD (중복 주소 감지)        |
| 연결성 감지         | ARP 캐시 타임아웃   | NUD (인접 노드 연결성 감지) |
+---------------------+---------------------+-----------------------------+
```

### 주요 개선점
1. **브로드캐스트 제거**: IPv4 ARP의 브로드캐스트 스톰 문제 해결
2. **보안 향상**: 기본적인 인증 메커니즘 도입
3. **효율성 증대**: 멀티캐스트를 통한 정확한 대상 지정
4. **기능 통합**: 여러 프로토콜의 기능을 하나로 통합

## IPv6 NDP 호스트-라우터 발견 기능: 라우터 발견, 접두사 발견, 매개변수 발견 및 주소 자동 구성

### 라우터 발견 프로세스
라우터 발견은 호스트가 네트워크에 연결될 때 수행되는 첫 번째 단계입니다:

```
라우터 발견 시퀀스
[호스트]                          [라우터]
    |                                  |
    |--- 라우터 요청 (RS) ------------>|
    | (ICMPv6 타입 133)               |
    | 목적지: FF02::2 (모든 라우터)   |
    |                                  |
    |<-- 라우터 광고 (RA) -------------|
    | (ICMPv6 타입 134)               |
    | 목적지: FF02::1 (모든 노드)     |
    |                                  |
광고 메시지 분석 및 네트워크 파라미터 구성
```

### 라우터 광고 메시지 구조
```
라우터 광고 메시지 (ICMPv6 타입 134)
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     타입(134)    |     코드(0)    |         체크섬          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| 현재 홉 제한     |M|O|H|Prf|P|R|R|       라우터 수명        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                     도달 가능 시간                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                     재전송 타이머                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    옵션 (가변 길이)                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

주요 플래그:
M: 관리 주소 구성 플래그 (DHCPv6 사용 여부)
O: 기타 구성 플래그 (DHCPv6 추가 정보)
H: 홈 에이전트 플래그 (모바일 IP 지원)
Prf: 기본 라우터 우선순위 (00: 보통, 01: 높음, 11: 낮음)
```

### 접두사 발견과 SLAAC
Stateless Address Autoconfiguration(SLAAC)은 NDP의 혁신적 기능입니다:

**SLAAC 작동 과정**:
1. **접두사 정보 획득**: 라우터 광고에서 접두사 옵션 획득
2. **인터페이스 식별자 생성**: EUI-64 방식 또는 임의 방식으로 생성
3. **주소 구성**: 접두사 + 인터페이스 식별자 = IPv6 글로벌 주소
4. **중복 주소 감지(DAD)**: 새 주소의 고유성 확인

```
EUI-64 주소 생성 예시
MAC 주소:    00:1A:2B:3C:4D:5E
변환 후:     02:1A:2B:FF:FE:3C:4D:5E  (U/L 비트 설정)
IPv6 인터페이스 식별자: 021A:2BFF:FE3C:4D5E
접두사:      2001:0DB8:ACAD::/64
최종 주소:   2001:0DB8:ACAD:0000:021A:2BFF:FE3C:4D5E
```

### 매개변수 발견
라우터 광고를 통해 호스트는 다양한 네트워크 매개변수를 자동으로 획득합니다:
- **MTU 크기**: 링크의 최대 전송 단위
- **홉 제한 기본값**: 기본 TTL 값
- **재전송 타이머**: NDP 메시지 재전송 간격
- **도달 가능 시간**: 이웃 노드 도달 가능성 판단 기준

## IPv6 NDP 호스트-호스트 통신 기능: 주소 해석, 다음 홉 결정, 인접 노드 연결성 감지 및 중복 주소 감지

### 주소 해석 프로세스
IPv4의 ARP를 대체하는 NDP의 주소 해석은 멀티캐스트를 활용합니다:

```
NDP 주소 해석 과정
[호스트 A]                                    [호스트 B]
(목표: B의 링크 계층 주소 찾기)              (IPv6: 2001:db8::1)
    |                                                  |
    |--- 네이버 요청 (NS) --------------------------->|
    | (ICMPv6 타입 135)                               |
    | 대상 주소: 2001:db8::1                          |
    | 송신 주소: 호스트 A의 링크-로컬 주소            |
    | 목적지: FF02::1:FF00:1 (요청 노드 멀티캐스트)   |
    |                                                  |
    |<-- 네이버 광고 (NA) ----------------------------|
    | (ICMPv6 타입 136)                               |
    | 대상 주소: 2001:db8::1                          |
    | 대상 링크 계층 주소 옵션 포함                   |
    |                                                  |
A의 네이버 캐시에 B의 정보 저장
```

### 요청 노드 멀티캐스트 주소
IPv6 NDP의 혁신적인 특징 중 하나는 요청 노드 멀티캐스트 주소입니다:
- **형식**: FF02::1:FFXX:XXXX (하위 24비트는 IPv6 주소의 하위 24비트와 동일)
- **장점**: 특정 노드만 수신하는 효율적 멀티캐스트
- **범위**: 링크-로컬 범위로 제한

### 인접 노드 연결성 감지(NUD)
NUD는 네트워크의 안정성을 크게 향상시키는 기능입니다:

**NUD 상태 머신**:
```
NUD 상태 다이어그램
+-----------+     +-----------+     +-----------+
| 불완전     |---->| 도달 가능  |---->| 지연      |
| (INCOMPLETE)|     | (REACHABLE)|     | (DELAY)  |
+-----------+     +-----------+     +-----------+
      |                 |                 |
      |                 |                 |
      v                 v                 v
+-----------+     +-----------+     +-----------+
| 조사 중    |---->| 프롭      |---->| 미지       |
| (PROBE)    |     | (STALE)   |     | (UNKNOWN) |
+-----------+     +-----------+     +-----------+
```

**연결성 확인 방법**:
1. **상위 계층 힌트**: TCP ACK와 같은 상위 계층 응답
2. **수동 확인**: 응용 프로그램이 연결성을 확인
3. **주기적 프로빙**: 주기적인 네이버 요청 전송

### 중복 주소 감지(DAD)
DAD는 주소 충돌을 방지하는 중요한 안전 메커니즘입니다:

```
DAD 프로세스
[새로운 호스트]                         [네트워크의 다른 호스트]
    |                                              |
    |--- 네이버 요청 (NS) ------------------------>|
    | 대상 주소: 자신의 예정 주소                  |
    | 송신 주소: 미지정 (::)                      |
    | 목적지: 예정 주소의 요청 노드 멀티캐스트     |
    |                                              |
    |<-- 네이버 광고 (NA) ------------------------|
    | (다른 호스트가 이미 해당 주소 사용 중인 경우)|
    |                                              |
주소 충돌 감지 → 다른 주소 시도 또는 오류 보고
```

## IPv6 NDP 리다이렉트 기능

### 목적과 필요성
리다이렉트 기능은 호스트의 라우팅 테이블을 동적으로 최적화합니다. 호스트가 비효율적인 경로로 패킷을 전송할 때, 더 나은 경로를 알려줌으로써 네트워크 효율성을 향상시킵니다.

### 리다이렉트 시나리오
```
리다이렉트 발생 상황
[호스트 A]          [라우터 R1]          [라우터 R2]          [호스트 B]
    |                    |                    |                    |
    |--- 패킷 전송 ---->|                    |                    |
    | (목적지: B)       |                    |                    |
    |                   |--- 패킷 전송 ---->|                    |
    |                   | (비효율적 경로)    |                    |
    |                   |                    |--- 패킷 전송 ---->|
    |                   |                    |                    |
    |<-- 리다이렉트 ----|                    |                    |
    | (더 나은 다음 홉: R2)                  |                    |
    |                   |                    |                    |
    |--- 이후 패킷 ------------------------->|                    |
    | (R2를 직접 경유)  |                    |                    |
    |                   |                    |--- 패킷 전송 ---->|
```

### 리다이렉트 메시지 형식
```
ICMPv6 리다이렉트 메시지 (타입 137)
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     타입(137)    |     코드(0)    |         체크섬          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           예약됨                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    대상 주소 (128비트)                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    목적지 주소 (128비트)                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    옵션 (가변 길이)                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

주요 필드:
- 대상 주소: 리다이렉트를 받는 호스트의 주소
- 목적지 주소: 최종 목적지 주소
- 옵션: 대상 링크 계층 주소 (새로운 다음 홉의 MAC 주소)
```

### 리다이렉트의 제한사항
1. **보안 고려**: 인증되지 않은 리다이렉트는 라우팅 공격에 활용될 수 있음
2. **범위 제한**: 링크-로컬 범위에서만 유효
3. **일시적 적용**: 영구적인 라우팅 항목이 아닌 일시적 최적화
4. **구현 의존성**: 모든 IPv6 스택이 리다이렉트를 완전히 지원하지는 않음

### 보안 강화: 안전한 NDP(SeND)
RFC 3971은 안전한 NDP(SeND)를 정의하여 NDP 메시지에 암호화 기반 인증을 추가합니다:
- **CGA 주소**: 암호화 생성 주소를 통한 발신자 인증
- **RSA 서명**: 메시지 무결성 보장
- **타임스탬프**: 리플레이 공격 방지

## 결론

IPv6 Neighbor Discovery Protocol은 IPv6 아키텍처의 핵심 구성 요소로서, 단순한 프로토콜 통합을 넘어 네트워크 관리의 패러다임을 변화시켰습니다. ARP, ICMP 라우터 발견, 리다이렉트 등 IPv4에서 분리되어 있던 기능들을 통합함으로써 더 일관되고 효율적인 네트워크 운영을 가능하게 했습니다.

NDP의 가장 큰 강점은 **효율성**과 **보안**입니다. 브로드캐스트를 제거하고 요청 노드 멀티캐스트를 도입함으로써 네트워크 트래픽을 최소화했으며, 기본적인 보안 메커니즘을 통해 ARP 스푸핑과 같은 전통적 공격을 방어합니다. 특히 SLAAC를 통한 상태 비저장 주소 자동 구성은 네트워크 관리의 복잡성을 크게 줄였습니다.

그러나 NDP도 완벽하지는 않습니다. 초기 구현에서는 보안 취약점이 발견되었고, SeND와 같은 확장이 필요했습니다. 또한 모바일 환경, 대규모 데이터센터, 소규모 IoT 네트워크 등 다양한 환경에서의 최적화가 지속적으로 요구되고 있습니다.

현실적으로 NDP는 IPv6 채용의 성공에 결정적 역할을 했습니다. 네트워크 관리자들이 IPv6로 전환할 때 NDP가 제공하는 자동 구성 기능은 진입 장벽을 크게 낮췄습니다. 오늘날 모바일 네트워크, 클라우드 인프라, IoT 시스템 등에서 NDP는 없어서는 안 될 필수 프로토콜로 자리잡았습니다.

네트워크 엔지니어에게 NDP의 깊은 이해는 IPv6 네트워크 설계, 운영, 문제 해결의 기초가 됩니다. NDP는 단순한 프로토콜 스펙을 넘어, 현대 네트워킹이 지향해야 할 방향성—자동화, 보안, 효율성—을 보여주는 모범 사례로서 계속해서 연구되고 발전될 것입니다.