---
layout: post
title: 확률과 통계 - 가설검정의 논리와 절차
date: 2025-09-19 22:25:23 +0900
category: 확률과 통계
---
# 8. 가설검정의 논리와 절차

> **목표**
> - **유의수준(α)**, **검정력(power = 1−β)**, **효과크기(effect size)**의 관계를 직관과 수식으로 정리한다.
> - **z/t/χ²/F** 검정이 **언제, 왜, 어떻게** 쓰이는지 조건과 절차를 정리한다.
> - **예시**: 버튼 색상 **A/B 전환율 차이 z-검정**, 이벤트별 다중실험에서 **FDR** 제어(**Benjamini–Hochberg**)를 적용한다.
> - **함정**: **p-hacking**(선정 기준 뒤바꾸기, 다중 시도, 중간 엿보기)의 위험과 **사전등록**(pre-registration), **정지 규칙**(stopping rule)로의 방어법을 배운다.

---

## 0. Hook — “p값 하나로 결론 내리면 왜 위험한가”
- 같은 데이터라도 **가설·지표·필터**를 바꾸며 여러 번 검정하면 **언젠가 유의**가 나온다(우연히).
- **유의수준 α**는 “가짜 양성”의 **평균 비율**에 대한 약속일 뿐, **한 번의 분석**에서 “참/거짓”을 단정하지 않는다.
- **검정력**과 **효과크기**까지 함께 설계해야 “실질적으로 의미 있는 개선”을 놓치지 않는다.

---

## 1. 가설검정의 3요소: α, β, 효과크기

### 1.1 유의수준(α)
- **귀무가설** $$H_0$$ 이 참인데도 “차이가 있다”고 오판할 **확률 한도**. 보통 $$\alpha=0.05$$.
- “유의하다”의 뜻: p값 ≤ α (단, **다중검정**이면 α 보정 필요).

### 1.2 검정력(power = 1−β)
- $$H_1$$ 이 참일 때(진짜 차이가 있을 때) **탐지할 확률**.
- **표본 크기 n**, **효과크기**, **변동성**이 클수록 power가 달라진다.

### 1.3 효과크기(effect size)
- **절대 차이**(risk difference): $$\Delta=p_B-p_A$$ (단위: pp)
- **상대 차이**(lift): $$(p_B-p_A)/p_A$$
- **Cohen’s h**(두 비율의 표준화):
  $$
  h=2\left[\arcsin\sqrt{p_B}-\arcsin\sqrt{p_A}\right]
  $$
- **연속형**(예: 체류시간 평균): **Cohen’s d**
  $$
  d=\frac{\mu_B-\mu_A}{s_{\text{pooled}}}
  $$

> **설계 직관**: “α는 **오판 허용치**, power는 **탐지 능력**, 효과크기는 **의미 크기**.” 3가지를 동시에 지정해야 테스트가 **행동 가능한** 결과를 낸다.

---

## 2. 검정 도구 지도: z/t/χ²/F

| 상황 | 가정/조건 | 대표 검정 | 핵심 통계량 |
|---|---|---|---|
| **두 비율 비교** (전환율/클릭율) | 표본 큼, $$np, n(1-p)\gtrsim 5$$ | **z-검정(2-표본 비율)** | pooled z |
| **평균 비교(연속)** | 정규 또는 표본 큼 | **t-검정** (Welch 권장) | t |
| **범주 독립성** (A/B × 구매여부) | 기대빈도 충분 | **χ² 독립성 검정** | χ² |
| **k개 그룹 평균 비교** | 정규·등분산(완화 가능) | **일원 ANOVA(F-검정)** | F |

> **노트**: 비율의 **k>2 그룹 비교**는 **χ²**(혹은 **로지스틱 회귀**)가 자연스럽다. 연속형은 **ANOVA**.

---

## 3. 예시 1 — 버튼 색상 A/B 전환율 차이 **z-검정**

### 3.1 데이터
- A: 노출 $$n_A=100{,}000$$, 전환 $$x_A=3{,}000\Rightarrow \hat p_A=0.0300$$
- B: 노출 $$n_B=100{,}000$$, 전환 $$x_B=3{,}300\Rightarrow \hat p_B=0.0330$$
- **관심**: $$H_0: p_A=p_B\quad \text{vs}\quad H_1: p_A\ne p_B$$ (양측)

### 3.2 z-통계량(풀드)
- pooled 비율:
  $$
  \hat p=\frac{x_A+x_B}{n_A+n_B}=\frac{6300}{200000}=0.0315
  $$
- 표준오차:
  $$
  \mathrm{SE}=\sqrt{\hat p(1-\hat p)\left(\frac{1}{n_A}+\frac{1}{n_B}\right)}\approx \sqrt{0.0315\cdot 0.9685\cdot 2/100000}\approx 0.00078
  $$
- z:
  $$
  z=\frac{\hat p_B-\hat p_A}{\mathrm{SE}}=\frac{0.0030}{0.00078}\approx 3.85
  $$
- p값(양측): **p ≈ 0.00012** ⇒ **유의**(α=0.05).

### 3.3 효과크기 & CI
- **절대 차이**: **+0.30pp**
- 95% **Wald CI**(차이):
  $$
  \hat\Delta\pm 1.96\sqrt{\frac{\hat p_A(1-\hat p_A)}{n_A}+\frac{\hat p_B(1-\hat p_B)}{n_B}}
  $$
  수치상 대략 **[+0.15pp, +0.45pp]**.
- **Cohen’s h**:
  $$
  h=2(\arcsin\sqrt{0.033}-\arcsin\sqrt{0.03})\approx 0.017\ \ (\text{매우 작음})
  $$

### 3.4 해석 문장 템플릿
- “B의 CVR은 **3.30%**, A의 **3.00%** 대비 **+0.30pp**(z=3.85, p=0.00012). **95% CI**: **[+0.15pp, +0.45pp]**. **효과크기 h≈0.017**로 **작지만 통계적으로 유의**.”

> **주의**: 유의하지만 **실질 효과**(pp, lift)가 **제품 목표**에 충분한지 별도 판단. 또한 **다중실험**이면 **FDR/Family 보정** 필요.

---

## 4. 예시 2 — 연속 지표(세션시간) **t-검정** (Welch)

### 4.1 설정
- A/B 각각 하루 사용자 샘플에서 **평균 체류시간** 비교. 분산이 다를 수 있어 **Welch t** 사용.

### 4.2 통계량
- $$t=\frac{\bar X_B-\bar X_A}{\sqrt{S_A^2/n_A+S_B^2/n_B}}$$
- 자유도(df)는 **Welch–Satterthwaite** 근사:
  $$
  \nu\approx \frac{(S_A^2/n_A+S_B^2/n_B)^2}{\frac{(S_A^2/n_A)^2}{n_A-1}+\frac{(S_B^2/n_B)^2}{n_B-1}}
  $$
- p값은 t분포로 계산. **정규성** 약할 땐 n이 충분하면 근사 양호, heavy-tail이면 **로버스트/부트스트랩** 병행.

---

## 5. 예시 3 — 범주 독립성 **χ² 검정**(2×2: A/B × 전환여부)

### 5.1 테이블
| | 전환 | 비전환 | 합계 |
|---|---:|---:|---:|
| A | 3000 | 97000 | 100000 |
| B | 3300 | 96700 | 100000 |

- 기대빈도 $$E_{ij}=\frac{\text{행합}\times \text{열합}}{N}$$ 계산 후
  $$
  \chi^2=\sum_{i,j}\frac{(O_{ij}-E_{ij})^2}{E_{ij}}
  $$
- **2×2**에서는 $$\chi^2=z^2$$(2-표본 비율 z와 동치). 기대빈도는 보통 **≥5** 권장.

---

## 6. 예시 4 — 3개 이상 그룹 평균 **ANOVA(F)**

### 6.1 상황
- A/B/C 세 변형의 **평균 ARPU** 비교(연속, 약 정규).
- 귀무: $$\mu_A=\mu_B=\mu_C$$.
- 그룹 간 변동/그룹 내 변동 비로 **F** 계산.
- **유의**이면 **사후분석**(Tukey HSD 등) 또는 선형모형(회귀)로 비교.

> **비율(전환율)**의 다그룹 비교는 **χ²** 또는 **로지스틱 회귀**가 자연스럽다.

---

## 7. 다중검정: FWER vs **FDR**

### 7.1 왜 보정이 필요한가
- 실험/이벤트를 **J개** 동시에 테스트하면, 각 α=0.05여도 **가짜 양성**이 평균 **0.05J개** 발생.
- **FWER**(Family-Wise Error Rate): 하나라도 가짜양성 날 확률 제어(**Bonferroni/Holm**).
- **FDR**(False Discovery Rate): “유의로 선언한 것 중 가짜의 **기대 비율**” 제어(**BH**).

### 7.2 Bonferroni / Holm (FWER)
- **Bonferroni**: 각 검정에 $$\alpha/J$$ 사용. 보수적.
- **Holm**: p값 정렬 후 순차적으로 비교(보다 덜 보수적).

### 7.3 **Benjamini–Hochberg (BH)** — FDR 제어
- p값 정렬: $$p_{(1)}\le\dots\le p_{(J)}$$
- 가장 큰 k를 찾아
  $$
  p_{(k)}\le \frac{k}{J}\alpha
  $$
  이면, **1..k**까지 유의로 선언.
- **q값**(최소 FDR 임계)으로 리포팅하기도 함.

### 7.4 예시 — 이벤트별 다중실험
- 10개 이벤트(푸시/배너/온보딩/결제팝업 등)에 대한 A/B. p값이
  $$[0.001, 0.004, 0.012, 0.018, 0.031, 0.049, 0.06, 0.11, 0.22, 0.40]$$
- BH (α=0.05): 임계선 $$k/J\cdot 0.05$$ 는 [0.005, 0.01, 0.015, 0.02, …].
  - k=4까지 통과(0.018 ≤ 0.02), k=5는 0.031 ≤ 0.025 **불통** → **상위 4개만 유의**.

> **실무 문장**: “10개 이벤트 동시 검정, **BH-FDR 5% 제어**에서 **4개 이벤트**가 유의. 개별 p는 […]이며, 추정된 **q값**은 […]”

---

## 8. p-hacking 방지: **사전등록 & 분석 계획**

### 8.1 위험 시나리오
- **중간 엿보기(옵셔널 스토핑)**: 데이터가 모이는 중 수시로 p를 보고 “유의하면 종료”. → **제1종 오류 급증**.
- **지표 갈아타기**: CVR 유의 안 되면 CTR/뷰/시간 등으로 전환.
- **사후 구간/세그먼트 발굴**: 전체 비유의 → “모바일 신규만 보면 유의”.
- **데이터 정제 후 추정 기준 변경**: 아웃라이어 제거/봇 필터 기준을 “보면서” 조정.

### 8.2 사전등록 체크리스트(권장 템플릿)
- **가설 & 1차 지표**: $$H_0, H_1$$, **주지표** 1개(예: D1, CVR), **보조지표** 명시.
- **분석 단위/무작위화 단위**: 사용자 ID/세션? **일치** 선언.
- **표본 크기/기간**: 목표 power, 최소 일수/노출수, **정지 규칙**(fixed horizon).
- **데이터 제외 기준**: 봇·내부 계정·중복·크로스오버 처리.
- **세그먼트**: 선행 정의(모바일/데스크톱, 신규/재방문 등), **탐색은 탐색**으로 라벨.
- **검정 세부**: z/t/χ²/F 중 무엇, **양/단측** 결정 이유.
- **다중검정 계획**: BH-FDR/Bonferroni/Holm 등.
- **정규성/등분산 위반 대응**: Welch/부트스트랩/로지스틱 회귀로 대안.

### 8.3 중간분석이 꼭 필요할 때(연속/순차)
- **그룹 순차 설계**: **α-spending**(O’Brien–Fleming, Pocock 등)로 중간검정 허용.
- **연속 모니터링**엔 **시퀀셜 검정**(SPRT, 혹은 mSPRT) 같은 **정합적 방법** 필요.
- **일반 z/t p값을 중간에 반복 조회**하면 **과소보정**으로 Type I 오류 ↑.

---

## 9. 절차: 첫 실험에서 리포트까지(플로우)

1) **사전등록** 완료: 가설/지표/샘플·기간/정지 규칙/다중검정/세그먼트.
2) **무작위화**: 사용자 ID 단위(크로스오버 금지), 배정 로그 저장.
3) **수집**: 사전에 정한 **fixed horizon**까지 데이터 수집.
4) **전처리**: 사전 규칙대로만(추가 규칙은 “탐색”으로 별도 표시).
5) **검정**:
   - 비율 → 2-표본 z(조건 충족), 소표본/희귀는 정확 또는 Wilson 기반.
   - 연속 → Welch t, 필요시 부트스트랩.
   - 다그룹 비율 → χ²/로지스틱, 연속 → ANOVA/회귀.
6) **다중검정**: 사전 계획대로 BH/Holm 등 적용.
7) **추정치 & CI**: 효과크기(절대 pp, lift, h/d)와 **95% CI** 병기.
8) **결론**: 통계 유의 + **제품 의미**(MDE 대비, 비용/리스크) + 다음 행동(롤아웃/추가 실험).
9) **부록**: 탐색 분석(레터링), 민감도 분석(필터·세그먼트 변화), 원시 로그 해시.

---

## 10. 설계: **power–MDE–n** 관계(두 비율 z-검정 근사)

### 10.1 대칭 팔, 1:1 배정
- 평균 비율 $$\bar p=(p_A+p_B)/2$$, 목표 차이 $$\Delta=p_B-p_A$$, 유의수준 α, 검정력 1−β.
  $$
  n_{\text{per arm}}\approx
  \frac{\Big(z_{1-\alpha/2}\sqrt{2\bar p(1-\bar p)}+z_{1-\beta}\sqrt{p_A(1-p_A)+p_B(1-p_B)}\Big)^2}{\Delta^2}
  $$
- **대칭 설계**(대략): $$p_A\approx p_B\approx p^*$$ 라면
  $$
  n_{\text{per arm}}\approx \frac{2(p^*(1-p^*))\left(z_{1-\alpha/2}+z_{1-\beta}\right)^2}{\Delta^2}
  $$

### 10.2 예
- 목표: **α=0.05**, **power=0.8**, **p≈3%**, **MDE=0.3pp**(=0.003).
  $$
  z_{0.975}=1.96,\ z_{0.8}=0.84,\ p^*(1-p^*)\approx 0.0291
  $$
  $$
  n\approx \frac{2\cdot 0.0291\cdot (1.96+0.84)^2}{0.003^2}\approx \frac{0.0582\cdot 7.84}{9\times 10^{-6}}\approx 50{,}700\ \text{(팔당)}
  $$
- **메시지**: **검정력**을 충분히 확보하려면 **MDE**가 작을수록 **n이 급증**한다.

---

## 11. 구현 스니펫(개념용) — 2-표본 z, BH-FDR, 표본 크기

```python
# 개념 확인용; 실전은 검증된 라이브러리 사용 권장

import math
from typing import List, Tuple

def two_prop_z(xA:int, nA:int, xB:int, nB:int) -> Tuple[float, float, float]:
    # returns (z, p_two_sided, diff)
    p_pool = (xA + xB) / (nA + nB)
    se = math.sqrt(p_pool*(1-p_pool)*(1/nA + 1/nB))
    diff = xB/nB - xA/nA
    z = diff / se
    # two-sided p using normal tail
    # Φ(z) approx via error function
    def phi(z): return 0.5*(1+math.erf(z/math.sqrt(2)))
    p = 2*(1-phi(abs(z)))
    return z, p, diff

def bh_fdr(pvals: List[float], alpha: float=0.05) -> List[bool]:
    # Benjamini–Hochberg: return decisions in original order
    m = len(pvals)
    order = sorted(range(m), key=lambda i: pvals[i])
    thresh_pass = -1
    for rank, i in enumerate(order, start=1):
        if pvals[i] <= alpha*rank/m:
            thresh_pass = i
    keep = [False]*m
    if thresh_pass >= 0:
        # find k: highest rank that passes
        k = max(r for r,i in enumerate(order, start=1) if pvals[i] <= alpha*r/m)
        for r, i in enumerate(order, start=1):
            if r <= k: keep[i] = True
    return keep

def n_per_arm_two_prop(power: float, alpha: float, p: float, d: float) -> int:
    # symmetric approximation
    # inverse normal (rough): use common quantiles
    def z(q):
        # rough mapping for common q
        table = {0.975:1.96, 0.995:2.576, 0.95:1.645, 0.8:0.8416, 0.9:1.2816}
        return table.get(q, 1.96)
    z_alpha = z(1-alpha/2)
    z_power = z(power)
    num = 2*p*(1-p)*(z_alpha+z_power)**2
    return math.ceil(num/(d**2))

# Example
z,p,diff = two_prop_z(3000,100000,3300,100000)
print("z, p, diff:", z, p, diff)  # ~ 3.85, 0.0001, 0.003
print("BH decisions:", bh_fdr([0.001,0.004,0.012,0.018,0.031,0.049,0.06,0.11,0.22,0.40], 0.05))
print("n/arm for p≈0.03, d=0.003, α=0.05, power=0.8:", n_per_arm_two_prop(0.8,0.05,0.03,0.003))
```

---

## 12. 보고 템플릿 — 한눈에 들어오는 **A/B 검정** 요약

> **가설/지표**: $$H_0: p_A=p_B$$(양측), 주지표 CVR.
> **표본/기간**: A/B 각 $$n_A, n_B$$(사전등록된 fixed horizon).
> **추정치**: A=…%, B=…%, 차이=…pp (lift …%).
> **검정**: 2-표본 z (조건 충족 확인), z=…, p=….
> **CI**: 차이 95% CI […, …] (Wilson/뉴컴 권장).
> **다중검정**: 동시 10개, **BH-FDR 5%**에서 유의 항목 k=….
> **해석**: 통계 유의(+제품 의미).
> **다음 단계**: 롤아웃/추가 실험(세그먼트 X에서 재검증).
> **주의**: 사전등록 외 분석은 “탐색”으로 별도 표기.

---

## 13. 함정과 처방 (체크리스트)

1) **조건 미충족 z-검정**
   - $$np, n(1-p)$$ 작으면 **정확검정/부트스트랩** 고려.
2) **옵셔널 스토핑**(중간 엿보기)
   - **α-spending**나 **시퀀셜 검정** 사용. 아니면 fixed horizon 준수.
3) **다중지표/세그먼트 남용**
   - 1차 지표 선정, 나머지는 **FDR**로 제어 또는 **탐색** 라벨.
4) **독립성 위반**
   - 무작위화=분석 단위 **정렬**(사용자ID). 크로스오버 금지.
5) **효과는 작고 유의만 강조**
   - **효과크기·CI** 함께 보고, **비즈니스 임계(MDE)**와 비교.
6) **분모 랜덤성 무시**
   - 일별 평균 대신 **비율의 비율** + 델타법 SE.
7) **모수 가정 경직**
   - 비정규/꼬리: **Welch/로버스트/부트스트랩** 병행.
8) **로그 변환 해석 누락**
   - 로그척도 분석 시 **원척도**로 재번역(젠슨/델타법 주의).

---

## 14. 미니 연습문제(정답 스케치)

**[1] 2-표본 z 전제조건**
- $$n_A\hat p_A,\ n_A(1-\hat p_A),\ n_B\hat p_B,\ n_B(1-\hat p_B)\gtrsim 5$$ 확인. 불충족이면? → **정확검정/Wilson·뉴컴**.

**[2] BH-FDR 판단**
- p값 [0.002,0.007,0.011,0.021,0.031], J=5, α=0.05 → k는?
- **스케치**: 임계 [0.01,0.02,0.03,0.04,0.05]; k=3(0.011≤0.03), 4는 0.021≤0.04 ⇒ **k=4**까지 유의.

**[3] power–MDE–n**
- p≈0.05, α=0.05, power=0.9, MDE=0.5pp(0.005) → n/arm?
- **스케치**: 공식에 대입(수치상 수만 단위).

**[4] p-hacking 시나리오**
- “유의 안 나오면 ‘모바일 신규’로 필터 → 유의”의 해석?
- **스케치**: 다중검정 문제. **사전등록** 없었고 **FDR/FWER 보정** 필요. 탐색으로 기록, 후속 독립 실험 요구.

---

## 15. TL;DR
- **α**는 가짜 양성 허용치, **power(1−β)**는 진짜 효과 탐지 능력, **효과크기**는 의미의 크기.
- **z/t/χ²/F**는 지표와 가정에 맞춰 선택: 비율(z/χ²), 연속(t/F).
- **다중검정**은 **BH-FDR**(또는 Holm/Bonferroni)로 제어하고 **q값**을 함께 보고.
- **p-hacking 방지**는 **사전등록**과 **정지 규칙**이 핵심. 중간 엿보기는 **α-spending** 등으로만.
- 리포트는 **효과크기+CI** 중심, “유의”만으로 결론내지 말 것.
