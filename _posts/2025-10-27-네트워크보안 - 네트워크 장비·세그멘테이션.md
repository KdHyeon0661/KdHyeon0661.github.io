---
layout: post
title: 네트워크보안 - 네트워크 장비·세그멘테이션
date: 2025-10-27 15:25:23 +0900
category: 네트워크보안
---
# 네트워크 장비·세그멘테이션

> 목표: **L2–L4 장비 보안 기능**을 체계적으로 정리하고, **오버레이(VXLAN)·eBPF 기반 마이크로세그멘테이션**까지 연결한다.
> 마지막으로 “**제로트러스트 세그먼트 설계**”를 **랩 구성–정책–검증–운영** 순서로 실습한다.
> 아래 예제는 **개념·운영 관점**이며, 실제 장비/버전 차이는 벤더 가이드를 확인할 것.

---

## L2 보안: Port Security, DAI, DHCP Snooping

### 왜 L2 보안인가

- **스위치 포트는 신뢰경계**다. L2에서의 위협(ARP 스푸핑, MAC 플러딩, DHCP 사칭)은 **L3/L7 보안**을 무력화한다.
- 최소 원칙: “**영역화 + 포트 단단히(Port Security) + L2 무결성(DAI/DHCP Snooping)** + 모니터링”.

---

### Port Security (예: Cisco IOS-XE 스타일)

- 목적: **포트 당 허용 MAC 수/목록** 제한, 우발적 허브/스위치 연결∙MAC 플러딩 완화.
- 주요 모드: `protect`(드롭만), `restrict`(로그/카운트), `shutdown`(에러디스에이블).

```text
interface GigabitEthernet1/0/10
  switchport mode access
  switchport access vlan 20
  switchport port-security
  switchport port-security maximum 2
  switchport port-security violation restrict
  switchport port-security mac-address sticky
  spanning-tree portfast
```

**운영 팁**
- 직원 좌석 맵과 **sticky MAC**을 정기 백업(변경관리).
- 에러디스에이블 자동복구:
```text
errdisable recovery cause psecure-violation
errdisable recovery interval 60
```

---

### DHCP Snooping (스푸핑/사칭 방지)

- 목적: **허가된 DHCP 서버**만 응답하도록, 트러스트 포트/언트러스트 포트 구분.
- 결과: **바인딩 테이블**(MAC–IP–VLAN–포트). **DAI**·**IP Source Guard**의 근거 데이터.

```text
ip dhcp snooping
ip dhcp snooping vlan 10,20
!
interface TenGigabitEthernet1/0/1
  description Uplink-to-Trusted-DHCP
  ip dhcp snooping trust
!
interface GigabitEthernet1/0/10
  ip dhcp snooping limit rate 30
```

**운영 팁**
- 바인딩 파일을 **플래시/원격 저장** 및 **부팅 시 복원** 설정.
- 릴레이(Helper) 경로는 **trust**로 지정하되, 상류 L3에서도 DHCP 필터링.

---

### Dynamic ARP Inspection (DAI)

- 목적: **DHCP Snooping 바인딩** 또는 **ARP ACL**에 기반해 **ARP Reply 유효성 검증**.
- 방어 범위: ARP 스푸핑/포이즈닝 → L3 게이트웨이 스니핑/MITM 완화.

```text
ip arp inspection vlan 10,20
ip arp inspection validate src-mac dst-mac ip
!
interface Gi1/0/10
  ip arp inspection limit rate 25 burst interval 1
```

**주의**
- 정적 IP 장비(서버/프린터)는 **ARP ACL** 또는 **정적 바인딩** 예외 처리.

---

### IP Source Guard (선택)

- 목적: DHCP Snooping 테이블 기반으로 **포트별 IP 스푸핑** 차단.

```text
interface Gi1/0/10
  ip verify source vlan dhcp-snooping port-security
```

---

### Open vSwitch/리눅스 브리지(대안)

- **OVS**에서 DHCP 스누핑/ARP 검증은 **컨트롤러/에이전트** 필요. 간단히는 **ebtables/nft**로 구현.

```bash
# ebtables: ARP 스푸핑 완화(예시)

ebtables -A FORWARD -p ARP --arp-op Reply --arp-mac-src ! <EXPECTED_MAC> -j DROP
```

---

## L3/L4 보안: ACL/uRPF/RTBH/FlowSpec

### ACL(접근제어목록)

- **경계(Edge)**와 **세그먼트 경유 포인트**에서 **기본 차단 + 허용 명시(Allow-list)**.
- 예: 관리망에서만 SSH, 앱–DB 사이 3306/TCP만 등.

**Cisco IOS-XE**
```text
ip access-list extended EDGE-IN
  remark Allow DNS/HTTP(S) out
  permit udp any any eq 53
  permit tcp any any eq 80
  permit tcp any any eq 443
  remark Block RFC1918 ingress from WAN
  deny   ip 10.0.0.0 0.255.255.255 any
  deny   ip 172.16.0.0 0.15.255.255 any
  deny   ip 192.168.0.0 0.0.255.255 any
  permit ip any any
!
interface GigabitEthernet0/0
  ip access-group EDGE-IN in
```

**nftables (Linux 경계방화벽)**
```nft
table inet edge {
  chain input {
    type filter hook input priority 0; policy drop;
    ct state established,related accept
    iifname "wan0" tcp dport {80,443} accept
    iifname "wan0" udp dport 53 accept
    # RFC1918 ingress drop (예: WAN에서 유입)
    iifname "wan0" ip saddr {10.0.0.0/8,172.16.0.0/12,192.168.0.0/16} drop
    # 기본 로그 후 드롭
    log prefix "edge-drop: " group 1
  }
}
```

---

### uRPF (Unicast Reverse Path Forwarding)

- 목적: **소스 IP 스푸핑** 차단.
- 모드:
  - **Strict**: FIB의 **Best path 인터페이스와 실제 수신 인터페이스가 동일**해야 통과(멀티홈 환경 주의).
  - **Loose**: 소스 IP가 **라우팅 테이블에 존재**하면 통과(보다 관대).

```text
interface TenGigabitEthernet0/0
  ip verify unicast source reachable-via rx
  ip verify unicast source reachable-via rx allow-default
```

**운영 팁**
- 멀티홈/ECMP 환경은 **Loose + ACL 보완** 또는 **uRPF VRF-어웨어** 사용.
- 업스트림과 **BCP38**(소스 검증) 준수 계약을 명확히.

---

### RTBH (Remotely Triggered Black Hole)

- 목적: 공격받는 프리픽스/호스트로 향하는 트래픽을 **업스트림에서 Null0로 유도**(급한 대처).
- 방식: **BGP 커뮤니티**/특정 Next-hop(예: **192.0.2.1 → Null**로 매핑)로 **흑홀 경로**를 전파.

**예: 엣지 라우터**
```text
ip route 192.0.2.1 255.255.255.255 Null0
route-map RTBH permit 10
  set ip next-hop 192.0.2.1
  set community 65535:666
!
router bgp 65000
  neighbor 203.0.113.1 remote-as 64500
  address-family ipv4
    neighbor 203.0.113.1 route-map RTBH out
```

**운영 플로우**
1) NOC가 공격 타깃 /32를 템플릿으로 BGP announce
2) 업스트림이 **커뮤니티/Next-hop** 규칙으로 Null0 전송
3) 공격 종료 후 철회
> 서비스 영향이 크므로 **선택적(마지막 수단)** 적용, 미러/스크러빙 센터 연계 권장.

---

### BGP FlowSpec (정밀 차단)

- 목적: L3/L4 조건(프리픽스+포트+플래그)으로 **분산 차단 규칙** 배포(BGP를 제어채널로 사용).
- 예: 특정 /32 대상 **UDP/53**만 드롭.

**FlowSpec 룰(개념)**
```text
# NLRI: dst 198.51.100.10/32, proto=udp, dport=53
# Action: traffic-rate 0 (drop) or traffic-action discard

```

**주의**
- **미스배포 위험** → **RPKI/정책/승인 워크플로우** 필수.
- 장비 성능(하드웨어 TCAM/소프트웨어 룰) 차이 고려.

---

## 마이크로세그멘테이션 (VXLAN/eBPF)

### 배경

- **동일 L2/L3 내에서도 워크로드 간 통신**을 최소 권한으로 제한(동일 VLAN → 서로 접근 불가).
- 구현 옵션
  1) **오버레이**: VXLAN/EVPN으로 테넌트 분리 + 가상 루터/방화벽.
  2) **호스트·워크로드 에이전트**: eBPF/iptables 기반 정책(예: **Cilium/Calico**).
  3) **하이브리드**: 물리–가상 Cross 정책(DC·K8s·VM 통합).

---

### VXLAN(DC 오버레이) 한 눈에

- **VNI(24bit)**로 **논리 세그먼트** 분리 (VLAN 확장/대체).
- **EVPN(Control-plane)**로 MAC/IP/ARP 정보 **BGP로 교환** → L2/L3 VNI 라우팅.

**EVPN Type-2/Type-5 요약**
- **Type-2**: MAC 및 MAC+IP 바인딩 배포(L2 확장)
- **Type-5**: L3 프리픽스 배포(L3 VNI 라우팅)

**운영 포인트**
- 게이트웨이(Distributed Anycast GW)로 **동일 IP 게이트웨이** 제공.
- **ARP/ND 억제**(프록시 ARP/ND)와 **/32 호스트 라우팅**으로 브로드캐스트 감소.

---

### eBPF 기반 마이크로세그 (K8s: Cilium 예)

**CiliumNetworkPolicy: 앱→DB에만 3306 허용, 외부 egress는 DNS/HTTPS만**
```yaml
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: allow-app-to-db
spec:
  endpointSelector:
    matchLabels:
      app: web
  egress:
  - toEndpoints:
    - matchLabels:
        app: mysql
    toPorts:
    - ports:
      - port: "3306"
        protocol: TCP
  - toFQDNs:
    - matchName: "api.github.com"
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
  - toEndpoints:
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: kube-system
    toPorts:
    - ports:
      - port: "53"
        protocol: ANY
    rules:
      dns:
      - matchPattern: "*"
  ingress:
  - fromEndpoints:
    - matchLabels:
        role: ingress-gateway
```

**설명**
- `web` → `mysql` **명시 허용**(3306/TCP).
- 외부 egress는 **특정 FQDN(HTTPS)**만. DNS는 kube-dns로 제한.
- 나머지 **기본 거부**는 **Cilium default deny** 설정으로 달성.

---

### eBPF(XDP) 미세 예제 — 단순 L4 차단(학습용)

> 운영은 Cilium/Calico 정책 우선. XDP는 고성능 커스텀 필터가 필요할 때 사용.

```c
// xdp_block_redis.c : dst port 6379 차단 (학습용, 성능 비교 목적)
#include <linux/bpf.h>
#include <linux/if_ether.h>
#include <linux/ip.h>
#include <linux/tcp.h>

SEC("xdp")
int xdp_block(struct xdp_md *ctx) {
  void *data = (void*)(long)ctx->data;
  void *data_end = (void*)(long)ctx->data_end;

  struct ethhdr *eth = data;
  if ((void*)eth + sizeof(*eth) > data_end) return XDP_PASS;
  if (eth->h_proto != __constant_htons(ETH_P_IP)) return XDP_PASS;

  struct iphdr *iph = (void*)eth + sizeof(*eth);
  if ((void*)iph + sizeof(*iph) > data_end) return XDP_PASS;
  if (iph->protocol != IPPROTO_TCP) return XDP_PASS;

  struct tcphdr *th = (void*)iph + iph->ihl*4;
  if ((void*)th + sizeof(*th) > data_end) return XDP_PASS;

  if (th->dest == __constant_htons(6379)) {
    return XDP_DROP; // Redis 차단
  }
  return XDP_PASS;
}
char _license[] SEC("license") = "GPL";
```

**적용(요지)**
```bash
clang -O2 -target bpf -c xdp_block_redis.c -o xdp_block_redis.o
ip link set dev eth0 xdp obj xdp_block_redis.o sec xdp
```

---

### VM/물리 혼합 — “분산 방화벽” 패턴

- 하이퍼바이저 vSwitch(예: **NSX-T DFW**, **OVS + conntrack**)에서 **워크로드별 태그/ID**로 L4 정책.
- 장점: 트래픽이 **하이퍼바이저에서 즉시 차단**(동-동 동선 최소화).

---

## 실습: 제로트러스트 세그먼트 설계

### 시나리오

- 테넌트: **Corp**
- 영역: `User(EDR/VDI)`, `App(웹/API)`, `DB`, `Mgmt`
- 원칙: **기본 거부(Default deny)** + **최소 권한 Allow-list** + **신원·기기상태·암호화(mTLS)**

```
User ──(ZTA GW/mTLS)── App ──(only 3306/TCP)── DB
   └─(Just-in-time Mgmt)── Mgmt
```

---

### 정책 정의 (사양서)

1) **User→App**:
   - 조건: **mTLS(클라이언트 인증서)** + **ID·기기상태(EDR healthy)**
   - L4: `443/TCP`만, HTTP는 `/login,/api/*` 접근, 속도 제한(DoS 대비)
2) **App→DB**:
   - `3306/TCP`만, 소스는 `app` 태그 엔드포인트, DB는 **서브넷/태그 동시 매칭**
3) **Mgmt→(App/DB)**:
   - JIT 포털 통해 **타임바운드** 접근, bastion의 **서버 인증서 핀**
4) **Egress(App/DB)**:
   - **패키지 리포지토리/CRL/OCSP** 도메인만 허용
5) **L2**:
   - User 세그먼트 포트: `Port Security max 2`, DHCP Snooping+DAI
6) **L3 경계**:
   - uRPF loose + ACL(비업무 포트 차단), RTBH/Flowspec 준비

---

### K8s(Cilium) 구현 예 — App/DB

**Default Deny 네임스페이스**
```yaml
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: default-deny
  namespace: corp
spec:
  endpointSelector: {}
  ingress: []
  egress: []
```

**App 허용(ingress from ZTA GW, egress to DB+DNS+CRL)**
```yaml
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: app-allow
  namespace: corp
spec:
  endpointSelector:
    matchLabels: { app: web }
  ingress:
  - fromEntities: [ "world" ]    # ZTA GW의 IP/FQDN으로 더 좁힘(예시는 world)
    toPorts:
    - ports: [{ port: "443", protocol: TCP }]
  egress:
  - toEndpoints: [{ matchLabels: { app: mysql } }]
    toPorts: [{ ports: [{ port: "3306", protocol: TCP }] }]
  - toFQDNs:
    - matchPattern: "*.crl.microsoft.com"
    - matchPattern: "ocsp.*"
    toPorts:
    - ports: [{ port: "80", protocol: TCP }, { port:"443", protocol: TCP }]
  - toEndpoints:
    - matchLabels: { k8s:io.kubernetes.pod.namespace: kube-system }
    toPorts:
    - ports: [{ port: "53", protocol: ANY }]
    rules:
      dns: [{ matchPattern: "*" }]
```

**DB 인바운드 제한**
```yaml
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: db-only-from-app
  namespace: corp
spec:
  endpointSelector: { matchLabels: { app: mysql } }
  ingress:
  - fromEndpoints: [{ matchLabels: { app: web } }]
    toPorts: [{ ports: [{ port: "3306", protocol: TCP }] }]
```

---

### mTLS 게이트웨이 (Nginx, 요지)

- ZTA GW에서 클라이언트 인증서 검증 후 App으로 프록시.

```nginx
server {
  listen 443 ssl http2;
  server_name zta.corp.example;

  ssl_certificate     /etc/certs/gw_fullchain.pem;
  ssl_certificate_key /etc/certs/gw.key;

  ssl_client_certificate /etc/certs/corp_client_ca_chain.pem;
  ssl_verify_client on;
  ssl_verify_depth 2;

  location / {
    proxy_set_header X-Client-Verify $ssl_client_verify;
    proxy_set_header X-Client-DN     $ssl_client_s_dn;
    proxy_pass https://app.corp.svc.cluster.local;
  }
}
```

**App에서 헤더 신뢰 경계**
```text
# App는 오직 ZTA GW(프록시)에서 온 요청만 신뢰
# 내부 Hop에선 위 헤더 제거/재설정. 백엔드 직접 접근 차단(ACL).

```

---

### L2/L3 연동 (액세스 스위치 + 경계)

**액세스(사용자 존)**
```text
vlan 100
interface Gi1/0/10
  switchport mode access
  switchport access vlan 100
  switchport port-security
  switchport port-security maximum 2
  ip dhcp snooping limit rate 20
  spanning-tree portfast
!
ip dhcp snooping vlan 100
ip arp inspection vlan 100
```

**경계 라우터**
```text
ip access-list extended USER-EGRESS
  permit tcp 10.10.100.0 0.0.0.255 host 10.10.10.10 eq 443   ! ZTA GW
  deny   ip any 10.10.20.0 0.0.0.255                          ! DB 직행 차단
  permit ip any any
!
interface Ten0/0
  ip verify unicast source reachable-via any  ! uRPF loose
  ip access-group USER-EGRESS out
```

---

### 검증 (테스트·관측)

**기능 테스트**
```bash
# User → App 443 OK (mTLS 필요)

curl -vk --cert user.p12 https://zta.corp.example/

# App → DB 3306 OK, 기타 포트 실패

kubectl -n corp exec deploy/web -- bash -lc "nc -zv mysql 3306 && nc -zv mysql 22"

# User → DB 직접 접근 실패

nc -zv 10.10.20.5 3306  # 경계 ACL로 차단되어야 함
```

**관측(TShark/Zeek)**
```bash
tshark -i eth0 -f "tcp port 3306" -Y "ip.src==APP_SUBNET and ip.dst==DB_SUBNET"
# 기대: App↔DB만 보이고, User 세그먼트 소스는 보이지 않음

```

**Cilium 정책 히트**
```bash
cilium monitor --type drop
# 불허 트래픽이 정책에 의해 DROP되는지 확인

```

---

### 운영 체크리스트

- **정책 소스오브트루스**: GitOps(리뷰/테스트/머지) + 자동 배포
- **기본 거부(Default deny)** 유지, 예외는 **만료일/소유자** 명시
- **ID·기기상태·네트워크** 3요소 기반 컨텍스트 — **시간대/리스크 점수**까지 확장
- **로그/가시성**: 정책 히트, 드롭 사유, 세션 요약(5-tuple+ID)
- **회귀 테스트**: 배포 전/후 **허용 목록 검증 스위트** 실행
- **L2–L3 연동**: DHCP Snooping 바인딩 유효성 → DAI → L3 ACL 일관성
- **DDoS 대비**: uRPF + RTBH/Flowspec **런북 문서화 및 모의훈련**

---

## 부록 A. 정책 설계 템플릿 (요구/제약/근거)

- **서비스**: 이름, 중요도, 데이터등급
- **주체/대상**: 태그/네임스페이스/서브넷/AS
- **허용 트래픽**: 프로토콜/포트/방향/시간대
- **신원**: 사용자/워크로드/기기 상태(mTLS/MDM)
- **가시성**: 로깅 수준, 메트릭, 대시보드 카드
- **만료**: 정책 종료일/갱신주기, 검토자
- **테스트 케이스**: 허용/거부 시나리오 목록

---

## 부록 B. Calico 네트워크 정책 (대안)

```yaml
apiVersion: projectcalico.org/v3
kind: NetworkPolicy
metadata:
  name: app-db
  namespace: corp
spec:
  selector: app == 'web'
  egress:
  - action: Allow
    destination:
      selector: app == 'mysql'
      ports: [3306]
  - action: Allow
    destination:
      nets:
      - 0.0.0.0/0
    protocol: TCP
    destination:
      ports: [443]
  ingress:
  - action: Allow
    source:
      selector: role == 'ingress-gateway'
```

---

## 요약

- **L2**: **Port Security + DHCP Snooping + DAI**로 **단말–스위치 경계**를 단단히 한다.
- **L3/L4**: **ACL/uRPF**를 기본으로, **RTBH/FlowSpec**으로 대규모 이벤트 대응력을 확보한다.
- **마이크로세그멘테이션**은 **VXLAN/EVPN**(물리/가상 영역화)과 **eBPF 정책**(워크로드 정체성) 조합이 효과적.
- **제로트러스트**는 **기본 거부 + 최소 허용 + mTLS + 컨텍스트 기반**으로 설계하고,
  **검증 자동화/관측/회귀 테스트**를 통해 **안전하게 운영**한다.
