---
layout: post
title: Avalonia - ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
date: 2025-02-16 21:20:23 +0900
category: Avalonia
---
# ğŸ”§ Avalonia MVVMì—ì„œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (WebSocket)

---

## ğŸ¯ ëª©í‘œ

| í•­ëª© | ì„¤ëª… |
|------|------|
| WebSocket í´ë¼ì´ì–¸íŠ¸ | ì„œë²„ì— ì‹¤ì‹œê°„ ì—°ê²° ìœ ì§€ |
| ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬ | ViewModelì— ì‹¤ì‹œê°„ ë°ì´í„° ë°˜ì˜ |
| êµ¬ì¡° ë¶„ë¦¬ | ì„œë¹„ìŠ¤, ViewModelë¡œ ë¶„ë¦¬í•´ í…ŒìŠ¤íŠ¸ ìš©ì´ì„± í™•ë³´ |
| UI ì—°ë™ | ë¦¬ìŠ¤íŠ¸, ì•Œë¦¼ UI ë“±ì— ì‹¤ì‹œê°„ ë°˜ì˜

---

## ğŸ§± êµ¬ì¡° ì˜ˆì‹œ

```
MyApp/
â”œâ”€â”€ Views/
â”‚   â””â”€â”€ DashboardView.axaml
â”œâ”€â”€ ViewModels/
â”‚   â””â”€â”€ DashboardViewModel.cs
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ IWebSocketService.cs
â”‚   â””â”€â”€ WebSocketService.cs
```

---

## 1ï¸âƒ£ WebSocket ì„œë²„ ì˜ˆì‹œ

ì„œë²„ëŠ” ì¼ë°˜ `ws://localhost:5000/ws` ê°™ì€ ì£¼ì†Œë¡œ ì—°ê²°ë©ë‹ˆë‹¤.  
ë©”ì‹œì§€ëŠ” JSONìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœë¡œ ë³´ë‚¸ë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤:

```json
{
  "type": "Notification",
  "message": "ìƒˆ ì£¼ë¬¸ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!",
  "timestamp": "2025-07-17T15:00:00"
}
```

---

## 2ï¸âƒ£ ë°ì´í„° ëª¨ë¸ ì •ì˜

### ğŸ“„ Models/NotificationMessage.cs

```csharp
public class NotificationMessage
{
    public string Type { get; set; } = "";
    public string Message { get; set; } = "";
    public DateTime Timestamp { get; set; }
}
```

---

## 3ï¸âƒ£ WebSocket ì¸í„°í˜ì´ìŠ¤ ì •ì˜

### ğŸ“„ Services/IWebSocketService.cs

```csharp
public interface IWebSocketService
{
    Task ConnectAsync();
    event EventHandler<NotificationMessage>? OnMessageReceived;
    Task DisconnectAsync();
}
```

---

## 4ï¸âƒ£ WebSocket í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„

.NETì—ëŠ” í‘œì¤€ WebSocket í´ë¼ì´ì–¸íŠ¸ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

### ğŸ“„ Services/WebSocketService.cs

```csharp
using System.Net.WebSockets;
using System.Text.Json;
using System.Text;

public class WebSocketService : IWebSocketService
{
    private readonly ClientWebSocket _socket = new();
    private readonly Uri _serverUri = new("ws://localhost:5000/ws");
    private CancellationTokenSource? _cts;

    public event EventHandler<NotificationMessage>? OnMessageReceived;

    public async Task ConnectAsync()
    {
        if (_socket.State == WebSocketState.Open)
            return;

        _cts = new CancellationTokenSource();
        await _socket.ConnectAsync(_serverUri, _cts.Token);

        _ = Task.Run(ReceiveLoop);
    }

    private async Task ReceiveLoop()
    {
        var buffer = new byte[4096];

        while (_socket.State == WebSocketState.Open)
        {
            var result = await _socket.ReceiveAsync(buffer, CancellationToken.None);
            if (result.MessageType == WebSocketMessageType.Close)
                break;

            var message = Encoding.UTF8.GetString(buffer, 0, result.Count);

            try
            {
                var obj = JsonSerializer.Deserialize<NotificationMessage>(message);
                if (obj != null)
                    OnMessageReceived?.Invoke(this, obj);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"WebSocket ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜: {ex.Message}");
            }
        }
    }

    public async Task DisconnectAsync()
    {
        if (_socket.State == WebSocketState.Open)
        {
            _cts?.Cancel();
            await _socket.CloseAsync(WebSocketCloseStatus.NormalClosure, "ì¢…ë£Œ", CancellationToken.None);
        }
    }
}
```

---

## 5ï¸âƒ£ ViewModelì—ì„œ ìˆ˜ì‹  ë©”ì‹œì§€ ì²˜ë¦¬

### ğŸ“„ ViewModels/DashboardViewModel.cs

```csharp
public class DashboardViewModel : ReactiveObject
{
    private readonly IWebSocketService _wsService;

    public ObservableCollection<NotificationMessage> Notifications { get; } = new();

    public DashboardViewModel(IWebSocketService wsService)
    {
        _wsService = wsService;
        _wsService.OnMessageReceived += (_, msg) =>
        {
            Avalonia.Threading.Dispatcher.UIThread.Post(() =>
            {
                Notifications.Insert(0, msg);
                if (Notifications.Count > 50)
                    Notifications.RemoveAt(50);
            });
        };

        _ = _wsService.ConnectAsync();
    }

    public async Task CleanupAsync()
    {
        await _wsService.DisconnectAsync();
    }
}
```

---

## 6ï¸âƒ£ UI êµ¬ì„± ì˜ˆì‹œ

### ğŸ“„ Views/DashboardView.axaml

```xml
<StackPanel Spacing="10" Margin="20">
  <TextBlock Text="ğŸ“¡ ì‹¤ì‹œê°„ ì•Œë¦¼" FontSize="18"/>
  <ItemsControl Items="{Binding Notifications}">
    <ItemsControl.ItemTemplate>
      <DataTemplate>
        <Border BorderBrush="Gray" BorderThickness="1" Padding="5" Margin="2">
          <StackPanel>
            <TextBlock Text="{Binding Message}" FontWeight="Bold"/>
            <TextBlock Text="{Binding Timestamp}" FontStyle="Italic" FontSize="12"/>
          </StackPanel>
        </Border>
      </DataTemplate>
    </ItemsControl.ItemTemplate>
  </ItemsControl>
</StackPanel>
```

---

## 7ï¸âƒ£ DI ë“±ë¡

```csharp
services.AddSingleton<IWebSocketService, WebSocketService>();
services.AddTransient<DashboardViewModel>();
```

---

## 8ï¸âƒ£ ì¢…ë£Œ ì‹œ ì •ë¦¬

ì°½ì´ ë‹«í ë•Œ ViewModelì˜ `CleanupAsync()` í˜¸ì¶œ:

```csharp
window.Closing += async (_, _) =>
{
    if (window.DataContext is DashboardViewModel vm)
        await vm.CleanupAsync();
};
```

---

## âœ… ì •ë¦¬

| í•­ëª© | êµ¬í˜„ ë‚´ìš© |
|------|-----------|
| WebSocket ì—°ê²° | `ClientWebSocket.ConnectAsync()` |
| ìˆ˜ì‹  ë©”ì‹œì§€ ì²˜ë¦¬ | JSON ë””ì½”ë”© í›„ ì´ë²¤íŠ¸ ë°œìƒ |
| MVVM êµ¬ì¡° | ViewModelì—ì„œ ObservableCollectionì— ë°”ì¸ë”© |
| UI ë™ê¸°í™” | Avalonia UI Thread Dispatcher ì‚¬ìš© |
| ì •ë¦¬/ì¢…ë£Œ ì²˜ë¦¬ | DisconnectAsync, ì´ë²¤íŠ¸ í•´ì œ

---

## ğŸ’¡ í™•ì¥ ì•„ì´ë””ì–´

- âœ… SignalRë¡œ í™•ì¥ (Microsoft.AspNetCore.SignalR.Client ì‚¬ìš©)
- ğŸ”„ WebSocket ëŠê¹€ ê°ì§€ ë° ì¬ì—°ê²°
- ğŸ§ª WebSocket ë©”ì‹œì§€ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- ğŸ”’ ì¸ì¦ í† í° í•¸ë“œì…‹ (JWT ë“±)ê³¼ í•¨ê»˜ ì—°ê²°
- ğŸ“ˆ ì‹¤ì‹œê°„ ë°ì´í„° ì‹œê°í™” (ê·¸ë˜í”„, ì°¨íŠ¸)

---

## ğŸ“š ì°¸ê³  ë¼ì´ë¸ŒëŸ¬ë¦¬

- .NET í‘œì¤€ `ClientWebSocket`
- `Websocket.Client` ë¼ì´ë¸ŒëŸ¬ë¦¬ (ê³ ê¸‰ ì¬ì—°ê²°/ë¡œê¹… ì§€ì›)
- `SignalR.Client` (Hub ë°©ì‹ ì‹¤ì‹œê°„ í†µì‹ )